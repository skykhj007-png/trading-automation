//@version=5
indicator("V42 Ultimate - ICT + Harmonic + Ï†ïÌôïÏÑ± ÌïÑÌÑ∞ (2026.01.23)", overlay=true, max_labels_count=500, max_lines_count=500, max_boxes_count=300)

// ============================================
// V42 Ultimate = V40 ICT Enhanced + V41 Harmonic
//
// ICT Í∏∞Îä• (V40):
// - Killzones (London/NY Open)
// - Liquidity Sweep
// - Smart Trail
// - CVD / Volume Delta
// - 30Ï†ê Ï†êÏàò ÏãúÏä§ÌÖú
//
// ÌïòÎ™®Îãâ Ìå®ÌÑ¥ (V41):
// - Gartley, Bat, Crab, Butterfly
// - Cypher, Shark, 5-0, 707
// - PRZ + TP/SL ÏûêÎèô Í≥ÑÏÇ∞
// - RSI BAMM
// ============================================

// ============================================
// Í∏∞Î≥∏ ÏÑ§Ï†ï
// ============================================
tradeMode = input.string("ÌòÑÎ¨º", title="Í±∞Îûò Î™®Îìú", options=["ÏÑ†Î¨º", "ÌòÑÎ¨º"], group="Í∏∞Î≥∏ ÏÑ§Ï†ï")
displayMode = input.string("ÏµúÏÜåÌôî", title="ÌôîÎ©¥ Î™®Îìú", options=["Ï†ÑÏ≤¥", "ÏµúÏÜåÌôî"], group="Í∏∞Î≥∏ ÏÑ§Ï†ï")

bool isFutures = tradeMode == "ÏÑ†Î¨º"
bool showShortSignals = isFutures
bool isMinimalMode = displayMode == "ÏµúÏÜåÌôî"

// ============================================
// ICT Killzones ÏÑ§Ï†ï
// ============================================
enableKillzones = input.bool(true, title="Killzones ÌïÑÌÑ∞", group="ICT ÏÑ§Ï†ï")
kzLondonOpen = input.bool(true, title="London Open (08-10 UTC)", group="ICT ÏÑ§Ï†ï")
kzNYOpen = input.bool(true, title="NY Open (13-15 UTC)", group="ICT ÏÑ§Ï†ï")
kzLondonClose = input.bool(true, title="London Close (15-17 UTC)", group="ICT ÏÑ§Ï†ï")

// Killzone ÏãúÍ∞Ñ Ï≤¥ÌÅ¨
utcHour = hour(time, "UTC")
isLondonOpen = utcHour >= 8 and utcHour < 10
isNYOpen = utcHour >= 13 and utcHour < 15
isLondonClose = utcHour >= 15 and utcHour < 17
isInKillzone = (kzLondonOpen and isLondonOpen) or (kzNYOpen and isNYOpen) or (kzLondonClose and isLondonClose)
killzoneActive = not enableKillzones or isInKillzone

// ============================================
// ÌïòÎ™®Îãâ Ìå®ÌÑ¥ ÏÑ§Ï†ï
// ============================================
showHarmonic = input.bool(true, title="ÌïòÎ™®Îãâ Ìå®ÌÑ¥ ÌëúÏãú", group="ÌïòÎ™®Îãâ Ìå®ÌÑ¥")
showHarmonicLabels = input.bool(true, title="Ìå®ÌÑ¥ ÎùºÎ≤®", group="ÌïòÎ™®Îãâ Ìå®ÌÑ¥")
showPRZ = input.bool(true, title="PRZ Íµ¨Í∞Ñ", group="ÌïòÎ™®Îãâ Ìå®ÌÑ¥")
showTPSL = input.bool(true, title="TP/SL Î†àÎ≤®", group="ÌïòÎ™®Îãâ Ìå®ÌÑ¥")
fibTolerance = input.float(5.0, title="ÌîºÎ≥¥ÎÇòÏπò ÌóàÏö© Ïò§Ï∞® (%)", minval=1.0, maxval=15.0, group="ÌïòÎ™®Îãâ Ìå®ÌÑ¥")

// Í∞úÎ≥Ñ Ìå®ÌÑ¥ ON/OFF
showGartley = input.bool(true, title="Gartley", inline="pat1", group="Ìå®ÌÑ¥ ÏÑ†ÌÉù")
showBat = input.bool(true, title="Bat", inline="pat1", group="Ìå®ÌÑ¥ ÏÑ†ÌÉù")
showCrab = input.bool(true, title="Crab", inline="pat1", group="Ìå®ÌÑ¥ ÏÑ†ÌÉù")
showButterfly = input.bool(true, title="Butterfly", inline="pat2", group="Ìå®ÌÑ¥ ÏÑ†ÌÉù")
showCypher = input.bool(true, title="Cypher", inline="pat2", group="Ìå®ÌÑ¥ ÏÑ†ÌÉù")
show707 = input.bool(true, title="707", inline="pat2", group="Ìå®ÌÑ¥ ÏÑ†ÌÉù")
showABCD = input.bool(true, title="AB=CD", inline="pat3", group="Ìå®ÌÑ¥ ÏÑ†ÌÉù")

// RSI BAMM ÏÑ§Ï†ï
showRSIBAMM = input.bool(true, title="RSI BAMM ÌôúÏÑ±Ìôî", group="RSI BAMM")
rsiBAMMLength = input.int(14, title="RSI Í∏∏Ïù¥", group="RSI BAMM")
rsiBAMMOB = input.int(70, title="RSI Í≥ºÎß§Ïàò", group="RSI BAMM")
rsiBAMMOS = input.int(30, title="RSI Í≥ºÎß§ÎèÑ", group="RSI BAMM")

// ============================================
// Ï†ïÌôïÏÑ± ÌïÑÌÑ∞ (Ïã†Í∑ú)
// ============================================
// ÌíàÏßà ÌïÑÌÑ∞
minQualityScore = input.int(60, title="ÏµúÏÜå ÌíàÏßà Ï†êÏàò (%)", minval=0, maxval=100, step=10, group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞", tooltip="Ïù¥ Ï†êÏàò Ïù¥ÏÉÅÏùò Ìå®ÌÑ¥Îßå Ïã†Ìò∏ Î∞úÏÉù")
requirePerfect = input.bool(false, title="Perfect Ìå®ÌÑ¥Îßå", group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞", tooltip="Perfect ÎπÑÏú® Ìå®ÌÑ¥Îßå Ïã†Ìò∏ Î∞úÏÉù")

// RSI ÌôïÏù∏ ÌïÑÌÑ∞
useRSIConfirm = input.bool(true, title="RSI ÌôïÏù∏ ÌïÑÌÑ∞", group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞", tooltip="PRZÏóêÏÑú RSI Í≥ºÎß§Ïàò/Í≥ºÎß§ÎèÑ ÌôïÏù∏")
rsiConfirmLevel = input.int(35, title="RSI ÌôïÏù∏ Î†àÎ≤®", minval=20, maxval=40, group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞", tooltip="Bullish: RSI < Ïù¥ Í∞í, Bearish: RSI > 100-Ïù¥ Í∞í")

// Ï∂îÏÑ∏ ÌïÑÌÑ∞
useTrendFilter = input.bool(true, title="Ï∂îÏÑ∏ ÌïÑÌÑ∞", group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞", tooltip="EMA Î∞©Ìñ•Í≥º ÏùºÏπòÌïòÎäî Ïã†Ìò∏Îßå")
trendEMALen = input.int(55, title="Ï∂îÏÑ∏ EMA Í∏∏Ïù¥", group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞")

// Í±∞ÎûòÎüâ ÌïÑÌÑ∞
useVolumeFilter = input.bool(true, title="Í±∞ÎûòÎüâ ÌïÑÌÑ∞", group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞", tooltip="ÌèâÍ∑† Ïù¥ÏÉÅ Í±∞ÎûòÎüâÏóêÏÑúÎßå Ïã†Ìò∏")
volumeMultiplier = input.float(1.2, title="Í±∞ÎûòÎüâ Î∞∞Ïàò", minval=1.0, maxval=3.0, step=0.1, group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞")
volumeLength = input.int(20, title="Í±∞ÎûòÎüâ MA Í∏∏Ïù¥", group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞")

// Ïª®ÌîåÎ£®Ïñ∏Ïä§ (Î≥µÌï© ÌôïÏù∏)
useConfluence = input.bool(true, title="Ïª®ÌîåÎ£®Ïñ∏Ïä§ ÌïÑÌÑ∞", group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞", tooltip="Ïó¨Îü¨ Ï°∞Í±¥ Ï∂©Ï°± ÏãúÎßå Ïã†Ìò∏")
minConfluenceScore = input.int(3, title="ÏµúÏÜå Ïª®ÌîåÎ£®Ïñ∏Ïä§", minval=1, maxval=5, group="Ï†ïÌôïÏÑ± ÌïÑÌÑ∞", tooltip="Ï∂©Ï°±Ìï¥Ïïº Ìï† ÏµúÏÜå Ï°∞Í±¥ Ïàò")

// Smart Trail ÏÑ§Ï†ï
showSmartTrail = input.bool(true, title="Smart Trail ÌëúÏãú", group="Smart Trail")
trailATRMult = input.float(2.0, title="ATR Î∞∞Ïàò", minval=0.5, maxval=5.0, group="Smart Trail")
trailATRLen = input.int(14, title="ATR Í∏∏Ïù¥", group="Smart Trail")

// ============================================
// ÏÉâÏÉÅ ÏÑ§Ï†ï
// ============================================
bullishColor = input.color(color.new(color.green, 20), title="Bullish", group="ÏÉâÏÉÅ")
bearishColor = input.color(color.new(color.red, 20), title="Bearish", group="ÏÉâÏÉÅ")
przColor = input.color(color.new(color.yellow, 70), title="PRZ", group="ÏÉâÏÉÅ")

// ============================================
// ÌîºÎ≥¥ÎÇòÏπò ÏÉÅÏàò
// ============================================
FIB_382 = 0.382
FIB_50 = 0.5
FIB_618 = 0.618
FIB_707 = 0.707
FIB_786 = 0.786
FIB_886 = 0.886
FIB_113 = 1.13
FIB_127 = 1.272
FIB_141 = 1.414
FIB_161 = 1.618

// ============================================
// Í∏∞Î≥∏ ÏßÄÌëú Í≥ÑÏÇ∞
// ============================================
ema8 = ta.ema(close, 8)
ema21 = ta.ema(close, 21)
ema55 = ta.ema(close, 55)
ema200 = ta.ema(close, 200)

rsi = ta.rsi(close, 14)
[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
atrValue = ta.atr(14)

avgVol = ta.sma(volume, 20)
volRatio = volume / avgVol
volSpike = volRatio >= 1.5

// ============================================
// Í≥†Îûò Í∞êÏßÄ ÏÑ§Ï†ï
// ============================================
showWhale = input.bool(true, title="Í≥†Îûò Îß§Ïàò/Îß§ÎèÑ ÌëúÏãú", group="Í≥†Îûò Í∞êÏßÄ")
whaleVolMultiplier = input.float(3.0, title="Í≥†Îûò Í±∞ÎûòÎüâ Î∞∞Ïàò", minval=2.0, maxval=10.0, step=0.5, group="Í≥†Îûò Í∞êÏßÄ")
whalePriceMove = input.float(0.5, title="Í≥†Îûò Í∞ÄÍ≤© Î≥ÄÎèô (%)", minval=0.1, maxval=2.0, step=0.1, group="Í≥†Îûò Í∞êÏßÄ")

// Volume Delta ÏÑ§Ï†ï
showVolumeDelta = input.bool(true, title="Volume Delta ÌëúÏãú", group="Volume Delta")
showCVD = input.bool(true, title="CVD ÎùºÏù∏ ÌëúÏãú", group="Volume Delta")

// ============================================
// Volume Delta & CVD Í≥ÑÏÇ∞
// ============================================
// Îß§Ïàò/Îß§ÎèÑ Í±∞ÎûòÎüâ Ï∂îÏ†ï
float upperWick = high - math.max(open, close)
float lowerWick = math.min(open, close) - low
float bodySize = math.abs(close - open)
float totalRange = high - low

// Îß§Ïàò ÎπÑÏú® Ï∂îÏ†ï
float buyRatio = totalRange > 0 ? (lowerWick + (close > open ? bodySize : 0)) / totalRange : 0.5
float bullVol = volume * buyRatio
float bearVol = volume * (1 - buyRatio)

// Volume Delta
float volumeDelta = bullVol - bearVol
float deltaRatio = volume > 0 ? volumeDelta / volume * 100 : 0

// CVD ÎàÑÏ†Å (ÏùºÎ¥â Î¶¨ÏÖã)
var float cvd = 0.0
bool resetCVD = ta.change(time("D")) != 0
cvd := resetCVD ? volumeDelta : cvd + volumeDelta

// CVD Ï∂îÏÑ∏
float cvdEma = ta.ema(cvd, 14)
bool cvdUptrend = cvd > cvdEma
bool cvdDowntrend = cvd < cvdEma

// Delta Í∞ïÎèÑ
bool strongPositiveDelta = deltaRatio > 30
bool strongNegativeDelta = deltaRatio < -30
bool delta3ConsecutiveBuy = volumeDelta > 0 and volumeDelta[1] > 0 and volumeDelta[2] > 0
bool delta3ConsecutiveSell = volumeDelta < 0 and volumeDelta[1] < 0 and volumeDelta[2] < 0

// Delta Îì±Í∏â
string deltaGrade = strongPositiveDelta and delta3ConsecutiveBuy ? "Í∞ïÎß§Ïàò" : strongNegativeDelta and delta3ConsecutiveSell ? "Í∞ïÎß§ÎèÑ" : deltaRatio > 10 ? "Îß§Ïàò" : deltaRatio < -10 ? "Îß§ÎèÑ" : "Ï§ëÎ¶Ω"
color deltaColor = deltaGrade == "Í∞ïÎß§Ïàò" ? color.lime : deltaGrade == "Îß§Ïàò" ? color.green : deltaGrade == "Í∞ïÎß§ÎèÑ" ? color.fuchsia : deltaGrade == "Îß§ÎèÑ" ? color.red : color.gray

// ============================================
// Í≥†Îûò Í∞êÏßÄ Í≥ÑÏÇ∞
// ============================================
float priceChangePercent = math.abs(close - open) / open * 100
bool isBullishCandle = close > open
bool isBearishCandle = close < open
float buyPressure = buyRatio * 100

bool isWhaleVolume = volRatio >= whaleVolMultiplier
bool isWhalePriceMove = priceChangePercent >= whalePriceMove

// Í≥†Îûò Îß§Ïàò/Îß§ÎèÑ
bool whaleBuy = isWhaleVolume and isWhalePriceMove and isBullishCandle and buyPressure > 55
bool whaleSell = isWhaleVolume and isWhalePriceMove and isBearishCandle and buyPressure < 45

// Í≥†Îûò Îì±Í∏â
string whaleGrade = volRatio >= 10.0 ? "üêãÏ¥àÎåÄÌòï" : volRatio >= 7.0 ? "üêãÎåÄÌòï" : volRatio >= 5.0 ? "üê¨Ï§ëÌòï" : volRatio >= 3.0 ? "üêüÏÜåÌòï" : ""

// ============================================
// Smart Trail Í≥ÑÏÇ∞
// ============================================
var float trailStop = na
var int trailDir = 0

trailATR = ta.atr(trailATRLen) * trailATRMult

if close > nz(trailStop)
    trailStop := math.max(nz(trailStop), close - trailATR)
    trailDir := 1
else
    trailStop := math.min(nz(trailStop), close + trailATR)
    trailDir := -1

trailColor = trailDir == 1 ? color.lime : color.red
plot(showSmartTrail ? trailStop : na, "Smart Trail", color=trailColor, linewidth=2, style=plot.style_linebr)

// ============================================
// Ïä§Ïúô Ìè¨Ïù∏Ìä∏ ÌÉêÏßÄ
// ============================================
swingLen = input.int(5, title="Ïä§Ïúô Í∏∏Ïù¥", group="ÌïòÎ™®Îãâ Ìå®ÌÑ¥")
pivotHigh = ta.pivothigh(high, swingLen, swingLen)
pivotLow = ta.pivotlow(low, swingLen, swingLen)

var float[] swingHighs = array.new_float(0)
var float[] swingLows = array.new_float(0)
var int[] swingHighBars = array.new_int(0)
var int[] swingLowBars = array.new_int(0)

if not na(pivotHigh)
    array.unshift(swingHighs, pivotHigh)
    array.unshift(swingHighBars, bar_index - swingLen)
    if array.size(swingHighs) > 20
        array.pop(swingHighs)
        array.pop(swingHighBars)

if not na(pivotLow)
    array.unshift(swingLows, pivotLow)
    array.unshift(swingLowBars, bar_index - swingLen)
    if array.size(swingLows) > 20
        array.pop(swingLows)
        array.pop(swingLowBars)

// ============================================
// ÌîºÎ≥¥ÎÇòÏπò ÎπÑÏú® Ìï®Ïàò
// ============================================
isWithinTolerance(float actual, float target, float tolerance) =>
    actual >= target * (1 - tolerance/100) and actual <= target * (1 + tolerance/100)

calcRatio(float p1, float p2, float p3) =>
    d1 = math.abs(p2 - p1)
    d2 = math.abs(p3 - p2)
    d1 != 0 ? d2 / d1 : 0

// ============================================
// ÌïòÎ™®Îãâ Ìå®ÌÑ¥ Í≤ÄÏ¶ù Ìï®Ïàò
// ============================================
isGartley(float xab, float xad) =>
    xab >= 0.588 - fibTolerance/100 and xab <= 0.648 + fibTolerance/100 and isWithinTolerance(xad, FIB_786, fibTolerance)

isBat(float xab, float xad) =>
    xab >= 0.382 - fibTolerance/100 and xab <= 0.55 + fibTolerance/100 and isWithinTolerance(xad, FIB_886, fibTolerance)

isCrab(float xab, float xad) =>
    xab >= 0.382 - fibTolerance/100 and xab <= 0.618 + fibTolerance/100 and isWithinTolerance(xad, FIB_161, fibTolerance)

isButterfly(float xab, float xad) =>
    xab >= 0.756 - fibTolerance/100 and xab <= 0.816 + fibTolerance/100 and isWithinTolerance(xad, FIB_127, fibTolerance)

isCypher(float xab, float xac) =>
    xab >= 0.382 - fibTolerance/100 and xab <= 0.618 + fibTolerance/100 and xac >= 1.13 - fibTolerance/100 and xac <= 1.414 + fibTolerance/100

is707(float xab, float xad) =>
    xab >= 0.677 - fibTolerance/100 and xab <= 0.737 + fibTolerance/100 and isWithinTolerance(xad, FIB_141, fibTolerance)

isABCDValid(float ab, float cd) =>
    ratio = cd / ab
    isWithinTolerance(ratio, 1.0, fibTolerance) or isWithinTolerance(ratio, FIB_127, fibTolerance) or isWithinTolerance(ratio, FIB_161, fibTolerance)

// ============================================
// Ìå®ÌÑ¥ ÌíàÏßà Í≥ÑÏÇ∞ Ìï®Ïàò
// ============================================
calcQuality(string patternName, float xabRatio, float xadRatio, float ab, float cd) =>
    // Î™©Ìëú ÎπÑÏú® ÏÑ§Ï†ï
    float targetXAB = patternName == "Gartley" ? 0.618 : patternName == "Bat" ? 0.50 : patternName == "Crab" ? 0.618 : patternName == "Butterfly" ? 0.786 : patternName == "707" ? 0.707 : 0.5
    float targetXAD = patternName == "Gartley" ? 0.786 : patternName == "Bat" ? 0.886 : patternName == "Crab" ? 1.618 : patternName == "Butterfly" ? 1.272 : patternName == "707" ? 1.414 : 1.0

    // ÎπÑÏú® Ï†ïÌôïÎèÑ Ï†êÏàò (Í∞Å ÏµúÎåÄ 30Ï†ê)
    float xabAccuracy = math.max(0, 30 - math.abs(xabRatio - targetXAB) * 100)
    float xadAccuracy = math.max(0, 30 - math.abs(xadRatio - targetXAD) * 50)

    // AB=CD Ï†êÏàò (ÏµúÎåÄ 20Ï†ê)
    float abcdRatio = cd / ab
    float abcdAccuracy = math.max(0, 20 - math.abs(abcdRatio - 1.0) * 40)

    // Í∏∞Î≥∏ Ï†êÏàò 20Ï†ê
    float quality = math.min(100, 20 + xabAccuracy + xadAccuracy + abcdAccuracy)
    quality

// Perfect Ìå®ÌÑ¥ Ï≤¥ÌÅ¨ (ÌóàÏö©Ïò§Ï∞® 1.5%)
isPerfectRatio(string patternName, float xabRatio, float xadRatio) =>
    float perfectTol = 1.5
    bool isPerfect = false
    if patternName == "Gartley"
        isPerfect := isWithinTolerance(xabRatio, 0.618, perfectTol) and isWithinTolerance(xadRatio, 0.786, perfectTol)
    else if patternName == "Bat"
        isPerfect := isWithinTolerance(xabRatio, 0.50, perfectTol) and isWithinTolerance(xadRatio, 0.886, perfectTol)
    else if patternName == "Crab"
        isPerfect := isWithinTolerance(xabRatio, 0.618, perfectTol) and isWithinTolerance(xadRatio, 1.618, perfectTol)
    else if patternName == "Butterfly"
        isPerfect := isWithinTolerance(xabRatio, 0.786, perfectTol) and isWithinTolerance(xadRatio, 1.272, perfectTol)
    else if patternName == "707"
        isPerfect := isWithinTolerance(xabRatio, 0.707, perfectTol) and isWithinTolerance(xadRatio, 1.414, perfectTol)
    isPerfect

// ============================================
// XABCD Ìè¨Ïù∏Ìä∏ Ï∞æÍ∏∞
// ============================================
var string currentPattern = ""
var float currentQuality = 0.0
var bool currentIsPerfect = false
var bool currentIsBullish = false
var float currentTP1 = na
var float currentTP2 = na
var float currentSL = na
var int currentPatternBar = 0

findPattern() =>
    string patternName = ""
    bool isBullish = false
    float xP = na, float aP = na, float bP = na, float cP = na, float dP = na
    int xB = na, int aB = na, int bB = na, int cB = na, int dB = na

    if array.size(swingHighs) >= 3 and array.size(swingLows) >= 3
        // Bullish: X(Ï†ÄÏ†ê)->A(Í≥†Ï†ê)->B(Ï†ÄÏ†ê)->C(Í≥†Ï†ê)->D(Ï†ÄÏ†ê)
        if array.size(swingLows) >= 3 and array.size(swingHighs) >= 2
            tX = array.get(swingLows, 2)
            tA = array.get(swingHighs, 1)
            tB = array.get(swingLows, 1)
            tC = array.get(swingHighs, 0)
            tD = array.get(swingLows, 0)

            tXB = array.get(swingLowBars, 2)
            tAB = array.get(swingHighBars, 1)
            tBB = array.get(swingLowBars, 1)
            tCB = array.get(swingHighBars, 0)
            tDB = array.get(swingLowBars, 0)

            if tXB < tAB and tAB < tBB and tBB < tCB and tCB < tDB
                if tA > tX and tB < tA and tC > tB and tD < tC
                    xa = math.abs(tA - tX)
                    xabRatio = math.abs(tB - tX) / xa
                    xadRatio = math.abs(tD - tX) / xa
                    xacRatio = math.abs(tC - tX) / xa
                    ab = math.abs(tB - tA)
                    cd = math.abs(tD - tC)

                    if showGartley and isGartley(xabRatio, xadRatio)
                        patternName := "Gartley"
                    else if showBat and isBat(xabRatio, xadRatio)
                        patternName := "Bat"
                    else if showCrab and isCrab(xabRatio, xadRatio)
                        patternName := "Crab"
                    else if showButterfly and isButterfly(xabRatio, xadRatio)
                        patternName := "Butterfly"
                    else if showCypher and isCypher(xabRatio, xacRatio)
                        patternName := "Cypher"
                    else if show707 and is707(xabRatio, xadRatio)
                        patternName := "707"
                    else if showABCD and isABCDValid(ab, cd)
                        patternName := "AB=CD"

                    if patternName != ""
                        isBullish := true
                        xP := tX, aP := tA, bP := tB, cP := tC, dP := tD
                        xB := tXB, aB := tAB, bB := tBB, cB := tCB, dB := tDB

        // Bearish: X(Í≥†Ï†ê)->A(Ï†ÄÏ†ê)->B(Í≥†Ï†ê)->C(Ï†ÄÏ†ê)->D(Í≥†Ï†ê)
        if patternName == "" and array.size(swingHighs) >= 3 and array.size(swingLows) >= 2
            tX = array.get(swingHighs, 2)
            tA = array.get(swingLows, 1)
            tB = array.get(swingHighs, 1)
            tC = array.get(swingLows, 0)
            tD = array.get(swingHighs, 0)

            tXB = array.get(swingHighBars, 2)
            tAB = array.get(swingLowBars, 1)
            tBB = array.get(swingHighBars, 1)
            tCB = array.get(swingLowBars, 0)
            tDB = array.get(swingHighBars, 0)

            if tXB < tAB and tAB < tBB and tBB < tCB and tCB < tDB
                if tA < tX and tB > tA and tC < tB and tD > tC
                    xa = math.abs(tA - tX)
                    xabRatio = math.abs(tB - tX) / xa
                    xadRatio = math.abs(tD - tX) / xa
                    xacRatio = math.abs(tC - tX) / xa
                    ab = math.abs(tB - tA)
                    cd = math.abs(tD - tC)

                    if showGartley and isGartley(xabRatio, xadRatio)
                        patternName := "Gartley"
                    else if showBat and isBat(xabRatio, xadRatio)
                        patternName := "Bat"
                    else if showCrab and isCrab(xabRatio, xadRatio)
                        patternName := "Crab"
                    else if showButterfly and isButterfly(xabRatio, xadRatio)
                        patternName := "Butterfly"
                    else if showCypher and isCypher(xabRatio, xacRatio)
                        patternName := "Cypher"
                    else if show707 and is707(xabRatio, xadRatio)
                        patternName := "707"
                    else if showABCD and isABCDValid(ab, cd)
                        patternName := "AB=CD"

                    if patternName != ""
                        isBullish := false
                        xP := tX, aP := tA, bP := tB, cP := tC, dP := tD
                        xB := tXB, aB := tAB, bB := tBB, cB := tCB, dB := tDB

    [patternName, isBullish, xP, aP, bP, cP, dP, xB, aB, bB, cB, dB]

[detectedPattern, bullish, xP, aP, bP, cP, dP, xB, aB, bB, cB, dB] = findPattern()

// ÌíàÏßà Î∞è Perfect Ìå®ÌÑ¥ Í≥ÑÏÇ∞
float patternQuality = 0.0
bool patternIsPerfect = false

if detectedPattern != "" and not na(xP) and not na(aP) and not na(bP) and not na(dP)
    xa = math.abs(aP - xP)
    xabRatio = math.abs(bP - xP) / xa
    xadRatio = math.abs(dP - xP) / xa
    ab = math.abs(bP - aP)
    cd = math.abs(dP - cP)
    patternQuality := calcQuality(detectedPattern, xabRatio, xadRatio, ab, cd)
    patternIsPerfect := isPerfectRatio(detectedPattern, xabRatio, xadRatio)

// ÌòÑÏû¨ ÌíàÏßà Ï†ÄÏû•
currentQuality := patternQuality
currentIsPerfect := patternIsPerfect

// ============================================
// TP/SL Í≥ÑÏÇ∞
// ============================================
calcTPSL(float a, float d, float x, bool isBullish) =>
    ad = math.abs(d - a)
    xa = math.abs(a - x)
    float tp1 = isBullish ? d + ad * 0.382 : d - ad * 0.382
    float tp2 = isBullish ? d + ad * 0.618 : d - ad * 0.618
    float sl = isBullish ? x - xa * 0.1 : x + xa * 0.1
    [tp1, tp2, sl]

// ============================================
// Ìå®ÌÑ¥ ÏãúÍ∞ÅÌôî
// ============================================
var line lineXA = na, var line lineAB = na, var line lineBC = na, var line lineCD = na
var label patternLabel = na
var box przBox = na
var line tp1Line = na, var line tp2Line = na, var line slLine = na

if showHarmonic and detectedPattern != "" and not na(dB) and bar_index - dB < 5
    patternColor = bullish ? bullishColor : bearishColor

    line.delete(lineXA), line.delete(lineAB), line.delete(lineBC), line.delete(lineCD)
    label.delete(patternLabel), box.delete(przBox)
    line.delete(tp1Line), line.delete(tp2Line), line.delete(slLine)

    if showHarmonicLabels
        lineXA := line.new(xB, xP, aB, aP, color=patternColor, width=2)
        lineAB := line.new(aB, aP, bB, bP, color=patternColor, width=2)
        lineBC := line.new(bB, bP, cB, cP, color=patternColor, width=2)
        lineCD := line.new(cB, cP, dB, dP, color=patternColor, width=2)

        labelText = (bullish ? "BULL " : "BEAR ") + detectedPattern
        labelY = bullish ? dP - atrValue * 0.5 : dP + atrValue * 0.5
        labelStyle = bullish ? label.style_label_up : label.style_label_down
        patternLabel := label.new(dB, labelY, labelText, color=patternColor, textcolor=color.white, style=labelStyle, size=size.normal)

    [tp1, tp2, sl] = calcTPSL(aP, dP, xP, bullish)

    if showPRZ
        xa = math.abs(aP - xP)
        przTop = bullish ? dP : dP + xa * 0.1
        przBottom = bullish ? dP - xa * 0.1 : dP
        przBox := box.new(dB - 5, math.max(przTop, przBottom), dB + 20, math.min(przTop, przBottom), bgcolor=przColor, border_color=color.yellow)

    if showTPSL
        tp1Line := line.new(dB, tp1, bar_index + 15, tp1, color=color.lime, width=2, style=line.style_dashed)
        tp2Line := line.new(dB, tp2, bar_index + 15, tp2, color=color.lime, width=2, style=line.style_dashed)
        slLine := line.new(dB, sl, bar_index + 15, sl, color=color.red, width=2, style=line.style_dashed)

    currentPattern := detectedPattern
    currentIsBullish := bullish
    currentTP1 := tp1
    currentTP2 := tp2
    currentSL := sl
    currentPatternBar := dB

// ============================================
// RSI BAMM
// ============================================
rsiValue = ta.rsi(close, rsiBAMMLength)
rsiOB = rsiValue > rsiBAMMOB
rsiOS = rsiValue < rsiBAMMOS
rsiCross50Up = ta.crossover(rsiValue, 50)
rsiCross50Down = ta.crossunder(rsiValue, 50)

// Îã§Ïù¥Î≤ÑÏ†ÑÏä§
priceHigh = high > ta.highest(high, 14)[1]
priceLow = low < ta.lowest(low, 14)[1]
rsiHigher = rsiValue > ta.highest(rsiValue, 14)[1]
rsiLower = rsiValue < ta.lowest(rsiValue, 14)[1]

bullishDiv = priceLow and not rsiLower and rsiValue[1] < 40
bearishDiv = priceHigh and not rsiHigher and rsiValue[1] > 60

rsiBAMMBuy = showRSIBAMM and bullishDiv and rsiCross50Up
rsiBAMMSell = showRSIBAMM and bearishDiv and rsiCross50Down

if rsiBAMMBuy
    label.new(bar_index, low - atrValue, "BAMM\nBUY", color=color.lime, textcolor=color.black, style=label.style_label_up, size=size.small)

if rsiBAMMSell and showShortSignals
    label.new(bar_index, high + atrValue, "BAMM\nSELL", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.small)

// ============================================
// Í≥†Îûò ÎùºÎ≤® ÌëúÏãú
// ============================================
if showWhale and whaleBuy
    label.new(bar_index, low - atrValue * 0.5, whaleGrade + "\nÎß§Ïàò", color=color.blue, textcolor=color.white, style=label.style_label_up, size=size.small)

if showWhale and whaleSell
    label.new(bar_index, high + atrValue * 0.5, whaleGrade + "\nÎß§ÎèÑ", color=color.purple, textcolor=color.white, style=label.style_label_down, size=size.small)

// Í≥†Îûò Î∞∞Í≤ΩÏÉâ
bgcolor(showWhale and whaleBuy ? color.new(color.blue, 90) : na)
bgcolor(showWhale and whaleSell ? color.new(color.purple, 90) : na)

// ============================================
// Ï†ïÌôïÏÑ± ÌïÑÌÑ∞ Í≥ÑÏÇ∞
// ============================================
// Ï∂îÏÑ∏ EMA
trendEMA = ta.ema(close, trendEMALen)
bullishTrend = close > trendEMA and trendEMA > trendEMA[5]
bearishTrend = close < trendEMA and trendEMA < trendEMA[5]

// Í±∞ÎûòÎüâ ÌôïÏù∏
volumeMA = ta.sma(volume, volumeLength)
volumeConfirm = volume > volumeMA * volumeMultiplier

// RSI ÌôïÏù∏ (PRZÏóêÏÑú Í≥ºÎß§Ïàò/Í≥ºÎß§ÎèÑ)
rsiConfirmBull = rsiValue < rsiConfirmLevel
rsiConfirmBear = rsiValue > (100 - rsiConfirmLevel)

// Ïª®ÌîåÎ£®Ïñ∏Ïä§ Ï†êÏàò Í≥ÑÏÇ∞ Ìï®Ïàò
calcConfluenceScore(bool isBullish) =>
    int confScore = 0
    // 1. Ï∂îÏÑ∏ ÌôïÏù∏
    confScore += (isBullish and bullishTrend) or (not isBullish and bearishTrend) ? 1 : 0
    // 2. RSI ÌôïÏù∏
    confScore += (isBullish and rsiConfirmBull) or (not isBullish and rsiConfirmBear) ? 1 : 0
    // 3. Í±∞ÎûòÎüâ ÌôïÏù∏
    confScore += volumeConfirm ? 1 : 0
    // 4. Killzone ÌôïÏù∏
    confScore += killzoneActive ? 1 : 0
    // 5. MACD ÌôïÏù∏
    confScore += (isBullish and macdLine > signalLine) or (not isBullish and macdLine < signalLine) ? 1 : 0
    confScore

// ÌïòÎ™®Îãâ Ìå®ÌÑ¥ ÌïÑÌÑ∞ Ï†ÅÏö©
harmonicConfluenceBull = calcConfluenceScore(true)
harmonicConfluenceBear = calcConfluenceScore(false)

// ÌïÑÌÑ∞ ÌÜµÍ≥º Ïó¨Î∂Ä ÌôïÏù∏
passQualityFilter(float quality, bool isPerfect) =>
    bool qualityOK = quality >= minQualityScore
    bool perfectOK = not requirePerfect or isPerfect
    qualityOK and perfectOK

passTrendFilter(bool isBullish) =>
    not useTrendFilter or (isBullish and bullishTrend) or (not isBullish and bearishTrend)

passRSIFilter(bool isBullish) =>
    not useRSIConfirm or (isBullish and rsiConfirmBull) or (not isBullish and rsiConfirmBear)

passVolumeFilter() =>
    not useVolumeFilter or volumeConfirm

passConfluenceFilter(bool isBullish) =>
    not useConfluence or (isBullish ? harmonicConfluenceBull : harmonicConfluenceBear) >= minConfluenceScore

// Î™®Îì† ÌïÑÌÑ∞ ÌÜµÍ≥º ÌôïÏù∏
passAllFilters(bool isBullish, float quality, bool isPerfect) =>
    passQualityFilter(quality, isPerfect) and passTrendFilter(isBullish) and passRSIFilter(isBullish) and passVolumeFilter() and passConfluenceFilter(isBullish)

if rsiBAMMBuy
    label.new(bar_index, low - atrValue, "BAMM\nBUY", color=color.lime, textcolor=color.black, style=label.style_label_up, size=size.small)

if rsiBAMMSell and showShortSignals
    label.new(bar_index, high + atrValue, "BAMM\nSELL", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.small)

// ============================================
// Ï†êÏàò ÏãúÏä§ÌÖú (Í∞ÑÏÜåÌôî)
// ============================================
score = 0
score += ema8 > ema21 ? 3 : ema8 < ema21 ? -3 : 0
score += close > ema200 ? 3 : close < ema200 ? -3 : 0
score += macdLine > signalLine ? 3 : macdLine < signalLine ? -3 : 0
score += rsi > 50 ? 2 : rsi < 50 ? -2 : 0
score += volSpike ? 2 : 0
score += trailDir == 1 ? 3 : -3
score += killzoneActive ? 2 : 0
score += detectedPattern != "" and bullish ? 5 : detectedPattern != "" and not bullish ? -5 : 0

string signalStrength = math.abs(score) >= 15 ? "SUPER" : math.abs(score) >= 10 ? "STRONG" : math.abs(score) >= 5 ? "NORMAL" : "WEAK"
bool longSignal = score >= 10 and killzoneActive
bool shortSignal = score <= -10 and killzoneActive and showShortSignals

// ============================================
// ÌïÑÌÑ∞ Ï†ÅÏö©Îêú Ïã†Ìò∏ (Ï†ïÌôïÏÑ± Ìñ•ÏÉÅ)
// ============================================
// ÌïòÎ™®Îãâ ÌïÑÌÑ∞ Ï†ÅÏö©
bool harmonicPassFilter = passAllFilters(bullish, patternQuality, patternIsPerfect)
bool filteredHarmonic = detectedPattern != "" and harmonicPassFilter

// ÌïÑÌÑ∞ Ï†ÅÏö©Îêú ÌïòÎ™®Îãâ Bullish/Bearish
bool filteredHarmonicBull = filteredHarmonic and bullish
bool filteredHarmonicBear = filteredHarmonic and not bullish

// ÌïÑÌÑ∞ Ï†ÅÏö©Îêú ICT Ïã†Ìò∏
bool filteredLongSignal = longSignal and passTrendFilter(true) and passVolumeFilter()
bool filteredShortSignal = shortSignal and passTrendFilter(false) and passVolumeFilter()

// ÌïÑÌÑ∞ Ï†ÅÏö©Îêú BAMM
bool filteredBAMMBuy = rsiBAMMBuy and passVolumeFilter() and (not useTrendFilter or bullishTrend)
bool filteredBAMMSell = rsiBAMMSell and passVolumeFilter() and (not useTrendFilter or bearishTrend)

// Ïª®ÌîåÎ£®Ïñ∏Ïä§ Ï†êÏàò ÌëúÏãúÏö©
int bullConfluence = harmonicConfluenceBull
int bearConfluence = harmonicConfluenceBear

// ============================================
// ÏãúÍ∑∏ÎÑê ÌëúÏãú
// ============================================
if filteredLongSignal and (signalStrength == "SUPER" or signalStrength == "STRONG")
    label.new(bar_index, low - atrValue * 1.5, signalStrength + "\nLONG", color=color.new(color.green, 0), textcolor=color.white, style=label.style_label_up, size=size.normal)

if filteredShortSignal and (signalStrength == "SUPER" or signalStrength == "STRONG")
    label.new(bar_index, high + atrValue * 1.5, signalStrength + "\nSHORT", color=color.new(color.red, 0), textcolor=color.white, style=label.style_label_down, size=size.normal)

// ============================================
// ÏïåÎûå Ï°∞Í±¥ (ÌïÑÌÑ∞ Ï†ÅÏö©Îê®)
// ============================================
// ÌÜµÌï© ÏïåÎûå (ÌïÑÌÑ∞ Ï†ÅÏö©) - Î∞©Ìñ• Íµ¨Î∂Ñ ÏïàÎê®, ÎπÑÏ∂îÏ≤ú
// alertcondition(filteredHarmonic or filteredLongSignal or filteredShortSignal, title="[V42] Î™®Îì† Ïã†Ìò∏ (ÌïÑÌÑ∞)", message="V42 Ïã†Ìò∏! {{ticker}} {{interval}} - ÌïÑÌÑ∞ ÌÜµÍ≥º")

// ÌïòÎ™®Îãâ Ï†ÑÏö© (ÌïÑÌÑ∞ Ï†ÅÏö©)
alertcondition(filteredHarmonic, title="[V42] ÌïòÎ™®Îãâ (ÌïÑÌÑ∞)", message="ÌïòÎ™®Îãâ Ìå®ÌÑ¥! {{ticker}} {{interval}} - ÌíàÏßà/Ïª®ÌîåÎ£®Ïñ∏Ïä§ ÌôïÏù∏Îê®")
alertcondition(filteredHarmonicBull, title="[V42] Bullish ÌïòÎ™®Îãâ (ÌïÑÌÑ∞)", message="Bullish ÌïòÎ™®Îãâ! {{ticker}} - Í≥†ÌíàÏßà")
alertcondition(filteredHarmonicBear, title="[V42] Bearish ÌïòÎ™®Îãâ (ÌïÑÌÑ∞)", message="Bearish ÌïòÎ™®Îãâ! {{ticker}} - Í≥†ÌíàÏßà")

// ICT Ïã†Ìò∏ (ÌïÑÌÑ∞ Ï†ÅÏö©)
alertcondition(filteredLongSignal, title="[V42] LONG (ÌïÑÌÑ∞)", message="LONG Ïã†Ìò∏! {{ticker}} {{interval}} - Ï∂îÏÑ∏/Í±∞ÎûòÎüâ ÌôïÏù∏")
alertcondition(filteredShortSignal, title="[V42] SHORT (ÌïÑÌÑ∞)", message="SHORT Ïã†Ìò∏! {{ticker}} {{interval}} - Ï∂îÏÑ∏/Í±∞ÎûòÎüâ ÌôïÏù∏")

// BAMM (ÌïÑÌÑ∞ Ï†ÅÏö©)
alertcondition(filteredBAMMBuy, title="[V42] BAMM Îß§Ïàò (ÌïÑÌÑ∞)", message="RSI BAMM Îß§Ïàò! {{ticker}} - Í±∞ÎûòÎüâ ÌôïÏù∏")
alertcondition(filteredBAMMSell, title="[V42] BAMM Îß§ÎèÑ (ÌïÑÌÑ∞)", message="RSI BAMM Îß§ÎèÑ! {{ticker}} - Í±∞ÎûòÎüâ ÌôïÏù∏")

// Î≥µÌï© Ïã†Ìò∏ (ÌïÑÌÑ∞ Ï†ÅÏö©) - Í∞ÄÏû• Ï†ïÌôï ‚òÖ‚òÖ‚òÖ Í∂åÏû• ‚òÖ‚òÖ‚òÖ
alertcondition(filteredHarmonicBull or filteredLongSignal or filteredBAMMBuy, title="[V42] ‚òÖ LONG (ÌïÑÌÑ∞)", message=">>> LONG <<< {{ticker}} {{interval}} - Îß§Ïàò Ïã†Ìò∏!")
alertcondition(filteredHarmonicBear or filteredShortSignal or filteredBAMMSell, title="[V42] ‚òÖ SHORT (ÌïÑÌÑ∞)", message=">>> SHORT <<< {{ticker}} {{interval}} - Îß§ÎèÑ Ïã†Ìò∏!")

// Í≥†Îûò ÏïåÎûå
alertcondition(whaleBuy, title="[V42] Í≥†Îûò Îß§Ïàò", message="üêã Í≥†Îûò Îß§Ïàò! {{ticker}} {{interval}} - ÎåÄÎüâ Îß§ÏàòÏÑ∏ Í∞êÏßÄ")
alertcondition(whaleSell, title="[V42] Í≥†Îûò Îß§ÎèÑ", message="üêã Í≥†Îûò Îß§ÎèÑ! {{ticker}} {{interval}} - ÎåÄÎüâ Îß§ÎèÑÏÑ∏ Í∞êÏßÄ")

// === ÌïÑÌÑ∞ ÎØ∏Ï†ÅÏö© (Í∏∞Ï°¥ Î≤ÑÏ†Ñ Ìò∏Ìôò) ===
alertcondition(detectedPattern != "" or longSignal or shortSignal, title="[V42] Î™®Îì† Ïã†Ìò∏ (ÏõêÎ≥∏)", message="V42 Ïã†Ìò∏! {{ticker}} {{interval}}")
alertcondition(detectedPattern != "", title="[V42] ÌïòÎ™®Îãâ (ÏõêÎ≥∏)", message="ÌïòÎ™®Îãâ Ìå®ÌÑ¥! {{ticker}} {{interval}}")
alertcondition(longSignal, title="[V42] LONG (ÏõêÎ≥∏)", message="LONG Ïã†Ìò∏! {{ticker}} {{interval}}")
alertcondition(shortSignal, title="[V42] SHORT (ÏõêÎ≥∏)", message="SHORT Ïã†Ìò∏! {{ticker}} {{interval}}")

// ============================================
// Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î
// ============================================
var table infoTable = table.new(position.top_right, 2, 17, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "V42 Ultimate", bgcolor=color.new(color.purple, 50), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Ï†ïÌôïÏÑ± Í∞ïÌôî", bgcolor=color.new(color.purple, 50), text_color=color.white, text_size=size.small)

    table.cell(infoTable, 0, 1, "Pattern", text_color=color.gray, text_size=size.tiny)
    pText = currentPattern != "" ? currentPattern : "None"
    pColor = currentPattern != "" ? (currentIsBullish ? color.new(color.green, 50) : color.new(color.red, 50)) : color.new(color.gray, 70)
    table.cell(infoTable, 1, 1, pText, bgcolor=pColor, text_color=color.white, text_size=size.tiny)

    // ÌíàÏßà Ï†êÏàò (Ïã†Í∑ú)
    table.cell(infoTable, 0, 2, "Quality", text_color=color.gray, text_size=size.tiny)
    qColor = currentQuality >= 80 ? color.lime : currentQuality >= 60 ? color.yellow : currentQuality >= 40 ? color.orange : color.red
    qText = currentPattern != "" ? str.tostring(currentQuality, "#") + "%" + (currentIsPerfect ? " PERFECT" : "") : "-"
    table.cell(infoTable, 1, 2, qText, text_color=qColor, text_size=size.tiny)

    // Ïª®ÌîåÎ£®Ïñ∏Ïä§ (Ïã†Í∑ú)
    table.cell(infoTable, 0, 3, "Confluence", text_color=color.gray, text_size=size.tiny)
    confScore = currentIsBullish ? bullConfluence : bearConfluence
    confColor = confScore >= 4 ? color.lime : confScore >= 3 ? color.yellow : confScore >= 2 ? color.orange : color.red
    confText = str.tostring(confScore) + "/5"
    table.cell(infoTable, 1, 3, confText, text_color=confColor, text_size=size.tiny)

    table.cell(infoTable, 0, 4, "Direction", text_color=color.gray, text_size=size.tiny)
    dText = currentPattern != "" ? (currentIsBullish ? "BULLISH" : "BEARISH") : "-"
    table.cell(infoTable, 1, 4, dText, text_color=currentIsBullish ? color.lime : color.red, text_size=size.tiny)

    table.cell(infoTable, 0, 5, "ICT Score", text_color=color.gray, text_size=size.tiny)
    sColor = score >= 10 ? color.lime : score <= -10 ? color.red : color.yellow
    table.cell(infoTable, 1, 5, str.tostring(score) + " (" + signalStrength + ")", text_color=sColor, text_size=size.tiny)

    table.cell(infoTable, 0, 6, "Killzone", text_color=color.gray, text_size=size.tiny)
    kzText = isLondonOpen ? "London" : isNYOpen ? "NY" : isLondonClose ? "LDN Close" : "OFF"
    kzColor = killzoneActive and isInKillzone ? color.lime : color.gray
    table.cell(infoTable, 1, 6, kzText, text_color=kzColor, text_size=size.tiny)

    // ÌïÑÌÑ∞ ÏÉÅÌÉú (Ïã†Í∑ú)
    table.cell(infoTable, 0, 7, "Filters", text_color=color.gray, text_size=size.tiny)
    filterOK = harmonicPassFilter or (not (detectedPattern != ""))
    fText = (useTrendFilter ? (bullishTrend ? "T" : bearishTrend ? "t" : "-") : "") + (useVolumeFilter ? (volumeConfirm ? "V" : "-") : "") + (useRSIConfirm ? (rsiConfirmBull or rsiConfirmBear ? "R" : "-") : "")
    fColor = filterOK ? color.lime : color.orange
    table.cell(infoTable, 1, 7, fText != "" ? fText : "OFF", text_color=fColor, text_size=size.tiny)

    table.cell(infoTable, 0, 8, "RSI", text_color=color.gray, text_size=size.tiny)
    rColor = rsiOB ? color.red : rsiOS ? color.lime : color.white
    table.cell(infoTable, 1, 8, str.tostring(rsiValue, "#.#"), text_color=rColor, text_size=size.tiny)

    table.cell(infoTable, 0, 9, "Trail", text_color=color.gray, text_size=size.tiny)
    tText = trailDir == 1 ? "LONG" : "SHORT"
    table.cell(infoTable, 1, 9, tText, text_color=trailDir == 1 ? color.lime : color.red, text_size=size.tiny)

    table.cell(infoTable, 0, 10, "TP1", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 10, not na(currentTP1) ? str.tostring(currentTP1, "#.##") : "-", text_color=color.lime, text_size=size.tiny)

    table.cell(infoTable, 0, 11, "TP2", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 11, not na(currentTP2) ? str.tostring(currentTP2, "#.##") : "-", text_color=color.lime, text_size=size.tiny)

    table.cell(infoTable, 0, 12, "SL", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 12, not na(currentSL) ? str.tostring(currentSL, "#.##") : "-", text_color=color.red, text_size=size.tiny)

    // Í≥†Îûò ÏÉÅÌÉú
    table.cell(infoTable, 0, 13, "Í≥†Îûò", text_color=color.gray, text_size=size.tiny)
    whaleText = whaleBuy ? "ÎåÄÎüâÎß§Ïàò" : whaleSell ? "ÎåÄÎüâÎß§ÎèÑ" : "ÏóÜÏùå"
    wColor = whaleBuy ? color.aqua : whaleSell ? color.fuchsia : color.gray
    table.cell(infoTable, 1, 13, whaleText + (isWhaleVolume ? " " + str.tostring(volRatio, "#.#") + "x" : ""), text_color=wColor, text_size=size.tiny)

    // Delta ÏÉÅÌÉú
    table.cell(infoTable, 0, 14, "Delta", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 14, deltaGrade + " " + str.tostring(deltaRatio, "#") + "%", text_color=deltaColor, text_size=size.tiny)

    // CVD Ï∂îÏÑ∏
    table.cell(infoTable, 0, 15, "CVD", text_color=color.gray, text_size=size.tiny)
    cvdText = cvdUptrend ? "ÏÉÅÏäπ‚Üë" : cvdDowntrend ? "ÌïòÎùΩ‚Üì" : "Ï§ëÎ¶Ω"
    cvdColor = cvdUptrend ? color.lime : cvdDowntrend ? color.red : color.gray
    table.cell(infoTable, 1, 15, cvdText, text_color=cvdColor, text_size=size.tiny)

    // Ïã†Ìò∏ ÏÉÅÌÉú
    table.cell(infoTable, 0, 16, "Signal", text_color=color.gray, text_size=size.tiny)
    sigText = filteredHarmonicBull or filteredLongSignal or filteredBAMMBuy ? "LONG" : filteredHarmonicBear or filteredShortSignal or filteredBAMMSell ? "SHORT" : "WAIT"
    sigColor = sigText == "LONG" ? color.lime : sigText == "SHORT" ? color.red : color.gray
    table.cell(infoTable, 1, 16, sigText, bgcolor=sigText != "WAIT" ? color.new(sigColor, 50) : color.new(color.gray, 80), text_color=color.white, text_size=size.tiny)

// ============================================
// ÌîåÎ°Ø
// ============================================
plot(0, display=display.none)
