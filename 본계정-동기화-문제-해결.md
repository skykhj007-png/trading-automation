# 본계정 Bitget 포지션 동기화 문제 해결

## 🔴 문제 상황
- 어제 Bitget에서 숏 수동 진입 → 구글시트에 기록 안 됨
- 오늘 아침 반익절 → 구글시트에 기록 안 됨

**원인**: Bitget 포지션 동기화 트리거가 작동하지 않음

---

## 🔍 문제 진단

### 원인 1: 트리거가 꺼져있거나 삭제됨 (80% 확률)

**확인 방법**:
```
Apps Script → 좌측 트리거 (⏰ 시계 아이콘)
```

**필요한 트리거**:
- `syncBitgetPositions` (1분마다) ← 이게 포지션 동기화
- `checkClosedPositions` (1분마다) ← 이게 청산 감지

**없으면** → 트리거 재생성 필요

---

### 원인 2: 트리거는 있는데 오류 발생 (15% 확률)

**확인 방법**:
```
Apps Script → 트리거 → syncBitgetPositions 우측 ... → 실행 로그
```

**오류 예시**:
```
오류    Exception: API error
오류    Bitget connection failed
```

---

### 원인 3: Bitget API 키 문제 (5% 확률)

**확인 방법**:
```javascript
testBitgetConnection()  // Apps Script에서 실행
```

---

## 🚀 즉시 해결 방법

### 방법 1: 트리거 재생성 (권장)

**본계정 Apps Script에서 실행**:
```javascript
원클릭_전체설정()
```

이 함수가 자동으로:
- 기존 트리거 삭제
- 새 트리거 생성 (syncBitgetPositions, checkClosedPositions)
- Bitget API 테스트

**실행 후 로그 확인**:
```
✅ syncBitgetPositions (1분마다)
✅ checkClosedPositions (1분마다)
✅ Bitget 연결 성공!
```

---

### 방법 2: 수동 동기화 (지금 당장)

**현재 Bitget 포지션을 즉시 시트에 반영**:

```javascript
// Apps Script에서 실행
syncBitgetPositions()
```

**이 함수가 하는 일**:
1. Bitget API로 현재 포지션 조회
2. 구글시트와 비교
3. 새 포지션 → 자동매매일지에 추가
4. 청산된 포지션 → 청산 기록

**실행 즉시 시트 확인**:
```
V25 자동매매일지 시트
→ 새 행 추가되어야 함
```

---

### 방법 3: 청산 기록 수동 추가 (이미 청산된 경우)

**오늘 아침 반익절한 것을 수동으로 기록**:

```javascript
// Apps Script에서 실행
// 예시: BTC SHORT 포지션 50% 익절
manualLogProfit('BTC-USDT', 'SHORT', 진입가, 청산가, 50)

// 실제 예시:
manualLogProfit('BTC-USDT', 'SHORT', 97500, 96800, 50)
```

---

## 📋 단계별 해결 가이드

### 1단계: 본계정 Apps Script 열기

```
https://script.google.com
→ 메인 계정 프로젝트 선택
```

---

### 2단계: 트리거 확인

**좌측 트리거 클릭**

**체크**:
- [ ] syncBitgetPositions 있음 (1분마다)
- [ ] checkClosedPositions 있음 (1분마다)

**없으면**:
```javascript
원클릭_전체설정()  // 실행
```

---

### 3단계: Bitget 동기화 즉시 실행

```javascript
syncBitgetPositions()  // 실행
```

**로그 확인**:
```
정보    Bitget 포지션 확인 중...
정보    [BTC-USDT] SHORT 포지션 발견
정보    V25 자동매매일지에 기록
```

---

### 4단계: 시트 확인

**V25 자동매매일지 시트 열기**

**확인할 것**:
- 어제 진입한 숏 포지션 기록되었는가?
- 오늘 반익절 기록되었는가?

**없으면**:
- Bitget에서 포지션이 완전히 청산되었는지 확인
- 청산되었으면 기록 불가 (이미 지나감)

---

## 🔄 동기화 작동 원리

### 정상 작동 시:

```
Bitget에서 포지션 진입
     ↓ (1분 이내)
syncBitgetPositions 트리거 실행
     ↓
Bitget API 호출
     ↓
새 포지션 감지
     ↓
V25 자동매매일지에 기록
"진입" 행 추가
```

```
Bitget에서 포지션 청산 (TP/SL 또는 수동)
     ↓ (1분 이내)
syncBitgetPositions 실행
     ↓
포지션 없어진 것 감지
     ↓
checkClosedPositions 실행
     ↓
V25 자동매매일지에 기록
"청산" 행 추가
```

---

## ⚠️ 트리거가 꺼지는 이유

### 자주 발생하는 원인:

1. **Apps Script 오류**
   - API 오류가 반복되면 Google이 트리거 자동 중지

2. **권한 만료**
   - Google 계정 보안 설정 변경
   - 재인증 필요

3. **수동 삭제**
   - 실수로 트리거 삭제

4. **배포 재설정**
   - 새 배포 시 트리기 유지되지만 간혹 문제 발생

---

## 🛡️ 자동 복구: 워치독

**워치독 트리거 활성화**:

```javascript
// Apps Script에서 실행
startFullSystem()
```

**워치독이 하는 일**:
- 15분마다 트리거 상태 체크
- 트리거 꺼져있으면 자동 재생성
- 시스템 자동 복구

---

## 📊 현재 상황 정리

### 어제 진입한 숏:
```
Bitget: 포지션 있음
시트: 기록 없음
→ syncBitgetPositions 실행하면 기록됨
```

**단, 주의**:
- 이미 청산되었으면 Bitget에 포지션 없음
- 포지션 없으면 동기화해도 기록 안 됨

### 오늘 아침 반익절:
```
Bitget: 50% 청산됨
시트: 청산 기록 없음
→ 트리거가 안 돌아서 감지 못함
```

**해결**:
- 트리거 재생성
- 다음부터는 자동 기록됨
- 이미 지난 청산은 수동 기록 필요

---

## 🎯 지금 실행하세요!

### 순서:

```
1. 본계정 Apps Script 열기

2. 트리거 확인
   좌측 트리거 → 2개 있는지 확인

3. 없으면:
   원클릭_전체설정() 실행

4. 즉시 동기화:
   syncBitgetPositions() 실행

5. 시트 확인:
   V25 자동매매일지 → 새 기록 있는지 확인
```

---

## 💡 앞으로 자동화

**워치독 시작**:
```javascript
startFullSystem()
```

**이제 트리거가 꺼져도**:
- 15분 이내 자동 복구
- 시스템 항상 작동

---

## 🔍 진단 함수

**본계정에도 진단 함수 추가**:

본계정 Code.gs에 보조계정과 동일한 진단 함수를 추가하려면:

```
trading-automation/진단함수-복사용.gs
→ 전체 복사
→ 본계정 Code.gs 맨 끝에 붙여넣기
```

**실행**:
```javascript
보조계정_자동매매_진단()  // 함수 이름은 동일
```

---

## 📞 긴급 체크리스트

본계정 동기화 문제 발생 시:

```
□ 트리거 확인
  Apps Script → 트리거
  syncBitgetPositions, checkClosedPositions 있는지

□ 트리거 없으면
  원클릭_전체설정() 실행

□ 즉시 동기화
  syncBitgetPositions() 실행

□ Bitget 포지션 확인
  Bitget 앱/웹에서 현재 포지션 확인

□ 시트 확인
  V25 자동매매일지 → 기록되었는지 확인
```

---

## 🆘 이미 청산된 거래 기록

**완전히 청산된 포지션은 자동 기록 불가**

**수동 기록 방법**:

### 방법 1: 직접 시트에 입력
```
V25 자동매매일지 시트
→ 새 행 추가
→ 수동으로 정보 입력
```

### 방법 2: 스크립트로 기록 (정확함)
```javascript
// Apps Script에서 실행
// logTradeResult(포지션정보, 청산유형, 청산가, 수익률)

var position = {
  market: 'BTC-USDT',
  side: 'SHORT',
  entryPrice: 97500,
  tp1: 96800,
  tp2: 96200,
  sl: 98500,
  size: 0.01
};

logTradeResult(position, '1차익절', 96800, -0.72);
```

---

## ✅ 완료 후 확인

트리거 재생성 후:

```
1. Bitget에서 테스트 진입
   (소액으로 테스트)

2. 1분 후 시트 확인
   V25 자동매매일지에 기록되는지

3. 수동 청산

4. 1분 후 시트 확인
   청산 기록되는지

5. ✅ 자동 동기화 작동!
```
