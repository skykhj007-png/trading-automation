//@version=5
indicator("V39 MTF Confluence Pro", overlay=true, max_labels_count=500, max_lines_count=500, max_boxes_count=200)

// ============================================
// V39 MTF Confluence Pro - í†µí•© ë¶„ì„ ì‹œìŠ¤í…œ
//
// V38 + BOS/EMA êµ¬ì¡° ë¶„ì„ í†µí•© ë²„ì „
// - ë©€í‹°TF ë¶„ì„ (5m/15m/1H/4H/D)
// - EMA ê°ë„ë³„ ìƒ‰ìƒ (ì¶”ì„¸ ê°•ë„)
// - ì‹œì¥ êµ¬ì¡° (HH/HL/LH/LL)
// - BOS ë°•ìŠ¤ + CHoCH ë¼ë²¨
// - 30ì  ì ìˆ˜ ì‹œìŠ¤í…œ
// ============================================

// ============================================
// ê¸°ë³¸ ì„¤ì •
// ============================================

tradeMode = input.string("í˜„ë¬¼", title="ê±°ë˜ ëª¨ë“œ", options=["ì„ ë¬¼", "í˜„ë¬¼", "ì£¼ì‹"], group="ê¸°ë³¸ ì„¤ì •", tooltip="í˜„ë¬¼/ì£¼ì‹: SHORT ì‹œê·¸ë„ ìˆ¨ê¹€")
displayMode = input.string("ìµœì†Œí™”", title="í™”ë©´ ëª¨ë“œ", options=["ì „ì²´", "ìµœì†Œí™”", "í…Œì´ë¸”ë§Œ"], group="ê¸°ë³¸ ì„¤ì •", tooltip="ìµœì†Œí™”: Smart Trail + ì‹œê·¸ë„ë§Œ í‘œì‹œ")
signalMode = input.string("STRONG ì´ìƒ", title="ì‹œê·¸ë„ í‘œì‹œ", options=["ì „ì²´", "STRONG ì´ìƒ", "SUPERë§Œ"], group="ê¸°ë³¸ ì„¤ì •", tooltip="ì‹œê·¸ë„ í•„í„°ë§ ìˆ˜ì¤€")

// ê±°ë˜ ëª¨ë“œì— ë”°ë¥¸ ì„¤ì •
bool isFutures = tradeMode == "ì„ ë¬¼"
bool showShortSignals = isFutures  // ì„ ë¬¼ë§Œ SHORT í‘œì‹œ

// í™”ë©´ ëª¨ë“œì— ë”°ë¥¸ ì„¤ì •
bool isMinimalMode = displayMode == "ìµœì†Œí™”"
bool isTableOnlyMode = displayMode == "í…Œì´ë¸”ë§Œ"
bool showVisuals = not isTableOnlyMode

// ============================================
// í‘œì‹œ ì„¤ì •
// ============================================

showSR = input.bool(true, title="ì§€ì§€/ì €í•­ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showHTFTrend = input.bool(true, title="HTF ì¶”ì„¸ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •")
showEMA = input.bool(false, title="EMA í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showBB = input.bool(false, title="ë³¼ë¦°ì €ë°´ë“œ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showDivergence = input.bool(false, title="ë‹¤ì´ë²„ì „ìŠ¤ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showInfoTable = input.bool(true, title="ì •ë³´ í…Œì´ë¸”", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode
showMiniPanel = input.bool(true, title="ë¯¸ë‹ˆ íŒ¨ë„ (ìµœì†Œí™” ëª¨ë“œ)", group="í‘œì‹œ ì„¤ì •")  // ìµœì†Œí™” ëª¨ë“œìš© ê°„ë‹¨ íŒ¨ë„
showSignalLabel = input.bool(false, title="ì‹œê·¸ë„ ë¼ë²¨", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode

volThreshold = input.float(1.5, title="ê±°ë˜ëŸ‰ ê¸‰ì¦ ë°°ìˆ˜", minval=1.0, maxval=5.0, step=0.1, group="ê±°ë˜ëŸ‰ ì„¤ì •")
volHighThreshold = input.float(2.5, title="ê±°ë˜ëŸ‰ í­ì¦ ë°°ìˆ˜", minval=1.5, maxval=10.0, step=0.5, group="ê±°ë˜ëŸ‰ ì„¤ì •")

// í”¼ë´‡ ì„¤ì •
pivotLeft = input.int(5, title="í”¼ë´‡ ì¢Œì¸¡ ë°”", minval=2, maxval=20, group="í”¼ë´‡ ì„¤ì •")
pivotRight = input.int(2, title="í”¼ë´‡ ìš°ì¸¡ ë°”", minval=1, maxval=10, group="í”¼ë´‡ ì„¤ì •")

// ============================================
// SMC (Smart Money Concepts) ì„¤ì •
// ============================================
showSMC = input.bool(true, title="SMC ê¸°ëŠ¥ í™œì„±í™”", group="SMC ì„¤ì •") and showVisuals
showOrderBlocks = input.bool(false, title="Order Blocks í‘œì‹œ", group="SMC ì„¤ì •") and not isMinimalMode  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showFVG = input.bool(false, title="Fair Value Gaps í‘œì‹œ", group="SMC ì„¤ì •")  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showBOS = input.bool(false, title="BOS/CHoCH í‘œì‹œ", group="SMC ì„¤ì •")  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showBOSBox = input.bool(false, title="BOS ë°•ìŠ¤ í‘œì‹œ", group="SMC ì„¤ì •")  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showStructureLabels = input.bool(false, title="êµ¬ì¡° ë¼ë²¨ (HH/HL/LH/LL)", group="SMC ì„¤ì •")  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showSmartTrail = input.bool(true, title="Smart Trail í‘œì‹œ", group="SMC ì„¤ì •")  // í•µì‹¬ - í•­ìƒ í‘œì‹œ
showLiquidityLevels = input.bool(false, title="Liquidity Levels í‘œì‹œ", group="SMC ì„¤ì •") and not isMinimalMode  // ê¸°ë³¸ê°’ OFF
showEMAAngle = input.bool(true, title="EMA ê°ë„ ìƒ‰ìƒ", group="SMC ì„¤ì •")  // EMA ê°ë„ë³„ ìƒ‰ìƒ

obLookback = input.int(20, title="Order Block íƒìƒ‰ ë²”ìœ„", minval=5, maxval=100, group="SMC ì„¤ì •")
fvgMinSize = input.float(0.1, title="FVG ìµœì†Œ í¬ê¸° (%)", minval=0.01, maxval=1.0, step=0.01, group="SMC ì„¤ì •")
swingLength = input.int(10, title="Swing íƒìƒ‰ ê¸¸ì´", minval=3, maxval=50, group="SMC ì„¤ì •")
emaAngleLength = input.int(14, title="EMA ê°ë„ ê¸¸ì´", minval=5, maxval=50, group="SMC ì„¤ì •")
emaAngleThreshold = input.float(1.0, title="EMA ê°ë„ ì„ê³„ê°’", minval=0.1, maxval=5.0, step=0.1, group="SMC ì„¤ì •")

// ê³ ë˜ ê°ì§€ ì„¤ì •
showWhale = input.bool(true, title="ê³ ë˜ ë§¤ìˆ˜/ë§¤ë„ í‘œì‹œ", group="SMC ì„¤ì •")
whaleVolMultiplier = input.float(3.0, title="ê³ ë˜ ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=2.0, maxval=10.0, step=0.5, group="SMC ì„¤ì •")
whalePriceMove = input.float(0.5, title="ê³ ë˜ ê°€ê²© ë³€ë™ (%)", minval=0.1, maxval=2.0, step=0.1, group="SMC ì„¤ì •")

// ============================================
// ì‹¬ë¦¬ì  ë§¤ë§¤ êµ¬ê°„ ì„¤ì •
// ============================================
showPsychLevels = input.bool(true, title="ì‹¬ë¦¬ì  êµ¬ê°„ í‘œì‹œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showRoundNumbers = input.bool(true, title="ë¼ìš´ë“œ ë„˜ë²„ í‘œì‹œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showFearGreed = input.bool(true, title="ê³µí¬/íƒìš• ì§€í‘œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showVolProfile = input.bool(true, title="ë³¼ë¥¨ ì§‘ì¤‘ êµ¬ê°„", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showFibLevels = input.bool(false, title="í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showKeyLevels = input.bool(true, title="ì£¼ìš” ê³ ì /ì €ì  í‘œì‹œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showPOC = input.bool(true, title="POC (ê±°ë˜ëŸ‰ ì§‘ì¤‘) í‘œì‹œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
roundNumInterval = input.int(5000, title="ë¼ìš´ë“œ ë„˜ë²„ ê°„ê²© ($)", minval=100, maxval=50000, step=100, group="ì‹¬ë¦¬ì  êµ¬ê°„")
fibLookback = input.int(100, title="í”¼ë³´ë‚˜ì¹˜ íƒìƒ‰ ë²”ìœ„", minval=20, maxval=500, group="ì‹¬ë¦¬ì  êµ¬ê°„")
keyLevelLookback = input.int(50, title="ì£¼ìš” ë ˆë²¨ íƒìƒ‰ ë²”ìœ„", minval=20, maxval=200, group="ì‹¬ë¦¬ì  êµ¬ê°„")
pocLookback = input.int(50, title="POC íƒìƒ‰ ë²”ìœ„", minval=20, maxval=200, group="ì‹¬ë¦¬ì  êµ¬ê°„")

// ============================================
// í˜„ì¬ TF ê¸°ë³¸ ì§€í‘œ
// ============================================

ema9 = ta.ema(close, 9)
ema21 = ta.ema(close, 21)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)

bool emaAlignedUp = ema9 > ema21 and ema21 > ema50
bool emaAlignedDown = ema9 < ema21 and ema21 < ema50
bool aboveEMA200 = close > ema200
bool belowEMA200 = close < ema200

// ============================================
// EMA ê°ë„ ë¶„ì„ (ì¶”ì„¸ ê°•ë„)
// ============================================
emaAngle14 = ta.ema(close, emaAngleLength)
emaAnglePrev = emaAngle14[1]
priceRange = ta.highest(high, 50) - ta.lowest(low, 50)
emaChange = (emaAngle14 - emaAnglePrev) / priceRange * 100
emaAngleValue = ta.sma(emaChange, 3)

// EMA ìƒ‰ìƒ: ì´ˆë¡(ê°•í•œìƒìŠ¹) > ë…¸ë‘(ì•½í•œìƒìŠ¹) > ì£¼í™©(íš¡ë³´) > ë¹¨ê°•(í•˜ë½)
color emaAngleColor = emaAngleValue > emaAngleThreshold ? color.lime :
                      emaAngleValue > 0 ? color.yellow :
                      emaAngleValue > -emaAngleThreshold ? color.orange :
                      color.red

bool emaStrongUp = emaAngleValue > emaAngleThreshold
bool emaWeakUp = emaAngleValue > 0 and emaAngleValue <= emaAngleThreshold
bool emaSideways = emaAngleValue <= 0 and emaAngleValue >= -emaAngleThreshold
bool emaStrongDown = emaAngleValue < -emaAngleThreshold

// ë³¼ë¦°ì €ë°´ë“œ
bbLength = 20
bbMult = 2.0
bbBasis = ta.sma(close, bbLength)
bbDev = ta.stdev(close, bbLength) * bbMult
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev
bool touchBBLower = low <= bbLower
bool touchBBUpper = high >= bbUpper

rsi = ta.rsi(close, 14)
stochRsi = ta.stoch(rsi, rsi, rsi, 14)
stochK = ta.sma(stochRsi, 3)
stochD = ta.sma(stochK, 3)
bool rsiOversold = rsi < 30
bool rsiOverbought = rsi > 70
bool stochOversold = stochK < 20
bool stochOverbought = stochK > 80
bool stochBullish = stochK > stochD

[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
bool macdBullish = macdLine > signalLine
bool macdBearish = macdLine < signalLine

[diPlus, diMinus, adxValue] = ta.dmi(14, 14)
bool trendStrong = adxValue >= 20
bool bullishDI = diPlus > diMinus

avgVol = ta.sma(volume, 20)
volRatio = volume / avgVol
volSpike = volRatio >= volThreshold
bool volumeExplosion = volRatio >= volHighThreshold

bullVol = close > open ? volume : volume * (close - low) / math.max(high - low, 0.0001)
bearVol = close < open ? volume : volume * (high - close) / math.max(high - low, 0.0001)
buyPressure = bullVol / (bullVol + bearVol) * 100
bool strongBuyPressure = buyPressure > 55
bool strongSellPressure = buyPressure < 45

// ============================================
// ê³ ë˜ ë§¤ìˆ˜/ë§¤ë„ ê°ì§€
// ============================================
float priceChangePercent = math.abs(close - open) / open * 100
bool isWhaleVolume = volRatio >= whaleVolMultiplier
bool isWhalePriceMove = priceChangePercent >= whalePriceMove
bool isBullishCandle = close > open
bool isBearishCandle = close < open

// ê³ ë˜ ë§¤ìˆ˜: ëŒ€ëŸ‰ ê±°ë˜ëŸ‰ + í° ì–‘ë´‰ + ë§¤ìˆ˜ì••ë ¥
bool whaleBuy = isWhaleVolume and isWhalePriceMove and isBullishCandle and buyPressure > 55

// ê³ ë˜ ë§¤ë„: ëŒ€ëŸ‰ ê±°ë˜ëŸ‰ + í° ìŒë´‰ + ë§¤ë„ì••ë ¥
bool whaleSell = isWhaleVolume and isWhalePriceMove and isBearishCandle and buyPressure < 45

// ê±°ë˜ëŸ‰ ë“±ê¸‰ë³„ ë¶„ë¥˜ (í•´ì–‘ìƒë¬¼ ë“±ê¸‰)
string whaleStrength = volRatio >= 10.0 ? "ğŸ‹WHALE" :
                       volRatio >= 7.0 ? "ğŸ¦ˆSHARK" :
                       volRatio >= 5.0 ? "ğŸ¬DOLPHIN" :
                       volRatio >= 3.0 ? "ğŸŸFISH" :
                       volRatio >= 2.0 ? "ğŸ¦€CRAB" : "ğŸ¦SHRIMP"

// ë“±ê¸‰ë³„ í•œê¸€ëª…
string whaleKorean = volRatio >= 10.0 ? "ê³ ë˜" :
                     volRatio >= 7.0 ? "ìƒì–´" :
                     volRatio >= 5.0 ? "ëŒê³ ë˜" :
                     volRatio >= 3.0 ? "ë¬¼ê³ ê¸°" :
                     volRatio >= 2.0 ? "ê²Œ" : "ìƒˆìš°"

// í”¼ë´‡/ë‹¤ì´ë²„ì „ìŠ¤
float pivotHigh = ta.pivothigh(high, pivotLeft, pivotRight)
float pivotLow = ta.pivotlow(low, pivotLeft, pivotRight)
float rsiPivotLow = ta.pivotlow(rsi, pivotLeft, pivotRight)
float rsiPivotHigh = ta.pivothigh(rsi, pivotLeft, pivotRight)
float pricePivotLow = ta.pivotlow(low, pivotLeft, pivotRight)
float pricePivotHigh = ta.pivothigh(high, pivotLeft, pivotRight)

var float prevRsiLow = na
var float prevPriceLow = na
var float prevRsiHigh = na
var float prevPriceHigh = na

bool bullishDivergence = false
if not na(rsiPivotLow) and not na(pricePivotLow)
    if not na(prevRsiLow) and not na(prevPriceLow)
        if pricePivotLow < prevPriceLow and rsiPivotLow > prevRsiLow
            bullishDivergence := true
    prevRsiLow := rsiPivotLow
    prevPriceLow := pricePivotLow

bool bearishDivergence = false
if not na(rsiPivotHigh) and not na(pricePivotHigh)
    if not na(prevRsiHigh) and not na(prevPriceHigh)
        if pricePivotHigh > prevPriceHigh and rsiPivotHigh < prevRsiHigh
            bearishDivergence := true
    prevRsiHigh := rsiPivotHigh
    prevPriceHigh := pricePivotHigh

// ============================================
// SMC (Smart Money Concepts) ê³„ì‚°
// ============================================

// --- Swing High/Low ê°ì§€ ---
float swingHigh = ta.pivothigh(high, swingLength, swingLength)
float swingLow = ta.pivotlow(low, swingLength, swingLength)

// ìµœê·¼ ìŠ¤ìœ™ í¬ì¸íŠ¸ ì €ì¥
var float lastSwingHigh = na
var float lastSwingLow = na
var int lastSwingHighBar = na
var int lastSwingLowBar = na
var float prevSwingHigh = na
var float prevSwingLow = na
var int prevSwingHighBar = na
var int prevSwingLowBar = na

// ì‹œì¥ êµ¬ì¡° ë¼ë²¨ìš© ë³€ìˆ˜
var string lastStructureType = "none"

if not na(swingHigh)
    prevSwingHigh := lastSwingHigh
    prevSwingHighBar := lastSwingHighBar
    lastSwingHigh := swingHigh
    lastSwingHighBar := bar_index - swingLength

if not na(swingLow)
    prevSwingLow := lastSwingLow
    prevSwingLowBar := lastSwingLowBar
    lastSwingLow := swingLow
    lastSwingLowBar := bar_index - swingLength

// --- ì‹œì¥ êµ¬ì¡° ë¶„ì„ (HH, HL, LH, LL) ---
bool isHigherHigh = not na(swingHigh) and not na(prevSwingHigh) and swingHigh > prevSwingHigh
bool isLowerHigh = not na(swingHigh) and not na(prevSwingHigh) and swingHigh < prevSwingHigh
bool isHigherLow = not na(swingLow) and not na(prevSwingLow) and swingLow > prevSwingLow
bool isLowerLow = not na(swingLow) and not na(prevSwingLow) and swingLow < prevSwingLow

// êµ¬ì¡° ë¼ë²¨ í‘œì‹œ
if showSMC and showStructureLabels
    if isHigherHigh
        label.new(bar_index - swingLength, swingHigh, "HH",
                 style=label.style_label_down, color=color.new(color.green, 40),
                 textcolor=color.white, size=size.tiny)
        lastStructureType := "HH"

    if isLowerHigh
        label.new(bar_index - swingLength, swingHigh, "LH",
                 style=label.style_label_down, color=color.new(color.red, 40),
                 textcolor=color.white, size=size.tiny)
        lastStructureType := "LH"

    if isHigherLow
        label.new(bar_index - swingLength, swingLow, "HL",
                 style=label.style_label_up, color=color.new(color.green, 40),
                 textcolor=color.white, size=size.tiny)
        lastStructureType := "HL"

    if isLowerLow
        label.new(bar_index - swingLength, swingLow, "LL",
                 style=label.style_label_up, color=color.new(color.red, 40),
                 textcolor=color.white, size=size.tiny)
        lastStructureType := "LL"

// --- BOS (Break of Structure) / CHoCH (Change of Character) ---
var bool isBullishStructure = true
var float bosLevel = na
var float chochLevel = na
var float lastBosHigh = na
var float lastBosLow = na
bool bosUp = false
bool bosDn = false
bool chochUp = false
bool chochDn = false

// BOS: ì¶”ì„¸ ë°©í–¥ìœ¼ë¡œì˜ êµ¬ì¡° ëŒíŒŒ (ì²˜ìŒ ëŒíŒŒ ì‹œì—ë§Œ)
// CHoCH: ì¶”ì„¸ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œì˜ êµ¬ì¡° ëŒíŒŒ (ì¶”ì„¸ ì „í™˜)
if isBullishStructure
    // CHoCH: ìƒìŠ¹ êµ¬ì¡°ì—ì„œ ì €ì  ì´íƒˆ = í•˜ë½ ì „í™˜
    if not na(lastSwingLow) and close < lastSwingLow and close[1] >= lastSwingLow
        chochDn := true
        chochLevel := lastSwingLow
        isBullishStructure := false
        lastBosLow := lastSwingLow
    // BOS: ìƒìŠ¹ êµ¬ì¡°ì—ì„œ ê³ ì  ëŒíŒŒ (ì²˜ìŒ ëŒíŒŒí•  ë•Œë§Œ)
    if not na(lastSwingHigh) and close > lastSwingHigh and close[1] <= lastSwingHigh and (na(lastBosHigh) or lastSwingHigh != lastBosHigh)
        bosUp := true
        bosLevel := lastSwingHigh
        lastBosHigh := lastSwingHigh
else
    // CHoCH: í•˜ë½ êµ¬ì¡°ì—ì„œ ê³ ì  ëŒíŒŒ = ìƒìŠ¹ ì „í™˜
    if not na(lastSwingHigh) and close > lastSwingHigh and close[1] <= lastSwingHigh
        chochUp := true
        chochLevel := lastSwingHigh
        isBullishStructure := true
        lastBosHigh := lastSwingHigh
    // BOS: í•˜ë½ êµ¬ì¡°ì—ì„œ ì €ì  ì´íƒˆ (ì²˜ìŒ ì´íƒˆí•  ë•Œë§Œ)
    if not na(lastSwingLow) and close < lastSwingLow and close[1] >= lastSwingLow and (na(lastBosLow) or lastSwingLow != lastBosLow)
        bosDn := true
        bosLevel := lastSwingLow
        lastBosLow := lastSwingLow

// --- BOS ë°•ìŠ¤ ìƒì„± ---
var box[] bosBoxes = array.new_box(0)

// Bullish BOS ë°•ìŠ¤ (ì²­ë¡ìƒ‰) - EMA ìƒìŠ¹ ì¤‘ + ê³ ì  ëŒíŒŒ
if showSMC and showBOSBox and bosUp and emaAngleValue > 0
    if array.size(bosBoxes) >= 10
        box.delete(array.shift(bosBoxes))
    // ì´ì „ ì €ì  ~ í˜„ì¬ ê³ ì  ë°•ìŠ¤
    float boxTop = lastSwingHigh
    float boxBot = not na(prevSwingLow) ? prevSwingLow : lastSwingLow
    array.push(bosBoxes, box.new(lastSwingHighBar, boxTop, bar_index + 15, boxBot,
               bgcolor=color.new(color.teal, 85), border_color=color.teal, border_width=2,
               text="BOS+", text_color=color.teal, text_size=size.small))

// Bearish BOS ë°•ìŠ¤ (ë¶„í™ìƒ‰) - EMA í•˜ë½ ì¤‘ + ì €ì  ì´íƒˆ
if showSMC and showBOSBox and bosDn and emaAngleValue < 0
    if array.size(bosBoxes) >= 10
        box.delete(array.shift(bosBoxes))
    // ì´ì „ ê³ ì  ~ í˜„ì¬ ì €ì  ë°•ìŠ¤
    float boxTop = not na(prevSwingHigh) ? prevSwingHigh : lastSwingHigh
    float boxBot = lastSwingLow
    array.push(bosBoxes, box.new(lastSwingLowBar, boxTop, bar_index + 15, boxBot,
               bgcolor=color.new(color.fuchsia, 85), border_color=color.fuchsia, border_width=2,
               text="BOS-", text_color=color.fuchsia, text_size=size.small))

// --- Order Blocks ê°ì§€ ---
var box[] bullishOBs = array.new_box(0)
var box[] bearishOBs = array.new_box(0)

// Bullish Order Block: í•˜ë½ í›„ ê°•í•œ ìƒìŠ¹ ì „ ë§ˆì§€ë§‰ í•˜ë½ ìº”ë“¤
bool isBullishOB = close[1] < open[1] and close > open and close > high[1] and volRatio >= 1.2
float bullOBTop = isBullishOB ? high[1] : na
float bullOBBot = isBullishOB ? low[1] : na

// Bearish Order Block: ìƒìŠ¹ í›„ ê°•í•œ í•˜ë½ ì „ ë§ˆì§€ë§‰ ìƒìŠ¹ ìº”ë“¤
bool isBearishOB = close[1] > open[1] and close < open and close < low[1] and volRatio >= 1.2
float bearOBTop = isBearishOB ? high[1] : na
float bearOBBot = isBearishOB ? low[1] : na

// Order Block ë°•ìŠ¤ ìƒì„±
if showSMC and showOrderBlocks and isBullishOB
    if array.size(bullishOBs) >= 5
        box.delete(array.shift(bullishOBs))
    array.push(bullishOBs, box.new(bar_index - 1, bullOBTop, bar_index + 20, bullOBBot, bgcolor=color.new(color.green, 85), border_color=color.green, border_width=1))

if showSMC and showOrderBlocks and isBearishOB
    if array.size(bearishOBs) >= 5
        box.delete(array.shift(bearishOBs))
    array.push(bearishOBs, box.new(bar_index - 1, bearOBTop, bar_index + 20, bearOBBot, bgcolor=color.new(color.red, 85), border_color=color.red, border_width=1))

// --- Fair Value Gap (FVG) ê°ì§€ ---
var box[] bullishFVGs = array.new_box(0)
var box[] bearishFVGs = array.new_box(0)

// Bullish FVG: í˜„ì¬ë´‰ ì €ê°€ > 2ë´‰ì „ ê³ ê°€ (ê°­ ìƒìŠ¹)
float fvgThreshold = close * fvgMinSize / 100
bool isBullishFVG = low > high[2] and (low - high[2]) >= fvgThreshold
float bullFVGTop = isBullishFVG ? low : na
float bullFVGBot = isBullishFVG ? high[2] : na

// Bearish FVG: í˜„ì¬ë´‰ ê³ ê°€ < 2ë´‰ì „ ì €ê°€ (ê°­ í•˜ë½)
bool isBearishFVG = high < low[2] and (low[2] - high) >= fvgThreshold
float bearFVGTop = isBearishFVG ? low[2] : na
float bearFVGBot = isBearishFVG ? high : na

// FVG ë°•ìŠ¤ ìƒì„±
if showSMC and showFVG and isBullishFVG
    if array.size(bullishFVGs) >= 5
        box.delete(array.shift(bullishFVGs))
    array.push(bullishFVGs, box.new(bar_index - 2, bullFVGTop, bar_index + 15, bullFVGBot, bgcolor=color.new(color.teal, 80), border_color=color.teal, border_width=1, border_style=line.style_dashed))

if showSMC and showFVG and isBearishFVG
    if array.size(bearishFVGs) >= 5
        box.delete(array.shift(bearishFVGs))
    array.push(bearishFVGs, box.new(bar_index - 2, bearFVGTop, bar_index + 15, bearFVGBot, bgcolor=color.new(color.maroon, 80), border_color=color.maroon, border_width=1, border_style=line.style_dashed))

// --- Smart Trail (íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘) ---
atrPeriod = 14
atrMult = 2.0
atrValue = ta.atr(atrPeriod)

var float smartTrail = na
var bool smartTrailUp = true

if smartTrailUp
    smartTrail := math.max(nz(smartTrail), close - atrValue * atrMult)
    if close < smartTrail
        smartTrailUp := false
        smartTrail := close + atrValue * atrMult
else
    smartTrail := math.min(nz(smartTrail), close + atrValue * atrMult)
    if close > smartTrail
        smartTrailUp := true
        smartTrail := close - atrValue * atrMult

// --- Liquidity Levels (Equal Highs/Lows) ---
var float[] eqHighs = array.new_float(0)
var float[] eqLows = array.new_float(0)
var int[] eqHighBars = array.new_int(0)
var int[] eqLowBars = array.new_int(0)

// Equal Highs ê°ì§€ (ë¹„ìŠ·í•œ ê³ ì  = ìœ ë™ì„± íƒ€ê²Ÿ)
eqHighThreshold = atrValue * 0.3
if not na(swingHigh) and not na(prevSwingHigh)
    if math.abs(swingHigh - prevSwingHigh) < eqHighThreshold
        if array.size(eqHighs) >= 3
            array.shift(eqHighs)
            array.shift(eqHighBars)
        array.push(eqHighs, (swingHigh + prevSwingHigh) / 2)
        array.push(eqHighBars, bar_index - swingLength)

// Equal Lows ê°ì§€ (ë¹„ìŠ·í•œ ì €ì  = ìœ ë™ì„± íƒ€ê²Ÿ)
if not na(swingLow) and not na(prevSwingLow)
    if math.abs(swingLow - prevSwingLow) < eqHighThreshold
        if array.size(eqLows) >= 3
            array.shift(eqLows)
            array.shift(eqLowBars)
        array.push(eqLows, (swingLow + prevSwingLow) / 2)
        array.push(eqLowBars, bar_index - swingLength)

// --- Premium/Discount Zone ---
float rangeHigh = ta.highest(high, 50)
float rangeLow = ta.lowest(low, 50)
float rangeMid = (rangeHigh + rangeLow) / 2
float premiumZone = rangeMid + (rangeHigh - rangeMid) * 0.5
float discountZone = rangeMid - (rangeMid - rangeLow) * 0.5
bool inPremium = close > premiumZone
bool inDiscount = close < discountZone

// SMC ì‹œê·¸ë„ ì¡°í•©
bool smcBullish = (isBullishOB or isBullishFVG or chochUp) and inDiscount and smartTrailUp
bool smcBearish = (isBearishOB or isBearishFVG or chochDn) and inPremium and not smartTrailUp

// ============================================
// 15ë¶„ë´‰ ë¶„ì„ (5ë¶„ë´‰ ì œê±° - security ì œí•œ 40ê°œ)
// ============================================

tf15m_ema9 = request.security(syminfo.tickerid, "15", ta.ema(close, 9), lookahead=barmerge.lookahead_off)
tf15m_ema21 = request.security(syminfo.tickerid, "15", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf15m_close = request.security(syminfo.tickerid, "15", close, lookahead=barmerge.lookahead_off)
tf15m_rsi = request.security(syminfo.tickerid, "15", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)
tf15m_vol = request.security(syminfo.tickerid, "15", volume, lookahead=barmerge.lookahead_off)
tf15m_avgVol = request.security(syminfo.tickerid, "15", ta.sma(volume, 20), lookahead=barmerge.lookahead_off)

float tf15m_volRatio = tf15m_vol / math.max(tf15m_avgVol, 1)
bool tf15m_uptrend = tf15m_ema9 > tf15m_ema21 and tf15m_close > tf15m_ema21
bool tf15m_downtrend = tf15m_ema9 < tf15m_ema21 and tf15m_close < tf15m_ema21
bool tf15m_volSpike = tf15m_volRatio >= volThreshold
bool tf15m_oversold = tf15m_rsi < 35
// ì¶”ì„¸ ê°•ë„
tf15m_ema50 = request.security(syminfo.tickerid, "15", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
bool tf15m_emaAligned = tf15m_ema9 > tf15m_ema21 and tf15m_ema21 > tf15m_ema50
bool tf15m_emaAlignedDn = tf15m_ema9 < tf15m_ema21 and tf15m_ema21 < tf15m_ema50
tf15m_macd = request.security(syminfo.tickerid, "15", ta.ema(close, 12) - ta.ema(close, 26), lookahead=barmerge.lookahead_off)
tf15m_macdSig = request.security(syminfo.tickerid, "15", ta.ema(ta.ema(close, 12) - ta.ema(close, 26), 9), lookahead=barmerge.lookahead_off)
bool tf15m_macdBull = tf15m_macd > tf15m_macdSig

// ============================================
// 1ì‹œê°„ë´‰ ë¶„ì„
// ============================================

tf1h_ema9 = request.security(syminfo.tickerid, "60", ta.ema(close, 9), lookahead=barmerge.lookahead_off)
tf1h_ema21 = request.security(syminfo.tickerid, "60", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf1h_ema50 = request.security(syminfo.tickerid, "60", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
tf1h_close = request.security(syminfo.tickerid, "60", close, lookahead=barmerge.lookahead_off)
tf1h_rsi = request.security(syminfo.tickerid, "60", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)
tf1h_vol = request.security(syminfo.tickerid, "60", volume, lookahead=barmerge.lookahead_off)
tf1h_avgVol = request.security(syminfo.tickerid, "60", ta.sma(volume, 20), lookahead=barmerge.lookahead_off)
tf1h_high3d = request.security(syminfo.tickerid, "60", ta.highest(high, 72), lookahead=barmerge.lookahead_off)
tf1h_low3d = request.security(syminfo.tickerid, "60", ta.lowest(low, 72), lookahead=barmerge.lookahead_off)

float tf1h_volRatio = tf1h_vol / math.max(tf1h_avgVol, 1)
bool tf1h_uptrend = tf1h_ema9 > tf1h_ema21 and tf1h_close > tf1h_ema21
bool tf1h_downtrend = tf1h_ema9 < tf1h_ema21 and tf1h_close < tf1h_ema21
bool tf1h_volSpike = tf1h_volRatio >= volThreshold
bool tf1h_oversold = tf1h_rsi < 35
// ì¶”ì„¸ ê°•ë„
bool tf1h_emaAligned = tf1h_ema9 > tf1h_ema21 and tf1h_ema21 > tf1h_ema50
bool tf1h_emaAlignedDn = tf1h_ema9 < tf1h_ema21 and tf1h_ema21 < tf1h_ema50
tf1h_macd = request.security(syminfo.tickerid, "60", ta.ema(close, 12) - ta.ema(close, 26), lookahead=barmerge.lookahead_off)
tf1h_macdSig = request.security(syminfo.tickerid, "60", ta.ema(ta.ema(close, 12) - ta.ema(close, 26), 9), lookahead=barmerge.lookahead_off)
bool tf1h_macdBull = tf1h_macd > tf1h_macdSig

// ============================================
// 4ì‹œê°„ë´‰ ë¶„ì„
// ============================================

tf4h_ema9 = request.security(syminfo.tickerid, "240", ta.ema(close, 9), lookahead=barmerge.lookahead_off)
tf4h_ema21 = request.security(syminfo.tickerid, "240", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf4h_close = request.security(syminfo.tickerid, "240", close, lookahead=barmerge.lookahead_off)
tf4h_rsi = request.security(syminfo.tickerid, "240", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)
tf4h_vol = request.security(syminfo.tickerid, "240", volume, lookahead=barmerge.lookahead_off)
tf4h_avgVol = request.security(syminfo.tickerid, "240", ta.sma(volume, 20), lookahead=barmerge.lookahead_off)
tf4h_high3d = request.security(syminfo.tickerid, "240", ta.highest(high, 18), lookahead=barmerge.lookahead_off)
tf4h_low3d = request.security(syminfo.tickerid, "240", ta.lowest(low, 18), lookahead=barmerge.lookahead_off)

float tf4h_volRatio = tf4h_vol / math.max(tf4h_avgVol, 1)
bool tf4h_uptrend = tf4h_ema9 > tf4h_ema21 and tf4h_close > tf4h_ema21
bool tf4h_downtrend = tf4h_ema9 < tf4h_ema21 and tf4h_close < tf4h_ema21
bool tf4h_volSpike = tf4h_volRatio >= volThreshold
bool tf4h_oversold = tf4h_rsi < 35
// ì¶”ì„¸ ê°•ë„
tf4h_ema50 = request.security(syminfo.tickerid, "240", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
bool tf4h_emaAligned = tf4h_ema9 > tf4h_ema21 and tf4h_ema21 > tf4h_ema50
bool tf4h_emaAlignedDn = tf4h_ema9 < tf4h_ema21 and tf4h_ema21 < tf4h_ema50
tf4h_macd = request.security(syminfo.tickerid, "240", ta.ema(close, 12) - ta.ema(close, 26), lookahead=barmerge.lookahead_off)
tf4h_macdSig = request.security(syminfo.tickerid, "240", ta.ema(ta.ema(close, 12) - ta.ema(close, 26), 9), lookahead=barmerge.lookahead_off)
bool tf4h_macdBull = tf4h_macd > tf4h_macdSig

// ============================================
// ì¼ë´‰ ë¶„ì„
// ============================================

tfD_ema9 = request.security(syminfo.tickerid, "D", ta.ema(close, 9), lookahead=barmerge.lookahead_off)
tfD_ema21 = request.security(syminfo.tickerid, "D", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tfD_close = request.security(syminfo.tickerid, "D", close, lookahead=barmerge.lookahead_off)
tfD_rsi = request.security(syminfo.tickerid, "D", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)
tfD_high3d = request.security(syminfo.tickerid, "D", ta.highest(high, 3), lookahead=barmerge.lookahead_off)
tfD_low3d = request.security(syminfo.tickerid, "D", ta.lowest(low, 3), lookahead=barmerge.lookahead_off)

bool tfD_uptrend = tfD_ema9 > tfD_ema21 and tfD_close > tfD_ema21
bool tfD_downtrend = tfD_ema9 < tfD_ema21 and tfD_close < tfD_ema21
bool tfD_oversold = tfD_rsi < 35
// ì¶”ì„¸ ê°•ë„
tfD_ema50 = request.security(syminfo.tickerid, "D", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
bool tfD_emaAligned = tfD_ema9 > tfD_ema21 and tfD_ema21 > tfD_ema50
bool tfD_emaAlignedDn = tfD_ema9 < tfD_ema21 and tfD_ema21 < tfD_ema50
tfD_macd = request.security(syminfo.tickerid, "D", ta.ema(close, 12) - ta.ema(close, 26), lookahead=barmerge.lookahead_off)
tfD_macdSig = request.security(syminfo.tickerid, "D", ta.ema(ta.ema(close, 12) - ta.ema(close, 26), 9), lookahead=barmerge.lookahead_off)
bool tfD_macdBull = tfD_macd > tfD_macdSig

// ============================================
// 3ì¼ì¹˜ ì§€ì§€/ì €í•­ (ëª¨ë“  TF í†µí•©)
// ============================================

// 1ì‹œê°„/4ì‹œê°„/ì¼ë´‰ ê¸°ì¤€ 3ì¼ ê³ ì €
float resistance3d = math.max(tf1h_high3d, tf4h_high3d, tfD_high3d)
float support3d = math.min(tf1h_low3d, tf4h_low3d, tfD_low3d)

// í˜„ì¬ ê°€ê²© ìœ„ì¹˜ (%)
float pricePosition = (close - support3d) / math.max(resistance3d - support3d, 0.0001) * 100

// ì§€ì§€/ì €í•­ ê·¼ì ‘ ì—¬ë¶€
bool nearSupport3d = pricePosition < 15
bool nearResistance3d = pricePosition > 85
bool atSupport3d = pricePosition < 5
bool atResistance3d = pricePosition > 95

// ============================================
// íƒ€ì„í”„ë ˆì„ ì¼ì¹˜ ì¹´ìš´íŠ¸ (15m/1H/4H/D = 4ê°œ)
// ============================================

// ìƒìŠ¹ ì¶”ì„¸ ì¼ì¹˜ ê°œìˆ˜
int uptrendCount = (tf15m_uptrend ? 1 : 0) + (tf1h_uptrend ? 1 : 0) + (tf4h_uptrend ? 1 : 0) + (tfD_uptrend ? 1 : 0)

// í•˜ë½ ì¶”ì„¸ ì¼ì¹˜ ê°œìˆ˜
int downtrendCount = (tf15m_downtrend ? 1 : 0) + (tf1h_downtrend ? 1 : 0) + (tf4h_downtrend ? 1 : 0) + (tfD_downtrend ? 1 : 0)

// ê±°ë˜ëŸ‰ ê¸‰ì¦ TF ê°œìˆ˜ (í˜„ì¬TF + 15m/1H/4H = 4ê°œ)
int volSpikeCount = (volSpike ? 1 : 0) + (tf15m_volSpike ? 1 : 0) + (tf1h_volSpike ? 1 : 0) + (tf4h_volSpike ? 1 : 0)

// ê³¼ë§¤ë„ TF ê°œìˆ˜
int oversoldCount = (rsi < 35 ? 1 : 0) + (tf15m_oversold ? 1 : 0) + (tf1h_oversold ? 1 : 0) + (tf4h_oversold ? 1 : 0)

// EMA ì •ë ¬ TF ê°œìˆ˜ (ê°•í•œ ì¶”ì„¸) - í˜„ì¬TF + 15m/1H/4H/D = 5ê°œ
int emaAlignedUpCount = (emaAlignedUp ? 1 : 0) + (tf15m_emaAligned ? 1 : 0) + (tf1h_emaAligned ? 1 : 0) + (tf4h_emaAligned ? 1 : 0) + (tfD_emaAligned ? 1 : 0)
int emaAlignedDnCount = (emaAlignedDown ? 1 : 0) + (tf15m_emaAlignedDn ? 1 : 0) + (tf1h_emaAlignedDn ? 1 : 0) + (tf4h_emaAlignedDn ? 1 : 0) + (tfD_emaAlignedDn ? 1 : 0)

// MACD ìƒìŠ¹ TF ê°œìˆ˜ - í˜„ì¬TF + 15m/1H/4H/D = 5ê°œ
int macdBullCount = (macdBullish ? 1 : 0) + (tf15m_macdBull ? 1 : 0) + (tf1h_macdBull ? 1 : 0) + (tf4h_macdBull ? 1 : 0) + (tfD_macdBull ? 1 : 0)

// ì „ì²´ ì¶”ì„¸ ì ìˆ˜ (0~14: 4+5+5)
int trendScore = uptrendCount + emaAlignedUpCount + macdBullCount
string trendStrength = trendScore >= 12 ? "VERY STRONG" : trendScore >= 10 ? "STRONG" : trendScore >= 7 ? "MODERATE" : trendScore >= 5 ? "WEAK" : "BEAR"

// ============================================
// 30ì  ì ìˆ˜ ì‹œìŠ¤í…œ (V37 ë°©ì‹)
// ============================================

// LONG ì ìˆ˜
float longScore = 0

// ì¶”ì„¸ (8ì )
longScore += emaAlignedUp ? 3 : (ema9 > ema21 ? 1 : 0)
longScore += aboveEMA200 ? 2 : 0
longScore += tf1h_uptrend ? 2 : 0
longScore += tf4h_uptrend ? 1 : 0

// ëª¨ë©˜í…€ (8ì )
longScore += stochOversold ? 3 : (stochK < 40 and stochBullish ? 2 : stochBullish ? 1 : 0)
longScore += macdBullish ? 2 : 0
longScore += rsiOversold ? 2 : (rsi < 45 ? 1 : 0)
longScore += (bullishDI and trendStrong) ? 1 : 0

// ê±°ë˜ëŸ‰ (6ì )
longScore += volumeExplosion and strongBuyPressure ? 3 : (volSpike and strongBuyPressure ? 2 : volSpike ? 1 : 0)
int multiTFVolCount = (tf15m_volSpike ? 1 : 0) + (tf1h_volSpike ? 1 : 0) + (tf4h_volSpike ? 1 : 0)
bool multiTFVolume = multiTFVolCount >= 2
longScore += multiTFVolume and strongBuyPressure ? 3 : (multiTFVolume ? 2 : 0)

// êµ¬ì¡° (8ì )
longScore += atSupport3d ? 3 : (nearSupport3d ? 2 : 0)
longScore += pricePosition < 20 ? 2 : 0
longScore += touchBBLower ? 2 : 0
longScore += bullishDivergence ? 1 : 0

// ============================================
// ê³ í™•ì‹  ì¡°ê±´ (V37 ë°©ì‹)
// ============================================

// [í™•ì‹ ë„ 1] HTF ì¶”ì„¸ ì¼ì¹˜ + ì§€ì§€ì„  + ê±°ë˜ëŸ‰ = ìµœê³  ìŠ¹ë¥ 
bool highConf1 = tf1h_uptrend and tf4h_uptrend and (atSupport3d or pricePosition < 10) and volSpike and strongBuyPressure

// [í™•ì‹ ë„ 2] ë‹¤ì´ë²„ì „ìŠ¤ + ê³¼ë§¤ë„ + ê±°ë˜ëŸ‰ = ë°˜ì „ í™•ë¥ 
bool highConf2 = bullishDivergence and (rsiOversold or stochOversold) and volSpike

// [í™•ì‹ ë„ 3] BB í•˜ë‹¨ + ê³¼ë§¤ë„ + HTF ìƒìŠ¹ = ë°”ìš´ìŠ¤
bool highConf3 = touchBBLower and stochOversold and tf1h_uptrend and volSpike

// [í™•ì‹ ë„ 4] EMA ì •ë ¬ + ADX ê°•í•¨ + MTF ê±°ë˜ëŸ‰ = ì¶”ì„¸ ì§€ì†
bool highConf4 = emaAlignedUp and aboveEMA200 and trendStrong and multiTFVolume

// ë†’ì€ í™•ì‹ ë„ LONG
bool highConfidenceLong = highConf1 or highConf2 or highConf3 or highConf4

// í™•ì‹ ë„ ì´ìœ 
string confReason = highConf1 ? "HTF+SR+VOL" : highConf2 ? "DIV+OVERSOLD" : highConf3 ? "BB+OVERSOLD" : highConf4 ? "TREND+VOL" : "-"

// ============================================
// ì‹ í˜¸ ë“±ê¸‰ ì‹œìŠ¤í…œ (30% ê°•í™”)
// ============================================

// Së“±ê¸‰: 3TF ìƒìŠ¹ + ì§€ì§€ê·¼ì²˜ + ê±°ë˜ëŸ‰ + ê³ í™•ì‹  + ë§¤ìˆ˜ì••ë ¥
bool gradeS = uptrendCount >= 3 and nearSupport3d and volSpikeCount >= 1 and highConfidenceLong and buyPressure > 52

// Aë“±ê¸‰: 2TF ìƒìŠ¹ + ê±°ë˜ëŸ‰ + ë§¤ìˆ˜ì••ë ¥
bool gradeA = uptrendCount >= 2 and volSpikeCount >= 1 and buyPressure > 48

// Bë“±ê¸‰: 2TF ìƒìŠ¹ + 1H ìƒìŠ¹
bool gradeB = uptrendCount >= 2 and tf1h_uptrend

// í˜„ì¬ ë“±ê¸‰ (ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œë„ í‘œì‹œ)
string currentGrade = gradeS ? "S" : longScore >= 22 ? "A+" : gradeA ? "A" : longScore >= 16 ? "B+" : gradeB ? "B" : "C"

// ============================================
// LONG ì‹œê·¸ë„ ì¡°ê±´
// ============================================

// ê°•ë ¥ LONG: Së“±ê¸‰ ë˜ëŠ” Aë“±ê¸‰
bool strongLong = gradeS or gradeA

// ì¼ë°˜ LONG: Bë“±ê¸‰ ì´ìƒ
bool normalLong = gradeB and not strongLong

// SUPER LONG: ëª¨ë“  ì¡°ê±´ ì¼ì¹˜ (ê¸°ì¡´ STRONG + SMC + Smart Trail)
bool superLong = strongLong and smcBullish and smartTrailUp and (isBullishOB or isBullishFVG or chochUp)

// ëŒ€ê¸°: Cë“±ê¸‰
bool waitSignal = not strongLong and not normalLong

// ============================================
// SHORT ë“±ê¸‰ ì‹œìŠ¤í…œ (30% ê°•í™”)
// ============================================

// SHORT Së“±ê¸‰: 3TF í•˜ë½ + ì €í•­ê·¼ì²˜ + ê±°ë˜ëŸ‰ + ë§¤ë„ì••ë ¥
bool gradeS_short = downtrendCount >= 3 and nearResistance3d and volSpikeCount >= 1 and buyPressure < 48

// SHORT Aë“±ê¸‰: 2TF í•˜ë½ + ê±°ë˜ëŸ‰ + ë§¤ë„ì••ë ¥
bool gradeA_short = downtrendCount >= 2 and volSpikeCount >= 1 and buyPressure < 52

// SHORT Bë“±ê¸‰: 2TF í•˜ë½ + 1H í•˜ë½
bool gradeB_short = downtrendCount >= 2 and not tf1h_uptrend

// SHORT ì‹œê·¸ë„
bool superShort = showShortSignals and gradeS_short and smcBearish and not smartTrailUp
bool strongShort = showShortSignals and (gradeS_short or gradeA_short) and not superShort
bool normalShort = showShortSignals and gradeB_short and not strongShort and not superShort

// ìµœì¢… ë“±ê¸‰ ì—…ë°ì´íŠ¸
string finalGrade = superLong ? "SUPER" : currentGrade

// ============================================
// ë§¤ë„ ì‹œê·¸ë„ (Smart Trail ê¸°ë°˜)
// ============================================

// Smart Trail ì „í™˜ ê°ì§€
var bool prevSmartTrailUp = true
bool trailFlipToShort = prevSmartTrailUp and not smartTrailUp  // LONG â†’ SHORT ì „í™˜
bool trailFlipToLong = not prevSmartTrailUp and smartTrailUp   // SHORT â†’ LONG ì „í™˜
prevSmartTrailUp := smartTrailUp

// ì²­ì‚° ì‹œê·¸ë„ (ë” ì—„ê²©í•œ ì¡°ê±´: Trailì „í™˜ + ì ìˆ˜ë‚®ìŒ + 1Hí•˜ë½)
bool exitLongSignal = trailFlipToShort and longScore < 12 and not tf1h_uptrend

// EXIT SHORT ì‹œê·¸ë„
bool exitShortSignal = trailFlipToLong and not tf1h_uptrend == false

// ì‹œê·¸ë„ ëª¨ë“œì— ë”°ë¥¸ í•„í„°ë§
bool showSuperLong = superLong and (signalMode == "ì „ì²´" or signalMode == "STRONG ì´ìƒ" or signalMode == "SUPERë§Œ")
bool showStrongLong = strongLong and not superLong and (signalMode == "ì „ì²´" or signalMode == "STRONG ì´ìƒ")
bool showNormalLong = normalLong and signalMode == "ì „ì²´"

// ============================================
// ì‹¬ë¦¬ì  ë§¤ë§¤ êµ¬ê°„ ë¶„ì„
// ============================================

// 1. ë¼ìš´ë“œ ë„˜ë²„ (Round Numbers)
float roundBelow = math.floor(close / roundNumInterval) * roundNumInterval
float roundAbove = roundBelow + roundNumInterval
float distToRoundBelow = math.abs(close - roundBelow) / close * 100
float distToRoundAbove = math.abs(roundAbove - close) / close * 100
bool nearRoundBelow = distToRoundBelow < 1.0  // 1% ì´ë‚´
bool nearRoundAbove = distToRoundAbove < 1.0
bool atRoundNumber = distToRoundBelow < 0.3 or distToRoundAbove < 0.3  // 0.3% ì´ë‚´

// 2. ê³µí¬/íƒìš• ì§€í‘œ (Fear & Greed)
// RSI ê¸°ë°˜ + ê°€ê²© í¸ì°¨ + ë³¼ë¥¨
float ema20 = ta.ema(close, 20)
float priceDeviation = (close - ema20) / ema20 * 100  // EMA20 ëŒ€ë¹„ í¸ì°¨
float rsiNorm = (rsi - 50) / 50  // -1 ~ +1 ì •ê·œí™”
float volNorm = math.min((volRatio - 1) / 4, 1)  // 0 ~ 1 ì •ê·œí™”

// ê³µí¬/íƒìš• ì ìˆ˜ (-100 ~ +100)
float fearGreedRaw = (rsiNorm * 40) + (priceDeviation * 3) + (volNorm * 20 * (close > ema20 ? 1 : -1))
float fearGreedScore = math.max(-100, math.min(100, fearGreedRaw))

// ê³µí¬/íƒìš• ë“±ê¸‰
string fearGreedGrade = fearGreedScore <= -60 ? "ê·¹ë‹¨ì ê³µí¬" : fearGreedScore <= -30 ? "ê³µí¬" : fearGreedScore <= -10 ? "ì•½í•œê³µí¬" : fearGreedScore < 10 ? "ì¤‘ë¦½" : fearGreedScore < 30 ? "ì•½í•œíƒìš•" : fearGreedScore < 60 ? "íƒìš•" : "ê·¹ë‹¨ì íƒìš•"

string fearGreedEmoji = fearGreedScore <= -60 ? "ğŸ˜±" : fearGreedScore <= -30 ? "ğŸ˜¨" : fearGreedScore <= -10 ? "ğŸ˜Ÿ" : fearGreedScore < 10 ? "ğŸ˜" : fearGreedScore < 30 ? "ğŸ™‚" : fearGreedScore < 60 ? "ğŸ˜€" : "ğŸ¤‘"

color fearGreedColor = fearGreedScore <= -60 ? color.new(color.green, 0) : fearGreedScore <= -30 ? color.new(color.lime, 20) : fearGreedScore <= -10 ? color.new(color.teal, 30) : fearGreedScore < 10 ? color.new(color.gray, 50) : fearGreedScore < 30 ? color.new(color.orange, 30) : fearGreedScore < 60 ? color.new(color.red, 20) : color.new(color.fuchsia, 0)

// ë§¤ìˆ˜/ë§¤ë„ ì‹¬ë¦¬ êµ¬ê°„
bool psychBuyZone = fearGreedScore <= -30 and nearSupport3d  // ê³µí¬ + ì§€ì§€ëŒ€ ê·¼ì²˜
bool psychSellZone = fearGreedScore >= 30 and nearResistance3d  // íƒìš• + ì €í•­ëŒ€ ê·¼ì²˜
bool extremeFear = fearGreedScore <= -60  // ê·¹ë‹¨ì  ê³µí¬ = ê°•í•œ ë§¤ìˆ˜ ì‹ í˜¸
bool extremeGreed = fearGreedScore >= 60  // ê·¹ë‹¨ì  íƒìš• = ê°•í•œ ë§¤ë„ ì‹ í˜¸

// 3. ë³¼ë¥¨ í”„ë¡œíŒŒì¼ ê¸°ë°˜ ì§€ì§€/ì €í•­ (ê°„ëµ ë²„ì „)
float volHigh = ta.highest(volume, 50)
float volLow = ta.lowest(volume, 50)
float volAvg50 = ta.sma(volume, 50)
bool highVolBar = volume > volAvg50 * 2

// ê³ ê±°ë˜ëŸ‰ ë°œìƒ ê°€ê²©ëŒ€ ì¶”ì  (ìµœê·¼ 50ë´‰ ì¤‘ ê³ ê±°ë˜ëŸ‰ ë°œìƒí•œ ê°€ê²©)
var float volSupportLevel = na
var float volResistanceLevel = na

if highVolBar and close > open
    volSupportLevel := low
if highVolBar and close < open
    volResistanceLevel := high

bool nearVolSupport = not na(volSupportLevel) and math.abs(close - volSupportLevel) / close * 100 < 1.5
bool nearVolResistance = not na(volResistanceLevel) and math.abs(close - volResistanceLevel) / close * 100 < 1.5

// 4. í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨
float fibHigh = ta.highest(high, fibLookback)
float fibLow = ta.lowest(low, fibLookback)
float fibRange = fibHigh - fibLow

float fib236 = fibHigh - fibRange * 0.236
float fib382 = fibHigh - fibRange * 0.382
float fib500 = fibHigh - fibRange * 0.5
float fib618 = fibHigh - fibRange * 0.618
float fib786 = fibHigh - fibRange * 0.786

bool nearFib382 = math.abs(close - fib382) / close * 100 < 0.5
bool nearFib500 = math.abs(close - fib500) / close * 100 < 0.5
bool nearFib618 = math.abs(close - fib618) / close * 100 < 0.5

// 5. ì£¼ìš” ê³ ì /ì €ì  (ì‹¬ë¦¬ì  ì§€ì§€/ì €í•­)
float keyHigh1 = ta.highest(high, keyLevelLookback)
float keyLow1 = ta.lowest(low, keyLevelLookback)
float keyHigh2 = ta.highest(high, keyLevelLookback * 2)
float keyLow2 = ta.lowest(low, keyLevelLookback * 2)

// ì‹¬ë¦¬ì  ìŠ¤ìœ™ ê³ ì /ì €ì  ì°¾ê¸° (ê¸°ì¡´ swingHighì™€ ë³„ë„)
float psychSwingHigh = ta.pivothigh(high, 15, 15)
float psychSwingLow = ta.pivotlow(low, 15, 15)

var float lastPsychHigh = na
var float lastPsychLow = na
var float prevPsychHigh = na
var float prevPsychLow = na

if not na(psychSwingHigh)
    prevPsychHigh := lastPsychHigh
    lastPsychHigh := psychSwingHigh
if not na(psychSwingLow)
    prevPsychLow := lastPsychLow
    lastPsychLow := psychSwingLow

bool nearKeyHigh = not na(lastPsychHigh) and math.abs(close - lastPsychHigh) / close * 100 < 1.0
bool nearKeyLow = not na(lastPsychLow) and math.abs(close - lastPsychLow) / close * 100 < 1.0

// 6. POC (Point of Control) - ê±°ë˜ëŸ‰ ì§‘ì¤‘ ê°€ê²©ëŒ€
var float[] priceVolume = array.new_float(20, 0.0)
var float[] priceLevels = array.new_float(20, 0.0)

float priceRangeHigh = ta.highest(high, pocLookback)
float priceRangeLow = ta.lowest(low, pocLookback)
float priceStep = (priceRangeHigh - priceRangeLow) / 20

// í˜„ì¬ ë´‰ì˜ ê°€ê²©ëŒ€ ì¸ë±ìŠ¤
int priceIndex = priceStep > 0 ? math.min(19, math.max(0, int((close - priceRangeLow) / priceStep))) : 0

// ê±°ë˜ëŸ‰ ëˆ„ì 
if bar_index > pocLookback
    array.set(priceVolume, priceIndex, array.get(priceVolume, priceIndex) + volume)
    array.set(priceLevels, priceIndex, priceRangeLow + priceStep * priceIndex + priceStep / 2)

// POC ì°¾ê¸° (ê°€ì¥ ê±°ë˜ëŸ‰ ë§ì€ ê°€ê²©ëŒ€)
var float pocPrice = na
var float maxVol = 0.0
var float hvnPrice1 = na  // High Volume Node 1
var float hvnPrice2 = na  // High Volume Node 2

if barstate.islast
    maxVol := 0.0
    float secondMaxVol = 0.0
    for i = 0 to 19
        float vol = array.get(priceVolume, i)
        if vol > maxVol
            secondMaxVol := maxVol
            hvnPrice2 := hvnPrice1
            maxVol := vol
            pocPrice := array.get(priceLevels, i)
            hvnPrice1 := pocPrice
        else if vol > secondMaxVol
            secondMaxVol := vol
            hvnPrice2 := array.get(priceLevels, i)

bool nearPOC = not na(pocPrice) and math.abs(close - pocPrice) / close * 100 < 0.5

// ì¢…í•© ì‹¬ë¦¬ì  êµ¬ê°„ íŒë‹¨
string psychZone = extremeFear ? "ê·¹ë‹¨ì ê³µí¬" : extremeGreed ? "ê·¹ë‹¨ì íƒìš•" : psychBuyZone ? "ë§¤ìˆ˜êµ¬ê°„" : psychSellZone ? "ë§¤ë„êµ¬ê°„" : nearRoundBelow ? "ë¼ìš´ë“œì§€ì§€" : nearRoundAbove ? "ë¼ìš´ë“œì €í•­" : nearFib618 ? "Fib618" : nearFib500 ? "Fib500" : nearFib382 ? "Fib382" : "ì¤‘ë¦½"

// ============================================
// ì°¨íŠ¸ í‘œì‹œ
// ============================================

// EMA
plot(showEMA ? ema9 : na, color=color.yellow, linewidth=1, title="EMA 9")
plot(showEMA ? ema21 : na, color=color.orange, linewidth=2, title="EMA 21")
plot(showEMA ? ema50 : na, color=color.blue, linewidth=1, title="EMA 50")
plot(showEMA ? ema200 : na, color=color.purple, linewidth=1, title="EMA 200")

// EMA ê°ë„ ìƒ‰ìƒ ë¼ì¸ (ì¶”ì„¸ ê°•ë„ ì‹œê°í™”)
plot(showEMAAngle ? emaAngle14 : na, color=emaAngleColor, linewidth=3, title="EMA Angle")

// ë³¼ë¦°ì €ë°´ë“œ
plot(showBB ? bbUpper : na, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(showBB ? bbBasis : na, color=color.new(color.gray, 70), linewidth=1, title="BB Basis")
plot(showBB ? bbLower : na, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")

// ë‹¤ì´ë²„ì „ìŠ¤ í‘œì‹œ
plotshape(showDivergence and bullishDivergence, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 20), text="DIV+", textcolor=color.white, size=size.tiny, title="Bullish Div", offset=-pivotRight)
plotshape(showDivergence and bearishDivergence, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 20), text="DIV-", textcolor=color.white, size=size.tiny, title="Bearish Div", offset=-pivotRight)

// ============================================
// ì‹¬ë¦¬ì  êµ¬ê°„ ì‹œê°í™”
// ============================================

// ë¼ìš´ë“œ ë„˜ë²„ ë¼ì¸
var line roundBelowLine = na
var line roundAboveLine = na
var label roundBelowLabel = na
var label roundAboveLabel = na

if showPsychLevels and showRoundNumbers and barstate.islast
    if not na(roundBelowLine)
        line.delete(roundBelowLine)
    if not na(roundAboveLine)
        line.delete(roundAboveLine)
    if not na(roundBelowLabel)
        label.delete(roundBelowLabel)
    if not na(roundAboveLabel)
        label.delete(roundAboveLabel)

    roundBelowLine := line.new(bar_index - 50, roundBelow, bar_index + 10, roundBelow, color=color.new(color.blue, 50), width=2, style=line.style_dotted)
    roundAboveLine := line.new(bar_index - 50, roundAbove, bar_index + 10, roundAbove, color=color.new(color.blue, 50), width=2, style=line.style_dotted)
    roundBelowLabel := label.new(bar_index + 12, roundBelow, "ğŸ“$" + str.tostring(roundBelow, "#"), style=label.style_label_left, color=color.new(color.blue, 70), textcolor=color.white, size=size.tiny)
    roundAboveLabel := label.new(bar_index + 12, roundAbove, "ğŸ“$" + str.tostring(roundAbove, "#"), style=label.style_label_left, color=color.new(color.blue, 70), textcolor=color.white, size=size.tiny)

// í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ ë¼ì¸
var line fib382Line = na
var line fib500Line = na
var line fib618Line = na

if showPsychLevels and showFibLevels and barstate.islast
    if not na(fib382Line)
        line.delete(fib382Line)
    if not na(fib500Line)
        line.delete(fib500Line)
    if not na(fib618Line)
        line.delete(fib618Line)

    fib382Line := line.new(bar_index - 50, fib382, bar_index + 10, fib382, color=color.new(color.yellow, 20), width=2, style=line.style_dashed)
    fib500Line := line.new(bar_index - 50, fib500, bar_index + 10, fib500, color=color.new(color.orange, 20), width=2, style=line.style_dashed)
    fib618Line := line.new(bar_index - 50, fib618, bar_index + 10, fib618, color=color.new(color.red, 20), width=2, style=line.style_dashed)

// ì£¼ìš” ê³ ì /ì €ì  (ì‹¬ë¦¬ì  ì§€ì§€/ì €í•­)
var line keyHighLine = na
var line keyLowLine = na
var line prevKeyHighLine = na
var line prevKeyLowLine = na
var label keyHighLabel = na
var label keyLowLabel = na

if showPsychLevels and showKeyLevels and barstate.islast
    if not na(keyHighLine)
        line.delete(keyHighLine)
    if not na(keyLowLine)
        line.delete(keyLowLine)
    if not na(prevKeyHighLine)
        line.delete(prevKeyHighLine)
    if not na(prevKeyLowLine)
        line.delete(prevKeyLowLine)
    if not na(keyHighLabel)
        label.delete(keyHighLabel)
    if not na(keyLowLabel)
        label.delete(keyLowLabel)

    if not na(lastPsychHigh)
        keyHighLine := line.new(bar_index - 80, lastPsychHigh, bar_index + 10, lastPsychHigh, color=color.new(color.red, 30), width=2, style=line.style_solid)
        keyHighLabel := label.new(bar_index + 12, lastPsychHigh, "ğŸ”ºê³ ì \n$" + str.tostring(lastPsychHigh, "#"), style=label.style_label_left, color=color.new(color.red, 50), textcolor=color.white, size=size.tiny)
    if not na(lastPsychLow)
        keyLowLine := line.new(bar_index - 80, lastPsychLow, bar_index + 10, lastPsychLow, color=color.new(color.green, 30), width=2, style=line.style_solid)
        keyLowLabel := label.new(bar_index + 12, lastPsychLow, "ğŸ”»ì €ì \n$" + str.tostring(lastPsychLow, "#"), style=label.style_label_left, color=color.new(color.green, 50), textcolor=color.white, size=size.tiny)
    if not na(prevPsychHigh) and prevPsychHigh != lastPsychHigh
        prevKeyHighLine := line.new(bar_index - 80, prevPsychHigh, bar_index + 10, prevPsychHigh, color=color.new(color.red, 60), width=1, style=line.style_dotted)
    if not na(prevPsychLow) and prevPsychLow != lastPsychLow
        prevKeyLowLine := line.new(bar_index - 80, prevPsychLow, bar_index + 10, prevPsychLow, color=color.new(color.green, 60), width=1, style=line.style_dotted)

// POC (Point of Control) ë¼ì¸
var line pocLine = na
var line hvnLine1 = na
var line hvnLine2 = na
var label pocLabel = na
var box pocBox = na

if showPsychLevels and showPOC and barstate.islast
    if not na(pocLine)
        line.delete(pocLine)
    if not na(hvnLine1)
        line.delete(hvnLine1)
    if not na(hvnLine2)
        line.delete(hvnLine2)
    if not na(pocLabel)
        label.delete(pocLabel)
    if not na(pocBox)
        box.delete(pocBox)

    if not na(pocPrice)
        // POC ë¼ì¸ (ê°€ì¥ ê±°ë˜ëŸ‰ ë§ì€ ê°€ê²©)
        pocLine := line.new(bar_index - 80, pocPrice, bar_index + 10, pocPrice, color=color.new(color.yellow, 0), width=3, style=line.style_solid)
        pocLabel := label.new(bar_index + 12, pocPrice, "âš¡POC\n$" + str.tostring(pocPrice, "#"), style=label.style_label_left, color=color.new(color.yellow, 30), textcolor=color.black, size=size.tiny)
        // POC ì£¼ë³€ ë°•ìŠ¤ (ê±°ë˜ëŸ‰ ì§‘ì¤‘ êµ¬ê°„)
        float boxHeight = priceStep * 2
        pocBox := box.new(bar_index - 60, pocPrice + boxHeight, bar_index + 5, pocPrice - boxHeight, bgcolor=color.new(color.yellow, 85), border_color=color.new(color.yellow, 50), border_width=1)

// ê³µí¬/íƒìš• ë°°ê²½ìƒ‰ (ê·¹ë‹¨ì  êµ¬ê°„ë§Œ)
bgcolor(showPsychLevels and showFearGreed and extremeFear ? color.new(color.green, 85) : na, title="ê·¹ë‹¨ì  ê³µí¬")
bgcolor(showPsychLevels and showFearGreed and extremeGreed ? color.new(color.red, 85) : na, title="ê·¹ë‹¨ì  íƒìš•")

// ì‹¬ë¦¬ì  ë§¤ìˆ˜/ë§¤ë„ êµ¬ê°„ ë§ˆì»¤
plotshape(showPsychLevels and psychBuyZone and not extremeFear, style=shape.diamond, location=location.belowbar, color=color.new(color.teal, 30), size=size.tiny, title="ì‹¬ë¦¬ì  ë§¤ìˆ˜ êµ¬ê°„")
plotshape(showPsychLevels and psychSellZone and not extremeGreed, style=shape.diamond, location=location.abovebar, color=color.new(color.maroon, 30), size=size.tiny, title="ì‹¬ë¦¬ì  ë§¤ë„ êµ¬ê°„")

// ë¼ìš´ë“œ ë„˜ë²„ ê·¼ì²˜ ì•Œë¦¼
plotshape(showPsychLevels and showRoundNumbers and atRoundNumber, style=shape.circle, location=location.belowbar, color=color.new(color.blue, 50), size=size.tiny, title="ë¼ìš´ë“œ ë„˜ë²„")

// 3ì¼ ì§€ì§€/ì €í•­ ë¼ì¸
var line sup3dLine = na
var line res3dLine = na
var label sup3dLabel = na
var label res3dLabel = na

if showSR and barstate.islast
    if not na(sup3dLine)
        line.delete(sup3dLine)
    if not na(res3dLine)
        line.delete(res3dLine)
    if not na(sup3dLabel)
        label.delete(sup3dLabel)
    if not na(res3dLabel)
        label.delete(res3dLabel)

    sup3dLine := line.new(bar_index - 100, support3d, bar_index + 10, support3d, color=color.green, width=3, style=line.style_solid)
    res3dLine := line.new(bar_index - 100, resistance3d, bar_index + 10, resistance3d, color=color.red, width=3, style=line.style_solid)
    sup3dLabel := label.new(bar_index + 12, support3d, "3D SUP\n" + str.tostring(support3d, "#.#"), style=label.style_label_left, color=color.green, textcolor=color.white, size=size.small)
    res3dLabel := label.new(bar_index + 12, resistance3d, "3D RES\n" + str.tostring(resistance3d, "#.#"), style=label.style_label_left, color=color.red, textcolor=color.white, size=size.small)

// ë©”ì¸ ì‹œê·¸ë„ (í•µì‹¬ë§Œ í‘œì‹œ)
// SUPER LONG: ğŸš€ ë¡œì¼“ - ê°€ì¥ í™•ì‹¤í•œ ì§„ì… êµ¬ê°„
plotshape(showVisuals and showSuperLong, style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), text="ğŸš€", textcolor=color.white, size=size.huge, title="SUPER LONG")
// STRONG LONG: â­ ë³„ - ê°•ë ¥í•œ ì§„ì… êµ¬ê°„
plotshape(showVisuals and showStrongLong, style=shape.labelup, location=location.belowbar, color=color.new(color.yellow, 0), text="â­", textcolor=color.black, size=size.large, title="STRONG LONG")
// LONG: ì¼ë°˜ ì‚¼ê°í˜• - ì‹œê·¸ë„ ëª¨ë“œ "ì „ì²´"ì¼ ë•Œë§Œ í‘œì‹œ
plotshape(showVisuals and showNormalLong and signalMode == "ì „ì²´", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="LONG")

// SHORT ì‹œê·¸ë„ (LONGê³¼ ìœ ì‚¬í•œ ë“±ê¸‰)
// SUPER SHORT: ğŸ’€ í•´ê³¨ - ê°€ì¥ í™•ì‹¤í•œ ìˆ êµ¬ê°„
plotshape(showVisuals and superShort, style=shape.labeldown, location=location.abovebar, color=color.new(color.fuchsia, 0), text="ğŸ’€", textcolor=color.white, size=size.huge, title="SUPER SHORT")
// STRONG SHORT: âš ï¸ ê²½ê³  - ê°•ë ¥í•œ ìˆ êµ¬ê°„
plotshape(showVisuals and strongShort, style=shape.labeldown, location=location.abovebar, color=color.new(color.orange, 0), text="âš ï¸", textcolor=color.black, size=size.large, title="STRONG SHORT")
// SHORT: ì¼ë°˜ ì‚¼ê°í˜• - ì‹œê·¸ë„ ëª¨ë“œ "ì „ì²´"ì¼ ë•Œë§Œ í‘œì‹œ
plotshape(showVisuals and normalShort and signalMode == "ì „ì²´", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="SHORT")

// ì²­ì‚° ì‹œê·¸ë„
plotshape(showVisuals and exitLongSignal, style=shape.xcross, location=location.abovebar, color=color.red, size=size.normal, title="EXIT LONG")
plotshape(showVisuals and exitShortSignal, style=shape.xcross, location=location.belowbar, color=color.green, size=size.normal, title="EXIT SHORT")
plotshape(showVisuals and trailFlipToShort and not exitLongSignal, style=shape.circle, location=location.abovebar, color=color.orange, size=size.tiny, title="Trail Warning")

// ê³ ë˜ ë§¤ìˆ˜/ë§¤ë„ ì‹œê·¸ë„
// ê³ ë˜ ë“±ê¸‰ë³„ ë¼ë²¨ í‘œì‹œ
if showVisuals and showWhale and whaleBuy
    label.new(bar_index, low, whaleStrength + "\nBUY", style=label.style_label_up, color=color.blue, textcolor=color.white, size=size.small)

if showVisuals and showWhale and whaleSell
    label.new(bar_index, high, whaleStrength + "\nSELL", style=label.style_label_down, color=color.purple, textcolor=color.white, size=size.small)

// ê³ ë˜ ë°°ê²½ìƒ‰
bgcolor(showWhale and whaleBuy ? color.new(color.blue, 85) : na)
bgcolor(showWhale and whaleSell ? color.new(color.purple, 85) : na)

// ë°°ê²½ìƒ‰ (í•„í„°ë§ ì ìš©)
bgcolor(showSuperLong ? color.new(color.aqua, 60) : na)
bgcolor(showStrongLong ? color.new(color.yellow, 70) : na)
bgcolor(gradeA and not strongLong and signalMode == "ì „ì²´" ? color.new(color.lime, 85) : na)
bgcolor(exitLongSignal ? color.new(color.red, 70) : na)

// ============================================
// SMC ì‹œê°í™”
// ============================================

// Smart Trail í”Œë¡¯
plot(showSMC and showSmartTrail ? smartTrail : na, color=smartTrailUp ? color.lime : color.red, linewidth=2, style=plot.style_stepline_diamond, title="Smart Trail")

// BOS/CHoCH ë¼ë²¨
if showSMC and showBOS and bosUp
    label.new(bar_index, high, "BOS+", style=label.style_label_down, color=color.new(color.teal, 30), textcolor=color.white, size=size.tiny)

if showSMC and showBOS and bosDn
    label.new(bar_index, low, "BOS-", style=label.style_label_up, color=color.new(color.maroon, 30), textcolor=color.white, size=size.tiny)

if showSMC and showBOS and chochUp
    label.new(bar_index, high, "CHoCH+", style=label.style_label_down, color=color.lime, textcolor=color.black, size=size.small)

if showSMC and showBOS and chochDn
    label.new(bar_index, low, "CHoCH-", style=label.style_label_up, color=color.fuchsia, textcolor=color.white, size=size.small)

// Liquidity Levels ë¼ì¸ í‘œì‹œ
var line[] eqHighLines = array.new_line(0)
var line[] eqLowLines = array.new_line(0)
var label[] eqHighLabels = array.new_label(0)
var label[] eqLowLabels = array.new_label(0)

// Equal Highs ë¼ì¸ ê·¸ë¦¬ê¸°
if showSMC and showLiquidityLevels and array.size(eqHighs) > 0
    if array.size(eqHighLines) > 0
        for i = 0 to array.size(eqHighLines) - 1
            line.delete(array.get(eqHighLines, i))
        array.clear(eqHighLines)
    if array.size(eqHighLabels) > 0
        for i = 0 to array.size(eqHighLabels) - 1
            label.delete(array.get(eqHighLabels, i))
        array.clear(eqHighLabels)
    for i = 0 to array.size(eqHighs) - 1
        float lvl = array.get(eqHighs, i)
        int startBar = array.get(eqHighBars, i)
        array.push(eqHighLines, line.new(startBar, lvl, bar_index + 20, lvl, color=color.new(color.orange, 40), width=2, style=line.style_dotted))
        array.push(eqHighLabels, label.new(bar_index + 22, lvl, "EQH", style=label.style_label_left, color=color.new(color.orange, 50), textcolor=color.white, size=size.tiny))

// Equal Lows ë¼ì¸ ê·¸ë¦¬ê¸°
if showSMC and showLiquidityLevels and array.size(eqLows) > 0
    if array.size(eqLowLines) > 0
        for i = 0 to array.size(eqLowLines) - 1
            line.delete(array.get(eqLowLines, i))
        array.clear(eqLowLines)
    if array.size(eqLowLabels) > 0
        for i = 0 to array.size(eqLowLabels) - 1
            label.delete(array.get(eqLowLabels, i))
        array.clear(eqLowLabels)
    for i = 0 to array.size(eqLows) - 1
        float lvl = array.get(eqLows, i)
        int startBar = array.get(eqLowBars, i)
        array.push(eqLowLines, line.new(startBar, lvl, bar_index + 20, lvl, color=color.new(color.purple, 40), width=2, style=line.style_dotted))
        array.push(eqLowLabels, label.new(bar_index + 22, lvl, "EQL", style=label.style_label_left, color=color.new(color.purple, 50), textcolor=color.white, size=size.tiny))

// Premium/Discount Zone í‘œì‹œ
plot(showSMC ? premiumZone : na, color=color.new(color.red, 70), linewidth=1, style=plot.style_linebr, title="Premium Zone")
plot(showSMC ? discountZone : na, color=color.new(color.green, 70), linewidth=1, style=plot.style_linebr, title="Discount Zone")
plot(showSMC ? rangeMid : na, color=color.new(color.gray, 80), linewidth=1, style=plot.style_linebr, title="Range Mid")

// ============================================
// ì‹œê·¸ë„ ë¼ë²¨
// ============================================

if showSignalLabel and superLong
    string t1 = "***** SUPER [" + finalGrade + "] " + str.tostring(longScore, "#") + "pt *****"
    string t2 = "MTF + SMC + Smart Trail ì¼ì¹˜!"
    string t3 = "ì¶”ì„¸: " + trendStrength + " (" + str.tostring(trendScore) + "/14)"
    string t4 = "TF: " + str.tostring(uptrendCount) + "/4 EMA:" + str.tostring(emaAlignedUpCount) + "/5"
    string t5 = "SMC: " + (isBullishOB ? "OB+" : "") + (isBullishFVG ? " FVG+" : "") + (chochUp ? " CHoCH+" : "")
    string t6 = "Zone: " + (inDiscount ? "DISCOUNT" : "MID") + " Trail: LONG"
    string lblText = t1 + "\n" + t2 + "\n" + t3 + "\n" + t4 + "\n" + t5 + "\n" + t6
    label.new(bar_index, low, lblText, style=label.style_label_up, color=color.aqua, textcolor=color.black, size=size.large)

if showSignalLabel and strongLong and not superLong
    string t1 = "*** STRONG [" + currentGrade + "] " + str.tostring(longScore, "#") + "pt ***"
    string t2 = highConfidenceLong ? confReason : ""
    string t3 = "ì¶”ì„¸: " + trendStrength + " (" + str.tostring(trendScore) + "/14)"
    string t4 = "TF: " + str.tostring(uptrendCount) + "/4 EMA:" + str.tostring(emaAlignedUpCount) + "/5 MACD:" + str.tostring(macdBullCount) + "/5"
    string t5 = "ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "% ADX:" + str.tostring(adxValue, "#")
    string v15 = tf15m_volSpike ? str.tostring(tf15m_volRatio, "#.#") : "-"
    string v1h = tf1h_volSpike ? str.tostring(tf1h_volRatio, "#.#") : "-"
    string v4h = tf4h_volSpike ? str.tostring(tf4h_volRatio, "#.#") : "-"
    string t6 = "Vol[15m:" + v15 + " 1H:" + v1h + " 4H:" + v4h + "]"
    string lblText = t1 + (t2 != "" ? "\n" + t2 : "") + "\n" + t3 + "\n" + t4 + "\n" + t5 + "\n" + t6
    label.new(bar_index, low, lblText, style=label.style_label_up, color=color.yellow, textcolor=color.black, size=size.normal)

if showSignalLabel and normalLong
    string t1 = "LONG [" + currentGrade + "] " + str.tostring(longScore, "#") + "pt"
    string t2 = "ì¶”ì„¸:" + trendStrength + " TF:" + str.tostring(uptrendCount) + "/4"
    string t3 = "EMA:" + str.tostring(emaAlignedUpCount) + "/5 MACD:" + str.tostring(macdBullCount) + "/5"
    string t4 = "Vol:" + str.tostring(volRatio, "#.#") + "x"
    string lblText = t1 + "\n" + t2 + "\n" + t3 + "\n" + t4
    label.new(bar_index, low, lblText, style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

// ============================================
// ì •ë³´ í…Œì´ë¸” (ê±°ë˜ëŸ‰ ë°°ìˆ˜ í¬í•¨)
// ============================================

if showInfoTable
    var table infoTbl = table.new(position.top_right, 5, 21, bgcolor=color.new(color.white, 5), border_width=1)

    if barstate.islast
        table.clear(infoTbl, 0, 0, 4, 20)

        // í—¤ë” + ëª¨ë“œ í‘œì‹œ
        string modeText = tradeMode == "ì„ ë¬¼" ? "F" : tradeMode == "í˜„ë¬¼" ? "S" : "K"  // Futures/Spot/stocK
        table.cell(infoTbl, 0, 0, "V39 [" + modeText + "]", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(infoTbl, 1, 0, "ì¶”ì„¸", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(infoTbl, 2, 0, "EMA", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(infoTbl, 3, 0, "MACD", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(infoTbl, 4, 0, "Vol", text_color=color.white, bgcolor=color.blue, text_size=size.small)

        // í˜„ì¬TF
        string curTFVol = str.tostring(volRatio, "#.#") + "x"
        color curVolColor = volumeExplosion ? color.lime : volSpike ? color.green : color.gray
        string curEma = emaAlignedUp ? "UP!" : emaAlignedDown ? "DN!" : ema9 > ema21 ? "up" : "dn"
        color curEmaColor = emaAlignedUp ? color.lime : emaAlignedDown ? color.fuchsia : ema9 > ema21 ? color.green : color.red
        table.cell(infoTbl, 0, 1, timeframe.period, text_color=color.blue, text_size=size.tiny)
        table.cell(infoTbl, 1, 1, ema9 > ema21 ? "UP" : "DN", text_color=ema9 > ema21 ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 2, 1, curEma, text_color=curEmaColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 1, macdBullish ? "BULL" : "BEAR", text_color=macdBullish ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 1, curTFVol, text_color=curVolColor, text_size=size.tiny)

        // 15ë¶„ (5ë¶„ë´‰ ì œê±°ë¨)
        string vol15mTxt = str.tostring(tf15m_volRatio, "#.#") + "x"
        color vol15mColor = tf15m_volRatio >= volHighThreshold ? color.lime : tf15m_volSpike ? color.green : color.gray
        string ema15m = tf15m_emaAligned ? "UP!" : tf15m_emaAlignedDn ? "DN!" : tf15m_uptrend ? "up" : tf15m_downtrend ? "dn" : "-"
        color ema15mColor = tf15m_emaAligned ? color.lime : tf15m_emaAlignedDn ? color.fuchsia : tf15m_uptrend ? color.green : tf15m_downtrend ? color.red : color.gray
        table.cell(infoTbl, 0, 2, "15m", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 2, tf15m_uptrend ? "UP" : tf15m_downtrend ? "DN" : "-", text_color=tf15m_uptrend ? color.green : tf15m_downtrend ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 2, ema15m, text_color=ema15mColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 2, tf15m_macdBull ? "BULL" : "BEAR", text_color=tf15m_macdBull ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 2, vol15mTxt, text_color=vol15mColor, text_size=size.tiny)

        // 1ì‹œê°„
        string vol1hTxt = str.tostring(tf1h_volRatio, "#.#") + "x"
        color vol1hColor = tf1h_volRatio >= volHighThreshold ? color.lime : tf1h_volSpike ? color.green : color.gray
        string ema1h = tf1h_emaAligned ? "UP!" : tf1h_emaAlignedDn ? "DN!" : tf1h_uptrend ? "up" : tf1h_downtrend ? "dn" : "-"
        color ema1hColor = tf1h_emaAligned ? color.lime : tf1h_emaAlignedDn ? color.fuchsia : tf1h_uptrend ? color.green : tf1h_downtrend ? color.red : color.gray
        table.cell(infoTbl, 0, 3, "1H", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 3, tf1h_uptrend ? "UP" : tf1h_downtrend ? "DN" : "-", text_color=tf1h_uptrend ? color.green : tf1h_downtrend ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 3, ema1h, text_color=ema1hColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 3, tf1h_macdBull ? "BULL" : "BEAR", text_color=tf1h_macdBull ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 3, vol1hTxt, text_color=vol1hColor, text_size=size.tiny)

        // 4ì‹œê°„
        string vol4hTxt = str.tostring(tf4h_volRatio, "#.#") + "x"
        color vol4hColor = tf4h_volRatio >= volHighThreshold ? color.lime : tf4h_volSpike ? color.green : color.gray
        string ema4h = tf4h_emaAligned ? "UP!" : tf4h_emaAlignedDn ? "DN!" : tf4h_uptrend ? "up" : tf4h_downtrend ? "dn" : "-"
        color ema4hColor = tf4h_emaAligned ? color.lime : tf4h_emaAlignedDn ? color.fuchsia : tf4h_uptrend ? color.green : tf4h_downtrend ? color.red : color.gray
        table.cell(infoTbl, 0, 4, "4H", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 4, tf4h_uptrend ? "UP" : tf4h_downtrend ? "DN" : "-", text_color=tf4h_uptrend ? color.green : tf4h_downtrend ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 4, ema4h, text_color=ema4hColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 4, tf4h_macdBull ? "BULL" : "BEAR", text_color=tf4h_macdBull ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 4, vol4hTxt, text_color=vol4hColor, text_size=size.tiny)

        // ì¼ë´‰
        string emaD = tfD_emaAligned ? "UP!" : tfD_emaAlignedDn ? "DN!" : tfD_uptrend ? "up" : tfD_downtrend ? "dn" : "-"
        color emaDColor = tfD_emaAligned ? color.lime : tfD_emaAlignedDn ? color.fuchsia : tfD_uptrend ? color.green : tfD_downtrend ? color.red : color.gray
        table.cell(infoTbl, 0, 5, "1D", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 5, tfD_uptrend ? "UP" : tfD_downtrend ? "DN" : "-", text_color=tfD_uptrend ? color.green : tfD_downtrend ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 5, emaD, text_color=emaDColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 5, tfD_macdBull ? "BULL" : "BEAR", text_color=tfD_macdBull ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 5, "-", text_color=color.gray, text_size=size.tiny)

        // êµ¬ë¶„ì„ 
        table.cell(infoTbl, 0, 6, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 1, 6, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 6, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 6, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 6, "---", text_color=color.gray, text_size=size.tiny)

        // ì¶”ì„¸ ì¢…í•©
        color trendScoreColor = trendScore >= 12 ? color.lime : trendScore >= 10 ? color.green : trendScore >= 7 ? color.orange : trendScore >= 5 ? color.gray : color.red
        table.cell(infoTbl, 0, 7, "ì¶”ì„¸ê°•ë„", text_color=color.white, bgcolor=color.teal, text_size=size.tiny)
        table.cell(infoTbl, 1, 7, trendStrength, text_color=trendScoreColor, text_size=size.tiny)
        table.cell(infoTbl, 2, 7, str.tostring(trendScore) + "/14", text_color=trendScoreColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 7, "", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 7, "", text_color=color.gray, text_size=size.tiny)

        // ìƒì„¸ ì¹´ìš´íŠ¸
        table.cell(infoTbl, 0, 8, "TFì¼ì¹˜", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 8, str.tostring(uptrendCount) + "/4", text_color=uptrendCount >= 3 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 8, "EMAì •ë ¬", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 3, 8, str.tostring(emaAlignedUpCount) + "/5", text_color=emaAlignedUpCount >= 3 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 8, emaAlignedUpCount >= 4 ? "!!" : "", text_color=color.lime, text_size=size.tiny)

        table.cell(infoTbl, 0, 9, "MACDì¼ì¹˜", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 9, str.tostring(macdBullCount) + "/5", text_color=macdBullCount >= 4 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 9, "Volê¸‰ì¦", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 3, 9, str.tostring(volSpikeCount) + "/4", text_color=volSpikeCount >= 2 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 9, multiTFVolume ? "MTF!" : "", text_color=color.lime, text_size=size.tiny)

        // ìœ„ì¹˜/ë§¤ìˆ˜ì••ë ¥
        table.cell(infoTbl, 0, 10, "ìœ„ì¹˜", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 10, str.tostring(pricePosition, "#") + "%", text_color=nearSupport3d ? color.green : nearResistance3d ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 10, atSupport3d ? "SUP!" : atResistance3d ? "RES!" : "", text_color=atSupport3d ? color.lime : color.fuchsia, text_size=size.tiny)
        table.cell(infoTbl, 3, 10, "Buy%", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 4, 10, str.tostring(buyPressure, "#") + "%", text_color=buyPressure > 55 ? color.green : buyPressure < 45 ? color.red : color.gray, text_size=size.tiny)

        // RSI/Stoch
        table.cell(infoTbl, 0, 11, "RSI", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 11, str.tostring(rsi, "#"), text_color=rsiOversold ? color.green : rsiOverbought ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 11, stochOversold ? "OS!" : stochOverbought ? "OB!" : "", text_color=stochOversold ? color.lime : color.fuchsia, text_size=size.tiny)
        table.cell(infoTbl, 3, 11, "Stoch", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 4, 11, str.tostring(stochK, "#"), text_color=stochOversold ? color.green : stochOverbought ? color.red : color.gray, text_size=size.tiny)

        // ADX
        table.cell(infoTbl, 0, 12, "ADX", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 12, str.tostring(adxValue, "#"), text_color=trendStrong ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 12, trendStrong ? "STRONG" : "WEAK", text_color=trendStrong ? color.lime : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 12, "DI", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 4, 12, bullishDI ? "+DI" : "-DI", text_color=bullishDI ? color.green : color.red, text_size=size.tiny)

        // BB
        table.cell(infoTbl, 0, 13, "BB", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 13, touchBBLower ? "í•˜ë‹¨!" : touchBBUpper ? "ìƒë‹¨!" : close > bbBasis ? "ì¤‘ì•™â†‘" : "ì¤‘ì•™â†“", text_color=touchBBLower ? color.lime : touchBBUpper ? color.fuchsia : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 13, bullishDivergence ? "DIV+" : bearishDivergence ? "DIV-" : "", text_color=bullishDivergence ? color.lime : bearishDivergence ? color.fuchsia : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 13, "", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 13, "", text_color=color.gray, text_size=size.tiny)

        // ì ìˆ˜
        table.cell(infoTbl, 0, 14, "ì ìˆ˜", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 14, str.tostring(longScore, "#") + "/30", text_color=longScore >= 20 ? color.lime : longScore >= 15 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 14, highConfidenceLong ? "HC!" : "", text_color=color.yellow, text_size=size.tiny)
        table.cell(infoTbl, 3, 14, "í™•ì‹ ", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 4, 14, confReason, text_color=highConfidenceLong ? color.yellow : color.gray, text_size=size.tiny)

        // SMC ì •ë³´
        string smcOB = isBullishOB ? "OB+" : isBearishOB ? "OB-" : "-"
        color smcOBColor = isBullishOB ? color.lime : isBearishOB ? color.red : color.gray
        string smcFVG = isBullishFVG ? "FVG+" : isBearishFVG ? "FVG-" : "-"
        color smcFVGColor = isBullishFVG ? color.teal : isBearishFVG ? color.maroon : color.gray
        string smcBOS = chochUp ? "CHoCH+" : chochDn ? "CHoCH-" : bosUp ? "BOS+" : bosDn ? "BOS-" : "-"
        color smcBOSColor = chochUp or bosUp ? color.lime : chochDn or bosDn ? color.red : color.gray
        string smcZone = inPremium ? "PREMIUM" : inDiscount ? "DISCOUNT" : "MID"
        color smcZoneColor = inDiscount ? color.green : inPremium ? color.red : color.gray
        string smcTrail = smartTrailUp ? "LONG" : "SHORT"
        color smcTrailColor = smartTrailUp ? color.lime : color.fuchsia

        table.cell(infoTbl, 0, 15, "SMC", text_color=color.white, bgcolor=color.purple, text_size=size.tiny)
        table.cell(infoTbl, 1, 15, smcOB, text_color=smcOBColor, text_size=size.tiny)
        table.cell(infoTbl, 2, 15, smcFVG, text_color=smcFVGColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 15, smcBOS, text_color=smcBOSColor, text_size=size.tiny)
        table.cell(infoTbl, 4, 15, smcTrail, text_color=smcTrailColor, text_size=size.tiny)

        table.cell(infoTbl, 0, 16, "Zone", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 16, smcZone, text_color=smcZoneColor, text_size=size.tiny)
        table.cell(infoTbl, 2, 16, smcBullish ? "SMC+" : smcBearish ? "SMC-" : "", text_color=smcBullish ? color.lime : smcBearish ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 16, "", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 16, "", text_color=color.gray, text_size=size.tiny)

        // ì‹œê·¸ë„
        string sigText = superLong ? "SUPER [" + finalGrade + "]" : strongLong ? "STRONG [" + currentGrade + "]" : normalLong ? "LONG [" + currentGrade + "]" : exitLongSignal ? "EXIT!" : "WAIT"
        color sigColor = superLong ? color.aqua : strongLong ? color.yellow : normalLong ? color.green : exitLongSignal ? color.red : color.gray
        color sigBg = superLong ? color.new(color.aqua, 70) : exitLongSignal ? color.new(color.red, 70) : color.new(color.gray, 50)
        table.cell(infoTbl, 0, 17, "Signal", text_color=color.white, bgcolor=color.gray, text_size=size.small)
        table.cell(infoTbl, 1, 17, sigText, text_color=sigColor, bgcolor=sigBg, text_size=size.small)
        table.cell(infoTbl, 2, 17, superLong ? "SMC+" : exitLongSignal ? "SELL" : "", text_color=superLong ? color.aqua : color.red, bgcolor=sigBg, text_size=size.tiny)
        table.cell(infoTbl, 3, 17, superLong ? "ALL" : "", text_color=color.aqua, bgcolor=sigBg, text_size=size.tiny)
        table.cell(infoTbl, 4, 17, superLong ? "GO!!" : strongLong ? "GO!" : exitLongSignal ? "OUT!" : "", text_color=superLong ? color.aqua : strongLong ? color.yellow : color.red, bgcolor=sigBg, text_size=size.small)

        // êµ¬ë¶„ì„ 
        table.cell(infoTbl, 0, 18, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 1, 18, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 18, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 18, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 18, "---", text_color=color.gray, text_size=size.tiny)

        // ëª¨ë“œ ì„¤ì • í‘œì‹œ
        string tradeModeShort = tradeMode == "ì„ ë¬¼" ? "ì„ ë¬¼" : tradeMode == "í˜„ë¬¼" ? "í˜„ë¬¼" : "ì£¼ì‹"
        color tradeModeColor = tradeMode == "ì„ ë¬¼" ? color.orange : tradeMode == "í˜„ë¬¼" ? color.teal : color.purple
        string displayModeShort = displayMode == "ì „ì²´" ? "ì „ì²´" : displayMode == "ìµœì†Œí™”" ? "ìµœì†Œ" : "í…Œì´ë¸”"
        string signalModeShort = signalMode == "ì „ì²´" ? "ì „ì²´" : signalMode == "STRONG ì´ìƒ" ? "STR+" : "SUPER"

        table.cell(infoTbl, 0, 19, "MODE", text_color=color.white, bgcolor=color.navy, text_size=size.tiny)
        table.cell(infoTbl, 1, 19, tradeModeShort, text_color=tradeModeColor, text_size=size.tiny)
        table.cell(infoTbl, 2, 19, displayModeShort, text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 19, signalModeShort, text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 19, smartTrailUp ? "LONG" : "SHORT", text_color=smartTrailUp ? color.lime : color.red, text_size=size.tiny)

        // í˜„ì¬ ìƒíƒœ ìš”ì•½
        string statusText = exitLongSignal ? "EXIT NOW" : trailFlipToShort ? "WARNING" : smartTrailUp ? "HOLDING" : "WAIT"
        color statusColor = exitLongSignal ? color.red : trailFlipToShort ? color.orange : smartTrailUp ? color.lime : color.gray
        color statusBg = exitLongSignal ? color.new(color.red, 60) : trailFlipToShort ? color.new(color.orange, 70) : color.new(color.gray, 80)
        table.cell(infoTbl, 0, 20, "STATUS", text_color=color.white, bgcolor=color.navy, text_size=size.tiny)
        table.cell(infoTbl, 1, 20, statusText, text_color=statusColor, bgcolor=statusBg, text_size=size.small)
        table.cell(infoTbl, 2, 20, str.tostring(longScore, "#") + "pt", text_color=longScore >= 16 ? color.green : color.gray, bgcolor=statusBg, text_size=size.tiny)
        table.cell(infoTbl, 3, 20, currentGrade, text_color=longScore >= 19 ? color.lime : longScore >= 16 ? color.green : color.gray, bgcolor=statusBg, text_size=size.tiny)
        table.cell(infoTbl, 4, 20, "", text_color=color.gray, bgcolor=statusBg, text_size=size.tiny)

// ============================================
// ë¯¸ë‹ˆ íŒ¨ë„ (ìµœì†Œí™” ëª¨ë“œìš©)
// ============================================

if showMiniPanel and isMinimalMode and barstate.islast
    var table miniTbl = table.new(position.top_right, 4, 8, bgcolor=color.new(color.black, 20), border_width=1)

    // ëª¨ë“œ í‘œì‹œ
    string modeText = tradeMode == "ì„ ë¬¼" ? "F" : tradeMode == "í˜„ë¬¼" ? "S" : "K"
    color modeBgColor = tradeMode == "ì„ ë¬¼" ? color.orange : tradeMode == "í˜„ë¬¼" ? color.teal : color.purple

    // ì‹œê·¸ë„ ìƒíƒœ
    string sigText = superLong ? "SUPER" : strongLong ? "STRONG" : normalLong ? "LONG" : exitLongSignal ? "EXIT!" : "WAIT"
    color sigColor = superLong ? color.aqua : strongLong ? color.yellow : normalLong ? color.green : exitLongSignal ? color.red : color.gray
    color sigBg = superLong ? color.new(color.aqua, 50) : exitLongSignal ? color.new(color.red, 50) : color.new(color.gray, 70)

    // í˜„ì¬ ìƒíƒœ
    string statusText = exitLongSignal ? "EXIT NOW" : trailFlipToShort ? "WARNING" : smartTrailUp ? "HOLD" : "WAIT"
    color statusColor = exitLongSignal ? color.red : trailFlipToShort ? color.orange : smartTrailUp ? color.lime : color.gray

    // LONG/SHORT ìœ ë¦¬ íŒë‹¨
    bool longFavorable = smartTrailUp and tf1h_uptrend and longScore >= 15
    bool shortFavorable = not smartTrailUp and not tf1h_uptrend and pricePosition > 70
    string biasIcon = longFavorable ? "â–² LONG" : shortFavorable ? "â–¼ SHORT" : "â€” WAIT"
    color biasColor = longFavorable ? color.lime : shortFavorable ? color.red : color.gray
    color biasBg = longFavorable ? color.new(color.green, 30) : shortFavorable ? color.new(color.red, 30) : color.new(color.gray, 70)

    // ì¡°ê±´ íŒíŠ¸ (ì™œ LONG/SHORT/WAITì¸ì§€)
    string condHint = ""
    if longFavorable
        condHint := "Trailâ†‘ 1Hâ†‘ " + str.tostring(longScore, "#") + "pt"
    else if shortFavorable
        condHint := "Trailâ†“ 1Hâ†“ " + str.tostring(pricePosition, "#") + "%"
    else
        // WAIT ìƒíƒœì¼ ë•Œ ë¶€ì¡±í•œ ì¡°ê±´ í‘œì‹œ
        string missing = ""
        if not smartTrailUp
            missing := "Trailâ†“"
        else if not tf1h_uptrend
            missing := "1Hâ†“"
        else if longScore < 15
            missing := str.tostring(longScore, "#") + "pt<15"
        condHint := missing

    // Row 0: ë°©í–¥ í‘œì‹œ (ê°€ì¥ ëˆˆì— ë„ê²Œ)
    table.cell(miniTbl, 0, 0, biasIcon, text_color=biasColor, bgcolor=biasBg, text_size=size.huge)
    table.cell(miniTbl, 1, 0, condHint, text_color=biasColor, bgcolor=biasBg, text_size=size.small)
    table.cell(miniTbl, 2, 0, str.tostring(longScore, "#") + "pt", text_color=longScore >= 16 ? color.lime : color.white, bgcolor=biasBg, text_size=size.large)
    table.cell(miniTbl, 3, 0, currentGrade, text_color=longScore >= 19 ? color.yellow : color.white, bgcolor=biasBg, text_size=size.large)

    // EMA ê°ë„ ìƒíƒœ
    string emaAngleStatus = emaStrongUp ? "â–²â–²" : emaWeakUp ? "â–²" : emaSideways ? "â€”" : "â–¼"
    color emaAngleStatusColor = emaStrongUp ? color.lime : emaWeakUp ? color.yellow : emaSideways ? color.orange : color.red

    // Row 1: í—¤ë”
    table.cell(miniTbl, 0, 1, "V39", text_color=color.white, bgcolor=color.blue, text_size=size.normal)
    table.cell(miniTbl, 1, 1, emaAngleStatus, text_color=emaAngleStatusColor, bgcolor=color.new(color.gray, 50), text_size=size.normal)
    table.cell(miniTbl, 2, 1, timeframe.period, text_color=color.white, bgcolor=color.gray, text_size=size.normal)
    table.cell(miniTbl, 3, 1, smartTrailUp ? "L" : "S", text_color=smartTrailUp ? color.lime : color.red, bgcolor=color.new(color.gray, 50), text_size=size.normal)

    // Row 2: ì‹œê·¸ë„
    table.cell(miniTbl, 0, 2, "Signal", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 2, sigText, text_color=sigColor, bgcolor=sigBg, text_size=size.large)
    table.cell(miniTbl, 2, 2, currentGrade, text_color=sigColor, bgcolor=sigBg, text_size=size.large)
    table.cell(miniTbl, 3, 2, str.tostring(longScore, "#") + "pt", text_color=longScore >= 16 ? color.green : color.gray, bgcolor=sigBg, text_size=size.small)

    // Row 3: ì¶”ì„¸
    table.cell(miniTbl, 0, 3, "ì¶”ì„¸", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 3, str.tostring(uptrendCount) + "/4", text_color=uptrendCount >= 3 ? color.green : color.gray, text_size=size.small)
    table.cell(miniTbl, 2, 3, tf1h_uptrend ? "1H:UP" : "1H:DN", text_color=tf1h_uptrend ? color.green : color.red, text_size=size.small)
    table.cell(miniTbl, 3, 3, tf4h_uptrend ? "4H:UP" : "4H:DN", text_color=tf4h_uptrend ? color.green : color.red, text_size=size.small)

    // Row 4: ìœ„ì¹˜/ê±°ë˜ëŸ‰
    table.cell(miniTbl, 0, 4, "ìœ„ì¹˜", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 4, str.tostring(pricePosition, "#") + "%", text_color=nearSupport3d ? color.green : nearResistance3d ? color.red : color.gray, text_size=size.small)
    table.cell(miniTbl, 2, 4, "Vol", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 3, 4, str.tostring(volRatio, "#.#") + "x", text_color=volSpike ? color.green : color.gray, text_size=size.small)

    // Row 5: ìƒíƒœ
    color statusBg = exitLongSignal ? color.new(color.red, 50) : trailFlipToShort ? color.new(color.orange, 60) : color.new(color.gray, 70)
    table.cell(miniTbl, 0, 5, "STATUS", text_color=color.white, bgcolor=color.navy, text_size=size.small)
    table.cell(miniTbl, 1, 5, statusText, text_color=statusColor, bgcolor=statusBg, text_size=size.large)
    table.cell(miniTbl, 2, 5, inDiscount ? "DISC" : inPremium ? "PREM" : "MID", text_color=inDiscount ? color.green : inPremium ? color.red : color.gray, bgcolor=statusBg, text_size=size.small)
    table.cell(miniTbl, 3, 5, superLong ? "GO!!" : strongLong ? "GO!" : exitLongSignal ? "OUT!" : "", text_color=superLong ? color.aqua : strongLong ? color.yellow : color.red, bgcolor=statusBg, text_size=size.normal)

    // Row 6: ê³ ë˜ ì •ë³´
    string whaleStatus = whaleBuy ? "ğŸ‹BUY" : whaleSell ? "ğŸ‹SELL" : "-"
    color whaleBg = whaleBuy ? color.new(color.blue, 50) : whaleSell ? color.new(color.purple, 50) : color.new(color.gray, 70)
    color whaleColor = whaleBuy ? color.aqua : whaleSell ? color.fuchsia : color.gray
    table.cell(miniTbl, 0, 6, "WHALE", text_color=color.white, bgcolor=color.new(color.purple, 30), text_size=size.small)
    table.cell(miniTbl, 1, 6, whaleStatus, text_color=whaleColor, bgcolor=whaleBg, text_size=size.normal)
    table.cell(miniTbl, 2, 6, isWhaleVolume ? str.tostring(volRatio, "#.#") + "x" : "-", text_color=isWhaleVolume ? color.yellow : color.gray, bgcolor=whaleBg, text_size=size.small)
    table.cell(miniTbl, 3, 6, whaleBuy or whaleSell ? whaleStrength : "", text_color=color.yellow, bgcolor=whaleBg, text_size=size.small)

    // Row 7: ì‹¬ë¦¬ì  êµ¬ê°„
    color psychBg = extremeFear ? color.new(color.green, 40) : extremeGreed ? color.new(color.red, 40) : psychBuyZone ? color.new(color.teal, 50) : psychSellZone ? color.new(color.maroon, 50) : color.new(color.gray, 70)
    color psychColor = extremeFear or psychBuyZone ? color.lime : extremeGreed or psychSellZone ? color.red : color.gray
    string fgScoreText = str.tostring(fearGreedScore, "#")
    table.cell(miniTbl, 0, 7, "ì‹¬ë¦¬", text_color=color.white, bgcolor=color.new(color.navy, 30), text_size=size.small)
    table.cell(miniTbl, 1, 7, fearGreedEmoji + fearGreedGrade, text_color=psychColor, bgcolor=psychBg, text_size=size.small)
    table.cell(miniTbl, 2, 7, fgScoreText, text_color=psychColor, bgcolor=psychBg, text_size=size.small)
    table.cell(miniTbl, 3, 7, nearRoundBelow ? "ğŸ“SUP" : nearRoundAbove ? "ğŸ“RES" : "", text_color=color.aqua, bgcolor=psychBg, text_size=size.small)

// ============================================
// ì•Œë¦¼ (ì°¸ê³ ìš© - íˆ¬ìê¶Œìœ  ì•„ë‹˜)
// ============================================

// ê±°ë˜ëŸ‰ ë°°ìˆ˜ í…ìŠ¤íŠ¸ (5ë¶„ë´‰ ì œê±°)
string volDetail15m = "15m:" + str.tostring(tf15m_volRatio, "#.#") + "x"
string volDetail1h = "1H:" + str.tostring(tf1h_volRatio, "#.#") + "x"
string volDetail4h = "4H:" + str.tostring(tf4h_volRatio, "#.#") + "x"
string volDetails = volDetail15m + " " + volDetail1h + " " + volDetail4h

// ë©´ì±… ë¬¸êµ¬
string disclaimer = "[ì°¸ê³ ìš©-íˆ¬ìê¶Œìœ ì•„ë‹˜]"

if superLong
    string m1 = "ğŸš€ğŸš€ğŸš€ SUPER LONG ğŸš€ğŸš€ğŸš€"
    string m2 = "[" + finalGrade + "] " + str.tostring(longScore, "#") + "pt"
    string m3 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string m4 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string m5 = "ğŸ“ˆ ì¶”ì„¸: " + trendStrength + " | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string m6 = "ğŸ“Š TF:" + str.tostring(uptrendCount) + "/4 | Vol:" + str.tostring(volSpikeCount) + "/4"
    string m7 = "ğŸ“‰ ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ìˆ˜ì••ë ¥: " + str.tostring(buyPressure, "#") + "%"
    string m8 = disclaimer
    string msg = m1 + "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5 + "\n" + m6 + "\n" + m7 + "\n" + m8
    alert(msg, freq=alert.freq_once_per_bar_close)

if strongLong and not superLong
    string m1 = "â­â­ STRONG LONG â­â­"
    string m2 = "[" + currentGrade + "] " + str.tostring(longScore, "#") + "pt"
    string m3 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string m4 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string m5 = "ğŸ“ˆ ì¶”ì„¸: " + trendStrength + " | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string m6 = "ğŸ“Š TF:" + str.tostring(uptrendCount) + "/4 | EMA:" + str.tostring(emaAlignedUpCount) + "/5"
    string m7 = "ğŸ“‰ ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ìˆ˜ì••ë ¥: " + str.tostring(buyPressure, "#") + "%"
    string m8 = disclaimer
    string msg = m1 + "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5 + "\n" + m6 + "\n" + m7 + "\n" + m8
    alert(msg, freq=alert.freq_once_per_bar_close)

if normalLong and signalMode == "ì „ì²´"
    string m1 = "ğŸ“— LONG [" + currentGrade + "] " + str.tostring(longScore, "#") + "pt"
    string m2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string m3 = "ğŸ“ˆ ì¶”ì„¸:" + trendStrength + " | TF:" + str.tostring(uptrendCount) + "/4"
    string m4 = "ğŸ“‰ ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ìˆ˜ì••ë ¥: " + str.tostring(buyPressure, "#") + "%"
    string m5 = disclaimer
    alert(m1 + "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5, freq=alert.freq_once_per_bar_close)

// ============================================
// ì²­ì‚° ì•Œë¦¼
// ============================================

if exitLongSignal
    string e1 = "âŒâŒ EXIT LONG âŒâŒ"
    string e2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string e3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string e4 = "âš ï¸ Smart Trailì´ SHORTë¡œ ì „í™˜ë¨"
    string e5 = "ğŸ“Š ì ìˆ˜: " + str.tostring(longScore, "#") + "pt | 1Hì¶”ì„¸: " + (tf1h_uptrend ? "UP" : "DOWN")
    string e6 = disclaimer
    alert(e1 + "\n" + e2 + "\n" + e3 + "\n" + e4 + "\n" + e5 + "\n" + e6, freq=alert.freq_once_per_bar_close)

if trailFlipToShort and not exitLongSignal
    string w1 = "âš ï¸ Trail Warning âš ï¸"
    string w2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string w3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string w4 = "ğŸ“‰ Smart Trail SHORT ì „í™˜ - ëª¨ë‹ˆí„°ë§ í•„ìš”"
    string w5 = "ğŸ“Š ì ìˆ˜: " + str.tostring(longScore, "#") + "pt | " + disclaimer
    alert(w1 + "\n" + w2 + "\n" + w3 + "\n" + w4 + "\n" + w5, freq=alert.freq_once_per_bar_close)

// ============================================
// SHORT ì•Œë¦¼ (ì„ ë¬¼ ëª¨ë“œì—ì„œë§Œ)
// ============================================

if superShort
    string s1 = "ğŸ’€ğŸ’€ğŸ’€ SUPER SHORT ğŸ’€ğŸ’€ğŸ’€"
    string s2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string s3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string s4 = "ğŸ“‰ í•˜ë½TF:" + str.tostring(downtrendCount) + "/4 | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string s5 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ë„ì••ë ¥: " + str.tostring(100 - buyPressure, "#") + "%"
    string s6 = disclaimer
    alert(s1 + "\n" + s2 + "\n" + s3 + "\n" + s4 + "\n" + s5 + "\n" + s6, freq=alert.freq_once_per_bar_close)

if strongShort and not superShort
    string s1 = "âš ï¸âš ï¸ STRONG SHORT âš ï¸âš ï¸"
    string s2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string s3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string s4 = "ğŸ“‰ í•˜ë½TF:" + str.tostring(downtrendCount) + "/4 | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string s5 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ë„ì••ë ¥: " + str.tostring(100 - buyPressure, "#") + "%"
    string s6 = disclaimer
    alert(s1 + "\n" + s2 + "\n" + s3 + "\n" + s4 + "\n" + s5 + "\n" + s6, freq=alert.freq_once_per_bar_close)

if normalShort and signalMode == "ì „ì²´"
    string s1 = "ğŸ“• SHORT"
    string s2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string s3 = "ğŸ“‰ í•˜ë½TF:" + str.tostring(downtrendCount) + "/4 | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string s4 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | " + disclaimer
    alert(s1 + "\n" + s2 + "\n" + s3 + "\n" + s4, freq=alert.freq_once_per_bar_close)

if exitShortSignal
    string e1 = "âŒâŒ EXIT SHORT âŒâŒ"
    string e2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string e3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string e4 = "âœ… Smart Trailì´ LONGìœ¼ë¡œ ì „í™˜ë¨"
    string e5 = disclaimer
    alert(e1 + "\n" + e2 + "\n" + e3 + "\n" + e4 + "\n" + e5, freq=alert.freq_once_per_bar_close)

// ============================================
// ê³ ë˜ ì•Œë¦¼
// ============================================

if showWhale and whaleBuy
    string w1 = whaleStrength + " ë§¤ìˆ˜ ê°ì§€!"
    string w2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string w3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string w4 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x (" + whaleKorean + " ë“±ê¸‰)"
    string w5 = "ğŸ“ˆ ê°€ê²©ë³€ë™: +" + str.tostring(priceChangePercent, "#.##") + "%"
    string w6 = "ğŸ’ª ë§¤ìˆ˜ì••ë ¥: " + str.tostring(buyPressure, "#") + "% | " + disclaimer
    alert(w1 + "\n" + w2 + "\n" + w3 + "\n" + w4 + "\n" + w5 + "\n" + w6, freq=alert.freq_once_per_bar_close)

if showWhale and whaleSell
    string w1 = whaleStrength + " ë§¤ë„ ê°ì§€!"
    string w2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string w3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string w4 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x (" + whaleKorean + " ë“±ê¸‰)"
    string w5 = "ğŸ“‰ ê°€ê²©ë³€ë™: -" + str.tostring(priceChangePercent, "#.##") + "%"
    string w6 = "ğŸ“‰ ë§¤ë„ì••ë ¥: " + str.tostring(100 - buyPressure, "#") + "% | " + disclaimer
    alert(w1 + "\n" + w2 + "\n" + w3 + "\n" + w4 + "\n" + w5 + "\n" + w6, freq=alert.freq_once_per_bar_close)


