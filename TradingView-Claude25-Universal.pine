//@version=5
indicator("í´ë¡œë“œ25 ìœ ë‹ˆë²„ì…œ (ì„ ë¬¼/í˜„ë¬¼/ì£¼ì‹)", overlay=true, max_labels_count=100)

// ============================================
// ğŸ¯ ê±°ë˜ ëª¨ë“œ ì„ íƒ
// ============================================
tradeMode = input.string("ì„ ë¬¼", title="ğŸ“Š ê±°ë˜ ëª¨ë“œ", options=["ì„ ë¬¼", "í˜„ë¬¼ì½”ì¸", "ì£¼ì‹"],
    tooltip="ì„ ë¬¼: LONG+SHORT, í˜„ë¬¼ì½”ì¸: LONGë§Œ, ì£¼ì‹: LONGë§Œ")

// ============================================
// ğŸ”§ ëª¨ë“œë³„ ìë™ TP/SL ì„¤ì •
// ============================================

// ëª¨ë“œë³„ ê¸°ë³¸ê°’ ê³„ì‚°
float defaultTP1 = tradeMode == "ì„ ë¬¼" ? 0.8 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.5 : 2.0
float defaultTP2 = tradeMode == "ì„ ë¬¼" ? 1.5 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 3.0 : 4.0
float defaultSL = tradeMode == "ì„ ë¬¼" ? 0.3 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.0 : 1.5

// ìˆ˜ë™ ì˜¤ë²„ë¼ì´ë“œ ì˜µì…˜
useAutoTPSL = input.bool(true, title="ìë™ TP/SL ì‚¬ìš©", tooltip="ì²´í¬ í•´ì œì‹œ ìˆ˜ë™ ì„¤ì • ì‚¬ìš©")
manualTP1 = input.float(0.8, title="ìˆ˜ë™ TP1 (%)", minval=0.1, maxval=10.0, step=0.1)
manualTP2 = input.float(1.5, title="ìˆ˜ë™ TP2 (%)", minval=0.1, maxval=20.0, step=0.1)
manualSL = input.float(0.3, title="ìˆ˜ë™ SL (%)", minval=0.05, maxval=5.0, step=0.05)

// ê¸°ë³¸ TP/SL ê°’ (ë ˆë²„ë¦¬ì§€ ì—°ë™ ì „)
float baseTpPct1 = useAutoTPSL ? defaultTP1 : manualTP1
float baseTpPct2 = useAutoTPSL ? defaultTP2 : manualTP2
float baseSlPct = useAutoTPSL ? defaultSL : manualSL

// ============================================
// ë ˆë²„ë¦¬ì§€ ë° í¬ì§€ì…˜ ì„¤ì •
// ============================================
leverageInput = input.int(50, title="ë ˆë²„ë¦¬ì§€ (ì„ ë¬¼ë§Œ)", minval=1, maxval=125)
riskPercentInput = input.float(20.0, title="íˆ¬ì… ë¹„ìœ¨ (%)", minval=1.0, maxval=100.0)

// ============================================
// ğŸ¯ ë ˆë²„ë¦¬ì§€ ê¸°ë°˜ TP/SL ìë™ ê³„ì‚°
// ìˆ˜ìˆ˜ë£Œ ê³ ë ¤: Bitget 0.06% x 2 = 0.12% + ì—¬ìœ ë¶„
// ëª©í‘œ ì‹¤ì œ ìˆ˜ìµë¥ : TP1=10%, TP2=20%, SL=-5%
// ============================================
// ê¸°ì¤€ ë ˆë²„ë¦¬ì§€ 10x ëŒ€ë¹„ ë¹„ìœ¨ë¡œ ì¡°ì •
float leverageRatio = 10.0 / leverageInput

// ë ˆë²„ë¦¬ì§€ ì—°ë™ TP/SL (ì„ ë¬¼ë§Œ ì ìš©)
// ê³ ë°°ìœ¨ì¼ìˆ˜ë¡ ê°€ê²© ë³€ë™í­ ì‘ê²Œ, ì €ë°°ìœ¨ì¼ìˆ˜ë¡ í¬ê²Œ
float leverageTP1 = tradeMode == "ì„ ë¬¼" ? math.max(0.15, 1.0 * leverageRatio) : baseTpPct1
float leverageTP2 = tradeMode == "ì„ ë¬¼" ? math.max(0.30, 2.0 * leverageRatio) : baseTpPct2
float leverageSL = tradeMode == "ì„ ë¬¼" ? math.max(0.08, 0.5 * leverageRatio) : baseSlPct

// ë ˆë²„ë¦¬ì§€ ì—°ë™ ì‚¬ìš© ì—¬ë¶€
useLeverageTPSL = input.bool(true, title="ğŸ“Š ë ˆë²„ë¦¬ì§€ ì—°ë™ TP/SL", tooltip="ON: ë ˆë²„ë¦¬ì§€ì— ë”°ë¼ TP/SL ìë™ ì¡°ì •, OFF: ê³ ì • TP/SL ì‚¬ìš©")

// â˜… ìµœì¢… TP/SL ê°’ (ë ˆë²„ë¦¬ì§€ ì—°ë™ ì ìš©) â˜…
float tpPct1 = useLeverageTPSL ? leverageTP1 : baseTpPct1
float tpPct2 = useLeverageTPSL ? leverageTP2 : baseTpPct2
float slPct = useLeverageTPSL ? leverageSL : baseSlPct

// ì‹ í˜¸ ê°•ë„ ì„¤ì •
minSignalStrength = input.int(10, title="ìµœì†Œ ì‹ í˜¸ ê°•ë„", minval=8, maxval=20)
strictMode = input.bool(true, title="ì—„ê²© ëª¨ë“œ")
useMultiTF = input.bool(true, title="ë©€í‹°íƒ€ì„í”„ë ˆì„ í•„í„°")
useADXFilter = input.bool(false, title="ADX í•„í„° ì‚¬ìš©", tooltip="ON: íš¡ë³´ì¥ í•„í„°ë§ (ì—„ê²©), OFF: ADXëŠ” ë³´ë„ˆìŠ¤ ì ìˆ˜ë§Œ")

// ============================================
// ğŸ‘¶ ì´ˆë³´ì ëª¨ë“œ ì„¤ì •
// ============================================
beginnerMode = input.bool(true, title="ğŸ‘¶ ì´ˆë³´ì ëª¨ë“œ", tooltip="ON: ì‰¬ìš´ ì„¤ëª… íŒ¨ë„ í‘œì‹œ, OFF: ì „ë¬¸ê°€ìš© ìƒì„¸ ì •ë³´ë§Œ")
showDetailTable = input.bool(true, title="ğŸ“Š ìƒì„¸ í…Œì´ë¸” í‘œì‹œ", tooltip="ìš°ì¸¡ ìƒì„¸ ì •ë³´ í…Œì´ë¸” í‘œì‹œ ì—¬ë¶€")

// ============================================
// ğŸ“ í…Œì´ë¸” ìœ„ì¹˜ ì„¤ì •
// ============================================
beginnerTablePos = input.string("ì¢Œì¸¡ ìƒë‹¨", title="ğŸ‘¶ ì´ˆë³´ì íŒ¨ë„ ìœ„ì¹˜", options=["ì¢Œì¸¡ ìƒë‹¨", "ì¢Œì¸¡ í•˜ë‹¨", "ìš°ì¸¡ ìƒë‹¨", "ìš°ì¸¡ í•˜ë‹¨", "ì¤‘ì•™ ìƒë‹¨", "ì¤‘ì•™ í•˜ë‹¨"])
detailTablePos = input.string("ìš°ì¸¡ ìƒë‹¨", title="ğŸ“Š ìƒì„¸ í…Œì´ë¸” ìœ„ì¹˜", options=["ì¢Œì¸¡ ìƒë‹¨", "ì¢Œì¸¡ í•˜ë‹¨", "ìš°ì¸¡ ìƒë‹¨", "ìš°ì¸¡ í•˜ë‹¨", "ì¤‘ì•™ ìƒë‹¨", "ì¤‘ì•™ í•˜ë‹¨"])

// ìœ„ì¹˜ ë³€í™˜ í•¨ìˆ˜
getTablePosition(posStr) =>
    switch posStr
        "ì¢Œì¸¡ ìƒë‹¨" => position.top_left
        "ì¢Œì¸¡ í•˜ë‹¨" => position.bottom_left
        "ìš°ì¸¡ ìƒë‹¨" => position.top_right
        "ìš°ì¸¡ í•˜ë‹¨" => position.bottom_right
        "ì¤‘ì•™ ìƒë‹¨" => position.top_center
        "ì¤‘ì•™ í•˜ë‹¨" => position.bottom_center
        => position.top_right

// ============================================
// ğŸ‹ ê³ ë˜ ê°ì§€ ì„¤ì •
// ============================================
whaleMultiplier = input.float(2.0, title="ê³ ë˜ ê°ì§€ ë°°ìˆ˜", minval=1.5, maxval=5.0, step=0.5)
institutionMultiplier = input.float(3.0, title="ê¸°ê´€ ê°ì§€ ë°°ìˆ˜", minval=2.0, maxval=10.0, step=0.5)
volumeLength = input.int(20, title="ê±°ë˜ëŸ‰ í‰ê·  ê¸°ê°„", minval=10, maxval=50)

// ê±°ë˜ëŸ‰ ë¶„ì„
avgVolume = ta.sma(volume, volumeLength)
volumeRatio = volume / avgVolume

// ê³ ë˜/ê¸°ê´€ ê°ì§€
isWhale = volumeRatio >= whaleMultiplier
isInstitution = volumeRatio >= institutionMultiplier

// Volume Delta (ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥)
bullVolume = close > open ? volume : volume * (close - low) / (high - low)
bearVolume = close < open ? volume : volume * (high - close) / (high - low)
buyPressure = bullVolume / (bullVolume + bearVolume) * 100
sellPressure = 100 - buyPressure

// ê³ ë˜ ë°©í–¥ íŒë³„
whaleBuying = isWhale and close > open and buyPressure > 60
whaleSelling = isWhale and close < open and sellPressure > 60
institutionBuying = isInstitution and close > open and buyPressure > 60
institutionSelling = isInstitution and close < open and sellPressure > 60

// ëˆ„ì /ë¶„ì‚° ê°ì§€
priceUp = close > close[1]
priceDown = close < close[1]
volumeUp = volume > volume[1]
isAccumulation = priceUp and volumeUp
isDistribution = priceDown and volumeUp

// ============================================
// ì´ë™í‰ê· ì„  ë° VWAP
// ============================================
vwap100 = ta.vwma(close, 100)
ma7 = ta.sma(close, 7)
ma15 = ta.sma(close, 15)
ma50 = ta.sma(close, 50)
ma100 = ta.sma(close, 100)
ma200 = ta.sma(close, 200)

// POC ê·¼ì‚¬ê°’
var float pocPrice = close
var float maxVolume = 0.0
for i = 0 to 99
    if volume[i] > maxVolume
        maxVolume := volume[i]
        pocPrice := close[i]

// ============================================
// Stochastic RSI
// ============================================
rsiLength = input.int(14, title="RSI ê¸¸ì´", minval=5, maxval=25)
stochLength = input.int(14, title="Stoch ê¸¸ì´", minval=5, maxval=25)
smoothK = input.int(3, title="Stoch K ìŠ¤ë¬´ë”©", minval=1, maxval=10)
smoothD = input.int(3, title="Stoch D ìŠ¤ë¬´ë”©", minval=1, maxval=10)

rsi = ta.rsi(close, rsiLength)
stochRsi = ta.stoch(rsi, rsi, rsi, stochLength)
stochK = ta.sma(stochRsi, smoothK)
stochD = ta.sma(stochK, smoothD)

stochOversold = stochK < 20
stochOverbought = stochK > 80
stochGoldenCross = ta.crossover(stochK, stochD)
stochDeadCross = ta.crossunder(stochK, stochD)

// ============================================
// ADX (ì¶”ì„¸ ê°•ë„) - íš¡ë³´ì¥ í•„í„°
// ============================================
adxLength = input.int(14, title="ADX ê¸¸ì´", minval=7, maxval=30)
adxThreshold = input.float(18.0, title="ADX ì„ê³„ê°’ (ì¶”ì„¸ ê°•ë„)", minval=12.0, maxval=35.0, step=1.0,
    tooltip="18 ì´ìƒ: ì¶”ì„¸ ìˆìŒ, 25 ì´ìƒ: ê°•í•œ ì¶”ì„¸, 18 ë¯¸ë§Œ: íš¡ë³´ì¥")

[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)

// ì¶”ì„¸ ê°•ë„ íŒë‹¨
noTrend = adx < adxThreshold           // íš¡ë³´ì¥ (ì§„ì… ê¸ˆì§€)
trendExists = adx >= adxThreshold      // ì¶”ì„¸ ìˆìŒ (ì§„ì… ê°€ëŠ¥)
strongTrend = adx >= 25                // ê°•í•œ ì¶”ì„¸
veryStrongTrend = adx >= 35            // ë§¤ìš° ê°•í•œ ì¶”ì„¸

// DI ë°©í–¥ (ì¶”ì„¸ ë°©í–¥ í™•ì¸)
bullishDI = diPlus > diMinus           // ìƒìŠ¹ ì¶”ì„¸
bearishDI = diMinus > diPlus           // í•˜ë½ ì¶”ì„¸

// ============================================
// ğŸ“ˆ Open Interest & Funding Rate
// ============================================
useOIFilter = input.bool(false, title="OI í•„í„° ì‚¬ìš©", tooltip="Open Interest ì¦ê°€ ì‹œì—ë§Œ ì§„ì… (TradingView í”„ë¦¬ë¯¸ì—„ í•„ìš”)")
oiChangeThreshold = input.float(1.0, title="OI ë³€í™”ìœ¨ ì„ê³„ê°’ (%)", minval=0.5, maxval=5.0, step=0.5)

// OI/í€ë”©ë¹„ - ê±°ë˜ëŸ‰ ê¸°ë°˜ ëŒ€ì²´ ê³„ì‚° (ì‹¬ë³¼ ì˜¤ë¥˜ ë°©ì§€)
// ì‹¤ì œ OI ë°ì´í„°ëŠ” Coinglass ì›¹ì‚¬ì´íŠ¸ ì°¸ê³  ê¶Œì¥
float oi = volume
float oiPrev = volume[1]
float oiChange = oiPrev > 0 ? ((oi - oiPrev) / oiPrev) * 100 : 0

// í€ë”©ë¹„ ëŒ€ì²´ - ê°€ê²© ëª¨ë©˜í…€ ê¸°ë°˜ ì¶”ì •
float priceChange = (close - close[8]) / close[8] * 100
float fundingRate = priceChange > 2 ? 0.06 : priceChange < -2 ? -0.02 : 0.01

// OI ìƒíƒœ íŒë‹¨
oiIncreasing = oiChange > oiChangeThreshold      // OI ì¦ê°€ (ì‹ ê·œ í¬ì§€ì…˜ ì§„ì…)
oiDecreasing = oiChange < -oiChangeThreshold     // OI ê°ì†Œ (í¬ì§€ì…˜ ì²­ì‚°)
oiStable = math.abs(oiChange) <= oiChangeThreshold

// í€ë”©ë¹„ ìƒíƒœ íŒë‹¨
fundingBullish = fundingRate < -0.01             // ìˆ ê³¼ì—´ â†’ ìƒìŠ¹ ê°€ëŠ¥
fundingBearish = fundingRate > 0.05              // ë¡± ê³¼ì—´ â†’ í•˜ë½ ì£¼ì˜
fundingNeutral = fundingRate >= -0.01 and fundingRate <= 0.05

// OI + ê°€ê²© ì¡°í•© ë¶„ì„
oiPriceUp = oiIncreasing and close > close[1]    // OIâ†‘ + ê°€ê²©â†‘ = ê°•í•œ ìƒìŠ¹
oiPriceDown = oiIncreasing and close < close[1]  // OIâ†‘ + ê°€ê²©â†“ = ê°•í•œ í•˜ë½
oiLongSqueeze = oiDecreasing and close < close[1] // OIâ†“ + ê°€ê²©â†“ = ë¡± ì²­ì‚°
oiShortSqueeze = oiDecreasing and close > close[1] // OIâ†“ + ê°€ê²©â†‘ = ìˆ ì²­ì‚°

// ============================================
// Bollinger Bands
// ============================================
bbLength = input.int(20, title="BB ê¸¸ì´", minval=10, maxval=50)
bbMult = input.float(2.0, title="BB ë°°ìˆ˜", minval=1.0, maxval=3.0, step=0.1)

bbBasis = ta.sma(close, bbLength)
bbDev = ta.stdev(close, bbLength)
bbUpper = bbBasis + bbMult * bbDev
bbLower = bbBasis - bbMult * bbDev
bbWidth = (bbUpper - bbLower) / bbBasis * 100
bbSqueeze = bbWidth < ta.sma(bbWidth, 20) * 0.8

// BB ì‹ í˜¸
touchingBBLower = low <= bbLower
touchingBBUpper = high >= bbUpper
bbReversal_long = touchingBBLower and stochOversold
bbReversal_short = touchingBBUpper and stochOverbought

// ============================================
// ğŸ”® í”¼ë´‡ í¬ì¸íŠ¸ (ìŠ¤ìœ™ ê³ ì /ì €ì )
// ============================================
pivotLength = input.int(5, title="í”¼ë´‡ ê¸¸ì´", minval=2, maxval=20)
showPivots = input.bool(true, title="í”¼ë´‡ í¬ì¸íŠ¸ í‘œì‹œ")

// í”¼ë´‡ ê³ ì /ì €ì  ê°ì§€
pivotHigh = ta.pivothigh(high, pivotLength, pivotLength)
pivotLow = ta.pivotlow(low, pivotLength, pivotLength)

// ìµœê·¼ í”¼ë´‡ ì €ì¥
var float lastPivotHigh = na
var float lastPivotLow = na
var int lastPivotHighBar = na
var int lastPivotLowBar = na

if not na(pivotHigh)
    lastPivotHigh := pivotHigh
    lastPivotHighBar := bar_index - pivotLength
if not na(pivotLow)
    lastPivotLow := pivotLow
    lastPivotLowBar := bar_index - pivotLength

// ============================================
// ğŸ“Š ì§€ì§€/ì €í•­ ë ˆë²¨
// ============================================
showSR = input.bool(true, title="ì§€ì§€/ì €í•­ ë ˆë²¨ í‘œì‹œ")
srLength = input.int(20, title="ì§€ì§€/ì €í•­ ê³„ì‚° ê¸¸ì´", minval=10, maxval=50)

// ìµœê·¼ ê³ ì /ì €ì  ê¸°ë°˜ ì§€ì§€/ì €í•­
recentHigh = ta.highest(high, srLength)
recentLow = ta.lowest(low, srLength)
srMiddle = (recentHigh + recentLow) / 2

// ê°€ê²©ì´ ì§€ì§€/ì €í•­ ê·¼ì²˜ì¸ì§€ í™•ì¸
nearResistance = high >= recentHigh * 0.998
nearSupport = low <= recentLow * 1.002
nearMiddle = math.abs(close - srMiddle) / srMiddle < 0.005

// ============================================
// ğŸ“ˆ ë‹¤ì´ë²„ì „ìŠ¤ ê°ì§€ (RSI vs ê°€ê²©)
// ============================================
showDivergence = input.bool(true, title="ë‹¤ì´ë²„ì „ìŠ¤ í‘œì‹œ")
divLength = input.int(14, title="ë‹¤ì´ë²„ì „ìŠ¤ RSI ê¸¸ì´", minval=7, maxval=21)

divRsi = ta.rsi(close, divLength)

// ë¶ˆë¦¬ì‹œ ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²© ì €ì  í•˜ë½ + RSI ì €ì  ìƒìŠ¹
priceLow1 = ta.lowest(low, 5)
priceLow2 = ta.lowest(low[5], 5)
rsiLow1 = ta.lowest(divRsi, 5)
rsiLow2 = ta.lowest(divRsi[5], 5)
bullishDivergence = priceLow1 < priceLow2 and rsiLow1 > rsiLow2 and divRsi < 40

// ë² ì–´ë¦¬ì‹œ ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²© ê³ ì  ìƒìŠ¹ + RSI ê³ ì  í•˜ë½
priceHigh1 = ta.highest(high, 5)
priceHigh2 = ta.highest(high[5], 5)
rsiHigh1 = ta.highest(divRsi, 5)
rsiHigh2 = ta.highest(divRsi[5], 5)
bearishDivergence = priceHigh1 > priceHigh2 and rsiHigh1 < rsiHigh2 and divRsi > 60

// ============================================
// ğŸ¯ ì¤‘ìš” êµ¬ê°„ ê°ì§€
// ============================================
// ê°•í•œ ë§¤ìˆ˜ êµ¬ê°„: BBí•˜ë‹¨ + ì§€ì§€ì„  + ê³¼ë§¤ë„
strongBuyZone = touchingBBLower and nearSupport and stochOversold
// ê°•í•œ ë§¤ë„ êµ¬ê°„: BBìƒë‹¨ + ì €í•­ì„  + ê³¼ë§¤ìˆ˜
strongSellZone = touchingBBUpper and nearResistance and stochOverbought
// ë³€ê³¡ì  êµ¬ê°„: ë‹¤ì´ë²„ì „ìŠ¤ ë°œìƒ
turningZone = bullishDivergence or bearishDivergence

// ============================================
// ë¶ˆì¥ë‹¨íƒ€ì™• ì ìˆ˜ (ìµœëŒ€ 10ì )
// ============================================
var float bulJangScore = 0.0
bulJangScore := 0.0

touchingVWAP = math.abs(close - vwap100) / vwap100 < 0.01
if touchingVWAP
    bulJangScore += 3

ma50_slope = ma50 - ma50[5]
vwap_gentle = math.abs(ma50_slope) < close * 0.01
upCount = 0
for i = 0 to 4
    if close[i] > close[i + 1]
        upCount += 1
recentUptrend = upCount >= 3
turningPoint = vwap_gentle and recentUptrend

vwapGoldenCross = ta.crossover(close, vwap100)
if turningPoint
    bulJangScore += 5
if vwapGoldenCross
    bulJangScore += 2

isUptrend = ma7 > ma15 and ma15 > ma50
if isUptrend
    bulJangScore += 2

// ============================================
// ë©€í‹°íƒ€ì„í”„ë ˆì„ ë¶„ì„ (ëª¨ë“œë³„ íƒ€ì„í”„ë ˆì„)
// ============================================

// ëª¨ë“œë³„ íƒ€ì„í”„ë ˆì„ ì„¤ì •
// ì„ ë¬¼: 1ì‹œê°„, 15ë¶„, 5ë¶„ (í™•ì‹¤í•œ ê¸°íšŒ)
// í˜„ë¬¼/ì£¼ì‹: ì¼ë´‰, 4ì‹œê°„, 1ì‹œê°„ (ìŠ¤ìœ™)

string tf_high = tradeMode == "ì„ ë¬¼" ? "60" : "D"      // ìƒìœ„: ì„ ë¬¼=1ì‹œê°„, í˜„ë¬¼/ì£¼ì‹=ì¼ë´‰
string tf_mid = tradeMode == "ì„ ë¬¼" ? "15" : "240"    // ì¤‘ê°„: ì„ ë¬¼=15ë¶„, í˜„ë¬¼/ì£¼ì‹=4ì‹œê°„
string tf_low = tradeMode == "ì„ ë¬¼" ? "5" : "60"      // í•˜ìœ„: ì„ ë¬¼=5ë¶„, í˜„ë¬¼/ì£¼ì‹=1ì‹œê°„

// ìƒìœ„ íƒ€ì„í”„ë ˆì„ (ì„ ë¬¼: 15ë¶„ / í˜„ë¬¼,ì£¼ì‹: ì¼ë´‰)
ema20_high = request.security(syminfo.tickerid, tf_high, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_high = request.security(syminfo.tickerid, tf_high, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
rsi_high = request.security(syminfo.tickerid, tf_high, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

trend_high_bullish = ema20_high > ema50_high and rsi_high > 45 and rsi_high < 70
trend_high_bearish = ema20_high < ema50_high and rsi_high > 30 and rsi_high < 55

// ì¤‘ê°„ íƒ€ì„í”„ë ˆì„ (ì„ ë¬¼: 5ë¶„ / í˜„ë¬¼,ì£¼ì‹: 4ì‹œê°„)
ema20_mid = request.security(syminfo.tickerid, tf_mid, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_mid = request.security(syminfo.tickerid, tf_mid, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_mid, signalLine_mid, histogram_mid] = request.security(syminfo.tickerid, tf_mid, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)
rsi_mid = request.security(syminfo.tickerid, tf_mid, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

macd_rising_mid = macdLine_mid > macdLine_mid[1]
trend_mid_bullish = ema20_mid > ema50_mid and macd_rising_mid and rsi_mid > 40
trend_mid_bearish = ema20_mid < ema50_mid and not macd_rising_mid and rsi_mid < 60

// í•˜ìœ„ íƒ€ì„í”„ë ˆì„ (ì„ ë¬¼: 3ë¶„ / í˜„ë¬¼,ì£¼ì‹: 1ì‹œê°„)
ema20_low = request.security(syminfo.tickerid, tf_low, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_low = request.security(syminfo.tickerid, tf_low, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_low, signalLine_low, histogram_low] = request.security(syminfo.tickerid, tf_low, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

// í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­ (ê¸°ì¡´ ë³€ìˆ˜ëª… ìœ ì§€)
ema20_15m = ema20_high
ema50_15m = ema50_high
rsi_15m = rsi_high
trend_15m_bullish = trend_high_bullish
trend_15m_bearish = trend_high_bearish

ema20_5m = ema20_mid
ema50_5m = ema50_mid
macdLine_5m = macdLine_mid
signalLine_5m = signalLine_mid
histogram_5m = histogram_mid
rsi_5m = rsi_mid
macd_rising_5m = macd_rising_mid
trend_5m_bullish = trend_mid_bullish
trend_5m_bearish = trend_mid_bearish

ema20_3m = ema20_low
ema50_3m = ema50_low
macdLine_3m = macdLine_low
signalLine_3m = signalLine_low
histogram_3m = histogram_low

signal_3m_long = ta.crossover(ema20_3m, ema50_3m) and macdLine_3m > signalLine_3m
signal_3m_short = ta.crossunder(ema20_3m, ema50_3m) and macdLine_3m < signalLine_3m

// 1ë¶„ë´‰
rsi_1m = ta.rsi(close, 14)
vwma_1m = ta.vwma(close, 20)

// ============================================
// í´ë¡œë“œ ì ìˆ˜ (ìµœëŒ€ 8ì )
// ============================================
var float claude21Score = 0.0
claude21Score := 0.0

longSignal_basic = signal_3m_long and rsi_1m > 35 and rsi_1m < 65 and close > vwma_1m
shortSignal_basic = signal_3m_short and rsi_1m > 35 and rsi_1m < 65 and close < vwma_1m

if longSignal_basic
    claude21Score += 3
if shortSignal_basic
    claude21Score += 3

if trend_15m_bullish and longSignal_basic
    claude21Score += 3
if trend_15m_bearish and shortSignal_basic
    claude21Score += 3

if trend_5m_bullish and longSignal_basic
    claude21Score += 2
if trend_5m_bearish and shortSignal_basic
    claude21Score += 2

// ============================================
// í•„í„° ì ìˆ˜ (ìµœëŒ€ 6ì )
// ============================================
var float filterScore = 0.0
filterScore := 0.0

deviation = (close - vwap100) / vwap100 * 100
meanReversionOK = math.abs(deviation) < 10
if meanReversionOK
    filterScore += 2

nearPOC = math.abs(close - pocPrice) / pocPrice < 0.02
if nearPOC
    filterScore += 2

above200MA = close > ma200
if above200MA
    filterScore += 2

// ============================================
// ê³ ë˜ ë³´ë„ˆìŠ¤ ì ìˆ˜ (ìµœëŒ€ 4ì )
// ============================================
var float whaleScore = 0.0
whaleScore := 0.0

if whaleBuying
    whaleScore += 2
if institutionBuying
    whaleScore += 2
if isAccumulation
    whaleScore += 1

// SHORT ë°©í–¥ ê³ ë˜ ì ìˆ˜ (ì„ ë¬¼ì—ì„œë§Œ ì‚¬ìš©)
var float whaleScoreShort = 0.0
whaleScoreShort := 0.0
if whaleSelling
    whaleScoreShort += 2
if institutionSelling
    whaleScoreShort += 2
if isDistribution
    whaleScoreShort += 1

// ============================================
// ğŸ¯ ìµœì¢… ì‹ í˜¸ ê²°ì • (ëª¨ë“œë³„ ì²˜ë¦¬)
// ============================================

var float totalScore = 0.0
totalScore := bulJangScore + claude21Score + filterScore + whaleScore

var float totalScoreShort = 0.0
totalScoreShort := bulJangScore + claude21Score + filterScore + whaleScoreShort

// ê¸°ë³¸ LONG ì‹ í˜¸
longSignal_final = bulJangScore >= 5 and longSignal_basic and totalScore >= minSignalStrength

// ê¸°ë³¸ SHORT ì‹ í˜¸ (ì„ ë¬¼ì—ì„œë§Œ í™œì„±í™”)
shortSignal_final = false
if tradeMode == "ì„ ë¬¼"
    shortSignal_final := shortSignal_basic and not isUptrend and close < ma200 and totalScoreShort >= minSignalStrength

// ì—„ê²© ëª¨ë“œ (ì™„í™”ë¨: í•˜ë‚˜ì˜ TFë§Œ ì¼ì¹˜í•´ë„ OK, ë˜ëŠ” ì ìˆ˜ê°€ ë†’ìœ¼ë©´ í†µê³¼)
if strictMode and useMultiTF
    // ì ìˆ˜ê°€ ì¶©ë¶„íˆ ë†’ìœ¼ë©´ (14ì  ì´ìƒ) TF í•„í„° ì™„í™”
    bool tfLongOK = trend_15m_bullish or trend_5m_bullish or totalScore >= minSignalStrength + 4
    bool tfShortOK = trend_15m_bearish or trend_5m_bearish or totalScoreShort >= minSignalStrength + 4
    longSignal_final := longSignal_final and tfLongOK
    if tradeMode == "ì„ ë¬¼"
        shortSignal_final := shortSignal_final and tfShortOK

// StochRSI í•„í„°
longSignal_final := longSignal_final and (stochOversold or stochGoldenCross)
if tradeMode == "ì„ ë¬¼"
    shortSignal_final := shortSignal_final and (stochOverbought or stochDeadCross)

// BB í•„í„° (ì™„í™”ë¨ - í•˜ë‚˜ì˜ TFë§Œ ì¼ì¹˜í•´ë„ OK)
longSignal_final := longSignal_final or (bbReversal_long and totalScore >= minSignalStrength - 2 and (trend_15m_bullish or trend_5m_bullish))
if tradeMode == "ì„ ë¬¼"
    shortSignal_final := shortSignal_final or (bbReversal_short and totalScoreShort >= minSignalStrength - 2 and (trend_15m_bearish or trend_5m_bearish))

// ADX í•„í„° (íš¡ë³´ì¥ í•„í„°ë§) - ì„ íƒì  ì ìš©
if useADXFilter
    // ì—„ê²© ëª¨ë“œ: ADX + DI ë°©í–¥ ëª¨ë‘ í•„ìˆ˜
    longSignal_final := longSignal_final and trendExists and bullishDI
    if tradeMode == "ì„ ë¬¼"
        shortSignal_final := shortSignal_final and trendExists and bearishDI
// ADX OFFì¼ ë•Œ: DI ë°˜ëŒ€ ë°©í–¥ì´ë©´ ì‹ í˜¸ ì•½í™” (ì™„ì „ ì°¨ë‹¨ X)
else
    // DI ë°©í–¥ì´ ë°˜ëŒ€ë©´ ì ìˆ˜ -2ì  í˜ë„í‹° ì ìš© (ì‹ í˜¸ ì°¨ë‹¨ì€ ì•ˆí•¨)
    if not bullishDI and totalScore < minSignalStrength + 2
        longSignal_final := false
    if tradeMode == "ì„ ë¬¼" and not bearishDI and totalScoreShort < minSignalStrength + 2
        shortSignal_final := false

// OI í•„í„° (Open Interest ê¸°ë°˜) - ì„ íƒì  ì ìš©
if useOIFilter and oi > 0
    // LONG: OI ì¦ê°€ + ê°€ê²© ìƒìŠ¹ ë˜ëŠ” ìˆ ìŠ¤í€´ì¦ˆ
    longSignal_final := longSignal_final and (oiPriceUp or oiShortSqueeze or oiStable)
    // SHORT: OI ì¦ê°€ + ê°€ê²© í•˜ë½ ë˜ëŠ” ë¡± ìŠ¤í€´ì¦ˆ
    if tradeMode == "ì„ ë¬¼"
        shortSignal_final := shortSignal_final and (oiPriceDown or oiLongSqueeze or oiStable)

// í€ë”©ë¹„ ê²½ê³  í•„í„° (ê·¹ë‹¨ì  ê³¼ì—´ ì‹œ ë°˜ëŒ€ í¬ì§€ì…˜ ì£¼ì˜)
if fundingBearish  // ë¡± ê³¼ì—´ (í€ë”©ë¹„ > 0.05%)
    longSignal_final := longSignal_final and strongTrend  // ê°•í•œ ì¶”ì„¸ì—ì„œë§Œ ë¡± í—ˆìš©
if fundingBullish  // ìˆ ê³¼ì—´ (í€ë”©ë¹„ < -0.01%)
    if tradeMode == "ì„ ë¬¼"
        shortSignal_final := shortSignal_final and strongTrend  // ê°•í•œ ì¶”ì„¸ì—ì„œë§Œ ìˆ í—ˆìš©

// ============================================
// ğŸš¨ ê³ ë˜ EXIT ì‹ í˜¸ (í˜„ë¬¼/ì£¼ì‹ìš©)
// ============================================

// í˜„ë¬¼/ì£¼ì‹ì—ì„œ ê³ ë˜ ë§¤ë„ = ì²­ì‚° ê²½ê³ 
whaleExitSignal = (tradeMode == "í˜„ë¬¼ì½”ì¸" or tradeMode == "ì£¼ì‹") and (whaleSelling or institutionSelling)

// ============================================
// ì°¨íŠ¸ í‘œì‹œ
// ============================================

// ì´ë™í‰ê· ì„ 
plot(vwap100, color=color.new(color.purple, 0), linewidth=3, title="VWAP 100")
plot(ma50, color=color.new(color.orange, 0), linewidth=2, title="MA 50")
plot(ma200, color=color.new(color.blue, 0), linewidth=2, title="MA 200")

// Bollinger Bands
plot(bbUpper, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(bbLower, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")

// 15ë¶„ë´‰ EMA
plot(ema20_15m, color=color.new(color.green, 50), linewidth=1, title="EMA20 (15m)")
plot(ema50_15m, color=color.new(color.red, 50), linewidth=1, title="EMA50 (15m)")

// ì‹ í˜¸ í‘œì‹œ
plotshape(longSignal_final, style=shape.triangleup, location=location.belowbar,
         color=color.new(color.green, 0), size=size.normal, title="LONG ì‹ í˜¸")
plotshape(shortSignal_final and tradeMode == "ì„ ë¬¼", style=shape.triangledown, location=location.abovebar,
         color=color.new(color.red, 0), size=size.normal, title="SHORT ì‹ í˜¸")

// ê³ ë˜ ì‹ í˜¸
plotshape(whaleBuying, style=shape.circle, location=location.belowbar,
         color=color.new(color.lime, 0), size=size.tiny, title="ê³ ë˜ ë§¤ìˆ˜")
plotshape(whaleSelling and tradeMode == "ì„ ë¬¼", style=shape.circle, location=location.abovebar,
         color=color.new(color.fuchsia, 0), size=size.tiny, title="ê³ ë˜ ë§¤ë„ (ì„ ë¬¼)")

// ê¸°ê´€ ì‹ í˜¸
plotshape(institutionBuying, style=shape.diamond, location=location.belowbar,
         color=color.new(color.aqua, 0), size=size.tiny, title="ê¸°ê´€ ë§¤ìˆ˜")
plotshape(institutionSelling and tradeMode == "ì„ ë¬¼", style=shape.diamond, location=location.abovebar,
         color=color.new(color.purple, 0), size=size.tiny, title="ê¸°ê´€ ë§¤ë„ (ì„ ë¬¼)")

// EXIT ê²½ê³  (í˜„ë¬¼/ì£¼ì‹)
plotshape(whaleExitSignal, style=shape.xcross, location=location.abovebar,
         color=color.new(color.orange, 0), size=size.small, title="EXIT ê²½ê³ ")

// ëˆ„ì /ë¶„ì‚° ë°°ê²½
bgcolor(isAccumulation ? color.new(color.green, 90) : na, title="ëˆ„ì  êµ¬ê°„")
bgcolor(isDistribution ? color.new(color.red, 90) : na, title="ë¶„ì‚° êµ¬ê°„")

// BB ìŠ¤í€´ì¦ˆ ë°°ê²½
bgcolor(bbSqueeze ? color.new(color.yellow, 90) : na, title="BB ìŠ¤í€´ì¦ˆ")

// ============================================
// ğŸ”® í”¼ë´‡ í¬ì¸íŠ¸ í‘œì‹œ
// ============================================
plotshape(showPivots and not na(pivotHigh), style=shape.triangledown, location=location.abovebar,
         color=color.new(color.red, 20), size=size.tiny, title="í”¼ë´‡ ê³ ì ", offset=-pivotLength)
plotshape(showPivots and not na(pivotLow), style=shape.triangleup, location=location.belowbar,
         color=color.new(color.green, 20), size=size.tiny, title="í”¼ë´‡ ì €ì ", offset=-pivotLength)

// í”¼ë´‡ ë¼ë²¨
if showPivots and not na(pivotHigh)
    label.new(bar_index - pivotLength, pivotHigh, "H", style=label.style_label_down,
              color=color.new(color.red, 30), textcolor=color.white, size=size.tiny)
if showPivots and not na(pivotLow)
    label.new(bar_index - pivotLength, pivotLow, "L", style=label.style_label_up,
              color=color.new(color.green, 30), textcolor=color.white, size=size.tiny)

// ============================================
// ğŸ“Š ì§€ì§€/ì €í•­ ë ˆë²¨ í‘œì‹œ
// ============================================
plot(showSR ? recentHigh : na, color=color.new(color.red, 40), linewidth=2, style=plot.style_circles, title="ì €í•­ì„ ")
plot(showSR ? recentLow : na, color=color.new(color.green, 40), linewidth=2, style=plot.style_circles, title="ì§€ì§€ì„ ")
plot(showSR ? srMiddle : na, color=color.new(color.gray, 60), linewidth=1, style=plot.style_cross, title="ì¤‘ì‹¬ì„ ")

// ì§€ì§€/ì €í•­ ê·¼ì²˜ ë°°ê²½ í•˜ì´ë¼ì´íŠ¸
bgcolor(showSR and nearResistance ? color.new(color.red, 85) : na, title="ì €í•­ì„  ê·¼ì²˜")
bgcolor(showSR and nearSupport ? color.new(color.green, 85) : na, title="ì§€ì§€ì„  ê·¼ì²˜")

// ============================================
// ğŸ“ˆ ë‹¤ì´ë²„ì „ìŠ¤ í‘œì‹œ
// ============================================
plotshape(showDivergence and bullishDivergence, style=shape.labelup, location=location.belowbar,
         color=color.new(color.lime, 0), size=size.small, text="Bull\nDiv", textcolor=color.white, title="ë¶ˆë¦¬ì‹œ ë‹¤ì´ë²„ì „ìŠ¤")
plotshape(showDivergence and bearishDivergence, style=shape.labeldown, location=location.abovebar,
         color=color.new(color.red, 0), size=size.small, text="Bear\nDiv", textcolor=color.white, title="ë² ì–´ë¦¬ì‹œ ë‹¤ì´ë²„ì „ìŠ¤")

// ============================================
// ğŸ¯ ì¤‘ìš” ë³€ê³¡ì  êµ¬ê°„ í•˜ì´ë¼ì´íŠ¸
// ============================================
// ê°•í•œ ë§¤ìˆ˜ êµ¬ê°„ (ê³¨ë“  ì¡´)
bgcolor(strongBuyZone ? color.new(color.lime, 70) : na, title="ğŸŸ¢ ê°•í•œ ë§¤ìˆ˜ êµ¬ê°„")
// ê°•í•œ ë§¤ë„ êµ¬ê°„ (ë°ìŠ¤ ì¡´)
bgcolor(strongSellZone ? color.new(color.fuchsia, 70) : na, title="ğŸ”´ ê°•í•œ ë§¤ë„ êµ¬ê°„")
// ë³€ê³¡ì  êµ¬ê°„ (ë‹¤ì´ë²„ì „ìŠ¤)
bgcolor(turningZone ? color.new(color.aqua, 80) : na, title="ğŸ”„ ë³€ê³¡ì  êµ¬ê°„")

// ============================================
// ì‹ í˜¸ ë¼ë²¨ í‘œì‹œ
// ============================================

var label signalLabel = na
var line tp1Line = na
var line tp2Line = na
var line slLine = na

// ëª¨ë“œë³„ ì´ëª¨ì§€
string modeEmoji = tradeMode == "ì„ ë¬¼" ? "âš¡" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "ğŸª™" : "ğŸ“ˆ"
string modeText = tradeMode == "ì„ ë¬¼" ? "FUTURES" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "SPOT" : "STOCK"

if longSignal_final
    if not na(signalLabel)
        label.delete(signalLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 + tpPct1/100)
    float labelTp2 = close * (1 + tpPct2/100)
    float labelSl = close * (1 - slPct/100)

    signalLabel := label.new(bar_index, low - (high - low) * 0.3,
                          text=modeEmoji + " LONG [" + modeText + "]\n" +
                               "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
                               "ì ìˆ˜: " + str.tostring(totalScore, "#.#") + "/28\n" +
                               "â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                               "TP1: $" + str.tostring(labelTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
                               "TP2: $" + str.tostring(labelTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
                               "SL: $" + str.tostring(labelSl, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)\n" +
                               (isWhale ? "ğŸ‹ ê³ ë˜ ê°ì§€!" : "") +
                               (isInstitution ? "ğŸ³ ê¸°ê´€ ê°ì§€!" : ""),
                          style=label.style_label_up,
                          color=color.new(color.green, 20),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 20, labelTp1,
                       color=color.new(color.green, 0), width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 20, labelTp2,
                       color=color.new(color.green, 0), width=3, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 20, labelSl,
                      color=color.new(color.red, 0), width=2, style=line.style_solid)

if shortSignal_final and tradeMode == "ì„ ë¬¼"
    if not na(signalLabel)
        label.delete(signalLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 - tpPct1/100)
    float labelTp2 = close * (1 - tpPct2/100)
    float labelSl = close * (1 + slPct/100)

    signalLabel := label.new(bar_index, high + (high - low) * 0.3,
                          text="âš¡ SHORT [FUTURES]\n" +
                               "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
                               "ì ìˆ˜: " + str.tostring(totalScoreShort, "#.#") + "/28\n" +
                               "â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                               "TP1: $" + str.tostring(labelTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
                               "TP2: $" + str.tostring(labelTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
                               "SL: $" + str.tostring(labelSl, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)\n" +
                               (whaleSelling ? "ğŸ‹ ê³ ë˜ ë§¤ë„!" : "") +
                               (institutionSelling ? "ğŸ³ ê¸°ê´€ ë§¤ë„!" : ""),
                          style=label.style_label_down,
                          color=color.new(color.red, 20),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 20, labelTp1,
                       color=color.new(color.green, 0), width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 20, labelTp2,
                       color=color.new(color.green, 0), width=3, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 20, labelSl,
                      color=color.new(color.red, 0), width=2, style=line.style_solid)

// EXIT ê²½ê³  ë¼ë²¨ (í˜„ë¬¼/ì£¼ì‹)
if whaleExitSignal
    label.new(bar_index, high + (high - low) * 0.2,
              text="âš ï¸ EXIT ê²½ê³ \nê³ ë˜ ë§¤ë„ ê°ì§€!",
              style=label.style_label_down,
              color=color.new(color.orange, 20),
              textcolor=color.white, size=size.small)

// ============================================
// ğŸ‘¶ ì´ˆë³´ììš© ê°„ë‹¨ íŒ¨ë„
// ============================================

var table beginnerTable = table.new(getTablePosition(beginnerTablePos), 1, 12, bgcolor=color.new(color.white, 5), border_width=2)

if barstate.islast and beginnerMode
    table.clear(beginnerTable, 0, 0, 0, 11)

    // ì¢…í•© íŒë‹¨ ê³„ì‚°
    bool overallBullish = bullishDI and (trend_15m_bullish or trend_5m_bullish) and close > ma50
    bool overallBearish = bearishDI and (trend_15m_bearish or trend_5m_bearish) and close < ma50
    bool isGoodLong = overallBullish and totalScore >= minSignalStrength and (isWhale ? whaleBuying : true)
    bool isGoodShort = overallBearish and totalScoreShort >= minSignalStrength and (isWhale ? whaleSelling : true)
    bool isDanger = (overallBullish and whaleSelling) or (overallBearish and whaleBuying) or noTrend

    // í—¤ë”
    color headerColor = isGoodLong ? color.green : isGoodShort ? color.red : isDanger ? color.orange : color.gray
    string headerText = isGoodLong ? "ğŸŸ¢ ë§¤ìˆ˜ ì¢‹ìŒ!" : isGoodShort ? "ğŸ”´ ë§¤ë„ ì¢‹ìŒ!" : isDanger ? "âš ï¸ ìœ„í—˜!" : "â¸ï¸ ê´€ë§"
    table.cell(beginnerTable, 0, 0, "â”â” " + headerText + " â”â”", text_color=color.white, text_size=size.normal,
              bgcolor=color.new(headerColor, 20))

    // 1. ì§€ê¸ˆ ì‹œì¥ì€?
    table.cell(beginnerTable, 0, 1, "ğŸ“Š ì§€ê¸ˆ ì‹œì¥ì€?", text_color=color.black, text_size=size.small,
              bgcolor=color.new(color.gray, 80))
    string marketStatus = overallBullish ? "ğŸ“ˆ ì˜¤ë¥´ëŠ” ì¤‘!" : overallBearish ? "ğŸ“‰ ë‚´ë¦¬ëŠ” ì¤‘!" : "â¡ï¸ ë°©í–¥ ì—†ìŒ"
    color marketColor = overallBullish ? color.green : overallBearish ? color.red : color.gray
    table.cell(beginnerTable, 0, 2, marketStatus, text_color=marketColor, text_size=size.small)

    // 2. ì¶”ì„¸ ê°•ë„ëŠ”?
    string strengthText = veryStrongTrend ? "ğŸ’ª ì•„ì£¼ ê°•í•¨ - ë”°ë¼ê°€ê¸° ì¢‹ìŒ" : strongTrend ? "âœ… ê°•í•¨ - ì§„ì… ê°€ëŠ¥" : trendExists ? "ğŸ”¸ ë³´í†µ - ì£¼ì˜ í•„ìš”" : "âš ï¸ ì•½í•¨ - ì§„ì… ìœ„í—˜"
    color strengthColor = veryStrongTrend ? color.green : strongTrend ? color.blue : trendExists ? color.orange : color.red
    table.cell(beginnerTable, 0, 3, strengthText, text_color=strengthColor, text_size=size.small)

    // 3. í°ì†ë“¤ì€?
    table.cell(beginnerTable, 0, 4, "ğŸ‹ í°ì†(ê³ ë˜)ë“¤ì€?", text_color=color.black, text_size=size.small,
              bgcolor=color.new(color.gray, 80))
    string whaleText = institutionBuying ? "ğŸ³ ê¸°ê´€ì´ ì‚¬ëŠ” ì¤‘!" : institutionSelling ? "ğŸ³ ê¸°ê´€ì´ íŒŒëŠ” ì¤‘!" : whaleBuying ? "ğŸ‹ ê³ ë˜ê°€ ì‚¬ëŠ” ì¤‘" : whaleSelling ? "ğŸ‹ ê³ ë˜ê°€ íŒŒëŠ” ì¤‘" : isWhale ? "ğŸ‹ ê³ ë˜ í™œë™ ê°ì§€" : "ğŸ¦ í°ì† ì—†ìŒ"
    color whaleColor = (institutionBuying or whaleBuying) ? color.green : (institutionSelling or whaleSelling) ? color.red : color.gray
    table.cell(beginnerTable, 0, 5, whaleText, text_color=whaleColor, text_size=size.small)

    // 4. ë§¤ìˆ˜/ë§¤ë„ ì„¸ë ¥
    string pressureText = buyPressure >= 70 ? "ğŸŸ¢ ë§¤ìˆ˜ì„¸ ê°•í•¨!" : buyPressure >= 55 ? "ğŸŸ¢ ë§¤ìˆ˜ ìš°ìœ„" : buyPressure <= 30 ? "ğŸ”´ ë§¤ë„ì„¸ ê°•í•¨!" : buyPressure <= 45 ? "ğŸ”´ ë§¤ë„ ìš°ìœ„" : "âšª ê· í˜•"
    color pressureColor = buyPressure >= 55 ? color.green : buyPressure <= 45 ? color.red : color.gray
    table.cell(beginnerTable, 0, 6, pressureText + " (" + str.tostring(buyPressure, "#") + "%)", text_color=pressureColor, text_size=size.small)

    // 5. ì§€ê¸ˆ ë“¤ì–´ê°€ë„ ë ê¹Œ?
    table.cell(beginnerTable, 0, 7, "ğŸ¯ ì§€ê¸ˆ ë“¤ì–´ê°€ë„ ë ê¹Œ?", text_color=color.black, text_size=size.small,
              bgcolor=color.new(color.gray, 80))
    string adviceText = ""
    color adviceColor = color.gray
    if longSignal_final
        adviceText := "âœ… ë¡± ì§„ì… ì‹ í˜¸!\nëª©í‘œ: $" + str.tostring(close * (1 + tpPct1/100), "#.#")
        adviceColor := color.green
    else if shortSignal_final and tradeMode == "ì„ ë¬¼"
        adviceText := "âœ… ìˆ ì§„ì… ì‹ í˜¸!\nëª©í‘œ: $" + str.tostring(close * (1 - tpPct1/100), "#.#")
        adviceColor := color.red
    else if isDanger
        adviceText := "âŒ ìœ„í—˜! ê¸°ë‹¤ë¦¬ì„¸ìš”\nê³ ë˜ì™€ ì¶”ì„¸ê°€ ë°˜ëŒ€"
        adviceColor := color.orange
    else if noTrend
        adviceText := "â¸ï¸ ë°©í–¥ ì—†ìŒ\níš¡ë³´ì¥ - ê¸°ë‹¤ë¦¬ì„¸ìš”"
        adviceColor := color.gray
    else if overallBullish and totalScore < minSignalStrength
        adviceText := "ğŸ”¸ ì¡°ê¸ˆ ë” ê¸°ë‹¤ë ¤ìš”\nì ìˆ˜ ë¶€ì¡± (" + str.tostring(totalScore, "#") + "/" + str.tostring(minSignalStrength, "#") + ")"
        adviceColor := color.orange
    else if overallBearish and totalScoreShort < minSignalStrength
        adviceText := "ğŸ”¸ ì¡°ê¸ˆ ë” ê¸°ë‹¤ë ¤ìš”\nì ìˆ˜ ë¶€ì¡±"
        adviceColor := color.orange
    else
        adviceText := "â¸ï¸ ê´€ë§í•˜ì„¸ìš”\nì¢‹ì€ ê¸°íšŒ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘"
        adviceColor := color.gray
    table.cell(beginnerTable, 0, 8, adviceText, text_color=adviceColor, text_size=size.small)

    // 6. ì†ì ˆ/ìµì ˆ ê°€ì´ë“œ
    table.cell(beginnerTable, 0, 9, "ğŸ’° ëª©í‘œê°€/ì†ì ˆê°€", text_color=color.black, text_size=size.small,
              bgcolor=color.new(color.gray, 80))
    string tpslGuide = "1ì°¨ ìµì ˆ: +" + str.tostring(tpPct1, "#.#") + "%\n2ì°¨ ìµì ˆ: +" + str.tostring(tpPct2, "#.#") + "%\nì†ì ˆ: -" + str.tostring(slPct, "#.#") + "%"
    table.cell(beginnerTable, 0, 10, tpslGuide, text_color=color.black, text_size=size.small)

    // 7. í˜„ì¬ ì ìˆ˜
    string scoreText = "ğŸ“Š ì‹ í˜¸ ì ìˆ˜: " + str.tostring(totalScore, "#") + "/28"
    color scoreColor = totalScore >= minSignalStrength ? color.green : totalScore >= minSignalStrength - 2 ? color.orange : color.gray
    table.cell(beginnerTable, 0, 11, scoreText, text_color=scoreColor, text_size=size.small,
              bgcolor=color.new(scoreColor, 80))

// ============================================
// ì •ë³´ í…Œì´ë¸” (ì „ë¬¸ê°€ìš©)
// ============================================

var table infoTable = table.new(getTablePosition(detailTablePos), 2, 25, bgcolor=color.new(color.white, 10), border_width=1)

if barstate.islast and showDetailTable
    table.clear(infoTable, 0, 0, 1, 24)

    // ëª¨ë“œ í‘œì‹œ
    modeColor = tradeMode == "ì„ ë¬¼" ? color.purple : tradeMode == "í˜„ë¬¼ì½”ì¸" ? color.orange : color.blue
    table.cell(infoTable, 0, 0, modeEmoji + " " + modeText, text_color=color.white, text_size=size.normal,
              bgcolor=color.new(modeColor, 20))
    table.cell(infoTable, 1, 0, "í´ë¡œë“œ27", text_color=color.white, text_size=size.normal,
              bgcolor=color.new(modeColor, 20))

    table.cell(infoTable, 0, 1, "í˜„ì¬ê°€", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 1, "$" + str.tostring(close, "#.##"), text_color=color.black, text_size=size.small)

    // TP/SL ì„¤ì •
    table.cell(infoTable, 0, 2, "TP1/TP2/SL", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(tpPct1, "#.#") + "/" + str.tostring(tpPct2, "#.#") + "/" + str.tostring(slPct, "#.#") + "%",
              text_color=color.black, text_size=size.small)

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š ì¶”ì„¸ ë¶„ì„ ì„¹ì…˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    table.cell(infoTable, 0, 3, "â”â” ì¶”ì„¸ ë¶„ì„ â”â”", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.blue, 30))
    table.cell(infoTable, 1, 3, "", bgcolor=color.new(color.blue, 30))

    // ì¢…í•© ì¶”ì„¸ íŒë‹¨
    bool overallBullish = bullishDI and (trend_15m_bullish or trend_5m_bullish) and close > ma50
    bool overallBearish = bearishDI and (trend_15m_bearish or trend_5m_bearish) and close < ma50
    string trendSummary = overallBullish ? "ğŸŸ¢ ìƒìŠ¹ì¶”ì„¸" : overallBearish ? "ğŸ”´ í•˜ë½ì¶”ì„¸" : "âšª íš¡ë³´/ë¶ˆëª…í™•"
    color trendSummaryColor = overallBullish ? color.green : overallBearish ? color.red : color.gray
    table.cell(infoTable, 0, 4, "ğŸ“ˆ ì¢…í•©ì¶”ì„¸", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 4, trendSummary, text_color=trendSummaryColor, text_size=size.small)

    // ADX (ì¶”ì„¸ ê°•ë„)
    table.cell(infoTable, 0, 5, "ğŸ“Š ì¶”ì„¸ê°•ë„", text_color=color.black, text_size=size.small)
    adxStatus = veryStrongTrend ? "ğŸ”¥ ë§¤ìš°ê°•í•¨" : strongTrend ? "ğŸ’ª ê°•í•¨" : trendExists ? "âœ… ì¶”ì„¸ìˆìŒ" : "âš ï¸ íš¡ë³´ì¥"
    adxColor = veryStrongTrend ? color.green : strongTrend ? color.blue : trendExists ? color.teal : color.red
    table.cell(infoTable, 1, 5, adxStatus + " (ADX:" + str.tostring(adx, "#.#") + ")",
              text_color=adxColor, text_size=size.small)

    // DI ë°©í–¥ (ì¶”ì„¸ ë°©í–¥)
    table.cell(infoTable, 0, 6, "ğŸ“ ì¶”ì„¸ë°©í–¥", text_color=color.black, text_size=size.small)
    float diDiff = diPlus - diMinus
    string diTrendStr = bullishDI ? "ğŸŸ¢ ìƒìŠ¹ (+" + str.tostring(diDiff, "#.#") + ")" : "ğŸ”´ í•˜ë½ (" + str.tostring(diDiff, "#.#") + ")"
    table.cell(infoTable, 1, 6, diTrendStr, text_color=bullishDI ? color.green : color.red, text_size=size.small)

    // ìƒìœ„ íƒ€ì„í”„ë ˆì„
    string tfHighLabel = tradeMode == "ì„ ë¬¼" ? "HTF(1H)" : "HTF(ì¼ë´‰)"
    table.cell(infoTable, 0, 7, tfHighLabel, text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 7, trend_15m_bullish ? "ğŸŸ¢ ìƒìŠ¹" : trend_15m_bearish ? "ğŸ”´ í•˜ë½" : "âšª ì¤‘ë¦½",
              text_color=trend_15m_bullish ? color.green : trend_15m_bearish ? color.red : color.gray, text_size=size.small)

    // ì¤‘ê°„ íƒ€ì„í”„ë ˆì„
    string tfMidLabel = tradeMode == "ì„ ë¬¼" ? "MTF(15M)" : "MTF(4H)"
    table.cell(infoTable, 0, 8, tfMidLabel, text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 8, trend_5m_bullish ? "ğŸŸ¢ ìƒìŠ¹" : trend_5m_bearish ? "ğŸ”´ í•˜ë½" : "âšª ì¤‘ë¦½",
              text_color=trend_5m_bullish ? color.green : trend_5m_bearish ? color.red : color.gray, text_size=size.small)

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ‹ ê³ ë˜ ë¶„ì„ ì„¹ì…˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    table.cell(infoTable, 0, 9, "â”â” ê³ ë˜ ë¶„ì„ â”â”", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.purple, 30))
    table.cell(infoTable, 1, 9, "", bgcolor=color.new(color.purple, 30))

    // ê³ ë˜ ë“±ê¸‰
    table.cell(infoTable, 0, 10, "ğŸ‹ ê³ ë˜ë“±ê¸‰", text_color=color.black, text_size=size.small)
    string whaleGrade = isInstitution ? "ğŸ³ ê¸°ê´€ê¸‰ (" + str.tostring(volumeRatio, "#.#") + "x)" : isWhale ? "ğŸ‹ ê³ ë˜ (" + str.tostring(volumeRatio, "#.#") + "x)" : volumeRatio >= 1.5 ? "ğŸŸ ì¤‘í˜• (" + str.tostring(volumeRatio, "#.#") + "x)" : "ğŸ¦ ì†Œí˜• (" + str.tostring(volumeRatio, "#.#") + "x)"
    color whaleGradeColor = isInstitution ? color.purple : isWhale ? color.blue : volumeRatio >= 1.5 ? color.teal : color.gray
    table.cell(infoTable, 1, 10, whaleGrade, text_color=whaleGradeColor, text_size=size.small)

    // ê³ ë˜ ë°©í–¥
    table.cell(infoTable, 0, 11, "ğŸ¯ ê³ ë˜ë°©í–¥", text_color=color.black, text_size=size.small)
    string whaleDirection = institutionBuying ? "ğŸŸ¢ğŸ³ ê¸°ê´€ë§¤ìˆ˜!" : institutionSelling ? "ğŸ”´ğŸ³ ê¸°ê´€ë§¤ë„!" : whaleBuying ? "ğŸŸ¢ğŸ‹ ê³ ë˜ë§¤ìˆ˜" : whaleSelling ? "ğŸ”´ğŸ‹ ê³ ë˜ë§¤ë„" : buyPressure > 60 ? "ğŸŸ¢ ë§¤ìˆ˜ìš°ìœ„" : sellPressure > 60 ? "ğŸ”´ ë§¤ë„ìš°ìœ„" : "âšª ì¤‘ë¦½"
    color whaleDirectionColor = (institutionBuying or whaleBuying or buyPressure > 60) ? color.green : (institutionSelling or whaleSelling or sellPressure > 60) ? color.red : color.gray
    table.cell(infoTable, 1, 11, whaleDirection, text_color=whaleDirectionColor, text_size=size.small)

    // ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥ ë°”
    table.cell(infoTable, 0, 12, "ğŸ’ª ë§¤ìˆ˜ì••ë ¥", text_color=color.black, text_size=size.small)
    string pressureBar = buyPressure >= 80 ? "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘" : buyPressure >= 70 ? "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘" : buyPressure >= 60 ? "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘" : buyPressure >= 50 ? "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘" : buyPressure >= 40 ? "â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘" : buyPressure >= 30 ? "â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘" : "â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
    string pressureText = str.tostring(buyPressure, "#") + "% " + pressureBar
    table.cell(infoTable, 1, 12, pressureText, text_color=buyPressure > 60 ? color.green : buyPressure < 40 ? color.red : color.gray, text_size=size.small)

    // ì‹œì¥ êµ­ë©´
    table.cell(infoTable, 0, 13, "ğŸ“Š ì‹œì¥êµ­ë©´", text_color=color.black, text_size=size.small)
    phaseText = isAccumulation ? "ğŸ“ˆ ì„¸ë ¥ ëˆ„ì ì¤‘" : isDistribution ? "ğŸ“‰ ì„¸ë ¥ ë¶„ì‚°ì¤‘" : "â¡ï¸ ê´€ë§"
    table.cell(infoTable, 1, 13, phaseText,
              text_color=isAccumulation ? color.green : isDistribution ? color.red : color.gray, text_size=size.small)

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š ì ìˆ˜ ì„¹ì…˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    table.cell(infoTable, 0, 14, "â”â” ì ìˆ˜ â”â”", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.gray, 30))
    table.cell(infoTable, 1, 14, str.tostring(totalScore, "#.#") + "/28", text_color=totalScore >= minSignalStrength ? color.green : color.gray,
              bgcolor=color.new(color.gray, 30))

    // ë¶ˆì¥ë‹¨íƒ€ì™•
    table.cell(infoTable, 0, 15, "ë¶ˆì¥ë‹¨íƒ€ì™•", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 15, str.tostring(bulJangScore, "#") + "/10",
              text_color=bulJangScore >= 6 ? color.green : bulJangScore >= 4 ? color.orange : color.red, text_size=size.small)

    // í´ë¡œë“œ
    table.cell(infoTable, 0, 16, "í´ë¡œë“œ21", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 16, str.tostring(claude21Score, "#") + "/8",
              text_color=claude21Score >= 6 ? color.green : claude21Score >= 4 ? color.orange : color.red, text_size=size.small)

    // í•„í„° + ê³ ë˜
    table.cell(infoTable, 0, 17, "í•„í„°+ê³ ë˜", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 17, str.tostring(filterScore, "#") + "+" + str.tostring(whaleScore, "#") + "/10",
              text_color=(filterScore + whaleScore) >= 6 ? color.green : color.gray, text_size=size.small)

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“ˆ ì§€í‘œ ìƒíƒœ ì„¹ì…˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    table.cell(infoTable, 0, 18, "â”â” ì§€í‘œ â”â”", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.teal, 30))
    table.cell(infoTable, 1, 18, "", bgcolor=color.new(color.teal, 30))

    // StochRSI
    table.cell(infoTable, 0, 19, "StochRSI", text_color=color.black, text_size=size.small)
    stochStatus = stochOversold ? "ğŸŸ¢ ê³¼ë§¤ë„ (ë§¤ìˆ˜)" : stochOverbought ? "ğŸ”´ ê³¼ë§¤ìˆ˜ (ë§¤ë„)" : stochK > 50 ? "â¬†ï¸ ìƒìŠ¹ì¤‘" : "â¬‡ï¸ í•˜ë½ì¤‘"
    table.cell(infoTable, 1, 19, stochStatus + " (" + str.tostring(stochK, "#") + ")",
              text_color=stochOversold ? color.green : stochOverbought ? color.red : color.gray, text_size=size.small)

    // BB
    table.cell(infoTable, 0, 20, "ë³¼ë¦°ì €ë°´ë“œ", text_color=color.black, text_size=size.small)
    bbStatus = bbSqueeze ? "ğŸŸ¡ ìŠ¤í€´ì¦ˆ (í­ë°œì˜ˆê³ )" : touchingBBLower ? "ğŸŸ¢ í•˜ë‹¨ (ë°˜ë“±)" : touchingBBUpper ? "ğŸ”´ ìƒë‹¨ (ì¡°ì •)" : "âšª ì¤‘ë¦½"
    table.cell(infoTable, 1, 20, bbStatus,
              text_color=bbSqueeze ? color.yellow : touchingBBLower ? color.green : touchingBBUpper ? color.red : color.gray,
              text_size=size.small)

    // OI ìƒíƒœ
    table.cell(infoTable, 0, 21, "ğŸ“ˆ OI", text_color=color.black, text_size=size.small)
    oiStatus = oiPriceUp ? "ğŸš€ ê°•í•œìƒìŠ¹" : oiPriceDown ? "ğŸ“‰ ê°•í•œí•˜ë½" : oiShortSqueeze ? "ğŸ”¥ ìˆìŠ¤í€´ì¦ˆ" : oiLongSqueeze ? "ğŸ’¥ ë¡±ìŠ¤í€´ì¦ˆ" : oiIncreasing ? "â¬†ï¸ ì¦ê°€" : oiDecreasing ? "â¬‡ï¸ ê°ì†Œ" : "â¡ï¸ ì•ˆì •"
    oiColor = oiPriceUp or oiShortSqueeze ? color.green : oiPriceDown or oiLongSqueeze ? color.red : color.gray
    table.cell(infoTable, 1, 21, oiStatus, text_color=oiColor, text_size=size.small)

    // Funding Rate
    table.cell(infoTable, 0, 22, "ğŸ’° í€ë”©ë¹„", text_color=color.black, text_size=size.small)
    fundingStatus = fundingBearish ? "ğŸ”´ ë¡±ê³¼ì—´ (ìˆìœ ë¦¬)" : fundingBullish ? "ğŸŸ¢ ìˆê³¼ì—´ (ë¡±ìœ ë¦¬)" : "âšª ì¤‘ë¦½"
    fundingColor = fundingBearish ? color.red : fundingBullish ? color.green : color.gray
    table.cell(infoTable, 1, 22, fundingStatus, text_color=fundingColor, text_size=size.small)

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¯ ìµœì¢… ì‹ í˜¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    table.cell(infoTable, 0, 23, "â”â”â”â”â”â”â”â”â”â”", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 23, "â”â”â”â”â”â”â”â”â”â”", text_color=color.gray, text_size=size.small)

    table.cell(infoTable, 0, 24, "ğŸ¯ ìµœì¢…ì‹ í˜¸", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.gray, 20))
    string finalText = longSignal_final ? "ğŸš€ LONG ì§„ì…" : (shortSignal_final and tradeMode == "ì„ ë¬¼") ? "ğŸ”» SHORT ì§„ì…" : whaleExitSignal ? "âš ï¸ EXIT ê²½ê³ " : "â¸ï¸ ëŒ€ê¸°ì¤‘"
    finalColor = longSignal_final ? color.green : (shortSignal_final and tradeMode == "ì„ ë¬¼") ? color.red : whaleExitSignal ? color.orange : color.gray
    table.cell(infoTable, 1, 24, finalText, text_color=finalColor, text_size=size.small,
              bgcolor=color.new(finalColor, 80))

// ============================================
// Webhook ì•Œë¦¼ (ê¹”ë”í•œ í˜•ì‹ + JSON ì›¹í›…)
// ============================================

if longSignal_final
    // ê°€ê²© ê³„ì‚°
    float tp1Price = close * (1 + tpPct1/100)
    float tp2Price = close * (1 + tpPct2/100)
    float slPrice = close * (1 - slPct/100)

    // ê¹”ë”í•œ ì•Œë¦¼ ë©”ì‹œì§€ (ì´ë©”ì¼/ì•± ì•Œë¦¼ìš©)
    string alertMsg = "ğŸŸ¢ LONG " + syminfo.basecurrency + "-USDT\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
          "TP1: $" + str.tostring(tp1Price, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
          "TP2: $" + str.tostring(tp2Price, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
          "SL: $" + str.tostring(slPrice, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ë ˆë²„ë¦¬ì§€: " + str.tostring(leverageInput) + "x | ì ìˆ˜: " + str.tostring(totalScore, "#.#") + "/28\n" +
          (isInstitution ? "ğŸ³ ê¸°ê´€ ê°ì§€!" : isWhale ? "ğŸ‹ ê³ ë˜ ê°ì§€!" : "") +
          "\n\n" +
          '{"version":"27","market":"' + syminfo.basecurrency + '-USDT","mode":"' + tradeMode + '","signal":"LONG",' +
          '"leverage":"' + str.tostring(leverageInput) + '",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"totalScore":"' + str.tostring(totalScore, "#.#") + '",' +
          '"tp1":"' + str.tostring(tp1Price, "#.##") + '",' +
          '"tp2":"' + str.tostring(tp2Price, "#.##") + '",' +
          '"sl":"' + str.tostring(slPrice, "#.##") + '",' +
          '"tp1_pct":"' + str.tostring(tpPct1, "#.#") + '",' +
          '"tp2_pct":"' + str.tostring(tpPct2, "#.#") + '",' +
          '"sl_pct":"' + str.tostring(slPct, "#.#") + '"}'

    alert(alertMsg, freq=alert.freq_once_per_bar)

if shortSignal_final and tradeMode == "ì„ ë¬¼"
    // ê°€ê²© ê³„ì‚°
    float tp1Price = close * (1 - tpPct1/100)
    float tp2Price = close * (1 - tpPct2/100)
    float slPrice = close * (1 + slPct/100)

    // ê¹”ë”í•œ ì•Œë¦¼ ë©”ì‹œì§€ (ì´ë©”ì¼/ì•± ì•Œë¦¼ìš©)
    string alertMsg = "ğŸ”´ SHORT " + syminfo.basecurrency + "-USDT\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
          "TP1: $" + str.tostring(tp1Price, "#.##") + " (-" + str.tostring(tpPct1, "#.#") + "%)\n" +
          "TP2: $" + str.tostring(tp2Price, "#.##") + " (-" + str.tostring(tpPct2, "#.#") + "%)\n" +
          "SL: $" + str.tostring(slPrice, "#.##") + " (+" + str.tostring(slPct, "#.#") + "%)\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "ë ˆë²„ë¦¬ì§€: " + str.tostring(leverageInput) + "x | ì ìˆ˜: " + str.tostring(totalScoreShort, "#.#") + "/28\n" +
          (institutionSelling ? "ğŸ³ ê¸°ê´€ ë§¤ë„!" : whaleSelling ? "ğŸ‹ ê³ ë˜ ë§¤ë„!" : "") +
          "\n\n" +
          '{"version":"27","market":"' + syminfo.basecurrency + '-USDT","mode":"ì„ ë¬¼","signal":"SHORT",' +
          '"leverage":"' + str.tostring(leverageInput) + '",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"totalScore":"' + str.tostring(totalScoreShort, "#.#") + '",' +
          '"tp1":"' + str.tostring(tp1Price, "#.##") + '",' +
          '"tp2":"' + str.tostring(tp2Price, "#.##") + '",' +
          '"sl":"' + str.tostring(slPrice, "#.##") + '",' +
          '"tp1_pct":"' + str.tostring(tpPct1, "#.#") + '",' +
          '"tp2_pct":"' + str.tostring(tpPct2, "#.#") + '",' +
          '"sl_pct":"' + str.tostring(slPct, "#.#") + '"}'

    alert(alertMsg, freq=alert.freq_once_per_bar)

if whaleExitSignal
    string alertMsg = "âš ï¸ EXIT ê²½ê³  " + syminfo.basecurrency + "-USDT\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
          "í˜„ì¬ê°€: $" + str.tostring(close, "#.##") + "\n" +
          "ì‚¬ìœ : ê³ ë˜ ë§¤ë„ ê°ì§€\n" +
          "ê±°ë˜ëŸ‰: " + str.tostring(volumeRatio, "#.##") + "ë°°\n" +
          "ë§¤ë„ì••ë ¥: " + str.tostring(sellPressure, "#.#") + "%" +
          "\n\n" +
          '{"version":"27","market":"' + syminfo.basecurrency + '-USDT","mode":"' + tradeMode + '","signal":"EXIT",' +
          '"reason":"WHALE_SELLING","current_price":"' + str.tostring(close, "#.##") + '"}'

    alert(alertMsg, freq=alert.freq_once_per_bar)
