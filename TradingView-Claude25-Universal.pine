//@version=5
indicator("í´ë¡œë“œ25 ìœ ë‹ˆë²„ì…œ (ì„ ë¬¼/í˜„ë¬¼/ì£¼ì‹)", overlay=true, max_labels_count=100)

// ============================================
// ğŸ¯ ê±°ë˜ ëª¨ë“œ ì„ íƒ
// ============================================
tradeMode = input.string("ì„ ë¬¼", title="ğŸ“Š ê±°ë˜ ëª¨ë“œ", options=["ì„ ë¬¼", "í˜„ë¬¼ì½”ì¸", "ì£¼ì‹"],
    tooltip="ì„ ë¬¼: LONG+SHORT, í˜„ë¬¼ì½”ì¸: LONGë§Œ, ì£¼ì‹: LONGë§Œ")

// ============================================
// ğŸ”§ ëª¨ë“œë³„ ìë™ TP/SL ì„¤ì •
// ============================================

// ëª¨ë“œë³„ ê¸°ë³¸ê°’ ê³„ì‚°
float defaultTP1 = tradeMode == "ì„ ë¬¼" ? 0.8 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.5 : 2.0
float defaultTP2 = tradeMode == "ì„ ë¬¼" ? 1.5 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 3.0 : 4.0
float defaultSL = tradeMode == "ì„ ë¬¼" ? 0.3 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.0 : 1.5

// ìˆ˜ë™ ì˜¤ë²„ë¼ì´ë“œ ì˜µì…˜
useAutoTPSL = input.bool(true, title="ìë™ TP/SL ì‚¬ìš©", tooltip="ì²´í¬ í•´ì œì‹œ ìˆ˜ë™ ì„¤ì • ì‚¬ìš©")
manualTP1 = input.float(0.8, title="ìˆ˜ë™ TP1 (%)", minval=0.1, maxval=10.0, step=0.1)
manualTP2 = input.float(1.5, title="ìˆ˜ë™ TP2 (%)", minval=0.1, maxval=20.0, step=0.1)
manualSL = input.float(0.3, title="ìˆ˜ë™ SL (%)", minval=0.05, maxval=5.0, step=0.05)

// ìµœì¢… TP/SL ê°’
float tpPct1 = useAutoTPSL ? defaultTP1 : manualTP1
float tpPct2 = useAutoTPSL ? defaultTP2 : manualTP2
float slPct = useAutoTPSL ? defaultSL : manualSL

// ============================================
// ë ˆë²„ë¦¬ì§€ ë° í¬ì§€ì…˜ ì„¤ì •
// ============================================
leverageInput = input.int(5, title="ë ˆë²„ë¦¬ì§€ (ì„ ë¬¼ë§Œ)", minval=1, maxval=20)
riskPercentInput = input.float(20.0, title="íˆ¬ì… ë¹„ìœ¨ (%)", minval=1.0, maxval=100.0)

// ì‹ í˜¸ ê°•ë„ ì„¤ì •
minSignalStrength = input.int(10, title="ìµœì†Œ ì‹ í˜¸ ê°•ë„", minval=8, maxval=20)
strictMode = input.bool(true, title="ì—„ê²© ëª¨ë“œ")
useMultiTF = input.bool(true, title="ë©€í‹°íƒ€ì„í”„ë ˆì„ í•„í„°")
useADXFilter = input.bool(false, title="ADX í•„í„° ì‚¬ìš©", tooltip="ON: íš¡ë³´ì¥ í•„í„°ë§ (ì—„ê²©), OFF: ADXëŠ” ë³´ë„ˆìŠ¤ ì ìˆ˜ë§Œ")

// ============================================
// ğŸ‹ ê³ ë˜ ê°ì§€ ì„¤ì •
// ============================================
whaleMultiplier = input.float(2.0, title="ê³ ë˜ ê°ì§€ ë°°ìˆ˜", minval=1.5, maxval=5.0, step=0.5)
institutionMultiplier = input.float(3.0, title="ê¸°ê´€ ê°ì§€ ë°°ìˆ˜", minval=2.0, maxval=10.0, step=0.5)
volumeLength = input.int(20, title="ê±°ë˜ëŸ‰ í‰ê·  ê¸°ê°„", minval=10, maxval=50)

// ê±°ë˜ëŸ‰ ë¶„ì„
avgVolume = ta.sma(volume, volumeLength)
volumeRatio = volume / avgVolume

// ê³ ë˜/ê¸°ê´€ ê°ì§€
isWhale = volumeRatio >= whaleMultiplier
isInstitution = volumeRatio >= institutionMultiplier

// Volume Delta (ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥)
bullVolume = close > open ? volume : volume * (close - low) / (high - low)
bearVolume = close < open ? volume : volume * (high - close) / (high - low)
buyPressure = bullVolume / (bullVolume + bearVolume) * 100
sellPressure = 100 - buyPressure

// ê³ ë˜ ë°©í–¥ íŒë³„
whaleBuying = isWhale and close > open and buyPressure > 60
whaleSelling = isWhale and close < open and sellPressure > 60
institutionBuying = isInstitution and close > open and buyPressure > 60
institutionSelling = isInstitution and close < open and sellPressure > 60

// ëˆ„ì /ë¶„ì‚° ê°ì§€
priceUp = close > close[1]
priceDown = close < close[1]
volumeUp = volume > volume[1]
isAccumulation = priceUp and volumeUp
isDistribution = priceDown and volumeUp

// ============================================
// ì´ë™í‰ê· ì„  ë° VWAP
// ============================================
vwap100 = ta.vwma(close, 100)
ma7 = ta.sma(close, 7)
ma15 = ta.sma(close, 15)
ma50 = ta.sma(close, 50)
ma100 = ta.sma(close, 100)
ma200 = ta.sma(close, 200)

// POC ê·¼ì‚¬ê°’
var float pocPrice = close
var float maxVolume = 0.0
for i = 0 to 99
    if volume[i] > maxVolume
        maxVolume := volume[i]
        pocPrice := close[i]

// ============================================
// Stochastic RSI
// ============================================
rsiLength = input.int(14, title="RSI ê¸¸ì´", minval=5, maxval=25)
stochLength = input.int(14, title="Stoch ê¸¸ì´", minval=5, maxval=25)
smoothK = input.int(3, title="Stoch K ìŠ¤ë¬´ë”©", minval=1, maxval=10)
smoothD = input.int(3, title="Stoch D ìŠ¤ë¬´ë”©", minval=1, maxval=10)

rsi = ta.rsi(close, rsiLength)
stochRsi = ta.stoch(rsi, rsi, rsi, stochLength)
stochK = ta.sma(stochRsi, smoothK)
stochD = ta.sma(stochK, smoothD)

stochOversold = stochK < 20
stochOverbought = stochK > 80
stochGoldenCross = ta.crossover(stochK, stochD)
stochDeadCross = ta.crossunder(stochK, stochD)

// ============================================
// ADX (ì¶”ì„¸ ê°•ë„) - íš¡ë³´ì¥ í•„í„°
// ============================================
adxLength = input.int(14, title="ADX ê¸¸ì´", minval=7, maxval=30)
adxThreshold = input.float(18.0, title="ADX ì„ê³„ê°’ (ì¶”ì„¸ ê°•ë„)", minval=12.0, maxval=35.0, step=1.0,
    tooltip="18 ì´ìƒ: ì¶”ì„¸ ìˆìŒ, 25 ì´ìƒ: ê°•í•œ ì¶”ì„¸, 18 ë¯¸ë§Œ: íš¡ë³´ì¥")

[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)

// ì¶”ì„¸ ê°•ë„ íŒë‹¨
noTrend = adx < adxThreshold           // íš¡ë³´ì¥ (ì§„ì… ê¸ˆì§€)
trendExists = adx >= adxThreshold      // ì¶”ì„¸ ìˆìŒ (ì§„ì… ê°€ëŠ¥)
strongTrend = adx >= 25                // ê°•í•œ ì¶”ì„¸
veryStrongTrend = adx >= 35            // ë§¤ìš° ê°•í•œ ì¶”ì„¸

// DI ë°©í–¥ (ì¶”ì„¸ ë°©í–¥ í™•ì¸)
bullishDI = diPlus > diMinus           // ìƒìŠ¹ ì¶”ì„¸
bearishDI = diMinus > diPlus           // í•˜ë½ ì¶”ì„¸

// ============================================
// ğŸ“ˆ Open Interest & Funding Rate
// ============================================
useOIFilter = input.bool(false, title="OI í•„í„° ì‚¬ìš©", tooltip="Open Interest ì¦ê°€ ì‹œì—ë§Œ ì§„ì… (TradingView í”„ë¦¬ë¯¸ì—„ í•„ìš”)")
oiChangeThreshold = input.float(1.0, title="OI ë³€í™”ìœ¨ ì„ê³„ê°’ (%)", minval=0.5, maxval=5.0, step=0.5)

// OI/í€ë”©ë¹„ - ê±°ë˜ëŸ‰ ê¸°ë°˜ ëŒ€ì²´ ê³„ì‚° (ì‹¬ë³¼ ì˜¤ë¥˜ ë°©ì§€)
// ì‹¤ì œ OI ë°ì´í„°ëŠ” Coinglass ì›¹ì‚¬ì´íŠ¸ ì°¸ê³  ê¶Œì¥
float oi = volume
float oiPrev = volume[1]
float oiChange = oiPrev > 0 ? ((oi - oiPrev) / oiPrev) * 100 : 0

// í€ë”©ë¹„ ëŒ€ì²´ - ê°€ê²© ëª¨ë©˜í…€ ê¸°ë°˜ ì¶”ì •
float priceChange = (close - close[8]) / close[8] * 100
float fundingRate = priceChange > 2 ? 0.06 : priceChange < -2 ? -0.02 : 0.01

// OI ìƒíƒœ íŒë‹¨
oiIncreasing = oiChange > oiChangeThreshold      // OI ì¦ê°€ (ì‹ ê·œ í¬ì§€ì…˜ ì§„ì…)
oiDecreasing = oiChange < -oiChangeThreshold     // OI ê°ì†Œ (í¬ì§€ì…˜ ì²­ì‚°)
oiStable = math.abs(oiChange) <= oiChangeThreshold

// í€ë”©ë¹„ ìƒíƒœ íŒë‹¨
fundingBullish = fundingRate < -0.01             // ìˆ ê³¼ì—´ â†’ ìƒìŠ¹ ê°€ëŠ¥
fundingBearish = fundingRate > 0.05              // ë¡± ê³¼ì—´ â†’ í•˜ë½ ì£¼ì˜
fundingNeutral = fundingRate >= -0.01 and fundingRate <= 0.05

// OI + ê°€ê²© ì¡°í•© ë¶„ì„
oiPriceUp = oiIncreasing and close > close[1]    // OIâ†‘ + ê°€ê²©â†‘ = ê°•í•œ ìƒìŠ¹
oiPriceDown = oiIncreasing and close < close[1]  // OIâ†‘ + ê°€ê²©â†“ = ê°•í•œ í•˜ë½
oiLongSqueeze = oiDecreasing and close < close[1] // OIâ†“ + ê°€ê²©â†“ = ë¡± ì²­ì‚°
oiShortSqueeze = oiDecreasing and close > close[1] // OIâ†“ + ê°€ê²©â†‘ = ìˆ ì²­ì‚°

// ============================================
// Bollinger Bands
// ============================================
bbLength = input.int(20, title="BB ê¸¸ì´", minval=10, maxval=50)
bbMult = input.float(2.0, title="BB ë°°ìˆ˜", minval=1.0, maxval=3.0, step=0.1)

bbBasis = ta.sma(close, bbLength)
bbDev = ta.stdev(close, bbLength)
bbUpper = bbBasis + bbMult * bbDev
bbLower = bbBasis - bbMult * bbDev
bbWidth = (bbUpper - bbLower) / bbBasis * 100
bbSqueeze = bbWidth < ta.sma(bbWidth, 20) * 0.8

// BB ì‹ í˜¸
touchingBBLower = low <= bbLower
touchingBBUpper = high >= bbUpper
bbReversal_long = touchingBBLower and stochOversold
bbReversal_short = touchingBBUpper and stochOverbought

// ============================================
// ğŸ”® í”¼ë´‡ í¬ì¸íŠ¸ (ìŠ¤ìœ™ ê³ ì /ì €ì )
// ============================================
pivotLength = input.int(5, title="í”¼ë´‡ ê¸¸ì´", minval=2, maxval=20)
showPivots = input.bool(true, title="í”¼ë´‡ í¬ì¸íŠ¸ í‘œì‹œ")

// í”¼ë´‡ ê³ ì /ì €ì  ê°ì§€
pivotHigh = ta.pivothigh(high, pivotLength, pivotLength)
pivotLow = ta.pivotlow(low, pivotLength, pivotLength)

// ìµœê·¼ í”¼ë´‡ ì €ì¥
var float lastPivotHigh = na
var float lastPivotLow = na
var int lastPivotHighBar = na
var int lastPivotLowBar = na

if not na(pivotHigh)
    lastPivotHigh := pivotHigh
    lastPivotHighBar := bar_index - pivotLength
if not na(pivotLow)
    lastPivotLow := pivotLow
    lastPivotLowBar := bar_index - pivotLength

// ============================================
// ğŸ“Š ì§€ì§€/ì €í•­ ë ˆë²¨
// ============================================
showSR = input.bool(true, title="ì§€ì§€/ì €í•­ ë ˆë²¨ í‘œì‹œ")
srLength = input.int(20, title="ì§€ì§€/ì €í•­ ê³„ì‚° ê¸¸ì´", minval=10, maxval=50)

// ìµœê·¼ ê³ ì /ì €ì  ê¸°ë°˜ ì§€ì§€/ì €í•­
recentHigh = ta.highest(high, srLength)
recentLow = ta.lowest(low, srLength)
srMiddle = (recentHigh + recentLow) / 2

// ê°€ê²©ì´ ì§€ì§€/ì €í•­ ê·¼ì²˜ì¸ì§€ í™•ì¸
nearResistance = high >= recentHigh * 0.998
nearSupport = low <= recentLow * 1.002
nearMiddle = math.abs(close - srMiddle) / srMiddle < 0.005

// ============================================
// ğŸ“ˆ ë‹¤ì´ë²„ì „ìŠ¤ ê°ì§€ (RSI vs ê°€ê²©)
// ============================================
showDivergence = input.bool(true, title="ë‹¤ì´ë²„ì „ìŠ¤ í‘œì‹œ")
divLength = input.int(14, title="ë‹¤ì´ë²„ì „ìŠ¤ RSI ê¸¸ì´", minval=7, maxval=21)

divRsi = ta.rsi(close, divLength)

// ë¶ˆë¦¬ì‹œ ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²© ì €ì  í•˜ë½ + RSI ì €ì  ìƒìŠ¹
priceLow1 = ta.lowest(low, 5)
priceLow2 = ta.lowest(low[5], 5)
rsiLow1 = ta.lowest(divRsi, 5)
rsiLow2 = ta.lowest(divRsi[5], 5)
bullishDivergence = priceLow1 < priceLow2 and rsiLow1 > rsiLow2 and divRsi < 40

// ë² ì–´ë¦¬ì‹œ ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²© ê³ ì  ìƒìŠ¹ + RSI ê³ ì  í•˜ë½
priceHigh1 = ta.highest(high, 5)
priceHigh2 = ta.highest(high[5], 5)
rsiHigh1 = ta.highest(divRsi, 5)
rsiHigh2 = ta.highest(divRsi[5], 5)
bearishDivergence = priceHigh1 > priceHigh2 and rsiHigh1 < rsiHigh2 and divRsi > 60

// ============================================
// ğŸ¯ ì¤‘ìš” êµ¬ê°„ ê°ì§€
// ============================================
// ê°•í•œ ë§¤ìˆ˜ êµ¬ê°„: BBí•˜ë‹¨ + ì§€ì§€ì„  + ê³¼ë§¤ë„
strongBuyZone = touchingBBLower and nearSupport and stochOversold
// ê°•í•œ ë§¤ë„ êµ¬ê°„: BBìƒë‹¨ + ì €í•­ì„  + ê³¼ë§¤ìˆ˜
strongSellZone = touchingBBUpper and nearResistance and stochOverbought
// ë³€ê³¡ì  êµ¬ê°„: ë‹¤ì´ë²„ì „ìŠ¤ ë°œìƒ
turningZone = bullishDivergence or bearishDivergence

// ============================================
// ë¶ˆì¥ë‹¨íƒ€ì™• ì ìˆ˜ (ìµœëŒ€ 10ì )
// ============================================
var float bulJangScore = 0.0
bulJangScore := 0.0

touchingVWAP = math.abs(close - vwap100) / vwap100 < 0.01
if touchingVWAP
    bulJangScore += 3

ma50_slope = ma50 - ma50[5]
vwap_gentle = math.abs(ma50_slope) < close * 0.01
upCount = 0
for i = 0 to 4
    if close[i] > close[i + 1]
        upCount += 1
recentUptrend = upCount >= 3
turningPoint = vwap_gentle and recentUptrend

vwapGoldenCross = ta.crossover(close, vwap100)
if turningPoint
    bulJangScore += 5
if vwapGoldenCross
    bulJangScore += 2

isUptrend = ma7 > ma15 and ma15 > ma50
if isUptrend
    bulJangScore += 2

// ============================================
// ë©€í‹°íƒ€ì„í”„ë ˆì„ ë¶„ì„ (ëª¨ë“œë³„ íƒ€ì„í”„ë ˆì„)
// ============================================

// ëª¨ë“œë³„ íƒ€ì„í”„ë ˆì„ ì„¤ì •
// ì„ ë¬¼: 1ì‹œê°„, 15ë¶„, 5ë¶„ (í™•ì‹¤í•œ ê¸°íšŒ)
// í˜„ë¬¼/ì£¼ì‹: ì¼ë´‰, 4ì‹œê°„, 1ì‹œê°„ (ìŠ¤ìœ™)

string tf_high = tradeMode == "ì„ ë¬¼" ? "60" : "D"      // ìƒìœ„: ì„ ë¬¼=1ì‹œê°„, í˜„ë¬¼/ì£¼ì‹=ì¼ë´‰
string tf_mid = tradeMode == "ì„ ë¬¼" ? "15" : "240"    // ì¤‘ê°„: ì„ ë¬¼=15ë¶„, í˜„ë¬¼/ì£¼ì‹=4ì‹œê°„
string tf_low = tradeMode == "ì„ ë¬¼" ? "5" : "60"      // í•˜ìœ„: ì„ ë¬¼=5ë¶„, í˜„ë¬¼/ì£¼ì‹=1ì‹œê°„

// ìƒìœ„ íƒ€ì„í”„ë ˆì„ (ì„ ë¬¼: 15ë¶„ / í˜„ë¬¼,ì£¼ì‹: ì¼ë´‰)
ema20_high = request.security(syminfo.tickerid, tf_high, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_high = request.security(syminfo.tickerid, tf_high, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
rsi_high = request.security(syminfo.tickerid, tf_high, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

trend_high_bullish = ema20_high > ema50_high and rsi_high > 45 and rsi_high < 70
trend_high_bearish = ema20_high < ema50_high and rsi_high > 30 and rsi_high < 55

// ì¤‘ê°„ íƒ€ì„í”„ë ˆì„ (ì„ ë¬¼: 5ë¶„ / í˜„ë¬¼,ì£¼ì‹: 4ì‹œê°„)
ema20_mid = request.security(syminfo.tickerid, tf_mid, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_mid = request.security(syminfo.tickerid, tf_mid, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_mid, signalLine_mid, histogram_mid] = request.security(syminfo.tickerid, tf_mid, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)
rsi_mid = request.security(syminfo.tickerid, tf_mid, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

macd_rising_mid = macdLine_mid > macdLine_mid[1]
trend_mid_bullish = ema20_mid > ema50_mid and macd_rising_mid and rsi_mid > 40
trend_mid_bearish = ema20_mid < ema50_mid and not macd_rising_mid and rsi_mid < 60

// í•˜ìœ„ íƒ€ì„í”„ë ˆì„ (ì„ ë¬¼: 3ë¶„ / í˜„ë¬¼,ì£¼ì‹: 1ì‹œê°„)
ema20_low = request.security(syminfo.tickerid, tf_low, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_low = request.security(syminfo.tickerid, tf_low, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_low, signalLine_low, histogram_low] = request.security(syminfo.tickerid, tf_low, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

// í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­ (ê¸°ì¡´ ë³€ìˆ˜ëª… ìœ ì§€)
ema20_15m = ema20_high
ema50_15m = ema50_high
rsi_15m = rsi_high
trend_15m_bullish = trend_high_bullish
trend_15m_bearish = trend_high_bearish

ema20_5m = ema20_mid
ema50_5m = ema50_mid
macdLine_5m = macdLine_mid
signalLine_5m = signalLine_mid
histogram_5m = histogram_mid
rsi_5m = rsi_mid
macd_rising_5m = macd_rising_mid
trend_5m_bullish = trend_mid_bullish
trend_5m_bearish = trend_mid_bearish

ema20_3m = ema20_low
ema50_3m = ema50_low
macdLine_3m = macdLine_low
signalLine_3m = signalLine_low
histogram_3m = histogram_low

signal_3m_long = ta.crossover(ema20_3m, ema50_3m) and macdLine_3m > signalLine_3m
signal_3m_short = ta.crossunder(ema20_3m, ema50_3m) and macdLine_3m < signalLine_3m

// 1ë¶„ë´‰
rsi_1m = ta.rsi(close, 14)
vwma_1m = ta.vwma(close, 20)

// ============================================
// í´ë¡œë“œ ì ìˆ˜ (ìµœëŒ€ 8ì )
// ============================================
var float claude21Score = 0.0
claude21Score := 0.0

longSignal_basic = signal_3m_long and rsi_1m > 35 and rsi_1m < 65 and close > vwma_1m
shortSignal_basic = signal_3m_short and rsi_1m > 35 and rsi_1m < 65 and close < vwma_1m

if longSignal_basic
    claude21Score += 3
if shortSignal_basic
    claude21Score += 3

if trend_15m_bullish and longSignal_basic
    claude21Score += 3
if trend_15m_bearish and shortSignal_basic
    claude21Score += 3

if trend_5m_bullish and longSignal_basic
    claude21Score += 2
if trend_5m_bearish and shortSignal_basic
    claude21Score += 2

// ============================================
// í•„í„° ì ìˆ˜ (ìµœëŒ€ 6ì )
// ============================================
var float filterScore = 0.0
filterScore := 0.0

deviation = (close - vwap100) / vwap100 * 100
meanReversionOK = math.abs(deviation) < 10
if meanReversionOK
    filterScore += 2

nearPOC = math.abs(close - pocPrice) / pocPrice < 0.02
if nearPOC
    filterScore += 2

above200MA = close > ma200
if above200MA
    filterScore += 2

// ============================================
// ê³ ë˜ ë³´ë„ˆìŠ¤ ì ìˆ˜ (ìµœëŒ€ 4ì )
// ============================================
var float whaleScore = 0.0
whaleScore := 0.0

if whaleBuying
    whaleScore += 2
if institutionBuying
    whaleScore += 2
if isAccumulation
    whaleScore += 1

// SHORT ë°©í–¥ ê³ ë˜ ì ìˆ˜ (ì„ ë¬¼ì—ì„œë§Œ ì‚¬ìš©)
var float whaleScoreShort = 0.0
whaleScoreShort := 0.0
if whaleSelling
    whaleScoreShort += 2
if institutionSelling
    whaleScoreShort += 2
if isDistribution
    whaleScoreShort += 1

// ============================================
// ğŸ¯ ìµœì¢… ì‹ í˜¸ ê²°ì • (ëª¨ë“œë³„ ì²˜ë¦¬)
// ============================================

var float totalScore = 0.0
totalScore := bulJangScore + claude21Score + filterScore + whaleScore

var float totalScoreShort = 0.0
totalScoreShort := bulJangScore + claude21Score + filterScore + whaleScoreShort

// ê¸°ë³¸ LONG ì‹ í˜¸
longSignal_final = bulJangScore >= 5 and longSignal_basic and totalScore >= minSignalStrength

// ê¸°ë³¸ SHORT ì‹ í˜¸ (ì„ ë¬¼ì—ì„œë§Œ í™œì„±í™”)
shortSignal_final = false
if tradeMode == "ì„ ë¬¼"
    shortSignal_final := shortSignal_basic and not isUptrend and close < ma200 and totalScoreShort >= minSignalStrength

// ì—„ê²© ëª¨ë“œ (ì™„í™”ë¨: í•˜ë‚˜ì˜ TFë§Œ ì¼ì¹˜í•´ë„ OK, ë˜ëŠ” ì ìˆ˜ê°€ ë†’ìœ¼ë©´ í†µê³¼)
if strictMode and useMultiTF
    // ì ìˆ˜ê°€ ì¶©ë¶„íˆ ë†’ìœ¼ë©´ (14ì  ì´ìƒ) TF í•„í„° ì™„í™”
    bool tfLongOK = trend_15m_bullish or trend_5m_bullish or totalScore >= minSignalStrength + 4
    bool tfShortOK = trend_15m_bearish or trend_5m_bearish or totalScoreShort >= minSignalStrength + 4
    longSignal_final := longSignal_final and tfLongOK
    if tradeMode == "ì„ ë¬¼"
        shortSignal_final := shortSignal_final and tfShortOK

// StochRSI í•„í„°
longSignal_final := longSignal_final and (stochOversold or stochGoldenCross)
if tradeMode == "ì„ ë¬¼"
    shortSignal_final := shortSignal_final and (stochOverbought or stochDeadCross)

// BB í•„í„° (ì™„í™”ë¨ - í•˜ë‚˜ì˜ TFë§Œ ì¼ì¹˜í•´ë„ OK)
longSignal_final := longSignal_final or (bbReversal_long and totalScore >= minSignalStrength - 2 and (trend_15m_bullish or trend_5m_bullish))
if tradeMode == "ì„ ë¬¼"
    shortSignal_final := shortSignal_final or (bbReversal_short and totalScoreShort >= minSignalStrength - 2 and (trend_15m_bearish or trend_5m_bearish))

// ADX í•„í„° (íš¡ë³´ì¥ í•„í„°ë§) - ì„ íƒì  ì ìš©
if useADXFilter
    // ì—„ê²© ëª¨ë“œ: ADX + DI ë°©í–¥ ëª¨ë‘ í•„ìˆ˜
    longSignal_final := longSignal_final and trendExists and bullishDI
    if tradeMode == "ì„ ë¬¼"
        shortSignal_final := shortSignal_final and trendExists and bearishDI
// ADX OFFì¼ ë•Œ: DI ë°˜ëŒ€ ë°©í–¥ì´ë©´ ì‹ í˜¸ ì•½í™” (ì™„ì „ ì°¨ë‹¨ X)
else
    // DI ë°©í–¥ì´ ë°˜ëŒ€ë©´ ì ìˆ˜ -2ì  í˜ë„í‹° ì ìš© (ì‹ í˜¸ ì°¨ë‹¨ì€ ì•ˆí•¨)
    if not bullishDI and totalScore < minSignalStrength + 2
        longSignal_final := false
    if tradeMode == "ì„ ë¬¼" and not bearishDI and totalScoreShort < minSignalStrength + 2
        shortSignal_final := false

// OI í•„í„° (Open Interest ê¸°ë°˜) - ì„ íƒì  ì ìš©
if useOIFilter and oi > 0
    // LONG: OI ì¦ê°€ + ê°€ê²© ìƒìŠ¹ ë˜ëŠ” ìˆ ìŠ¤í€´ì¦ˆ
    longSignal_final := longSignal_final and (oiPriceUp or oiShortSqueeze or oiStable)
    // SHORT: OI ì¦ê°€ + ê°€ê²© í•˜ë½ ë˜ëŠ” ë¡± ìŠ¤í€´ì¦ˆ
    if tradeMode == "ì„ ë¬¼"
        shortSignal_final := shortSignal_final and (oiPriceDown or oiLongSqueeze or oiStable)

// í€ë”©ë¹„ ê²½ê³  í•„í„° (ê·¹ë‹¨ì  ê³¼ì—´ ì‹œ ë°˜ëŒ€ í¬ì§€ì…˜ ì£¼ì˜)
if fundingBearish  // ë¡± ê³¼ì—´ (í€ë”©ë¹„ > 0.05%)
    longSignal_final := longSignal_final and strongTrend  // ê°•í•œ ì¶”ì„¸ì—ì„œë§Œ ë¡± í—ˆìš©
if fundingBullish  // ìˆ ê³¼ì—´ (í€ë”©ë¹„ < -0.01%)
    if tradeMode == "ì„ ë¬¼"
        shortSignal_final := shortSignal_final and strongTrend  // ê°•í•œ ì¶”ì„¸ì—ì„œë§Œ ìˆ í—ˆìš©

// ============================================
// ğŸš¨ ê³ ë˜ EXIT ì‹ í˜¸ (í˜„ë¬¼/ì£¼ì‹ìš©)
// ============================================

// í˜„ë¬¼/ì£¼ì‹ì—ì„œ ê³ ë˜ ë§¤ë„ = ì²­ì‚° ê²½ê³ 
whaleExitSignal = (tradeMode == "í˜„ë¬¼ì½”ì¸" or tradeMode == "ì£¼ì‹") and (whaleSelling or institutionSelling)

// ============================================
// ì°¨íŠ¸ í‘œì‹œ
// ============================================

// ì´ë™í‰ê· ì„ 
plot(vwap100, color=color.new(color.purple, 0), linewidth=3, title="VWAP 100")
plot(ma50, color=color.new(color.orange, 0), linewidth=2, title="MA 50")
plot(ma200, color=color.new(color.blue, 0), linewidth=2, title="MA 200")

// Bollinger Bands
plot(bbUpper, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(bbLower, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")

// 15ë¶„ë´‰ EMA
plot(ema20_15m, color=color.new(color.green, 50), linewidth=1, title="EMA20 (15m)")
plot(ema50_15m, color=color.new(color.red, 50), linewidth=1, title="EMA50 (15m)")

// ì‹ í˜¸ í‘œì‹œ
plotshape(longSignal_final, style=shape.triangleup, location=location.belowbar,
         color=color.new(color.green, 0), size=size.normal, title="LONG ì‹ í˜¸")
plotshape(shortSignal_final and tradeMode == "ì„ ë¬¼", style=shape.triangledown, location=location.abovebar,
         color=color.new(color.red, 0), size=size.normal, title="SHORT ì‹ í˜¸")

// ê³ ë˜ ì‹ í˜¸
plotshape(whaleBuying, style=shape.circle, location=location.belowbar,
         color=color.new(color.lime, 0), size=size.tiny, title="ê³ ë˜ ë§¤ìˆ˜")
plotshape(whaleSelling and tradeMode == "ì„ ë¬¼", style=shape.circle, location=location.abovebar,
         color=color.new(color.fuchsia, 0), size=size.tiny, title="ê³ ë˜ ë§¤ë„ (ì„ ë¬¼)")

// ê¸°ê´€ ì‹ í˜¸
plotshape(institutionBuying, style=shape.diamond, location=location.belowbar,
         color=color.new(color.aqua, 0), size=size.tiny, title="ê¸°ê´€ ë§¤ìˆ˜")
plotshape(institutionSelling and tradeMode == "ì„ ë¬¼", style=shape.diamond, location=location.abovebar,
         color=color.new(color.purple, 0), size=size.tiny, title="ê¸°ê´€ ë§¤ë„ (ì„ ë¬¼)")

// EXIT ê²½ê³  (í˜„ë¬¼/ì£¼ì‹)
plotshape(whaleExitSignal, style=shape.xcross, location=location.abovebar,
         color=color.new(color.orange, 0), size=size.small, title="EXIT ê²½ê³ ")

// ëˆ„ì /ë¶„ì‚° ë°°ê²½
bgcolor(isAccumulation ? color.new(color.green, 90) : na, title="ëˆ„ì  êµ¬ê°„")
bgcolor(isDistribution ? color.new(color.red, 90) : na, title="ë¶„ì‚° êµ¬ê°„")

// BB ìŠ¤í€´ì¦ˆ ë°°ê²½
bgcolor(bbSqueeze ? color.new(color.yellow, 90) : na, title="BB ìŠ¤í€´ì¦ˆ")

// ============================================
// ğŸ”® í”¼ë´‡ í¬ì¸íŠ¸ í‘œì‹œ
// ============================================
plotshape(showPivots and not na(pivotHigh), style=shape.triangledown, location=location.abovebar,
         color=color.new(color.red, 20), size=size.tiny, title="í”¼ë´‡ ê³ ì ", offset=-pivotLength)
plotshape(showPivots and not na(pivotLow), style=shape.triangleup, location=location.belowbar,
         color=color.new(color.green, 20), size=size.tiny, title="í”¼ë´‡ ì €ì ", offset=-pivotLength)

// í”¼ë´‡ ë¼ë²¨
if showPivots and not na(pivotHigh)
    label.new(bar_index - pivotLength, pivotHigh, "H", style=label.style_label_down,
              color=color.new(color.red, 30), textcolor=color.white, size=size.tiny)
if showPivots and not na(pivotLow)
    label.new(bar_index - pivotLength, pivotLow, "L", style=label.style_label_up,
              color=color.new(color.green, 30), textcolor=color.white, size=size.tiny)

// ============================================
// ğŸ“Š ì§€ì§€/ì €í•­ ë ˆë²¨ í‘œì‹œ
// ============================================
plot(showSR ? recentHigh : na, color=color.new(color.red, 40), linewidth=2, style=plot.style_circles, title="ì €í•­ì„ ")
plot(showSR ? recentLow : na, color=color.new(color.green, 40), linewidth=2, style=plot.style_circles, title="ì§€ì§€ì„ ")
plot(showSR ? srMiddle : na, color=color.new(color.gray, 60), linewidth=1, style=plot.style_cross, title="ì¤‘ì‹¬ì„ ")

// ì§€ì§€/ì €í•­ ê·¼ì²˜ ë°°ê²½ í•˜ì´ë¼ì´íŠ¸
bgcolor(showSR and nearResistance ? color.new(color.red, 85) : na, title="ì €í•­ì„  ê·¼ì²˜")
bgcolor(showSR and nearSupport ? color.new(color.green, 85) : na, title="ì§€ì§€ì„  ê·¼ì²˜")

// ============================================
// ğŸ“ˆ ë‹¤ì´ë²„ì „ìŠ¤ í‘œì‹œ
// ============================================
plotshape(showDivergence and bullishDivergence, style=shape.labelup, location=location.belowbar,
         color=color.new(color.lime, 0), size=size.small, text="Bull\nDiv", textcolor=color.white, title="ë¶ˆë¦¬ì‹œ ë‹¤ì´ë²„ì „ìŠ¤")
plotshape(showDivergence and bearishDivergence, style=shape.labeldown, location=location.abovebar,
         color=color.new(color.red, 0), size=size.small, text="Bear\nDiv", textcolor=color.white, title="ë² ì–´ë¦¬ì‹œ ë‹¤ì´ë²„ì „ìŠ¤")

// ============================================
// ğŸ¯ ì¤‘ìš” ë³€ê³¡ì  êµ¬ê°„ í•˜ì´ë¼ì´íŠ¸
// ============================================
// ê°•í•œ ë§¤ìˆ˜ êµ¬ê°„ (ê³¨ë“  ì¡´)
bgcolor(strongBuyZone ? color.new(color.lime, 70) : na, title="ğŸŸ¢ ê°•í•œ ë§¤ìˆ˜ êµ¬ê°„")
// ê°•í•œ ë§¤ë„ êµ¬ê°„ (ë°ìŠ¤ ì¡´)
bgcolor(strongSellZone ? color.new(color.fuchsia, 70) : na, title="ğŸ”´ ê°•í•œ ë§¤ë„ êµ¬ê°„")
// ë³€ê³¡ì  êµ¬ê°„ (ë‹¤ì´ë²„ì „ìŠ¤)
bgcolor(turningZone ? color.new(color.aqua, 80) : na, title="ğŸ”„ ë³€ê³¡ì  êµ¬ê°„")

// ============================================
// ì‹ í˜¸ ë¼ë²¨ í‘œì‹œ
// ============================================

var label signalLabel = na
var line tp1Line = na
var line tp2Line = na
var line slLine = na

// ëª¨ë“œë³„ ì´ëª¨ì§€
string modeEmoji = tradeMode == "ì„ ë¬¼" ? "âš¡" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "ğŸª™" : "ğŸ“ˆ"
string modeText = tradeMode == "ì„ ë¬¼" ? "FUTURES" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "SPOT" : "STOCK"

if longSignal_final
    if not na(signalLabel)
        label.delete(signalLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 + tpPct1/100)
    float labelTp2 = close * (1 + tpPct2/100)
    float labelSl = close * (1 - slPct/100)

    signalLabel := label.new(bar_index, low - (high - low) * 0.3,
                          text=modeEmoji + " LONG [" + modeText + "]\n" +
                               "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
                               "ì ìˆ˜: " + str.tostring(totalScore, "#.#") + "/28\n" +
                               "â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                               "TP1: $" + str.tostring(labelTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
                               "TP2: $" + str.tostring(labelTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
                               "SL: $" + str.tostring(labelSl, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)\n" +
                               (isWhale ? "ğŸ‹ ê³ ë˜ ê°ì§€!" : "") +
                               (isInstitution ? "ğŸ³ ê¸°ê´€ ê°ì§€!" : ""),
                          style=label.style_label_up,
                          color=color.new(color.green, 20),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 20, labelTp1,
                       color=color.new(color.green, 0), width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 20, labelTp2,
                       color=color.new(color.green, 0), width=3, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 20, labelSl,
                      color=color.new(color.red, 0), width=2, style=line.style_solid)

if shortSignal_final and tradeMode == "ì„ ë¬¼"
    if not na(signalLabel)
        label.delete(signalLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 - tpPct1/100)
    float labelTp2 = close * (1 - tpPct2/100)
    float labelSl = close * (1 + slPct/100)

    signalLabel := label.new(bar_index, high + (high - low) * 0.3,
                          text="âš¡ SHORT [FUTURES]\n" +
                               "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
                               "ì ìˆ˜: " + str.tostring(totalScoreShort, "#.#") + "/28\n" +
                               "â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                               "TP1: $" + str.tostring(labelTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
                               "TP2: $" + str.tostring(labelTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
                               "SL: $" + str.tostring(labelSl, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)\n" +
                               (whaleSelling ? "ğŸ‹ ê³ ë˜ ë§¤ë„!" : "") +
                               (institutionSelling ? "ğŸ³ ê¸°ê´€ ë§¤ë„!" : ""),
                          style=label.style_label_down,
                          color=color.new(color.red, 20),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 20, labelTp1,
                       color=color.new(color.green, 0), width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 20, labelTp2,
                       color=color.new(color.green, 0), width=3, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 20, labelSl,
                      color=color.new(color.red, 0), width=2, style=line.style_solid)

// EXIT ê²½ê³  ë¼ë²¨ (í˜„ë¬¼/ì£¼ì‹)
if whaleExitSignal
    label.new(bar_index, high + (high - low) * 0.2,
              text="âš ï¸ EXIT ê²½ê³ \nê³ ë˜ ë§¤ë„ ê°ì§€!",
              style=label.style_label_down,
              color=color.new(color.orange, 20),
              textcolor=color.white, size=size.small)

// ============================================
// ì •ë³´ í…Œì´ë¸”
// ============================================

var table infoTable = table.new(position.top_right, 2, 20, bgcolor=color.new(color.white, 10), border_width=1)

if barstate.islast
    table.clear(infoTable, 0, 0, 1, 19)

    // ëª¨ë“œ í‘œì‹œ
    modeColor = tradeMode == "ì„ ë¬¼" ? color.purple : tradeMode == "í˜„ë¬¼ì½”ì¸" ? color.orange : color.blue
    table.cell(infoTable, 0, 0, modeEmoji + " " + modeText, text_color=color.white, text_size=size.normal,
              bgcolor=color.new(modeColor, 20))
    table.cell(infoTable, 1, 0, "í´ë¡œë“œ25", text_color=color.white, text_size=size.normal,
              bgcolor=color.new(modeColor, 20))

    table.cell(infoTable, 0, 1, "í˜„ì¬ê°€", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 1, "$" + str.tostring(close, "#.##"), text_color=color.black, text_size=size.small)

    // TP/SL ì„¤ì •
    table.cell(infoTable, 0, 2, "TP1/TP2/SL", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(tpPct1, "#.#") + "/" + str.tostring(tpPct2, "#.#") + "/" + str.tostring(slPct, "#.#") + "%",
              text_color=color.black, text_size=size.small)

    // ì ìˆ˜
    table.cell(infoTable, 0, 3, "ğŸ“Š ì´ì ", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.gray, 30))
    table.cell(infoTable, 1, 3, str.tostring(totalScore, "#.#") + "/28",
              text_color=totalScore >= minSignalStrength ? color.green : color.gray, text_size=size.small)

    // ë¶ˆì¥ë‹¨íƒ€ì™•
    table.cell(infoTable, 0, 4, "ë¶ˆì¥ë‹¨íƒ€ì™•", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(bulJangScore, "#") + "/10",
              text_color=bulJangScore >= 5 ? color.green : color.gray, text_size=size.small)

    // í´ë¡œë“œ
    table.cell(infoTable, 0, 5, "í´ë¡œë“œ21", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(claude21Score, "#") + "/8",
              text_color=claude21Score >= 5 ? color.green : color.gray, text_size=size.small)

    // í•„í„°
    table.cell(infoTable, 0, 6, "í•„í„°", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 6, str.tostring(filterScore, "#") + "/6",
              text_color=filterScore >= 4 ? color.green : color.gray, text_size=size.small)

    // ê³ ë˜ ì ìˆ˜
    table.cell(infoTable, 0, 7, "ğŸ‹ ê³ ë˜", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 7, str.tostring(whaleScore, "#") + "/4",
              text_color=whaleScore >= 2 ? color.green : color.gray, text_size=size.small)

    // ADX (ì¶”ì„¸ ê°•ë„)
    table.cell(infoTable, 0, 8, "ğŸ“Š ADX", text_color=color.black, text_size=size.small)
    adxStatus = veryStrongTrend ? "ğŸ”¥ ë§¤ìš°ê°•í•¨" : strongTrend ? "ğŸ’ª ê°•í•¨" : trendExists ? "âœ… ì¶”ì„¸" : "âš ï¸ íš¡ë³´"
    adxColor = veryStrongTrend ? color.green : strongTrend ? color.blue : trendExists ? color.teal : color.red
    table.cell(infoTable, 1, 8, adxStatus + " (" + str.tostring(adx, "#.#") + ")",
              text_color=adxColor, text_size=size.small)

    // DI ë°©í–¥
    table.cell(infoTable, 0, 9, "DI ë°©í–¥", text_color=color.black, text_size=size.small)
    diStatus = bullishDI ? "ğŸŸ¢ ìƒìŠ¹" : "ğŸ”´ í•˜ë½"
    table.cell(infoTable, 1, 9, diStatus + " (+" + str.tostring(diPlus, "#.#") + "/-" + str.tostring(diMinus, "#.#") + ")",
              text_color=bullishDI ? color.green : color.red, text_size=size.small)

    // Open Interest (OI)
    table.cell(infoTable, 0, 10, "ğŸ“ˆ OI", text_color=color.black, text_size=size.small)
    oiStatus = oiPriceUp ? "ğŸš€ ê°•í•œìƒìŠ¹" : oiPriceDown ? "ğŸ“‰ ê°•í•œí•˜ë½" : oiShortSqueeze ? "ğŸ”¥ ìˆì²­ì‚°" : oiLongSqueeze ? "ğŸ’¥ ë¡±ì²­ì‚°" : oiIncreasing ? "â¬†ï¸ ì¦ê°€" : oiDecreasing ? "â¬‡ï¸ ê°ì†Œ" : "â¡ï¸ ì•ˆì •"
    oiColor = oiPriceUp or oiShortSqueeze ? color.green : oiPriceDown or oiLongSqueeze ? color.red : color.gray
    table.cell(infoTable, 1, 10, oiStatus + " (" + str.tostring(oiChange, "#.##") + "%)",
              text_color=oiColor, text_size=size.small)

    // Funding Rate (í€ë”©ë¹„)
    table.cell(infoTable, 0, 11, "ğŸ’° í€ë”©ë¹„", text_color=color.black, text_size=size.small)
    fundingStatus = fundingBearish ? "ğŸ”´ ë¡±ê³¼ì—´" : fundingBullish ? "ğŸŸ¢ ìˆê³¼ì—´" : "âšª ì¤‘ë¦½"
    fundingColor = fundingBearish ? color.red : fundingBullish ? color.green : color.gray
    table.cell(infoTable, 1, 11, fundingStatus + " (" + str.tostring(fundingRate * 100, "#.###") + "%)",
              text_color=fundingColor, text_size=size.small)

    // StochRSI
    table.cell(infoTable, 0, 12, "StochRSI", text_color=color.black, text_size=size.small)
    stochStatus = stochOversold ? "ğŸŸ¢ ê³¼ë§¤ë„" : stochOverbought ? "ğŸ”´ ê³¼ë§¤ìˆ˜" : "âšª ì¤‘ë¦½"
    table.cell(infoTable, 1, 12, stochStatus + " (" + str.tostring(stochK, "#.#") + ")",
              text_color=stochOversold ? color.green : stochOverbought ? color.red : color.gray, text_size=size.small)

    // BB
    table.cell(infoTable, 0, 13, "BB ìƒíƒœ", text_color=color.black, text_size=size.small)
    bbStatus = bbSqueeze ? "ğŸŸ¡ ìŠ¤í€´ì¦ˆ" : touchingBBLower ? "ğŸŸ¢ í•˜ë‹¨" : touchingBBUpper ? "ğŸ”´ ìƒë‹¨" : "âšª ì¤‘ë¦½"
    table.cell(infoTable, 1, 13, bbStatus,
              text_color=bbSqueeze ? color.yellow : touchingBBLower ? color.green : touchingBBUpper ? color.red : color.gray,
              text_size=size.small)

    // ê±°ë˜ëŸ‰ ë¹„ìœ¨
    table.cell(infoTable, 0, 14, "ê±°ë˜ëŸ‰ ë¹„ìœ¨", text_color=color.black, text_size=size.small)
    volColor = isInstitution ? color.purple : isWhale ? color.blue : color.gray
    volText = isInstitution ? "ğŸ³ ê¸°ê´€ " : isWhale ? "ğŸ‹ ê³ ë˜ " : ""
    table.cell(infoTable, 1, 14, volText + str.tostring(volumeRatio, "#.##") + "x",
              text_color=volColor, text_size=size.small)

    // ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥
    table.cell(infoTable, 0, 15, "ë§¤ìˆ˜ ì••ë ¥", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 15, str.tostring(buyPressure, "#.#") + "%",
              text_color=buyPressure > 60 ? color.green : buyPressure < 40 ? color.red : color.gray, text_size=size.small)

    // ì‹œì¥ êµ­ë©´
    table.cell(infoTable, 0, 16, "ì‹œì¥ êµ­ë©´", text_color=color.black, text_size=size.small)
    phaseText = isAccumulation ? "ğŸ“ˆ ëˆ„ì " : isDistribution ? "ğŸ“‰ ë¶„ì‚°" : "â¡ï¸ ì¤‘ë¦½"
    table.cell(infoTable, 1, 16, phaseText,
              text_color=isAccumulation ? color.green : isDistribution ? color.red : color.gray, text_size=size.small)

    // ìƒìœ„ íƒ€ì„í”„ë ˆì„ íŠ¸ë Œë“œ (ì„ ë¬¼: 1ì‹œê°„ / í˜„ë¬¼,ì£¼ì‹: ì¼ë´‰)
    string tfHighLabel = tradeMode == "ì„ ë¬¼" ? "1ì‹œê°„" : "ì¼ë´‰"
    table.cell(infoTable, 0, 17, tfHighLabel, text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 17, trend_15m_bullish ? "ğŸŸ¢ BULL" : trend_15m_bearish ? "ğŸ”´ BEAR" : "âšª FLAT",
              text_color=trend_15m_bullish ? color.green : trend_15m_bearish ? color.red : color.gray, text_size=size.small)

    // ì¤‘ê°„ íƒ€ì„í”„ë ˆì„ íŠ¸ë Œë“œ (ì„ ë¬¼: 15ë¶„ / í˜„ë¬¼,ì£¼ì‹: 4ì‹œê°„)
    string tfMidLabel = tradeMode == "ì„ ë¬¼" ? "15ë¶„ë´‰" : "4ì‹œê°„"
    table.cell(infoTable, 0, 18, tfMidLabel, text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 18, trend_5m_bullish ? "ğŸŸ¢ BULL" : trend_5m_bearish ? "ğŸ”´ BEAR" : "âšª FLAT",
              text_color=trend_5m_bullish ? color.green : trend_5m_bearish ? color.red : color.gray, text_size=size.small)

    // ìµœì¢… ì‹ í˜¸
    table.cell(infoTable, 0, 19, "ìµœì¢… ì‹ í˜¸", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.gray, 30))
    string finalText = longSignal_final ? "ğŸš€ LONG" : (shortSignal_final and tradeMode == "ì„ ë¬¼") ? "ğŸ”» SHORT" : whaleExitSignal ? "âš ï¸ EXIT" : "â¸ï¸ ëŒ€ê¸°"
    finalColor = longSignal_final ? color.green : (shortSignal_final and tradeMode == "ì„ ë¬¼") ? color.red : whaleExitSignal ? color.orange : color.gray
    table.cell(infoTable, 1, 19, finalText, text_color=finalColor, text_size=size.small)

// ============================================
// Webhook ì•Œë¦¼
// ============================================

if longSignal_final
    string jsonData = '{"version":"25",' +
          '"mode":"' + tradeMode + '",' +
          '"signal":"LONG",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"totalScore":"' + str.tostring(totalScore, "#.#") + '",' +
          '"tp1":"' + str.tostring(close * (1 + tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 + tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 - slPct/100), "#.##") + '",' +
          '"tp1_pct":"' + str.tostring(tpPct1, "#.#") + '",' +
          '"tp2_pct":"' + str.tostring(tpPct2, "#.#") + '",' +
          '"sl_pct":"' + str.tostring(slPct, "#.#") + '",' +
          '"volume_ratio":"' + str.tostring(volumeRatio, "#.##") + '",' +
          '"smart_money":"' + (isInstitution ? "INSTITUTION" : isWhale ? "WHALE" : "NONE") + '",' +
          '"buy_pressure":"' + str.tostring(buyPressure, "#.#") + '",' +
          '"market_phase":"' + (isAccumulation ? "ACCUMULATION" : isDistribution ? "DISTRIBUTION" : "NEUTRAL") + '",' +
          '"stochRSI_k":"' + str.tostring(stochK, "#.#") + '",' +
          '"bb_squeeze":"' + (bbSqueeze ? "true" : "false") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)

if shortSignal_final and tradeMode == "ì„ ë¬¼"
    string jsonData = '{"version":"25",' +
          '"mode":"ì„ ë¬¼",' +
          '"signal":"SHORT",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"totalScore":"' + str.tostring(totalScoreShort, "#.#") + '",' +
          '"tp1":"' + str.tostring(close * (1 - tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 - tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 + slPct/100), "#.##") + '",' +
          '"tp1_pct":"' + str.tostring(tpPct1, "#.#") + '",' +
          '"tp2_pct":"' + str.tostring(tpPct2, "#.#") + '",' +
          '"sl_pct":"' + str.tostring(slPct, "#.#") + '",' +
          '"volume_ratio":"' + str.tostring(volumeRatio, "#.##") + '",' +
          '"smart_money":"' + (institutionSelling ? "INSTITUTION" : whaleSelling ? "WHALE" : "NONE") + '",' +
          '"sell_pressure":"' + str.tostring(sellPressure, "#.#") + '",' +
          '"market_phase":"' + (isDistribution ? "DISTRIBUTION" : "NEUTRAL") + '",' +
          '"stochRSI_k":"' + str.tostring(stochK, "#.#") + '",' +
          '"bb_squeeze":"' + (bbSqueeze ? "true" : "false") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)

if whaleExitSignal
    string jsonData = '{"version":"25",' +
          '"mode":"' + tradeMode + '",' +
          '"signal":"EXIT",' +
          '"reason":"WHALE_SELLING",' +
          '"current_price":"' + str.tostring(close, "#.##") + '",' +
          '"volume_ratio":"' + str.tostring(volumeRatio, "#.##") + '",' +
          '"sell_pressure":"' + str.tostring(sellPressure, "#.#") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)
