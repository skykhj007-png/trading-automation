# 보조계정 진입 안 되는 문제 진단 가이드

## 🔍 문제 상황
TradingView에서 신호가 왔는데 보조계정에서 진입이 안 됨

---

## 📋 단계별 진단

### 1단계: Apps Script 실행 로그 확인 (가장 중요!)

**목적**: 웹훅이 실제로 도착했는지 확인

**방법**:
```
1. Apps Script 에디터 열기
2. 좌측 "실행" (시계 아이콘) 클릭
3. 최근 실행 내역 확인
```

**확인할 것**:
```
✅ "Webhook 수신" 메시지가 있는가?
✅ 타임스탬프가 신호 시간과 일치하는가?
✅ 신호 데이터가 정상인가? (LONG/SHORT, 진입가 등)
```

**케이스 A: "Webhook 수신" 메시지가 있음**
```
정보    Webhook 수신: 2025-12-21 18:45:23
정보    신호: LONG BTC-USDT
정보    진입: $97,500
```
→ 웹훅은 정상 도착함
→ **2단계로 이동**

**케이스 B: "Webhook 수신" 메시지가 없음**
```
로그에 아무것도 없거나 관련 없는 메시지만 있음
```
→ 웹훅이 도착하지 않음
→ **문제: TradingView 알림 설정**
→ [해결방법 A] 참조

---

### 2단계: 신호기록 시트 확인

**목적**: 신호가 시트에 저장되었는지 확인

**방법**:
```
1. 스프레드시트 열기
   https://docs.google.com/spreadsheets/d/1L6wn9fSLa-sThsYLViSOmbh6Em7jbnXXvfvCcvFMH80/edit

2. "신호기록" 시트 열기

3. 맨 아래 행 확인
```

**확인할 것**:
```
✅ 새 신호가 추가되었는가?
✅ 타임스탬프가 맞는가?
✅ 상태가 무엇인가?
```

**케이스 A: 새 신호가 있고 상태가 "대기중"**
```
2025-12-21 | 18:45:23 | BTC-USDT | LONG | ... | 대기중
```
→ 신호는 받았지만 포지션 생성 안 됨
→ **3단계로 이동**

**케이스 B: 새 신호가 있고 상태가 "중복"**
```
2025-12-21 | 18:45:23 | BTC-USDT | LONG | ... | 중복
```
→ 이미 해당 마켓에 포지션이 있어서 무시됨
→ **[해결방법 B] 참조**

**케이스 C: 새 신호가 없음**
```
마지막 신호가 몇 시간 또는 며칠 전
```
→ 신호가 시트에 저장 안 됨
→ Apps Script 오류
→ **[해결방법 C] 참조**

---

### 3단계: 트리거 실행 로그 확인

**목적**: syncBitgetPositions 트리거가 실행되었는지 확인

**방법**:
```
1. Apps Script 에디터
2. 좌측 "트리거" (시계 아이콘)
3. syncBitgetPositions 트리거 우측 ... 클릭
4. "실행 로그" 클릭
```

**확인할 것**:
```
✅ 신호 발생 후 1분 이내에 실행되었는가?
✅ 오류 메시지가 있는가?
```

**케이스 A: 트리거가 실행됨, 오류 없음**
```
정보    syncBitgetPositions 실행
정보    Bitget 포지션 확인 중...
```
→ 트리거는 정상 작동
→ **4단계로 이동**

**케이스 B: 트리거가 실행 안 됨**
```
신호 시간 이후 실행 내역 없음
```
→ 트리거가 꺼져있거나 삭제됨
→ **[해결방법 D] 참조**

**케이스 C: 트리거 실행됨, 오류 있음**
```
오류    Exception: ...
```
→ API 오류 또는 코드 오류
→ **4단계로 이동**

---

### 4단계: Bitget API 오류 확인

**목적**: Bitget 포지션 생성 시 오류가 있었는지 확인

**방법**:
```
1. Apps Script → 실행 → 실행 로그
2. syncBitgetPositions 실행 시간 확인
3. 오류 메시지 찾기
```

**자주 발생하는 오류**:

**오류 1: 잔고 부족**
```
오류    Insufficient balance
오류    잔고 부족
```
→ Bitget 계정에 USDT 부족
→ **[해결방법 E] 참조**

**오류 2: API 권한 오류**
```
오류    Invalid signature
오류    API key invalid
```
→ API 키/시크릿/패스프레이즈 오류
→ **[해결방법 F] 참조**

**오류 3: 포지션 생성 실패**
```
오류    Order failed
오류    Position creation failed
```
→ Bitget API 문제 또는 설정 오류
→ **[해결방법 G] 참조**

---

## 🔧 해결 방법

### [해결방법 A] 웹훅이 도착하지 않는 경우

**원인**: TradingView 알림 웹훅 URL 문제

**해결**:
```
1. Apps Script → 배포 → 새 배포
2. 유형: 웹 앱
3. 액세스: 모든 사용자 ← 중요!
4. 배포 → URL 복사 (/exec 확인)
5. TradingView 알림 편집
6. 웹훅 URL에 새 URL 붙여넣기
7. 저장
```

**테스트**:
```
브라우저에서 URL 열기:
https://script.google.com/macros/s/.../exec

결과:
{"status":"ok", "message":"V25 Universal Trading Bot..."}
```

---

### [해결방법 B] 중복 신호로 무시되는 경우

**원인**: 이미 해당 마켓에 포지션이 있음

**확인**:
```javascript
// Apps Script에서 실행
checkPosition()
```

**포지션이 있으면**:
```
BTC-USDT: LONG 포지션 홀딩 중
```
→ 정상 동작 (중복 진입 방지)

**포지션이 없는데 "중복"이면**:
```javascript
// 강제로 포지션 상태 초기화
forceClosePosition()

// 다시 진단
보조계정_자동매매_진단()
```

---

### [해결방법 C] 신호가 시트에 저장 안 되는 경우

**원인**: Apps Script 오류 또는 시트 ID 문제

**확인**:
```
Apps Script 로그에서 오류 메시지 확인
```

**시트 ID 확인**:
```javascript
// Code.gs 상단
var SHEET_CONFIG = {
  SPREADSHEET_ID: '1L6wn9fSLa-sThsYLViSOmbh6Em7jbnXXvfvCcvFMH80',  // 맞는지 확인!
  ...
};
```

**시트 재생성**:
```javascript
initSimulation()  // 실행
```

---

### [해결방법 D] 트리거가 실행 안 되는 경우

**원인**: 트리거가 삭제되었거나 꺼짐

**해결**:
```javascript
원클릭_전체설정()  // 트리거 재생성
```

**확인**:
```
Apps Script → 트리거
- syncBitgetPositions (1분마다)
- checkClosedPositions (1분마다)
2개 모두 있어야 함
```

---

### [해결방법 E] 잔고 부족

**원인**: Bitget 계정에 USDT 부족

**확인**:
```javascript
getBitgetFuturesBalance()  // 실행
```

**잔고 확인**:
```
선물 잔고: $13.22
```

**필요 금액**:
```
최소 진입 금액: 약 $10-20
(레버리지와 포지션 크기에 따라 다름)
```

**해결**:
- Bitget 계정에 USDT 입금
- 또는 현물에서 선물로 자산 이전

---

### [해결방법 F] API 키 오류

**원인**: API 키/시크릿/패스프레이즈 오류

**확인**:
```javascript
testBitgetConnection()  // 실행
```

**오류 나면**:
```javascript
// Code.gs에서 API 키 재확인
var BITGET_CONFIG = {
  API_KEY: 'bg_e3799f8c2c2599651938eb78caeaa3d4',
  SECRET_KEY: '3d09bdfdfa48c93f6a8ed26fdeac72140256de8e975d4993efaa4961f921e400',
  PASSPHRASE: 'ajdcjddl12',
  ...
};
```

**API 키 재발급**:
```
1. Bitget 로그인 (보조계정)
2. 프로필 → API 관리
3. 기존 API 삭제
4. 새 API 생성 (읽기 + 거래)
5. Code.gs에 새 키 입력
6. 저장 → 배포
```

---

### [해결방법 G] 포지션 생성 실패

**원인**: Bitget API 문제 또는 설정 오류

**확인**:
```
Apps Script 로그에서 정확한 오류 메시지 확인
```

**자주 발생하는 문제**:
1. 선물 계정 미활성화
2. 레버리지 설정 오류
3. 최소 주문 금액 미달

**해결**:
```
1. Bitget 선물 계정 활성화 확인
2. 레버리지 설정 확인 (10x-100x)
3. 최소 $10 이상 잔고 확인
```

---

## 🔍 상세 진단 실행

**자동 진단 함수**:
```javascript
보조계정_자동매매_진단()
```

이 함수가:
- 모든 시스템 체크
- 문제 발견
- 해결 방법 제시

---

## 📞 긴급 체크리스트

신호가 왔는데 진입 안 되면 **즉시** 확인:

```
□ Apps Script 로그: "Webhook 수신" 있는가?
  └─ 없으면 → TradingView 웹훅 URL 재설정

□ 신호기록 시트: 새 신호 있는가?
  └─ 없으면 → Apps Script 오류, 로그 확인

□ 신호 상태: "대기중"인가 "중복"인가?
  └─ 중복이면 → 이미 포지션 있음 (정상)
  └─ 대기중이면 → 트리거 확인

□ 트리거: syncBitgetPositions 실행되었는가?
  └─ 안 됨 → 원클릭_전체설정() 실행

□ Bitget 잔고: 충분한가?
  └─ 부족 → 입금 필요

□ API 키: 정상인가?
  └─ 오류 → testBitgetConnection() 실행
```

---

## 💡 가장 흔한 원인 TOP 3

### 1. 웹훅 URL 문제 (50%)
```
해결: TradingView 알림 편집 → 새 URL 설정
```

### 2. 잔고 부족 (30%)
```
해결: Bitget 계정 입금
현재 잔고: $13.22
```

### 3. 중복 신호 (20%)
```
해결: 정상 동작 (이미 포지션 있음)
확인: checkPosition() 실행
```

---

## 🎯 완벽한 테스트 흐름

```
1. 보조계정_자동매매_진단() 실행
   모든 시스템 ✅ 확인

2. TradingView 신호 대기
   1분봉으로 빠른 테스트

3. 신호 발생 즉시:
   - Apps Script 로그 확인 ("Webhook 수신")
   - 신호기록 시트 확인 (새 행 추가)

4. 1분 후:
   - syncBitgetPositions 실행 확인
   - Bitget 포지션 확인
   - V25 자동매매일지 확인

5. ✅ 진입 완료!
```
