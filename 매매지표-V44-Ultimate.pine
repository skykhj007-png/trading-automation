//@version=5
indicator("V42 Complete - ICT + Harmonic + ì •í™•ì„±í•„í„° (2026.01.27)", overlay=true, max_labels_count=500, max_lines_count=500, max_boxes_count=300)

// ============================================
// V42 Complete - ëª¨ë“  ê¸°ëŠ¥ í†µí•© ì™„ì „íŒ
//
// â˜…â˜…â˜… V40 ICT ì „ì²´ ê¸°ëŠ¥ â˜…â˜…â˜…
// 1. ICT Killzones (ê¸°ê´€ ë§¤ë§¤ ì‹œê°„ëŒ€)
// 2. Liquidity Sweep (ìœ ë™ì„± ìŠ¤ìœ•)
// 3. CVD ì •ë°€ë„ (Reset + Normalization)
// 4. ê³ ë˜ ê°ì§€ (ëŒ€ëŸ‰ ë§¤ìˆ˜/ë§¤ë„)
// 5. 30ì  ì ìˆ˜ ì‹œìŠ¤í…œ
// 6. ë©€í‹°TF ë¶„ì„ (1H/4H/ì¼ë´‰)
// 7. ì§€ì§€/ì €í•­ ë ˆë²¨
// 8. ì´ì¹˜ëª¨ì¿  êµ¬ë¦„
// 9. Smart Trail / BOS / CHoCH
// 10. Delta / Smart OBV
//
// â˜…â˜…â˜… V41 í•˜ëª¨ë‹‰ íŒ¨í„´ â˜…â˜…â˜…
// - Gartley, Bat, Crab, Butterfly
// - Cypher, Shark, 707, AB=CD
// - PRZ ìë™ ê³„ì‚° + TP/SL
// - RSI BAMM
//
// â˜…â˜…â˜… ì •í™•ì„± í•„í„° (ì‹ ê·œ) â˜…â˜…â˜…
// - í’ˆì§ˆ ì ìˆ˜ í•„í„°
// - ì¶”ì„¸/ê±°ë˜ëŸ‰/RSI í™•ì¸
// - ì»¨í”Œë£¨ì–¸ìŠ¤ ì‹œìŠ¤í…œ
// ============================================

// ============================================
// ê¸°ë³¸ ì„¤ì •
// ============================================

tradeMode = input.string("í˜„ë¬¼", title="ê±°ë˜ ëª¨ë“œ", options=["ì„ ë¬¼", "í˜„ë¬¼", "ì£¼ì‹"], group="ê¸°ë³¸ ì„¤ì •", tooltip="í˜„ë¬¼/ì£¼ì‹: SHORT ì‹œê·¸ë„ ìˆ¨ê¹€")
displayMode = input.string("ìµœì†Œí™”", title="í™”ë©´ ëª¨ë“œ", options=["ì „ì²´", "ìµœì†Œí™”", "í…Œì´ë¸”ë§Œ"], group="ê¸°ë³¸ ì„¤ì •", tooltip="ìµœì†Œí™”: Smart Trail + ì‹œê·¸ë„ë§Œ í‘œì‹œ")
signalMode = input.string("STRONG ì´ìƒ", title="ì‹œê·¸ë„ í‘œì‹œ", options=["ì „ì²´", "STRONG ì´ìƒ", "SUPERë§Œ"], group="ê¸°ë³¸ ì„¤ì •", tooltip="ì‹œê·¸ë„ í•„í„°ë§ ìˆ˜ì¤€")

// ê±°ë˜ ëª¨ë“œì— ë”°ë¥¸ ì„¤ì •
bool isFutures = tradeMode == "ì„ ë¬¼"
bool showShortSignals = isFutures  // ì„ ë¬¼ë§Œ SHORT í‘œì‹œ

// í™”ë©´ ëª¨ë“œì— ë”°ë¥¸ ì„¤ì •
bool isMinimalMode = displayMode == "ìµœì†Œí™”"
bool isTableOnlyMode = displayMode == "í…Œì´ë¸”ë§Œ"
bool showVisuals = not isTableOnlyMode

// ============================================
// í‘œì‹œ ì„¤ì •
// ============================================

showSR = input.bool(true, title="ì§€ì§€/ì €í•­ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showHTFTrend = input.bool(true, title="HTF ì¶”ì„¸ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •")
showEMA = input.bool(false, title="EMA í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showBB = input.bool(false, title="ë³¼ë¦°ì €ë°´ë“œ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showDivergence = input.bool(false, title="ë‹¤ì´ë²„ì „ìŠ¤ í‘œì‹œ âš ï¸", group="í‘œì‹œ ì„¤ì •", tooltip="âš ï¸ ì°¨íŠ¸ ë§ˆì»¤ ë¹„í™œì„±í™”ë¨ (Pine Script plot ì œí•œ 64ê°œ ì´ˆê³¼). ì ìˆ˜ ì‹œìŠ¤í…œì—ëŠ” ë°˜ì˜ë¨. ì•ŒëŒìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥.") and not isMinimalMode and showVisuals
showInfoTable = input.bool(true, title="ì •ë³´ í…Œì´ë¸”", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode
showMiniPanel = input.bool(true, title="ë¯¸ë‹ˆ íŒ¨ë„ (ìµœì†Œí™” ëª¨ë“œ)", group="í‘œì‹œ ì„¤ì •")  // ìµœì†Œí™” ëª¨ë“œìš© ê°„ë‹¨ íŒ¨ë„
showSignalLabel = input.bool(false, title="ì‹œê·¸ë„ ë¼ë²¨", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode

volThreshold = input.float(1.5, title="ê±°ë˜ëŸ‰ ê¸‰ì¦ ë°°ìˆ˜", minval=1.0, maxval=5.0, step=0.1, group="ê±°ë˜ëŸ‰ ì„¤ì •")
volHighThreshold = input.float(2.5, title="ê±°ë˜ëŸ‰ í­ì¦ ë°°ìˆ˜", minval=1.5, maxval=10.0, step=0.5, group="ê±°ë˜ëŸ‰ ì„¤ì •")

// í”¼ë´‡ ì„¤ì •
pivotLeft = input.int(5, title="í”¼ë´‡ ì¢Œì¸¡ ë°”", minval=2, maxval=20, group="í”¼ë´‡ ì„¤ì •")
pivotRight = input.int(2, title="í”¼ë´‡ ìš°ì¸¡ ë°”", minval=1, maxval=10, group="í”¼ë´‡ ì„¤ì •")

// ============================================
// V40 ì‹ ê·œ ê¸°ëŠ¥ ì„¤ì •
// ============================================

// 1. ì¿¨ë‹¤ìš´ ì‹œìŠ¤í…œ
enableCooldown = input.bool(true, title="ì‹ í˜¸ ì¿¨ë‹¤ìš´ í™œì„±í™”", group="V40 í•„í„°", tooltip="ì‹ í˜¸ í›„ Në´‰ ë™ì•ˆ ì¶”ê°€ ì‹ í˜¸ ì–µì œ")
cooldownBars = input.int(8, title="ì¿¨ë‹¤ìš´ ë°” ìˆ˜", minval=1, maxval=20, group="V40 í•„í„°", tooltip="15ë¶„ë´‰ ê¸°ì¤€ 8ë´‰ = 2ì‹œê°„ ê°„ê²©")
dynamicCooldown = input.bool(true, title="ë™ì  ì¿¨ë‹¤ìš´ (ATR ê¸°ë°˜)", group="V40 í•„í„°", tooltip="ë³€ë™ì„± ë†’ìœ¼ë©´ ì¿¨ë‹¤ìš´ ë‹¨ì¶•")

// 2. ë³¼ë¥¨ í•„í„°
enableVolumeFilter = input.bool(true, title="ë³¼ë¥¨ í•„í„° í™œì„±í™”", group="V40 í•„í„°", tooltip="í‰ê·  ê±°ë˜ëŸ‰ ì´ìƒì¼ ë•Œë§Œ ì‹ í˜¸")
volumeAvgLength = input.int(20, title="ë³¼ë¥¨ í‰ê·  ê¸°ê°„", minval=5, maxval=100, group="V40 í•„í„°")
minVolumeRatio = input.float(1.5, title="ìµœì†Œ ë³¼ë¥¨ ë°°ìˆ˜", minval=0.5, maxval=3.0, step=0.1, group="V40 í•„í„°", tooltip="1.5ë°° ì´ìƒ ê±°ë˜ëŸ‰ì¼ ë•Œë§Œ ì‹ í˜¸")

// 3. ì‹œê°„ í•„í„° (ë¹„íš¨ìœ¨ ì„¸ì…˜ ì œì™¸)
enableTimeFilter = input.bool(true, title="ì‹œê°„ í•„í„° í™œì„±í™”", group="V40 í•„í„°", tooltip="ì•„ì‹œì•„-ìœ ëŸ½-ë¯¸êµ­ ì „í™˜ ì‹œê°„ ì œì™¸")
excludeAsiaEU = input.bool(true, title="ì•„ì‹œì•„-ìœ ëŸ½ ì „í™˜ ì œì™¸ (08:00-10:00 UTC)", group="V40 í•„í„°")
excludeEUUS = input.bool(true, title="ìœ ëŸ½-ë¯¸êµ­ ì „í™˜ ì œì™¸ (14:00-16:00 UTC)", group="V40 í•„í„°")

// 4. CVD Reset ì˜µì…˜
cvdResetMode = input.string("ì¼ë´‰", title="CVD Reset ëª¨ë“œ", options=["ì—†ìŒ", "ì¼ë´‰", "ì„¸ì…˜", "ì£¼ë´‰"], group="V40 CVD ê°œì„ ", tooltip="ì¼ë´‰ ë¦¬ì…‹ ê¶Œì¥ - ë” ì •í™•í•œ ë‹¤ì´ë²„ì „ìŠ¤ ê°ì§€")
showCVDNormalized = input.bool(true, title="CVD ì •ê·œí™” í‘œì‹œ", group="V40 CVD ê°œì„ ", tooltip="ê³ ê°€ ìì‚°ì—ì„œ ì •í™•í•œ CVD")

// 5. BOS/CHoCH ê°œì„  í•„í„°
bosVolumeConfirm = input.bool(true, title="BOS ê±°ë˜ëŸ‰ í™•ì¸", group="V40 BOS ê°œì„ ", tooltip="BOS ì‹œ ê±°ë˜ëŸ‰ ì¦ê°€ í•„ìˆ˜")
bosMinVolumeRatio = input.float(1.3, title="BOS ìµœì†Œ ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=1.0, maxval=3.0, step=0.1, group="V40 BOS ê°œì„ ")
bosStrongClose = input.bool(true, title="BOS ê°•í•œ ì¢…ê°€ í™•ì¸", group="V40 BOS ê°œì„ ", tooltip="Swing ë„˜ì–´ ê²°ì •ì  ì¢…ê°€ í•„ìš”")

// 6. ë™ì  íŒŒë¼ë¯¸í„°
enableDynamicParams = input.bool(true, title="ë™ì  íŒŒë¼ë¯¸í„° í™œì„±í™”", group="V40 ë™ì  ì¡°ì •", tooltip="ATR ê¸°ë°˜ ìë™ ì¡°ì •")
atrPeriod = input.int(14, title="ATR ê¸°ê°„", minval=5, maxval=50, group="V40 ë™ì  ì¡°ì •")
highVolThreshold = input.float(1.5, title="ê³ ë³€ë™ì„± ì„ê³„ê°’", minval=1.0, maxval=3.0, step=0.1, group="V40 ë™ì  ì¡°ì •")
lowVolThreshold = input.float(0.5, title="ì €ë³€ë™ì„± ì„ê³„ê°’", minval=0.1, maxval=1.0, step=0.1, group="V40 ë™ì  ì¡°ì •")

// ============================================
// V40+ ICT Killzones (ê¸°ê´€ ë§¤ë§¤ ì‹œê°„ëŒ€)
// ============================================
enableKillzones = input.bool(true, title="Killzones í•„í„° í™œì„±í™”", group="V40+ Killzones", tooltip="ê¸°ê´€ ë§¤ë§¤ ì‹œê°„ëŒ€ì—ë§Œ ì‹ í˜¸ ë°œìƒ")
showKillzoneBoxes = input.bool(false, title="Killzone ë°•ìŠ¤ í‘œì‹œ", group="V40+ Killzones", tooltip="ì°¨íŠ¸ì— ì‹œê°„ëŒ€ ë°•ìŠ¤ í‘œì‹œ")
kzLondonOpen = input.bool(true, title="London Open (08:00-10:00 UTC)", group="V40+ Killzones")
kzNYOpen = input.bool(true, title="NY Open (13:00-15:00 UTC)", group="V40+ Killzones")
kzLondonClose = input.bool(true, title="London Close (15:00-17:00 UTC)", group="V40+ Killzones")
kzAsianOpen = input.bool(false, title="Asian Open (00:00-02:00 UTC)", group="V40+ Killzones", tooltip="ë³€ë™ì„± ë‚®ìŒ - ì„ íƒì ")

// ============================================
// V40+ Liquidity Sweep (ìœ ë™ì„± ìŠ¤ìœ•)
// ============================================
enableLiqSweep = input.bool(true, title="Liquidity Sweep í™œì„±í™”", group="V40+ Liquidity", tooltip="ìŠ¤íƒ‘ë¡œìŠ¤ ì‚¬ëƒ¥ í›„ ë°˜ì „ ê°ì§€")
showLiqSweepLabel = input.bool(true, title="Sweep ë¼ë²¨ í‘œì‹œ", group="V40+ Liquidity")
liqSweepLookback = input.int(20, title="Sweep íƒìƒ‰ ë²”ìœ„", minval=5, maxval=50, group="V40+ Liquidity")
liqSweepMinWick = input.float(0.5, title="ìµœì†Œ ê¼¬ë¦¬ ë¹„ìœ¨ (%)", minval=0.1, maxval=2.0, step=0.1, group="V40+ Liquidity", tooltip="ìº”ë“¤ ê¼¬ë¦¬ê°€ ì´ ë¹„ìœ¨ ì´ìƒì´ë©´ Sweep")

// ============================================
// V40+ ì²­ì‚° ë§¤ë¬¼ëŒ€ (Liquidation Levels)
// ============================================
enableLiqLevels = input.bool(true, title="ì²­ì‚° ë ˆë²¨ í‘œì‹œ âš ï¸", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€", tooltip="âš ï¸ ì²­ì‚° ìŠ¤ìœ• ë§ˆì»¤ ë¹„í™œì„±í™”ë¨ (Pine Script plot ì œí•œ). ë¼ì¸/ë¼ë²¨ì€ ì •ìƒ í‘œì‹œ. ìŠ¤ìœ• ì•ŒëŒìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥.")
showLongLiq = input.bool(true, title="ë¡± ì²­ì‚° ë ˆë²¨ (í•˜ë½ ì‹œ)", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€")
showShortLiq = input.bool(true, title="ìˆ ì²­ì‚° ë ˆë²¨ (ìƒìŠ¹ ì‹œ)", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€")
showLiqLabels = input.bool(true, title="ì²­ì‚° ë¼ë²¨ í‘œì‹œ", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€")
showLiqHighRisk = input.bool(true, title="ê³ ìœ„í—˜ êµ¬ê°„ ê°•ì¡° (50x+)", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€")
liqShow10x = input.bool(true, title="10x ë ˆë²¨", inline="liqLev1", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€")
liqShow25x = input.bool(true, title="25x ë ˆë²¨", inline="liqLev1", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€")
liqShow50x = input.bool(true, title="50x ë ˆë²¨", inline="liqLev2", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€")
liqShow100x = input.bool(true, title="100x ë ˆë²¨", inline="liqLev2", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€")
liqMaintenanceMargin = input.float(0.5, title="ìœ ì§€ë§ˆì§„ìœ¨ (%)", minval=0.1, maxval=2.0, step=0.1, group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€") / 100
liqSweepBoost = input.bool(true, title="ì²­ì‚° ìŠ¤ìœ• ì‹œ ì‹ í˜¸ ê°•í™”", group="V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€", tooltip="ì²­ì‚° êµ¬ê°„ ëŒíŒŒ í›„ ë°˜ì „ ì‹œ STRONGâ†’SUPER ìŠ¹ê²©")

// ============================================
// V40+ ì‹¤ì œ ì²­ì‚° ë§¤ë¬¼ëŒ€ (Coinglass ê¸°ë°˜ ê³ ì • ë ˆë²¨)
// ============================================
enableRealLiqLevels = input.bool(true, title="ì‹¤ì œ ì²­ì‚° ë§¤ë¬¼ëŒ€ í‘œì‹œ âš ï¸", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€", tooltip="âš ï¸ ìŠ¤ìœ• ë§ˆì»¤ ë¹„í™œì„±í™”ë¨ (Pine Script plot ì œí•œ). ë¼ì¸/ë¼ë²¨ì€ ì •ìƒ í‘œì‹œ. ìŠ¤ìœ• ì•ŒëŒìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥.")
showRealLiqLabels = input.bool(true, title="ë¼ë²¨ í‘œì‹œ", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")

// ë¡± ì²­ì‚° ì§‘ì¤‘ êµ¬ê°„ (ê°€ê²© í•˜ë½ ì‹œ ëŒ€ëŸ‰ ì²­ì‚°)
realLongLiq1Enable = input.bool(true, title="ë¡±ì²­ì‚°1 í™œì„±í™”", inline="rl1", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realLongLiq1 = input.float(90000, title="ê°€ê²©", inline="rl1", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€", tooltip="ëŒ€ëŸ‰ ë¡± ì²­ì‚° ì§‘ì¤‘ êµ¬ê°„")
realLongLiq1Label = input.string("ë¡± ëŒ€ëŸ‰ì²­ì‚°", title="ë¼ë²¨", inline="rl1", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")

realLongLiq2Enable = input.bool(true, title="ë¡±ì²­ì‚°2 í™œì„±í™”", inline="rl2", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realLongLiq2 = input.float(93000, title="ê°€ê²©", inline="rl2", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€", tooltip="ë¡± ì²­ì‚° ì§€ì§€ì„ ")
realLongLiq2Label = input.string("ë¡± ì§€ì§€ì„ ", title="ë¼ë²¨", inline="rl2", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")

realLongLiq3Enable = input.bool(false, title="ë¡±ì²­ì‚°3 í™œì„±í™”", inline="rl3", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realLongLiq3 = input.float(88000, title="ê°€ê²©", inline="rl3", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realLongLiq3Label = input.string("ë¡± ì¶”ê°€", title="ë¼ë²¨", inline="rl3", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")

// ìˆ ì²­ì‚° ì§‘ì¤‘ êµ¬ê°„ (ê°€ê²© ìƒìŠ¹ ì‹œ ëŒ€ëŸ‰ ì²­ì‚°)
realShortLiq1Enable = input.bool(true, title="ìˆì²­ì‚°1 í™œì„±í™”", inline="rs1", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realShortLiq1 = input.float(95000, title="ê°€ê²©", inline="rs1", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€", tooltip="ëŒ€ëŸ‰ ìˆ ì²­ì‚° ì €í•­ êµ¬ê°„")
realShortLiq1Label = input.string("ìˆ ëŒ€ëŸ‰ì²­ì‚°", title="ë¼ë²¨", inline="rs1", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")

realShortLiq2Enable = input.bool(true, title="ìˆì²­ì‚°2 í™œì„±í™”", inline="rs2", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realShortLiq2 = input.float(100000, title="ê°€ê²©", inline="rs2", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€", tooltip="ì‹¬ë¦¬ì  ì €í•­ + ìˆ ì²­ì‚°")
realShortLiq2Label = input.string("ìˆ $100K", title="ë¼ë²¨", inline="rs2", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")

realShortLiq3Enable = input.bool(false, title="ìˆì²­ì‚°3 í™œì„±í™”", inline="rs3", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realShortLiq3 = input.float(105000, title="ê°€ê²©", inline="rs3", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realShortLiq3Label = input.string("ìˆ ì¶”ê°€", title="ë¼ë²¨", inline="rs3", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")

// ì‹¤ì œ ì²­ì‚° ë§¤ë¬¼ëŒ€ ìƒ‰ìƒ
realLongLiqColor = input.color(color.new(#FF5252, 20), title="ë¡± ì²­ì‚° ìƒ‰ìƒ", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")
realShortLiqColor = input.color(color.new(#4CAF50, 20), title="ìˆ ì²­ì‚° ìƒ‰ìƒ", group="V40+ ì‹¤ì œ ì²­ì‚°ë§¤ë¬¼ëŒ€")

// ============================================
// SMC (Smart Money Concepts) ì„¤ì •
// ============================================
showSMC = input.bool(true, title="SMC ê¸°ëŠ¥ í™œì„±í™”", group="SMC ì„¤ì •") and showVisuals
showOrderBlocks = input.bool(false, title="Order Blocks í‘œì‹œ", group="SMC ì„¤ì •") and not isMinimalMode  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showFVG = input.bool(false, title="Fair Value Gaps í‘œì‹œ", group="SMC ì„¤ì •")  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showBOS = input.bool(false, title="BOS/CHoCH í‘œì‹œ", group="SMC ì„¤ì •")  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showBOSBox = input.bool(false, title="BOS ë°•ìŠ¤ í‘œì‹œ", group="SMC ì„¤ì •")  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showStructureLabels = input.bool(false, title="êµ¬ì¡° ë¼ë²¨ (HH/HL/LH/LL)", group="SMC ì„¤ì •")  // ê¸°ë³¸ê°’ OFF (ê¹”ë”í•˜ê²Œ)
showSmartTrail = input.bool(true, title="Smart Trail í‘œì‹œ", group="SMC ì„¤ì •")  // í•µì‹¬ - í•­ìƒ í‘œì‹œ
showLiquidityLevels = input.bool(false, title="Liquidity Levels í‘œì‹œ", group="SMC ì„¤ì •") and not isMinimalMode  // ê¸°ë³¸ê°’ OFF
showEMAAngle = input.bool(true, title="EMA ê°ë„ ìƒ‰ìƒ", group="SMC ì„¤ì •")  // EMA ê°ë„ë³„ ìƒ‰ìƒ

obLookback = input.int(20, title="Order Block íƒìƒ‰ ë²”ìœ„", minval=5, maxval=100, group="SMC ì„¤ì •")
fvgMinSize = input.float(0.1, title="FVG ìµœì†Œ í¬ê¸° (%)", minval=0.01, maxval=1.0, step=0.01, group="SMC ì„¤ì •")
swingLength = input.int(10, title="Swing íƒìƒ‰ ê¸¸ì´", minval=3, maxval=50, group="SMC ì„¤ì •")
emaAngleLength = input.int(14, title="EMA ê°ë„ ê¸¸ì´", minval=5, maxval=50, group="SMC ì„¤ì •")
emaAngleThreshold = input.float(1.0, title="EMA ê°ë„ ì„ê³„ê°’", minval=0.1, maxval=5.0, step=0.1, group="SMC ì„¤ì •")

// ê³ ë˜ ê°ì§€ ì„¤ì •
showWhale = input.bool(true, title="ê³ ë˜ ë§¤ìˆ˜/ë§¤ë„ í‘œì‹œ", group="SMC ì„¤ì •")
whaleVolMultiplier = input.float(3.0, title="ê³ ë˜ ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=2.0, maxval=10.0, step=0.5, group="SMC ì„¤ì •")
whalePriceMove = input.float(0.5, title="ê³ ë˜ ê°€ê²© ë³€ë™ (%)", minval=0.1, maxval=2.0, step=0.1, group="SMC ì„¤ì •")

// ============================================
// ì‹¬ë¦¬ì  ë§¤ë§¤ êµ¬ê°„ ì„¤ì •
// ============================================
showPsychLevels = input.bool(true, title="ì‹¬ë¦¬ì  êµ¬ê°„ í‘œì‹œ", group="ì‹¬ë¦¬ì  êµ¬ê°„", tooltip="âš ï¸ í”Œë¡¯ ì œí•œ(64ê°œ)ìœ¼ë¡œ ì°¨íŠ¸ ë§ˆì»¤(ë§¤ìˆ˜/ë§¤ë„ êµ¬ê°„ ì‚¼ê°í˜•)ëŠ” ë¹„í™œì„±í™”ë¨. ë°°ê²½ìƒ‰ í‘œì‹œëŠ” ì •ìƒ ì‘ë™.")
showRoundNumbers = input.bool(true, title="ë¼ìš´ë“œ ë„˜ë²„ í‘œì‹œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showFearGreed = input.bool(true, title="ê³µí¬/íƒìš• ì§€í‘œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showVolProfile = input.bool(true, title="ë³¼ë¥¨ ì§‘ì¤‘ êµ¬ê°„", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showFibLevels = input.bool(false, title="í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showKeyLevels = input.bool(true, title="ì£¼ìš” ê³ ì /ì €ì  í‘œì‹œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
showPOC = input.bool(true, title="POC (ê±°ë˜ëŸ‰ ì§‘ì¤‘) í‘œì‹œ", group="ì‹¬ë¦¬ì  êµ¬ê°„")
roundNumInterval = input.int(5000, title="ë¼ìš´ë“œ ë„˜ë²„ ê°„ê²© ($)", minval=100, maxval=50000, step=100, group="ì‹¬ë¦¬ì  êµ¬ê°„")
fibLookback = input.int(100, title="í”¼ë³´ë‚˜ì¹˜ íƒìƒ‰ ë²”ìœ„", minval=20, maxval=500, group="ì‹¬ë¦¬ì  êµ¬ê°„")
keyLevelLookback = input.int(50, title="ì£¼ìš” ë ˆë²¨ íƒìƒ‰ ë²”ìœ„", minval=20, maxval=200, group="ì‹¬ë¦¬ì  êµ¬ê°„")
pocLookback = input.int(50, title="POC íƒìƒ‰ ë²”ìœ„", minval=20, maxval=200, group="ì‹¬ë¦¬ì  êµ¬ê°„")

// ============================================
// ì¼ëª©ê· í˜•í‘œ (Ichimoku Cloud) ì„¤ì •
// ============================================
showIchimoku = input.bool(true, title="ì¼ëª© êµ¬ë¦„ í‘œì‹œ", group="ì¼ëª©ê· í˜•í‘œ")
ichimokuFilter = input.bool(true, title="ì¼ëª© êµ¬ë¦„ í•„í„° í™œì„±í™”", group="ì¼ëª©ê· í˜•í‘œ", tooltip="êµ¬ë¦„ ìœ„=ë¡±ë§Œ, êµ¬ë¦„ ì•„ë˜=ìˆë§Œ")
tenkanPeriod = input.int(20, title="ì „í™˜ì„  ê¸°ê°„", minval=1, maxval=50, group="ì¼ëª©ê· í˜•í‘œ", tooltip="ì•”í˜¸í™”í 24/7 ì‹œì¥: 20 (ê¸°ì¡´ 9)")
kijunPeriod = input.int(60, title="ê¸°ì¤€ì„  ê¸°ê°„", minval=1, maxval=100, group="ì¼ëª©ê· í˜•í‘œ", tooltip="ì•”í˜¸í™”í 24/7 ì‹œì¥: 60 (ê¸°ì¡´ 26)")
senkouBPeriod = input.int(120, title="ì„ í–‰ìŠ¤íŒ¬B ê¸°ê°„", minval=1, maxval=200, group="ì¼ëª©ê· í˜•í‘œ", tooltip="ì•”í˜¸í™”í 24/7 ì‹œì¥: 120 (ê¸°ì¡´ 52)")
displacement = input.int(30, title="êµ¬ë¦„ ì´ë™", minval=1, maxval=100, group="ì¼ëª©ê· í˜•í‘œ", tooltip="ì•”í˜¸í™”í 24/7 ì‹œì¥: 30 (ê¸°ì¡´ 26)")

// ============================================
// ì—˜ë¦¬ì—‡ íŒŒë™ (Elliott Wave) ì„¤ì •
// ============================================
showElliottWave = input.bool(true, title="ì—˜ë¦¬ì—‡ íŒŒë™ í™œì„±í™”", group="ì—˜ë¦¬ì—‡ íŒŒë™")
showEWLabels = input.bool(true, title="íŒŒë™ ë ˆì´ë¸” í‘œì‹œ", group="ì—˜ë¦¬ì—‡ íŒŒë™")
showEWFib = input.bool(true, title="í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ í‘œì‹œ", group="ì—˜ë¦¬ì—‡ íŒŒë™")
showEWZones = input.bool(true, title="ë§¤ë§¤ êµ¬ê°„ í‘œì‹œ", group="ì—˜ë¦¬ì—‡ íŒŒë™", tooltip="Wave 2 ê³¨ë“ ì¡´ (61.8~78.6%) í‘œì‹œ")
ewSwingLength = input.int(10, title="ìŠ¤ìœ™ íƒìƒ‰ ê¸¸ì´", minval=5, maxval=50, group="ì—˜ë¦¬ì—‡ íŒŒë™")
ewMinWaves = input.int(5, title="ìµœì†Œ íŒŒë™ ìˆ˜", minval=3, maxval=10, group="ì—˜ë¦¬ì—‡ íŒŒë™")
ewFibTolerance = input.float(5.0, title="í”¼ë³´ë‚˜ì¹˜ í—ˆìš© ì˜¤ì°¨ (%)", minval=1.0, maxval=20.0, step=1.0, group="ì—˜ë¦¬ì—‡ íŒŒë™")

// ì—˜ë¦¬ì—‡ íŒŒë™ ìƒ‰ìƒ
ewImpulseColor = input.color(color.new(color.blue, 0), title="Impulse ìƒ‰ìƒ", group="ì—˜ë¦¬ì—‡ íŒŒë™")
ewCorrectiveColor = input.color(color.new(color.orange, 0), title="Corrective ìƒ‰ìƒ", group="ì—˜ë¦¬ì—‡ íŒŒë™")
ewGoldenZoneColor = input.color(color.new(color.green, 80), title="ê³¨ë“ ì¡´ ìƒ‰ìƒ", group="ì—˜ë¦¬ì—‡ íŒŒë™")

// ============================================
// â˜…â˜…â˜… í•˜ëª¨ë‹‰ íŒ¨í„´ ì„¤ì • (V42 ì‹ ê·œ) â˜…â˜…â˜…
// ============================================
showHarmonic = input.bool(true, title="í•˜ëª¨ë‹‰ íŒ¨í„´ í‘œì‹œ", group="í•˜ëª¨ë‹‰ íŒ¨í„´")
showHarmonicLabels = input.bool(true, title="íŒ¨í„´ ë¼ë²¨", group="í•˜ëª¨ë‹‰ íŒ¨í„´")
showPRZ = input.bool(true, title="PRZ êµ¬ê°„", group="í•˜ëª¨ë‹‰ íŒ¨í„´")
showTPSL = input.bool(true, title="TP/SL ë ˆë²¨", group="í•˜ëª¨ë‹‰ íŒ¨í„´")
harmonicFibTolerance = input.float(5.0, title="í”¼ë³´ë‚˜ì¹˜ í—ˆìš© ì˜¤ì°¨ (%)", minval=1.0, maxval=15.0, group="í•˜ëª¨ë‹‰ íŒ¨í„´")
harmonicSwingLen = input.int(10, title="ìŠ¤ìœ™ ê¸¸ì´", minval=3, maxval=30, group="í•˜ëª¨ë‹‰ íŒ¨í„´")

// ê°œë³„ íŒ¨í„´ ON/OFF
showGartley = input.bool(true, title="Gartley", inline="hpat1", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showBat = input.bool(true, title="Bat", inline="hpat1", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showCrab = input.bool(true, title="Crab", inline="hpat1", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showButterfly = input.bool(true, title="Butterfly", inline="hpat2", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showCypher = input.bool(true, title="Cypher", inline="hpat2", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
show707 = input.bool(true, title="707", inline="hpat2", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showShark = input.bool(true, title="Shark", inline="hpat3", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showABCD = input.bool(true, title="AB=CD", inline="hpat3", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showDeepGartley = input.bool(true, title="Deep Gartley", inline="hpat4", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showDeepCrab = input.bool(true, title="Deep Crab", inline="hpat4", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showAltBat = input.bool(true, title="Alt Bat", inline="hpat4", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")
showFiveZero = input.bool(true, title="5-0", inline="hpat5", group="í•˜ëª¨ë‹‰ íŒ¨í„´ ì„ íƒ")

// RSI BAMM ì„¤ì •
showRSIBAMM = input.bool(true, title="RSI BAMM í™œì„±í™”", group="RSI BAMM")
rsiBAMMLength = input.int(14, title="RSI ê¸¸ì´", group="RSI BAMM")
rsiBAMMOB = input.int(70, title="RSI ê³¼ë§¤ìˆ˜", group="RSI BAMM")
rsiBAMMOS = input.int(30, title="RSI ê³¼ë§¤ë„", group="RSI BAMM")

// í•˜ëª¨ë‹‰ ìƒ‰ìƒ
harmonicBullColor = input.color(color.new(color.green, 20), title="Bullish", group="í•˜ëª¨ë‹‰ ìƒ‰ìƒ")
harmonicBearColor = input.color(color.new(color.red, 20), title="Bearish", group="í•˜ëª¨ë‹‰ ìƒ‰ìƒ")
przColor = input.color(color.new(color.yellow, 70), title="PRZ", group="í•˜ëª¨ë‹‰ ìƒ‰ìƒ")

// ============================================
// â˜…â˜…â˜… ì •í™•ì„± í•„í„° ì„¤ì • (V42 ì‹ ê·œ) â˜…â˜…â˜…
// ============================================
// í’ˆì§ˆ í•„í„°
minQualityScore = input.int(60, title="ìµœì†Œ í’ˆì§ˆ ì ìˆ˜ (%)", minval=0, maxval=100, step=10, group="ì •í™•ì„± í•„í„°", tooltip="ì´ ì ìˆ˜ ì´ìƒì˜ íŒ¨í„´ë§Œ ì‹ í˜¸ ë°œìƒ")
requirePerfect = input.bool(false, title="Perfect íŒ¨í„´ë§Œ", group="ì •í™•ì„± í•„í„°", tooltip="Perfect ë¹„ìœ¨ íŒ¨í„´ë§Œ ì‹ í˜¸ ë°œìƒ")

// RSI í™•ì¸ í•„í„°
useRSIConfirm = input.bool(true, title="RSI í™•ì¸ í•„í„°", group="ì •í™•ì„± í•„í„°", tooltip="PRZì—ì„œ RSI ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ í™•ì¸")
rsiConfirmLevel = input.int(35, title="RSI í™•ì¸ ë ˆë²¨", minval=20, maxval=40, group="ì •í™•ì„± í•„í„°")

// ì¶”ì„¸ í•„í„°
useTrendFilter = input.bool(true, title="ì¶”ì„¸ í•„í„°", group="ì •í™•ì„± í•„í„°", tooltip="EMA ë°©í–¥ê³¼ ì¼ì¹˜í•˜ëŠ” ì‹ í˜¸ë§Œ")
trendEMALen = input.int(55, title="ì¶”ì„¸ EMA ê¸¸ì´", group="ì •í™•ì„± í•„í„°")

// ê±°ë˜ëŸ‰ í•„í„° (í•˜ëª¨ë‹‰ìš©)
useHarmonicVolumeFilter = input.bool(true, title="í•˜ëª¨ë‹‰ ê±°ë˜ëŸ‰ í•„í„°", group="ì •í™•ì„± í•„í„°", tooltip="í‰ê·  ì´ìƒ ê±°ë˜ëŸ‰ì—ì„œë§Œ ì‹ í˜¸")
harmonicVolumeMultiplier = input.float(1.2, title="ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=1.0, maxval=3.0, step=0.1, group="ì •í™•ì„± í•„í„°")

// ì»¨í”Œë£¨ì–¸ìŠ¤ (ë³µí•© í™•ì¸)
useConfluence = input.bool(true, title="ì»¨í”Œë£¨ì–¸ìŠ¤ í•„í„°", group="ì •í™•ì„± í•„í„°", tooltip="ì—¬ëŸ¬ ì¡°ê±´ ì¶©ì¡± ì‹œë§Œ ì‹ í˜¸")
minConfluenceScore = input.int(3, title="ìµœì†Œ ì»¨í”Œë£¨ì–¸ìŠ¤", minval=1, maxval=5, group="ì •í™•ì„± í•„í„°")

// ============================================
// í˜„ì¬ TF ê¸°ë³¸ ì§€í‘œ
// ============================================

// í”¼ë³´ë‚˜ì¹˜ ê¸°ë°˜ EMA (ê¸°ê´€/í”„ë¡œ ì„¤ì •: 8, 21, 55, 200)
ema8 = ta.ema(close, 8)
ema21 = ta.ema(close, 21)
ema55 = ta.ema(close, 55)
ema200 = ta.ema(close, 200)

bool emaAlignedUp = ema8 > ema21 and ema21 > ema55
bool emaAlignedDown = ema8 < ema21 and ema21 < ema55
bool aboveEMA200 = close > ema200
bool belowEMA200 = close < ema200

// ============================================
// EMA ê°ë„ ë¶„ì„ (ì¶”ì„¸ ê°•ë„) - V40 ê°œì„ 
// Arctangent ë°©ì‹ + Normalization
// ============================================
emaAngle14 = ta.ema(close, emaAngleLength)
emaAnglePrev = emaAngle14[emaAngleLength]  // Lookback ê±°ë¦¬ë§Œí¼ ì´ì „ ê°’

// V40: Arctangent ë°©ì‹ ê°ë„ ê³„ì‚°
float emaDelta = emaAngle14 - emaAnglePrev
float emaAngleDegrees = math.atan(emaDelta / emaAngleLength) * 180 / math.pi  // -90Â° ~ +90Â°

// V40: ì •ê·œí™” (ê°€ê²© ë²”ìœ„ì— ë…ë¦½ì )
float priceRange = ta.highest(high, 50) - ta.lowest(low, 50)
float normalizedDelta = priceRange > 0 ? emaDelta / priceRange : 0
float emaAngleNormalized = math.atan(normalizedDelta * 100) * 180 / math.pi

// ìµœì¢… ê°ë„ ê°’ (ì •ê·œí™” ë²„ì „ ì‚¬ìš©)
float emaAngleValue = ta.sma(emaAngleNormalized, 3)  // 3ë´‰ í‰í™œí™”

// EMA ìƒ‰ìƒ: ì´ˆë¡(ê°•í•œìƒìŠ¹) > ë…¸ë‘(ì•½í•œìƒìŠ¹) > ì£¼í™©(íš¡ë³´) > ë¹¨ê°•(í•˜ë½)
color emaAngleColor = emaAngleValue > emaAngleThreshold ? color.lime :
                      emaAngleValue > 0 ? color.yellow :
                      emaAngleValue > -emaAngleThreshold ? color.orange :
                      color.red

bool emaStrongUp = emaAngleValue > emaAngleThreshold
bool emaWeakUp = emaAngleValue > 0 and emaAngleValue <= emaAngleThreshold
bool emaSideways = emaAngleValue <= 0 and emaAngleValue >= -emaAngleThreshold
bool emaStrongDown = emaAngleValue < -emaAngleThreshold

// ============================================
// ì¼ëª©ê· í˜•í‘œ (Ichimoku Cloud) ê³„ì‚°
// ============================================
// ì „í™˜ì„  (Tenkan-sen): 9ì¼ ê³ ì € í‰ê· 
float tenkanSen = (ta.highest(high, tenkanPeriod) + ta.lowest(low, tenkanPeriod)) / 2

// ê¸°ì¤€ì„  (Kijun-sen): 26ì¼ ê³ ì € í‰ê· 
float kijunSen = (ta.highest(high, kijunPeriod) + ta.lowest(low, kijunPeriod)) / 2

// ì„ í–‰ìŠ¤íŒ¬A (Senkou Span A): ì „í™˜ì„ +ê¸°ì¤€ì„  í‰ê· , 26ì¼ ì•ì— í‘œì‹œ
float senkouSpanA = (tenkanSen + kijunSen) / 2

// ì„ í–‰ìŠ¤íŒ¬B (Senkou Span B): 52ì¼ ê³ ì € í‰ê· , 26ì¼ ì•ì— í‘œì‹œ
float senkouSpanB = (ta.highest(high, senkouBPeriod) + ta.lowest(low, senkouBPeriod)) / 2

// í˜„ì¬ êµ¬ë¦„ ìƒë‹¨/í•˜ë‹¨ (26ì¼ ì „ ê°’ = í˜„ì¬ êµ¬ë¦„)
float currentCloudTop = math.max(senkouSpanA[displacement], senkouSpanB[displacement])
float currentCloudBottom = math.min(senkouSpanA[displacement], senkouSpanB[displacement])

// êµ¬ë¦„ ëŒ€ë¹„ ê°€ê²© ìœ„ì¹˜ íŒë‹¨
bool priceAboveCloud = close > currentCloudTop      // êµ¬ë¦„ ìœ„ = ê°•í•œ ìƒìŠ¹
bool priceBelowCloud = close < currentCloudBottom   // êµ¬ë¦„ ì•„ë˜ = ê°•í•œ í•˜ë½
bool priceInCloud = not priceAboveCloud and not priceBelowCloud  // êµ¬ë¦„ ë‚´ë¶€ = íš¡ë³´/ë¶ˆí™•ì‹¤

// êµ¬ë¦„ ìƒ‰ìƒ (ì–‘ìš´/ìŒìš´)
bool bullishCloud = senkouSpanA > senkouSpanB       // ì–‘ìš´ (ì´ˆë¡)
bool bearishCloud = senkouSpanA < senkouSpanB       // ìŒìš´ (ë¹¨ê°•)

// êµ¬ë¦„ ë‘ê»˜ (ì§€ì§€/ì €í•­ ê°•ë„)
float cloudThickness = math.abs(currentCloudTop - currentCloudBottom)
float cloudThicknessPercent = cloudThickness / close * 100

// ì¼ëª© ì‹ í˜¸ ì¢…í•©
string ichimokuSignal = priceAboveCloud ? "êµ¬ë¦„ìœ„" : priceBelowCloud ? "êµ¬ë¦„ì•„ë˜" : "êµ¬ë¦„ë‚´"
color ichimokuColor = priceAboveCloud ? color.lime : priceBelowCloud ? color.red : color.yellow

// ë³¼ë¦°ì €ë°´ë“œ
bbLength = 20
bbMult = 2.0
bbBasis = ta.sma(close, bbLength)
bbDev = ta.stdev(close, bbLength) * bbMult
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev
bool touchBBLower = low <= bbLower
bool touchBBUpper = high >= bbUpper

rsi = ta.rsi(close, 14)
stochRsi = ta.stoch(rsi, rsi, rsi, 14)
stochK = ta.sma(stochRsi, 3)
stochD = ta.sma(stochK, 3)
bool rsiOversold = rsi < 30
bool rsiOverbought = rsi > 70
bool stochOversold = stochK < 20
bool stochOverbought = stochK > 80
bool stochBullish = stochK > stochD

[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
bool macdBullish = macdLine > signalLine
bool macdBearish = macdLine < signalLine

[diPlus, diMinus, adxValue] = ta.dmi(14, 14)
bool trendStrong = adxValue >= 20
bool bullishDI = diPlus > diMinus

avgVol = ta.sma(volume, 20)
volRatio = volume / avgVol
volSpike = volRatio >= volThreshold
bool volumeExplosion = volRatio >= volHighThreshold

bullVol = close > open ? volume : volume * (close - low) / math.max(high - low, 0.0001)
bearVol = close < open ? volume : volume * (high - close) / math.max(high - low, 0.0001)
buyPressure = bullVol / (bullVol + bearVol) * 100
bool strongBuyPressure = buyPressure > 55
bool strongSellPressure = buyPressure < 45

// ============================================
// ê³ ë˜ ë§¤ìˆ˜/ë§¤ë„ ê°ì§€
// ============================================
float priceChangePercent = math.abs(close - open) / open * 100
bool isWhaleVolume = volRatio >= whaleVolMultiplier
bool isWhalePriceMove = priceChangePercent >= whalePriceMove
bool isBullishCandle = close > open
bool isBearishCandle = close < open

// ê³ ë˜ ë§¤ìˆ˜: ëŒ€ëŸ‰ ê±°ë˜ëŸ‰ + í° ì–‘ë´‰ + ë§¤ìˆ˜ì••ë ¥
bool whaleBuy = isWhaleVolume and isWhalePriceMove and isBullishCandle and buyPressure > 55

// ê³ ë˜ ë§¤ë„: ëŒ€ëŸ‰ ê±°ë˜ëŸ‰ + í° ìŒë´‰ + ë§¤ë„ì••ë ¥
bool whaleSell = isWhaleVolume and isWhalePriceMove and isBearishCandle and buyPressure < 45

// ê±°ë˜ëŸ‰ ë“±ê¸‰ë³„ ë¶„ë¥˜ (í•´ì–‘ìƒë¬¼ ë“±ê¸‰)
string whaleStrength = volRatio >= 10.0 ? "ğŸ‹WHALE" :
                       volRatio >= 7.0 ? "ğŸ¦ˆSHARK" :
                       volRatio >= 5.0 ? "ğŸ¬DOLPHIN" :
                       volRatio >= 3.0 ? "ğŸŸFISH" :
                       volRatio >= 2.0 ? "ğŸ¦€CRAB" : "ğŸ¦SHRIMP"

// ë“±ê¸‰ë³„ í•œê¸€ëª…
string whaleKorean = volRatio >= 10.0 ? "ê³ ë˜" :
                     volRatio >= 7.0 ? "ìƒì–´" :
                     volRatio >= 5.0 ? "ëŒê³ ë˜" :
                     volRatio >= 3.0 ? "ë¬¼ê³ ê¸°" :
                     volRatio >= 2.0 ? "ê²Œ" : "ìƒˆìš°"

// ============================================
// Volume Delta & CVD (í˜¸ê°€ì°½ ëŒ€ì²´ ë¶„ì„) - V40 ê°œì„ 
// Lower TF ë°ì´í„° + Reset ê¸°ëŠ¥ + Normalization
// ============================================

// Volume Delta ì„¤ì •
showVolumeDelta = input.bool(true, title="Volume Delta í‘œì‹œ", group="Volume Delta")
showCVD = input.bool(true, title="CVD ë¼ì¸ í‘œì‹œ", group="Volume Delta")
deltaLength = input.int(14, title="Delta EMA ê¸¸ì´", minval=5, maxval=50, group="Volume Delta")
deltaSpikeThreshold = input.float(2.0, title="Delta ê¸‰ì¦ ë°°ìˆ˜", minval=1.5, maxval=5.0, step=0.5, group="Volume Delta")

// Volume Delta ê³„ì‚° (ë§¤ìˆ˜ ê±°ë˜ëŸ‰ - ë§¤ë„ ê±°ë˜ëŸ‰)
float volumeDelta = bullVol - bearVol
float absDelta = math.abs(volumeDelta)

// Delta ë¹„ìœ¨ (ì „ì²´ ê±°ë˜ëŸ‰ ëŒ€ë¹„)
float deltaRatio = volume > 0 ? volumeDelta / volume * 100 : 0

// V40: CVD Reset ê¸°ëŠ¥
var float cvd = 0.0
bool resetCVD = false

// Reset ì¡°ê±´ ì²´í¬
if cvdResetMode == "ì¼ë´‰"
    resetCVD := ta.change(time("D")) != 0
else if cvdResetMode == "ì„¸ì…˜"
    resetCVD := ta.change(time("D")) != 0  // ì„¸ì…˜ ì‹œì‘ (ê°„ì†Œí™”)
else if cvdResetMode == "ì£¼ë´‰"
    resetCVD := ta.change(time("W")) != 0

// CVD ëˆ„ì  (Reset ì ìš©)
cvd := resetCVD ? volumeDelta : cvd + volumeDelta

// V40: CVD Normalization (ê³ ê°€ ìì‚° ëŒ€ì‘)
float avgPrice = ta.sma(close, 20)
float cvdNormalized = showCVDNormalized and avgPrice > 0 ? cvd / avgPrice * 100 : cvd
float cvdDisplay = showCVDNormalized ? cvdNormalized : cvd

// CVD EMA (ì¶”ì„¸ íŒŒì•…ìš©)
float cvdEma = ta.ema(cvdDisplay, deltaLength)
float cvdSlope = cvdDisplay - cvdDisplay[1]
bool cvdUptrend = cvdDisplay > cvdEma
bool cvdDowntrend = cvdDisplay < cvdEma

// Delta ê¸‰ì¦ ê°ì§€
float avgDelta = ta.sma(absDelta, 20)
float deltaSpike = absDelta / math.max(avgDelta, 0.0001)
bool isDeltaSpike = deltaSpike >= deltaSpikeThreshold

// Delta ë°©í–¥
bool positiveDelta = volumeDelta > 0
bool negativeDelta = volumeDelta < 0
bool strongPositiveDelta = deltaRatio > 30  // ë§¤ìˆ˜ 30% ì´ìƒ ìš°ì„¸
bool strongNegativeDelta = deltaRatio < -30 // ë§¤ë„ 30% ì´ìƒ ìš°ì„¸

// Delta ë‹¤ì´ë²„ì „ìŠ¤ ê°ì§€
// ê°€ê²© ìƒìŠ¹ + Delta í•˜ë½ = ì•½ì„¸ ë‹¤ì´ë²„ì „ìŠ¤ (ë§¤ë„ ì‹ í˜¸)
// ê°€ê²© í•˜ë½ + Delta ìƒìŠ¹ = ê°•ì„¸ ë‹¤ì´ë²„ì „ìŠ¤ (ë§¤ìˆ˜ ì‹ í˜¸)
bool deltaBullDiv = close < close[5] and cvd > cvd[5] and volumeDelta > 0
bool deltaBearDiv = close > close[5] and cvd < cvd[5] and volumeDelta < 0

// Delta ì—°ì†ì„± (3ë´‰ ì—°ì† ê°™ì€ ë°©í–¥)
bool delta3ConsecutiveBuy = volumeDelta > 0 and volumeDelta[1] > 0 and volumeDelta[2] > 0
bool delta3ConsecutiveSell = volumeDelta < 0 and volumeDelta[1] < 0 and volumeDelta[2] < 0

// Delta ê¸°ë°˜ ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥ ë“±ê¸‰
string deltaGrade = strongPositiveDelta and delta3ConsecutiveBuy ? "STRONG BUY" : strongNegativeDelta and delta3ConsecutiveSell ? "STRONG SELL" : positiveDelta and cvdUptrend ? "BUY" : negativeDelta and cvdDowntrend ? "SELL" : "NEUTRAL"

color deltaColor = deltaGrade == "STRONG BUY" ? color.lime : deltaGrade == "BUY" ? color.green : deltaGrade == "STRONG SELL" ? color.fuchsia : deltaGrade == "SELL" ? color.red : color.gray

// ============================================
// ìŠ¤ë§ˆíŠ¸ OBV (Smart OBV) - ì­ ì›¨ì´ë“œ ì „ëµ (ê°œì„ )
// ============================================

// ìŠ¤ë§ˆíŠ¸ OBV ì„¤ì •
showSmartOBV = input.bool(true, title="ìŠ¤ë§ˆíŠ¸ OBV í™œì„±í™”", group="ìŠ¤ë§ˆíŠ¸ OBV", tooltip="âš ï¸ í”Œë¡¯ ì œí•œ(64ê°œ)ìœ¼ë¡œ ê³¨ë“ í¬ë¡œìŠ¤/ë°ë“œí¬ë¡œìŠ¤/ìŠ¤í€´ì¦ˆ ë§ˆì»¤ëŠ” ë¹„í™œì„±í™”ë¨. ë°°ê²½ìƒ‰ í‘œì‹œëŠ” ì •ìƒ ì‘ë™.")
smartOBVLength = input.int(20, title="ì¤‘ì‹¬ì„  ê¸¸ì´", minval=5, maxval=50, group="ìŠ¤ë§ˆíŠ¸ OBV")
smartOBVSqueezeMult = input.float(1.5, title="ìŠ¤í€´ì¦ˆ BB ë°°ìˆ˜", minval=1.0, maxval=3.0, step=0.1, group="ìŠ¤ë§ˆíŠ¸ OBV", tooltip="BB í­ì´ ì´ ë°°ìˆ˜ ì´í•˜ë©´ ìŠ¤í€´ì¦ˆ")
showSmartOBVBg = input.bool(true, title="ë°°ê²½ìƒ‰ í‘œì‹œ", group="ìŠ¤ë§ˆíŠ¸ OBV")

// ìŠ¤ë§ˆíŠ¸ OBV ê³„ì‚° (ê°€ê²© ë³€ë™ ê°•ë„ ê°€ì¤‘ì¹˜ ì ìš©)
// ê¸°ì¡´ OBV: ì–‘ë´‰ì´ë©´ +volume, ìŒë´‰ì´ë©´ -volume (ë‹¨ìˆœ)
// ìŠ¤ë§ˆíŠ¸ OBV: (í˜„ì¬ì¢…ê°€ - ì´ì „ì¢…ê°€) / ATR * volume (ATR í‘œì¤€í™” ê°€ì¤‘ì¹˜)
float priceChangePrev = close - close[1]  // ì´ì „ ì¢…ê°€ ëŒ€ë¹„ ë³€ë™
float atrNorm = ta.atr(14)  // ATRë¡œ í‘œì¤€í™”
float normalizedChange = atrNorm != 0 ? priceChangePrev / atrNorm : 0  // -1 ~ +1 ë²”ìœ„ë¡œ ì •ê·œí™”
float weightedVolume = normalizedChange * volume / 1000000  // ìŠ¤ì¼€ì¼ ì¡°ì • (ë°±ë§Œ ë‹¨ìœ„)

// ìŠ¤ë§ˆíŠ¸ OBV ëˆ„ì 
var float smartOBV = 0.0
smartOBV := smartOBV + weightedVolume

// ì¤‘ì‹¬ì„  (Nì¼ EMA) - ë§¤ìˆ˜/ë§¤ë„ì„¸ íŒë‹¨ ê¸°ì¤€
float smartOBVCenter = ta.ema(smartOBV, smartOBVLength)

// ìŠ¤ë§ˆíŠ¸ OBV ìƒíƒœ
bool smartOBVAboveCenter = smartOBV > smartOBVCenter  // ë§¤ìˆ˜ì„¸ ìš°ì„¸
bool smartOBVBelowCenter = smartOBV < smartOBVCenter  // ë§¤ë„ì„¸ ìš°ì„¸

// ì¤‘ì‹¬ì„  í¬ë¡œìŠ¤ ì‹ í˜¸
bool smartOBVCrossUp = ta.crossover(smartOBV, smartOBVCenter)   // ë§¤ìˆ˜ì„¸ ì „í™˜
bool smartOBVCrossDown = ta.crossunder(smartOBV, smartOBVCenter) // ë§¤ë„ì„¸ ì „í™˜

// ìŠ¤í€´ì¦ˆ ëª¨ë©˜í…€ ê°ì§€ (ë³¼ë¦°ì € ë°´ë“œ í­ ê¸°ë°˜ - ë” ì •í™•)
// BB í­ì´ ì¢ìœ¼ë©´ ì—ë„ˆì§€ ì‘ì¶•, ë„“ì–´ì§€ë©´ ë¸Œë ˆì´í¬ì•„ì›ƒ
float smartOBVBBUpper = ta.sma(smartOBV, smartOBVLength) + ta.stdev(smartOBV, smartOBVLength) * 2
float smartOBVBBLower = ta.sma(smartOBV, smartOBVLength) - ta.stdev(smartOBV, smartOBVLength) * 2
float smartOBVBBWidth = smartOBVBBUpper - smartOBVBBLower
float smartOBVBBWidthAvg = ta.sma(smartOBVBBWidth, smartOBVLength)
bool smartOBVSqueeze = smartOBVBBWidth < smartOBVBBWidthAvg / smartOBVSqueezeMult  // BB í­ì´ í‰ê· ì˜ 1/1.5 ì´í•˜ë©´ ìŠ¤í€´ì¦ˆ

// ìŠ¤í€´ì¦ˆ í›„ ë¸Œë ˆì´í¬ì•„ì›ƒ ê°ì§€ (BB ëŒíŒŒ + ë°©í–¥)
bool squeezeBBBreakUp = smartOBV > smartOBVBBUpper and smartOBVSqueeze[1]  // ìƒë‹¨ ëŒíŒŒ
bool squeezeBBBreakDown = smartOBV < smartOBVBBLower and smartOBVSqueeze[1]  // í•˜ë‹¨ ëŒíŒŒ
bool squeezeBreakoutUp = (smartOBVSqueeze[1] and not smartOBVSqueeze and smartOBVAboveCenter) or squeezeBBBreakUp
bool squeezeBreakoutDown = (smartOBVSqueeze[1] and not smartOBVSqueeze and smartOBVBelowCenter) or squeezeBBBreakDown

// ìŠ¤ë§ˆíŠ¸ OBV ê¸°ìš¸ê¸° (ëª¨ë©˜í…€) - 3ë´‰ ëŒ€ë¹„ ë³€í™”ìœ¨
float smartOBVSlope = smartOBV - smartOBV[3]
float smartOBVSlopeNorm = smartOBVBBWidthAvg != 0 ? smartOBVSlope / smartOBVBBWidthAvg * 100 : 0  // ì •ê·œí™”ëœ ê¸°ìš¸ê¸°
bool smartOBVMomentumUp = smartOBVSlope > 0 and smartOBVAboveCenter
bool smartOBVMomentumDown = smartOBVSlope < 0 and smartOBVBelowCenter

// ê°•í•œ ëª¨ë©˜í…€ ê°ì§€ (ê¸°ìš¸ê¸°ê°€ í¬ë©´)
bool smartOBVStrongMomentumUp = smartOBVSlopeNorm > 30 and smartOBVAboveCenter
bool smartOBVStrongMomentumDown = smartOBVSlopeNorm < -30 and smartOBVBelowCenter

// ìŠ¤ë§ˆíŠ¸ OBV ë“±ê¸‰
string smartOBVGrade = squeezeBreakoutUp and smartOBVStrongMomentumUp ? "STRONG BUY" :
                       squeezeBreakoutDown and smartOBVStrongMomentumDown ? "STRONG SELL" :
                       smartOBVMomentumUp and smartOBVAboveCenter ? "BUY" :
                       smartOBVMomentumDown and smartOBVBelowCenter ? "SELL" :
                       smartOBVSqueeze ? "SQUEEZE" : "NEUTRAL"

// í”¼ë´‡/ë‹¤ì´ë²„ì „ìŠ¤
float pivotHigh = ta.pivothigh(high, pivotLeft, pivotRight)
float pivotLow = ta.pivotlow(low, pivotLeft, pivotRight)
float rsiPivotLow = ta.pivotlow(rsi, pivotLeft, pivotRight)
float rsiPivotHigh = ta.pivothigh(rsi, pivotLeft, pivotRight)
float pricePivotLow = ta.pivotlow(low, pivotLeft, pivotRight)
float pricePivotHigh = ta.pivothigh(high, pivotLeft, pivotRight)

var float prevRsiLow = na
var float prevPriceLow = na
var float prevRsiHigh = na
var float prevPriceHigh = na

bool bullishDivergence = false
if not na(rsiPivotLow) and not na(pricePivotLow)
    if not na(prevRsiLow) and not na(prevPriceLow)
        if pricePivotLow < prevPriceLow and rsiPivotLow > prevRsiLow
            bullishDivergence := true
    prevRsiLow := rsiPivotLow
    prevPriceLow := pricePivotLow

bool bearishDivergence = false
if not na(rsiPivotHigh) and not na(pricePivotHigh)
    if not na(prevRsiHigh) and not na(prevPriceHigh)
        if pricePivotHigh > prevPriceHigh and rsiPivotHigh < prevRsiHigh
            bearishDivergence := true
    prevRsiHigh := rsiPivotHigh
    prevPriceHigh := pricePivotHigh

// ============================================
// SMC (Smart Money Concepts) ê³„ì‚°
// ============================================

// --- Swing High/Low ê°ì§€ ---
float swingHigh = ta.pivothigh(high, swingLength, swingLength)
float swingLow = ta.pivotlow(low, swingLength, swingLength)

// ìµœê·¼ ìŠ¤ìœ™ í¬ì¸íŠ¸ ì €ì¥
var float lastSwingHigh = na
var float lastSwingLow = na
var int lastSwingHighBar = na
var int lastSwingLowBar = na
var float prevSwingHigh = na
var float prevSwingLow = na
var int prevSwingHighBar = na
var int prevSwingLowBar = na

// ì‹œì¥ êµ¬ì¡° ë¼ë²¨ìš© ë³€ìˆ˜
var string lastStructureType = "none"

if not na(swingHigh)
    prevSwingHigh := lastSwingHigh
    prevSwingHighBar := lastSwingHighBar
    lastSwingHigh := swingHigh
    lastSwingHighBar := bar_index - swingLength

if not na(swingLow)
    prevSwingLow := lastSwingLow
    prevSwingLowBar := lastSwingLowBar
    lastSwingLow := swingLow
    lastSwingLowBar := bar_index - swingLength

// --- ì‹œì¥ êµ¬ì¡° ë¶„ì„ (HH, HL, LH, LL) ---
bool isHigherHigh = not na(swingHigh) and not na(prevSwingHigh) and swingHigh > prevSwingHigh
bool isLowerHigh = not na(swingHigh) and not na(prevSwingHigh) and swingHigh < prevSwingHigh
bool isHigherLow = not na(swingLow) and not na(prevSwingLow) and swingLow > prevSwingLow
bool isLowerLow = not na(swingLow) and not na(prevSwingLow) and swingLow < prevSwingLow

// êµ¬ì¡° ë¼ë²¨ í‘œì‹œ
if showSMC and showStructureLabels
    if isHigherHigh
        label.new(bar_index - swingLength, swingHigh, "HH",
                 style=label.style_label_down, color=color.new(color.green, 40),
                 textcolor=color.white, size=size.tiny)
        lastStructureType := "HH"

    if isLowerHigh
        label.new(bar_index - swingLength, swingHigh, "LH",
                 style=label.style_label_down, color=color.new(color.red, 40),
                 textcolor=color.white, size=size.tiny)
        lastStructureType := "LH"

    if isHigherLow
        label.new(bar_index - swingLength, swingLow, "HL",
                 style=label.style_label_up, color=color.new(color.green, 40),
                 textcolor=color.white, size=size.tiny)
        lastStructureType := "HL"

    if isLowerLow
        label.new(bar_index - swingLength, swingLow, "LL",
                 style=label.style_label_up, color=color.new(color.red, 40),
                 textcolor=color.white, size=size.tiny)
        lastStructureType := "LL"

// --- BOS (Break of Structure) / CHoCH (Change of Character) - V40 ê°œì„  ---
var bool isBullishStructure = true
var float bosLevel = na
var float chochLevel = na
var float lastBosHigh = na
var float lastBosLow = na
bool bosUp = false
bool bosDn = false
bool chochUp = false
bool chochDn = false

// V40: BOS í™•ì¸ ì¡°ê±´
bool bosVolumeOK = not bosVolumeConfirm or volRatio >= bosMinVolumeRatio  // ê±°ë˜ëŸ‰ í™•ì¸
strongCloseAbove(float level) => close > level and close > open  // ê°•í•œ ì–‘ë´‰ ì¢…ê°€
strongCloseBelow(float level) => close < level and close < open  // ê°•í•œ ìŒë´‰ ì¢…ê°€

// BOS: ì¶”ì„¸ ë°©í–¥ìœ¼ë¡œì˜ êµ¬ì¡° ëŒíŒŒ (ì²˜ìŒ ëŒíŒŒ ì‹œì—ë§Œ)
// CHoCH: ì¶”ì„¸ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œì˜ êµ¬ì¡° ëŒíŒŒ (ì¶”ì„¸ ì „í™˜)
if isBullishStructure
    // CHoCH: ìƒìŠ¹ êµ¬ì¡°ì—ì„œ ì €ì  ì´íƒˆ = í•˜ë½ ì „í™˜
    // V40: ê°•í•œ ì¢…ê°€ + ê±°ë˜ëŸ‰ í™•ì¸
    bool chochCondition = not na(lastSwingLow) and close < lastSwingLow and close[1] >= lastSwingLow
    bool chochConfirmed = bosStrongClose ? strongCloseBelow(lastSwingLow) and bosVolumeOK : chochCondition and bosVolumeOK

    if chochConfirmed
        chochDn := true
        chochLevel := lastSwingLow
        isBullishStructure := false
        lastBosLow := lastSwingLow

    // BOS: ìƒìŠ¹ êµ¬ì¡°ì—ì„œ ê³ ì  ëŒíŒŒ (ì²˜ìŒ ëŒíŒŒí•  ë•Œë§Œ)
    // V40: ê°•í•œ ì¢…ê°€ + ê±°ë˜ëŸ‰ í™•ì¸
    bool bosCondition = not na(lastSwingHigh) and close > lastSwingHigh and close[1] <= lastSwingHigh and (na(lastBosHigh) or lastSwingHigh != lastBosHigh)
    bool bosConfirmed = bosStrongClose ? strongCloseAbove(lastSwingHigh) and bosVolumeOK : bosCondition and bosVolumeOK

    if bosConfirmed
        bosUp := true
        bosLevel := lastSwingHigh
        lastBosHigh := lastSwingHigh
else
    // CHoCH: í•˜ë½ êµ¬ì¡°ì—ì„œ ê³ ì  ëŒíŒŒ = ìƒìŠ¹ ì „í™˜
    // V40: ê°•í•œ ì¢…ê°€ + ê±°ë˜ëŸ‰ í™•ì¸
    bool chochCondition = not na(lastSwingHigh) and close > lastSwingHigh and close[1] <= lastSwingHigh
    bool chochConfirmed = bosStrongClose ? strongCloseAbove(lastSwingHigh) and bosVolumeOK : chochCondition and bosVolumeOK

    if chochConfirmed
        chochUp := true
        chochLevel := lastSwingHigh
        isBullishStructure := true
        lastBosHigh := lastSwingHigh

    // BOS: í•˜ë½ êµ¬ì¡°ì—ì„œ ì €ì  ì´íƒˆ (ì²˜ìŒ ì´íƒˆí•  ë•Œë§Œ)
    // V40: ê°•í•œ ì¢…ê°€ + ê±°ë˜ëŸ‰ í™•ì¸
    bool bosCondition = not na(lastSwingLow) and close < lastSwingLow and close[1] >= lastSwingLow and (na(lastBosLow) or lastSwingLow != lastBosLow)
    bool bosConfirmed = bosStrongClose ? strongCloseBelow(lastSwingLow) and bosVolumeOK : bosCondition and bosVolumeOK

    if bosConfirmed
        bosDn := true
        bosLevel := lastSwingLow
        lastBosLow := lastSwingLow

// --- BOS ë°•ìŠ¤ ìƒì„± ---
var box[] bosBoxes = array.new_box(0)

// Bullish BOS ë°•ìŠ¤ (ì²­ë¡ìƒ‰) - EMA ìƒìŠ¹ ì¤‘ + ê³ ì  ëŒíŒŒ
if showSMC and showBOSBox and bosUp and emaAngleValue > 0
    if array.size(bosBoxes) >= 10
        box.delete(array.shift(bosBoxes))
    // ì´ì „ ì €ì  ~ í˜„ì¬ ê³ ì  ë°•ìŠ¤
    float boxTop = lastSwingHigh
    float boxBot = not na(prevSwingLow) ? prevSwingLow : lastSwingLow
    array.push(bosBoxes, box.new(lastSwingHighBar, boxTop, bar_index + 15, boxBot,
               bgcolor=color.new(color.teal, 85), border_color=color.teal, border_width=2,
               text="BOS+", text_color=color.teal, text_size=size.small))

// Bearish BOS ë°•ìŠ¤ (ë¶„í™ìƒ‰) - EMA í•˜ë½ ì¤‘ + ì €ì  ì´íƒˆ
if showSMC and showBOSBox and bosDn and emaAngleValue < 0
    if array.size(bosBoxes) >= 10
        box.delete(array.shift(bosBoxes))
    // ì´ì „ ê³ ì  ~ í˜„ì¬ ì €ì  ë°•ìŠ¤
    float boxTop = not na(prevSwingHigh) ? prevSwingHigh : lastSwingHigh
    float boxBot = lastSwingLow
    array.push(bosBoxes, box.new(lastSwingLowBar, boxTop, bar_index + 15, boxBot,
               bgcolor=color.new(color.fuchsia, 85), border_color=color.fuchsia, border_width=2,
               text="BOS-", text_color=color.fuchsia, text_size=size.small))

// --- Order Blocks ê°ì§€ ---
var box[] bullishOBs = array.new_box(0)
var box[] bearishOBs = array.new_box(0)

// Bullish Order Block: í•˜ë½ í›„ ê°•í•œ ìƒìŠ¹ ì „ ë§ˆì§€ë§‰ í•˜ë½ ìº”ë“¤
bool isBullishOB = close[1] < open[1] and close > open and close > high[1] and volRatio >= 1.2
float bullOBTop = isBullishOB ? high[1] : na
float bullOBBot = isBullishOB ? low[1] : na

// Bearish Order Block: ìƒìŠ¹ í›„ ê°•í•œ í•˜ë½ ì „ ë§ˆì§€ë§‰ ìƒìŠ¹ ìº”ë“¤
bool isBearishOB = close[1] > open[1] and close < open and close < low[1] and volRatio >= 1.2
float bearOBTop = isBearishOB ? high[1] : na
float bearOBBot = isBearishOB ? low[1] : na

// Order Block ë°•ìŠ¤ ìƒì„±
if showSMC and showOrderBlocks and isBullishOB
    if array.size(bullishOBs) >= 5
        box.delete(array.shift(bullishOBs))
    array.push(bullishOBs, box.new(bar_index - 1, bullOBTop, bar_index + 20, bullOBBot, bgcolor=color.new(color.green, 85), border_color=color.green, border_width=1))

if showSMC and showOrderBlocks and isBearishOB
    if array.size(bearishOBs) >= 5
        box.delete(array.shift(bearishOBs))
    array.push(bearishOBs, box.new(bar_index - 1, bearOBTop, bar_index + 20, bearOBBot, bgcolor=color.new(color.red, 85), border_color=color.red, border_width=1))

// --- Fair Value Gap (FVG) ê°ì§€ ---
var box[] bullishFVGs = array.new_box(0)
var box[] bearishFVGs = array.new_box(0)

// Bullish FVG: í˜„ì¬ë´‰ ì €ê°€ > 2ë´‰ì „ ê³ ê°€ (ê°­ ìƒìŠ¹)
float fvgThreshold = close * fvgMinSize / 100
bool isBullishFVG = low > high[2] and (low - high[2]) >= fvgThreshold
float bullFVGTop = isBullishFVG ? low : na
float bullFVGBot = isBullishFVG ? high[2] : na

// Bearish FVG: í˜„ì¬ë´‰ ê³ ê°€ < 2ë´‰ì „ ì €ê°€ (ê°­ í•˜ë½)
bool isBearishFVG = high < low[2] and (low[2] - high) >= fvgThreshold
float bearFVGTop = isBearishFVG ? low[2] : na
float bearFVGBot = isBearishFVG ? high : na

// FVG ë°•ìŠ¤ ìƒì„±
if showSMC and showFVG and isBullishFVG
    if array.size(bullishFVGs) >= 5
        box.delete(array.shift(bullishFVGs))
    array.push(bullishFVGs, box.new(bar_index - 2, bullFVGTop, bar_index + 15, bullFVGBot, bgcolor=color.new(color.teal, 80), border_color=color.teal, border_width=1, border_style=line.style_dashed))

if showSMC and showFVG and isBearishFVG
    if array.size(bearishFVGs) >= 5
        box.delete(array.shift(bearishFVGs))
    array.push(bearishFVGs, box.new(bar_index - 2, bearFVGTop, bar_index + 15, bearFVGBot, bgcolor=color.new(color.maroon, 80), border_color=color.maroon, border_width=1, border_style=line.style_dashed))

// --- Smart Trail (íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘) ---
// atrPeriodëŠ” V40 ì„¤ì •ì—ì„œ ì •ì˜ë¨
atrMult = 2.0
float atrValueForTrail = ta.atr(atrPeriod)

var float smartTrail = na
var bool smartTrailUp = true

if smartTrailUp
    smartTrail := math.max(nz(smartTrail), close - atrValueForTrail * atrMult)
    if close < smartTrail
        smartTrailUp := false
        smartTrail := close + atrValueForTrail * atrMult
else
    smartTrail := math.min(nz(smartTrail), close + atrValueForTrail * atrMult)
    if close > smartTrail
        smartTrailUp := true
        smartTrail := close - atrValueForTrail * atrMult

// --- Liquidity Levels (Equal Highs/Lows) ---
var float[] eqHighs = array.new_float(0)
var float[] eqLows = array.new_float(0)
var int[] eqHighBars = array.new_int(0)
var int[] eqLowBars = array.new_int(0)

// Equal Highs ê°ì§€ (ë¹„ìŠ·í•œ ê³ ì  = ìœ ë™ì„± íƒ€ê²Ÿ)
eqHighThreshold = atrValueForTrail * 0.3
if not na(swingHigh) and not na(prevSwingHigh)
    if math.abs(swingHigh - prevSwingHigh) < eqHighThreshold
        if array.size(eqHighs) >= 3
            array.shift(eqHighs)
            array.shift(eqHighBars)
        array.push(eqHighs, (swingHigh + prevSwingHigh) / 2)
        array.push(eqHighBars, bar_index - swingLength)

// Equal Lows ê°ì§€ (ë¹„ìŠ·í•œ ì €ì  = ìœ ë™ì„± íƒ€ê²Ÿ)
if not na(swingLow) and not na(prevSwingLow)
    if math.abs(swingLow - prevSwingLow) < eqHighThreshold
        if array.size(eqLows) >= 3
            array.shift(eqLows)
            array.shift(eqLowBars)
        array.push(eqLows, (swingLow + prevSwingLow) / 2)
        array.push(eqLowBars, bar_index - swingLength)

// --- Premium/Discount Zone ---
float rangeHigh = ta.highest(high, 50)
float rangeLow = ta.lowest(low, 50)
float rangeMid = (rangeHigh + rangeLow) / 2
float premiumZone = rangeMid + (rangeHigh - rangeMid) * 0.5
float discountZone = rangeMid - (rangeMid - rangeLow) * 0.5
bool inPremium = close > premiumZone
bool inDiscount = close < discountZone

// SMC ì‹œê·¸ë„ ì¡°í•©
bool smcBullish = (isBullishOB or isBullishFVG or chochUp) and inDiscount and smartTrailUp
bool smcBearish = (isBearishOB or isBearishFVG or chochDn) and inPremium and not smartTrailUp

// ============================================
// 15ë¶„ë´‰ ë¶„ì„ (5ë¶„ë´‰ ì œê±° - security ì œí•œ 40ê°œ)
// ============================================

tf15m_ema8 = request.security(syminfo.tickerid, "15", ta.ema(close, 8), lookahead=barmerge.lookahead_off)
tf15m_ema21 = request.security(syminfo.tickerid, "15", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf15m_close = request.security(syminfo.tickerid, "15", close, lookahead=barmerge.lookahead_off)
tf15m_rsi = request.security(syminfo.tickerid, "15", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)
tf15m_vol = request.security(syminfo.tickerid, "15", volume, lookahead=barmerge.lookahead_off)
tf15m_avgVol = request.security(syminfo.tickerid, "15", ta.sma(volume, 20), lookahead=barmerge.lookahead_off)

float tf15m_volRatio = tf15m_vol / math.max(tf15m_avgVol, 1)
bool tf15m_uptrend = tf15m_ema8 > tf15m_ema21 and tf15m_close > tf15m_ema21
bool tf15m_downtrend = tf15m_ema8 < tf15m_ema21 and tf15m_close < tf15m_ema21
bool tf15m_volSpike = tf15m_volRatio >= volThreshold
bool tf15m_oversold = tf15m_rsi < 35
// ì¶”ì„¸ ê°•ë„
tf15m_ema55 = request.security(syminfo.tickerid, "15", ta.ema(close, 55), lookahead=barmerge.lookahead_off)
bool tf15m_emaAligned = tf15m_ema8 > tf15m_ema21 and tf15m_ema21 > tf15m_ema55
bool tf15m_emaAlignedDn = tf15m_ema8 < tf15m_ema21 and tf15m_ema21 < tf15m_ema55
tf15m_macd = request.security(syminfo.tickerid, "15", ta.ema(close, 12) - ta.ema(close, 26), lookahead=barmerge.lookahead_off)
tf15m_macdSig = request.security(syminfo.tickerid, "15", ta.ema(ta.ema(close, 12) - ta.ema(close, 26), 9), lookahead=barmerge.lookahead_off)
bool tf15m_macdBull = tf15m_macd > tf15m_macdSig

// ============================================
// 1ì‹œê°„ë´‰ ë¶„ì„
// ============================================

tf1h_ema8 = request.security(syminfo.tickerid, "60", ta.ema(close, 8), lookahead=barmerge.lookahead_off)
tf1h_ema21 = request.security(syminfo.tickerid, "60", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf1h_ema55 = request.security(syminfo.tickerid, "60", ta.ema(close, 55), lookahead=barmerge.lookahead_off)
tf1h_close = request.security(syminfo.tickerid, "60", close, lookahead=barmerge.lookahead_off)
tf1h_rsi = request.security(syminfo.tickerid, "60", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)
tf1h_vol = request.security(syminfo.tickerid, "60", volume, lookahead=barmerge.lookahead_off)
tf1h_avgVol = request.security(syminfo.tickerid, "60", ta.sma(volume, 20), lookahead=barmerge.lookahead_off)
tf1h_high3d = request.security(syminfo.tickerid, "60", ta.highest(high, 72), lookahead=barmerge.lookahead_off)
tf1h_low3d = request.security(syminfo.tickerid, "60", ta.lowest(low, 72), lookahead=barmerge.lookahead_off)

float tf1h_volRatio = tf1h_vol / math.max(tf1h_avgVol, 1)
bool tf1h_uptrend = tf1h_ema8 > tf1h_ema21 and tf1h_close > tf1h_ema21
bool tf1h_downtrend = tf1h_ema8 < tf1h_ema21 and tf1h_close < tf1h_ema21
bool tf1h_volSpike = tf1h_volRatio >= volThreshold
bool tf1h_oversold = tf1h_rsi < 35
// ì¶”ì„¸ ê°•ë„
bool tf1h_emaAligned = tf1h_ema8 > tf1h_ema21 and tf1h_ema21 > tf1h_ema55
bool tf1h_emaAlignedDn = tf1h_ema8 < tf1h_ema21 and tf1h_ema21 < tf1h_ema55
tf1h_macd = request.security(syminfo.tickerid, "60", ta.ema(close, 12) - ta.ema(close, 26), lookahead=barmerge.lookahead_off)
tf1h_macdSig = request.security(syminfo.tickerid, "60", ta.ema(ta.ema(close, 12) - ta.ema(close, 26), 9), lookahead=barmerge.lookahead_off)
bool tf1h_macdBull = tf1h_macd > tf1h_macdSig

// ============================================
// 4ì‹œê°„ë´‰ ë¶„ì„
// ============================================

tf4h_ema8 = request.security(syminfo.tickerid, "240", ta.ema(close, 8), lookahead=barmerge.lookahead_off)
tf4h_ema21 = request.security(syminfo.tickerid, "240", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf4h_close = request.security(syminfo.tickerid, "240", close, lookahead=barmerge.lookahead_off)
tf4h_rsi = request.security(syminfo.tickerid, "240", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)
tf4h_vol = request.security(syminfo.tickerid, "240", volume, lookahead=barmerge.lookahead_off)
tf4h_avgVol = request.security(syminfo.tickerid, "240", ta.sma(volume, 20), lookahead=barmerge.lookahead_off)
tf4h_high3d = request.security(syminfo.tickerid, "240", ta.highest(high, 18), lookahead=barmerge.lookahead_off)
tf4h_low3d = request.security(syminfo.tickerid, "240", ta.lowest(low, 18), lookahead=barmerge.lookahead_off)

float tf4h_volRatio = tf4h_vol / math.max(tf4h_avgVol, 1)
bool tf4h_uptrend = tf4h_ema8 > tf4h_ema21 and tf4h_close > tf4h_ema21
bool tf4h_downtrend = tf4h_ema8 < tf4h_ema21 and tf4h_close < tf4h_ema21
bool tf4h_volSpike = tf4h_volRatio >= volThreshold
bool tf4h_oversold = tf4h_rsi < 35
// ì¶”ì„¸ ê°•ë„
tf4h_ema55 = request.security(syminfo.tickerid, "240", ta.ema(close, 55), lookahead=barmerge.lookahead_off)
bool tf4h_emaAligned = tf4h_ema8 > tf4h_ema21 and tf4h_ema21 > tf4h_ema55
bool tf4h_emaAlignedDn = tf4h_ema8 < tf4h_ema21 and tf4h_ema21 < tf4h_ema55
tf4h_macd = request.security(syminfo.tickerid, "240", ta.ema(close, 12) - ta.ema(close, 26), lookahead=barmerge.lookahead_off)
tf4h_macdSig = request.security(syminfo.tickerid, "240", ta.ema(ta.ema(close, 12) - ta.ema(close, 26), 9), lookahead=barmerge.lookahead_off)
bool tf4h_macdBull = tf4h_macd > tf4h_macdSig

// ============================================
// ì¼ë´‰ ë¶„ì„
// ============================================

tfD_ema8 = request.security(syminfo.tickerid, "D", ta.ema(close, 8), lookahead=barmerge.lookahead_off)
tfD_ema21 = request.security(syminfo.tickerid, "D", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tfD_close = request.security(syminfo.tickerid, "D", close, lookahead=barmerge.lookahead_off)
tfD_rsi = request.security(syminfo.tickerid, "D", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)
tfD_high3d = request.security(syminfo.tickerid, "D", ta.highest(high, 3), lookahead=barmerge.lookahead_off)
tfD_low3d = request.security(syminfo.tickerid, "D", ta.lowest(low, 3), lookahead=barmerge.lookahead_off)

bool tfD_uptrend = tfD_ema8 > tfD_ema21 and tfD_close > tfD_ema21
bool tfD_downtrend = tfD_ema8 < tfD_ema21 and tfD_close < tfD_ema21
bool tfD_oversold = tfD_rsi < 35
// ì¶”ì„¸ ê°•ë„
tfD_ema55 = request.security(syminfo.tickerid, "D", ta.ema(close, 55), lookahead=barmerge.lookahead_off)
bool tfD_emaAligned = tfD_ema8 > tfD_ema21 and tfD_ema21 > tfD_ema55
bool tfD_emaAlignedDn = tfD_ema8 < tfD_ema21 and tfD_ema21 < tfD_ema55
tfD_macd = request.security(syminfo.tickerid, "D", ta.ema(close, 12) - ta.ema(close, 26), lookahead=barmerge.lookahead_off)
tfD_macdSig = request.security(syminfo.tickerid, "D", ta.ema(ta.ema(close, 12) - ta.ema(close, 26), 9), lookahead=barmerge.lookahead_off)
bool tfD_macdBull = tfD_macd > tfD_macdSig

// ============================================
// 3ì¼ì¹˜ ì§€ì§€/ì €í•­ (ëª¨ë“  TF í†µí•©)
// ============================================

// 1ì‹œê°„/4ì‹œê°„/ì¼ë´‰ ê¸°ì¤€ 3ì¼ ê³ ì €
float resistance3d = math.max(tf1h_high3d, tf4h_high3d, tfD_high3d)
float support3d = math.min(tf1h_low3d, tf4h_low3d, tfD_low3d)

// í˜„ì¬ ê°€ê²© ìœ„ì¹˜ (%)
float pricePosition = (close - support3d) / math.max(resistance3d - support3d, 0.0001) * 100

// ì§€ì§€/ì €í•­ ê·¼ì ‘ ì—¬ë¶€
bool nearSupport3d = pricePosition < 15
bool nearResistance3d = pricePosition > 85
bool atSupport3d = pricePosition < 5
bool atResistance3d = pricePosition > 95

// ============================================
// íƒ€ì„í”„ë ˆì„ ì¼ì¹˜ ì¹´ìš´íŠ¸ (15m/1H/4H/D = 4ê°œ)
// ============================================

// ìƒìŠ¹ ì¶”ì„¸ ì¼ì¹˜ ê°œìˆ˜
int uptrendCount = (tf15m_uptrend ? 1 : 0) + (tf1h_uptrend ? 1 : 0) + (tf4h_uptrend ? 1 : 0) + (tfD_uptrend ? 1 : 0)

// í•˜ë½ ì¶”ì„¸ ì¼ì¹˜ ê°œìˆ˜
int downtrendCount = (tf15m_downtrend ? 1 : 0) + (tf1h_downtrend ? 1 : 0) + (tf4h_downtrend ? 1 : 0) + (tfD_downtrend ? 1 : 0)

// ê±°ë˜ëŸ‰ ê¸‰ì¦ TF ê°œìˆ˜ (í˜„ì¬TF + 15m/1H/4H = 4ê°œ)
int volSpikeCount = (volSpike ? 1 : 0) + (tf15m_volSpike ? 1 : 0) + (tf1h_volSpike ? 1 : 0) + (tf4h_volSpike ? 1 : 0)

// ê³¼ë§¤ë„ TF ê°œìˆ˜
int oversoldCount = (rsi < 35 ? 1 : 0) + (tf15m_oversold ? 1 : 0) + (tf1h_oversold ? 1 : 0) + (tf4h_oversold ? 1 : 0)

// EMA ì •ë ¬ TF ê°œìˆ˜ (ê°•í•œ ì¶”ì„¸) - í˜„ì¬TF + 15m/1H/4H/D = 5ê°œ
int emaAlignedUpCount = (emaAlignedUp ? 1 : 0) + (tf15m_emaAligned ? 1 : 0) + (tf1h_emaAligned ? 1 : 0) + (tf4h_emaAligned ? 1 : 0) + (tfD_emaAligned ? 1 : 0)
int emaAlignedDnCount = (emaAlignedDown ? 1 : 0) + (tf15m_emaAlignedDn ? 1 : 0) + (tf1h_emaAlignedDn ? 1 : 0) + (tf4h_emaAlignedDn ? 1 : 0) + (tfD_emaAlignedDn ? 1 : 0)

// MACD ìƒìŠ¹ TF ê°œìˆ˜ - í˜„ì¬TF + 15m/1H/4H/D = 5ê°œ
int macdBullCount = (macdBullish ? 1 : 0) + (tf15m_macdBull ? 1 : 0) + (tf1h_macdBull ? 1 : 0) + (tf4h_macdBull ? 1 : 0) + (tfD_macdBull ? 1 : 0)

// ì „ì²´ ì¶”ì„¸ ì ìˆ˜ (0~14: 4+5+5)
int trendScore = uptrendCount + emaAlignedUpCount + macdBullCount
string trendStrength = trendScore >= 12 ? "VERY STRONG" : trendScore >= 10 ? "STRONG" : trendScore >= 7 ? "MODERATE" : trendScore >= 5 ? "WEAK" : "BEAR"

// ============================================
// â˜…â˜…â˜… í•˜ëª¨ë‹‰ íŒ¨í„´ ê°ì§€ (V42 ì‹ ê·œ) â˜…â˜…â˜…
// ============================================

// í”¼ë³´ë‚˜ì¹˜ ìƒìˆ˜
float HFIB_382 = 0.382
float HFIB_50 = 0.5
float HFIB_618 = 0.618
float HFIB_707 = 0.707
float HFIB_786 = 0.786
float HFIB_886 = 0.886
float HFIB_113 = 1.13
float HFIB_127 = 1.272
float HFIB_141 = 1.414
float HFIB_161 = 1.618

// í”¼ë³´ë‚˜ì¹˜ í—ˆìš© ì˜¤ì°¨ ì²´í¬
isWithinHarmonicTol(float value, float target, float tolerance) =>
    math.abs(value - target) <= tolerance / 100

// íŒ¨í„´ ê°ì§€ í•¨ìˆ˜ë“¤
isHarmonicGartley(float xab, float xad) =>
    xab >= 0.588 - harmonicFibTolerance/100 and xab <= 0.648 + harmonicFibTolerance/100 and isWithinHarmonicTol(xad, HFIB_786, harmonicFibTolerance)

isHarmonicBat(float xab, float xad) =>
    xab >= 0.382 - harmonicFibTolerance/100 and xab <= 0.50 + harmonicFibTolerance/100 and isWithinHarmonicTol(xad, HFIB_886, harmonicFibTolerance)

isHarmonicCrab(float xab, float xad) =>
    xab >= 0.382 - harmonicFibTolerance/100 and xab <= 0.618 + harmonicFibTolerance/100 and isWithinHarmonicTol(xad, HFIB_161, harmonicFibTolerance)

isHarmonicButterfly(float xab, float xad) =>
    xab >= 0.756 - harmonicFibTolerance/100 and xab <= 0.816 + harmonicFibTolerance/100 and isWithinHarmonicTol(xad, HFIB_127, harmonicFibTolerance)

isHarmonicCypher(float xab, float xac) =>
    xab >= 0.382 - harmonicFibTolerance/100 and xab <= 0.618 + harmonicFibTolerance/100 and xac >= 1.13 - harmonicFibTolerance/100 and xac <= 1.414 + harmonicFibTolerance/100

isHarmonic707(float xab, float xad) =>
    xab >= 0.677 - harmonicFibTolerance/100 and xab <= 0.737 + harmonicFibTolerance/100 and isWithinHarmonicTol(xad, HFIB_141, harmonicFibTolerance)

isHarmonicShark(float xab, float xad) =>
    xab >= 0.382 - harmonicFibTolerance/100 and xab <= 0.618 + harmonicFibTolerance/100 and xad >= 0.886 - harmonicFibTolerance/100 and xad <= 1.13 + harmonicFibTolerance/100

isHarmonicABCD(float ab, float cd) =>
    float ratio = cd / ab
    isWithinHarmonicTol(ratio, 1.0, harmonicFibTolerance) or isWithinHarmonicTol(ratio, HFIB_127, harmonicFibTolerance) or isWithinHarmonicTol(ratio, HFIB_161, harmonicFibTolerance)

// Deep Gartley: B 0.588-0.648, D 0.886 (PDF ê¸°ì¤€)
isHarmonicDeepGartley(float xab, float xad) =>
    xab >= 0.588 - harmonicFibTolerance/100 and xab <= 0.648 + harmonicFibTolerance/100 and isWithinHarmonicTol(xad, HFIB_886, harmonicFibTolerance)

// Deep Crab: B 0.886-0.936, D 1.618 (PDF ê¸°ì¤€)
isHarmonicDeepCrab(float xab, float xad) =>
    xab >= 0.886 - harmonicFibTolerance/100 and xab <= 0.936 + harmonicFibTolerance/100 and isWithinHarmonicTol(xad, HFIB_161, harmonicFibTolerance)

// Alternate Bat: B 0.352-0.382, D 1.13 (PDF ê¸°ì¤€)
isHarmonicAltBat(float xab, float xad) =>
    xab >= 0.352 - harmonicFibTolerance/100 and xab <= 0.382 + harmonicFibTolerance/100 and isWithinHarmonicTol(xad, HFIB_113, harmonicFibTolerance)

// 5-0 Pattern: Shark ì´í›„ BCì˜ 0.5ì—ì„œ ë°˜ì „ (PDF ê¸°ì¤€)
isHarmonicFiveZero(float xab, float xad, float bcRatio) =>
    xab >= 0.382 - harmonicFibTolerance/100 and xab <= 0.618 + harmonicFibTolerance/100 and isWithinHarmonicTol(bcRatio, HFIB_50, harmonicFibTolerance)

// í•˜ëª¨ë‹‰ ìŠ¤ìœ™ í¬ì¸íŠ¸ ìˆ˜ì§‘
var array<float> harmonicSwingHighs = array.new_float(0)
var array<float> harmonicSwingLows = array.new_float(0)
var array<int> harmonicSwingHighBars = array.new_int(0)
var array<int> harmonicSwingLowBars = array.new_int(0)

harmonicPh = ta.pivothigh(high, harmonicSwingLen, harmonicSwingLen)
harmonicPl = ta.pivotlow(low, harmonicSwingLen, harmonicSwingLen)

if not na(harmonicPh)
    array.unshift(harmonicSwingHighs, harmonicPh)
    array.unshift(harmonicSwingHighBars, bar_index - harmonicSwingLen)
    if array.size(harmonicSwingHighs) > 10
        array.pop(harmonicSwingHighs)
        array.pop(harmonicSwingHighBars)

if not na(harmonicPl)
    array.unshift(harmonicSwingLows, harmonicPl)
    array.unshift(harmonicSwingLowBars, bar_index - harmonicSwingLen)
    if array.size(harmonicSwingLows) > 10
        array.pop(harmonicSwingLows)
        array.pop(harmonicSwingLowBars)

// íŒ¨í„´ ë³€ìˆ˜
var string currentHarmonicPattern = ""
var bool currentHarmonicBullish = false
var float currentHarmonicTP1 = na
var float currentHarmonicTP2 = na
var float currentHarmonicSL = na
var float currentHarmonicQuality = 0.0
var bool currentHarmonicIsPerfect = false

// íŒ¨í„´ ì°¾ê¸° í•¨ìˆ˜
findHarmonicPattern() =>
    string patternName = ""
    bool isBullish = false
    float xP = na, float aP = na, float bP = na, float cP = na, float dP = na
    int dB = na

    if array.size(harmonicSwingHighs) >= 3 and array.size(harmonicSwingLows) >= 3
        // Bullish íŒ¨í„´
        if array.size(harmonicSwingLows) >= 3 and array.size(harmonicSwingHighs) >= 2
            tX = array.get(harmonicSwingLows, 2)
            tA = array.get(harmonicSwingHighs, 1)
            tB = array.get(harmonicSwingLows, 1)
            tC = array.get(harmonicSwingHighs, 0)
            tD = array.get(harmonicSwingLows, 0)
            tXB = array.get(harmonicSwingLowBars, 2)
            tAB = array.get(harmonicSwingHighBars, 1)
            tBB = array.get(harmonicSwingLowBars, 1)
            tCB = array.get(harmonicSwingHighBars, 0)
            tDB = array.get(harmonicSwingLowBars, 0)

            if tXB < tAB and tAB < tBB and tBB < tCB and tCB < tDB
                if tA > tX and tB < tA and tC > tB and tD < tC
                    xa = math.abs(tA - tX)
                    xabRatio = math.abs(tB - tX) / xa
                    xadRatio = math.abs(tD - tX) / xa
                    xacRatio = math.abs(tC - tX) / xa
                    ab = math.abs(tB - tA)
                    cd = math.abs(tD - tC)
                    bc = math.abs(tC - tB)
                    bcRatio = bc > 0 ? math.abs(tD - tB) / bc : 0

                    if showGartley and isHarmonicGartley(xabRatio, xadRatio)
                        patternName := "Gartley"
                    else if showDeepGartley and isHarmonicDeepGartley(xabRatio, xadRatio)
                        patternName := "Deep Gartley"
                    else if showBat and isHarmonicBat(xabRatio, xadRatio)
                        patternName := "Bat"
                    else if showAltBat and isHarmonicAltBat(xabRatio, xadRatio)
                        patternName := "Alt Bat"
                    else if showCrab and isHarmonicCrab(xabRatio, xadRatio)
                        patternName := "Crab"
                    else if showDeepCrab and isHarmonicDeepCrab(xabRatio, xadRatio)
                        patternName := "Deep Crab"
                    else if showButterfly and isHarmonicButterfly(xabRatio, xadRatio)
                        patternName := "Butterfly"
                    else if showCypher and isHarmonicCypher(xabRatio, xacRatio)
                        patternName := "Cypher"
                    else if show707 and isHarmonic707(xabRatio, xadRatio)
                        patternName := "707"
                    else if showShark and isHarmonicShark(xabRatio, xadRatio)
                        patternName := "Shark"
                    else if showFiveZero and isHarmonicFiveZero(xabRatio, xadRatio, bcRatio)
                        patternName := "5-0"
                    else if showABCD and isHarmonicABCD(ab, cd)
                        patternName := "AB=CD"

                    if patternName != ""
                        isBullish := true
                        xP := tX, aP := tA, bP := tB, cP := tC, dP := tD
                        dB := tDB

        // Bearish íŒ¨í„´
        if patternName == "" and array.size(harmonicSwingHighs) >= 3 and array.size(harmonicSwingLows) >= 2
            tX = array.get(harmonicSwingHighs, 2)
            tA = array.get(harmonicSwingLows, 1)
            tB = array.get(harmonicSwingHighs, 1)
            tC = array.get(harmonicSwingLows, 0)
            tD = array.get(harmonicSwingHighs, 0)
            tXB = array.get(harmonicSwingHighBars, 2)
            tAB = array.get(harmonicSwingLowBars, 1)
            tBB = array.get(harmonicSwingHighBars, 1)
            tCB = array.get(harmonicSwingLowBars, 0)
            tDB = array.get(harmonicSwingHighBars, 0)

            if tXB < tAB and tAB < tBB and tBB < tCB and tCB < tDB
                if tA < tX and tB > tA and tC < tB and tD > tC
                    xa = math.abs(tA - tX)
                    xabRatio = math.abs(tB - tX) / xa
                    xadRatio = math.abs(tD - tX) / xa
                    xacRatio = math.abs(tC - tX) / xa
                    ab = math.abs(tB - tA)
                    cd = math.abs(tD - tC)
                    bc = math.abs(tC - tB)
                    bcRatio = bc > 0 ? math.abs(tD - tB) / bc : 0

                    if showGartley and isHarmonicGartley(xabRatio, xadRatio)
                        patternName := "Gartley"
                    else if showDeepGartley and isHarmonicDeepGartley(xabRatio, xadRatio)
                        patternName := "Deep Gartley"
                    else if showBat and isHarmonicBat(xabRatio, xadRatio)
                        patternName := "Bat"
                    else if showAltBat and isHarmonicAltBat(xabRatio, xadRatio)
                        patternName := "Alt Bat"
                    else if showCrab and isHarmonicCrab(xabRatio, xadRatio)
                        patternName := "Crab"
                    else if showDeepCrab and isHarmonicDeepCrab(xabRatio, xadRatio)
                        patternName := "Deep Crab"
                    else if showButterfly and isHarmonicButterfly(xabRatio, xadRatio)
                        patternName := "Butterfly"
                    else if showCypher and isHarmonicCypher(xabRatio, xacRatio)
                        patternName := "Cypher"
                    else if show707 and isHarmonic707(xabRatio, xadRatio)
                        patternName := "707"
                    else if showShark and isHarmonicShark(xabRatio, xadRatio)
                        patternName := "Shark"
                    else if showFiveZero and isHarmonicFiveZero(xabRatio, xadRatio, bcRatio)
                        patternName := "5-0"
                    else if showABCD and isHarmonicABCD(ab, cd)
                        patternName := "AB=CD"

                    if patternName != ""
                        isBullish := false
                        xP := tX, aP := tA, bP := tB, cP := tC, dP := tD
                        dB := tDB

    [patternName, isBullish, xP, aP, bP, cP, dP, dB]

[detectedHarmonicPattern, harmonicBullish, hxP, haP, hbP, hcP, hdP, hdB] = findHarmonicPattern()

// TP/SL ê³„ì‚°
calcHarmonicTPSL(float a, float d, float x, bool isBullish) =>
    ad = math.abs(d - a)
    xa = math.abs(a - x)
    float tp1 = isBullish ? d + ad * 0.382 : d - ad * 0.382
    float tp2 = isBullish ? d + ad * 0.618 : d - ad * 0.618
    float sl = isBullish ? x - xa * 0.1 : x + xa * 0.1
    [tp1, tp2, sl]

// í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
calcHarmonicQuality(string patternName, float xP, float aP, float bP, float dP) =>
    if na(xP) or na(aP) or na(bP) or na(dP)
        0.0
    else
        xa = math.abs(aP - xP)
        xabRatio = math.abs(bP - xP) / xa
        xadRatio = math.abs(dP - xP) / xa
        float targetXAB = patternName == "Gartley" ? 0.618 : patternName == "Bat" ? 0.50 : patternName == "Crab" ? 0.618 : patternName == "Butterfly" ? 0.786 : patternName == "707" ? 0.707 : 0.5
        float targetXAD = patternName == "Gartley" ? 0.786 : patternName == "Bat" ? 0.886 : patternName == "Crab" ? 1.618 : patternName == "Butterfly" ? 1.272 : patternName == "707" ? 1.414 : 1.0
        float xabAccuracy = math.max(0.0, 30.0 - math.abs(xabRatio - targetXAB) * 100)
        float xadAccuracy = math.max(0.0, 30.0 - math.abs(xadRatio - targetXAD) * 50)
        math.min(100.0, 40.0 + xabAccuracy + xadAccuracy)

// íŒ¨í„´ ì—…ë°ì´íŠ¸
if detectedHarmonicPattern != "" and not na(hdB) and bar_index - hdB < 5
    currentHarmonicPattern := detectedHarmonicPattern
    currentHarmonicBullish := harmonicBullish
    currentHarmonicQuality := calcHarmonicQuality(detectedHarmonicPattern, hxP, haP, hbP, hdP)
    currentHarmonicIsPerfect := currentHarmonicQuality >= 80
    [tp1, tp2, sl] = calcHarmonicTPSL(haP, hdP, hxP, harmonicBullish)
    currentHarmonicTP1 := tp1
    currentHarmonicTP2 := tp2
    currentHarmonicSL := sl

// í•˜ëª¨ë‹‰ ì‹œê°í™”
var line hLineXA = na, var line hLineAB = na, var line hLineBC = na, var line hLineCD = na
var label hPatternLabel = na
var box hPrzBox = na
var line hTp1Line = na, var line hTp2Line = na, var line hSlLine = na

if showHarmonic and detectedHarmonicPattern != "" and not na(hdB) and bar_index - hdB < 5
    hPatternColor = harmonicBullish ? harmonicBullColor : harmonicBearColor

    line.delete(hLineXA), line.delete(hLineAB), line.delete(hLineBC), line.delete(hLineCD)
    label.delete(hPatternLabel), box.delete(hPrzBox)
    line.delete(hTp1Line), line.delete(hTp2Line), line.delete(hSlLine)

    if showHarmonicLabels
        labelY = harmonicBullish ? hdP - atrValueForTrail * 0.5 : hdP + atrValueForTrail * 0.5
        labelStyle = harmonicBullish ? label.style_label_up : label.style_label_down
        qualityStr = currentHarmonicIsPerfect ? " PERFECT" : " Q:" + str.tostring(currentHarmonicQuality, "#") + "%"
        labelText = (harmonicBullish ? "BULL " : "BEAR ") + detectedHarmonicPattern + qualityStr
        hPatternLabel := label.new(hdB, labelY, labelText, color=hPatternColor, textcolor=color.white, style=labelStyle, size=size.normal)

    if showPRZ
        xa = math.abs(haP - hxP)
        przTop = harmonicBullish ? hdP : hdP + xa * 0.1
        przBottom = harmonicBullish ? hdP - xa * 0.1 : hdP
        hPrzBox := box.new(hdB - 5, math.max(przTop, przBottom), hdB + 20, math.min(przTop, przBottom), bgcolor=przColor, border_color=color.yellow)

    if showTPSL and not na(currentHarmonicTP1)
        hTp1Line := line.new(hdB, currentHarmonicTP1, bar_index + 15, currentHarmonicTP1, color=color.lime, width=2, style=line.style_dashed)
        hTp2Line := line.new(hdB, currentHarmonicTP2, bar_index + 15, currentHarmonicTP2, color=color.lime, width=2, style=line.style_dashed)
        hSlLine := line.new(hdB, currentHarmonicSL, bar_index + 15, currentHarmonicSL, color=color.red, width=2, style=line.style_dashed)

// RSI BAMM
harmonicRsiValue = ta.rsi(close, rsiBAMMLength)
harmonicRsiOB = harmonicRsiValue > rsiBAMMOB
harmonicRsiOS = harmonicRsiValue < rsiBAMMOS
harmonicRsiCross50Up = ta.crossover(harmonicRsiValue, 50)
harmonicRsiCross50Down = ta.crossunder(harmonicRsiValue, 50)

hPriceHigh = high > ta.highest(high, 14)[1]
hPriceLow = low < ta.lowest(low, 14)[1]
hRsiHigher = harmonicRsiValue > ta.highest(harmonicRsiValue, 14)[1]
hRsiLower = harmonicRsiValue < ta.lowest(harmonicRsiValue, 14)[1]

hBullishDiv = hPriceLow and not hRsiLower and harmonicRsiValue[1] < 40
hBearishDiv = hPriceHigh and not hRsiHigher and harmonicRsiValue[1] > 60

rsiBAMMBuy = showRSIBAMM and hBullishDiv and harmonicRsiCross50Up
rsiBAMMSell = showRSIBAMM and hBearishDiv and harmonicRsiCross50Down

if rsiBAMMBuy
    label.new(bar_index, low - atrValueForTrail, "BAMM\nBUY", color=color.lime, textcolor=color.black, style=label.style_label_up, size=size.small)

if rsiBAMMSell and showShortSignals
    label.new(bar_index, high + atrValueForTrail, "BAMM\nSELL", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.small)

// ============================================
// ì •í™•ì„± í•„í„° ê³„ì‚° (V42 ì‹ ê·œ)
// ============================================
// ì¶”ì„¸ EMA
harmonicTrendEMA = ta.ema(close, trendEMALen)
harmonicBullishTrend = close > harmonicTrendEMA and harmonicTrendEMA > harmonicTrendEMA[5]
harmonicBearishTrend = close < harmonicTrendEMA and harmonicTrendEMA < harmonicTrendEMA[5]

// ê±°ë˜ëŸ‰ í™•ì¸
harmonicVolumeMA = ta.sma(volume, 20)
harmonicVolumeConfirm = volume > harmonicVolumeMA * harmonicVolumeMultiplier

// RSI í™•ì¸
harmonicRsiConfirmBull = harmonicRsiValue < rsiConfirmLevel
harmonicRsiConfirmBear = harmonicRsiValue > (100 - rsiConfirmLevel)

// ì»¨í”Œë£¨ì–¸ìŠ¤ ì ìˆ˜ (5ê°€ì§€ ì¡°ê±´)
calcHarmonicConfluence(bool isBullish) =>
    int confScore = 0
    // 1. ì¶”ì„¸ í™•ì¸
    confScore += (isBullish and harmonicBullishTrend) or (not isBullish and harmonicBearishTrend) ? 1 : 0
    // 2. RSI í™•ì¸
    confScore += (isBullish and harmonicRsiConfirmBull) or (not isBullish and harmonicRsiConfirmBear) ? 1 : 0
    // 3. ê±°ë˜ëŸ‰ í™•ì¸
    confScore += harmonicVolumeConfirm ? 1 : 0
    // 4. MACD ë°©í–¥ í™•ì¸
    confScore += (isBullish and macdBullish) or (not isBullish and not macdBullish) ? 1 : 0
    // 5. EMA200 ìœ„ì¹˜ í™•ì¸
    confScore += (isBullish and close > ema200) or (not isBullish and close < ema200) ? 1 : 0
    confScore

harmonicConfluenceBull = calcHarmonicConfluence(true)
harmonicConfluenceBear = calcHarmonicConfluence(false)

// í•„í„° í†µê³¼ ì—¬ë¶€
passHarmonicQualityFilter = currentHarmonicQuality >= minQualityScore and (not requirePerfect or currentHarmonicIsPerfect)
passHarmonicTrendFilter = not useTrendFilter or (currentHarmonicBullish and harmonicBullishTrend) or (not currentHarmonicBullish and harmonicBearishTrend)
passHarmonicRSIFilter = not useRSIConfirm or (currentHarmonicBullish and harmonicRsiConfirmBull) or (not currentHarmonicBullish and harmonicRsiConfirmBear)
passHarmonicVolumeFilter = not useHarmonicVolumeFilter or harmonicVolumeConfirm
passHarmonicConfluenceFilter = not useConfluence or (currentHarmonicBullish ? harmonicConfluenceBull : harmonicConfluenceBear) >= minConfluenceScore

passAllHarmonicFilters = passHarmonicQualityFilter and passHarmonicTrendFilter and passHarmonicRSIFilter and passHarmonicVolumeFilter and passHarmonicConfluenceFilter

// í•„í„° ì ìš©ëœ í•˜ëª¨ë‹‰ ì‹ í˜¸
filteredHarmonicSignal = detectedHarmonicPattern != "" and passAllHarmonicFilters
filteredHarmonicBullSignal = filteredHarmonicSignal and harmonicBullish
filteredHarmonicBearSignal = filteredHarmonicSignal and not harmonicBullish

// ============================================
// 30ì  ì ìˆ˜ ì‹œìŠ¤í…œ (V37 ë°©ì‹)
// ============================================

// LONG ì ìˆ˜
float longScore = 0

// ì¶”ì„¸ (8ì )
longScore += emaAlignedUp ? 3 : (ema8 > ema21 ? 1 : 0)
longScore += aboveEMA200 ? 2 : 0
longScore += tf1h_uptrend ? 2 : 0
longScore += tf4h_uptrend ? 1 : 0

// ëª¨ë©˜í…€ (8ì )
longScore += stochOversold ? 3 : (stochK < 40 and stochBullish ? 2 : stochBullish ? 1 : 0)
longScore += macdBullish ? 2 : 0
longScore += rsiOversold ? 2 : (rsi < 45 ? 1 : 0)
longScore += (bullishDI and trendStrong) ? 1 : 0

// ê±°ë˜ëŸ‰ (6ì )
longScore += volumeExplosion and strongBuyPressure ? 3 : (volSpike and strongBuyPressure ? 2 : volSpike ? 1 : 0)
int multiTFVolCount = (tf15m_volSpike ? 1 : 0) + (tf1h_volSpike ? 1 : 0) + (tf4h_volSpike ? 1 : 0)
bool multiTFVolume = multiTFVolCount >= 2
longScore += multiTFVolume and strongBuyPressure ? 3 : (multiTFVolume ? 2 : 0)

// êµ¬ì¡° (8ì )
longScore += atSupport3d ? 3 : (nearSupport3d ? 2 : 0)
longScore += pricePosition < 20 ? 2 : 0
longScore += touchBBLower ? 2 : 0
longScore += bullishDivergence ? 1 : 0

// Volume Delta (4ì ) - í˜¸ê°€ì°½ ëŒ€ì²´ ë¶„ì„
longScore += strongPositiveDelta and delta3ConsecutiveBuy ? 3 : (positiveDelta and cvdUptrend ? 2 : positiveDelta ? 1 : 0)
longScore += deltaBullDiv ? 1 : 0  // Delta ê°•ì„¸ ë‹¤ì´ë²„ì „ìŠ¤

// ìŠ¤ë§ˆíŠ¸ OBV ì ìˆ˜ (ì­ ì›¨ì´ë“œ ì „ëµ)
longScore += squeezeBreakoutUp ? 3 : (smartOBVMomentumUp ? 2 : smartOBVAboveCenter ? 1 : 0)
longScore += smartOBVCrossUp ? 1 : 0  // ë§¤ìˆ˜ì„¸ ì „í™˜ ì‹ í˜¸

// â˜… í•˜ëª¨ë‹‰ íŒ¨í„´ ì ìˆ˜ (V42 ì‹ ê·œ) â˜…
longScore += filteredHarmonicBullSignal ? 5 : (detectedHarmonicPattern != "" and harmonicBullish ? 3 : 0)
longScore += rsiBAMMBuy ? 2 : 0

// SHORT ì ìˆ˜ìš© Delta (ì°¸ê³ )
float shortDeltaScore = strongNegativeDelta and delta3ConsecutiveSell ? 3 : (negativeDelta and cvdDowntrend ? 2 : negativeDelta ? 1 : 0)
shortDeltaScore += deltaBearDiv ? 1 : 0

// ============================================
// ê³ í™•ì‹  ì¡°ê±´ (V37 ë°©ì‹ + Delta ê°•í™”)
// ============================================

// [í™•ì‹ ë„ 1] HTF ì¶”ì„¸ ì¼ì¹˜ + ì§€ì§€ì„  + ê±°ë˜ëŸ‰ = ìµœê³  ìŠ¹ë¥ 
bool highConf1 = tf1h_uptrend and tf4h_uptrend and (atSupport3d or pricePosition < 10) and volSpike and strongBuyPressure

// [í™•ì‹ ë„ 2] ë‹¤ì´ë²„ì „ìŠ¤ + ê³¼ë§¤ë„ + ê±°ë˜ëŸ‰ = ë°˜ì „ í™•ë¥ 
bool highConf2 = bullishDivergence and (rsiOversold or stochOversold) and volSpike

// [í™•ì‹ ë„ 3] BB í•˜ë‹¨ + ê³¼ë§¤ë„ + HTF ìƒìŠ¹ = ë°”ìš´ìŠ¤
bool highConf3 = touchBBLower and stochOversold and tf1h_uptrend and volSpike

// [í™•ì‹ ë„ 4] EMA ì •ë ¬ + ADX ê°•í•¨ + MTF ê±°ë˜ëŸ‰ = ì¶”ì„¸ ì§€ì†
bool highConf4 = emaAlignedUp and aboveEMA200 and trendStrong and multiTFVolume

// [í™•ì‹ ë„ 5] Delta ê°•ì„¸ + CVD ìƒìŠ¹ + HTF ìƒìŠ¹ = ìˆ˜ê¸‰ í™•ì¸
bool highConf5 = strongPositiveDelta and cvdUptrend and delta3ConsecutiveBuy and tf1h_uptrend

// [í™•ì‹ ë„ 6] Delta ë‹¤ì´ë²„ì „ìŠ¤ + ê³¼ë§¤ë„ = ë°˜ì „ ìˆ˜ê¸‰
bool highConf6 = deltaBullDiv and (rsiOversold or stochOversold) and nearSupport3d

// [í™•ì‹ ë„ 7] í•˜ëª¨ë‹‰ íŒ¨í„´ (í•„í„° í†µê³¼) + ì¶”ì„¸ ì¼ì¹˜ = ê³ ì •í™• ë°˜ì „
bool highConf7 = filteredHarmonicBullSignal and tf1h_uptrend and harmonicVolumeConfirm

// [í™•ì‹ ë„ 8] RSI BAMM ë§¤ìˆ˜ + ì§€ì§€ì„  = ê°•ë ¥ ë°˜ì „
bool highConf8 = rsiBAMMBuy and nearSupport3d and volSpike

// ë†’ì€ í™•ì‹ ë„ LONG
bool highConfidenceLong = highConf1 or highConf2 or highConf3 or highConf4 or highConf5 or highConf6 or highConf7 or highConf8

// í™•ì‹ ë„ ì´ìœ 
string confReason = highConf1 ? "HTF+SR+VOL" : highConf2 ? "DIV+OVERSOLD" : highConf3 ? "BB+OVERSOLD" : highConf4 ? "TREND+VOL" : highConf5 ? "DELTA+CVD" : highConf6 ? "DELTA_DIV" : highConf7 ? "HARMONIC" : highConf8 ? "RSI_BAMM" : "-"

// ============================================
// ì‹ í˜¸ ë“±ê¸‰ ì‹œìŠ¤í…œ (30% ê°•í™”)
// ============================================

// Së“±ê¸‰: 3TF ìƒìŠ¹ + ì§€ì§€ê·¼ì²˜ + ê±°ë˜ëŸ‰ + ê³ í™•ì‹  + ë§¤ìˆ˜ì••ë ¥
bool gradeS = uptrendCount >= 3 and nearSupport3d and volSpikeCount >= 1 and highConfidenceLong and buyPressure > 52

// Aë“±ê¸‰: 3TF ìƒìŠ¹ + ê±°ë˜ëŸ‰ + ë§¤ìˆ˜ì••ë ¥ ê°•í™”
bool gradeA = uptrendCount >= 3 and volSpikeCount >= 1 and buyPressure > 55

// Bë“±ê¸‰: 2TF ìƒìŠ¹ + 1H ìƒìŠ¹
bool gradeB = uptrendCount >= 2 and tf1h_uptrend

// í˜„ì¬ ë“±ê¸‰ (ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œë„ í‘œì‹œ)
string currentGrade = gradeS ? "S" : longScore >= 22 ? "A+" : gradeA ? "A" : longScore >= 16 ? "B+" : gradeB ? "B" : "C"

// ============================================
// LONG ì‹œê·¸ë„ ì¡°ê±´
// ============================================

// ê°•ë ¥ LONG: Së“±ê¸‰ ë˜ëŠ” Aë“±ê¸‰
bool strongLong = gradeS or gradeA

// ì¼ë°˜ LONG: Bë“±ê¸‰ ì´ìƒ
bool normalLong = gradeB and not strongLong

// SUPER LONG: ëª¨ë“  ì¡°ê±´ ì¼ì¹˜ (ê¸°ì¡´ STRONG + SMC + Smart Trail)
bool superLong = strongLong and smcBullish and smartTrailUp and (isBullishOB or isBullishFVG or chochUp)

// ëŒ€ê¸°: Cë“±ê¸‰
bool waitSignal = not strongLong and not normalLong

// ============================================
// SHORT ë“±ê¸‰ ì‹œìŠ¤í…œ (30% ê°•í™”)
// ============================================

// SHORT Së“±ê¸‰: 3TF í•˜ë½ + ì €í•­ê·¼ì²˜ + ê±°ë˜ëŸ‰ + ë§¤ë„ì••ë ¥
bool gradeS_short = downtrendCount >= 3 and nearResistance3d and volSpikeCount >= 1 and buyPressure < 48

// SHORT Aë“±ê¸‰: 2TF í•˜ë½ + ê±°ë˜ëŸ‰ + ë§¤ë„ì••ë ¥
bool gradeA_short = downtrendCount >= 2 and volSpikeCount >= 1 and buyPressure < 52

// SHORT Bë“±ê¸‰: 2TF í•˜ë½ + 1H í•˜ë½
bool gradeB_short = downtrendCount >= 2 and not tf1h_uptrend

// SHORT ì‹œê·¸ë„
bool superShort = showShortSignals and gradeS_short and smcBearish and not smartTrailUp
bool strongShort = showShortSignals and (gradeS_short or gradeA_short) and not superShort
bool normalShort = showShortSignals and gradeB_short and not strongShort and not superShort

// ìµœì¢… ë“±ê¸‰ ì—…ë°ì´íŠ¸
string finalGrade = superLong ? "SUPER" : currentGrade

// ============================================
// ë§¤ë„ ì‹œê·¸ë„ (Smart Trail ê¸°ë°˜)
// ============================================

// Smart Trail ì „í™˜ ê°ì§€
var bool prevSmartTrailUp = true
bool trailFlipToShort = prevSmartTrailUp and not smartTrailUp  // LONG â†’ SHORT ì „í™˜
bool trailFlipToLong = not prevSmartTrailUp and smartTrailUp   // SHORT â†’ LONG ì „í™˜
prevSmartTrailUp := smartTrailUp

// ì²­ì‚° ì‹œê·¸ë„ (ë” ì—„ê²©í•œ ì¡°ê±´: Trailì „í™˜ + ì ìˆ˜ë‚®ìŒ + 1Hí•˜ë½)
bool exitLongSignal = trailFlipToShort and longScore < 12 and not tf1h_uptrend

// EXIT SHORT ì‹œê·¸ë„
bool exitShortSignal = trailFlipToLong and not tf1h_uptrend == false

// ============================================
// V40 í•„í„° ì‹œìŠ¤í…œ
// ============================================

// 1. ë™ì  íŒŒë¼ë¯¸í„° (ATR ê¸°ë°˜)
float atrValue = ta.atr(atrPeriod)
float atrSMA = ta.sma(atrValue, atrPeriod)
float atrRatio = atrValue / atrSMA
bool highVolatility = enableDynamicParams and atrRatio > highVolThreshold
bool lowVolatility = enableDynamicParams and atrRatio < lowVolThreshold

// ë™ì  ì¿¨ë‹¤ìš´ (ë³€ë™ì„±ì— ë”°ë¼ ì¡°ì •)
int dynamicCooldownBars = enableDynamicParams and dynamicCooldown ?
     (highVolatility ? math.floor(cooldownBars * 0.6) :  // ê³ ë³€ë™ì„±: ì¿¨ë‹¤ìš´ 40% ë‹¨ì¶•
      lowVolatility ? math.floor(cooldownBars * 1.5) :   // ì €ë³€ë™ì„±: ì¿¨ë‹¤ìš´ 50% ì—°ì¥
      cooldownBars) : cooldownBars

// 2. ì¿¨ë‹¤ìš´ ì‹œìŠ¤í…œ
var int lastSignalBar = 0
int barsSinceSignal = bar_index - lastSignalBar
bool cooldownActive = enableCooldown and barsSinceSignal < dynamicCooldownBars
bool cooldownPass = not enableCooldown or not cooldownActive

// 3. ë³¼ë¥¨ í•„í„°
float volumeAvg = ta.sma(volume, volumeAvgLength)
bool volumeFilterPass = not enableVolumeFilter or (volume >= volumeAvg * minVolumeRatio)

// 4. ì‹œê°„ í•„í„° (UTC ê¸°ì¤€)
int hourUTC = hour(time, "UTC")
bool asiaEUTransition = excludeAsiaEU and hourUTC >= 8 and hourUTC < 10
bool euUSTransition = excludeEUUS and hourUTC >= 14 and hourUTC < 16
bool timeFilterPass = not enableTimeFilter or (not asiaEUTransition and not euUSTransition)

// ============================================
// 5. ICT Killzones (ê¸°ê´€ ë§¤ë§¤ ì‹œê°„ëŒ€)
// ============================================
// London Open: 08:00-10:00 UTC (ê°€ì¥ í™œë°œ)
bool inLondonOpen = kzLondonOpen and hourUTC >= 8 and hourUTC < 10

// NY Open: 13:00-15:00 UTC (ë‘ ë²ˆì§¸ë¡œ í™œë°œ)
bool inNYOpen = kzNYOpen and hourUTC >= 13 and hourUTC < 15

// London Close: 15:00-17:00 UTC (í° ì›€ì§ì„)
bool inLondonClose = kzLondonClose and hourUTC >= 15 and hourUTC < 17

// Asian Open: 00:00-02:00 UTC (ì„ íƒì )
bool inAsianOpen = kzAsianOpen and hourUTC >= 0 and hourUTC < 2

// Killzone ë‚´ë¶€ì¸ì§€ í™•ì¸
bool inKillzone = inLondonOpen or inNYOpen or inLondonClose or inAsianOpen
bool killzonePass = not enableKillzones or inKillzone

// Killzone ì´ë¦„ (í…Œì´ë¸”ìš©)
string currentKillzone = inLondonOpen ? "London Open" :
                         inNYOpen ? "NY Open" :
                         inLondonClose ? "London Close" :
                         inAsianOpen ? "Asian" : "Outside KZ"

// ============================================
// 6. Liquidity Sweep (ìœ ë™ì„± ìŠ¤ìœ• ê°ì§€)
// ============================================
// ìµœê·¼ ê³ ì /ì €ì  ì°¾ê¸°
float recentHigh = ta.highest(high, liqSweepLookback)
float recentLow = ta.lowest(low, liqSweepLookback)

// ìº”ë“¤ ê¼¬ë¦¬ ê³„ì‚°
float upperWick = high - math.max(open, close)
float lowerWick = math.min(open, close) - low
float bodySize = math.abs(close - open)
float candleRange = high - low

// ê¼¬ë¦¬ ë¹„ìœ¨ (%)
float upperWickRatio = candleRange > 0 ? upperWick / candleRange * 100 : 0
float lowerWickRatio = candleRange > 0 ? lowerWick / candleRange * 100 : 0

// Liquidity Sweep ì¡°ê±´
// Bullish Sweep: ì €ì  ëŒíŒŒ í›„ ìœ„ë¡œ ë§ˆê° (ê¸´ ì•„ë˜ê¼¬ë¦¬)
bool bullishSweep = enableLiqSweep and low <= recentLow[1] and close > open and lowerWickRatio >= liqSweepMinWick * 10 and close > low + candleRange * 0.5

// Bearish Sweep: ê³ ì  ëŒíŒŒ í›„ ì•„ë˜ë¡œ ë§ˆê° (ê¸´ ìœ„ê¼¬ë¦¬)
bool bearishSweep = enableLiqSweep and high >= recentHigh[1] and close < open and upperWickRatio >= liqSweepMinWick * 10 and close < high - candleRange * 0.5

// Sweep ì‹ í˜¸ (ì§„ì…ì— í™œìš©)
bool liqSweepBullish = bullishSweep
bool liqSweepBearish = bearishSweep

// V40 ì¢…í•© í•„í„° (Killzone ì¶”ê°€)
bool v40FilterPass = cooldownPass and volumeFilterPass and timeFilterPass and killzonePass

// ============================================
// 7. ì²­ì‚° ë§¤ë¬¼ëŒ€ (Liquidation Levels)
// ============================================

// ë¡± ì²­ì‚°ê°€ = ì§„ì…ê°€ * (1 - 1/ë ˆë²„ë¦¬ì§€ + ìœ ì§€ë§ˆì§„ìœ¨)
// ìˆ ì²­ì‚°ê°€ = ì§„ì…ê°€ * (1 + 1/ë ˆë²„ë¦¬ì§€ - ìœ ì§€ë§ˆì§„ìœ¨)

float liqLong10x = close * (1 - 1/10.0 + liqMaintenanceMargin)
float liqLong25x = close * (1 - 1/25.0 + liqMaintenanceMargin)
float liqLong50x = close * (1 - 1/50.0 + liqMaintenanceMargin)
float liqLong100x = close * (1 - 1/100.0 + liqMaintenanceMargin)

float liqShort10x = close * (1 + 1/10.0 - liqMaintenanceMargin)
float liqShort25x = close * (1 + 1/25.0 - liqMaintenanceMargin)
float liqShort50x = close * (1 + 1/50.0 - liqMaintenanceMargin)
float liqShort100x = close * (1 + 1/100.0 - liqMaintenanceMargin)

// ì²­ì‚° êµ¬ê°„ ê·¼ì ‘ ê°ì§€ (1% ì´ë‚´)
bool nearLongLiq50x = low <= liqLong50x * 1.01 and low >= liqLong50x * 0.99
bool nearLongLiq100x = low <= liqLong100x * 1.01 and low >= liqLong100x * 0.99
bool nearShortLiq50x = high >= liqShort50x * 0.99 and high <= liqShort50x * 1.01
bool nearShortLiq100x = high >= liqShort100x * 0.99 and high <= liqShort100x * 1.01

// ì²­ì‚° ìŠ¤ìœ• ê°ì§€ (ì²­ì‚° ë ˆë²¨ ëŒíŒŒ í›„ ë°˜ì „) - ì¿¨ë‹¤ìš´ ì ìš©
// ì¡°ê±´ ê°•í™”: ì´ì „ ë´‰ ì¢…ê°€ê°€ ë ˆë²¨ ìœ„ì— ìˆì—ˆëŠ”ë°, í˜„ì¬ ë´‰ì—ì„œ ì•„ë˜ë¡œ ê°”ë‹¤ê°€ ë‹¤ì‹œ ìœ„ë¡œ ë§ˆê°
bool longLiq50xSweepRaw = low < liqLong50x and close > liqLong50x and close[1] > liqLong50x
bool longLiq100xSweepRaw = low < liqLong100x and close > liqLong100x and close[1] > liqLong100x
bool shortLiq50xSweepRaw = high > liqShort50x and close < liqShort50x and close[1] < liqShort50x
bool shortLiq100xSweepRaw = high > liqShort100x and close < liqShort100x and close[1] < liqShort100x

// ë ˆë²„ë¦¬ì§€ ì²­ì‚° ìŠ¤ìœ• ì¿¨ë‹¤ìš´ (15ë´‰)
var int lastLevLongLiqBar = 0
var int lastLevShortLiqBar = 0
int levLiqCooldown = 15

bool longLiq50xSweep = longLiq50xSweepRaw and (bar_index - lastLevLongLiqBar > levLiqCooldown)
bool longLiq100xSweep = longLiq100xSweepRaw and (bar_index - lastLevLongLiqBar > levLiqCooldown)
bool shortLiq50xSweep = shortLiq50xSweepRaw and (bar_index - lastLevShortLiqBar > levLiqCooldown)
bool shortLiq100xSweep = shortLiq100xSweepRaw and (bar_index - lastLevShortLiqBar > levLiqCooldown)

// ì¿¨ë‹¤ìš´ ì—…ë°ì´íŠ¸
if longLiq50xSweep or longLiq100xSweep
    lastLevLongLiqBar := bar_index
if shortLiq50xSweep or shortLiq100xSweep
    lastLevShortLiqBar := bar_index

// ì²­ì‚° ìŠ¤ìœ• í†µí•© (ëŒ€ëŸ‰ ì²­ì‚° í›„ ë°˜ì „ = ê°•í•œ ì‹ í˜¸)
bool bullishLiqSweep = (longLiq50xSweep or longLiq100xSweep) and liqSweepBoost
bool bearishLiqSweep = (shortLiq50xSweep or shortLiq100xSweep) and liqSweepBoost

// ì‹œê·¸ë„ ëª¨ë“œì— ë”°ë¥¸ í•„í„°ë§ (V40 í•„í„° ì ìš©)
// V40+: Liquidity Sweep ë˜ëŠ” ì²­ì‚° ìŠ¤ìœ• ì‹œ STRONG â†’ SUPERë¡œ ìŠ¹ê²©
bool sweepUpgrade = (liqSweepBullish or bullishLiqSweep) and strongLong and not superLong
bool showSuperLong = (superLong or sweepUpgrade) and v40FilterPass and (signalMode == "ì „ì²´" or signalMode == "STRONG ì´ìƒ" or signalMode == "SUPERë§Œ")
bool showStrongLong = strongLong and not superLong and not sweepUpgrade and v40FilterPass and (signalMode == "ì „ì²´" or signalMode == "STRONG ì´ìƒ") and (nearSupport3d or smcBullish)
bool showNormalLong = normalLong and v40FilterPass and signalMode == "ì „ì²´"

// ì‹ í˜¸ ë°œìƒ ì‹œ ì¿¨ë‹¤ìš´ ì‹œì‘
if showSuperLong or showStrongLong or showNormalLong
    lastSignalBar := bar_index

// ============================================
// ì‹¬ë¦¬ì  ë§¤ë§¤ êµ¬ê°„ ë¶„ì„
// ============================================

// 1. ë¼ìš´ë“œ ë„˜ë²„ (Round Numbers)
float roundBelow = math.floor(close / roundNumInterval) * roundNumInterval
float roundAbove = roundBelow + roundNumInterval
float distToRoundBelow = math.abs(close - roundBelow) / close * 100
float distToRoundAbove = math.abs(roundAbove - close) / close * 100
bool nearRoundBelow = distToRoundBelow < 1.0  // 1% ì´ë‚´
bool nearRoundAbove = distToRoundAbove < 1.0
bool atRoundNumber = distToRoundBelow < 0.3 or distToRoundAbove < 0.3  // 0.3% ì´ë‚´

// 2. ê³µí¬/íƒìš• ì§€í‘œ (Fear & Greed)
// RSI ê¸°ë°˜ + ê°€ê²© í¸ì°¨ + ë³¼ë¥¨
float ema20 = ta.ema(close, 20)
float priceDeviation = (close - ema20) / ema20 * 100  // EMA20 ëŒ€ë¹„ í¸ì°¨
float rsiNorm = (rsi - 50) / 50  // -1 ~ +1 ì •ê·œí™”
float volNorm = math.min((volRatio - 1) / 4, 1)  // 0 ~ 1 ì •ê·œí™”

// ê³µí¬/íƒìš• ì ìˆ˜ (-100 ~ +100)
float fearGreedRaw = (rsiNorm * 40) + (priceDeviation * 3) + (volNorm * 20 * (close > ema20 ? 1 : -1))
float fearGreedScore = math.max(-100, math.min(100, fearGreedRaw))

// ê³µí¬/íƒìš• ë“±ê¸‰
string fearGreedGrade = fearGreedScore <= -60 ? "ê·¹ë‹¨ì ê³µí¬" : fearGreedScore <= -30 ? "ê³µí¬" : fearGreedScore <= -10 ? "ì•½í•œê³µí¬" : fearGreedScore < 10 ? "ì¤‘ë¦½" : fearGreedScore < 30 ? "ì•½í•œíƒìš•" : fearGreedScore < 60 ? "íƒìš•" : "ê·¹ë‹¨ì íƒìš•"

string fearGreedEmoji = fearGreedScore <= -60 ? "ğŸ˜±" : fearGreedScore <= -30 ? "ğŸ˜¨" : fearGreedScore <= -10 ? "ğŸ˜Ÿ" : fearGreedScore < 10 ? "ğŸ˜" : fearGreedScore < 30 ? "ğŸ™‚" : fearGreedScore < 60 ? "ğŸ˜€" : "ğŸ¤‘"

color fearGreedColor = fearGreedScore <= -60 ? color.new(color.green, 0) : fearGreedScore <= -30 ? color.new(color.lime, 20) : fearGreedScore <= -10 ? color.new(color.teal, 30) : fearGreedScore < 10 ? color.new(color.gray, 50) : fearGreedScore < 30 ? color.new(color.orange, 30) : fearGreedScore < 60 ? color.new(color.red, 20) : color.new(color.fuchsia, 0)

// ë§¤ìˆ˜/ë§¤ë„ ì‹¬ë¦¬ êµ¬ê°„
bool psychBuyZone = fearGreedScore <= -30 and nearSupport3d  // ê³µí¬ + ì§€ì§€ëŒ€ ê·¼ì²˜
bool psychSellZone = fearGreedScore >= 30 and nearResistance3d  // íƒìš• + ì €í•­ëŒ€ ê·¼ì²˜
bool extremeFear = fearGreedScore <= -60  // ê·¹ë‹¨ì  ê³µí¬ = ê°•í•œ ë§¤ìˆ˜ ì‹ í˜¸
bool extremeGreed = fearGreedScore >= 60  // ê·¹ë‹¨ì  íƒìš• = ê°•í•œ ë§¤ë„ ì‹ í˜¸

// 3. ë³¼ë¥¨ í”„ë¡œíŒŒì¼ ê¸°ë°˜ ì§€ì§€/ì €í•­ (ê°„ëµ ë²„ì „)
float volHigh = ta.highest(volume, 50)
float volLow = ta.lowest(volume, 50)
float volAvg50 = ta.sma(volume, 50)
bool highVolBar = volume > volAvg50 * 2

// ê³ ê±°ë˜ëŸ‰ ë°œìƒ ê°€ê²©ëŒ€ ì¶”ì  (ìµœê·¼ 50ë´‰ ì¤‘ ê³ ê±°ë˜ëŸ‰ ë°œìƒí•œ ê°€ê²©)
var float volSupportLevel = na
var float volResistanceLevel = na

if highVolBar and close > open
    volSupportLevel := low
if highVolBar and close < open
    volResistanceLevel := high

bool nearVolSupport = not na(volSupportLevel) and math.abs(close - volSupportLevel) / close * 100 < 1.5
bool nearVolResistance = not na(volResistanceLevel) and math.abs(close - volResistanceLevel) / close * 100 < 1.5

// 4. í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨
float fibHigh = ta.highest(high, fibLookback)
float fibLow = ta.lowest(low, fibLookback)
float fibRange = fibHigh - fibLow

float fib236 = fibHigh - fibRange * 0.236
float fib382 = fibHigh - fibRange * 0.382
float fib500 = fibHigh - fibRange * 0.5
float fib618 = fibHigh - fibRange * 0.618
float fib786 = fibHigh - fibRange * 0.786

bool nearFib382 = math.abs(close - fib382) / close * 100 < 0.5
bool nearFib500 = math.abs(close - fib500) / close * 100 < 0.5
bool nearFib618 = math.abs(close - fib618) / close * 100 < 0.5

// 5. ì£¼ìš” ê³ ì /ì €ì  (ì‹¬ë¦¬ì  ì§€ì§€/ì €í•­)
float keyHigh1 = ta.highest(high, keyLevelLookback)
float keyLow1 = ta.lowest(low, keyLevelLookback)
float keyHigh2 = ta.highest(high, keyLevelLookback * 2)
float keyLow2 = ta.lowest(low, keyLevelLookback * 2)

// ì‹¬ë¦¬ì  ìŠ¤ìœ™ ê³ ì /ì €ì  ì°¾ê¸° (ê¸°ì¡´ swingHighì™€ ë³„ë„)
float psychSwingHigh = ta.pivothigh(high, 15, 15)
float psychSwingLow = ta.pivotlow(low, 15, 15)

var float lastPsychHigh = na
var float lastPsychLow = na
var float prevPsychHigh = na
var float prevPsychLow = na

if not na(psychSwingHigh)
    prevPsychHigh := lastPsychHigh
    lastPsychHigh := psychSwingHigh
if not na(psychSwingLow)
    prevPsychLow := lastPsychLow
    lastPsychLow := psychSwingLow

bool nearKeyHigh = not na(lastPsychHigh) and math.abs(close - lastPsychHigh) / close * 100 < 1.0
bool nearKeyLow = not na(lastPsychLow) and math.abs(close - lastPsychLow) / close * 100 < 1.0

// 6. POC (Point of Control) - ê±°ë˜ëŸ‰ ì§‘ì¤‘ ê°€ê²©ëŒ€
var float[] priceVolume = array.new_float(20, 0.0)
var float[] priceLevels = array.new_float(20, 0.0)

float priceRangeHigh = ta.highest(high, pocLookback)
float priceRangeLow = ta.lowest(low, pocLookback)
float priceStep = (priceRangeHigh - priceRangeLow) / 20

// í˜„ì¬ ë´‰ì˜ ê°€ê²©ëŒ€ ì¸ë±ìŠ¤
int priceIndex = priceStep > 0 ? math.min(19, math.max(0, int((close - priceRangeLow) / priceStep))) : 0

// ê±°ë˜ëŸ‰ ëˆ„ì 
if bar_index > pocLookback
    array.set(priceVolume, priceIndex, array.get(priceVolume, priceIndex) + volume)
    array.set(priceLevels, priceIndex, priceRangeLow + priceStep * priceIndex + priceStep / 2)

// POC ì°¾ê¸° (ê°€ì¥ ê±°ë˜ëŸ‰ ë§ì€ ê°€ê²©ëŒ€)
var float pocPrice = na
var float maxVol = 0.0
var float hvnPrice1 = na  // High Volume Node 1
var float hvnPrice2 = na  // High Volume Node 2

if barstate.islast
    maxVol := 0.0
    float secondMaxVol = 0.0
    for i = 0 to 19
        float vol = array.get(priceVolume, i)
        if vol > maxVol
            secondMaxVol := maxVol
            hvnPrice2 := hvnPrice1
            maxVol := vol
            pocPrice := array.get(priceLevels, i)
            hvnPrice1 := pocPrice
        else if vol > secondMaxVol
            secondMaxVol := vol
            hvnPrice2 := array.get(priceLevels, i)

bool nearPOC = not na(pocPrice) and math.abs(close - pocPrice) / close * 100 < 0.5

// ì¢…í•© ì‹¬ë¦¬ì  êµ¬ê°„ íŒë‹¨
string psychZone = extremeFear ? "ê·¹ë‹¨ì ê³µí¬" : extremeGreed ? "ê·¹ë‹¨ì íƒìš•" : psychBuyZone ? "ë§¤ìˆ˜êµ¬ê°„" : psychSellZone ? "ë§¤ë„êµ¬ê°„" : nearRoundBelow ? "ë¼ìš´ë“œì§€ì§€" : nearRoundAbove ? "ë¼ìš´ë“œì €í•­" : nearFib618 ? "Fib618" : nearFib500 ? "Fib500" : nearFib382 ? "Fib382" : "ì¤‘ë¦½"

// ============================================
// ì°¨íŠ¸ í‘œì‹œ
// ============================================

// EMA
plot(showEMA ? ema8 : na, color=color.yellow, linewidth=1, title="EMA 8")
plot(showEMA ? ema21 : na, color=color.orange, linewidth=2, title="EMA 21")
plot(showEMA ? ema55 : na, color=color.blue, linewidth=1, title="EMA 55")
plot(showEMA ? ema200 : na, color=color.purple, linewidth=1, title="EMA 200")

// EMA ê°ë„ ìƒ‰ìƒ ë¼ì¸ (ì¶”ì„¸ ê°•ë„ ì‹œê°í™”)
plot(showEMAAngle ? emaAngle14 : na, color=emaAngleColor, linewidth=3, title="EMA Angle")

// ë³¼ë¦°ì €ë°´ë“œ
plot(showBB ? bbUpper : na, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(showBB ? bbBasis : na, color=color.new(color.gray, 70), linewidth=1, title="BB Basis")
plot(showBB ? bbLower : na, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")

// ============================================
// ì¼ëª©ê· í˜•í‘œ êµ¬ë¦„ ì‹œê°í™”
// ============================================
// ì„ í–‰ìŠ¤íŒ¬A/Bë¥¼ 26ì¼ ì•ì— í‘œì‹œ (offset)
p1 = plot(showIchimoku ? senkouSpanA : na, offset=displacement, color=color.new(color.green, 80), linewidth=1, title="Senkou A")
p2 = plot(showIchimoku ? senkouSpanB : na, offset=displacement, color=color.new(color.red, 80), linewidth=1, title="Senkou B")

// êµ¬ë¦„ ì±„ìš°ê¸° (ì–‘ìš´=ì´ˆë¡, ìŒìš´=ë¹¨ê°•)
fill(p1, p2, color=senkouSpanA > senkouSpanB ? color.new(color.green, 85) : color.new(color.red, 85), title="Ichimoku Cloud")

// ë‹¤ì´ë²„ì „ìŠ¤ í‘œì‹œ (plot ì œí•œìœ¼ë¡œ ë¹„í™œì„±í™”)
// plotshape(showDivergence and bullishDivergence, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 20), text="DIV+", textcolor=color.white, size=size.tiny, title="Bullish Div", offset=-pivotRight)
// plotshape(showDivergence and bearishDivergence, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 20), text="DIV-", textcolor=color.white, size=size.tiny, title="Bearish Div", offset=-pivotRight)

// ============================================
// ì‹¬ë¦¬ì  êµ¬ê°„ ì‹œê°í™”
// ============================================

// ë¼ìš´ë“œ ë„˜ë²„ ë¼ì¸
var line roundBelowLine = na
var line roundAboveLine = na
var label roundBelowLabel = na
var label roundAboveLabel = na

if showPsychLevels and showRoundNumbers and barstate.islast
    if not na(roundBelowLine)
        line.delete(roundBelowLine)
    if not na(roundAboveLine)
        line.delete(roundAboveLine)
    if not na(roundBelowLabel)
        label.delete(roundBelowLabel)
    if not na(roundAboveLabel)
        label.delete(roundAboveLabel)

    roundBelowLine := line.new(bar_index - 50, roundBelow, bar_index + 10, roundBelow, color=color.new(color.blue, 50), width=2, style=line.style_dotted)
    roundAboveLine := line.new(bar_index - 50, roundAbove, bar_index + 10, roundAbove, color=color.new(color.blue, 50), width=2, style=line.style_dotted)
    roundBelowLabel := label.new(bar_index + 12, roundBelow, "ğŸ“$" + str.tostring(roundBelow, "#"), style=label.style_label_left, color=color.new(color.blue, 70), textcolor=color.white, size=size.tiny)
    roundAboveLabel := label.new(bar_index + 12, roundAbove, "ğŸ“$" + str.tostring(roundAbove, "#"), style=label.style_label_left, color=color.new(color.blue, 70), textcolor=color.white, size=size.tiny)

// í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ ë¼ì¸
var line fib382Line = na
var line fib500Line = na
var line fib618Line = na

if showPsychLevels and showFibLevels and barstate.islast
    if not na(fib382Line)
        line.delete(fib382Line)
    if not na(fib500Line)
        line.delete(fib500Line)
    if not na(fib618Line)
        line.delete(fib618Line)

    fib382Line := line.new(bar_index - 50, fib382, bar_index + 10, fib382, color=color.new(color.yellow, 20), width=2, style=line.style_dashed)
    fib500Line := line.new(bar_index - 50, fib500, bar_index + 10, fib500, color=color.new(color.orange, 20), width=2, style=line.style_dashed)
    fib618Line := line.new(bar_index - 50, fib618, bar_index + 10, fib618, color=color.new(color.red, 20), width=2, style=line.style_dashed)

// ì£¼ìš” ê³ ì /ì €ì  (ì‹¬ë¦¬ì  ì§€ì§€/ì €í•­)
var line keyHighLine = na
var line keyLowLine = na
var line prevKeyHighLine = na
var line prevKeyLowLine = na
var label keyHighLabel = na
var label keyLowLabel = na

if showPsychLevels and showKeyLevels and barstate.islast
    if not na(keyHighLine)
        line.delete(keyHighLine)
    if not na(keyLowLine)
        line.delete(keyLowLine)
    if not na(prevKeyHighLine)
        line.delete(prevKeyHighLine)
    if not na(prevKeyLowLine)
        line.delete(prevKeyLowLine)
    if not na(keyHighLabel)
        label.delete(keyHighLabel)
    if not na(keyLowLabel)
        label.delete(keyLowLabel)

    if not na(lastPsychHigh)
        keyHighLine := line.new(bar_index - 80, lastPsychHigh, bar_index + 10, lastPsychHigh, color=color.new(color.red, 30), width=2, style=line.style_solid)
        keyHighLabel := label.new(bar_index + 12, lastPsychHigh, "ğŸ”ºê³ ì \n$" + str.tostring(lastPsychHigh, "#"), style=label.style_label_left, color=color.new(color.red, 50), textcolor=color.white, size=size.tiny)
    if not na(lastPsychLow)
        keyLowLine := line.new(bar_index - 80, lastPsychLow, bar_index + 10, lastPsychLow, color=color.new(color.green, 30), width=2, style=line.style_solid)
        keyLowLabel := label.new(bar_index + 12, lastPsychLow, "ğŸ”»ì €ì \n$" + str.tostring(lastPsychLow, "#"), style=label.style_label_left, color=color.new(color.green, 50), textcolor=color.white, size=size.tiny)
    if not na(prevPsychHigh) and prevPsychHigh != lastPsychHigh
        prevKeyHighLine := line.new(bar_index - 80, prevPsychHigh, bar_index + 10, prevPsychHigh, color=color.new(color.red, 60), width=1, style=line.style_dotted)
    if not na(prevPsychLow) and prevPsychLow != lastPsychLow
        prevKeyLowLine := line.new(bar_index - 80, prevPsychLow, bar_index + 10, prevPsychLow, color=color.new(color.green, 60), width=1, style=line.style_dotted)

// POC (Point of Control) ë¼ì¸
var line pocLine = na
var line hvnLine1 = na
var line hvnLine2 = na
var label pocLabel = na
var box pocBox = na

if showPsychLevels and showPOC and barstate.islast
    if not na(pocLine)
        line.delete(pocLine)
    if not na(hvnLine1)
        line.delete(hvnLine1)
    if not na(hvnLine2)
        line.delete(hvnLine2)
    if not na(pocLabel)
        label.delete(pocLabel)
    if not na(pocBox)
        box.delete(pocBox)

    if not na(pocPrice)
        // POC ë¼ì¸ (ê°€ì¥ ê±°ë˜ëŸ‰ ë§ì€ ê°€ê²©)
        pocLine := line.new(bar_index - 80, pocPrice, bar_index + 10, pocPrice, color=color.new(color.yellow, 0), width=3, style=line.style_solid)
        pocLabel := label.new(bar_index + 12, pocPrice, "âš¡POC\n$" + str.tostring(pocPrice, "#"), style=label.style_label_left, color=color.new(color.yellow, 30), textcolor=color.black, size=size.tiny)
        // POC ì£¼ë³€ ë°•ìŠ¤ (ê±°ë˜ëŸ‰ ì§‘ì¤‘ êµ¬ê°„)
        float boxHeight = priceStep * 2
        pocBox := box.new(bar_index - 60, pocPrice + boxHeight, bar_index + 5, pocPrice - boxHeight, bgcolor=color.new(color.yellow, 85), border_color=color.new(color.yellow, 50), border_width=1)

// ê³µí¬/íƒìš• ë°°ê²½ìƒ‰ (ê·¹ë‹¨ì  êµ¬ê°„ë§Œ)
bgcolor(showPsychLevels and showFearGreed and extremeFear ? color.new(color.green, 85) : na, title="ê·¹ë‹¨ì  ê³µí¬")
bgcolor(showPsychLevels and showFearGreed and extremeGreed ? color.new(color.red, 85) : na, title="ê·¹ë‹¨ì  íƒìš•")

// ì‹¬ë¦¬ì  ë§¤ìˆ˜/ë§¤ë„ êµ¬ê°„ ë§ˆì»¤ (plot ì œí•œìœ¼ë¡œ ë¹„í™œì„±í™”)
// plotshape(showPsychLevels and psychBuyZone and not extremeFear, style=shape.diamond, location=location.belowbar, color=color.new(color.teal, 30), size=size.tiny, title="ì‹¬ë¦¬ì  ë§¤ìˆ˜ êµ¬ê°„")
// plotshape(showPsychLevels and psychSellZone and not extremeGreed, style=shape.diamond, location=location.abovebar, color=color.new(color.maroon, 30), size=size.tiny, title="ì‹¬ë¦¬ì  ë§¤ë„ êµ¬ê°„")

// ë¼ìš´ë“œ ë„˜ë²„ ê·¼ì²˜ ì•Œë¦¼ (plot ì œí•œìœ¼ë¡œ ë¹„í™œì„±í™”)
// plotshape(showPsychLevels and showRoundNumbers and atRoundNumber, style=shape.circle, location=location.belowbar, color=color.new(color.blue, 50), size=size.tiny, title="ë¼ìš´ë“œ ë„˜ë²„")

// 3ì¼ ì§€ì§€/ì €í•­ ë¼ì¸
var line sup3dLine = na
var line res3dLine = na
var label sup3dLabel = na
var label res3dLabel = na

if showSR and barstate.islast
    if not na(sup3dLine)
        line.delete(sup3dLine)
    if not na(res3dLine)
        line.delete(res3dLine)
    if not na(sup3dLabel)
        label.delete(sup3dLabel)
    if not na(res3dLabel)
        label.delete(res3dLabel)

    sup3dLine := line.new(bar_index - 100, support3d, bar_index + 10, support3d, color=color.green, width=3, style=line.style_solid)
    res3dLine := line.new(bar_index - 100, resistance3d, bar_index + 10, resistance3d, color=color.red, width=3, style=line.style_solid)
    sup3dLabel := label.new(bar_index + 12, support3d, "3D SUP\n" + str.tostring(support3d, "#.#"), style=label.style_label_left, color=color.green, textcolor=color.white, size=size.small)
    res3dLabel := label.new(bar_index + 12, resistance3d, "3D RES\n" + str.tostring(resistance3d, "#.#"), style=label.style_label_left, color=color.red, textcolor=color.white, size=size.small)

// ë©”ì¸ ì‹œê·¸ë„ (í•µì‹¬ë§Œ í‘œì‹œ)
// SUPER LONG: ğŸš€ ë¡œì¼“ - ê°€ì¥ í™•ì‹¤í•œ ì§„ì… êµ¬ê°„
plotshape(showVisuals and showSuperLong, style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), text="ğŸš€", textcolor=color.white, size=size.huge, title="SUPER LONG")
// STRONG LONG: â­ ë³„ - ê°•ë ¥í•œ ì§„ì… êµ¬ê°„
plotshape(showVisuals and showStrongLong, style=shape.labelup, location=location.belowbar, color=color.new(color.yellow, 0), text="â­", textcolor=color.black, size=size.large, title="STRONG LONG")
// LONG: ì¼ë°˜ ì‚¼ê°í˜• - ì‹œê·¸ë„ ëª¨ë“œ "ì „ì²´"ì¼ ë•Œë§Œ í‘œì‹œ
plotshape(showVisuals and showNormalLong and signalMode == "ì „ì²´", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="LONG")

// SHORT ì‹œê·¸ë„ (LONGê³¼ ìœ ì‚¬í•œ ë“±ê¸‰)
// SUPER SHORT: ğŸ’€ í•´ê³¨ - ê°€ì¥ í™•ì‹¤í•œ ìˆ êµ¬ê°„
plotshape(showVisuals and superShort, style=shape.labeldown, location=location.abovebar, color=color.new(color.fuchsia, 0), text="ğŸ’€", textcolor=color.white, size=size.huge, title="SUPER SHORT")
// STRONG SHORT: âš ï¸ ê²½ê³  - ê°•ë ¥í•œ ìˆ êµ¬ê°„
plotshape(showVisuals and strongShort, style=shape.labeldown, location=location.abovebar, color=color.new(color.orange, 0), text="âš ï¸", textcolor=color.black, size=size.large, title="STRONG SHORT")
// SHORT: ì¼ë°˜ ì‚¼ê°í˜• - ì‹œê·¸ë„ ëª¨ë“œ "ì „ì²´"ì¼ ë•Œë§Œ í‘œì‹œ
plotshape(showVisuals and normalShort and signalMode == "ì „ì²´", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="SHORT")

// ì²­ì‚° ì‹œê·¸ë„
plotshape(showVisuals and exitLongSignal, style=shape.xcross, location=location.abovebar, color=color.red, size=size.normal, title="EXIT LONG")
plotshape(showVisuals and exitShortSignal, style=shape.xcross, location=location.belowbar, color=color.green, size=size.normal, title="EXIT SHORT")
plotshape(showVisuals and trailFlipToShort and not exitLongSignal, style=shape.circle, location=location.abovebar, color=color.orange, size=size.tiny, title="Trail Warning")

// ê³ ë˜ ë§¤ìˆ˜/ë§¤ë„ ì‹œê·¸ë„
// ê³ ë˜ ë“±ê¸‰ë³„ ë¼ë²¨ í‘œì‹œ
if showVisuals and showWhale and whaleBuy
    label.new(bar_index, low, whaleStrength + "\nBUY", style=label.style_label_up, color=color.blue, textcolor=color.white, size=size.small)

if showVisuals and showWhale and whaleSell
    label.new(bar_index, high, whaleStrength + "\nSELL", style=label.style_label_down, color=color.purple, textcolor=color.white, size=size.small)

// ============================================
// V40+ Liquidity Sweep ë¼ë²¨ í‘œì‹œ
// ============================================
if showVisuals and showLiqSweepLabel and liqSweepBullish
    label.new(bar_index, low, "ğŸ”„ SWEEP\nâ†‘ BUY", style=label.style_label_up, color=color.new(color.teal, 20), textcolor=color.white, size=size.normal)

if showVisuals and showLiqSweepLabel and liqSweepBearish
    label.new(bar_index, high, "ğŸ”„ SWEEP\nâ†“ SELL", style=label.style_label_down, color=color.new(color.maroon, 20), textcolor=color.white, size=size.normal)

// ê³ ë˜ ë°°ê²½ìƒ‰
bgcolor(showWhale and whaleBuy ? color.new(color.blue, 85) : na)
bgcolor(showWhale and whaleSell ? color.new(color.purple, 85) : na)

// ë°°ê²½ìƒ‰ (í•„í„°ë§ ì ìš©)
bgcolor(showSuperLong ? color.new(color.aqua, 60) : na)
bgcolor(showStrongLong ? color.new(color.yellow, 70) : na)
bgcolor(gradeA and not strongLong and signalMode == "ì „ì²´" ? color.new(color.lime, 85) : na)
bgcolor(exitLongSignal ? color.new(color.red, 70) : na)

// ìŠ¤ë§ˆíŠ¸ OBV ë°°ê²½ìƒ‰ (ì¤‘ì‹¬ì„  ìœ„=ì²­ë¡, ì•„ë˜=ë…¸ë‘, ìŠ¤í€´ì¦ˆ=íšŒìƒ‰)
bgcolor(showSmartOBV and showSmartOBVBg and smartOBVSqueeze ? color.new(color.gray, 90) : na, title="ìŠ¤ë§ˆíŠ¸OBV ìŠ¤í€´ì¦ˆ")
bgcolor(showSmartOBV and showSmartOBVBg and not smartOBVSqueeze and smartOBVAboveCenter ? color.new(color.teal, 92) : na, title="ìŠ¤ë§ˆíŠ¸OBV ë§¤ìˆ˜ì„¸")
bgcolor(showSmartOBV and showSmartOBVBg and not smartOBVSqueeze and smartOBVBelowCenter ? color.new(color.orange, 92) : na, title="ìŠ¤ë§ˆíŠ¸OBV ë§¤ë„ì„¸")

// ìŠ¤ë§ˆíŠ¸ OBV í¬ë¡œìŠ¤ ì‹ í˜¸ í‘œì‹œ (plot ì œí•œìœ¼ë¡œ ë¹„í™œì„±í™”)
// plotshape(showSmartOBV and smartOBVCrossUp and not smartOBVSqueeze, style=shape.circle, location=location.bottom, color=color.teal, size=size.tiny, title="ìŠ¤ë§ˆíŠ¸OBV ë§¤ìˆ˜ì „í™˜")
// plotshape(showSmartOBV and smartOBVCrossDown and not smartOBVSqueeze, style=shape.circle, location=location.bottom, color=color.orange, size=size.tiny, title="ìŠ¤ë§ˆíŠ¸OBV ë§¤ë„ì „í™˜")

// ìŠ¤í€´ì¦ˆ ë¸Œë ˆì´í¬ì•„ì›ƒ ì‹ í˜¸ (ê°•ë ¥) (plot ì œí•œìœ¼ë¡œ ë¹„í™œì„±í™”)
// plotshape(showSmartOBV and squeezeBreakoutUp, style=shape.diamond, location=location.bottom, color=color.lime, size=size.small, title="ìŠ¤í€´ì¦ˆ ìƒìŠ¹ëŒíŒŒ")
// plotshape(showSmartOBV and squeezeBreakoutDown, style=shape.diamond, location=location.bottom, color=color.red, size=size.small, title="ìŠ¤í€´ì¦ˆ í•˜ë½ëŒíŒŒ")

// ============================================
// SMC ì‹œê°í™”
// ============================================

// Smart Trail í”Œë¡¯
plot(showSMC and showSmartTrail ? smartTrail : na, color=smartTrailUp ? color.lime : color.red, linewidth=2, style=plot.style_stepline_diamond, title="Smart Trail")

// BOS/CHoCH ë¼ë²¨
if showSMC and showBOS and bosUp
    label.new(bar_index, high, "BOS+", style=label.style_label_down, color=color.new(color.teal, 30), textcolor=color.white, size=size.tiny)

if showSMC and showBOS and bosDn
    label.new(bar_index, low, "BOS-", style=label.style_label_up, color=color.new(color.maroon, 30), textcolor=color.white, size=size.tiny)

if showSMC and showBOS and chochUp
    label.new(bar_index, high, "CHoCH+", style=label.style_label_down, color=color.lime, textcolor=color.black, size=size.small)

if showSMC and showBOS and chochDn
    label.new(bar_index, low, "CHoCH-", style=label.style_label_up, color=color.fuchsia, textcolor=color.white, size=size.small)

// Liquidity Levels ë¼ì¸ í‘œì‹œ
var line[] eqHighLines = array.new_line(0)
var line[] eqLowLines = array.new_line(0)
var label[] eqHighLabels = array.new_label(0)
var label[] eqLowLabels = array.new_label(0)

// Equal Highs ë¼ì¸ ê·¸ë¦¬ê¸°
if showSMC and showLiquidityLevels and array.size(eqHighs) > 0
    if array.size(eqHighLines) > 0
        for i = 0 to array.size(eqHighLines) - 1
            line.delete(array.get(eqHighLines, i))
        array.clear(eqHighLines)
    if array.size(eqHighLabels) > 0
        for i = 0 to array.size(eqHighLabels) - 1
            label.delete(array.get(eqHighLabels, i))
        array.clear(eqHighLabels)
    for i = 0 to array.size(eqHighs) - 1
        float lvl = array.get(eqHighs, i)
        int startBar = array.get(eqHighBars, i)
        array.push(eqHighLines, line.new(startBar, lvl, bar_index + 20, lvl, color=color.new(color.orange, 40), width=2, style=line.style_dotted))
        array.push(eqHighLabels, label.new(bar_index + 22, lvl, "EQH", style=label.style_label_left, color=color.new(color.orange, 50), textcolor=color.white, size=size.tiny))

// Equal Lows ë¼ì¸ ê·¸ë¦¬ê¸°
if showSMC and showLiquidityLevels and array.size(eqLows) > 0
    if array.size(eqLowLines) > 0
        for i = 0 to array.size(eqLowLines) - 1
            line.delete(array.get(eqLowLines, i))
        array.clear(eqLowLines)
    if array.size(eqLowLabels) > 0
        for i = 0 to array.size(eqLowLabels) - 1
            label.delete(array.get(eqLowLabels, i))
        array.clear(eqLowLabels)
    for i = 0 to array.size(eqLows) - 1
        float lvl = array.get(eqLows, i)
        int startBar = array.get(eqLowBars, i)
        array.push(eqLowLines, line.new(startBar, lvl, bar_index + 20, lvl, color=color.new(color.purple, 40), width=2, style=line.style_dotted))
        array.push(eqLowLabels, label.new(bar_index + 22, lvl, "EQL", style=label.style_label_left, color=color.new(color.purple, 50), textcolor=color.white, size=size.tiny))

// ============================================
// ì²­ì‚° ë§¤ë¬¼ëŒ€ (Liquidation Levels) ì‹œê°í™”
// ============================================

var line[] liqLongLines = array.new_line(0)
var line[] liqShortLines = array.new_line(0)
var label[] liqLabelsArr = array.new_label(0)

// ì²­ì‚° ë ˆë²¨ ë¼ì¸ ê·¸ë¦¬ê¸° (ë§ˆì§€ë§‰ ë´‰ì—ì„œë§Œ)
if enableLiqLevels and barstate.islast
    // ê¸°ì¡´ ë¼ì¸/ë¼ë²¨ ì‚­ì œ
    if array.size(liqLongLines) > 0
        for i = 0 to array.size(liqLongLines) - 1
            line.delete(array.get(liqLongLines, i))
        array.clear(liqLongLines)
    if array.size(liqShortLines) > 0
        for i = 0 to array.size(liqShortLines) - 1
            line.delete(array.get(liqShortLines, i))
        array.clear(liqShortLines)
    if array.size(liqLabelsArr) > 0
        for i = 0 to array.size(liqLabelsArr) - 1
            label.delete(array.get(liqLabelsArr, i))
        array.clear(liqLabelsArr)

    // ë¡± ì²­ì‚° ë ˆë²¨ (ë¹¨ê°„ìƒ‰ - ê°€ê²© í•˜ë½ ì‹œ ì²­ì‚°)
    if showLongLiq
        if liqShow10x
            array.push(liqLongLines, line.new(bar_index - 30, liqLong10x, bar_index + 10, liqLong10x, color=color.new(color.red, 60), style=line.style_dotted, width=1))
            if showLiqLabels
                array.push(liqLabelsArr, label.new(bar_index + 12, liqLong10x, "L10x", style=label.style_label_left, color=color.new(color.red, 80), textcolor=color.red, size=size.tiny))
        if liqShow25x
            array.push(liqLongLines, line.new(bar_index - 30, liqLong25x, bar_index + 10, liqLong25x, color=color.new(color.red, 50), style=line.style_dashed, width=1))
            if showLiqLabels
                array.push(liqLabelsArr, label.new(bar_index + 12, liqLong25x, "L25x", style=label.style_label_left, color=color.new(color.red, 80), textcolor=color.red, size=size.tiny))
        if liqShow50x
            liqColor50 = showLiqHighRisk ? color.new(color.orange, 30) : color.new(color.red, 40)
            array.push(liqLongLines, line.new(bar_index - 30, liqLong50x, bar_index + 10, liqLong50x, color=liqColor50, style=line.style_solid, width=2))
            if showLiqLabels
                array.push(liqLabelsArr, label.new(bar_index + 12, liqLong50x, "L50xâš ", style=label.style_label_left, color=color.new(color.orange, 70), textcolor=color.orange, size=size.small))
        if liqShow100x
            liqColor100 = showLiqHighRisk ? color.new(color.red, 0) : color.new(color.red, 30)
            array.push(liqLongLines, line.new(bar_index - 30, liqLong100x, bar_index + 10, liqLong100x, color=liqColor100, style=line.style_solid, width=3))
            if showLiqLabels
                array.push(liqLabelsArr, label.new(bar_index + 12, liqLong100x, "L100xğŸ”¥", style=label.style_label_left, color=color.new(color.red, 60), textcolor=color.red, size=size.normal))

    // ìˆ ì²­ì‚° ë ˆë²¨ (ì´ˆë¡ìƒ‰ - ê°€ê²© ìƒìŠ¹ ì‹œ ì²­ì‚°)
    if showShortLiq
        if liqShow10x
            array.push(liqShortLines, line.new(bar_index - 30, liqShort10x, bar_index + 10, liqShort10x, color=color.new(color.green, 60), style=line.style_dotted, width=1))
            if showLiqLabels
                array.push(liqLabelsArr, label.new(bar_index + 12, liqShort10x, "S10x", style=label.style_label_left, color=color.new(color.green, 80), textcolor=color.green, size=size.tiny))
        if liqShow25x
            array.push(liqShortLines, line.new(bar_index - 30, liqShort25x, bar_index + 10, liqShort25x, color=color.new(color.green, 50), style=line.style_dashed, width=1))
            if showLiqLabels
                array.push(liqLabelsArr, label.new(bar_index + 12, liqShort25x, "S25x", style=label.style_label_left, color=color.new(color.green, 80), textcolor=color.green, size=size.tiny))
        if liqShow50x
            liqColorS50 = showLiqHighRisk ? color.new(color.teal, 30) : color.new(color.green, 40)
            array.push(liqShortLines, line.new(bar_index - 30, liqShort50x, bar_index + 10, liqShort50x, color=liqColorS50, style=line.style_solid, width=2))
            if showLiqLabels
                array.push(liqLabelsArr, label.new(bar_index + 12, liqShort50x, "S50xâš ", style=label.style_label_left, color=color.new(color.teal, 70), textcolor=color.teal, size=size.small))
        if liqShow100x
            liqColorS100 = showLiqHighRisk ? color.new(color.green, 0) : color.new(color.green, 30)
            array.push(liqShortLines, line.new(bar_index - 30, liqShort100x, bar_index + 10, liqShort100x, color=liqColorS100, style=line.style_solid, width=3))
            if showLiqLabels
                array.push(liqLabelsArr, label.new(bar_index + 12, liqShort100x, "S100xğŸ”¥", style=label.style_label_left, color=color.new(color.green, 60), textcolor=color.green, size=size.normal))

// ì²­ì‚° ìŠ¤ìœ• ë§ˆì»¤ (plot ì œí•œìœ¼ë¡œ ë¹„í™œì„±í™” - ì•ŒëŒìœ¼ë¡œ ëŒ€ì²´)
// plotshape(enableLiqLevels and longLiq100xSweep, title="100x ë¡±ì²­ì‚° ìŠ¤ìœ•", location=location.belowbar, color=color.red, style=shape.triangleup, size=size.normal, text="LIQ\nSWEEP")
// plotshape(enableLiqLevels and longLiq50xSweep and not longLiq100xSweep, title="50x ë¡±ì²­ì‚° ìŠ¤ìœ•", location=location.belowbar, color=color.orange, style=shape.triangleup, size=size.small, text="50x")
// plotshape(enableLiqLevels and shortLiq100xSweep, title="100x ìˆì²­ì‚° ìŠ¤ìœ•", location=location.abovebar, color=color.green, style=shape.triangledown, size=size.normal, text="LIQ\nSWEEP")
// plotshape(enableLiqLevels and shortLiq50xSweep and not shortLiq100xSweep, title="50x ìˆì²­ì‚° ìŠ¤ìœ•", location=location.abovebar, color=color.teal, style=shape.triangledown, size=size.small, text="50x")

// ============================================
// ì‹¤ì œ ì²­ì‚° ë§¤ë¬¼ëŒ€ ì‹œê°í™” (Coinglass ê¸°ë°˜ ê³ ì • ë ˆë²¨)
// ============================================

var line[] realLongLiqLines = array.new_line(0)
var line[] realShortLiqLines = array.new_line(0)
var label[] realLiqLabelsArr = array.new_label(0)

// ì‹¤ì œ ì²­ì‚° ë§¤ë¬¼ëŒ€ ë¼ì¸ ê·¸ë¦¬ê¸° (ê³ ì • - ì›€ì§ì´ì§€ ì•ŠìŒ)
if enableRealLiqLevels and barstate.islast
    // ê¸°ì¡´ ë¼ì¸/ë¼ë²¨ ì‚­ì œ
    if array.size(realLongLiqLines) > 0
        for i = 0 to array.size(realLongLiqLines) - 1
            line.delete(array.get(realLongLiqLines, i))
        array.clear(realLongLiqLines)
    if array.size(realShortLiqLines) > 0
        for i = 0 to array.size(realShortLiqLines) - 1
            line.delete(array.get(realShortLiqLines, i))
        array.clear(realShortLiqLines)
    if array.size(realLiqLabelsArr) > 0
        for i = 0 to array.size(realLiqLabelsArr) - 1
            label.delete(array.get(realLiqLabelsArr, i))
        array.clear(realLiqLabelsArr)

    // ë¡± ì²­ì‚° ì§‘ì¤‘ êµ¬ê°„ (ë¹¨ê°„ êµµì€ ì„  - ê°€ê²© í•˜ë½ ì‹œ ëŒ€ëŸ‰ ì²­ì‚°)
    if realLongLiq1Enable and realLongLiq1 > 0
        array.push(realLongLiqLines, line.new(bar_index - 100, realLongLiq1, bar_index + 20, realLongLiq1, color=realLongLiqColor, style=line.style_solid, width=3))
        if showRealLiqLabels
            array.push(realLiqLabelsArr, label.new(bar_index + 22, realLongLiq1, "ğŸ”´ " + realLongLiq1Label + "\n$" + str.tostring(realLongLiq1, "#"), style=label.style_label_left, color=color.new(color.red, 60), textcolor=color.white, size=size.normal))

    if realLongLiq2Enable and realLongLiq2 > 0
        array.push(realLongLiqLines, line.new(bar_index - 100, realLongLiq2, bar_index + 20, realLongLiq2, color=realLongLiqColor, style=line.style_dashed, width=2))
        if showRealLiqLabels
            array.push(realLiqLabelsArr, label.new(bar_index + 22, realLongLiq2, "ğŸ”´ " + realLongLiq2Label + "\n$" + str.tostring(realLongLiq2, "#"), style=label.style_label_left, color=color.new(color.red, 70), textcolor=color.white, size=size.small))

    if realLongLiq3Enable and realLongLiq3 > 0
        array.push(realLongLiqLines, line.new(bar_index - 100, realLongLiq3, bar_index + 20, realLongLiq3, color=realLongLiqColor, style=line.style_dotted, width=2))
        if showRealLiqLabels
            array.push(realLiqLabelsArr, label.new(bar_index + 22, realLongLiq3, "ğŸ”´ " + realLongLiq3Label, style=label.style_label_left, color=color.new(color.red, 80), textcolor=color.white, size=size.tiny))

    // ìˆ ì²­ì‚° ì§‘ì¤‘ êµ¬ê°„ (ì´ˆë¡ êµµì€ ì„  - ê°€ê²© ìƒìŠ¹ ì‹œ ëŒ€ëŸ‰ ì²­ì‚°)
    if realShortLiq1Enable and realShortLiq1 > 0
        array.push(realShortLiqLines, line.new(bar_index - 100, realShortLiq1, bar_index + 20, realShortLiq1, color=realShortLiqColor, style=line.style_solid, width=3))
        if showRealLiqLabels
            array.push(realLiqLabelsArr, label.new(bar_index + 22, realShortLiq1, "ğŸŸ¢ " + realShortLiq1Label + "\n$" + str.tostring(realShortLiq1, "#"), style=label.style_label_left, color=color.new(color.green, 60), textcolor=color.white, size=size.normal))

    if realShortLiq2Enable and realShortLiq2 > 0
        array.push(realShortLiqLines, line.new(bar_index - 100, realShortLiq2, bar_index + 20, realShortLiq2, color=realShortLiqColor, style=line.style_dashed, width=2))
        if showRealLiqLabels
            array.push(realLiqLabelsArr, label.new(bar_index + 22, realShortLiq2, "ğŸŸ¢ " + realShortLiq2Label + "\n$" + str.tostring(realShortLiq2, "#"), style=label.style_label_left, color=color.new(color.green, 70), textcolor=color.white, size=size.small))

    if realShortLiq3Enable and realShortLiq3 > 0
        array.push(realShortLiqLines, line.new(bar_index - 100, realShortLiq3, bar_index + 20, realShortLiq3, color=realShortLiqColor, style=line.style_dotted, width=2))
        if showRealLiqLabels
            array.push(realLiqLabelsArr, label.new(bar_index + 22, realShortLiq3, "ğŸŸ¢ " + realShortLiq3Label, style=label.style_label_left, color=color.new(color.green, 80), textcolor=color.white, size=size.tiny))

// ì‹¤ì œ ì²­ì‚° ë§¤ë¬¼ëŒ€ ë„ë‹¬ ê°ì§€
bool nearRealLongLiq1 = realLongLiq1Enable and math.abs(close - realLongLiq1) / close * 100 < 1
bool nearRealLongLiq2 = realLongLiq2Enable and math.abs(close - realLongLiq2) / close * 100 < 1
bool nearRealShortLiq1 = realShortLiq1Enable and math.abs(close - realShortLiq1) / close * 100 < 1
bool nearRealShortLiq2 = realShortLiq2Enable and math.abs(close - realShortLiq2) / close * 100 < 1

// ì‹¤ì œ ì²­ì‚° ë§¤ë¬¼ëŒ€ ëŒíŒŒ í›„ ë°˜ì „ ê°ì§€ (ìŠ¤ìœ•) - ì¿¨ë‹¤ìš´ ì ìš©
// ì¡°ê±´: ì´ì „ ë´‰ì—ì„œ ë ˆë²¨ ìœ„ì— ìˆì—ˆëŠ”ë° â†’ í˜„ì¬ ë´‰ì—ì„œ ë ˆë²¨ ì•„ë˜ë¡œ ê°”ë‹¤ê°€ â†’ ë‹¤ì‹œ ë ˆë²¨ ìœ„ë¡œ ë§ˆê°
bool realLongLiqSweep1Raw = realLongLiq1Enable and low < realLongLiq1 and close > realLongLiq1 and close[1] > realLongLiq1
bool realLongLiqSweep2Raw = realLongLiq2Enable and low < realLongLiq2 and close > realLongLiq2 and close[1] > realLongLiq2
bool realShortLiqSweep1Raw = realShortLiq1Enable and high > realShortLiq1 and close < realShortLiq1 and close[1] < realShortLiq1
bool realShortLiqSweep2Raw = realShortLiq2Enable and high > realShortLiq2 and close < realShortLiq2 and close[1] < realShortLiq2

// ì¿¨ë‹¤ìš´ ì ìš© (20ë´‰ = ì•½ 5ì‹œê°„ in 15ë¶„ë´‰)
var int lastRealLongLiqBar = 0
var int lastRealShortLiqBar = 0
int realLiqCooldown = 20

bool realLongLiqSweep1 = realLongLiqSweep1Raw and (bar_index - lastRealLongLiqBar > realLiqCooldown)
bool realLongLiqSweep2 = realLongLiqSweep2Raw and (bar_index - lastRealLongLiqBar > realLiqCooldown)
bool realShortLiqSweep1 = realShortLiqSweep1Raw and (bar_index - lastRealShortLiqBar > realLiqCooldown)
bool realShortLiqSweep2 = realShortLiqSweep2Raw and (bar_index - lastRealShortLiqBar > realLiqCooldown)

// ì¿¨ë‹¤ìš´ ì—…ë°ì´íŠ¸
if realLongLiqSweep1 or realLongLiqSweep2
    lastRealLongLiqBar := bar_index
if realShortLiqSweep1 or realShortLiqSweep2
    lastRealShortLiqBar := bar_index

// ì‹¤ì œ ì²­ì‚° ìŠ¤ìœ• ë§ˆì»¤ (plot ì œí•œìœ¼ë¡œ ë¹„í™œì„±í™” - ì•ŒëŒìœ¼ë¡œ ëŒ€ì²´)
// plotshape(enableRealLiqLevels and realLongLiqSweep1, title="ë¡± ëŒ€ëŸ‰ì²­ì‚° ìŠ¤ìœ•", location=location.belowbar, color=#FF5252, style=shape.labelup, size=size.normal, text="ğŸ’€ LONG LIQ")
// plotshape(enableRealLiqLevels and realShortLiqSweep1, title="ìˆ ëŒ€ëŸ‰ì²­ì‚° ìŠ¤ìœ•", location=location.abovebar, color=#4CAF50, style=shape.labeldown, size=size.normal, text="ğŸ’€ SHORT LIQ")

// Premium/Discount Zone í‘œì‹œ (plot ì œí•œìœ¼ë¡œ ë¹„í™œì„±í™”)
// plot(showSMC ? premiumZone : na, color=color.new(color.red, 70), linewidth=1, style=plot.style_linebr, title="Premium Zone")
// plot(showSMC ? discountZone : na, color=color.new(color.green, 70), linewidth=1, style=plot.style_linebr, title="Discount Zone")
// plot(showSMC ? rangeMid : na, color=color.new(color.gray, 80), linewidth=1, style=plot.style_linebr, title="Range Mid")

// ============================================
// ì‹œê·¸ë„ ë¼ë²¨
// ============================================

if showSignalLabel and superLong
    string t1 = "***** SUPER [" + finalGrade + "] " + str.tostring(longScore, "#") + "pt *****"
    string t2 = "MTF + SMC + Smart Trail ì¼ì¹˜!"
    string t3 = "ì¶”ì„¸: " + trendStrength + " (" + str.tostring(trendScore) + "/14)"
    string t4 = "TF: " + str.tostring(uptrendCount) + "/4 EMA:" + str.tostring(emaAlignedUpCount) + "/5"
    string t5 = "SMC: " + (isBullishOB ? "OB+" : "") + (isBullishFVG ? " FVG+" : "") + (chochUp ? " CHoCH+" : "")
    string t6 = "Zone: " + (inDiscount ? "DISCOUNT" : "MID") + " Trail: LONG"
    string lblText = t1 + "\n" + t2 + "\n" + t3 + "\n" + t4 + "\n" + t5 + "\n" + t6
    label.new(bar_index, low, lblText, style=label.style_label_up, color=color.aqua, textcolor=color.black, size=size.large)

if showSignalLabel and strongLong and not superLong
    string t1 = "*** STRONG [" + currentGrade + "] " + str.tostring(longScore, "#") + "pt ***"
    string t2 = highConfidenceLong ? confReason : ""
    string t3 = "ì¶”ì„¸: " + trendStrength + " (" + str.tostring(trendScore) + "/14)"
    string t4 = "TF: " + str.tostring(uptrendCount) + "/4 EMA:" + str.tostring(emaAlignedUpCount) + "/5 MACD:" + str.tostring(macdBullCount) + "/5"
    string t5 = "ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "% ADX:" + str.tostring(adxValue, "#")
    string v15 = tf15m_volSpike ? str.tostring(tf15m_volRatio, "#.#") : "-"
    string v1h = tf1h_volSpike ? str.tostring(tf1h_volRatio, "#.#") : "-"
    string v4h = tf4h_volSpike ? str.tostring(tf4h_volRatio, "#.#") : "-"
    string t6 = "Vol[15m:" + v15 + " 1H:" + v1h + " 4H:" + v4h + "]"
    string lblText = t1 + (t2 != "" ? "\n" + t2 : "") + "\n" + t3 + "\n" + t4 + "\n" + t5 + "\n" + t6
    label.new(bar_index, low, lblText, style=label.style_label_up, color=color.yellow, textcolor=color.black, size=size.normal)

if showSignalLabel and normalLong
    string t1 = "LONG [" + currentGrade + "] " + str.tostring(longScore, "#") + "pt"
    string t2 = "ì¶”ì„¸:" + trendStrength + " TF:" + str.tostring(uptrendCount) + "/4"
    string t3 = "EMA:" + str.tostring(emaAlignedUpCount) + "/5 MACD:" + str.tostring(macdBullCount) + "/5"
    string t4 = "Vol:" + str.tostring(volRatio, "#.#") + "x"
    string lblText = t1 + "\n" + t2 + "\n" + t3 + "\n" + t4
    label.new(bar_index, low, lblText, style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

// ============================================
// ì •ë³´ í…Œì´ë¸” (ê±°ë˜ëŸ‰ ë°°ìˆ˜ í¬í•¨)
// ============================================

if showInfoTable
    var table infoTbl = table.new(position.top_right, 5, 21, bgcolor=color.new(color.white, 5), border_width=1)

    if barstate.islast
        table.clear(infoTbl, 0, 0, 4, 20)

        // í—¤ë” + ëª¨ë“œ í‘œì‹œ
        string modeText = tradeMode == "ì„ ë¬¼" ? "F" : tradeMode == "í˜„ë¬¼" ? "S" : "K"  // Futures/Spot/stocK
        table.cell(infoTbl, 0, 0, "V39 [" + modeText + "]", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(infoTbl, 1, 0, "ì¶”ì„¸", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(infoTbl, 2, 0, "EMA", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(infoTbl, 3, 0, "MACD", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(infoTbl, 4, 0, "Vol", text_color=color.white, bgcolor=color.blue, text_size=size.small)

        // í˜„ì¬TF
        string curTFVol = str.tostring(volRatio, "#.#") + "x"
        color curVolColor = volumeExplosion ? color.lime : volSpike ? color.green : color.gray
        string curEma = emaAlignedUp ? "UP!" : emaAlignedDown ? "DN!" : ema8 > ema21 ? "up" : "dn"
        color curEmaColor = emaAlignedUp ? color.lime : emaAlignedDown ? color.fuchsia : ema8 > ema21 ? color.green : color.red
        table.cell(infoTbl, 0, 1, timeframe.period, text_color=color.blue, text_size=size.tiny)
        table.cell(infoTbl, 1, 1, ema8 > ema21 ? "UP" : "DN", text_color=ema8 > ema21 ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 2, 1, curEma, text_color=curEmaColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 1, macdBullish ? "BULL" : "BEAR", text_color=macdBullish ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 1, curTFVol, text_color=curVolColor, text_size=size.tiny)

        // 15ë¶„ (5ë¶„ë´‰ ì œê±°ë¨)
        string vol15mTxt = str.tostring(tf15m_volRatio, "#.#") + "x"
        color vol15mColor = tf15m_volRatio >= volHighThreshold ? color.lime : tf15m_volSpike ? color.green : color.gray
        string ema15m = tf15m_emaAligned ? "UP!" : tf15m_emaAlignedDn ? "DN!" : tf15m_uptrend ? "up" : tf15m_downtrend ? "dn" : "-"
        color ema15mColor = tf15m_emaAligned ? color.lime : tf15m_emaAlignedDn ? color.fuchsia : tf15m_uptrend ? color.green : tf15m_downtrend ? color.red : color.gray
        table.cell(infoTbl, 0, 2, "15m", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 2, tf15m_uptrend ? "UP" : tf15m_downtrend ? "DN" : "-", text_color=tf15m_uptrend ? color.green : tf15m_downtrend ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 2, ema15m, text_color=ema15mColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 2, tf15m_macdBull ? "BULL" : "BEAR", text_color=tf15m_macdBull ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 2, vol15mTxt, text_color=vol15mColor, text_size=size.tiny)

        // 1ì‹œê°„
        string vol1hTxt = str.tostring(tf1h_volRatio, "#.#") + "x"
        color vol1hColor = tf1h_volRatio >= volHighThreshold ? color.lime : tf1h_volSpike ? color.green : color.gray
        string ema1h = tf1h_emaAligned ? "UP!" : tf1h_emaAlignedDn ? "DN!" : tf1h_uptrend ? "up" : tf1h_downtrend ? "dn" : "-"
        color ema1hColor = tf1h_emaAligned ? color.lime : tf1h_emaAlignedDn ? color.fuchsia : tf1h_uptrend ? color.green : tf1h_downtrend ? color.red : color.gray
        table.cell(infoTbl, 0, 3, "1H", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 3, tf1h_uptrend ? "UP" : tf1h_downtrend ? "DN" : "-", text_color=tf1h_uptrend ? color.green : tf1h_downtrend ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 3, ema1h, text_color=ema1hColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 3, tf1h_macdBull ? "BULL" : "BEAR", text_color=tf1h_macdBull ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 3, vol1hTxt, text_color=vol1hColor, text_size=size.tiny)

        // 4ì‹œê°„
        string vol4hTxt = str.tostring(tf4h_volRatio, "#.#") + "x"
        color vol4hColor = tf4h_volRatio >= volHighThreshold ? color.lime : tf4h_volSpike ? color.green : color.gray
        string ema4h = tf4h_emaAligned ? "UP!" : tf4h_emaAlignedDn ? "DN!" : tf4h_uptrend ? "up" : tf4h_downtrend ? "dn" : "-"
        color ema4hColor = tf4h_emaAligned ? color.lime : tf4h_emaAlignedDn ? color.fuchsia : tf4h_uptrend ? color.green : tf4h_downtrend ? color.red : color.gray
        table.cell(infoTbl, 0, 4, "4H", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 4, tf4h_uptrend ? "UP" : tf4h_downtrend ? "DN" : "-", text_color=tf4h_uptrend ? color.green : tf4h_downtrend ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 4, ema4h, text_color=ema4hColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 4, tf4h_macdBull ? "BULL" : "BEAR", text_color=tf4h_macdBull ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 4, vol4hTxt, text_color=vol4hColor, text_size=size.tiny)

        // ì¼ë´‰
        string emaD = tfD_emaAligned ? "UP!" : tfD_emaAlignedDn ? "DN!" : tfD_uptrend ? "up" : tfD_downtrend ? "dn" : "-"
        color emaDColor = tfD_emaAligned ? color.lime : tfD_emaAlignedDn ? color.fuchsia : tfD_uptrend ? color.green : tfD_downtrend ? color.red : color.gray
        table.cell(infoTbl, 0, 5, "1D", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 5, tfD_uptrend ? "UP" : tfD_downtrend ? "DN" : "-", text_color=tfD_uptrend ? color.green : tfD_downtrend ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 5, emaD, text_color=emaDColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 5, tfD_macdBull ? "BULL" : "BEAR", text_color=tfD_macdBull ? color.green : color.red, text_size=size.tiny)
        table.cell(infoTbl, 4, 5, "-", text_color=color.gray, text_size=size.tiny)

        // êµ¬ë¶„ì„ 
        table.cell(infoTbl, 0, 6, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 1, 6, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 6, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 6, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 6, "---", text_color=color.gray, text_size=size.tiny)

        // ì¶”ì„¸ ì¢…í•©
        color trendScoreColor = trendScore >= 12 ? color.lime : trendScore >= 10 ? color.green : trendScore >= 7 ? color.orange : trendScore >= 5 ? color.gray : color.red
        table.cell(infoTbl, 0, 7, "ì¶”ì„¸ê°•ë„", text_color=color.white, bgcolor=color.teal, text_size=size.tiny)
        table.cell(infoTbl, 1, 7, trendStrength, text_color=trendScoreColor, text_size=size.tiny)
        table.cell(infoTbl, 2, 7, str.tostring(trendScore) + "/14", text_color=trendScoreColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 7, "", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 7, "", text_color=color.gray, text_size=size.tiny)

        // ìƒì„¸ ì¹´ìš´íŠ¸
        table.cell(infoTbl, 0, 8, "TFì¼ì¹˜", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 8, str.tostring(uptrendCount) + "/4", text_color=uptrendCount >= 3 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 8, "EMAì •ë ¬", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 3, 8, str.tostring(emaAlignedUpCount) + "/5", text_color=emaAlignedUpCount >= 3 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 8, emaAlignedUpCount >= 4 ? "!!" : "", text_color=color.lime, text_size=size.tiny)

        table.cell(infoTbl, 0, 9, "MACDì¼ì¹˜", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 9, str.tostring(macdBullCount) + "/5", text_color=macdBullCount >= 4 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 9, "Volê¸‰ì¦", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 3, 9, str.tostring(volSpikeCount) + "/4", text_color=volSpikeCount >= 2 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 9, multiTFVolume ? "MTF!" : "", text_color=color.lime, text_size=size.tiny)

        // ìœ„ì¹˜/ë§¤ìˆ˜ì••ë ¥
        table.cell(infoTbl, 0, 10, "ìœ„ì¹˜", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 10, str.tostring(pricePosition, "#") + "%", text_color=nearSupport3d ? color.green : nearResistance3d ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 10, atSupport3d ? "SUP!" : atResistance3d ? "RES!" : "", text_color=atSupport3d ? color.lime : color.fuchsia, text_size=size.tiny)
        table.cell(infoTbl, 3, 10, "Buy%", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 4, 10, str.tostring(buyPressure, "#") + "%", text_color=buyPressure > 55 ? color.green : buyPressure < 45 ? color.red : color.gray, text_size=size.tiny)

        // RSI/Stoch
        table.cell(infoTbl, 0, 11, "RSI", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 11, str.tostring(rsi, "#"), text_color=rsiOversold ? color.green : rsiOverbought ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 11, stochOversold ? "OS!" : stochOverbought ? "OB!" : "", text_color=stochOversold ? color.lime : color.fuchsia, text_size=size.tiny)
        table.cell(infoTbl, 3, 11, "Stoch", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 4, 11, str.tostring(stochK, "#"), text_color=stochOversold ? color.green : stochOverbought ? color.red : color.gray, text_size=size.tiny)

        // ADX
        table.cell(infoTbl, 0, 12, "ADX", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 12, str.tostring(adxValue, "#"), text_color=trendStrong ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 12, trendStrong ? "STRONG" : "WEAK", text_color=trendStrong ? color.lime : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 12, "DI", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 4, 12, bullishDI ? "+DI" : "-DI", text_color=bullishDI ? color.green : color.red, text_size=size.tiny)

        // BB
        table.cell(infoTbl, 0, 13, "BB", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 13, touchBBLower ? "í•˜ë‹¨!" : touchBBUpper ? "ìƒë‹¨!" : close > bbBasis ? "ì¤‘ì•™â†‘" : "ì¤‘ì•™â†“", text_color=touchBBLower ? color.lime : touchBBUpper ? color.fuchsia : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 13, bullishDivergence ? "DIV+" : bearishDivergence ? "DIV-" : "", text_color=bullishDivergence ? color.lime : bearishDivergence ? color.fuchsia : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 13, "", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 13, "", text_color=color.gray, text_size=size.tiny)

        // ì ìˆ˜
        table.cell(infoTbl, 0, 14, "ì ìˆ˜", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 14, str.tostring(longScore, "#") + "/30", text_color=longScore >= 20 ? color.lime : longScore >= 15 ? color.green : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 14, highConfidenceLong ? "HC!" : "", text_color=color.yellow, text_size=size.tiny)
        table.cell(infoTbl, 3, 14, "í™•ì‹ ", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 4, 14, confReason, text_color=highConfidenceLong ? color.yellow : color.gray, text_size=size.tiny)

        // SMC ì •ë³´
        string smcOB = isBullishOB ? "OB+" : isBearishOB ? "OB-" : "-"
        color smcOBColor = isBullishOB ? color.lime : isBearishOB ? color.red : color.gray
        string smcFVG = isBullishFVG ? "FVG+" : isBearishFVG ? "FVG-" : "-"
        color smcFVGColor = isBullishFVG ? color.teal : isBearishFVG ? color.maroon : color.gray
        string smcBOS = chochUp ? "CHoCH+" : chochDn ? "CHoCH-" : bosUp ? "BOS+" : bosDn ? "BOS-" : "-"
        color smcBOSColor = chochUp or bosUp ? color.lime : chochDn or bosDn ? color.red : color.gray
        string smcZone = inPremium ? "PREMIUM" : inDiscount ? "DISCOUNT" : "MID"
        color smcZoneColor = inDiscount ? color.green : inPremium ? color.red : color.gray
        string smcTrail = smartTrailUp ? "LONG" : "SHORT"
        color smcTrailColor = smartTrailUp ? color.lime : color.fuchsia

        table.cell(infoTbl, 0, 15, "SMC", text_color=color.white, bgcolor=color.purple, text_size=size.tiny)
        table.cell(infoTbl, 1, 15, smcOB, text_color=smcOBColor, text_size=size.tiny)
        table.cell(infoTbl, 2, 15, smcFVG, text_color=smcFVGColor, text_size=size.tiny)
        table.cell(infoTbl, 3, 15, smcBOS, text_color=smcBOSColor, text_size=size.tiny)
        table.cell(infoTbl, 4, 15, smcTrail, text_color=smcTrailColor, text_size=size.tiny)

        table.cell(infoTbl, 0, 16, "Zone", text_color=color.black, text_size=size.tiny)
        table.cell(infoTbl, 1, 16, smcZone, text_color=smcZoneColor, text_size=size.tiny)
        table.cell(infoTbl, 2, 16, smcBullish ? "SMC+" : smcBearish ? "SMC-" : "", text_color=smcBullish ? color.lime : smcBearish ? color.red : color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 16, "", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 16, "", text_color=color.gray, text_size=size.tiny)

        // ì‹œê·¸ë„
        string sigText = superLong ? "SUPER [" + finalGrade + "]" : strongLong ? "STRONG [" + currentGrade + "]" : normalLong ? "LONG [" + currentGrade + "]" : exitLongSignal ? "EXIT!" : "WAIT"
        color sigColor = superLong ? color.aqua : strongLong ? color.yellow : normalLong ? color.green : exitLongSignal ? color.red : color.gray
        color sigBg = superLong ? color.new(color.aqua, 70) : exitLongSignal ? color.new(color.red, 70) : color.new(color.gray, 50)
        table.cell(infoTbl, 0, 17, "Signal", text_color=color.white, bgcolor=color.gray, text_size=size.small)
        table.cell(infoTbl, 1, 17, sigText, text_color=sigColor, bgcolor=sigBg, text_size=size.small)
        table.cell(infoTbl, 2, 17, superLong ? "SMC+" : exitLongSignal ? "SELL" : "", text_color=superLong ? color.aqua : color.red, bgcolor=sigBg, text_size=size.tiny)
        table.cell(infoTbl, 3, 17, superLong ? "ALL" : "", text_color=color.aqua, bgcolor=sigBg, text_size=size.tiny)
        table.cell(infoTbl, 4, 17, superLong ? "GO!!" : strongLong ? "GO!" : exitLongSignal ? "OUT!" : "", text_color=superLong ? color.aqua : strongLong ? color.yellow : color.red, bgcolor=sigBg, text_size=size.small)

        // êµ¬ë¶„ì„ 
        table.cell(infoTbl, 0, 18, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 1, 18, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 2, 18, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 18, "---", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 18, "---", text_color=color.gray, text_size=size.tiny)

        // ëª¨ë“œ ì„¤ì • í‘œì‹œ
        string tradeModeShort = tradeMode == "ì„ ë¬¼" ? "ì„ ë¬¼" : tradeMode == "í˜„ë¬¼" ? "í˜„ë¬¼" : "ì£¼ì‹"
        color tradeModeColor = tradeMode == "ì„ ë¬¼" ? color.orange : tradeMode == "í˜„ë¬¼" ? color.teal : color.purple
        string displayModeShort = displayMode == "ì „ì²´" ? "ì „ì²´" : displayMode == "ìµœì†Œí™”" ? "ìµœì†Œ" : "í…Œì´ë¸”"
        string signalModeShort = signalMode == "ì „ì²´" ? "ì „ì²´" : signalMode == "STRONG ì´ìƒ" ? "STR+" : "SUPER"

        table.cell(infoTbl, 0, 19, "MODE", text_color=color.white, bgcolor=color.navy, text_size=size.tiny)
        table.cell(infoTbl, 1, 19, tradeModeShort, text_color=tradeModeColor, text_size=size.tiny)
        table.cell(infoTbl, 2, 19, displayModeShort, text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 3, 19, signalModeShort, text_color=color.gray, text_size=size.tiny)
        table.cell(infoTbl, 4, 19, smartTrailUp ? "LONG" : "SHORT", text_color=smartTrailUp ? color.lime : color.red, text_size=size.tiny)

        // í˜„ì¬ ìƒíƒœ ìš”ì•½
        string statusText = exitLongSignal ? "EXIT NOW" : trailFlipToShort ? "WARNING" : smartTrailUp ? "HOLDING" : "WAIT"
        color statusColor = exitLongSignal ? color.red : trailFlipToShort ? color.orange : smartTrailUp ? color.lime : color.gray
        color statusBg = exitLongSignal ? color.new(color.red, 60) : trailFlipToShort ? color.new(color.orange, 70) : color.new(color.gray, 80)
        table.cell(infoTbl, 0, 20, "STATUS", text_color=color.white, bgcolor=color.navy, text_size=size.tiny)
        table.cell(infoTbl, 1, 20, statusText, text_color=statusColor, bgcolor=statusBg, text_size=size.small)
        table.cell(infoTbl, 2, 20, str.tostring(longScore, "#") + "pt", text_color=longScore >= 16 ? color.green : color.gray, bgcolor=statusBg, text_size=size.tiny)
        table.cell(infoTbl, 3, 20, currentGrade, text_color=longScore >= 19 ? color.lime : longScore >= 16 ? color.green : color.gray, bgcolor=statusBg, text_size=size.tiny)
        table.cell(infoTbl, 4, 20, "", text_color=color.gray, bgcolor=statusBg, text_size=size.tiny)

// ============================================
// ë¯¸ë‹ˆ íŒ¨ë„ (ìµœì†Œí™” ëª¨ë“œìš©)
// ============================================

if showMiniPanel and isMinimalMode and barstate.islast
    var table miniTbl = table.new(position.top_right, 4, 12, bgcolor=color.new(color.black, 20), border_width=1)

    // ========== ğŸŸ¢ LONG ì‹ í˜¸ë“± íŒë‹¨ ë¡œì§ ==========
    // ğŸŸ¢ ë¡±OK: ëª¨ë“  í•µì‹¬ ì¡°ê±´ ì¶©ì¡± + êµ¬ë¦„ í•„í„°
    // ğŸŸ¡ ëŒ€ê¸°: ì¼ë¶€ ì¡°ê±´ë§Œ ì¶©ì¡±
    // ğŸ”´ ìœ„í—˜: ì—­ë°©í–¥ ë˜ëŠ” ìœ„í—˜ êµ¬ê°„

    // êµ¬ë¦„ í•„í„°: í™œì„±í™”ì‹œ êµ¬ë¦„ ì•„ë˜ë©´ ë¡± ì‹ í˜¸ ì°¨ë‹¨
    bool cloudLongOK = not ichimokuFilter or priceAboveCloud or priceInCloud
    bool cloudShortOK = not ichimokuFilter or priceBelowCloud or priceInCloud

    bool isLongGreen = smartTrailUp and tf1h_uptrend and longScore >= 16 and pricePosition < 30 and (deltaGrade == "STRONG BUY" or deltaGrade == "BUY" or deltaGrade == "NEUTRAL") and cloudLongOK
    bool isLongRed = exitLongSignal or (pricePosition > 70 and (deltaGrade == "STRONG SELL" or deltaGrade == "SELL")) or (not smartTrailUp and not tf1h_uptrend) or (ichimokuFilter and priceBelowCloud)

    string longLightEmoji = isLongGreen ? "ğŸŸ¢" : isLongRed ? "ğŸ”´" : "ğŸŸ¡"
    string longLightText = isLongGreen ? "ë¡±OK" : isLongRed ? "ìœ„í—˜" : "ëŒ€ê¸°"
    string longLightReason = isLongGreen ? "ì¡°ê±´ì¶©ì¡±!" : isLongRed ? (exitLongSignal ? "ì²­ì‚°í•„ìš”" : (ichimokuFilter and priceBelowCloud) ? "êµ¬ë¦„ì•„ë˜" : pricePosition > 70 ? "ê³ ì ì£¼ì˜" : "í•˜ë½ì¶”ì„¸") : (not smartTrailUp ? "ì¶”ì„¸â†“" : not tf1h_uptrend ? "1Hí•˜ë½" : longScore < 16 ? "ì ìˆ˜ë¶€ì¡±" : pricePosition >= 30 ? "ìœ„ì¹˜ë†’ìŒ" : not cloudLongOK ? "êµ¬ë¦„í™•ì¸" : "ì¡°ê±´í™•ì¸")
    color longLightBg = isLongGreen ? color.new(color.green, 20) : isLongRed ? color.new(color.red, 20) : color.new(color.yellow, 30)
    color longLightColor = isLongGreen ? color.lime : isLongRed ? color.red : color.yellow

    // ========== ğŸ”´ SHORT ì‹ í˜¸ë“± íŒë‹¨ ë¡œì§ ==========
    // ğŸŸ¢ ìˆOK: í•˜ë½ ì¡°ê±´ ì¶©ì¡± (ê³ ì  + í•˜ë½ì¶”ì„¸ + ë§¤ë„ì„¸) + êµ¬ë¦„ í•„í„°
    // ğŸŸ¡ ëŒ€ê¸°: ì¼ë¶€ ì¡°ê±´ë§Œ ì¶©ì¡±
    // ğŸ”´ ìœ„í—˜: ìƒìŠ¹ ì¶”ì„¸ ì¤‘

    bool isShortGreen = not smartTrailUp and not tf1h_uptrend and not tf4h_uptrend and pricePosition > 70 and (deltaGrade == "STRONG SELL" or deltaGrade == "SELL") and cloudShortOK
    bool isShortRed = (smartTrailUp and tf1h_uptrend and pricePosition < 50) or (ichimokuFilter and priceAboveCloud)

    string shortLightEmoji = isShortGreen ? "ğŸŸ¢" : isShortRed ? "ğŸ”´" : "ğŸŸ¡"
    string shortLightText = isShortGreen ? "ìˆOK" : isShortRed ? "ìœ„í—˜" : "ëŒ€ê¸°"
    string shortLightReason = isShortGreen ? "í•˜ë½ì¡°ê±´!" : isShortRed ? ((ichimokuFilter and priceAboveCloud) ? "êµ¬ë¦„ìœ„" : smartTrailUp ? "ìƒìŠ¹ì¶”ì„¸" : "ì €ì ì£¼ì˜") : (smartTrailUp ? "ì¶”ì„¸â†‘" : tf1h_uptrend ? "1HìƒìŠ¹" : pricePosition <= 70 ? "ìœ„ì¹˜ë‚®ìŒ" : not cloudShortOK ? "êµ¬ë¦„í™•ì¸" : deltaGrade == "NEUTRAL" ? "ìˆ˜ê¸‰ì¤‘ë¦½" : "ì¡°ê±´í™•ì¸")
    color shortLightBg = isShortGreen ? color.new(color.fuchsia, 20) : isShortRed ? color.new(color.red, 20) : color.new(color.yellow, 30)
    color shortLightColor = isShortGreen ? color.fuchsia : isShortRed ? color.red : color.yellow

    // Row 0: ğŸš¦ LONG ì‹ í˜¸ë“±
    table.cell(miniTbl, 0, 0, "ğŸ“ˆLONG", text_color=color.white, bgcolor=color.new(color.teal, 30), text_size=size.normal)
    table.cell(miniTbl, 1, 0, longLightEmoji + longLightText, text_color=longLightColor, bgcolor=longLightBg, text_size=size.large)
    table.cell(miniTbl, 2, 0, longLightReason, text_color=longLightColor, bgcolor=longLightBg, text_size=size.small)
    table.cell(miniTbl, 3, 0, str.tostring(longScore, "#") + "pt", text_color=longLightColor, bgcolor=longLightBg, text_size=size.normal)

    // Row 1: ğŸš¦ SHORT ì‹ í˜¸ë“± (ì„ ë¬¼ëª¨ë“œì—ì„œë§Œ ê°•ì¡°)
    color shortRowBg = isFutures ? shortLightBg : color.new(color.gray, 60)
    color shortRowColor = isFutures ? shortLightColor : color.gray
    string shortDisplay = isFutures ? shortLightEmoji + shortLightText : "í˜„ë¬¼ëª¨ë“œ"
    table.cell(miniTbl, 0, 1, "ğŸ“‰SHORT", text_color=color.white, bgcolor=color.new(color.purple, 30), text_size=size.normal)
    table.cell(miniTbl, 1, 1, shortDisplay, text_color=shortRowColor, bgcolor=shortRowBg, text_size=size.large)
    table.cell(miniTbl, 2, 1, isFutures ? shortLightReason : "ìˆë¶ˆê°€", text_color=shortRowColor, bgcolor=shortRowBg, text_size=size.small)
    table.cell(miniTbl, 3, 1, isFutures ? (isShortGreen ? "GO!" : "") : "", text_color=color.fuchsia, bgcolor=shortRowBg, text_size=size.normal)

    // ì‹œê·¸ë„ ìƒíƒœ
    string sigText = superLong ? "SUPER" : strongLong ? "STRONG" : normalLong ? "LONG" : exitLongSignal ? "EXIT!" : "WAIT"
    color sigColor = superLong ? color.aqua : strongLong ? color.yellow : normalLong ? color.green : exitLongSignal ? color.red : color.gray
    color sigBg = superLong ? color.new(color.aqua, 50) : exitLongSignal ? color.new(color.red, 50) : color.new(color.gray, 70)

    // í˜„ì¬ ìƒíƒœ
    string statusText = exitLongSignal ? "ì²­ì‚°!" : trailFlipToShort ? "ì£¼ì˜" : smartTrailUp ? "ë³´ìœ " : "ëŒ€ê¸°"
    color statusColor = exitLongSignal ? color.red : trailFlipToShort ? color.orange : smartTrailUp ? color.lime : color.gray

    // EMA ê°ë„ ìƒíƒœ + í•œê¸€
    string emaAngleStatus = emaStrongUp ? "â–²â–²ê°•ì„¸" : emaWeakUp ? "â–²ìƒìŠ¹" : emaSideways ? "-íš¡ë³´" : "â–¼í•˜ë½"
    color emaAngleStatusColor = emaStrongUp ? color.lime : emaWeakUp ? color.yellow : emaSideways ? color.orange : color.red

    // Row 2: í—¤ë”
    table.cell(miniTbl, 0, 2, "V39", text_color=color.white, bgcolor=color.blue, text_size=size.normal)
    table.cell(miniTbl, 1, 2, emaAngleStatus, text_color=emaAngleStatusColor, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(miniTbl, 2, 2, timeframe.period, text_color=color.white, bgcolor=color.gray, text_size=size.normal)
    table.cell(miniTbl, 3, 2, smartTrailUp ? "ì¶”ì„¸â†‘" : "ì¶”ì„¸â†“", text_color=smartTrailUp ? color.lime : color.red, bgcolor=color.new(color.gray, 50), text_size=size.small)

    // Row 3: ì‹œê·¸ë„
    string sigKorean = superLong ? "ìµœê°•ë§¤ìˆ˜" : strongLong ? "ê°•ë ¥ë§¤ìˆ˜" : normalLong ? "ë§¤ìˆ˜" : exitLongSignal ? "ì²­ì‚°!" : "ëŒ€ê¸°"
    table.cell(miniTbl, 0, 3, "ì‹œê·¸ë„", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 3, sigText, text_color=sigColor, bgcolor=sigBg, text_size=size.large)
    table.cell(miniTbl, 2, 3, sigKorean, text_color=sigColor, bgcolor=sigBg, text_size=size.small)
    table.cell(miniTbl, 3, 3, str.tostring(longScore, "#") + "pt", text_color=longScore >= 16 ? color.green : color.gray, bgcolor=sigBg, text_size=size.small)

    // Row 4: ì¶”ì„¸ + í•œê¸€ í•´ì„
    string trendKorean = uptrendCount >= 3 ? "ì¢‹ìŒ" : uptrendCount >= 2 ? "ë³´í†µ" : "ë‚˜ì¨"
    color trendKoreanColor = uptrendCount >= 3 ? color.lime : uptrendCount >= 2 ? color.yellow : color.red
    table.cell(miniTbl, 0, 4, "ì¶”ì„¸", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 4, str.tostring(uptrendCount) + "/4 " + trendKorean, text_color=trendKoreanColor, text_size=size.small)
    table.cell(miniTbl, 2, 4, tf1h_uptrend ? "1HìƒìŠ¹" : "1Hí•˜ë½", text_color=tf1h_uptrend ? color.green : color.red, text_size=size.small)
    table.cell(miniTbl, 3, 4, tf4h_uptrend ? "4HìƒìŠ¹" : "4Hí•˜ë½", text_color=tf4h_uptrend ? color.green : color.red, text_size=size.small)

    // Row 5: ìœ„ì¹˜ + í•œê¸€ í•´ì„
    string posKorean = pricePosition < 20 ? "ì €ì OK" : pricePosition < 40 ? "ì–‘í˜¸" : pricePosition < 60 ? "ì¤‘ê°„" : pricePosition < 80 ? "ë†’ìŒ" : "ê³ ì !"
    color posKoreanColor = pricePosition < 20 ? color.lime : pricePosition < 40 ? color.green : pricePosition < 60 ? color.yellow : pricePosition < 80 ? color.orange : color.red
    table.cell(miniTbl, 0, 5, "ìœ„ì¹˜", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 5, str.tostring(pricePosition, "#") + "% " + posKorean, text_color=posKoreanColor, text_size=size.small)
    table.cell(miniTbl, 2, 5, "ê±°ë˜ëŸ‰", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 3, 5, str.tostring(volRatio, "#.#") + "x", text_color=volSpike ? color.green : color.gray, text_size=size.small)

    // Row 6: ìƒíƒœ + í•œê¸€
    color statusBg = exitLongSignal ? color.new(color.red, 50) : trailFlipToShort ? color.new(color.orange, 60) : color.new(color.gray, 70)
    string zoneKorean = inDiscount ? "ì €ì êµ¬ê°„" : inPremium ? "ê³ ì êµ¬ê°„" : "ì¤‘ê°„"
    table.cell(miniTbl, 0, 6, "ìƒíƒœ", text_color=color.white, bgcolor=color.navy, text_size=size.small)
    table.cell(miniTbl, 1, 6, statusText, text_color=statusColor, bgcolor=statusBg, text_size=size.large)
    table.cell(miniTbl, 2, 6, zoneKorean, text_color=inDiscount ? color.green : inPremium ? color.red : color.gray, bgcolor=statusBg, text_size=size.small)
    table.cell(miniTbl, 3, 6, superLong ? "GO!!" : strongLong ? "GO!" : exitLongSignal ? "OUT!" : "", text_color=superLong ? color.aqua : strongLong ? color.yellow : color.red, bgcolor=statusBg, text_size=size.normal)

    // Row 7: ê³ ë˜ + í•œê¸€
    string whaleKoreanText = whaleBuy ? "ëŒ€ëŸ‰ë§¤ìˆ˜" : whaleSell ? "ëŒ€ëŸ‰ë§¤ë„" : "ì—†ìŒ"
    color whaleBg = whaleBuy ? color.new(color.blue, 50) : whaleSell ? color.new(color.purple, 50) : color.new(color.gray, 70)
    color whaleColor = whaleBuy ? color.aqua : whaleSell ? color.fuchsia : color.gray
    table.cell(miniTbl, 0, 7, "ê³ ë˜", text_color=color.white, bgcolor=color.new(color.purple, 30), text_size=size.small)
    table.cell(miniTbl, 1, 7, whaleKoreanText, text_color=whaleColor, bgcolor=whaleBg, text_size=size.small)
    table.cell(miniTbl, 2, 7, isWhaleVolume ? str.tostring(volRatio, "#.#") + "x" : "-", text_color=isWhaleVolume ? color.yellow : color.gray, bgcolor=whaleBg, text_size=size.small)
    table.cell(miniTbl, 3, 7, whaleBuy or whaleSell ? whaleStrength : "", text_color=color.yellow, bgcolor=whaleBg, text_size=size.small)

    // Row 8: ì‹¬ë¦¬ + ë” ëª…í™•í•œ í•œê¸€
    color psychBg = extremeFear ? color.new(color.green, 40) : extremeGreed ? color.new(color.red, 40) : psychBuyZone ? color.new(color.teal, 50) : psychSellZone ? color.new(color.maroon, 50) : color.new(color.gray, 70)
    color psychColor = extremeFear or psychBuyZone ? color.lime : extremeGreed or psychSellZone ? color.red : color.gray
    string psychAction = extremeFear ? "ë§¤ìˆ˜ê¸°íšŒ" : extremeGreed ? "ë§¤ë„ì£¼ì˜" : psychBuyZone ? "ë§¤ìˆ˜êµ¬ê°„" : psychSellZone ? "ë§¤ë„êµ¬ê°„" : "ì¤‘ë¦½"
    table.cell(miniTbl, 0, 8, "ì‹¬ë¦¬", text_color=color.white, bgcolor=color.new(color.navy, 30), text_size=size.small)
    table.cell(miniTbl, 1, 8, fearGreedEmoji + fearGreedGrade, text_color=psychColor, bgcolor=psychBg, text_size=size.small)
    table.cell(miniTbl, 2, 8, psychAction, text_color=psychColor, bgcolor=psychBg, text_size=size.small)
    table.cell(miniTbl, 3, 8, nearRoundBelow ? "ì§€ì§€ì„ " : nearRoundAbove ? "ì €í•­ì„ " : "", text_color=color.aqua, bgcolor=psychBg, text_size=size.small)

    // Row 9: Delta + ìŠ¤ë§ˆíŠ¸ OBV
    string deltaKorean = deltaGrade == "STRONG BUY" ? "ê°•ë§¤ìˆ˜ì„¸" : deltaGrade == "BUY" ? "ë§¤ìˆ˜ì„¸" : deltaGrade == "STRONG SELL" ? "ê°•ë§¤ë„ì„¸" : deltaGrade == "SELL" ? "ë§¤ë„ì„¸" : "ì¤‘ë¦½"
    string smartOBVKorean = smartOBVGrade == "STRONG BUY" ? "ê°•ë§¤ìˆ˜" : smartOBVGrade == "BUY" ? "ë§¤ìˆ˜" : smartOBVGrade == "STRONG SELL" ? "ê°•ë§¤ë„" : smartOBVGrade == "SELL" ? "ë§¤ë„" : smartOBVGrade == "SQUEEZE" ? "ì‘ì¶•" : "ì¤‘ë¦½"
    color deltaBg = deltaGrade == "STRONG BUY" ? color.new(color.lime, 40) : deltaGrade == "BUY" ? color.new(color.green, 50) : deltaGrade == "STRONG SELL" ? color.new(color.fuchsia, 40) : deltaGrade == "SELL" ? color.new(color.red, 50) : color.new(color.gray, 70)
    color smartOBVColor = smartOBVGrade == "STRONG BUY" ? color.lime : smartOBVGrade == "BUY" ? color.green : smartOBVGrade == "STRONG SELL" ? color.fuchsia : smartOBVGrade == "SELL" ? color.red : smartOBVGrade == "SQUEEZE" ? color.yellow : color.gray
    table.cell(miniTbl, 0, 9, "ìˆ˜ê¸‰", text_color=color.white, bgcolor=color.new(color.teal, 30), text_size=size.small)
    table.cell(miniTbl, 1, 9, deltaKorean, text_color=deltaColor, bgcolor=deltaBg, text_size=size.small)
    table.cell(miniTbl, 2, 9, str.tostring(deltaRatio, "#") + "%", text_color=deltaColor, bgcolor=deltaBg, text_size=size.small)
    table.cell(miniTbl, 3, 9, "OBV:" + smartOBVKorean, text_color=smartOBVColor, bgcolor=deltaBg, text_size=size.small)

    // Row 10: ì¼ëª© êµ¬ë¦„ ìƒíƒœ
    string cloudKorean = priceAboveCloud ? "êµ¬ë¦„ìœ„" : priceBelowCloud ? "êµ¬ë¦„ì•„ë˜" : "êµ¬ë¦„ë‚´"
    string cloudType = bullishCloud ? "ì–‘ìš´" : "ìŒìš´"
    string cloudAction = priceAboveCloud ? "ë¡±ìœ ë¦¬" : priceBelowCloud ? "ìˆìœ ë¦¬" : "ê´€ë§"
    color cloudBg = priceAboveCloud ? color.new(color.lime, 40) : priceBelowCloud ? color.new(color.red, 40) : color.new(color.yellow, 50)
    color cloudTextColor = priceAboveCloud ? color.lime : priceBelowCloud ? color.red : color.yellow
    table.cell(miniTbl, 0, 10, "êµ¬ë¦„", text_color=color.white, bgcolor=color.new(color.purple, 30), text_size=size.small)
    table.cell(miniTbl, 1, 10, cloudKorean, text_color=cloudTextColor, bgcolor=cloudBg, text_size=size.small)
    table.cell(miniTbl, 2, 10, cloudType, text_color=bullishCloud ? color.lime : color.red, bgcolor=cloudBg, text_size=size.small)
    table.cell(miniTbl, 3, 10, cloudAction, text_color=cloudTextColor, bgcolor=cloudBg, text_size=size.small)

    // Row 11: ìš”ì•½ ì¡°ì–¸
    string longAdvice = isLongGreen ? "ë¡± ì§„ì… ê³ ë ¤" : isLongRed ? "ë¡± ìœ„í—˜!" : "ë¡± ëŒ€ê¸°"
    string shortAdvice = isShortGreen ? "ìˆ ì§„ì… ê³ ë ¤" : isShortRed ? "ìˆ ìœ„í—˜!" : "ìˆ ëŒ€ê¸°"
    string finalAdvice = isLongGreen ? longAdvice : (isFutures and isShortGreen) ? shortAdvice : (isLongRed and isFutures and not isShortRed) ? "ìˆ ê²€í† ?" : "ê´€ë§ ì¶”ì²œ"
    color adviceBg = isLongGreen ? color.new(color.green, 30) : (isFutures and isShortGreen) ? color.new(color.fuchsia, 30) : color.new(color.gray, 50)
    color adviceColor = isLongGreen ? color.lime : (isFutures and isShortGreen) ? color.fuchsia : color.gray
    table.cell(miniTbl, 0, 11, "ì¡°ì–¸", text_color=color.white, bgcolor=color.navy, text_size=size.small)
    table.cell(miniTbl, 1, 11, finalAdvice, text_color=adviceColor, bgcolor=adviceBg, text_size=size.small)
    table.cell(miniTbl, 2, 11, "", text_color=color.gray, bgcolor=adviceBg, text_size=size.small)
    table.cell(miniTbl, 3, 11, "", text_color=color.gray, bgcolor=adviceBg, text_size=size.small)

// ============================================
// ì•Œë¦¼ (ì°¸ê³ ìš© - íˆ¬ìê¶Œìœ  ì•„ë‹˜)
// ============================================

// ê±°ë˜ëŸ‰ ë°°ìˆ˜ í…ìŠ¤íŠ¸ (5ë¶„ë´‰ ì œê±°)
string volDetail15m = "15m:" + str.tostring(tf15m_volRatio, "#.#") + "x"
string volDetail1h = "1H:" + str.tostring(tf1h_volRatio, "#.#") + "x"
string volDetail4h = "4H:" + str.tostring(tf4h_volRatio, "#.#") + "x"
string volDetails = volDetail15m + " " + volDetail1h + " " + volDetail4h

// ë©´ì±… ë¬¸êµ¬
string disclaimer = "[ì°¸ê³ ìš©-íˆ¬ìê¶Œìœ ì•„ë‹˜]"

if superLong
    string m1 = "ğŸš€ğŸš€ğŸš€ SUPER LONG ğŸš€ğŸš€ğŸš€"
    string m2 = "[" + finalGrade + "] " + str.tostring(longScore, "#") + "pt"
    string m3 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string m4 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string m5 = "ğŸ“ˆ ì¶”ì„¸: " + trendStrength + " | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string m6 = "ğŸ“Š TF:" + str.tostring(uptrendCount) + "/4 | Vol:" + str.tostring(volSpikeCount) + "/4"
    string m7 = "ğŸ“‰ ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ìˆ˜ì••ë ¥: " + str.tostring(buyPressure, "#") + "%"
    string m7b = "ğŸ“Š Delta: " + deltaGrade + " | CVD: " + (cvdUptrend ? "ìƒìŠ¹â†‘" : cvdDowntrend ? "í•˜ë½â†“" : "ì¤‘ë¦½")
    string m8 = disclaimer
    string msg = m1 + "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5 + "\n" + m6 + "\n" + m7 + "\n" + m7b + "\n" + m8
    alert(msg, freq=alert.freq_once_per_bar_close)

if strongLong and not superLong
    string m1 = "â­â­ STRONG LONG â­â­"
    string m2 = "[" + currentGrade + "] " + str.tostring(longScore, "#") + "pt"
    string m3 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string m4 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string m5 = "ğŸ“ˆ ì¶”ì„¸: " + trendStrength + " | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string m6 = "ğŸ“Š TF:" + str.tostring(uptrendCount) + "/4 | EMA:" + str.tostring(emaAlignedUpCount) + "/5"
    string m7 = "ğŸ“‰ ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ìˆ˜ì••ë ¥: " + str.tostring(buyPressure, "#") + "%"
    string m7b = "ğŸ“Š Delta: " + deltaGrade + " | CVD: " + (cvdUptrend ? "ìƒìŠ¹â†‘" : cvdDowntrend ? "í•˜ë½â†“" : "ì¤‘ë¦½")
    string m8 = disclaimer
    string msg = m1 + "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5 + "\n" + m6 + "\n" + m7 + "\n" + m7b + "\n" + m8
    alert(msg, freq=alert.freq_once_per_bar_close)

if normalLong and signalMode == "ì „ì²´"
    string m1 = "ğŸ“— LONG [" + currentGrade + "] " + str.tostring(longScore, "#") + "pt"
    string m2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string m3 = "ğŸ“ˆ ì¶”ì„¸:" + trendStrength + " | TF:" + str.tostring(uptrendCount) + "/4"
    string m4 = "ğŸ“‰ ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ìˆ˜ì••ë ¥: " + str.tostring(buyPressure, "#") + "%"
    string m5 = disclaimer
    alert(m1 + "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5, freq=alert.freq_once_per_bar_close)

// ============================================
// ì²­ì‚° ì•Œë¦¼
// ============================================

if exitLongSignal
    string e1 = "âŒâŒ EXIT LONG âŒâŒ"
    string e2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string e3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string e4 = "âš ï¸ Smart Trailì´ SHORTë¡œ ì „í™˜ë¨"
    string e5 = "ğŸ“Š ì ìˆ˜: " + str.tostring(longScore, "#") + "pt | 1Hì¶”ì„¸: " + (tf1h_uptrend ? "UP" : "DOWN")
    string e6 = disclaimer
    alert(e1 + "\n" + e2 + "\n" + e3 + "\n" + e4 + "\n" + e5 + "\n" + e6, freq=alert.freq_once_per_bar_close)

if trailFlipToShort and not exitLongSignal
    string w1 = "âš ï¸ Trail Warning âš ï¸"
    string w2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string w3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string w4 = "ğŸ“‰ Smart Trail SHORT ì „í™˜ - ëª¨ë‹ˆí„°ë§ í•„ìš”"
    string w5 = "ğŸ“Š ì ìˆ˜: " + str.tostring(longScore, "#") + "pt | " + disclaimer
    alert(w1 + "\n" + w2 + "\n" + w3 + "\n" + w4 + "\n" + w5, freq=alert.freq_once_per_bar_close)

// ============================================
// SHORT ì•Œë¦¼ (ì„ ë¬¼ ëª¨ë“œì—ì„œë§Œ)
// ============================================

if superShort
    string s1 = "ğŸ’€ğŸ’€ğŸ’€ SUPER SHORT ğŸ’€ğŸ’€ğŸ’€"
    string s2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string s3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string s4 = "ğŸ“‰ í•˜ë½TF:" + str.tostring(downtrendCount) + "/4 | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string s5 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ë„ì••ë ¥: " + str.tostring(100 - buyPressure, "#") + "%"
    string s6 = disclaimer
    alert(s1 + "\n" + s2 + "\n" + s3 + "\n" + s4 + "\n" + s5 + "\n" + s6, freq=alert.freq_once_per_bar_close)

if strongShort and not superShort
    string s1 = "âš ï¸âš ï¸ STRONG SHORT âš ï¸âš ï¸"
    string s2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string s3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string s4 = "ğŸ“‰ í•˜ë½TF:" + str.tostring(downtrendCount) + "/4 | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string s5 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | ë§¤ë„ì••ë ¥: " + str.tostring(100 - buyPressure, "#") + "%"
    string s6 = disclaimer
    alert(s1 + "\n" + s2 + "\n" + s3 + "\n" + s4 + "\n" + s5 + "\n" + s6, freq=alert.freq_once_per_bar_close)

if normalShort and signalMode == "ì „ì²´"
    string s1 = "ğŸ“• SHORT"
    string s2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string s3 = "ğŸ“‰ í•˜ë½TF:" + str.tostring(downtrendCount) + "/4 | ìœ„ì¹˜: " + str.tostring(pricePosition, "#") + "%"
    string s4 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x | " + disclaimer
    alert(s1 + "\n" + s2 + "\n" + s3 + "\n" + s4, freq=alert.freq_once_per_bar_close)

if exitShortSignal
    string e1 = "âŒâŒ EXIT SHORT âŒâŒ"
    string e2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string e3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string e4 = "âœ… Smart Trailì´ LONGìœ¼ë¡œ ì „í™˜ë¨"
    string e5 = disclaimer
    alert(e1 + "\n" + e2 + "\n" + e3 + "\n" + e4 + "\n" + e5, freq=alert.freq_once_per_bar_close)

// ============================================
// ê³ ë˜ ì•Œë¦¼
// ============================================

if showWhale and whaleBuy
    string w1 = whaleStrength + " ë§¤ìˆ˜ ê°ì§€!"
    string w2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string w3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string w4 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x (" + whaleKorean + " ë“±ê¸‰)"
    string w5 = "ğŸ“ˆ ê°€ê²©ë³€ë™: +" + str.tostring(priceChangePercent, "#.##") + "%"
    string w6 = "ğŸ’ª ë§¤ìˆ˜ì••ë ¥: " + str.tostring(buyPressure, "#") + "% | " + disclaimer
    alert(w1 + "\n" + w2 + "\n" + w3 + "\n" + w4 + "\n" + w5 + "\n" + w6, freq=alert.freq_once_per_bar_close)

if showWhale and whaleSell
    string w1 = whaleStrength + " ë§¤ë„ ê°ì§€!"
    string w2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string w3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string w4 = "ğŸ“Š ê±°ë˜ëŸ‰: " + str.tostring(volRatio, "#.#") + "x (" + whaleKorean + " ë“±ê¸‰)"
    string w5 = "ğŸ“‰ ê°€ê²©ë³€ë™: -" + str.tostring(priceChangePercent, "#.##") + "%"
    string w6 = "ğŸ“‰ ë§¤ë„ì••ë ¥: " + str.tostring(100 - buyPressure, "#") + "% | " + disclaimer
    alert(w1 + "\n" + w2 + "\n" + w3 + "\n" + w4 + "\n" + w5 + "\n" + w6, freq=alert.freq_once_per_bar_close)

// ============================================
// Delta ê¸‰ì¦ ì•Œë¦¼ (ìˆ˜ê¸‰ ê¸‰ë³€)
// ============================================

if showVolumeDelta and isDeltaSpike and strongPositiveDelta
    string d1 = "ğŸ“ˆğŸ“ˆ DELTA ê¸‰ì¦ (ë§¤ìˆ˜) ğŸ“ˆğŸ“ˆ"
    string d2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string d3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string d4 = "ğŸ“Š Delta: " + str.tostring(deltaRatio, "#") + "% (í‰ê·  " + str.tostring(deltaSpike, "#.#") + "ë°°)"
    string d5 = "ğŸ“ˆ CVD: " + (cvdUptrend ? "ìƒìŠ¹ ì¶”ì„¸" : "í•˜ë½ ì¶”ì„¸")
    string d6 = delta3ConsecutiveBuy ? "âœ… 3ë´‰ ì—°ì† ë§¤ìˆ˜ ìš°ì„¸\n" : ""
    string d7 = disclaimer
    string deltaMsg1 = d1 + "\n" + d2 + "\n" + d3 + "\n" + d4 + "\n" + d5 + "\n" + d6 + d7
    alert(deltaMsg1, freq=alert.freq_once_per_bar_close)

if showVolumeDelta and isDeltaSpike and strongNegativeDelta
    string d1 = "ğŸ“‰ğŸ“‰ DELTA ê¸‰ì¦ (ë§¤ë„) ğŸ“‰ğŸ“‰"
    string d2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string d3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string d4 = "ğŸ“Š Delta: " + str.tostring(deltaRatio, "#") + "% (í‰ê·  " + str.tostring(deltaSpike, "#.#") + "ë°°)"
    string d5 = "ğŸ“‰ CVD: " + (cvdUptrend ? "ìƒìŠ¹ ì¶”ì„¸" : "í•˜ë½ ì¶”ì„¸")
    string d6 = delta3ConsecutiveSell ? "âš ï¸ 3ë´‰ ì—°ì† ë§¤ë„ ìš°ì„¸\n" : ""
    string d7 = disclaimer
    string deltaMsg2 = d1 + "\n" + d2 + "\n" + d3 + "\n" + d4 + "\n" + d5 + "\n" + d6 + d7
    alert(deltaMsg2, freq=alert.freq_once_per_bar_close)

// Delta ë‹¤ì´ë²„ì „ìŠ¤ ì•Œë¦¼
if showVolumeDelta and deltaBullDiv and nearSupport3d
    string d1 = "ğŸ”„ Delta ê°•ì„¸ ë‹¤ì´ë²„ì „ìŠ¤!"
    string d2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string d3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string d4 = "ê°€ê²©â†“ + CVDâ†‘ = ë°˜ì „ ì‹ í˜¸"
    string d5 = "ğŸ“ ì§€ì§€ì„  ê·¼ì²˜ - ë§¤ìˆ˜ ê³ ë ¤"
    string d6 = disclaimer
    alert(d1 + "\n" + d2 + "\n" + d3 + "\n" + d4 + "\n" + d5 + "\n" + d6, freq=alert.freq_once_per_bar_close)

// ============================================
// ì—˜ë¦¬ì—‡ íŒŒë™ ë¶„ì„ (Elliott Wave Analysis)
// ============================================

// ìŠ¤ìœ™ ê³ ì /ì €ì  ê°ì§€
ewSwingHigh = ta.pivothigh(high, ewSwingLength, ewSwingLength)
ewSwingLow = ta.pivotlow(low, ewSwingLength, ewSwingLength)

// ìŠ¤ìœ™ í¬ì¸íŠ¸ ì €ì¥ ë°°ì—´
var float[] ewHighs = array.new_float(10, na)
var float[] ewLows = array.new_float(10, na)
var int[] ewHighBars = array.new_int(10, na)
var int[] ewLowBars = array.new_int(10, na)

// ìŠ¤ìœ™ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
if showElliottWave and not na(ewSwingHigh)
    array.unshift(ewHighs, ewSwingHigh)
    array.unshift(ewHighBars, bar_index - ewSwingLength)
    if array.size(ewHighs) > 10
        array.pop(ewHighs)
        array.pop(ewHighBars)

if showElliottWave and not na(ewSwingLow)
    array.unshift(ewLows, ewSwingLow)
    array.unshift(ewLowBars, bar_index - ewSwingLength)
    if array.size(ewLows) > 10
        array.pop(ewLows)
        array.pop(ewLowBars)

// í”¼ë³´ë‚˜ì¹˜ ë˜ëŒë¦¼ ë¹„ìœ¨ ê³„ì‚° í•¨ìˆ˜ (Wave1ì—ì„œ ì–¼ë§ˆë‚˜ ë˜ëŒë¦¼í–ˆëŠ”ì§€)
ewFibRetracement(float waveStart, float waveEnd, float retracePoint) =>
    math.abs((waveEnd - retracePoint) / (waveEnd - waveStart) * 100)

// í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ ì²´í¬ (í—ˆìš© ì˜¤ì°¨ í¬í•¨)
ewCheckFib(float ratio, float target) =>
    math.abs(ratio - target) <= ewFibTolerance

// íŒŒë™ êµ¬ì¡° ë¶„ì„
var string ewCurrentPattern = "ë¶„ì„ì¤‘"
var string ewCurrentWave = "-"
var float ewWave0 = na  // ì‹œì‘ì 
var float ewWave1 = na
var float ewWave2 = na
var float ewWave3 = na
var float ewWave4 = na
var float ewWave5 = na
var int ewWave0Bar = na
var int ewWave1Bar = na
var int ewWave2Bar = na
var int ewWave3Bar = na
var int ewWave4Bar = na
var int ewWave5Bar = na
var bool ewIsUptrend = true

// ìµœê·¼ ìŠ¤ìœ™ í¬ì¸íŠ¸ë¡œ íŒŒë™ ë¶„ì„
if showElliottWave and array.size(ewHighs) >= 3 and array.size(ewLows) >= 3
    // ìµœê·¼ ê³ ì /ì €ì  ê°€ì ¸ì˜¤ê¸°
    float h1 = array.get(ewHighs, 0)
    float h2 = array.get(ewHighs, 1)
    float h3 = array.get(ewHighs, 2)
    float l1 = array.get(ewLows, 0)
    float l2 = array.get(ewLows, 1)
    float l3 = array.get(ewLows, 2)

    int hb1 = array.get(ewHighBars, 0)
    int hb2 = array.get(ewHighBars, 1)
    int lb1 = array.get(ewLowBars, 0)
    int lb2 = array.get(ewLowBars, 1)

    // ìƒìŠ¹ Impulse íŒ¨í„´ ê°ì§€ (HH + HL êµ¬ì¡°)
    bool isHigherHigh = not na(h1) and not na(h2) and h1 > h2
    bool isHigherLow = not na(l1) and not na(l2) and l1 > l2

    // í•˜ë½ Impulse íŒ¨í„´ ê°ì§€ (LH + LL êµ¬ì¡°)
    bool isLowerHigh = not na(h1) and not na(h2) and h1 < h2
    bool isLowerLow = not na(l1) and not na(l2) and l1 < l2

    // ì‹œê°„ ìˆœì„œ ê²€ì¦: Wave0(ì €ì ) â†’ Wave1(ê³ ì ) â†’ Wave2(ì €ì ) â†’ Wave3(ê³ ì )
    bool validUptrendSequence = lb2 < hb2 and hb2 < lb1 and lb1 < hb1
    bool validDowntrendSequence = hb2 < lb2 and lb2 < hb1 and hb1 < lb1

    // ìƒìŠ¹ ì¶”ì„¸ Impulse
    if isHigherHigh and isHigherLow and validUptrendSequence
        ewIsUptrend := true
        ewWave0 := l2
        ewWave1 := h2
        ewWave2 := l1
        ewWave3 := h1
        ewWave0Bar := lb2
        ewWave1Bar := hb2
        ewWave2Bar := lb1
        ewWave3Bar := hb1

        // í”¼ë³´ë‚˜ì¹˜ ë¹„ìœ¨ ê²€ì¦
        float wave1Size = ewWave1 - ewWave0
        float wave2Retrace = ewFibRetracement(ewWave0, ewWave1, ewWave2)
        float wave3Extend = (ewWave3 - ewWave2) / wave1Size * 100

        // Wave 2: 38.2~78.6% ë˜ëŒë¦¼ (ê°€ì¥ ì¼ë°˜ì : 50~61.8%)
        bool validWave2 = wave2Retrace >= 38.2 and wave2Retrace <= 78.6

        // Wave 3: 161.8% ì´ìƒ í™•ì¥ (ê°€ì¥ ê°•í•œ íŒŒë™, ì ˆëŒ€ ê°€ì¥ ì§§ì§€ ì•ŠìŒ)
        bool validWave3 = wave3Extend >= 161.8

        if validWave2 and validWave3
            ewCurrentPattern := "IMPULSE â†‘"
            if close > ewWave3
                ewCurrentWave := "Wave 5 ì§„í–‰ì¤‘"
            else if close > ewWave2
                ewCurrentWave := "Wave 3 ì§„í–‰ì¤‘"
            else
                ewCurrentWave := "Wave 2 (ë§¤ìˆ˜ êµ¬ê°„)"
        else if validWave2 and wave3Extend >= 100
            ewCurrentPattern := "IMPULSE â†‘ (ì•½)"
            ewCurrentWave := "Wave 3 ì§„í–‰ì¤‘"
        else if validWave2
            ewCurrentPattern := "ABC ì¡°ì • ê°€ëŠ¥"
            ewCurrentWave := "Wave C ì§„í–‰ì¤‘"

    // í•˜ë½ ì¶”ì„¸ Impulse
    else if isLowerHigh and isLowerLow and validDowntrendSequence
        ewIsUptrend := false
        ewWave0 := h2
        ewWave1 := l2
        ewWave2 := h1
        ewWave3 := l1
        ewWave0Bar := hb2
        ewWave1Bar := lb2
        ewWave2Bar := hb1
        ewWave3Bar := lb1

        float wave1Size = ewWave0 - ewWave1
        float wave2Retrace = ewFibRetracement(ewWave0, ewWave1, ewWave2)
        float wave3Extend = (ewWave2 - ewWave3) / wave1Size * 100

        // Wave 2: 38.2~78.6% ë˜ëŒë¦¼
        bool validWave2 = wave2Retrace >= 38.2 and wave2Retrace <= 78.6
        // Wave 3: 161.8% ì´ìƒ í™•ì¥
        bool validWave3 = wave3Extend >= 161.8

        if validWave2 and validWave3
            ewCurrentPattern := "IMPULSE â†“"
            if close < ewWave3
                ewCurrentWave := "Wave 5 ì§„í–‰ì¤‘"
            else if close < ewWave2
                ewCurrentWave := "Wave 3 ì§„í–‰ì¤‘"
            else
                ewCurrentWave := "Wave 2 (ë§¤ë„ êµ¬ê°„)"
        else if validWave2 and wave3Extend >= 100
            ewCurrentPattern := "IMPULSE â†“ (ì•½)"
            ewCurrentWave := "Wave 3 ì§„í–‰ì¤‘"
        else if validWave2
            ewCurrentPattern := "ABC ì¡°ì • ê°€ëŠ¥"
            ewCurrentWave := "Wave C ì§„í–‰ì¤‘"

    // íš¡ë³´/ì‚¼ê°í˜• íŒ¨í„´ ê°ì§€
    else if not isHigherHigh and not isLowerLow
        float range1 = math.abs(h1 - l1)
        float range2 = math.abs(h2 - l2)

        // ìˆ˜ë ´ ì‚¼ê°í˜•: ë²”ìœ„ê°€ ì¤„ì–´ë“¦
        if range1 < range2
            ewCurrentPattern := "TRIANGLE"
            ewCurrentWave := "ìˆ˜ë ´ ì¤‘ (ë¸Œë ˆì´í¬ì•„ì›ƒ ëŒ€ê¸°)"
        else
            ewCurrentPattern := "FLAT/ZIGZAG"
            ewCurrentWave := "ì¡°ì •íŒŒ ì§„í–‰ì¤‘"

// Wave 3 ë§¤ë§¤ ì‹ í˜¸ (ê³¨ë“ ì¡´)
var bool ewWave3BuyZone = false
var bool ewWave3SellZone = false
var float ewGoldenTop = na
var float ewGoldenBottom = na

if showElliottWave and not na(ewWave0) and not na(ewWave1)
    float wave1Range = math.abs(ewWave1 - ewWave0)

    if ewIsUptrend
        // ìƒìŠ¹ ì¶”ì„¸: Wave 2 ê³¨ë“ ì¡´ (61.8~78.6%)
        ewGoldenTop := ewWave1 - wave1Range * 0.618
        ewGoldenBottom := ewWave1 - wave1Range * 0.786
        ewWave3BuyZone := close >= ewGoldenBottom and close <= ewGoldenTop and close < ewWave1
        ewWave3SellZone := false
    else
        // í•˜ë½ ì¶”ì„¸: Wave 2 ê³¨ë“ ì¡´ (61.8~78.6%)
        ewGoldenBottom := ewWave1 + wave1Range * 0.618
        ewGoldenTop := ewWave1 + wave1Range * 0.786
        ewWave3SellZone := close >= ewGoldenBottom and close <= ewGoldenTop and close > ewWave1
        ewWave3BuyZone := false

// ì—˜ë¦¬ì—‡ íŒŒë™ ì‹œê°í™”
var label ewLabel1 = na
var label ewLabel2 = na
var label ewLabel3 = na
var line ewFibLine1 = na
var line ewFibLine2 = na
var line ewFibLine3 = na
var box ewGoldenBox = na

// ì´ì „ ê°ì²´ ì‚­ì œ
if showElliottWave and showEWLabels
    label.delete(ewLabel1[1])
    label.delete(ewLabel2[1])
    label.delete(ewLabel3[1])

if showElliottWave and showEWFib
    line.delete(ewFibLine1[1])
    line.delete(ewFibLine2[1])
    line.delete(ewFibLine3[1])

if showElliottWave and showEWZones
    box.delete(ewGoldenBox[1])

// íŒŒë™ ë ˆì´ë¸” ê·¸ë¦¬ê¸°
if showElliottWave and showEWLabels and not na(ewWave1Bar) and not na(ewWave2Bar)
    labelColor = ewIsUptrend ? ewImpulseColor : ewCorrectiveColor

    if not na(ewWave0) and not na(ewWave0Bar)
        ewLabel1 := label.new(ewWave0Bar, ewIsUptrend ? ewWave0 : ewWave0,
             ewIsUptrend ? "0" : "0",
             style=ewIsUptrend ? label.style_label_up : label.style_label_down,
             color=labelColor, textcolor=color.white, size=size.small)

    if not na(ewWave1) and not na(ewWave1Bar)
        ewLabel2 := label.new(ewWave1Bar, ewIsUptrend ? ewWave1 : ewWave1,
             "1",
             style=ewIsUptrend ? label.style_label_down : label.style_label_up,
             color=labelColor, textcolor=color.white, size=size.small)

    if not na(ewWave2) and not na(ewWave2Bar)
        ewLabel3 := label.new(ewWave2Bar, ewIsUptrend ? ewWave2 : ewWave2,
             "2",
             style=ewIsUptrend ? label.style_label_up : label.style_label_down,
             color=labelColor, textcolor=color.white, size=size.small)

// í”¼ë³´ë‚˜ì¹˜ ë ˆë²¨ ê·¸ë¦¬ê¸°
if showElliottWave and showEWFib and not na(ewWave0) and not na(ewWave1)
    float wave1Range = math.abs(ewWave1 - ewWave0)
    float fib382 = ewIsUptrend ? ewWave1 - wave1Range * 0.382 : ewWave1 + wave1Range * 0.382
    float fib50 = ewIsUptrend ? ewWave1 - wave1Range * 0.5 : ewWave1 + wave1Range * 0.5
    float fib618 = ewIsUptrend ? ewWave1 - wave1Range * 0.618 : ewWave1 + wave1Range * 0.618

    ewFibLine1 := line.new(ewWave1Bar, fib382, bar_index, fib382, color=color.gray, style=line.style_dotted, width=1)
    ewFibLine2 := line.new(ewWave1Bar, fib50, bar_index, fib50, color=color.yellow, style=line.style_dotted, width=1)
    ewFibLine3 := line.new(ewWave1Bar, fib618, bar_index, fib618, color=color.green, style=line.style_dotted, width=2)

// ê³¨ë“ ì¡´ ë°•ìŠ¤ ê·¸ë¦¬ê¸°
if showElliottWave and showEWZones and not na(ewGoldenTop) and not na(ewGoldenBottom)
    ewGoldenBox := box.new(bar_index - 50, ewGoldenTop, bar_index + 10, ewGoldenBottom,
         bgcolor=ewGoldenZoneColor, border_color=color.green, border_width=1)

// ì—˜ë¦¬ì—‡ íŒŒë™ í…Œì´ë¸” (ë¯¸ë‹ˆ íŒ¨ë„ì— í†µí•©)
var table ewTable = table.new(position.top_right, 2, 4, bgcolor=color.new(color.black, 85), border_width=1)

if showElliottWave and barstate.islast
    table.cell(ewTable, 0, 0, "ğŸ“Š Elliott Wave", text_color=color.white, text_size=size.small)
    table.cell(ewTable, 1, 0, "", text_color=color.white, text_size=size.small)
    table.cell(ewTable, 0, 1, "íŒ¨í„´", text_color=color.gray, text_size=size.tiny)
    table.cell(ewTable, 1, 1, ewCurrentPattern, text_color=ewIsUptrend ? color.lime : color.red, text_size=size.tiny)
    table.cell(ewTable, 0, 2, "í˜„ì¬", text_color=color.gray, text_size=size.tiny)
    table.cell(ewTable, 1, 2, ewCurrentWave, text_color=color.yellow, text_size=size.tiny)
    table.cell(ewTable, 0, 3, "ì‹ í˜¸", text_color=color.gray, text_size=size.tiny)
    string ewSignal = ewWave3BuyZone ? "ğŸŸ¢ ë§¤ìˆ˜ ê³¨ë“ ì¡´" : ewWave3SellZone ? "ğŸ”´ ë§¤ë„ ê³¨ë“ ì¡´" : "âšª ëŒ€ê¸°"
    table.cell(ewTable, 1, 3, ewSignal, text_color=ewWave3BuyZone ? color.lime : ewWave3SellZone ? color.red : color.gray, text_size=size.tiny)

// ============================================
// ì—˜ë¦¬ì—‡ íŒŒë™ ì•Œë¦¼
// ============================================

// Wave 3 ë§¤ìˆ˜ ê¸°íšŒ ì•Œë¦¼
if showElliottWave and ewWave3BuyZone and ewCurrentPattern == "IMPULSE â†‘"
    string ew1 = "ğŸŒŠ ELLIOTT WAVE ë§¤ìˆ˜ ì‹ í˜¸! ğŸŒŠ"
    string ew2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string ew3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string ew4 = "ğŸ“ˆ íŒ¨í„´: " + ewCurrentPattern
    string ew5 = "ğŸ¯ Wave 2 ê³¨ë“ ì¡´ (61.8~78.6%)"
    string ew6 = "ğŸ’° Wave 3 ì§„ì… ê¸°íšŒ!"
    string ew7 = "ğŸ›¡ï¸ ì†ì ˆ: Wave 1 ì‹œì‘ì  ($" + str.tostring(ewWave0, "#.##") + ")"
    string ew8 = "ğŸ¯ ëª©í‘œ: 161.8~261.8% í™•ì¥"
    string ew9 = disclaimer
    alert(ew1 + "\n" + ew2 + "\n" + ew3 + "\n" + ew4 + "\n" + ew5 + "\n" + ew6 + "\n" + ew7 + "\n" + ew8 + "\n" + ew9, freq=alert.freq_once_per_bar_close)

// Wave 3 ë§¤ë„ ê¸°íšŒ ì•Œë¦¼ (ì„ ë¬¼)
if showElliottWave and ewWave3SellZone and ewCurrentPattern == "IMPULSE â†“" and isFutures
    string ew1 = "ğŸŒŠ ELLIOTT WAVE ë§¤ë„ ì‹ í˜¸! ğŸŒŠ"
    string ew2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string ew3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string ew4 = "ğŸ“‰ íŒ¨í„´: " + ewCurrentPattern
    string ew5 = "ğŸ¯ Wave 2 ê³¨ë“ ì¡´ (61.8~78.6%)"
    string ew6 = "ğŸ’° Wave 3 ìˆ ì§„ì… ê¸°íšŒ!"
    string ew7 = "ğŸ›¡ï¸ ì†ì ˆ: Wave 1 ì‹œì‘ì  ($" + str.tostring(ewWave0, "#.##") + ")"
    string ew8 = "ğŸ¯ ëª©í‘œ: 161.8~261.8% í™•ì¥"
    string ew9 = disclaimer
    alert(ew1 + "\n" + ew2 + "\n" + ew3 + "\n" + ew4 + "\n" + ew5 + "\n" + ew6 + "\n" + ew7 + "\n" + ew8 + "\n" + ew9, freq=alert.freq_once_per_bar_close)

// ì‚¼ê°í˜• ë¸Œë ˆì´í¬ì•„ì›ƒ ëŒ€ê¸° ì•Œë¦¼
if showElliottWave and ewCurrentPattern == "TRIANGLE"
    string ew1 = "ğŸ”º TRIANGLE íŒ¨í„´ ê°ì§€!"
    string ew2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string ew3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string ew4 = "ğŸ“Š ìˆ˜ë ´ ì‚¼ê°í˜• - ë¸Œë ˆì´í¬ì•„ì›ƒ ëŒ€ê¸°"
    string ew5 = "âš¡ ë³€ë™ì„± í™•ëŒ€ ì˜ˆìƒ"
    string ew6 = disclaimer
    alert(ew1 + "\n" + ew2 + "\n" + ew3 + "\n" + ew4 + "\n" + ew5 + "\n" + ew6, freq=alert.freq_once_per_bar_close)

// ============================================
// ì²­ì‚° ìŠ¤ìœ• ì•Œë¦¼ (ëŒ€ëŸ‰ ì²­ì‚° í›„ ë°˜ì „ = ì§„ì… ê¸°íšŒ)
// ============================================

// ë¡± ì²­ì‚° ìŠ¤ìœ• ì•Œë¦¼ (í•˜ë½ í›„ ë°˜ë“± = ë§¤ìˆ˜ ê¸°íšŒ)
if enableLiqLevels and longLiq100xSweep
    string liq1 = "ğŸ”¥ 100x ë¡± ì²­ì‚° ìŠ¤ìœ•! ğŸ”¥"
    string liq2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string liq3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string liq4 = "ğŸ’€ 100x ë¡± ì²­ì‚° ë ˆë²¨ ëŒíŒŒ í›„ ë°˜ë“±"
    string liq5 = "ğŸ“ˆ ëŒ€ëŸ‰ ì²­ì‚° ë°œìƒ â†’ ë§¤ìˆ˜ ë°˜ë“± ê¸°íšŒ?"
    string liq6 = "ğŸ¯ ì²­ì‚° ë ˆë²¨: $" + str.tostring(liqLong100x, "#.##")
    string liq7 = disclaimer
    alert(liq1 + "\n" + liq2 + "\n" + liq3 + "\n" + liq4 + "\n" + liq5 + "\n" + liq6 + "\n" + liq7, freq=alert.freq_once_per_bar_close)

if enableLiqLevels and longLiq50xSweep and not longLiq100xSweep
    string liq1 = "âš ï¸ 50x ë¡± ì²­ì‚° ìŠ¤ìœ•!"
    string liq2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string liq3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string liq4 = "ğŸ“‰ 50x ë¡± ì²­ì‚° ë ˆë²¨ ëŒíŒŒ í›„ ë°˜ë“±"
    string liq5 = "ğŸ¯ ì²­ì‚° ë ˆë²¨: $" + str.tostring(liqLong50x, "#.##")
    string liq6 = disclaimer
    alert(liq1 + "\n" + liq2 + "\n" + liq3 + "\n" + liq4 + "\n" + liq5 + "\n" + liq6, freq=alert.freq_once_per_bar_close)

// ìˆ ì²­ì‚° ìŠ¤ìœ• ì•Œë¦¼ (ìƒìŠ¹ í›„ í•˜ë½ = ë§¤ë„ ê¸°íšŒ)
if enableLiqLevels and shortLiq100xSweep and isFutures
    string liq1 = "ğŸ”¥ 100x ìˆ ì²­ì‚° ìŠ¤ìœ•! ğŸ”¥"
    string liq2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string liq3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string liq4 = "ğŸ’€ 100x ìˆ ì²­ì‚° ë ˆë²¨ ëŒíŒŒ í›„ í•˜ë½"
    string liq5 = "ğŸ“‰ ëŒ€ëŸ‰ ì²­ì‚° ë°œìƒ â†’ ë§¤ë„ í•˜ë½ ê¸°íšŒ?"
    string liq6 = "ğŸ¯ ì²­ì‚° ë ˆë²¨: $" + str.tostring(liqShort100x, "#.##")
    string liq7 = disclaimer
    alert(liq1 + "\n" + liq2 + "\n" + liq3 + "\n" + liq4 + "\n" + liq5 + "\n" + liq6 + "\n" + liq7, freq=alert.freq_once_per_bar_close)

if enableLiqLevels and shortLiq50xSweep and not shortLiq100xSweep and isFutures
    string liq1 = "âš ï¸ 50x ìˆ ì²­ì‚° ìŠ¤ìœ•!"
    string liq2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string liq3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string liq4 = "ğŸ“ˆ 50x ìˆ ì²­ì‚° ë ˆë²¨ ëŒíŒŒ í›„ í•˜ë½"
    string liq5 = "ğŸ¯ ì²­ì‚° ë ˆë²¨: $" + str.tostring(liqShort50x, "#.##")
    string liq6 = disclaimer
    alert(liq1 + "\n" + liq2 + "\n" + liq3 + "\n" + liq4 + "\n" + liq5 + "\n" + liq6, freq=alert.freq_once_per_bar_close)

// ì²­ì‚° êµ¬ê°„ ì ‘ê·¼ ì•Œë¦¼ (ë¹„í™œì„±í™” - ì •ë³´ì„± ì•Œë¦¼ì´ë¼ ë§¤ë§¤ì— ë¶ˆí•„ìš”)
// if enableLiqLevels and nearLongLiq100x
//     alert("âš ï¸ " + syminfo.basecurrency + " 100x ë¡± ì²­ì‚° êµ¬ê°„ ì ‘ê·¼! $" + str.tostring(close, "#.##") + " â†’ ì²­ì‚° ë ˆë²¨: $" + str.tostring(liqLong100x, "#.##"), freq=alert.freq_once_per_bar_close)

// if enableLiqLevels and nearShortLiq100x
//     alert("âš ï¸ " + syminfo.basecurrency + " 100x ìˆ ì²­ì‚° êµ¬ê°„ ì ‘ê·¼! $" + str.tostring(close, "#.##") + " â†’ ì²­ì‚° ë ˆë²¨: $" + str.tostring(liqShort100x, "#.##"), freq=alert.freq_once_per_bar_close)

// ============================================
// ì‹¤ì œ ì²­ì‚° ë§¤ë¬¼ëŒ€ ì•Œë¦¼ (ëŒ€í˜• í¬ì§€ì…˜ ì§‘ì¤‘ êµ¬ê°„)
// ============================================

// ë¡± ëŒ€ëŸ‰ ì²­ì‚° êµ¬ê°„ ì ‘ê·¼ ì•Œë¦¼ (ë¹„í™œì„±í™” - ì •ë³´ì„± ì•Œë¦¼ì´ë¼ ë§¤ë§¤ì— ë¶ˆí•„ìš”)
// if enableRealLiqLevels and nearRealLongLiq1
//     string rliq1 = "ğŸš¨ ë¡± ëŒ€ëŸ‰ ì²­ì‚° êµ¬ê°„ ì ‘ê·¼! ğŸš¨"
//     string rliq2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
//     string rliq3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
//     string rliq4 = "ğŸ’€ ëŒ€í˜• ë¡± í¬ì§€ì…˜ ì²­ì‚° ì§‘ì¤‘ êµ¬ê°„"
//     string rliq5 = "ğŸ¯ ì²­ì‚° ë ˆë²¨: $" + str.tostring(realLongLiq1, "#")
//     string rliq6 = "ğŸ“‰ í•˜ë½ ì‹œ ì—°ì‡„ ì²­ì‚° ê°€ëŠ¥!"
//     string rliq7 = disclaimer
//     alert(rliq1 + "\n" + rliq2 + "\n" + rliq3 + "\n" + rliq4 + "\n" + rliq5 + "\n" + rliq6 + "\n" + rliq7, freq=alert.freq_once_per_bar_close)

// ìˆ ëŒ€ëŸ‰ ì²­ì‚° êµ¬ê°„ ì ‘ê·¼ ì•Œë¦¼ (ë¹„í™œì„±í™” - ì •ë³´ì„± ì•Œë¦¼ì´ë¼ ë§¤ë§¤ì— ë¶ˆí•„ìš”)
// if enableRealLiqLevels and nearRealShortLiq1
//     string rsiq1 = "ğŸš¨ ìˆ ëŒ€ëŸ‰ ì²­ì‚° êµ¬ê°„ ì ‘ê·¼! ğŸš¨"
//     string rsiq2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
//     string rsiq3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
//     string rsiq4 = "ğŸ’€ ëŒ€í˜• ìˆ í¬ì§€ì…˜ ì²­ì‚° ì§‘ì¤‘ êµ¬ê°„"
//     string rsiq5 = "ğŸ¯ ì²­ì‚° ë ˆë²¨: $" + str.tostring(realShortLiq1, "#")
//     string rsiq6 = "ğŸ“ˆ ìƒìŠ¹ ì‹œ ìˆ ìŠ¤í€´ì¦ˆ ê°€ëŠ¥!"
//     string rsiq7 = disclaimer
//     alert(rsiq1 + "\n" + rsiq2 + "\n" + rsiq3 + "\n" + rsiq4 + "\n" + rsiq5 + "\n" + rsiq6 + "\n" + rsiq7, freq=alert.freq_once_per_bar_close)

// ì‹¤ì œ ì²­ì‚° ìŠ¤ìœ• ì•Œë¦¼ (ëŒ€ëŸ‰ ì²­ì‚° ë°œìƒ í›„ ë°˜ì „)
if enableRealLiqLevels and realLongLiqSweep1
    string rls1 = "ğŸ’€ğŸ’€ğŸ’€ ë¡± ëŒ€ëŸ‰ ì²­ì‚° ìŠ¤ìœ•! ğŸ’€ğŸ’€ğŸ’€"
    string rls2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string rls3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string rls4 = "ğŸ”¥ $" + str.tostring(realLongLiq1, "#") + " ë¡± ì²­ì‚° êµ¬ê°„ ëŒíŒŒ í›„ ë°˜ë“±!"
    string rls5 = "ğŸ“ˆ ëŒ€ëŸ‰ ë¡± ì²­ì‚° ë°œìƒ â†’ ë°˜ë“± ê¸°íšŒ?"
    string rls6 = "âš¡ ê°•í•œ ë§¤ìˆ˜ì„¸ ìœ ì… ê°€ëŠ¥"
    string rls7 = disclaimer
    alert(rls1 + "\n" + rls2 + "\n" + rls3 + "\n" + rls4 + "\n" + rls5 + "\n" + rls6 + "\n" + rls7, freq=alert.freq_once_per_bar_close)

if enableRealLiqLevels and realShortLiqSweep1
    string rss1 = "ğŸ’€ğŸ’€ğŸ’€ ìˆ ëŒ€ëŸ‰ ì²­ì‚° ìŠ¤ìœ•! ğŸ’€ğŸ’€ğŸ’€"
    string rss2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string rss3 = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    string rss4 = "ğŸ”¥ $" + str.tostring(realShortLiq1, "#") + " ìˆ ì²­ì‚° êµ¬ê°„ ëŒíŒŒ í›„ í•˜ë½!"
    string rss5 = "ğŸ“‰ ëŒ€ëŸ‰ ìˆ ì²­ì‚° ë°œìƒ â†’ í•˜ë½ ê¸°íšŒ?"
    string rss6 = "âš¡ ê°•í•œ ë§¤ë„ì„¸ ìœ ì… ê°€ëŠ¥"
    string rss7 = disclaimer
    alert(rss1 + "\n" + rss2 + "\n" + rss3 + "\n" + rss4 + "\n" + rss5 + "\n" + rss6 + "\n" + rss7, freq=alert.freq_once_per_bar_close)

// ============================================
// V40+ ë³€ê²½ì‚¬í•­ ìš”ì•½ (2026.01.21)
// ============================================
//
// 1. CVD ì •ë°€ë„ í–¥ìƒ
//    - CVD Reset ê¸°ëŠ¥ ì¶”ê°€ (ì¼ë´‰/ì„¸ì…˜/ì£¼ë´‰)
//    - CVD Normalization (ê³ ê°€ ìì‚° ëŒ€ì‘)
//    - ë” ì •í™•í•œ ë§¤ìˆ˜/ë§¤ë„ì•• ì¸¡ì •
//
// 2. BOS/CHoCH ì‹ ë¢°ì„± ê°•í™”
//    - ê±°ë˜ëŸ‰ í™•ì¸ í•„í„° (bosVolumeConfirm)
//    - ê°•í•œ ì¢…ê°€ í™•ì¸ (bosStrongClose)
//    - í—ˆìœ„ ëŒíŒŒ ê°ì†Œ
//
// 3. í•„í„° ì‹œìŠ¤í…œ ì¶”ê°€
//    - ì‹ í˜¸ ì¿¨ë‹¤ìš´ (ê³¼ë§¤ë§¤ ë°©ì§€)
//    - ë³¼ë¥¨ í•„í„° (ì €ê±°ë˜ëŸ‰ ì œì™¸)
//    - ì‹œê°„ í•„í„° (ë¹„íš¨ìœ¨ ì„¸ì…˜ ì œì™¸)
//
// 4. EMA ê°ë„ ê³„ì‚° ê°œì„ 
//    - Arctangent ë°©ì‹ ì ìš©
//    - Normalization (ê°€ê²© ë…ë¦½ì )
//    - ë” ì •í™•í•œ ì¶”ì„¸ ê°•ë„ ì¸¡ì •
//
// 5. ë™ì  íŒŒë¼ë¯¸í„° ì¡°ì •
//    - ATR ê¸°ë°˜ ì ì‘í˜• ì‹œìŠ¤í…œ
//    - ë³€ë™ì„±ì— ë”°ë¥¸ ì¿¨ë‹¤ìš´ ì¡°ì •
//    - ì‹œì¥ ìƒí™©ì— ë§ì¶˜ ìë™ ìµœì í™”
//
// V40 ì„¤ì • ìœ„ì¹˜:
// - Settings > V40 í•„í„°
// - Settings > V40 CVD ê°œì„ 
// - Settings > V40 BOS ê°œì„ 
// - Settings > V40 ë™ì  ì¡°ì •
// - Settings > V40+ ì²­ì‚°ë§¤ë¬¼ëŒ€ (NEW!)
//
// V1.2 (2026.01.21) ì²­ì‚° ë§¤ë¬¼ëŒ€ ì¶”ê°€:
// - ë ˆë²„ë¦¬ì§€ë³„ ì²­ì‚° ë ˆë²¨ í‘œì‹œ (10x/25x/50x/100x)
// - ë¡± ì²­ì‚° ë ˆë²¨ (ë¹¨ê°„ìƒ‰) / ìˆ ì²­ì‚° ë ˆë²¨ (ì´ˆë¡ìƒ‰)
// - ì²­ì‚° ìŠ¤ìœ• ê°ì§€ (ëŒ€ëŸ‰ ì²­ì‚° í›„ ë°˜ì „ = ê°•í•œ ì‹ í˜¸)
// - ì²­ì‚° ìŠ¤ìœ• ì‹œ STRONG â†’ SUPER ìŠ¹ê²©
// - ì²­ì‚° êµ¬ê°„ ì ‘ê·¼/ìŠ¤ìœ• ì•Œë¦¼
//
// V42 Complete (2026.01.27) í•˜ëª¨ë‹‰ + ì •í™•ì„± í•„í„°:
// - í•˜ëª¨ë‹‰ íŒ¨í„´ ê°ì§€ (Gartley, Bat, Crab, Butterfly, Cypher, 707, Shark, AB=CD)
// - PRZ + TP/SL ìë™ ê³„ì‚°
// - RSI BAMM ì‹ í˜¸
// - ì •í™•ì„± í•„í„° (í’ˆì§ˆ, ì¶”ì„¸, ê±°ë˜ëŸ‰, RSI, ì»¨í”Œë£¨ì–¸ìŠ¤)
// - 30ì  ì ìˆ˜ ì‹œìŠ¤í…œì— í•˜ëª¨ë‹‰ ì ìˆ˜ ë°˜ì˜
// ============================================

// ============================================
// â˜…â˜…â˜… V42 í†µí•© ì•ŒëŒ ì¡°ê±´ â˜…â˜…â˜…
// ============================================

// --- ìµœê³  ì •í™•ë„ ì•ŒëŒ (ê¶Œì¥) ---
alertcondition(filteredHarmonicBullSignal or (strongLong and highConfidenceLong) or rsiBAMMBuy, title="[V42] â˜… LONG (í•„í„°)", message=">>> LONG <<< {{ticker}} {{interval}} - ê³ ì •í™• ë§¤ìˆ˜ ì‹ í˜¸!")
alertcondition(filteredHarmonicBearSignal or (showShortSignals and shortDeltaScore >= 3) or rsiBAMMSell, title="[V42] â˜… SHORT (í•„í„°)", message=">>> SHORT <<< {{ticker}} {{interval}} - ê³ ì •í™• ë§¤ë„ ì‹ í˜¸!")

// --- í•˜ëª¨ë‹‰ íŒ¨í„´ ì•ŒëŒ ---
alertcondition(filteredHarmonicSignal, title="[V42] í•˜ëª¨ë‹‰ (í•„í„°)", message="í•˜ëª¨ë‹‰ íŒ¨í„´! {{ticker}} {{interval}} - í’ˆì§ˆ/ì»¨í”Œë£¨ì–¸ìŠ¤ í™•ì¸")
alertcondition(filteredHarmonicBullSignal, title="[V42] Bullish í•˜ëª¨ë‹‰", message="Bullish í•˜ëª¨ë‹‰! {{ticker}} - PRZ í™•ì¸, ë§¤ìˆ˜ ê²€í† ")
alertcondition(filteredHarmonicBearSignal, title="[V42] Bearish í•˜ëª¨ë‹‰", message="Bearish í•˜ëª¨ë‹‰! {{ticker}} - PRZ í™•ì¸, ë§¤ë„ ê²€í† ")
alertcondition(detectedHarmonicPattern != "", title="[V42] í•˜ëª¨ë‹‰ (ì›ë³¸)", message="í•˜ëª¨ë‹‰ íŒ¨í„´ ê°ì§€! {{ticker}} {{interval}}")

// --- RSI BAMM ì•ŒëŒ ---
alertcondition(rsiBAMMBuy, title="[V42] BAMM ë§¤ìˆ˜", message="RSI BAMM ë§¤ìˆ˜! {{ticker}} - ë‹¤ì´ë²„ì „ìŠ¤ + RSI 50 ëŒíŒŒ")
alertcondition(rsiBAMMSell, title="[V42] BAMM ë§¤ë„", message="RSI BAMM ë§¤ë„! {{ticker}} - ë‹¤ì´ë²„ì „ìŠ¤ + RSI 50 í•˜í–¥ëŒíŒŒ")

// --- ICT/SMC ì•ŒëŒ ---
alertcondition(strongLong, title="[V42] ICT LONG", message="ICT LONG ì‹ í˜¸! {{ticker}} {{interval}} - S/A ë“±ê¸‰")
alertcondition(superLong, title="[V42] SUPER LONG", message="SUPER LONG! {{ticker}} {{interval}} - ëª¨ë“  ì¡°ê±´ ì¼ì¹˜")
alertcondition(highConfidenceLong, title="[V42] ê³ í™•ì‹  LONG", message="ê³ í™•ì‹  LONG! {{ticker}} - ë†’ì€ ìŠ¹ë¥  ì¡°ê±´ ì¶©ì¡±")

// --- ê³ ë˜ ì•ŒëŒ ---
alertcondition(whaleBuy, title="[V42] ê³ ë˜ ë§¤ìˆ˜", message="ê³ ë˜ ë§¤ìˆ˜! {{ticker}} {{interval}} - ëŒ€ëŸ‰ ë§¤ìˆ˜ì„¸ ê°ì§€")
alertcondition(whaleSell, title="[V42] ê³ ë˜ ë§¤ë„", message="ê³ ë˜ ë§¤ë„! {{ticker}} {{interval}} - ëŒ€ëŸ‰ ë§¤ë„ì„¸ ê°ì§€")

// --- í†µí•© ì•ŒëŒ ---
alertcondition(filteredHarmonicBullSignal or strongLong or rsiBAMMBuy or whaleBuy, title="[V42] ëª¨ë“  ë¡±", message="ë¡± ì‹ í˜¸! {{ticker}} {{interval}}")
alertcondition(filteredHarmonicBearSignal or (showShortSignals and shortDeltaScore >= 3) or rsiBAMMSell or whaleSell, title="[V42] ëª¨ë“  ìˆ", message="ìˆ ì‹ í˜¸! {{ticker}} {{interval}}")


