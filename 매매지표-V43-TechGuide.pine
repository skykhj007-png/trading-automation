//@version=5
indicator("V43 TechGuide - PSAR + Stochì‚¼í˜•ì œ + íˆë“ ë‹¤ì´ë²„ì „ìŠ¤ + íŒ¨í„´ (2026.01.29)", overlay=true, max_labels_count=500, max_lines_count=500, max_boxes_count=300)

// ============================================
// V43 TechGuide - coin_guide.txt ê¸°ë°˜ ì—…ê·¸ë ˆì´ë“œ
//
// â˜…â˜…â˜… V42 ëª¨ë“  ê¸°ëŠ¥ í¬í•¨ â˜…â˜…â˜…
//
// â˜…â˜…â˜… V43 ì‹ ê·œ ê¸°ëŠ¥ (coin_guide ê¸°ë°˜) â˜…â˜…â˜…
// 1. Parabolic SAR (ì¶”ì„¸ ì¶”ì¢… ì§€í‘œ)
// 2. Stochastic ì‚¼í˜•ì œ (5,3,3 / 10,6,6 / 20,12,12)
// 3. íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ (ì¶”ì„¸ ì§€ì† ê°ì§€)
// 4. ì°¨íŠ¸ íŒ¨í„´ ê°ì§€ (ì‚¼ê°ìˆ˜ë ´, ì›»ì§€)
// 5. ì ìˆ˜ ì‹œìŠ¤í…œ í†µí•© (35ì ìœ¼ë¡œ í™•ì¥)
// ============================================

// ============================================
// ê¸°ë³¸ ì„¤ì •
// ============================================

tradeMode = input.string("í˜„ë¬¼", title="ê±°ë˜ ëª¨ë“œ", options=["ì„ ë¬¼", "í˜„ë¬¼", "ì£¼ì‹"], group="ê¸°ë³¸ ì„¤ì •", tooltip="í˜„ë¬¼/ì£¼ì‹: SHORT ì‹œê·¸ë„ ìˆ¨ê¹€")
displayMode = input.string("ìµœì†Œí™”", title="í™”ë©´ ëª¨ë“œ", options=["ì „ì²´", "ìµœì†Œí™”", "í…Œì´ë¸”ë§Œ"], group="ê¸°ë³¸ ì„¤ì •", tooltip="ìµœì†Œí™”: Smart Trail + ì‹œê·¸ë„ë§Œ í‘œì‹œ")
signalMode = input.string("STRONG ì´ìƒ", title="ì‹œê·¸ë„ í‘œì‹œ", options=["ì „ì²´", "STRONG ì´ìƒ", "SUPERë§Œ"], group="ê¸°ë³¸ ì„¤ì •", tooltip="ì‹œê·¸ë„ í•„í„°ë§ ìˆ˜ì¤€")

bool isFutures = tradeMode == "ì„ ë¬¼"
bool showShortSignals = isFutures
bool isMinimalMode = displayMode == "ìµœì†Œí™”"
bool isTableOnlyMode = displayMode == "í…Œì´ë¸”ë§Œ"
bool showVisuals = not isTableOnlyMode

// ============================================
// í‘œì‹œ ì„¤ì •
// ============================================

showSR = input.bool(true, title="ì§€ì§€/ì €í•­ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showHTFTrend = input.bool(true, title="HTF ì¶”ì„¸ í‘œì‹œ", group="í‘œì‹œ ì„¤ì •")
showEMA = input.bool(false, title="EMA í‘œì‹œ", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode and showVisuals
showInfoTable = input.bool(true, title="ì •ë³´ í…Œì´ë¸”", group="í‘œì‹œ ì„¤ì •") and not isMinimalMode
showMiniPanel = input.bool(true, title="ë¯¸ë‹ˆ íŒ¨ë„ (ìµœì†Œí™” ëª¨ë“œ)", group="í‘œì‹œ ì„¤ì •")

volThreshold = input.float(1.5, title="ê±°ë˜ëŸ‰ ê¸‰ì¦ ë°°ìˆ˜", minval=1.0, maxval=5.0, step=0.1, group="ê±°ë˜ëŸ‰ ì„¤ì •")
volHighThreshold = input.float(2.5, title="ê±°ë˜ëŸ‰ í­ì¦ ë°°ìˆ˜", minval=1.5, maxval=10.0, step=0.5, group="ê±°ë˜ëŸ‰ ì„¤ì •")

// í”¼ë´‡ ì„¤ì •
pivotLeft = input.int(5, title="í”¼ë´‡ ì¢Œì¸¡ ë°”", minval=2, maxval=20, group="í”¼ë´‡ ì„¤ì •")
pivotRight = input.int(2, title="í”¼ë´‡ ìš°ì¸¡ ë°”", minval=1, maxval=10, group="í”¼ë´‡ ì„¤ì •")

// ============================================
// â˜…â˜…â˜… V43 ì‹ ê·œ: Parabolic SAR ì„¤ì • â˜…â˜…â˜…
// coin_guide 45-48p: ì¶”ì„¸ ì¶”ì¢… ì§€í‘œ
// ============================================

showPSAR = input.bool(true, title="Parabolic SAR í‘œì‹œ", group="V43 Parabolic SAR", tooltip="coin_guide: ì¶”ì„¸ ì¶”ì¢… ì§€í‘œ, ìº”ë“¤ ìœ„ì¹˜ì™€ SAR ê±°ë¦¬ê°€ ê°€ê¹Œìš¸ìˆ˜ë¡ ì¶”ì„¸ ì „í™˜ ì‹ í˜¸")
psarStart = input.float(0.02, title="SAR ì‹œì‘ê°’", minval=0.01, maxval=0.1, step=0.01, group="V43 Parabolic SAR")
psarIncrement = input.float(0.02, title="SAR ì¦ê°€ê°’", minval=0.01, maxval=0.1, step=0.01, group="V43 Parabolic SAR")
psarMax = input.float(0.2, title="SAR ìµœëŒ€ê°’", minval=0.1, maxval=0.5, step=0.05, group="V43 Parabolic SAR")
psarConfirmBars = input.int(3, title="SAR í™•ì¸ ë´‰ìˆ˜", minval=1, maxval=10, group="V43 Parabolic SAR", tooltip="SAR ì „í™˜ í›„ Në´‰ ì—°ì† ìœ ì§€ ì‹œ í™•ì¸")

// ============================================
// â˜…â˜…â˜… V43 ì‹ ê·œ: Stochastic ì‚¼í˜•ì œ ì„¤ì • â˜…â˜…â˜…
// coin_guide 49-53p: ë‹¨ê¸°/ì¤‘ê¸°/ì¥ê¸° ëª¨ë©˜í…€ ë¶„ì„
// ============================================

showStoch3 = input.bool(true, title="Stochastic ì‚¼í˜•ì œ ë¶„ì„", group="V43 Stochastic ì‚¼í˜•ì œ", tooltip="coin_guide: ë§‰ë‚´(5,3,3) ë‘˜ì§¸(10,6,6) í°í˜•(20,12,12)")
stoch1K = input.int(5, title="ë§‰ë‚´ %K ê¸°ê°„", group="V43 Stochastic ì‚¼í˜•ì œ")
stoch1Smooth = input.int(3, title="ë§‰ë‚´ Smooth", group="V43 Stochastic ì‚¼í˜•ì œ")
stoch2K = input.int(10, title="ë‘˜ì§¸ %K ê¸°ê°„", group="V43 Stochastic ì‚¼í˜•ì œ")
stoch2Smooth = input.int(6, title="ë‘˜ì§¸ Smooth", group="V43 Stochastic ì‚¼í˜•ì œ")
stoch3K = input.int(20, title="í°í˜• %K ê¸°ê°„", group="V43 Stochastic ì‚¼í˜•ì œ")
stoch3Smooth = input.int(12, title="í°í˜• Smooth", group="V43 Stochastic ì‚¼í˜•ì œ")

// ============================================
// â˜…â˜…â˜… V43 ì‹ ê·œ: íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ ì„¤ì • â˜…â˜…â˜…
// coin_guide 30p: ì¶”ì„¸ ì§€ì† ê°ì§€
// ============================================

showHiddenDiv = input.bool(true, title="íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ ê°ì§€", group="V43 íˆë“  ë‹¤ì´ë²„ì „ìŠ¤", tooltip="coin_guide: íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ëŠ” ê¸°ì¡´ ì¶”ì„¸ ì§€ì†ì„ ì˜ë¯¸")
hiddenDivLookback = input.int(20, title="íƒìƒ‰ ë²”ìœ„", minval=10, maxval=50, group="V43 íˆë“  ë‹¤ì´ë²„ì „ìŠ¤")

// ============================================
// â˜…â˜…â˜… V43 ì‹ ê·œ: ì°¨íŠ¸ íŒ¨í„´ ì„¤ì • â˜…â˜…â˜…
// coin_guide 21-23p: ì‚¼ê°ìˆ˜ë ´, ì›»ì§€, í”Œë˜ê·¸
// ============================================

showPatterns = input.bool(true, title="ì°¨íŠ¸ íŒ¨í„´ ê°ì§€", group="V43 ì°¨íŠ¸ íŒ¨í„´", tooltip="ì‚¼ê°ìˆ˜ë ´, ì›»ì§€, í”Œë˜ê·¸ íŒ¨í„´ ê°ì§€")
patternLookback = input.int(50, title="íŒ¨í„´ íƒìƒ‰ ë²”ìœ„", minval=20, maxval=100, group="V43 ì°¨íŠ¸ íŒ¨í„´")
patternMinBars = input.int(10, title="ìµœì†Œ íŒ¨í„´ ê¸¸ì´", minval=5, maxval=30, group="V43 ì°¨íŠ¸ íŒ¨í„´")

// ============================================
// V40 í•„í„° ì„¤ì •
// ============================================

enableCooldown = input.bool(true, title="ì‹ í˜¸ ì¿¨ë‹¤ìš´ í™œì„±í™”", group="V40 í•„í„°")
cooldownBars = input.int(8, title="ì¿¨ë‹¤ìš´ ë°” ìˆ˜", minval=1, maxval=20, group="V40 í•„í„°")
enableVolumeFilter = input.bool(true, title="ë³¼ë¥¨ í•„í„° í™œì„±í™”", group="V40 í•„í„°")
volumeAvgLength = input.int(20, title="ë³¼ë¥¨ í‰ê·  ê¸°ê°„", minval=5, maxval=100, group="V40 í•„í„°")
minVolumeRatio = input.float(1.5, title="ìµœì†Œ ë³¼ë¥¨ ë°°ìˆ˜", minval=0.5, maxval=3.0, step=0.1, group="V40 í•„í„°")

// SMC ì„¤ì •
showSMC = input.bool(true, title="SMC ê¸°ëŠ¥ í™œì„±í™”", group="SMC ì„¤ì •") and showVisuals
showSmartTrail = input.bool(true, title="Smart Trail í‘œì‹œ", group="SMC ì„¤ì •")
swingLength = input.int(10, title="Swing íƒìƒ‰ ê¸¸ì´", minval=3, maxval=50, group="SMC ì„¤ì •")
emaAngleLength = input.int(14, title="EMA ê°ë„ ê¸¸ì´", minval=5, maxval=50, group="SMC ì„¤ì •")
emaAngleThreshold = input.float(1.0, title="EMA ê°ë„ ì„ê³„ê°’", minval=0.1, maxval=5.0, step=0.1, group="SMC ì„¤ì •")

// ê³ ë˜ ê°ì§€ ì„¤ì •
showWhale = input.bool(true, title="ê³ ë˜ ë§¤ìˆ˜/ë§¤ë„ í‘œì‹œ", group="SMC ì„¤ì •")
whaleVolMultiplier = input.float(3.0, title="ê³ ë˜ ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=2.0, maxval=10.0, step=0.5, group="SMC ì„¤ì •")
whalePriceMove = input.float(0.5, title="ê³ ë˜ ê°€ê²© ë³€ë™ (%)", minval=0.1, maxval=2.0, step=0.1, group="SMC ì„¤ì •")

// ì¼ëª©ê· í˜•í‘œ ì„¤ì •
showIchimoku = input.bool(true, title="ì¼ëª© êµ¬ë¦„ í‘œì‹œ", group="ì¼ëª©ê· í˜•í‘œ")
ichimokuFilter = input.bool(true, title="ì¼ëª© êµ¬ë¦„ í•„í„° í™œì„±í™”", group="ì¼ëª©ê· í˜•í‘œ")
tenkanPeriod = input.int(20, title="ì „í™˜ì„  ê¸°ê°„", group="ì¼ëª©ê· í˜•í‘œ")
kijunPeriod = input.int(60, title="ê¸°ì¤€ì„  ê¸°ê°„", group="ì¼ëª©ê· í˜•í‘œ")
senkouBPeriod = input.int(120, title="ì„ í–‰ìŠ¤íŒ¬B ê¸°ê°„", group="ì¼ëª©ê· í˜•í‘œ")
displacement = input.int(30, title="êµ¬ë¦„ ì´ë™", group="ì¼ëª©ê· í˜•í‘œ")

// ATR ì„¤ì •
atrPeriod = input.int(14, title="ATR ê¸°ê°„", minval=5, maxval=50, group="ë™ì  ì¡°ì •")

// ============================================
// í˜„ì¬ TF ê¸°ë³¸ ì§€í‘œ
// ============================================

// í”¼ë³´ë‚˜ì¹˜ ê¸°ë°˜ EMA
ema8 = ta.ema(close, 8)
ema21 = ta.ema(close, 21)
ema55 = ta.ema(close, 55)
ema200 = ta.ema(close, 200)

bool emaAlignedUp = ema8 > ema21 and ema21 > ema55
bool emaAlignedDown = ema8 < ema21 and ema21 < ema55
bool aboveEMA200 = close > ema200
bool belowEMA200 = close < ema200

// EMA ê°ë„ ë¶„ì„
emaAngle14 = ta.ema(close, emaAngleLength)
emaAnglePrev = emaAngle14[emaAngleLength]
float emaDelta = emaAngle14 - emaAnglePrev
float priceRange = ta.highest(high, 50) - ta.lowest(low, 50)
float normalizedDelta = priceRange > 0 ? emaDelta / priceRange : 0
float emaAngleNormalized = math.atan(normalizedDelta * 100) * 180 / math.pi
float emaAngleValue = ta.sma(emaAngleNormalized, 3)

color emaAngleColor = emaAngleValue > emaAngleThreshold ? color.lime :
                      emaAngleValue > 0 ? color.yellow :
                      emaAngleValue > -emaAngleThreshold ? color.orange :
                      color.red

bool emaStrongUp = emaAngleValue > emaAngleThreshold
bool emaWeakUp = emaAngleValue > 0 and emaAngleValue <= emaAngleThreshold
bool emaSideways = emaAngleValue <= 0 and emaAngleValue >= -emaAngleThreshold
bool emaStrongDown = emaAngleValue < -emaAngleThreshold

// ============================================
// â˜…â˜…â˜… V43: Parabolic SAR ê³„ì‚° â˜…â˜…â˜…
// coin_guide: "ì¶”ì„¸ ì¶”ì¢… ì§€í‘œ, í›„í–‰ì„± ìˆìœ¼ë‚˜ ì¶”ì„¸ íŒŒì•…ì— ìœ ìš©"
// ============================================

float psarValue = ta.sar(psarStart, psarIncrement, psarMax)

// PSAR ìƒíƒœ
bool psarBullish = close > psarValue  // ê°€ê²©ì´ SAR ìœ„ = ìƒìŠ¹ ì¶”ì„¸
bool psarBearish = close < psarValue  // ê°€ê²©ì´ SAR ì•„ë˜ = í•˜ë½ ì¶”ì„¸

// PSAR ì „í™˜ ê°ì§€
bool psarFlipToLong = psarBullish and not psarBullish[1]   // SAR ì•„ë˜ â†’ ìœ„ = ë§¤ìˆ˜ ì‹ í˜¸
bool psarFlipToShort = psarBearish and not psarBearish[1]  // SAR ìœ„ â†’ ì•„ë˜ = ë§¤ë„ ì‹ í˜¸

// PSARê³¼ ê°€ê²© ê±°ë¦¬ (ì¶”ì„¸ ì „í™˜ ì„ë°• ê°ì§€)
float psarDistance = math.abs(close - psarValue) / close * 100
float psarDistanceAvg = ta.sma(psarDistance, 14)
bool psarNearFlip = psarDistance < psarDistanceAvg * 0.5  // í‰ê· ì˜ 50% ì´í•˜ë©´ ì „í™˜ ì„ë°•

// PSAR í™•ì¸ (Në´‰ ì—°ì† ìœ ì§€)
var int psarConfirmCount = 0
if psarBullish
    psarConfirmCount := psarConfirmCount[1] >= 0 ? psarConfirmCount[1] + 1 : 1
else
    psarConfirmCount := psarConfirmCount[1] <= 0 ? psarConfirmCount[1] - 1 : -1

bool psarConfirmedLong = psarBullish and psarConfirmCount >= psarConfirmBars
bool psarConfirmedShort = psarBearish and psarConfirmCount <= -psarConfirmBars

// PSAR ì¶”ì„¸ ê°•ë„ (coin_guide: "ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ SARì´ ê°€íŒŒë¥´ê²Œ ì›€ì§ì„")
float psarSlope = psarValue - psarValue[3]
bool psarAccelerating = psarBullish and psarSlope > psarSlope[3]  // SAR ìƒìŠ¹ ê°€ì†

// ============================================
// â˜…â˜…â˜… V43: Stochastic ì‚¼í˜•ì œ ê³„ì‚° â˜…â˜…â˜…
// coin_guide: "ë§‰ë‚´(ë‹¨ê¸°), ë‘˜ì§¸(ì¤‘ê¸°), í°í˜•(ì¥ê¸°)"
// ============================================

// ë§‰ë‚´ (ë‹¨ê¸°) - ê°€ì¥ ë¯¼ê°
float stoch1RawK = ta.stoch(close, high, low, stoch1K)
float stoch1K_val = ta.sma(stoch1RawK, stoch1Smooth)
float stoch1D_val = ta.sma(stoch1K_val, stoch1Smooth)

// ë‘˜ì§¸ (ì¤‘ê¸°) - ì¤‘ê°„ ë¯¼ê°ë„
float stoch2RawK = ta.stoch(close, high, low, stoch2K)
float stoch2K_val = ta.sma(stoch2RawK, stoch2Smooth)
float stoch2D_val = ta.sma(stoch2K_val, stoch2Smooth)

// í°í˜• (ì¥ê¸°) - ê°€ì¥ ì•ˆì •ì 
float stoch3RawK = ta.stoch(close, high, low, stoch3K)
float stoch3K_val = ta.sma(stoch3RawK, stoch3Smooth)
float stoch3D_val = ta.sma(stoch3K_val, stoch3Smooth)

// ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„
bool stoch1Oversold = stoch1K_val < 20
bool stoch1Overbought = stoch1K_val > 80
bool stoch2Oversold = stoch2K_val < 20
bool stoch2Overbought = stoch2K_val > 80
bool stoch3Oversold = stoch3K_val < 20
bool stoch3Overbought = stoch3K_val > 80

// ê³¨ë“ /ë°ë“œ í¬ë¡œìŠ¤
bool stoch1GoldenCross = ta.crossover(stoch1K_val, stoch1D_val) and stoch1K_val < 40
bool stoch1DeadCross = ta.crossunder(stoch1K_val, stoch1D_val) and stoch1K_val > 60
bool stoch2GoldenCross = ta.crossover(stoch2K_val, stoch2D_val) and stoch2K_val < 40
bool stoch2DeadCross = ta.crossunder(stoch2K_val, stoch2D_val) and stoch2K_val > 60
bool stoch3GoldenCross = ta.crossover(stoch3K_val, stoch3D_val) and stoch3K_val < 40
bool stoch3DeadCross = ta.crossunder(stoch3K_val, stoch3D_val) and stoch3K_val > 60

// ì‚¼í˜•ì œ ë™ì‹œ ìƒìŠ¹/í•˜ë½ (coin_guide: "ì„¸ ì§€í‘œê°€ ì°¨ë¡€ë¡œ ê³ ê°œë¥¼ ë“¤ë©´ ìƒìŠ¹ ì „í™˜")
bool stoch3Rising = stoch1K_val > stoch1K_val[1] and stoch2K_val > stoch2K_val[1] and stoch3K_val > stoch3K_val[1]
bool stoch3Falling = stoch1K_val < stoch1K_val[1] and stoch2K_val < stoch2K_val[1] and stoch3K_val < stoch3K_val[1]

// ì‚¼í˜•ì œ ë™ì‹œ ê³¼ë§¤ë„/ê³¼ë§¤ìˆ˜ (ê°•ë ¥ ì‹ í˜¸)
bool stoch3AllOversold = stoch1Oversold and stoch2Oversold and stoch3Oversold
bool stoch3AllOverbought = stoch1Overbought and stoch2Overbought and stoch3Overbought

// ì‚¼í˜•ì œ ìˆœì°¨ ìƒìŠ¹ (ë§‰ë‚´â†’ë‘˜ì§¸â†’í°í˜•) - coin_guide: "ì§„ì§œ ì‹ í˜¸ë©´ ìˆœì°¨ ë°œìƒ"
bool stoch3SequentialRise = stoch1K_val > stoch1D_val and stoch2K_val > stoch2D_val and stoch3K_val > stoch3D_val
bool stoch3SequentialFall = stoch1K_val < stoch1D_val and stoch2K_val < stoch2D_val and stoch3K_val < stoch3D_val

// Stochastic ì¢…í•© ì ìˆ˜ (0-6)
var int stochScore = 0
stochScore := 0
stochScore := stochScore + (stoch1K_val > stoch1D_val ? 1 : 0)
stochScore := stochScore + (stoch2K_val > stoch2D_val ? 1 : 0)
stochScore := stochScore + (stoch3K_val > stoch3D_val ? 1 : 0)
stochScore := stochScore + (stoch3Rising ? 1 : 0)
stochScore := stochScore + (stoch3AllOversold ? 2 : stoch3SequentialRise and (stoch1Oversold or stoch2Oversold) ? 1 : 0)

// ============================================
// RSI ë° ê¸°ì¡´ ì§€í‘œ
// ============================================

float rsi = ta.rsi(close, 14)
float stochRsi = ta.stoch(rsi, rsi, rsi, 14)
float stochK = ta.sma(stochRsi, 3)
float stochD = ta.sma(stochK, 3)
bool rsiOversold = rsi < 30
bool rsiOverbought = rsi > 70
bool stochOversold = stochK < 20
bool stochOverbought = stochK > 80
bool stochBullish = stochK > stochD

[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
bool macdBullish = macdLine > signalLine
bool macdBearish = macdLine < signalLine

[diPlus, diMinus, adxValue] = ta.dmi(14, 14)
bool trendStrong = adxValue >= 20
bool bullishDI = diPlus > diMinus

// ë³¼ë¦°ì €ë°´ë“œ
int bbLength = 20
float bbMult = 2.0
float bbBasis = ta.sma(close, bbLength)
float bbDev = ta.stdev(close, bbLength) * bbMult
float bbUpper = bbBasis + bbDev
float bbLower = bbBasis - bbDev
bool touchBBLower = low <= bbLower
bool touchBBUpper = high >= bbUpper

// ê±°ë˜ëŸ‰
float avgVol = ta.sma(volume, 20)
float volRatio = volume / avgVol
bool volSpike = volRatio >= volThreshold
bool volumeExplosion = volRatio >= volHighThreshold

float bullVol = close > open ? volume : volume * (close - low) / math.max(high - low, 0.0001)
float bearVol = close < open ? volume : volume * (high - close) / math.max(high - low, 0.0001)
float buyPressure = bullVol / (bullVol + bearVol) * 100
bool strongBuyPressure = buyPressure > 55
bool strongSellPressure = buyPressure < 45

// ê³ ë˜ ê°ì§€
float priceChangePercent = math.abs(close - open) / open * 100
bool isWhaleVolume = volRatio >= whaleVolMultiplier
bool isWhalePriceMove = priceChangePercent >= whalePriceMove
bool isBullishCandle = close > open
bool isBearishCandle = close < open
bool whaleBuy = isWhaleVolume and isWhalePriceMove and isBullishCandle and buyPressure > 55
bool whaleSell = isWhaleVolume and isWhalePriceMove and isBearishCandle and buyPressure < 45

// ============================================
// â˜…â˜…â˜… V43: íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ ê³„ì‚° â˜…â˜…â˜…
// coin_guide 30p: "íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ëŠ” ê¸°ì¡´ ì¶”ì„¸ ì§€ì† ì˜ë¯¸"
// ============================================

// í”¼ë´‡ ê°ì§€
float pivotHigh = ta.pivothigh(high, pivotLeft, pivotRight)
float pivotLow = ta.pivotlow(low, pivotLeft, pivotRight)
float rsiPivotLow = ta.pivotlow(rsi, pivotLeft, pivotRight)
float rsiPivotHigh = ta.pivothigh(rsi, pivotLeft, pivotRight)
float pricePivotLow = ta.pivotlow(low, pivotLeft, pivotRight)
float pricePivotHigh = ta.pivothigh(high, pivotLeft, pivotRight)

// ì¼ë°˜ ë‹¤ì´ë²„ì „ìŠ¤
var float prevRsiLow = na
var float prevPriceLow = na
var float prevRsiHigh = na
var float prevPriceHigh = na

bool bullishDivergence = false
if not na(rsiPivotLow) and not na(pricePivotLow)
    if not na(prevRsiLow) and not na(prevPriceLow)
        if pricePivotLow < prevPriceLow and rsiPivotLow > prevRsiLow
            bullishDivergence := true
    prevRsiLow := rsiPivotLow
    prevPriceLow := pricePivotLow

bool bearishDivergence = false
if not na(rsiPivotHigh) and not na(pricePivotHigh)
    if not na(prevRsiHigh) and not na(prevPriceHigh)
        if pricePivotHigh > prevPriceHigh and rsiPivotHigh < prevRsiHigh
            bearishDivergence := true
    prevRsiHigh := rsiPivotHigh
    prevPriceHigh := pricePivotHigh

// íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ (coin_guide: "ê¸°ì¡´ ì¶”ì„¸ ì§€ì†")
// íˆë“  ìƒìŠ¹ ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²© ì €ì  ìƒìŠ¹ + RSI ì €ì  í•˜ë½ = ìƒìŠ¹ ì¶”ì„¸ ì§€ì†
// íˆë“  í•˜ë½ ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²© ê³ ì  í•˜ë½ + RSI ê³ ì  ìƒìŠ¹ = í•˜ë½ ì¶”ì„¸ ì§€ì†
var float prevHiddenRsiLow = na
var float prevHiddenPriceLow = na
var float prevHiddenRsiHigh = na
var float prevHiddenPriceHigh = na

bool hiddenBullishDiv = false
bool hiddenBearishDiv = false

if showHiddenDiv and not na(rsiPivotLow) and not na(pricePivotLow)
    if not na(prevHiddenRsiLow) and not na(prevHiddenPriceLow)
        // íˆë“  ìƒìŠ¹: ê°€ê²© ì €ì  ë†’ì•„ì§€ëŠ”ë° RSI ì €ì  ë‚®ì•„ì§ = ìƒìŠ¹ ì§€ì†
        if pricePivotLow > prevHiddenPriceLow and rsiPivotLow < prevHiddenRsiLow
            hiddenBullishDiv := true
    prevHiddenRsiLow := rsiPivotLow
    prevHiddenPriceLow := pricePivotLow

if showHiddenDiv and not na(rsiPivotHigh) and not na(pricePivotHigh)
    if not na(prevHiddenRsiHigh) and not na(prevHiddenPriceHigh)
        // íˆë“  í•˜ë½: ê°€ê²© ê³ ì  ë‚®ì•„ì§€ëŠ”ë° RSI ê³ ì  ë†’ì•„ì§ = í•˜ë½ ì§€ì†
        if pricePivotHigh < prevHiddenPriceHigh and rsiPivotHigh > prevHiddenRsiHigh
            hiddenBearishDiv := true
    prevHiddenRsiHigh := rsiPivotHigh
    prevHiddenPriceHigh := pricePivotHigh

// ============================================
// â˜…â˜…â˜… V43: ì°¨íŠ¸ íŒ¨í„´ ê°ì§€ â˜…â˜…â˜…
// coin_guide 21-23p: ì‚¼ê°ìˆ˜ë ´, ì›»ì§€
// ============================================

// ìŠ¤ìœ™ ê³ ì /ì €ì  ë°°ì—´
var float[] swingHighs = array.new_float(0)
var float[] swingLows = array.new_float(0)
var int[] swingHighBars = array.new_int(0)
var int[] swingLowBars = array.new_int(0)

// ìŠ¤ìœ™ í¬ì¸íŠ¸ ìˆ˜ì§‘
float swingH = ta.pivothigh(high, 5, 5)
float swingL = ta.pivotlow(low, 5, 5)

if not na(swingH)
    array.unshift(swingHighs, swingH)
    array.unshift(swingHighBars, bar_index - 5)
    if array.size(swingHighs) > 10
        array.pop(swingHighs)
        array.pop(swingHighBars)

if not na(swingL)
    array.unshift(swingLows, swingL)
    array.unshift(swingLowBars, bar_index - 5)
    if array.size(swingLows) > 10
        array.pop(swingLows)
        array.pop(swingLowBars)

// íŒ¨í„´ ê°ì§€ ë³€ìˆ˜
var string detectedPattern = ""
var bool patternBullish = false
var int patternStartBar = 0

// ì‚¼ê°ìˆ˜ë ´ ê°ì§€ (coin_guide: "ê±°ë˜ëŸ‰ ì¤„ë©° ê°€ê²©ì´ ìˆ˜ë ´")
detectTriangle() =>
    string pattern = ""
    bool bullish = false
    if array.size(swingHighs) >= 3 and array.size(swingLows) >= 3
        float h1 = array.get(swingHighs, 0)
        float h2 = array.get(swingHighs, 1)
        float h3 = array.get(swingHighs, 2)
        float l1 = array.get(swingLows, 0)
        float l2 = array.get(swingLows, 1)
        float l3 = array.get(swingLows, 2)

        // ê³ ì  í•˜ë½ + ì €ì  ìƒìŠ¹ = ëŒ€ì¹­ ì‚¼ê°ìˆ˜ë ´
        bool highsDesc = h1 < h2 and h2 < h3
        bool lowsAsc = l1 > l2 and l2 > l3

        // ìƒìŠ¹ ì‚¼ê°ìˆ˜ë ´: ê³ ì  ìˆ˜í‰ + ì €ì  ìƒìŠ¹
        bool ascTriangle = math.abs(h1 - h2) / h1 < 0.01 and lowsAsc

        // í•˜ë½ ì‚¼ê°ìˆ˜ë ´: ì €ì  ìˆ˜í‰ + ê³ ì  í•˜ë½
        bool descTriangle = math.abs(l1 - l2) / l1 < 0.01 and highsDesc

        if highsDesc and lowsAsc
            pattern := "ëŒ€ì¹­ì‚¼ê°"
            bullish := close > (h1 + l1) / 2  // ì¤‘ê°„ ìœ„ë©´ ìƒìŠ¹ ìš°ì„¸
        else if ascTriangle
            pattern := "ìƒìŠ¹ì‚¼ê°"
            bullish := true
        else if descTriangle
            pattern := "í•˜ë½ì‚¼ê°"
            bullish := false

    [pattern, bullish]

// ì›»ì§€ ê°ì§€ (coin_guide: "ë¼ì´ì§•ì›»ì§€=í•˜ë½, í´ë§ì›»ì§€=ìƒìŠ¹")
detectWedge() =>
    string pattern = ""
    bool bullish = false
    if array.size(swingHighs) >= 3 and array.size(swingLows) >= 3
        float h1 = array.get(swingHighs, 0)
        float h2 = array.get(swingHighs, 1)
        float l1 = array.get(swingLows, 0)
        float l2 = array.get(swingLows, 1)

        // ë‘ ì„ ì˜ ê¸°ìš¸ê¸°
        float highSlope = h1 - h2
        float lowSlope = l1 - l2

        // ë¼ì´ì§• ì›»ì§€: ë‘˜ ë‹¤ ìƒìŠ¹í•˜ë˜ ìˆ˜ë ´ (í•˜ë½ ì‹ í˜¸)
        bool risingWedge = highSlope > 0 and lowSlope > 0 and lowSlope > highSlope * 0.5

        // í´ë§ ì›»ì§€: ë‘˜ ë‹¤ í•˜ë½í•˜ë˜ ìˆ˜ë ´ (ìƒìŠ¹ ì‹ í˜¸)
        bool fallingWedge = highSlope < 0 and lowSlope < 0 and math.abs(lowSlope) < math.abs(highSlope)

        if risingWedge
            pattern := "ë¼ì´ì§•ì›»ì§€"
            bullish := false  // coin_guide: í•˜ë½ ì‹ í˜¸
        else if fallingWedge
            pattern := "í´ë§ì›»ì§€"
            bullish := true   // coin_guide: ìƒìŠ¹ ì‹ í˜¸

    [pattern, bullish]

// íŒ¨í„´ ê°ì§€ ì‹¤í–‰
[trianglePattern, triangleBull] = detectTriangle()
[wedgePattern, wedgeBull] = detectWedge()

if showPatterns
    if trianglePattern != ""
        detectedPattern := trianglePattern
        patternBullish := triangleBull
        patternStartBar := bar_index
    else if wedgePattern != ""
        detectedPattern := wedgePattern
        patternBullish := wedgeBull
        patternStartBar := bar_index

// íŒ¨í„´ ìœ íš¨ì„± (20ë´‰ ì´ë‚´ë§Œ)
bool patternValid = detectedPattern != "" and bar_index - patternStartBar < 20
bool patternBullSignal = patternValid and patternBullish
bool patternBearSignal = patternValid and not patternBullish

// ============================================
// ì¼ëª©ê· í˜•í‘œ
// ============================================

float tenkanSen = (ta.highest(high, tenkanPeriod) + ta.lowest(low, tenkanPeriod)) / 2
float kijunSen = (ta.highest(high, kijunPeriod) + ta.lowest(low, kijunPeriod)) / 2
float senkouSpanA = (tenkanSen + kijunSen) / 2
float senkouSpanB = (ta.highest(high, senkouBPeriod) + ta.lowest(low, senkouBPeriod)) / 2
float currentCloudTop = math.max(senkouSpanA[displacement], senkouSpanB[displacement])
float currentCloudBottom = math.min(senkouSpanA[displacement], senkouSpanB[displacement])
bool priceAboveCloud = close > currentCloudTop
bool priceBelowCloud = close < currentCloudBottom
bool priceInCloud = not priceAboveCloud and not priceBelowCloud
bool bullishCloud = senkouSpanA > senkouSpanB
string ichimokuSignal = priceAboveCloud ? "êµ¬ë¦„ìœ„" : priceBelowCloud ? "êµ¬ë¦„ì•„ë˜" : "êµ¬ë¦„ë‚´"

// ============================================
// SMC: Smart Trail
// ============================================

float atrMult = 2.0
float atrValueForTrail = ta.atr(atrPeriod)

var float smartTrail = na
var bool smartTrailUp = true

if smartTrailUp
    smartTrail := math.max(nz(smartTrail), close - atrValueForTrail * atrMult)
    if close < smartTrail
        smartTrailUp := false
        smartTrail := close + atrValueForTrail * atrMult
else
    smartTrail := math.min(nz(smartTrail), close + atrValueForTrail * atrMult)
    if close > smartTrail
        smartTrailUp := true
        smartTrail := close - atrValueForTrail * atrMult

// Premium/Discount Zone
float rangeHigh = ta.highest(high, 50)
float rangeLow = ta.lowest(low, 50)
float rangeMid = (rangeHigh + rangeLow) / 2
float premiumZone = rangeMid + (rangeHigh - rangeMid) * 0.5
float discountZone = rangeMid - (rangeMid - rangeLow) * 0.5
bool inPremium = close > premiumZone
bool inDiscount = close < discountZone

// ============================================
// ë©€í‹°íƒ€ì„í”„ë ˆì„ ë¶„ì„
// ============================================

tf15m_ema8 = request.security(syminfo.tickerid, "15", ta.ema(close, 8), lookahead=barmerge.lookahead_off)
tf15m_ema21 = request.security(syminfo.tickerid, "15", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf15m_close = request.security(syminfo.tickerid, "15", close, lookahead=barmerge.lookahead_off)
bool tf15m_uptrend = tf15m_ema8 > tf15m_ema21 and tf15m_close > tf15m_ema21
bool tf15m_downtrend = tf15m_ema8 < tf15m_ema21 and tf15m_close < tf15m_ema21

tf1h_ema8 = request.security(syminfo.tickerid, "60", ta.ema(close, 8), lookahead=barmerge.lookahead_off)
tf1h_ema21 = request.security(syminfo.tickerid, "60", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf1h_close = request.security(syminfo.tickerid, "60", close, lookahead=barmerge.lookahead_off)
bool tf1h_uptrend = tf1h_ema8 > tf1h_ema21 and tf1h_close > tf1h_ema21
bool tf1h_downtrend = tf1h_ema8 < tf1h_ema21 and tf1h_close < tf1h_ema21

tf4h_ema8 = request.security(syminfo.tickerid, "240", ta.ema(close, 8), lookahead=barmerge.lookahead_off)
tf4h_ema21 = request.security(syminfo.tickerid, "240", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tf4h_close = request.security(syminfo.tickerid, "240", close, lookahead=barmerge.lookahead_off)
bool tf4h_uptrend = tf4h_ema8 > tf4h_ema21 and tf4h_close > tf4h_ema21
bool tf4h_downtrend = tf4h_ema8 < tf4h_ema21 and tf4h_close < tf4h_ema21

tfD_ema8 = request.security(syminfo.tickerid, "D", ta.ema(close, 8), lookahead=barmerge.lookahead_off)
tfD_ema21 = request.security(syminfo.tickerid, "D", ta.ema(close, 21), lookahead=barmerge.lookahead_off)
tfD_close = request.security(syminfo.tickerid, "D", close, lookahead=barmerge.lookahead_off)
bool tfD_uptrend = tfD_ema8 > tfD_ema21 and tfD_close > tfD_ema21
bool tfD_downtrend = tfD_ema8 < tfD_ema21 and tfD_close < tfD_ema21

// 3ì¼ ì§€ì§€/ì €í•­
tf1h_high3d = request.security(syminfo.tickerid, "60", ta.highest(high, 72), lookahead=barmerge.lookahead_off)
tf1h_low3d = request.security(syminfo.tickerid, "60", ta.lowest(low, 72), lookahead=barmerge.lookahead_off)
float resistance3d = tf1h_high3d
float support3d = tf1h_low3d
float pricePosition = (close - support3d) / math.max(resistance3d - support3d, 0.0001) * 100
bool nearSupport3d = pricePosition < 15
bool nearResistance3d = pricePosition > 85
bool atSupport3d = pricePosition < 5
bool atResistance3d = pricePosition > 95

// TF ì¼ì¹˜ ì¹´ìš´íŠ¸
int uptrendCount = (tf15m_uptrend ? 1 : 0) + (tf1h_uptrend ? 1 : 0) + (tf4h_uptrend ? 1 : 0) + (tfD_uptrend ? 1 : 0)
int downtrendCount = (tf15m_downtrend ? 1 : 0) + (tf1h_downtrend ? 1 : 0) + (tf4h_downtrend ? 1 : 0) + (tfD_downtrend ? 1 : 0)

// ============================================
// â˜…â˜…â˜… V43: 35ì  ì ìˆ˜ ì‹œìŠ¤í…œ (í™•ì¥) â˜…â˜…â˜…
// ============================================

float longScore = 0

// ì¶”ì„¸ (8ì )
longScore += emaAlignedUp ? 3 : (ema8 > ema21 ? 1 : 0)
longScore += aboveEMA200 ? 2 : 0
longScore += tf1h_uptrend ? 2 : 0
longScore += tf4h_uptrend ? 1 : 0

// ëª¨ë©˜í…€ (8ì )
longScore += stochOversold ? 3 : (stochK < 40 and stochBullish ? 2 : stochBullish ? 1 : 0)
longScore += macdBullish ? 2 : 0
longScore += rsiOversold ? 2 : (rsi < 45 ? 1 : 0)
longScore += (bullishDI and trendStrong) ? 1 : 0

// ê±°ë˜ëŸ‰ (6ì )
longScore += volumeExplosion and strongBuyPressure ? 3 : (volSpike and strongBuyPressure ? 2 : volSpike ? 1 : 0)
longScore += whaleBuy ? 3 : 0

// êµ¬ì¡° (6ì )
longScore += atSupport3d ? 3 : (nearSupport3d ? 2 : 0)
longScore += touchBBLower ? 2 : 0
longScore += bullishDivergence ? 1 : 0

// â˜… V43 ì‹ ê·œ: Parabolic SAR (3ì )
longScore += psarConfirmedLong and psarAccelerating ? 3 : psarBullish ? 1 : 0

// â˜… V43 ì‹ ê·œ: Stochastic ì‚¼í˜•ì œ (4ì )
longScore += stoch3AllOversold ? 3 : (stoch3SequentialRise and stochScore >= 4) ? 2 : stoch3Rising ? 1 : 0
longScore += stoch3GoldenCross or stoch2GoldenCross or stoch1GoldenCross ? 1 : 0

// â˜… V43 ì‹ ê·œ: íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ (2ì ) - ì¶”ì„¸ ì§€ì†
longScore += hiddenBullishDiv ? 2 : 0

// â˜… V43 ì‹ ê·œ: ì°¨íŠ¸ íŒ¨í„´ (3ì )
longScore += patternBullSignal ? 3 : 0

// ì¶”ì„¸ ì ìˆ˜
int emaAlignedUpCount = (emaAlignedUp ? 1 : 0) + (tf15m_uptrend ? 1 : 0) + (tf1h_uptrend ? 1 : 0) + (tf4h_uptrend ? 1 : 0) + (tfD_uptrend ? 1 : 0)
int trendScore = uptrendCount + emaAlignedUpCount
string trendStrength = trendScore >= 8 ? "VERY STRONG" : trendScore >= 6 ? "STRONG" : trendScore >= 4 ? "MODERATE" : trendScore >= 2 ? "WEAK" : "BEAR"

// ============================================
// ê³ í™•ì‹  ì¡°ê±´
// ============================================

// ê¸°ì¡´ ê³ í™•ì‹  ì¡°ê±´
bool highConf1 = tf1h_uptrend and tf4h_uptrend and (atSupport3d or pricePosition < 10) and volSpike and strongBuyPressure
bool highConf2 = bullishDivergence and (rsiOversold or stochOversold) and volSpike
bool highConf3 = touchBBLower and stochOversold and tf1h_uptrend and volSpike
bool highConf4 = emaAlignedUp and aboveEMA200 and trendStrong and volSpike

// â˜… V43 ì‹ ê·œ ê³ í™•ì‹  ì¡°ê±´
bool highConf5 = psarFlipToLong and stoch3SequentialRise and volSpike  // PSAR ì „í™˜ + ì‚¼í˜•ì œ ìƒìŠ¹
bool highConf6 = hiddenBullishDiv and smartTrailUp and tf1h_uptrend    // íˆë“  ë‹¤ì´ë²„ + ì¶”ì„¸ ì§€ì†
bool highConf7 = patternBullSignal and stoch3AllOversold and volSpike  // íŒ¨í„´ + ê³¼ë§¤ë„

bool highConfidenceLong = highConf1 or highConf2 or highConf3 or highConf4 or highConf5 or highConf6 or highConf7

string confReason = highConf1 ? "HTF+SR+VOL" : highConf2 ? "DIV+OVERSOLD" : highConf3 ? "BB+OVERSOLD" : highConf4 ? "TREND+VOL" : highConf5 ? "PSAR+STOCH" : highConf6 ? "HIDDEN_DIV" : highConf7 ? "PATTERN" : "-"

// ============================================
// ì‹ í˜¸ ë“±ê¸‰ ì‹œìŠ¤í…œ
// ============================================

// Së“±ê¸‰: 35ì  ì¤‘ 25ì  ì´ìƒ
bool gradeS = longScore >= 25 and uptrendCount >= 3 and nearSupport3d and highConfidenceLong

// Aë“±ê¸‰: 20ì  ì´ìƒ
bool gradeA = longScore >= 20 and uptrendCount >= 3 and volSpike

// Bë“±ê¸‰: 15ì  ì´ìƒ
bool gradeB = longScore >= 15 and uptrendCount >= 2 and tf1h_uptrend

string currentGrade = gradeS ? "S" : longScore >= 22 ? "A+" : gradeA ? "A" : longScore >= 17 ? "B+" : gradeB ? "B" : "C"

// LONG ì‹œê·¸ë„
bool strongLong = gradeS or gradeA
bool normalLong = gradeB and not strongLong
bool superLong = strongLong and smartTrailUp and (psarBullish or stoch3SequentialRise) and inDiscount

// Smart Trail ì „í™˜
var bool prevSmartTrailUp = true
bool trailFlipToShort = prevSmartTrailUp and not smartTrailUp
bool trailFlipToLong = not prevSmartTrailUp and smartTrailUp
prevSmartTrailUp := smartTrailUp

bool exitLongSignal = trailFlipToShort and longScore < 12 and not tf1h_uptrend

// í•„í„°
var int lastSignalBar = 0
int barsSinceSignal = bar_index - lastSignalBar
bool cooldownActive = enableCooldown and barsSinceSignal < cooldownBars
bool cooldownPass = not enableCooldown or not cooldownActive
float volumeAvg = ta.sma(volume, volumeAvgLength)
bool volumeFilterPass = not enableVolumeFilter or (volume >= volumeAvg * minVolumeRatio)
bool v40FilterPass = cooldownPass and volumeFilterPass

// ìµœì¢… ì‹œê·¸ë„
bool showSuperLong = superLong and v40FilterPass
bool showStrongLong = strongLong and not superLong and v40FilterPass and (nearSupport3d or highConfidenceLong)
bool showNormalLong = normalLong and v40FilterPass and signalMode == "ì „ì²´"

if showSuperLong or showStrongLong or showNormalLong
    lastSignalBar := bar_index

string finalGrade = superLong ? "SUPER" : currentGrade

// ============================================
// ì°¨íŠ¸ í‘œì‹œ
// ============================================

// EMA
plot(showEMA ? ema8 : na, color=color.yellow, linewidth=1, title="EMA 8")
plot(showEMA ? ema21 : na, color=color.orange, linewidth=2, title="EMA 21")
plot(showEMA ? ema55 : na, color=color.blue, linewidth=1, title="EMA 55")
plot(showEMA ? ema200 : na, color=color.purple, linewidth=1, title="EMA 200")

// Parabolic SAR
plot(showPSAR ? psarValue : na, style=plot.style_circles, color=psarBullish ? color.lime : color.red, linewidth=2, title="Parabolic SAR")

// ì¼ëª©ê· í˜•í‘œ
p1 = plot(showIchimoku ? senkouSpanA : na, offset=displacement, color=color.new(color.green, 80), linewidth=1, title="Senkou A")
p2 = plot(showIchimoku ? senkouSpanB : na, offset=displacement, color=color.new(color.red, 80), linewidth=1, title="Senkou B")
fill(p1, p2, color=senkouSpanA > senkouSpanB ? color.new(color.green, 85) : color.new(color.red, 85), title="Ichimoku Cloud")

// Smart Trail
plot(showSMC and showSmartTrail ? smartTrail : na, color=smartTrailUp ? color.lime : color.red, linewidth=2, style=plot.style_stepline_diamond, title="Smart Trail")

// ë©”ì¸ ì‹œê·¸ë„
plotshape(showVisuals and showSuperLong, style=shape.labelup, location=location.belowbar, color=color.new(color.aqua, 0), text="ğŸš€", textcolor=color.white, size=size.huge, title="SUPER LONG")
plotshape(showVisuals and showStrongLong, style=shape.labelup, location=location.belowbar, color=color.new(color.yellow, 0), text="â­", textcolor=color.black, size=size.large, title="STRONG LONG")
plotshape(showVisuals and showNormalLong and signalMode == "ì „ì²´", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="LONG")

// ì²­ì‚° ì‹œê·¸ë„
plotshape(showVisuals and exitLongSignal, style=shape.xcross, location=location.abovebar, color=color.red, size=size.normal, title="EXIT LONG")

// ê³ ë˜ ë¼ë²¨
if showVisuals and showWhale and whaleBuy
    label.new(bar_index, low, "ğŸ‹BUY", style=label.style_label_up, color=color.blue, textcolor=color.white, size=size.small)
if showVisuals and showWhale and whaleSell
    label.new(bar_index, high, "ğŸ‹SELL", style=label.style_label_down, color=color.purple, textcolor=color.white, size=size.small)

// V43 íŒ¨í„´ ë¼ë²¨
if showVisuals and showPatterns and patternValid and bar_index == patternStartBar
    color labelColor = patternBullish ? color.teal : color.maroon
    string labelText = patternBullish ? "â–²" + detectedPattern : "â–¼" + detectedPattern
    label.new(bar_index, patternBullish ? low : high, labelText,
             style=patternBullish ? label.style_label_up : label.style_label_down,
             color=labelColor, textcolor=color.white, size=size.normal)

// íˆë“  ë‹¤ì´ë²„ì „ìŠ¤ ë¼ë²¨
if showVisuals and showHiddenDiv and hiddenBullishDiv
    label.new(bar_index - pivotRight, low, "H.DIV+", style=label.style_label_up,
             color=color.new(color.teal, 30), textcolor=color.white, size=size.tiny)
if showVisuals and showHiddenDiv and hiddenBearishDiv
    label.new(bar_index - pivotRight, high, "H.DIV-", style=label.style_label_down,
             color=color.new(color.maroon, 30), textcolor=color.white, size=size.tiny)

// PSAR ì „í™˜ ë¼ë²¨
if showVisuals and showPSAR and psarFlipToLong
    label.new(bar_index, low, "SARâ†‘", style=label.style_label_up,
             color=color.new(color.lime, 30), textcolor=color.white, size=size.tiny)
if showVisuals and showPSAR and psarFlipToShort
    label.new(bar_index, high, "SARâ†“", style=label.style_label_down,
             color=color.new(color.red, 30), textcolor=color.white, size=size.tiny)

// ë°°ê²½ìƒ‰
bgcolor(showSuperLong ? color.new(color.aqua, 60) : na)
bgcolor(showStrongLong ? color.new(color.yellow, 70) : na)
bgcolor(exitLongSignal ? color.new(color.red, 70) : na)

// 3ì¼ ì§€ì§€/ì €í•­ ë¼ì¸
var line sup3dLine = na
var line res3dLine = na
if showSR and barstate.islast
    if not na(sup3dLine)
        line.delete(sup3dLine)
    if not na(res3dLine)
        line.delete(res3dLine)
    sup3dLine := line.new(bar_index - 100, support3d, bar_index + 10, support3d, color=color.green, width=3)
    res3dLine := line.new(bar_index - 100, resistance3d, bar_index + 10, resistance3d, color=color.red, width=3)

// ============================================
// ë¯¸ë‹ˆ íŒ¨ë„
// ============================================

if showMiniPanel and isMinimalMode and barstate.islast
    var table miniTbl = table.new(position.top_right, 4, 14, bgcolor=color.new(color.black, 20), border_width=1)

    // êµ¬ë¦„ í•„í„°
    bool cloudLongOK = not ichimokuFilter or priceAboveCloud or priceInCloud

    // ì‹ í˜¸ë“± íŒë‹¨
    bool isLongGreen = smartTrailUp and tf1h_uptrend and longScore >= 18 and pricePosition < 30 and cloudLongOK
    bool isLongRed = exitLongSignal or (pricePosition > 70) or (not smartTrailUp and not tf1h_uptrend) or (ichimokuFilter and priceBelowCloud)

    string longLightEmoji = isLongGreen ? "ğŸŸ¢" : isLongRed ? "ğŸ”´" : "ğŸŸ¡"
    string longLightText = isLongGreen ? "ë¡±OK" : isLongRed ? "ìœ„í—˜" : "ëŒ€ê¸°"
    color longLightBg = isLongGreen ? color.new(color.green, 20) : isLongRed ? color.new(color.red, 20) : color.new(color.yellow, 30)
    color longLightColor = isLongGreen ? color.lime : isLongRed ? color.red : color.yellow

    // ì‹œê·¸ë„ ì •ë³´
    string sigText = superLong ? "SUPER" : strongLong ? "STRONG" : normalLong ? "LONG" : exitLongSignal ? "EXIT!" : "WAIT"
    color sigColor = superLong ? color.aqua : strongLong ? color.yellow : normalLong ? color.green : exitLongSignal ? color.red : color.gray
    color sigBg = superLong ? color.new(color.aqua, 50) : exitLongSignal ? color.new(color.red, 50) : color.new(color.gray, 70)

    // ìƒíƒœ
    string statusText = exitLongSignal ? "ì²­ì‚°!" : trailFlipToShort ? "ì£¼ì˜" : smartTrailUp ? "ë³´ìœ " : "ëŒ€ê¸°"
    color statusColor = exitLongSignal ? color.red : trailFlipToShort ? color.orange : smartTrailUp ? color.lime : color.gray

    // EMA ê°ë„
    string emaAngleStatus = emaStrongUp ? "â–²â–²ê°•ì„¸" : emaWeakUp ? "â–²ìƒìŠ¹" : emaSideways ? "-íš¡ë³´" : "â–¼í•˜ë½"
    color emaAngleStatusColor = emaStrongUp ? color.lime : emaWeakUp ? color.yellow : emaSideways ? color.orange : color.red

    // Row 0: LONG ì‹ í˜¸ë“±
    table.cell(miniTbl, 0, 0, "ğŸ“ˆLONG", text_color=color.white, bgcolor=color.new(color.teal, 30), text_size=size.normal)
    table.cell(miniTbl, 1, 0, longLightEmoji + longLightText, text_color=longLightColor, bgcolor=longLightBg, text_size=size.large)
    table.cell(miniTbl, 2, 0, confReason, text_color=longLightColor, bgcolor=longLightBg, text_size=size.small)
    table.cell(miniTbl, 3, 0, str.tostring(longScore, "#") + "pt", text_color=longLightColor, bgcolor=longLightBg, text_size=size.normal)

    // Row 1: V43 í—¤ë”
    table.cell(miniTbl, 0, 1, "V43", text_color=color.white, bgcolor=color.blue, text_size=size.normal)
    table.cell(miniTbl, 1, 1, emaAngleStatus, text_color=emaAngleStatusColor, bgcolor=color.new(color.gray, 50), text_size=size.small)
    table.cell(miniTbl, 2, 1, timeframe.period, text_color=color.white, bgcolor=color.gray, text_size=size.normal)
    table.cell(miniTbl, 3, 1, smartTrailUp ? "ì¶”ì„¸â†‘" : "ì¶”ì„¸â†“", text_color=smartTrailUp ? color.lime : color.red, text_size=size.small)

    // Row 2: ì‹œê·¸ë„
    string sigKorean = superLong ? "ìµœê°•ë§¤ìˆ˜" : strongLong ? "ê°•ë ¥ë§¤ìˆ˜" : normalLong ? "ë§¤ìˆ˜" : exitLongSignal ? "ì²­ì‚°!" : "ëŒ€ê¸°"
    table.cell(miniTbl, 0, 2, "ì‹œê·¸ë„", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 2, sigText, text_color=sigColor, bgcolor=sigBg, text_size=size.large)
    table.cell(miniTbl, 2, 2, sigKorean, text_color=sigColor, bgcolor=sigBg, text_size=size.small)
    table.cell(miniTbl, 3, 2, currentGrade, text_color=sigColor, bgcolor=sigBg, text_size=size.small)

    // Row 3: ì¶”ì„¸
    string trendKorean = uptrendCount >= 3 ? "ì¢‹ìŒ" : uptrendCount >= 2 ? "ë³´í†µ" : "ë‚˜ì¨"
    color trendKoreanColor = uptrendCount >= 3 ? color.lime : uptrendCount >= 2 ? color.yellow : color.red
    table.cell(miniTbl, 0, 3, "ì¶”ì„¸", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 3, str.tostring(uptrendCount) + "/4 " + trendKorean, text_color=trendKoreanColor, text_size=size.small)
    table.cell(miniTbl, 2, 3, tf1h_uptrend ? "1Hâ†‘" : "1Hâ†“", text_color=tf1h_uptrend ? color.green : color.red, text_size=size.small)
    table.cell(miniTbl, 3, 3, tf4h_uptrend ? "4Hâ†‘" : "4Hâ†“", text_color=tf4h_uptrend ? color.green : color.red, text_size=size.small)

    // Row 4: ìœ„ì¹˜
    string posKorean = pricePosition < 20 ? "ì €ì OK" : pricePosition < 40 ? "ì–‘í˜¸" : pricePosition < 60 ? "ì¤‘ê°„" : pricePosition < 80 ? "ë†’ìŒ" : "ê³ ì !"
    color posKoreanColor = pricePosition < 20 ? color.lime : pricePosition < 40 ? color.green : pricePosition < 60 ? color.yellow : color.red
    table.cell(miniTbl, 0, 4, "ìœ„ì¹˜", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(miniTbl, 1, 4, str.tostring(pricePosition, "#") + "% " + posKorean, text_color=posKoreanColor, text_size=size.small)
    table.cell(miniTbl, 2, 4, "Vol", text_color=color.white, text_size=size.small)
    table.cell(miniTbl, 3, 4, str.tostring(volRatio, "#.#") + "x", text_color=volSpike ? color.green : color.gray, text_size=size.small)

    // Row 5: ìƒíƒœ
    string zoneKorean = inDiscount ? "ì €ì êµ¬ê°„" : inPremium ? "ê³ ì êµ¬ê°„" : "ì¤‘ê°„"
    table.cell(miniTbl, 0, 5, "ìƒíƒœ", text_color=color.white, bgcolor=color.navy, text_size=size.small)
    table.cell(miniTbl, 1, 5, statusText, text_color=statusColor, text_size=size.large)
    table.cell(miniTbl, 2, 5, zoneKorean, text_color=inDiscount ? color.green : inPremium ? color.red : color.gray, text_size=size.small)
    table.cell(miniTbl, 3, 5, superLong ? "GO!!" : strongLong ? "GO!" : "", text_color=superLong ? color.aqua : color.yellow, text_size=size.normal)

    // Row 6: â˜… V43 Parabolic SAR
    string psarStatus = psarBullish ? "ìƒìŠ¹SAR" : "í•˜ë½SAR"
    string psarDetail = psarConfirmedLong ? "í™•ì¸ë¨" : psarFlipToLong ? "ì „í™˜!" : psarNearFlip ? "ì „í™˜ì„ë°•" : ""
    color psarColor = psarBullish ? color.lime : color.red
    color psarBg = psarFlipToLong ? color.new(color.lime, 40) : psarNearFlip ? color.new(color.yellow, 50) : color.new(color.gray, 70)
    table.cell(miniTbl, 0, 6, "PSAR", text_color=color.white, bgcolor=color.new(color.purple, 30), text_size=size.small)
    table.cell(miniTbl, 1, 6, psarStatus, text_color=psarColor, bgcolor=psarBg, text_size=size.small)
    table.cell(miniTbl, 2, 6, psarDetail, text_color=psarColor, bgcolor=psarBg, text_size=size.small)
    table.cell(miniTbl, 3, 6, str.tostring(psarDistance, "#.#") + "%", text_color=psarNearFlip ? color.yellow : color.gray, bgcolor=psarBg, text_size=size.small)

    // Row 7: â˜… V43 Stochastic ì‚¼í˜•ì œ
    string stochStatus = stoch3AllOversold ? "ì „ì›ê³¼ë§¤ë„" : stoch3AllOverbought ? "ì „ì›ê³¼ë§¤ìˆ˜" : stoch3SequentialRise ? "ì „ì›ìƒìŠ¹" : stoch3SequentialFall ? "ì „ì›í•˜ë½" : "í˜¼ì¡°"
    string stochDetail = stoch3GoldenCross ? "GC!" : stoch3DeadCross ? "DC!" : stoch3Rising ? "â†‘â†‘â†‘" : stoch3Falling ? "â†“â†“â†“" : ""
    color stochStatusColor = stoch3AllOversold or stoch3SequentialRise ? color.lime : stoch3AllOverbought or stoch3SequentialFall ? color.red : color.gray
    color stochBg = stoch3AllOversold ? color.new(color.green, 40) : stoch3AllOverbought ? color.new(color.red, 40) : color.new(color.gray, 70)
    table.cell(miniTbl, 0, 7, "Stoch3", text_color=color.white, bgcolor=color.new(color.teal, 30), text_size=size.small)
    table.cell(miniTbl, 1, 7, stochStatus, text_color=stochStatusColor, bgcolor=stochBg, text_size=size.small)
    table.cell(miniTbl, 2, 7, stochDetail, text_color=stochStatusColor, bgcolor=stochBg, text_size=size.small)
    table.cell(miniTbl, 3, 7, str.tostring(stochScore) + "/6", text_color=stochScore >= 4 ? color.lime : color.gray, bgcolor=stochBg, text_size=size.small)

    // Row 8: â˜… V43 ì‚¼í˜•ì œ ìƒì„¸
    string s1 = str.tostring(stoch1K_val, "#")
    string s2 = str.tostring(stoch2K_val, "#")
    string s3 = str.tostring(stoch3K_val, "#")
    table.cell(miniTbl, 0, 8, "ë§‰ë‚´", text_color=color.gray, text_size=size.tiny)
    table.cell(miniTbl, 1, 8, s1, text_color=stoch1Oversold ? color.lime : stoch1Overbought ? color.red : color.gray, text_size=size.small)
    table.cell(miniTbl, 2, 8, "ë‘˜ì§¸ " + s2, text_color=stoch2Oversold ? color.lime : stoch2Overbought ? color.red : color.gray, text_size=size.tiny)
    table.cell(miniTbl, 3, 8, "í°í˜• " + s3, text_color=stoch3Oversold ? color.lime : stoch3Overbought ? color.red : color.gray, text_size=size.tiny)

    // Row 9: â˜… V43 ë‹¤ì´ë²„ì „ìŠ¤
    string divStatus = hiddenBullishDiv ? "íˆë“ ìƒìŠ¹" : hiddenBearishDiv ? "íˆë“ í•˜ë½" : bullishDivergence ? "ì¼ë°˜ìƒìŠ¹" : bearishDivergence ? "ì¼ë°˜í•˜ë½" : "ì—†ìŒ"
    string divMeaning = hiddenBullishDiv ? "ì¶”ì„¸ì§€ì†â†‘" : hiddenBearishDiv ? "ì¶”ì„¸ì§€ì†â†“" : bullishDivergence ? "ë°˜ì „ê°€ëŠ¥â†‘" : bearishDivergence ? "ë°˜ì „ê°€ëŠ¥â†“" : ""
    color divColor = hiddenBullishDiv or bullishDivergence ? color.lime : hiddenBearishDiv or bearishDivergence ? color.red : color.gray
    color divBg = hiddenBullishDiv ? color.new(color.teal, 40) : hiddenBearishDiv ? color.new(color.maroon, 40) : color.new(color.gray, 70)
    table.cell(miniTbl, 0, 9, "DIV", text_color=color.white, bgcolor=color.new(color.orange, 30), text_size=size.small)
    table.cell(miniTbl, 1, 9, divStatus, text_color=divColor, bgcolor=divBg, text_size=size.small)
    table.cell(miniTbl, 2, 9, divMeaning, text_color=divColor, bgcolor=divBg, text_size=size.small)
    table.cell(miniTbl, 3, 9, "", text_color=color.gray, bgcolor=divBg, text_size=size.small)

    // Row 10: â˜… V43 íŒ¨í„´
    string patternStatus = patternValid ? detectedPattern : "ì—†ìŒ"
    string patternAction = patternBullSignal ? "ë§¤ìˆ˜ìš°ì„¸" : patternBearSignal ? "ë§¤ë„ìš°ì„¸" : ""
    color patternColor = patternBullSignal ? color.lime : patternBearSignal ? color.red : color.gray
    color patternBg = patternValid ? (patternBullish ? color.new(color.teal, 50) : color.new(color.maroon, 50)) : color.new(color.gray, 70)
    table.cell(miniTbl, 0, 10, "íŒ¨í„´", text_color=color.white, bgcolor=color.new(color.navy, 30), text_size=size.small)
    table.cell(miniTbl, 1, 10, patternStatus, text_color=patternColor, bgcolor=patternBg, text_size=size.small)
    table.cell(miniTbl, 2, 10, patternAction, text_color=patternColor, bgcolor=patternBg, text_size=size.small)
    table.cell(miniTbl, 3, 10, "", text_color=color.gray, bgcolor=patternBg, text_size=size.small)

    // Row 11: êµ¬ë¦„ ìƒíƒœ
    string cloudKorean = priceAboveCloud ? "êµ¬ë¦„ìœ„" : priceBelowCloud ? "êµ¬ë¦„ì•„ë˜" : "êµ¬ë¦„ë‚´"
    string cloudAction = priceAboveCloud ? "ë¡±ìœ ë¦¬" : priceBelowCloud ? "ìˆìœ ë¦¬" : "ê´€ë§"
    color cloudTextColor = priceAboveCloud ? color.lime : priceBelowCloud ? color.red : color.yellow
    color cloudBg = priceAboveCloud ? color.new(color.lime, 40) : priceBelowCloud ? color.new(color.red, 40) : color.new(color.yellow, 50)
    table.cell(miniTbl, 0, 11, "êµ¬ë¦„", text_color=color.white, bgcolor=color.new(color.purple, 30), text_size=size.small)
    table.cell(miniTbl, 1, 11, cloudKorean, text_color=cloudTextColor, bgcolor=cloudBg, text_size=size.small)
    table.cell(miniTbl, 2, 11, bullishCloud ? "ì–‘ìš´" : "ìŒìš´", text_color=bullishCloud ? color.lime : color.red, bgcolor=cloudBg, text_size=size.small)
    table.cell(miniTbl, 3, 11, cloudAction, text_color=cloudTextColor, bgcolor=cloudBg, text_size=size.small)

    // Row 12: RSI/MACD
    table.cell(miniTbl, 0, 12, "RSI", text_color=color.gray, text_size=size.tiny)
    table.cell(miniTbl, 1, 12, str.tostring(rsi, "#"), text_color=rsiOversold ? color.lime : rsiOverbought ? color.red : color.gray, text_size=size.small)
    table.cell(miniTbl, 2, 12, "MACD", text_color=color.gray, text_size=size.tiny)
    table.cell(miniTbl, 3, 12, macdBullish ? "BULL" : "BEAR", text_color=macdBullish ? color.green : color.red, text_size=size.small)

    // Row 13: ì¡°ì–¸
    string finalAdvice = isLongGreen ? "ë¡± ì§„ì… ê³ ë ¤" : isLongRed ? "ë¡± ìœ„í—˜!" : psarFlipToLong ? "PSAR ì „í™˜!" : stoch3AllOversold ? "ê³¼ë§¤ë„ ì£¼ëª©" : "ê´€ë§ ì¶”ì²œ"
    color adviceColor = isLongGreen ? color.lime : isLongRed ? color.red : psarFlipToLong or stoch3AllOversold ? color.yellow : color.gray
    color adviceBg = isLongGreen ? color.new(color.green, 30) : isLongRed ? color.new(color.red, 30) : color.new(color.gray, 50)
    table.cell(miniTbl, 0, 13, "ì¡°ì–¸", text_color=color.white, bgcolor=color.navy, text_size=size.small)
    table.cell(miniTbl, 1, 13, finalAdvice, text_color=adviceColor, bgcolor=adviceBg, text_size=size.small)
    table.cell(miniTbl, 2, 13, "", bgcolor=adviceBg, text_size=size.small)
    table.cell(miniTbl, 3, 13, "", bgcolor=adviceBg, text_size=size.small)

// ============================================
// ì•Œë¦¼
// ============================================

string disclaimer = "[ì°¸ê³ ìš©-íˆ¬ìê¶Œìœ ì•„ë‹˜]"

if superLong
    string m1 = "ğŸš€ğŸš€ğŸš€ V43 SUPER LONG ğŸš€ğŸš€ğŸš€"
    string m2 = "[" + finalGrade + "] " + str.tostring(longScore, "#") + "pt/35"
    string m3 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string m4 = "PSAR: " + (psarBullish ? "ìƒìŠ¹" : "í•˜ë½") + " | Stoch: " + str.tostring(stochScore) + "/6"
    string m5 = disclaimer
    alert(m1 + "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5, freq=alert.freq_once_per_bar_close)

if strongLong and not superLong
    string m1 = "â­â­ V43 STRONG LONG â­â­"
    string m2 = "[" + currentGrade + "] " + str.tostring(longScore, "#") + "pt/35"
    string m3 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string m4 = confReason + " | Stochì‚¼í˜•ì œ: " + (stoch3SequentialRise ? "ìƒìŠ¹" : stoch3SequentialFall ? "í•˜ë½" : "í˜¼ì¡°")
    string m5 = disclaimer
    alert(m1 + "\n" + m2 + "\n" + m3 + "\n" + m4 + "\n" + m5, freq=alert.freq_once_per_bar_close)

if exitLongSignal
    string e1 = "âŒâŒ V43 EXIT LONG âŒâŒ"
    string e2 = syminfo.basecurrency + "/USDT " + timeframe.period + " $" + str.tostring(close, "#.##")
    string e3 = "Smart Trail SHORT ì „í™˜ | ì ìˆ˜: " + str.tostring(longScore, "#") + "pt"
    string e4 = disclaimer
    alert(e1 + "\n" + e2 + "\n" + e3 + "\n" + e4, freq=alert.freq_once_per_bar_close)

// V43 ì‹ ê·œ ì•Œë¦¼: PSAR ì „í™˜
if psarFlipToLong and volSpike
    alert("ğŸ“Š V43 PSAR ë§¤ìˆ˜ì „í™˜! " + syminfo.basecurrency + " $" + str.tostring(close, "#.##") + " | Stoch: " + str.tostring(stochScore) + "/6 " + disclaimer, freq=alert.freq_once_per_bar_close)

// V43 ì‹ ê·œ ì•Œë¦¼: ì‚¼í˜•ì œ ì „ì› ê³¼ë§¤ë„
if stoch3AllOversold and not stoch3AllOversold[1]
    alert("ğŸ“Š V43 Stochì‚¼í˜•ì œ ì „ì›ê³¼ë§¤ë„! " + syminfo.basecurrency + " $" + str.tostring(close, "#.##") + " | ë°˜ì „ ì£¼ëª© " + disclaimer, freq=alert.freq_once_per_bar_close)

// V43 ì‹ ê·œ ì•Œë¦¼: íˆë“  ë‹¤ì´ë²„ì „ìŠ¤
if hiddenBullishDiv
    alert("ğŸ“Š V43 íˆë“ ìƒìŠ¹ë‹¤ì´ë²„ì „ìŠ¤! " + syminfo.basecurrency + " $" + str.tostring(close, "#.##") + " | ìƒìŠ¹ì¶”ì„¸ ì§€ì† " + disclaimer, freq=alert.freq_once_per_bar_close)

// V43 ì‹ ê·œ ì•Œë¦¼: íŒ¨í„´ ê°ì§€
if patternValid and patternBullish and bar_index == patternStartBar
    alert("ğŸ“Š V43 " + detectedPattern + " ìƒìŠ¹íŒ¨í„´! " + syminfo.basecurrency + " $" + str.tostring(close, "#.##") + " " + disclaimer, freq=alert.freq_once_per_bar_close)
