//@version=5
strategy("ë§¤ë§¤ì§€í‘œ V30 ìµœì í™” (ë°±í…ŒìŠ¤íŠ¸+ì§€í‘œ)", overlay=true, max_labels_count=100, max_lines_count=50, default_qty_type=strategy.percent_of_equity, default_qty_value=30, initial_capital=1000, commission_type=strategy.commission.percent, commission_value=0.1, slippage=2)

// ============================================
// V30 ìµœì í™” ë²„ì „ - ëª¨ë“  ë²„ì „ í†µí•© (ë¶ˆì¥ë‹¨íƒ€ì™• ì œì™¸)
//
// í¬í•¨ëœ ê¸°ëŠ¥:
// - V26: ADX í•„í„°, ì‹ í˜¸ í’ˆì§ˆ ê°•í™”
// - V27: HTF ì¶”ì„¸ ì»¨íŒ (15ë¶„/1ì‹œê°„)
// - V28: HTF ê±°ë˜ëŸ‰ ì»¨íŒ
// - V29: 3ì¼ë´‰ ì§€ì§€/ì €í•­
// - LONG/SHORT ìµœì í™” ì¡°ê±´
// ============================================

// ============================================
// ê±°ë˜ ëª¨ë“œ ì„ íƒ
// ============================================
tradeMode = input.string("ì„ ë¬¼", title="ê±°ë˜ ëª¨ë“œ", options=["ì„ ë¬¼", "í˜„ë¬¼ì½”ì¸", "ì£¼ì‹"], tooltip="ì„ ë¬¼: LONG+SHORT, í˜„ë¬¼ì½”ì¸: LONGë§Œ, ì£¼ì‹: LONGë§Œ")
shortMode = input.string("ìë™", title="SHORT ëª¨ë“œ", options=["ìë™", "í•­ìƒ OFF", "í•­ìƒ ON"], tooltip="ìë™: í•˜ë½ì¥ ìë™ ê°ì§€, OFF: SHORT ë¹„í™œì„±í™”, ON: í•­ìƒ í™œì„±í™”", group="ê±°ë˜ ì„¤ì •")

// ============================================
// ì§€ì§€/ì €í•­ ë¶„ì„ ì„¤ì • (V29 - ìë™ íƒ€ì„í”„ë ˆì„)
// ============================================
showSRLevels = input.bool(true, title="ì§€ì§€/ì €í•­ ë ˆë²¨ í‘œì‹œ", group="S/R ì„¤ì •")
srAutoTimeframe = input.bool(true, title="S/R íƒ€ì„í”„ë ˆì„ ìë™", tooltip="í˜„ì¬ ì°¨íŠ¸ íƒ€ì„í”„ë ˆì„ì— ë”°ë¼ ìë™ ì¡°ì •", group="S/R ì„¤ì •")
srManualTimeframe = input.timeframe("3D", title="S/R ìˆ˜ë™ íƒ€ì„í”„ë ˆì„", tooltip="ìë™ OFFì‹œ ì‚¬ìš©", group="S/R ì„¤ì •")
srStrengthThreshold = input.float(1.5, title="ê°•í•œ S/R ë°°ìˆ˜", minval=1.0, maxval=3.0, step=0.1, group="S/R ì„¤ì •")

// í˜„ì¬ íƒ€ì„í”„ë ˆì„ì— ë”°ë¥¸ S/R íƒ€ì„í”„ë ˆì„ ìë™ ì„¤ì •
// ì§§ì€ íƒ€ì„í”„ë ˆì„ì¼ìˆ˜ë¡ ë” ë†’ì€ íƒ€ì„í”„ë ˆì„ì˜ S/R ì‚¬ìš©
currentTFMinutes = timeframe.in_seconds() / 60

// ìë™ S/R íƒ€ì„í”„ë ˆì„ ê²°ì •
string autoSRTimeframe = "D"
if currentTFMinutes <= 1
    autoSRTimeframe := "15"      // 1ë¶„ë´‰ â†’ 15ë¶„ë´‰ S/R
else if currentTFMinutes <= 5
    autoSRTimeframe := "60"      // 5ë¶„ë´‰ â†’ 1ì‹œê°„ë´‰ S/R
else if currentTFMinutes <= 15
    autoSRTimeframe := "240"     // 15ë¶„ë´‰ â†’ 4ì‹œê°„ë´‰ S/R
else if currentTFMinutes <= 60
    autoSRTimeframe := "D"       // 1ì‹œê°„ë´‰ â†’ ì¼ë´‰ S/R
else if currentTFMinutes <= 240
    autoSRTimeframe := "3D"      // 4ì‹œê°„ë´‰ â†’ 3ì¼ë´‰ S/R
else
    autoSRTimeframe := "W"       // ê·¸ ì´ìƒ â†’ ì£¼ë´‰ S/R

// ìµœì¢… S/R íƒ€ì„í”„ë ˆì„
srTimeframe = srAutoTimeframe ? autoSRTimeframe : srManualTimeframe

// ============================================
// HTF ì»¨íŒ ì„¤ì • (V27)
// ============================================
useHTFConfirm = input.bool(true, title="HTF ì¶”ì„¸ ì»¨íŒ", group="HTF ì„¤ì •")
htfTimeframe1 = input.timeframe("15", title="HTF 1 (15ë¶„)", group="HTF ì„¤ì •")
htfTimeframe2 = input.timeframe("60", title="HTF 2 (1ì‹œê°„)", group="HTF ì„¤ì •")

// ============================================
// HTF ê±°ë˜ëŸ‰ ì„¤ì • (V28)
// ============================================
useHTFVolumeConfirm = input.bool(true, title="HTF ê±°ë˜ëŸ‰ ì»¨íŒ", group="ê±°ë˜ëŸ‰ ì„¤ì •")
htfVolumeRatioMin = input.float(1.2, title="HTF ìµœì†Œ ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=0.8, maxval=3.0, step=0.1, group="ê±°ë˜ëŸ‰ ì„¤ì •")
currentTFVolumeMin = input.float(1.5, title="í˜„ì¬TF ìµœì†Œ ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=1.0, maxval=5.0, step=0.1, group="ê±°ë˜ëŸ‰ ì„¤ì •")

// ============================================
// ë ˆë²„ë¦¬ì§€ ì„¤ì •
// ============================================
leverageInput = input.int(5, title="ë ˆë²„ë¦¬ì§€", minval=1, maxval=50, step=1, group="TP/SL ì„¤ì •")
float leverageMultiplier = 5.0 / leverageInput

float baseTP1 = tradeMode == "ì„ ë¬¼" ? 0.8 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.2 : 1.5
float baseTP2 = tradeMode == "ì„ ë¬¼" ? 1.5 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 2.5 : 3.0
float baseSL = tradeMode == "ì„ ë¬¼" ? 0.6 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.0 : 1.2

float defaultTP1 = tradeMode == "ì„ ë¬¼" ? baseTP1 * leverageMultiplier : baseTP1
float defaultTP2 = tradeMode == "ì„ ë¬¼" ? baseTP2 * leverageMultiplier : baseTP2
float defaultSL = tradeMode == "ì„ ë¬¼" ? baseSL * leverageMultiplier : baseSL

defaultTP1 := math.max(0.3, math.min(defaultTP1, 5.0))
defaultTP2 := math.max(0.5, math.min(defaultTP2, 10.0))
defaultSL := math.max(0.15, math.min(defaultSL, 3.0))

useAutoTPSL = input.bool(true, title="ìë™ TP/SL", group="TP/SL ì„¤ì •")
manualTP1 = input.float(1.0, title="ìˆ˜ë™ TP1 (%)", minval=0.1, maxval=10.0, step=0.1, group="TP/SL ì„¤ì •")
manualTP2 = input.float(2.0, title="ìˆ˜ë™ TP2 (%)", minval=0.1, maxval=20.0, step=0.1, group="TP/SL ì„¤ì •")
manualSL = input.float(0.5, title="ìˆ˜ë™ SL (%)", minval=0.1, maxval=5.0, step=0.1, group="TP/SL ì„¤ì •")

float tpPct1 = useAutoTPSL ? defaultTP1 : manualTP1
float tpPct2 = useAutoTPSL ? defaultTP2 : manualTP2
float slPct = useAutoTPSL ? defaultSL : manualSL

// ============================================
// ì‹ í˜¸ í’ˆì§ˆ ì„¤ì • (V26)
// ============================================
minSignalStrength = input.int(17, title="ìµœì†Œ ì‹ í˜¸ ê°•ë„", minval=10, maxval=24, group="ì‹ í˜¸ ì„¤ì •")
minBarsBetweenSignals = input.int(5, title="ì‹ í˜¸ ìµœì†Œ ê°„ê²©", minval=3, maxval=20, group="ì‹ í˜¸ ì„¤ì •")
requireVolumeConfirm = input.bool(true, title="ê±°ë˜ëŸ‰ í™•ì¸ í•„ìˆ˜", group="ì‹ í˜¸ ì„¤ì •")

// ============================================
// ADX ì„¤ì • (V26)
// ============================================
useADXFilter = input.bool(true, title="ADX í•„í„°", group="ADX ì„¤ì •")
adxLength = input.int(14, title="ADX ê¸¸ì´", minval=7, maxval=30, group="ADX ì„¤ì •")
adxThreshold = input.float(20.0, title="ADX ì„ê³„ê°’", minval=15.0, maxval=35.0, step=1.0, group="ADX ì„¤ì •")

// ============================================
// ì´ë™í‰ê· ì„  (ë¶ˆì¥ë‹¨íƒ€ì™• ì œì™¸ - EMA ê¸°ë°˜)
// ============================================
ema9 = ta.ema(close, 9)
ema21 = ta.ema(close, 21)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)
vwap50 = ta.vwma(close, 50)

// ì¶”ì„¸ ì •ì˜
strongUptrend = ema9 > ema21 and ema21 > ema50 and close > ema200
strongDowntrend = ema9 < ema21 and ema21 < ema50 and close < ema200
isUptrend = ema9 > ema21 and close > ema50
isDowntrend = ema9 < ema21 and close < ema50

// ============================================
// ìë™ í•˜ë½ì¥ ê°ì§€ (SHORT ìë™ í™œì„±í™”ìš©)
// ============================================
// ì¡°ê±´: EMA200 ì•„ë˜ + ê°•í•œ í•˜ë½ ì¶”ì„¸ + 1ì‹œê°„ë´‰ bearish
// ì´ ì¡°ê±´ì´ ì¶©ì¡±ë˜ë©´ "í•˜ë½ì¥"ìœ¼ë¡œ íŒë‹¨
bool isMarketBearish = close < ema200 and ema50 < ema200 and strongDowntrend

// ============================================
// ADX (V26)
// ============================================
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)
noTrend = adx < adxThreshold
trendExists = adx >= adxThreshold
strongTrend = adx >= 25
veryStrongTrend = adx >= 30
bullishDI = diPlus > diMinus
bearishDI = diMinus > diPlus
diCrossUp = ta.crossover(diPlus, diMinus)
diCrossDown = ta.crossunder(diPlus, diMinus)

// ============================================
// RSI
// ============================================
rsi = ta.rsi(close, 14)
rsiOversold = rsi < 30
rsiOverbought = rsi > 70
rsiBullish = rsi > 50 and rsi < 70
rsiBearish = rsi < 50 and rsi > 30

// ============================================
// RSI ë‹¤ì´ë²„ì „ìŠ¤ (ìŠ¹ë¥  í–¥ìƒ)
// ============================================
// í”¼ë´‡ ê°ì§€ (5ë´‰ ê¸°ì¤€)
pivotLookback = 5
rsiPivotLow = ta.pivotlow(rsi, pivotLookback, pivotLookback)
rsiPivotHigh = ta.pivothigh(rsi, pivotLookback, pivotLookback)
pricePivotLow = ta.pivotlow(low, pivotLookback, pivotLookback)
pricePivotHigh = ta.pivothigh(high, pivotLookback, pivotLookback)

// ì´ì „ í”¼ë´‡ ì €ì¥
var float prevRsiLow = na
var float prevPriceLow = na
var float prevRsiHigh = na
var float prevPriceHigh = na

if not na(rsiPivotLow)
    prevRsiLow := rsiPivotLow[pivotLookback]
    prevPriceLow := pricePivotLow[pivotLookback]

if not na(rsiPivotHigh)
    prevRsiHigh := rsiPivotHigh[pivotLookback]
    prevPriceHigh := pricePivotHigh[pivotLookback]

// ìƒìŠ¹ ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²©ì€ ë” ë‚®ì€ ì €ì , RSIëŠ” ë” ë†’ì€ ì €ì 
bullishDivergence = not na(rsiPivotLow) and not na(prevRsiLow) and
     low[pivotLookback] < prevPriceLow and rsi[pivotLookback] > prevRsiLow and rsi[pivotLookback] < 40

// í•˜ë½ ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²©ì€ ë” ë†’ì€ ê³ ì , RSIëŠ” ë” ë‚®ì€ ê³ ì 
bearishDivergence = not na(rsiPivotHigh) and not na(prevRsiHigh) and
     high[pivotLookback] > prevPriceHigh and rsi[pivotLookback] < prevRsiHigh and rsi[pivotLookback] > 60

// ============================================
// Stochastic RSI (V26 ê°•í™”)
// ============================================
stochRsi = ta.stoch(rsi, rsi, rsi, 14)
stochK = ta.sma(stochRsi, 3)
stochD = ta.sma(stochK, 3)
stochOversold = stochK < 15
stochOverbought = stochK > 85
stochGoldenCross = ta.crossover(stochK, stochD) and stochK < 30
stochDeadCross = ta.crossunder(stochK, stochD) and stochK > 70

// ============================================
// MACD
// ============================================
[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
macdBullish = macdLine > signalLine and histogram > 0
macdBearish = macdLine < signalLine and histogram < 0
macdCrossUp = ta.crossover(macdLine, signalLine)
macdCrossDown = ta.crossunder(macdLine, signalLine)

// ============================================
// Bollinger Bands
// ============================================
bbBasis = ta.sma(close, 20)
bbDev = ta.stdev(close, 20)
bbUpper = bbBasis + 2 * bbDev
bbLower = bbBasis - 2 * bbDev
bbWidth = (bbUpper - bbLower) / bbBasis * 100
touchingBBLower = low <= bbLower
touchingBBUpper = high >= bbUpper
bbSqueeze = bbWidth < ta.sma(bbWidth, 20) * 0.7

// ============================================
// ìº”ë“¤ íŒ¨í„´ ë¶„ì„ (ìŠ¹ë¥  í–¥ìƒ)
// ============================================
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalRange = high - low
avgBody = ta.sma(bodySize, 14)

// ë§ì¹˜í˜• (Hammer) - í•˜ë½ í›„ ë°˜ì „ ì‹ í˜¸
isHammer = lowerWick > bodySize * 2 and upperWick < bodySize * 0.5 and close > open and low < low[1]

// ì—­ë§ì¹˜í˜• (Inverted Hammer) - í•˜ë½ í›„ ë°˜ì „ ì‹ í˜¸
isInvertedHammer = upperWick > bodySize * 2 and lowerWick < bodySize * 0.5 and low < low[1]

// ì¥ì•…í˜• (Engulfing)
isBullishEngulfing = close > open and close[1] < open[1] and close > open[1] and open < close[1] and bodySize > avgBody
isBearishEngulfing = close < open and close[1] > open[1] and close < open[1] and open > close[1] and bodySize > avgBody

// ë„ì§€ (Doji) - ë¶ˆí™•ì‹¤ì„±, ë°˜ì „ ê°€ëŠ¥
isDoji = bodySize < totalRange * 0.1 and totalRange > 0

// ìƒìŠ¹ ë°˜ì „ íŒ¨í„´
bullishCandlePattern = isHammer or isInvertedHammer or isBullishEngulfing
// í•˜ë½ ë°˜ì „ íŒ¨í„´
bearishCandlePattern = isBearishEngulfing or (isDoji and close[1] > open[1])

// ============================================
// ê±°ë˜ëŸ‰ ë¶„ì„ (V28)
// ============================================
avgVolume = ta.sma(volume, 20)
volumeRatio = volume / avgVolume
volumeConfirm = volumeRatio >= 1.0
highVolume = volumeRatio >= 1.5
veryHighVolume = volumeRatio >= 2.0
currentTFVolumeOK = volumeRatio >= currentTFVolumeMin

bullVolume = close > open ? volume : volume * (close - low) / math.max(high - low, 0.0001)
bearVolume = close < open ? volume : volume * (high - close) / math.max(high - low, 0.0001)
buyPressure = bullVolume / (bullVolume + bearVolume) * 100
strongBuyPressure = buyPressure > 65
strongSellPressure = buyPressure < 35

// ============================================
// HTF ê±°ë˜ëŸ‰ ì»¨íŒ (V28)
// ============================================
htf_volume = request.security(syminfo.tickerid, htfTimeframe1, volume, lookahead=barmerge.lookahead_off)
htf_avgVolume = request.security(syminfo.tickerid, htfTimeframe1, ta.sma(volume, 20), lookahead=barmerge.lookahead_off)
htf_volumeRatio = htf_volume / htf_avgVolume
htfVolumeOK = htf_volumeRatio >= htfVolumeRatioMin

htf_close = request.security(syminfo.tickerid, htfTimeframe1, close, lookahead=barmerge.lookahead_off)
htf_open = request.security(syminfo.tickerid, htfTimeframe1, open, lookahead=barmerge.lookahead_off)
htf_high = request.security(syminfo.tickerid, htfTimeframe1, high, lookahead=barmerge.lookahead_off)
htf_low = request.security(syminfo.tickerid, htfTimeframe1, low, lookahead=barmerge.lookahead_off)

htf_bullVolume = htf_close > htf_open ? htf_volume : htf_volume * (htf_close - htf_low) / math.max(htf_high - htf_low, 0.0001)
htf_bearVolume = htf_close < htf_open ? htf_volume : htf_volume * (htf_high - htf_close) / math.max(htf_high - htf_low, 0.0001)
htf_buyPressure = htf_bullVolume / (htf_bullVolume + htf_bearVolume) * 100
htf_strongBuyPressure = htf_buyPressure > 60
htf_strongSellPressure = htf_buyPressure < 40

bool volumeFullConfirm = true
if useHTFVolumeConfirm
    volumeFullConfirm := currentTFVolumeOK and htfVolumeOK
else
    volumeFullConfirm := volumeConfirm

// ============================================
// 3ì¼ë´‰ ì§€ì§€/ì €í•­ (V29)
// ============================================
sr_high = request.security(syminfo.tickerid, srTimeframe, high, lookahead=barmerge.lookahead_off)
sr_low = request.security(syminfo.tickerid, srTimeframe, low, lookahead=barmerge.lookahead_off)
sr_volume = request.security(syminfo.tickerid, srTimeframe, volume, lookahead=barmerge.lookahead_off)
sr_avgVolume = request.security(syminfo.tickerid, srTimeframe, ta.sma(volume, 20), lookahead=barmerge.lookahead_off)

sr_high_1 = request.security(syminfo.tickerid, srTimeframe, high[1], lookahead=barmerge.lookahead_off)
sr_low_1 = request.security(syminfo.tickerid, srTimeframe, low[1], lookahead=barmerge.lookahead_off)
sr_volume_1 = request.security(syminfo.tickerid, srTimeframe, volume[1], lookahead=barmerge.lookahead_off)

sr_high_2 = request.security(syminfo.tickerid, srTimeframe, high[2], lookahead=barmerge.lookahead_off)
sr_low_2 = request.security(syminfo.tickerid, srTimeframe, low[2], lookahead=barmerge.lookahead_off)
sr_volume_2 = request.security(syminfo.tickerid, srTimeframe, volume[2], lookahead=barmerge.lookahead_off)

sr_volRatio_0 = sr_volume / sr_avgVolume
sr_volRatio_1 = sr_volume_1 / sr_avgVolume
sr_volRatio_2 = sr_volume_2 / sr_avgVolume

// ê°€ì¥ ê°€ê¹Œìš´ ì €í•­/ì§€ì§€
float nearestResistance = na
float nearestResistanceStrength = 0.0
float nearestSupport = na
float nearestSupportStrength = 0.0

if sr_high > close
    nearestResistance := sr_high
    nearestResistanceStrength := sr_volRatio_0
if sr_high_1 > close and (na(nearestResistance) or sr_high_1 < nearestResistance)
    nearestResistance := sr_high_1
    nearestResistanceStrength := sr_volRatio_1
if sr_high_2 > close and (na(nearestResistance) or sr_high_2 < nearestResistance)
    nearestResistance := sr_high_2
    nearestResistanceStrength := sr_volRatio_2

if sr_low < close
    nearestSupport := sr_low
    nearestSupportStrength := sr_volRatio_0
if sr_low_1 < close and (na(nearestSupport) or sr_low_1 > nearestSupport)
    nearestSupport := sr_low_1
    nearestSupportStrength := sr_volRatio_1
if sr_low_2 < close and (na(nearestSupport) or sr_low_2 > nearestSupport)
    nearestSupport := sr_low_2
    nearestSupportStrength := sr_volRatio_2

float resistanceDistance = na(nearestResistance) ? na : (nearestResistance - close) / close * 100
float supportDistance = na(nearestSupport) ? na : (close - nearestSupport) / close * 100

bool nearResistance = not na(resistanceDistance) and resistanceDistance <= 0.5
bool nearSupport = not na(supportDistance) and supportDistance <= 0.5
bool isStrongResistance = nearestResistanceStrength >= srStrengthThreshold
bool isStrongSupport = nearestSupportStrength >= srStrengthThreshold

// ============================================
// HTF ì¶”ì„¸ ì»¨íŒ (V27)
// ============================================
htf1_ema20 = request.security(syminfo.tickerid, htfTimeframe1, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
htf1_ema50 = request.security(syminfo.tickerid, htfTimeframe1, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
htf1_rsi = request.security(syminfo.tickerid, htfTimeframe1, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

[htf1_diPlus, htf1_diMinus, htf1_adx_raw] = ta.dmi(14, 14)
htf1_diPlus_sec = request.security(syminfo.tickerid, htfTimeframe1, htf1_diPlus, lookahead=barmerge.lookahead_off)
htf1_diMinus_sec = request.security(syminfo.tickerid, htfTimeframe1, htf1_diMinus, lookahead=barmerge.lookahead_off)

[htf1_macdLine, htf1_signalLine, htf1_hist] = request.security(syminfo.tickerid, htfTimeframe1, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

htf1_bullish = htf1_ema20 > htf1_ema50 and htf1_rsi > 45 and htf1_rsi < 75 and htf1_macdLine > htf1_signalLine
htf1_bearish = htf1_ema20 < htf1_ema50 and htf1_rsi < 55 and htf1_rsi > 25 and htf1_macdLine < htf1_signalLine
htf1_bullDI = htf1_diPlus_sec > htf1_diMinus_sec
htf1_bearDI = htf1_diMinus_sec > htf1_diPlus_sec

htf2_ema20 = request.security(syminfo.tickerid, htfTimeframe2, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
htf2_ema50 = request.security(syminfo.tickerid, htfTimeframe2, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
htf2_rsi = request.security(syminfo.tickerid, htfTimeframe2, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

[htf2_diPlus, htf2_diMinus, htf2_adx_raw] = ta.dmi(14, 14)
htf2_diPlus_sec = request.security(syminfo.tickerid, htfTimeframe2, htf2_diPlus, lookahead=barmerge.lookahead_off)
htf2_diMinus_sec = request.security(syminfo.tickerid, htfTimeframe2, htf2_diMinus, lookahead=barmerge.lookahead_off)

[htf2_macdLine, htf2_signalLine, htf2_hist] = request.security(syminfo.tickerid, htfTimeframe2, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

htf2_bullish = htf2_ema20 > htf2_ema50 and htf2_rsi > 45 and htf2_rsi < 75 and htf2_macdLine > htf2_signalLine
htf2_bearish = htf2_ema20 < htf2_ema50 and htf2_rsi < 55 and htf2_rsi > 25 and htf2_macdLine < htf2_signalLine
htf2_bullDI = htf2_diPlus_sec > htf2_diMinus_sec
htf2_bearDI = htf2_diMinus_sec > htf2_diPlus_sec

htf1_longConfirm = htf1_bullish and htf1_bullDI
htf2_longConfirm = htf2_bullish and htf2_bullDI
htf1_shortConfirm = htf1_bearish and htf1_bearDI
htf2_shortConfirm = htf2_bearish and htf2_bearDI

bool htfLongConfirmed = htf1_longConfirm or htf2_longConfirm
bool htfShortConfirmed = htf1_shortConfirm or htf2_shortConfirm

// ============================================
// ì‹ í˜¸ ê°„ê²© ì¶”ì 
// ============================================
var int barsSinceLastLong = 999
var int barsSinceLastShort = 999
barsSinceLastLong := barsSinceLastLong + 1
barsSinceLastShort := barsSinceLastShort + 1
canSignalLong = barsSinceLastLong >= minBarsBetweenSignals
canSignalShort = barsSinceLastShort >= minBarsBetweenSignals

// ============================================
// ì ìˆ˜ ì‹œìŠ¤í…œ (ìµœëŒ€ 24ì )
// ============================================

// LONG ì ìˆ˜
var float trendScore = 0.0
trendScore := 0.0
if strongUptrend
    trendScore += 4
else if isUptrend
    trendScore += 2
if htf1_bullish
    trendScore += 2
if htf2_bullish
    trendScore += 2

var float momentumScore = 0.0
momentumScore := 0.0
if stochGoldenCross
    momentumScore += 3
else if stochOversold
    momentumScore += 2
if macdCrossUp or macdBullish
    momentumScore += 2
if rsiBullish
    momentumScore += 2
if diCrossUp or (bullishDI and trendExists)
    momentumScore += 1

var float volumeScore = 0.0
volumeScore := 0.0
if veryHighVolume and strongBuyPressure and htfVolumeOK and htf_strongBuyPressure
    volumeScore += 5
else if veryHighVolume and strongBuyPressure
    volumeScore += 4
else if highVolume and strongBuyPressure
    volumeScore += 3
else if volumeConfirm and buyPressure > 55
    volumeScore += 2
else if volumeConfirm
    volumeScore += 1

var float technicalScore = 0.0
technicalScore := 0.0
if touchingBBLower and stochOversold
    technicalScore += 2
if close > vwap50
    technicalScore += 1
if close > ema200
    technicalScore += 1

var float srScore = 0.0
srScore := 0.0
if nearSupport and isStrongSupport
    srScore += 2
else if nearSupport
    srScore += 1

// ìº”ë“¤ íŒ¨í„´ + ë‹¤ì´ë²„ì „ìŠ¤ ì ìˆ˜ (ìµœëŒ€ 4ì )
var float patternScore = 0.0
patternScore := 0.0
if bullishCandlePattern
    patternScore += 2
if bullishDivergence
    patternScore += 2

var float totalScore = 0.0
totalScore := trendScore + momentumScore + volumeScore + technicalScore + srScore + patternScore

// SHORT ì ìˆ˜
var float trendScoreShort = 0.0
trendScoreShort := 0.0
if strongDowntrend
    trendScoreShort += 4
else if isDowntrend
    trendScoreShort += 2
if htf1_bearish
    trendScoreShort += 2
if htf2_bearish
    trendScoreShort += 2

var float momentumScoreShort = 0.0
momentumScoreShort := 0.0
if stochDeadCross
    momentumScoreShort += 3
else if stochOverbought
    momentumScoreShort += 2
if macdCrossDown or macdBearish
    momentumScoreShort += 2
if rsiBearish
    momentumScoreShort += 2
if diCrossDown or (bearishDI and trendExists)
    momentumScoreShort += 1

var float volumeScoreShort = 0.0
volumeScoreShort := 0.0
if veryHighVolume and strongSellPressure and htfVolumeOK and htf_strongSellPressure
    volumeScoreShort += 5
else if veryHighVolume and strongSellPressure
    volumeScoreShort += 4
else if highVolume and strongSellPressure
    volumeScoreShort += 3
else if volumeConfirm and buyPressure < 45
    volumeScoreShort += 2
else if volumeConfirm
    volumeScoreShort += 1

var float technicalScoreShort = 0.0
technicalScoreShort := 0.0
if touchingBBUpper and stochOverbought
    technicalScoreShort += 2
if close < vwap50
    technicalScoreShort += 1
if close < ema200
    technicalScoreShort += 1

var float srScoreShort = 0.0
srScoreShort := 0.0
if nearResistance and isStrongResistance
    srScoreShort += 2
else if nearResistance
    srScoreShort += 1

// ìº”ë“¤ íŒ¨í„´ + ë‹¤ì´ë²„ì „ìŠ¤ ì ìˆ˜ (ìµœëŒ€ 4ì )
var float patternScoreShort = 0.0
patternScoreShort := 0.0
if bearishCandlePattern
    patternScoreShort += 2
if bearishDivergence
    patternScoreShort += 2

var float totalScoreShort = 0.0
totalScoreShort := trendScoreShort + momentumScoreShort + volumeScoreShort + technicalScoreShort + srScoreShort + patternScoreShort

// ============================================
// LONG ì‹ í˜¸ ì¡°ê±´ (V30.3 - ìŠ¹ë¥  60% ëª©í‘œ)
// ============================================
longBase = totalScore >= minSignalStrength
longBase := longBase and canSignalLong

// ê°•í•œ ìƒìŠ¹ ì¶”ì„¸ ë˜ëŠ” (ì¼ë°˜ ìƒìŠ¹ + ìº”ë“¤íŒ¨í„´/ë‹¤ì´ë²„ì „ìŠ¤)
bool trendCondition = strongUptrend or (isUptrend and (bullishCandlePattern or bullishDivergence))
longBase := longBase and trendCondition

if requireVolumeConfirm
    longBase := longBase and volumeFullConfirm
    // ë§¤ìˆ˜ ì••ë ¥ 55% ì´ìƒ
    longBase := longBase and (buyPressure > 55)

if useADXFilter
    // ADX íŠ¸ë Œë“œ ì¡´ì¬ + bullish DI
    longBase := longBase and trendExists and bullishDI

// ìŠ¤í† ìºìŠ¤í‹±: ê³¼ë§¤ë„ ë˜ëŠ” ê³¨ë“ í¬ë¡œìŠ¤ (ë” ì—„ê²©)
longBase := longBase and (stochOversold or stochGoldenCross)

if useHTFConfirm
    longBase := longBase and htfLongConfirmed

if useHTFVolumeConfirm
    longBase := longBase and (htf_buyPressure > 55)

// ì¶”ê°€ í•„í„°: EMA200 ìœ„ì—ì„œë§Œ ì§„ì…
longBase := longBase and (close > ema200)

longSignal_final = longBase

// ============================================
// SHORT ì‹ í˜¸ ì¡°ê±´ (V30.3 - ìë™ í•˜ë½ì¥ ê°ì§€)
// ============================================
// SHORT í™œì„±í™” ì¡°ê±´ ê²°ì • (ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸)
var bool enableShort = false
enableShort := false
if tradeMode == "ì„ ë¬¼"
    if shortMode == "í•­ìƒ ON"
        enableShort := true
    else if shortMode == "ìë™"
        // ìë™ ëª¨ë“œ: í•˜ë½ì¥ì—ì„œë§Œ SHORT í™œì„±í™”
        enableShort := isMarketBearish and htf2_bearish
    // "í•­ìƒ OFF"ëŠ” enableShort = false ìœ ì§€

shortBase = false
if enableShort
    // SHORTëŠ” ì‹ í˜¸ ê°•ë„ +1 ë” ë†’ê²Œ ìš”êµ¬
    shortBase := totalScoreShort >= (minSignalStrength + 1)
    shortBase := shortBase and canSignalShort
    // í•˜ë½ ì¶”ì„¸ í•„ìˆ˜ (ê°•í•œ ë˜ëŠ” ì¼ë°˜)
    shortBase := shortBase and isDowntrend

    if requireVolumeConfirm
        shortBase := shortBase and volumeFullConfirm

    if useADXFilter
        // íŠ¸ë Œë“œ ì¡´ì¬ + bearish DI
        shortBase := shortBase and trendExists and bearishDI

    // ìŠ¤í† ìºìŠ¤í‹± ì¡°ê±´ (ë°ë“œí¬ë¡œìŠ¤ ë˜ëŠ” ê³¼ë§¤ìˆ˜ ë˜ëŠ” í•˜ë½ì¤‘)
    shortBase := shortBase and (stochDeadCross or stochOverbought or (stochK > 60 and stochK < stochD))

    // HTF 1ì‹œê°„ë´‰ bearish í•„ìˆ˜ (15ë¶„ì€ ì˜µì…˜)
    shortBase := shortBase and htf2_bearish

    if useHTFVolumeConfirm
        // HTF ë§¤ë„ ì••ë ¥ (50% ë¯¸ë§Œ)
        shortBase := shortBase and (htf_buyPressure < 50)

shortSignal_final = shortBase

// ì‹ í˜¸ ë°œìƒì‹œ ì¹´ìš´í„° ë¦¬ì…‹
if longSignal_final
    barsSinceLastLong := 0
if shortSignal_final
    barsSinceLastShort := 0

// ============================================
// Strategy ì§„ì…/ì²­ì‚°
// ============================================
if longSignal_final and strategy.position_size == 0
    strategy.entry("LONG", strategy.long)

if shortSignal_final and strategy.position_size == 0
    strategy.entry("SHORT", strategy.short)

// LONG TP/SL
if strategy.position_size > 0
    longTP1Price = strategy.position_avg_price * (1 + tpPct1/100)
    longTP2Price = strategy.position_avg_price * (1 + tpPct2/100)
    longSLPrice = strategy.position_avg_price * (1 - slPct/100)
    strategy.exit("LONG TP1", "LONG", qty_percent=50, limit=longTP1Price, stop=longSLPrice)
    strategy.exit("LONG TP2", "LONG", limit=longTP2Price, stop=longSLPrice)

// SHORT TP/SL (ë¹ ë¥¸ ìµì ˆ, ë¹ ë¥¸ ì†ì ˆ)
if strategy.position_size < 0
    float shortTP1Pct = tpPct1 * 0.85
    float shortTP2Pct = tpPct2 * 0.9
    float shortSLPct = slPct * 0.7
    shortTP1Price = strategy.position_avg_price * (1 - shortTP1Pct/100)
    shortTP2Price = strategy.position_avg_price * (1 - shortTP2Pct/100)
    shortSLPrice = strategy.position_avg_price * (1 + shortSLPct/100)
    strategy.exit("SHORT TP1", "SHORT", qty_percent=50, limit=shortTP1Price, stop=shortSLPrice)
    strategy.exit("SHORT TP2", "SHORT", limit=shortTP2Price, stop=shortSLPrice)

// ============================================
// ì°¨íŠ¸ í‘œì‹œ
// ============================================
plot(ema21, color=color.new(color.orange, 0), linewidth=2, title="EMA 21")
plot(ema50, color=color.new(color.blue, 0), linewidth=2, title="EMA 50")
plot(ema200, color=color.new(color.purple, 0), linewidth=2, title="EMA 200")
plot(bbUpper, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(bbLower, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")

plotshape(longSignal_final, style=shape.triangleup, location=location.belowbar, color=color.new(color.green, 0), size=size.normal, title="LONG")
plotshape(shortSignal_final, style=shape.triangledown, location=location.abovebar, color=color.new(color.red, 0), size=size.normal, title="SHORT")

bgcolor(strongUptrend ? color.new(color.green, 92) : strongDowntrend ? color.new(color.red, 92) : na)
bgcolor(bbSqueeze ? color.new(color.yellow, 90) : na, title="BB Squeeze")

// ============================================
// S/R ë¼ì¸ í‘œì‹œ (V29)
// ============================================
var line resistanceLine = na
var line supportLine = na
var label resistanceLabel = na
var label supportLabel = na

if showSRLevels and barstate.islast
    // ê¸°ì¡´ ë¼ì¸/ë¼ë²¨ ì‚­ì œ
    if not na(resistanceLine)
        line.delete(resistanceLine)
    if not na(supportLine)
        line.delete(supportLine)
    if not na(resistanceLabel)
        label.delete(resistanceLabel)
    if not na(supportLabel)
        label.delete(supportLabel)

    // ì €í•­ì„ 
    if not na(nearestResistance)
        resistanceLine := line.new(bar_index - 50, nearestResistance, bar_index + 10, nearestResistance, color=isStrongResistance ? color.red : color.new(color.red, 50), width=isStrongResistance ? 2 : 1, style=line.style_dashed)
        resistanceLabel := label.new(bar_index + 5, nearestResistance, "R: " + str.tostring(nearestResistance, "#.#"), style=label.style_label_left, color=color.new(color.red, 80), textcolor=color.red, size=size.small)

    // ì§€ì§€ì„ 
    if not na(nearestSupport)
        supportLine := line.new(bar_index - 50, nearestSupport, bar_index + 10, nearestSupport, color=isStrongSupport ? color.green : color.new(color.green, 50), width=isStrongSupport ? 2 : 1, style=line.style_dashed)
        supportLabel := label.new(bar_index + 5, nearestSupport, "S: " + str.tostring(nearestSupport, "#.#"), style=label.style_label_left, color=color.new(color.green, 80), textcolor=color.green, size=size.small)

// ============================================
// ì‹ í˜¸ ë¼ë²¨ í‘œì‹œ
// ============================================
if longSignal_final
    label.new(bar_index, low, "LONG\n" + str.tostring(totalScore, "#.#"), style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

if shortSignal_final
    label.new(bar_index, high, "SHORT\n" + str.tostring(totalScoreShort, "#.#"), style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

// ============================================
// TP/SL ë¼ì¸ í‘œì‹œ (í¬ì§€ì…˜ ì§„ì…ì‹œ)
// ============================================
var line longTP1Line = na
var line longTP2Line = na
var line longSLLine = na
var line shortTP1Line = na
var line shortTP2Line = na
var line shortSLLine = na
var label longTP1Label = na
var label longTP2Label = na
var label longSLLabel = na
var label shortTP1Label = na
var label shortTP2Label = na
var label shortSLLabel = na

// ì´ì „ ë¼ì¸ ì‚­ì œ í•¨ìˆ˜ ëŒ€ì‹  ì§ì ‘ ì²˜ë¦¬
if strategy.position_size == 0
    // í¬ì§€ì…˜ ì—†ìœ¼ë©´ ë¼ì¸ ì‚­ì œ
    if not na(longTP1Line)
        line.delete(longTP1Line)
        longTP1Line := na
    if not na(longTP2Line)
        line.delete(longTP2Line)
        longTP2Line := na
    if not na(longSLLine)
        line.delete(longSLLine)
        longSLLine := na
    if not na(shortTP1Line)
        line.delete(shortTP1Line)
        shortTP1Line := na
    if not na(shortTP2Line)
        line.delete(shortTP2Line)
        shortTP2Line := na
    if not na(shortSLLine)
        line.delete(shortSLLine)
        shortSLLine := na
    if not na(longTP1Label)
        label.delete(longTP1Label)
        longTP1Label := na
    if not na(longTP2Label)
        label.delete(longTP2Label)
        longTP2Label := na
    if not na(longSLLabel)
        label.delete(longSLLabel)
        longSLLabel := na
    if not na(shortTP1Label)
        label.delete(shortTP1Label)
        shortTP1Label := na
    if not na(shortTP2Label)
        label.delete(shortTP2Label)
        shortTP2Label := na
    if not na(shortSLLabel)
        label.delete(shortSLLabel)
        shortSLLabel := na

// LONG í¬ì§€ì…˜ TP/SL ë¼ì¸
if strategy.position_size > 0
    float lTP1 = strategy.position_avg_price * (1 + tpPct1/100)
    float lTP2 = strategy.position_avg_price * (1 + tpPct2/100)
    float lSL = strategy.position_avg_price * (1 - slPct/100)

    if na(longTP1Line)
        longTP1Line := line.new(bar_index - 20, lTP1, bar_index + 10, lTP1, color=color.lime, width=2, style=line.style_dotted)
        longTP2Line := line.new(bar_index - 20, lTP2, bar_index + 10, lTP2, color=color.green, width=2, style=line.style_dotted)
        longSLLine := line.new(bar_index - 20, lSL, bar_index + 10, lSL, color=color.red, width=2, style=line.style_dotted)
        longTP1Label := label.new(bar_index + 8, lTP1, "TP1: " + str.tostring(lTP1, "#.#"), style=label.style_label_left, color=color.new(color.lime, 70), textcolor=color.lime, size=size.tiny)
        longTP2Label := label.new(bar_index + 8, lTP2, "TP2: " + str.tostring(lTP2, "#.#"), style=label.style_label_left, color=color.new(color.green, 70), textcolor=color.green, size=size.tiny)
        longSLLabel := label.new(bar_index + 8, lSL, "SL: " + str.tostring(lSL, "#.#"), style=label.style_label_left, color=color.new(color.red, 70), textcolor=color.red, size=size.tiny)
    else
        line.set_xy1(longTP1Line, bar_index - 20, lTP1)
        line.set_xy2(longTP1Line, bar_index + 10, lTP1)
        line.set_xy1(longTP2Line, bar_index - 20, lTP2)
        line.set_xy2(longTP2Line, bar_index + 10, lTP2)
        line.set_xy1(longSLLine, bar_index - 20, lSL)
        line.set_xy2(longSLLine, bar_index + 10, lSL)
        label.set_xy(longTP1Label, bar_index + 8, lTP1)
        label.set_xy(longTP2Label, bar_index + 8, lTP2)
        label.set_xy(longSLLabel, bar_index + 8, lSL)

// SHORT í¬ì§€ì…˜ TP/SL ë¼ì¸
if strategy.position_size < 0
    float sTP1Pct = tpPct1 * 0.85
    float sTP2Pct = tpPct2 * 0.9
    float sSLPct = slPct * 0.7
    float sTP1 = strategy.position_avg_price * (1 - sTP1Pct/100)
    float sTP2 = strategy.position_avg_price * (1 - sTP2Pct/100)
    float sSL = strategy.position_avg_price * (1 + sSLPct/100)

    if na(shortTP1Line)
        shortTP1Line := line.new(bar_index - 20, sTP1, bar_index + 10, sTP1, color=color.lime, width=2, style=line.style_dotted)
        shortTP2Line := line.new(bar_index - 20, sTP2, bar_index + 10, sTP2, color=color.green, width=2, style=line.style_dotted)
        shortSLLine := line.new(bar_index - 20, sSL, bar_index + 10, sSL, color=color.red, width=2, style=line.style_dotted)
        shortTP1Label := label.new(bar_index + 8, sTP1, "TP1: " + str.tostring(sTP1, "#.#"), style=label.style_label_left, color=color.new(color.lime, 70), textcolor=color.lime, size=size.tiny)
        shortTP2Label := label.new(bar_index + 8, sTP2, "TP2: " + str.tostring(sTP2, "#.#"), style=label.style_label_left, color=color.new(color.green, 70), textcolor=color.green, size=size.tiny)
        shortSLLabel := label.new(bar_index + 8, sSL, "SL: " + str.tostring(sSL, "#.#"), style=label.style_label_left, color=color.new(color.red, 70), textcolor=color.red, size=size.tiny)
    else
        line.set_xy1(shortTP1Line, bar_index - 20, sTP1)
        line.set_xy2(shortTP1Line, bar_index + 10, sTP1)
        line.set_xy1(shortTP2Line, bar_index - 20, sTP2)
        line.set_xy2(shortTP2Line, bar_index + 10, sTP2)
        line.set_xy1(shortSLLine, bar_index - 20, sSL)
        line.set_xy2(shortSLLine, bar_index + 10, sSL)
        label.set_xy(shortTP1Label, bar_index + 8, sTP1)
        label.set_xy(shortTP2Label, bar_index + 8, sTP2)
        label.set_xy(shortSLLabel, bar_index + 8, sSL)

// ============================================
// ì •ë³´ í…Œì´ë¸”
// ============================================
var table infoTable = table.new(position.top_right, 2, 20, bgcolor=color.new(color.white, 10), border_width=1)

string modeEmoji = tradeMode == "ì„ ë¬¼" ? "F" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "S" : "K"
color modeColor = tradeMode == "ì„ ë¬¼" ? color.purple : tradeMode == "í˜„ë¬¼ì½”ì¸" ? color.orange : color.blue
string htf1_status = htf1_bullish ? "BULL" : htf1_bearish ? "BEAR" : "FLAT"
color htf1_tableColor = htf1_bullish ? color.green : htf1_bearish ? color.red : color.gray
string htf2_status = htf2_bullish ? "BULL" : htf2_bearish ? "BEAR" : "FLAT"
color htf2_tableColor = htf2_bullish ? color.green : htf2_bearish ? color.red : color.gray
string adxStatus = veryStrongTrend ? "STRONG" : strongTrend ? "TREND" : trendExists ? "OK" : "RANGE"
color adxTableColor = veryStrongTrend ? color.green : strongTrend ? color.blue : trendExists ? color.teal : color.red
string trendStatus = strongUptrend ? "UP" : strongDowntrend ? "DOWN" : isUptrend ? "up" : isDowntrend ? "down" : "FLAT"
color trendColor = strongUptrend or isUptrend ? color.green : strongDowntrend or isDowntrend ? color.red : color.gray
string finalText = longSignal_final ? "LONG" : shortSignal_final ? "SHORT" : "WAIT"
color finalColor = longSignal_final ? color.green : shortSignal_final ? color.red : color.gray

if barstate.islast
    table.clear(infoTable, 0, 0, 1, 19)
    table.cell(infoTable, 0, 0, "[" + modeEmoji + "] V30", text_color=color.white, text_size=size.normal, bgcolor=color.new(modeColor, 20))
    table.cell(infoTable, 1, 0, str.tostring(leverageInput) + "x", text_color=color.white, text_size=size.normal, bgcolor=color.new(modeColor, 20))
    table.cell(infoTable, 0, 1, "Score", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(totalScore, "#.#") + "/28", text_color=totalScore >= minSignalStrength ? color.green : color.gray, text_size=size.small)
    table.cell(infoTable, 0, 2, "15m", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 2, htf1_status, text_color=htf1_tableColor, text_size=size.small)
    table.cell(infoTable, 0, 3, "1H", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 3, htf2_status, text_color=htf2_tableColor, text_size=size.small)
    table.cell(infoTable, 0, 4, "ADX", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 4, adxStatus + " (" + str.tostring(adx, "#.#") + ")", text_color=adxTableColor, text_size=size.small)
    table.cell(infoTable, 0, 5, "Trend", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 5, trendStatus, text_color=trendColor, text_size=size.small)
    table.cell(infoTable, 0, 6, "Vol", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 6, str.tostring(volumeRatio, "#.#") + "x", text_color=volumeRatio >= 1.5 ? color.green : color.gray, text_size=size.small)
    table.cell(infoTable, 0, 7, "RSI", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 7, str.tostring(rsi, "#.#"), text_color=rsi < 30 ? color.green : rsi > 70 ? color.red : color.gray, text_size=size.small)
    table.cell(infoTable, 0, 8, "StochK", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 8, str.tostring(stochK, "#.#"), text_color=stochK < 20 ? color.green : stochK > 80 ? color.red : color.gray, text_size=size.small)
    table.cell(infoTable, 0, 9, "S/R TF", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 9, srTimeframe, text_color=color.blue, text_size=size.small)
    table.cell(infoTable, 0, 10, "R1", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 10, na(nearestResistance) ? "N/A" : "$" + str.tostring(nearestResistance, "#.#"), text_color=isStrongResistance ? color.red : color.gray, text_size=size.small)
    table.cell(infoTable, 0, 11, "S1", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 11, na(nearestSupport) ? "N/A" : "$" + str.tostring(nearestSupport, "#.#"), text_color=isStrongSupport ? color.green : color.gray, text_size=size.small)
    table.cell(infoTable, 0, 12, "SIGNAL", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 30))
    table.cell(infoTable, 1, 12, finalText, text_color=finalColor, text_size=size.small, bgcolor=color.new(color.gray, 30))

    // TP/SL ê°€ê²© í‘œì‹œ (ì‹œê·¸ë„ ë°œìƒ ì‹œì—ë§Œ)
    table.cell(infoTable, 0, 13, "TP1", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 0, 14, "TP2", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 0, 15, "SL", text_color=color.black, text_size=size.small)

    if longSignal_final
        float displayTP1 = close * (1 + tpPct1/100)
        float displayTP2 = close * (1 + tpPct2/100)
        float displaySL = close * (1 - slPct/100)
        table.cell(infoTable, 1, 13, str.tostring(displayTP1, "#.#") + " (+" + str.tostring(tpPct1, "#.##") + "%)", text_color=color.green, text_size=size.small)
        table.cell(infoTable, 1, 14, str.tostring(displayTP2, "#.#") + " (+" + str.tostring(tpPct2, "#.##") + "%)", text_color=color.teal, text_size=size.small)
        table.cell(infoTable, 1, 15, str.tostring(displaySL, "#.#") + " (-" + str.tostring(slPct, "#.##") + "%)", text_color=color.red, text_size=size.small)
    else if shortSignal_final
        float sTP1Pct = tpPct1 * 0.85
        float sTP2Pct = tpPct2 * 0.9
        float sSLPct = slPct * 0.7
        float displayTP1 = close * (1 - sTP1Pct/100)
        float displayTP2 = close * (1 - sTP2Pct/100)
        float displaySL = close * (1 + sSLPct/100)
        table.cell(infoTable, 1, 13, str.tostring(displayTP1, "#.#") + " (-" + str.tostring(sTP1Pct, "#.##") + "%)", text_color=color.green, text_size=size.small)
        table.cell(infoTable, 1, 14, str.tostring(displayTP2, "#.#") + " (-" + str.tostring(sTP2Pct, "#.##") + "%)", text_color=color.teal, text_size=size.small)
        table.cell(infoTable, 1, 15, str.tostring(displaySL, "#.#") + " (+" + str.tostring(sSLPct, "#.##") + "%)", text_color=color.red, text_size=size.small)
    else if strategy.position_size > 0
        float displayTP1 = strategy.position_avg_price * (1 + tpPct1/100)
        float displayTP2 = strategy.position_avg_price * (1 + tpPct2/100)
        float displaySL = strategy.position_avg_price * (1 - slPct/100)
        table.cell(infoTable, 1, 13, str.tostring(displayTP1, "#.#"), text_color=color.green, text_size=size.small)
        table.cell(infoTable, 1, 14, str.tostring(displayTP2, "#.#"), text_color=color.teal, text_size=size.small)
        table.cell(infoTable, 1, 15, str.tostring(displaySL, "#.#"), text_color=color.red, text_size=size.small)
    else if strategy.position_size < 0
        float sTP1Pct = tpPct1 * 0.85
        float sTP2Pct = tpPct2 * 0.9
        float sSLPct = slPct * 0.7
        float displayTP1 = strategy.position_avg_price * (1 - sTP1Pct/100)
        float displayTP2 = strategy.position_avg_price * (1 - sTP2Pct/100)
        float displaySL = strategy.position_avg_price * (1 + sSLPct/100)
        table.cell(infoTable, 1, 13, str.tostring(displayTP1, "#.#"), text_color=color.green, text_size=size.small)
        table.cell(infoTable, 1, 14, str.tostring(displayTP2, "#.#"), text_color=color.teal, text_size=size.small)
        table.cell(infoTable, 1, 15, str.tostring(displaySL, "#.#"), text_color=color.red, text_size=size.small)
    else
        table.cell(infoTable, 1, 13, "-", text_color=color.gray, text_size=size.small)
        table.cell(infoTable, 1, 14, "-", text_color=color.gray, text_size=size.small)
        table.cell(infoTable, 1, 15, "-", text_color=color.gray, text_size=size.small)

    // ìº”ë“¤ íŒ¨í„´ ìƒíƒœ
    string patternStatus = bullishCandlePattern ? "BULL" : bearishCandlePattern ? "BEAR" : "-"
    color patternColor = bullishCandlePattern ? color.green : bearishCandlePattern ? color.red : color.gray
    table.cell(infoTable, 0, 16, "Pattern", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 16, patternStatus, text_color=patternColor, text_size=size.small)

    // ì‹œì¥ ìƒíƒœ & SHORT í™œì„±í™” í‘œì‹œ
    string marketStatus = isMarketBearish ? "BEAR" : strongUptrend ? "BULL" : "NEUTRAL"
    color marketColor = isMarketBearish ? color.red : strongUptrend ? color.green : color.gray
    table.cell(infoTable, 0, 17, "Market", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 17, marketStatus, text_color=marketColor, text_size=size.small)

    string shortStatus = enableShort ? "ON" : "OFF"
    color shortStatusColor = enableShort ? color.orange : color.gray
    table.cell(infoTable, 0, 18, "SHORT", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 18, shortStatus, text_color=shortStatusColor, text_size=size.small)

// ============================================
// Webhook ì•Œë¦¼ (ë³´ê¸° ì¢‹ì€ í˜•ì‹)
// ============================================
float longTp1 = close * (1 + tpPct1/100)
float longTp2 = close * (1 + tpPct2/100)
float longSl = close * (1 - slPct/100)
float shortTp1 = close * (1 - tpPct1 * 0.85/100)
float shortTp2 = close * (1 - tpPct2 * 0.9/100)
float shortSl = close * (1 + slPct * 0.7/100)

if longSignal_final
    string alertMsg = "ğŸŸ¢ LONG ì‹œê·¸ë„\n" +
         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
         "ğŸ“Š " + syminfo.basecurrency + "-USDT | " + tradeMode + " " + str.tostring(leverageInput) + "x\n" +
         "ğŸ’° ì§„ì…ê°€: $" + str.tostring(close, "#.##") + "\n" +
         "ğŸ¯ TP1: $" + str.tostring(longTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.##") + "%)\n" +
         "ğŸ¯ TP2: $" + str.tostring(longTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.##") + "%)\n" +
         "ğŸ›‘ SL: $" + str.tostring(longSl, "#.##") + " (-" + str.tostring(slPct, "#.##") + "%)\n" +
         "â­ ì ìˆ˜: " + str.tostring(totalScore, "#.#") + "/28"
    alert(alertMsg, freq=alert.freq_once_per_bar)

if shortSignal_final
    float sTP1Pct = tpPct1 * 0.85
    float sTP2Pct = tpPct2 * 0.9
    float sSLPct = slPct * 0.7
    string alertMsg = "ğŸ”´ SHORT ì‹œê·¸ë„\n" +
         "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
         "ğŸ“Š " + syminfo.basecurrency + "-USDT | " + tradeMode + " " + str.tostring(leverageInput) + "x\n" +
         "ğŸ’° ì§„ì…ê°€: $" + str.tostring(close, "#.##") + "\n" +
         "ğŸ¯ TP1: $" + str.tostring(shortTp1, "#.##") + " (-" + str.tostring(sTP1Pct, "#.##") + "%)\n" +
         "ğŸ¯ TP2: $" + str.tostring(shortTp2, "#.##") + " (-" + str.tostring(sTP2Pct, "#.##") + "%)\n" +
         "ğŸ›‘ SL: $" + str.tostring(shortSl, "#.##") + " (+" + str.tostring(sSLPct, "#.##") + "%)\n" +
         "â­ ì ìˆ˜: " + str.tostring(totalScoreShort, "#.#") + "/28"
    alert(alertMsg, freq=alert.freq_once_per_bar)
