//@version=5
indicator("í´ë¡œë“œ21 ë©€í‹°TF + StochRSI (Indicator)", overlay=true, max_labels_count=100)

// ======================== ê°œì„ ëœ ì…ë ¥ ë³€ìˆ˜ ========================
leverageInput = input.int(5, title="ë ˆë²„ë¦¬ì§€", minval=1, maxval=20)
riskPercentInput = input.float(20.0, title="íˆ¬ì… ë¹„ìœ¨ (%)", minval=1.0, maxval=100.0)
tpPct1 = input.float(0.8, title="TP1 ìˆ˜ìµë¥  (%)", minval=0.1, maxval=5.0, step=0.1)
tpPct2 = input.float(1.5, title="TP2 ìˆ˜ìµë¥  (%)", minval=0.1, maxval=5.0, step=0.1)
slPct = input.float(0.3, title="ì†ì ˆ ë¹„ìœ¨ (%)", minval=0.05, maxval=2.0, step=0.05)

// ë©€í‹°íƒ€ì„í”„ë ˆì„ í™œì„±í™” ì˜µì…˜
useMultiTF = input.bool(true, title="ë©€í‹°íƒ€ì„í”„ë ˆì„ í•„í„° ì‚¬ìš©")
strictMode = input.bool(true, title="ì—„ê²© ëª¨ë“œ (ëª¨ë“  ì¡°ê±´ ë§Œì¡±)")

// ğŸ†• Stochastic RSI ì„¤ì •
useStochRSI = input.bool(true, title="ğŸ†• Stochastic RSI í•„í„° ì‚¬ìš©", group="Stochastic RSI")
stochRSI_length = input.int(14, title="RSI ê¸°ê°„", minval=1, group="Stochastic RSI")
stochRSI_smoothK = input.int(3, title="K í‰í™œí™”", minval=1, group="Stochastic RSI")
stochRSI_smoothD = input.int(3, title="D í‰í™œí™”", minval=1, group="Stochastic RSI")
stochRSI_overbought = input.float(80, title="ê³¼ë§¤ìˆ˜ ë ˆë²¨", minval=50, maxval=100, group="Stochastic RSI")
stochRSI_oversold = input.float(20, title="ê³¼ë§¤ë„ ë ˆë²¨", minval=0, maxval=50, group="Stochastic RSI")

// ======================== Stochastic RSI ê³„ì‚° ========================
// í˜„ì¬ ì°¨íŠ¸ (1ë¶„ë´‰) Stochastic RSI
rsi_for_stoch = ta.rsi(close, stochRSI_length)
stoch_k = ta.stoch(rsi_for_stoch, rsi_for_stoch, rsi_for_stoch, stochRSI_length)
stochRSI_k = ta.sma(stoch_k, stochRSI_smoothK)
stochRSI_d = ta.sma(stochRSI_k, stochRSI_smoothD)

// 5ë¶„ë´‰ Stochastic RSI (ì¶”ê°€ í™•ì¸ìš©)
rsi_5m_for_stoch = request.security(syminfo.tickerid, "5", ta.rsi(close, stochRSI_length), lookahead=barmerge.lookahead_off)
stoch_k_5m = request.security(syminfo.tickerid, "5", ta.stoch(ta.rsi(close, stochRSI_length), ta.rsi(close, stochRSI_length), ta.rsi(close, stochRSI_length), stochRSI_length), lookahead=barmerge.lookahead_off)
stochRSI_k_5m = ta.sma(stoch_k_5m, stochRSI_smoothK)

// Stochastic RSI ì‹ í˜¸
stochRSI_bullish = stochRSI_k < stochRSI_oversold or (stochRSI_k > stochRSI_k[1] and stochRSI_k < 50)  // ê³¼ë§¤ë„ êµ¬ê°„ ë˜ëŠ” ìƒìŠ¹ ì¤‘
stochRSI_bearish = stochRSI_k > stochRSI_overbought or (stochRSI_k < stochRSI_k[1] and stochRSI_k > 50)  // ê³¼ë§¤ìˆ˜ êµ¬ê°„ ë˜ëŠ” í•˜ë½ ì¤‘
stochRSI_golden_cross = ta.crossover(stochRSI_k, stochRSI_d)  // ê³¨ë“  í¬ë¡œìŠ¤
stochRSI_death_cross = ta.crossunder(stochRSI_k, stochRSI_d)  // ë°ë“œ í¬ë¡œìŠ¤

// ======================== ë©€í‹°íƒ€ì„í”„ë ˆì„ ë°ì´í„° ========================
// 15ë¶„ë´‰ - ì£¼ìš” íŠ¸ë Œë“œ ë°©í–¥
ema20_15m = request.security(syminfo.tickerid, "15", ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_15m = request.security(syminfo.tickerid, "15", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
rsi_15m = request.security(syminfo.tickerid, "15", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

// 5ë¶„ë´‰ - ì¤‘ê°„ íŠ¸ë Œë“œ í™•ì¸
ema20_5m = request.security(syminfo.tickerid, "5", ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_5m = request.security(syminfo.tickerid, "5", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_5m, signalLine_5m, histogram_5m] = request.security(syminfo.tickerid, "5", ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)
rsi_5m = request.security(syminfo.tickerid, "5", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

// 3ë¶„ë´‰ - ì •í™•í•œ ì§„ì…ì 
ema20_3m = request.security(syminfo.tickerid, "3", ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_3m = request.security(syminfo.tickerid, "3", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_3m, signalLine_3m, histogram_3m] = request.security(syminfo.tickerid, "3", ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

// í˜„ì¬ ì°¨íŠ¸ (1ë¶„ë´‰) ë³´ì¡° ì§€í‘œ
rsi_1m = ta.rsi(close, 14)
vwma_1m = ta.vwma(close, 20)

// ======================== íŠ¸ë Œë“œ ë°©í–¥ ë¶„ì„ ========================
// 15ë¶„ë´‰ ì£¼ìš” íŠ¸ë Œë“œ
trend_15m_bullish = ema20_15m > ema50_15m and rsi_15m > 45 and rsi_15m < 70
trend_15m_bearish = ema20_15m < ema50_15m and rsi_15m > 30 and rsi_15m < 55

// 5ë¶„ë´‰ ì¤‘ê°„ íŠ¸ë Œë“œ
trend_5m_bullish = ema20_5m > ema50_5m and macdLine_5m > macdLine_5m[1] and rsi_5m > 40
trend_5m_bearish = ema20_5m < ema50_5m and macdLine_5m < macdLine_5m[1] and rsi_5m < 60

// 3ë¶„ë´‰ ì§„ì… ì‹ í˜¸
signal_3m_long = ta.crossover(ema20_3m, ema50_3m) and macdLine_3m > signalLine_3m
signal_3m_short = ta.crossunder(ema20_3m, ema50_3m) and macdLine_3m < signalLine_3m

// ======================== ë©€í‹°íƒ€ì„í”„ë ˆì„ ì‹ í˜¸ ì¡°í•© + StochRSI ========================
// LONG ì‹ í˜¸ (ëª¨ë“  íƒ€ì„í”„ë ˆì„ ì •ë ¬ + StochRSI í™•ì¸)
longSignal_basic = signal_3m_long and rsi_1m > 35 and rsi_1m < 65 and close > vwma_1m

// ğŸ†• Stochastic RSI ì¡°ê±´ ì¶”ê°€
longSignal_stochRSI = if useStochRSI
    // LONG ì¡°ê±´: ê³¼ë§¤ë„ êµ¬ê°„ì—ì„œ ë°˜ë“± ë˜ëŠ” ê³¨ë“ í¬ë¡œìŠ¤
    (stochRSI_k < stochRSI_oversold or stochRSI_golden_cross or (stochRSI_k > stochRSI_k[1] and stochRSI_k < 50)) and
    not (stochRSI_k > stochRSI_overbought)  // ê³¼ë§¤ìˆ˜ êµ¬ê°„ íšŒí”¼
else
    true

longSignal_filtered = if useMultiTF
    if strictMode
        // ì—„ê²© ëª¨ë“œ: ëª¨ë“  ì¡°ê±´ ë§Œì¡±
        longSignal_basic and trend_15m_bullish and trend_5m_bullish and longSignal_stochRSI
    else
        // ì™„í™” ëª¨ë“œ: 15ë¶„ ë˜ëŠ” 5ë¶„ ì¤‘ í•˜ë‚˜ë§Œ ë§Œì¡±
        longSignal_basic and (trend_15m_bullish or trend_5m_bullish) and longSignal_stochRSI
else
    longSignal_basic and longSignal_stochRSI

// SHORT ì‹ í˜¸ (ëª¨ë“  íƒ€ì„í”„ë ˆì„ ì •ë ¬ + StochRSI í™•ì¸)
shortSignal_basic = signal_3m_short and rsi_1m > 35 and rsi_1m < 65 and close < vwma_1m

// ğŸ†• Stochastic RSI ì¡°ê±´ ì¶”ê°€
shortSignal_stochRSI = if useStochRSI
    // SHORT ì¡°ê±´: ê³¼ë§¤ìˆ˜ êµ¬ê°„ì—ì„œ í•˜ë½ ë˜ëŠ” ë°ë“œí¬ë¡œìŠ¤
    (stochRSI_k > stochRSI_overbought or stochRSI_death_cross or (stochRSI_k < stochRSI_k[1] and stochRSI_k > 50)) and
    not (stochRSI_k < stochRSI_oversold)  // ê³¼ë§¤ë„ êµ¬ê°„ íšŒí”¼
else
    true

shortSignal_filtered = if useMultiTF
    if strictMode
        // ì—„ê²© ëª¨ë“œ: ëª¨ë“  ì¡°ê±´ ë§Œì¡±
        shortSignal_basic and trend_15m_bearish and trend_5m_bearish and shortSignal_stochRSI
    else
        // ì™„í™” ëª¨ë“œ: 15ë¶„ ë˜ëŠ” 5ë¶„ ì¤‘ í•˜ë‚˜ë§Œ ë§Œì¡±
        shortSignal_basic and (trend_15m_bearish or trend_5m_bearish) and shortSignal_stochRSI
else
    shortSignal_basic and shortSignal_stochRSI

// ======================== ì°¨íŠ¸ í‘œì‹œ ========================
plotshape(longSignal_filtered, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.normal, title="ë©€í‹°TF LONG")
plotshape(shortSignal_filtered, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.normal, title="ë©€í‹°TF SHORT")

// í•„í„°ë§ëœ ì‹ í˜¸ í‘œì‹œ
plotshape(longSignal_basic and not longSignal_filtered, style=shape.circle, location=location.belowbar, color=color.gray, size=size.tiny, title="í•„í„°ë§ëœ LONG")
plotshape(shortSignal_basic and not shortSignal_filtered, style=shape.circle, location=location.abovebar, color=color.gray, size=size.tiny, title="í•„í„°ë§ëœ SHORT")

// EMA ë¼ì¸ í‘œì‹œ
plot(ema20_15m, color=color.blue, linewidth=1, title="EMA20 (15m)")
plot(ema50_15m, color=color.red, linewidth=1, title="EMA50 (15m)")

// ======================== ì‹ í˜¸ ë°œìƒ ì‹œ TP/SL ê³„ì‚° ë° í‘œì‹œ ========================
var label timeLabel = na
var line tp1Line = na
var line tp2Line = na
var line slLine = na

if longSignal_filtered
    if not na(timeLabel)
        label.delete(timeLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 + tpPct1/100)
    float labelTp2 = close * (1 + tpPct2/100)
    float labelSl = close * (1 - slPct/100)

    timeLabel := label.new(bar_index, low - (high - low) * 0.2,
                          text="ğŸ“… " + str.format_time(time, "MM-dd HH:mm", "Asia/Seoul") +
                               "\nğŸ”¥ ë©€í‹°TF + StochRSI LONG / $" + str.tostring(close, "#.##") +
                               "\nTP1: $" + str.tostring(labelTp1, "#.##") + " / TP2: $" + str.tostring(labelTp2, "#.##") +
                               "\nSL: $" + str.tostring(labelSl, "#.##") +
                               "\n15m:" + (trend_15m_bullish ? "âœ…" : "âŒ") + " 5m:" + (trend_5m_bullish ? "âœ…" : "âŒ") +
                               "\nğŸ†• StochRSI K:" + str.tostring(stochRSI_k, "#.#") + " " + (stochRSI_golden_cross ? "ğŸŸ¢GC" : ""),
                          style=label.style_label_up,
                          color=color.new(color.green, 40),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 10, labelTp1, color=color.green, width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 10, labelTp2, color=color.green, width=2, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 10, labelSl, color=color.red, width=2, style=line.style_solid)

if shortSignal_filtered
    if not na(timeLabel)
        label.delete(timeLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 - tpPct1/100)
    float labelTp2 = close * (1 - tpPct2/100)
    float labelSl = close * (1 + slPct/100)

    timeLabel := label.new(bar_index, high + (high - low) * 0.2,
                          text="ğŸ“… " + str.format_time(time, "MM-dd HH:mm", "Asia/Seoul") +
                               "\nğŸ”¥ ë©€í‹°TF + StochRSI SHORT / $" + str.tostring(close, "#.##") +
                               "\nTP1: $" + str.tostring(labelTp1, "#.##") + " / TP2: $" + str.tostring(labelTp2, "#.##") +
                               "\nSL: $" + str.tostring(labelSl, "#.##") +
                               "\n15m:" + (trend_15m_bearish ? "âœ…" : "âŒ") + " 5m:" + (trend_5m_bearish ? "âœ…" : "âŒ") +
                               "\nğŸ†• StochRSI K:" + str.tostring(stochRSI_k, "#.#") + " " + (stochRSI_death_cross ? "ğŸ”´DC" : ""),
                          style=label.style_label_down,
                          color=color.new(color.red, 40),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 10, labelTp1, color=color.green, width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 10, labelTp2, color=color.green, width=2, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 10, labelSl, color=color.red, width=2, style=line.style_solid)

// ======================== ê°œì„ ëœ ì •ë³´ í…Œì´ë¸” ========================
var table infoTable = table.new(position.top_right, 2, 10, bgcolor=color.white, border_width=1)

if barstate.islast
    table.clear(infoTable, 0, 0, 1, 9)

    // í—¤ë”
    table.cell(infoTable, 0, 0, "ë©€í‹°TF + StochRSI", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.purple, 20))
    table.cell(infoTable, 1, 0, "ì‹ í˜¸ì „ìš©ëª¨ë“œ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 20))

    table.cell(infoTable, 0, 1, "Current Price", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 1, "$" + str.tostring(close, "#.#"), text_color=color.black, text_size=size.small)

    table.cell(infoTable, 0, 2, "15m Trend", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 2, trend_15m_bullish ? "ğŸŸ¢ BULL" : trend_15m_bearish ? "ğŸ”´ BEAR" : "âšª FLAT", text_color=trend_15m_bullish ? color.green : trend_15m_bearish ? color.red : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 3, "5m Trend", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 3, trend_5m_bullish ? "ğŸŸ¢ BULL" : trend_5m_bearish ? "ğŸ”´ BEAR" : "âšª FLAT", text_color=trend_5m_bullish ? color.green : trend_5m_bearish ? color.red : color.gray, text_size=size.small)

    // ğŸ†• Stochastic RSI í‘œì‹œ
    table.cell(infoTable, 0, 4, "ğŸ†• StochRSI K", text_color=color.black, text_size=size.small, bgcolor=color.new(color.yellow, 80))
    string stochStatus = str.tostring(stochRSI_k, "#.#")
    color stochColor = stochRSI_k < stochRSI_oversold ? color.green : stochRSI_k > stochRSI_overbought ? color.red : color.gray
    if stochRSI_golden_cross
        stochStatus := stochStatus + " ğŸŸ¢GC"
    if stochRSI_death_cross
        stochStatus := stochStatus + " ğŸ”´DC"
    table.cell(infoTable, 1, 4, stochStatus, text_color=stochColor, text_size=size.small)

    table.cell(infoTable, 0, 5, "StochRSI Status", text_color=color.black, text_size=size.small)
    string stochSignal = stochRSI_k < stochRSI_oversold ? "ê³¼ë§¤ë„" : stochRSI_k > stochRSI_overbought ? "ê³¼ë§¤ìˆ˜" : "ì¤‘ë¦½"
    table.cell(infoTable, 1, 5, stochSignal, text_color=stochColor, text_size=size.small)

    table.cell(infoTable, 0, 6, "Next Signal", text_color=color.black, text_size=size.small)
    string nextSignal = "ëŒ€ê¸°ì¤‘"
    if trend_15m_bullish and trend_5m_bullish and stochRSI_bullish
        nextSignal := "ğŸŸ¢ LONG ì¤€ë¹„"
    else if trend_15m_bearish and trend_5m_bearish and stochRSI_bearish
        nextSignal := "ğŸ”´ SHORT ì¤€ë¹„"
    table.cell(infoTable, 1, 6, nextSignal, text_color=str.contains(nextSignal, "LONG") ? color.green : str.contains(nextSignal, "SHORT") ? color.red : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 7, "TP1/TP2/SL", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 7, str.tostring(tpPct1, "#.#") + "%/" + str.tostring(tpPct2, "#.#") + "%/" + str.tostring(slPct, "#.#") + "%", text_color=color.blue, text_size=size.small)

    table.cell(infoTable, 0, 8, "Leverage", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 8, str.tostring(leverageInput) + "ë°° Ã— " + str.tostring(riskPercentInput) + "%", text_color=color.orange, text_size=size.small)

    table.cell(infoTable, 0, 9, "Mode", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 9, strictMode ? "ì—„ê²©ëª¨ë“œ" : "ì™„í™”ëª¨ë“œ", text_color=strictMode ? color.red : color.green, text_size=size.small)

// ======================== ì•ŒëŒ ì„¤ì • (Google Sheets ì—°ë™) ========================
if longSignal_filtered
    // JSON ë°ì´í„°ì— StochRSI ì •ë³´ ì¶”ê°€
    string jsonData = '{"date":"' + str.format_time(time, "yyyy-MM-dd", "Asia/Seoul") + '",' +
          '"time":"' + str.format_time(time, "HH:mm", "Asia/Seoul") + '",' +
          '"signal":"LONG",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"tp1":"' + str.tostring(close * (1 + tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 + tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 - slPct/100), "#.##") + '",' +
          '"trend15m":"' + (trend_15m_bullish ? "BULL" : "BEAR") + '",' +
          '"trend5m":"' + (trend_5m_bullish ? "BULL" : trend_5m_bearish ? "BEAR" : "FLAT") + '",' +
          '"stochRSI_k":"' + str.tostring(stochRSI_k, "#.##") + '",' +
          '"stochRSI_signal":"' + (stochRSI_golden_cross ? "GOLDEN_CROSS" : stochRSI_k < stochRSI_oversold ? "OVERSOLD" : "BULLISH") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)

if shortSignal_filtered
    // JSON ë°ì´í„°ì— StochRSI ì •ë³´ ì¶”ê°€
    string jsonData = '{"date":"' + str.format_time(time, "yyyy-MM-dd", "Asia/Seoul") + '",' +
          '"time":"' + str.format_time(time, "HH:mm", "Asia/Seoul") + '",' +
          '"signal":"SHORT",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"tp1":"' + str.tostring(close * (1 - tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 - tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 + slPct/100), "#.##") + '",' +
          '"trend15m":"' + (trend_15m_bearish ? "BEAR" : "BULL") + '",' +
          '"trend5m":"' + (trend_5m_bullish ? "BULL" : trend_5m_bearish ? "BEAR" : "FLAT") + '",' +
          '"stochRSI_k":"' + str.tostring(stochRSI_k, "#.##") + '",' +
          '"stochRSI_signal":"' + (stochRSI_death_cross ? "DEATH_CROSS" : stochRSI_k > stochRSI_overbought ? "OVERBOUGHT" : "BEARISH") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)
