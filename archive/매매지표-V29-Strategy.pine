//@version=5
strategy("매매지표 V29 Strategy (백테스트)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100, initial_capital=10000, commission_type=strategy.commission.percent, commission_value=0.1)

// ============================================
// V29 Strategy 버전 - 백테스트용
// 원본: 매매지표-V29-SRZones.pine
// ============================================

// ============================================
// 거래 모드 선택
// ============================================
tradeMode = input.string("선물", title="거래 모드", options=["선물", "현물코인", "주식"], tooltip="선물: LONG+SHORT, 현물코인: LONG만, 주식: LONG만")

// ============================================
// V29 신규: 지지/저항 분석 설정
// ============================================
showSRLevels = input.bool(true, title="지지/저항 레벨 표시", tooltip="3일봉 기준 주요 지지/저항 레벨을 차트에 표시")
srTimeframe = input.timeframe("3D", title="S/R 분석 타임프레임", tooltip="지지/저항 분석용 타임프레임")
srLookback = input.int(5, title="S/R 분석 기간 (봉 수)", minval=3, maxval=10, tooltip="최근 몇 개의 3일봉을 분석할지")
srStrengthThreshold = input.float(1.5, title="강한 S/R 거래량 배수", minval=1.0, maxval=3.0, step=0.1, tooltip="평균 거래량의 몇 배 이상이면 강한 레벨로 표시")
srProximityPct = input.float(0.5, title="S/R 근접 알림 (%)", minval=0.1, maxval=2.0, step=0.1, tooltip="현재가가 S/R에서 이 % 이내이면 알림")

// ============================================
// 상위 타임프레임 컨펌 설정
// ============================================
useHTFConfirm = input.bool(true, title="상위 타임프레임 추세 컨펌", tooltip="15분/1시간봉 추세가 일치해야만 신호 발생")
htfTimeframe1 = input.timeframe("15", title="컨펌 타임프레임 1", tooltip="첫 번째 상위 타임프레임")
htfTimeframe2 = input.timeframe("60", title="컨펌 타임프레임 2", tooltip="두 번째 상위 타임프레임")
requireBothHTF = input.bool(false, title="두 타임프레임 모두 일치 필요", tooltip="체크시 15분+1시간 모두 일치해야 신호")

// ============================================
// 상위 타임프레임 거래량 컨펌 설정
// ============================================
useHTFVolumeConfirm = input.bool(true, title="15분봉 거래량 컨펌", tooltip="15분봉에서도 평균 이상 거래량이어야 신호 발생")
htfVolumeRatioMin = input.float(1.2, title="15분봉 최소 거래량 배수", minval=0.8, maxval=3.0, step=0.1, tooltip="15분봉 거래량이 평균의 몇 배 이상이어야 하는지")
currentTFVolumeMin = input.float(1.5, title="현재TF 최소 거래량 배수", minval=1.0, maxval=5.0, step=0.1, tooltip="현재 타임프레임 거래량이 평균의 몇 배 이상이어야 하는지")

// ============================================
// 레버리지 설정 (TP/SL 자동 연동)
// ============================================
leverageInput = input.int(5, title="레버리지", minval=1, maxval=50, step=1, tooltip="레버리지에 따라 TP/SL 자동 조정")

// 레버리지 기반 TP/SL 계산
float leverageMultiplier = 5.0 / leverageInput

// 모드별 기본값 (5배 레버리지 기준)
float baseTP1 = tradeMode == "선물" ? 1.0 : tradeMode == "현물코인" ? 1.5 : 2.0
float baseTP2 = tradeMode == "선물" ? 2.0 : tradeMode == "현물코인" ? 3.0 : 4.0
float baseSL = tradeMode == "선물" ? 0.5 : tradeMode == "현물코인" ? 1.0 : 1.5

// 레버리지 적용된 TP/SL (선물에서만 적용)
float defaultTP1 = tradeMode == "선물" ? baseTP1 * leverageMultiplier : baseTP1
float defaultTP2 = tradeMode == "선물" ? baseTP2 * leverageMultiplier : baseTP2
float defaultSL = tradeMode == "선물" ? baseSL * leverageMultiplier : baseSL

// 최소/최대 제한
defaultTP1 := math.max(0.3, math.min(defaultTP1, 5.0))
defaultTP2 := math.max(0.5, math.min(defaultTP2, 10.0))
defaultSL := math.max(0.15, math.min(defaultSL, 3.0))

// 수동 오버라이드 옵션
useAutoTPSL = input.bool(true, title="자동 TP/SL 사용")
manualTP1 = input.float(1.0, title="수동 TP1 (%)", minval=0.1, maxval=10.0, step=0.1)
manualTP2 = input.float(2.0, title="수동 TP2 (%)", minval=0.1, maxval=20.0, step=0.1)
manualSL = input.float(0.5, title="수동 SL (%)", minval=0.1, maxval=5.0, step=0.1)

// 최종 TP/SL 값
float tpPct1 = useAutoTPSL ? defaultTP1 : manualTP1
float tpPct2 = useAutoTPSL ? defaultTP2 : manualTP2
float slPct = useAutoTPSL ? defaultSL : manualSL

// ============================================
// 신호 품질 설정
// ============================================
minSignalStrength = input.int(14, title="최소 신호 강도", minval=10, maxval=20)
minBarsBetweenSignals = input.int(5, title="신호 최소 간격 (봉)", minval=3, maxval=20)
requireVolumeConfirm = input.bool(true, title="거래량 확인 필수")

// ============================================
// ADX 설정
// ============================================
useADXFilter = input.bool(true, title="ADX 필터 사용")
adxLength = input.int(14, title="ADX 길이", minval=7, maxval=30)
adxThreshold = input.float(20.0, title="ADX 임계값", minval=15.0, maxval=35.0, step=1.0)

// ============================================
// 현재 타임프레임 지표 계산
// ============================================

// 이동평균선
ema9 = ta.ema(close, 9)
ema21 = ta.ema(close, 21)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)
vwap50 = ta.vwma(close, 50)

// 추세 정의
strongUptrend = ema9 > ema21 and ema21 > ema50 and close > ema200
strongDowntrend = ema9 < ema21 and ema21 < ema50 and close < ema200
isUptrend = ema9 > ema21 and close > ema50
isDowntrend = ema9 < ema21 and close < ema50

// ADX
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)
noTrend = adx < adxThreshold
trendExists = adx >= adxThreshold
strongTrend = adx >= 25
veryStrongTrend = adx >= 30
bullishDI = diPlus > diMinus
bearishDI = diMinus > diPlus
diCrossUp = ta.crossover(diPlus, diMinus)
diCrossDown = ta.crossunder(diPlus, diMinus)

// RSI
rsi = ta.rsi(close, 14)
rsiOversold = rsi < 30
rsiOverbought = rsi > 70
rsiBullish = rsi > 50 and rsi < 70
rsiBearish = rsi < 50 and rsi > 30

// Stochastic RSI
stochRsi = ta.stoch(rsi, rsi, rsi, 14)
stochK = ta.sma(stochRsi, 3)
stochD = ta.sma(stochK, 3)
stochOversold = stochK < 15
stochOverbought = stochK > 85
stochGoldenCross = ta.crossover(stochK, stochD) and stochK < 30
stochDeadCross = ta.crossunder(stochK, stochD) and stochK > 70

// MACD
[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
macdBullish = macdLine > signalLine and histogram > 0
macdBearish = macdLine < signalLine and histogram < 0
macdCrossUp = ta.crossover(macdLine, signalLine)
macdCrossDown = ta.crossunder(macdLine, signalLine)

// Bollinger Bands
bbBasis = ta.sma(close, 20)
bbDev = ta.stdev(close, 20)
bbUpper = bbBasis + 2 * bbDev
bbLower = bbBasis - 2 * bbDev
bbWidth = (bbUpper - bbLower) / bbBasis * 100
touchingBBLower = low <= bbLower
touchingBBUpper = high >= bbUpper
bbSqueeze = bbWidth < ta.sma(bbWidth, 20) * 0.7

// ============================================
// 현재 타임프레임 거래량 분석
// ============================================
avgVolume = ta.sma(volume, 20)
volumeRatio = volume / avgVolume
volumeConfirm = volumeRatio >= 1.0
highVolume = volumeRatio >= 1.5
veryHighVolume = volumeRatio >= 2.0
currentTFVolumeOK = volumeRatio >= currentTFVolumeMin

bullVolume = close > open ? volume : volume * (close - low) / math.max(high - low, 0.0001)
bearVolume = close < open ? volume : volume * (high - close) / math.max(high - low, 0.0001)
buyPressure = bullVolume / (bullVolume + bearVolume) * 100
strongBuyPressure = buyPressure > 65
strongSellPressure = buyPressure < 35

// ============================================
// 15분봉 거래량 컨펌
// ============================================
htf_volume = request.security(syminfo.tickerid, htfTimeframe1, volume, lookahead=barmerge.lookahead_off)
htf_avgVolume = request.security(syminfo.tickerid, htfTimeframe1, ta.sma(volume, 20), lookahead=barmerge.lookahead_off)
htf_volumeRatio = htf_volume / htf_avgVolume
htfVolumeOK = htf_volumeRatio >= htfVolumeRatioMin

htf_close = request.security(syminfo.tickerid, htfTimeframe1, close, lookahead=barmerge.lookahead_off)
htf_open = request.security(syminfo.tickerid, htfTimeframe1, open, lookahead=barmerge.lookahead_off)
htf_high = request.security(syminfo.tickerid, htfTimeframe1, high, lookahead=barmerge.lookahead_off)
htf_low = request.security(syminfo.tickerid, htfTimeframe1, low, lookahead=barmerge.lookahead_off)

htf_bullVolume = htf_close > htf_open ? htf_volume : htf_volume * (htf_close - htf_low) / math.max(htf_high - htf_low, 0.0001)
htf_bearVolume = htf_close < htf_open ? htf_volume : htf_volume * (htf_high - htf_close) / math.max(htf_high - htf_low, 0.0001)
htf_buyPressure = htf_bullVolume / (htf_bullVolume + htf_bearVolume) * 100
htf_strongBuyPressure = htf_buyPressure > 60
htf_strongSellPressure = htf_buyPressure < 40

bool volumeFullConfirm = true
if useHTFVolumeConfirm
    volumeFullConfirm := currentTFVolumeOK and htfVolumeOK
else
    volumeFullConfirm := volumeConfirm

// ============================================
// V29 핵심: 3일봉 지지/저항 분석
// ============================================

// 3일봉 데이터 가져오기
sr_high = request.security(syminfo.tickerid, srTimeframe, high, lookahead=barmerge.lookahead_off)
sr_low = request.security(syminfo.tickerid, srTimeframe, low, lookahead=barmerge.lookahead_off)
sr_close = request.security(syminfo.tickerid, srTimeframe, close, lookahead=barmerge.lookahead_off)
sr_open = request.security(syminfo.tickerid, srTimeframe, open, lookahead=barmerge.lookahead_off)
sr_volume = request.security(syminfo.tickerid, srTimeframe, volume, lookahead=barmerge.lookahead_off)
sr_avgVolume = request.security(syminfo.tickerid, srTimeframe, ta.sma(volume, 20), lookahead=barmerge.lookahead_off)

// 3일봉 피벗 계산 (각 봉별)
sr_high_1 = request.security(syminfo.tickerid, srTimeframe, high[1], lookahead=barmerge.lookahead_off)
sr_low_1 = request.security(syminfo.tickerid, srTimeframe, low[1], lookahead=barmerge.lookahead_off)
sr_volume_1 = request.security(syminfo.tickerid, srTimeframe, volume[1], lookahead=barmerge.lookahead_off)

sr_high_2 = request.security(syminfo.tickerid, srTimeframe, high[2], lookahead=barmerge.lookahead_off)
sr_low_2 = request.security(syminfo.tickerid, srTimeframe, low[2], lookahead=barmerge.lookahead_off)
sr_volume_2 = request.security(syminfo.tickerid, srTimeframe, volume[2], lookahead=barmerge.lookahead_off)

sr_high_3 = request.security(syminfo.tickerid, srTimeframe, high[3], lookahead=barmerge.lookahead_off)
sr_low_3 = request.security(syminfo.tickerid, srTimeframe, low[3], lookahead=barmerge.lookahead_off)
sr_volume_3 = request.security(syminfo.tickerid, srTimeframe, volume[3], lookahead=barmerge.lookahead_off)

sr_high_4 = request.security(syminfo.tickerid, srTimeframe, high[4], lookahead=barmerge.lookahead_off)
sr_low_4 = request.security(syminfo.tickerid, srTimeframe, low[4], lookahead=barmerge.lookahead_off)
sr_volume_4 = request.security(syminfo.tickerid, srTimeframe, volume[4], lookahead=barmerge.lookahead_off)

// 거래량 가중치 계산
sr_volRatio_0 = sr_volume / sr_avgVolume
sr_volRatio_1 = sr_volume_1 / sr_avgVolume
sr_volRatio_2 = sr_volume_2 / sr_avgVolume
sr_volRatio_3 = sr_volume_3 / sr_avgVolume
sr_volRatio_4 = sr_volume_4 / sr_avgVolume

// 가장 가까운 저항/지지 찾기
float nearestResistance = na
float nearestResistanceStrength = 0.0
float nearestSupport = na
float nearestSupportStrength = 0.0

// 현재가 위의 가장 가까운 저항
if sr_high > close
    nearestResistance := sr_high
    nearestResistanceStrength := sr_volRatio_0
if sr_high_1 > close and (na(nearestResistance) or sr_high_1 < nearestResistance)
    nearestResistance := sr_high_1
    nearestResistanceStrength := sr_volRatio_1
if sr_high_2 > close and (na(nearestResistance) or sr_high_2 < nearestResistance)
    nearestResistance := sr_high_2
    nearestResistanceStrength := sr_volRatio_2
if sr_high_3 > close and (na(nearestResistance) or sr_high_3 < nearestResistance)
    nearestResistance := sr_high_3
    nearestResistanceStrength := sr_volRatio_3
if sr_high_4 > close and (na(nearestResistance) or sr_high_4 < nearestResistance)
    nearestResistance := sr_high_4
    nearestResistanceStrength := sr_volRatio_4

// 현재가 아래의 가장 가까운 지지
if sr_low < close
    nearestSupport := sr_low
    nearestSupportStrength := sr_volRatio_0
if sr_low_1 < close and (na(nearestSupport) or sr_low_1 > nearestSupport)
    nearestSupport := sr_low_1
    nearestSupportStrength := sr_volRatio_1
if sr_low_2 < close and (na(nearestSupport) or sr_low_2 > nearestSupport)
    nearestSupport := sr_low_2
    nearestSupportStrength := sr_volRatio_2
if sr_low_3 < close and (na(nearestSupport) or sr_low_3 > nearestSupport)
    nearestSupport := sr_low_3
    nearestSupportStrength := sr_volRatio_3
if sr_low_4 < close and (na(nearestSupport) or sr_low_4 > nearestSupport)
    nearestSupport := sr_low_4
    nearestSupportStrength := sr_volRatio_4

// S/R 근접도 계산
float resistanceDistance = na(nearestResistance) ? na : (nearestResistance - close) / close * 100
float supportDistance = na(nearestSupport) ? na : (close - nearestSupport) / close * 100

bool nearResistance = not na(resistanceDistance) and resistanceDistance <= srProximityPct
bool nearSupport = not na(supportDistance) and supportDistance <= srProximityPct

// 강한 S/R 여부
bool isStrongResistance = nearestResistanceStrength >= srStrengthThreshold
bool isStrongSupport = nearestSupportStrength >= srStrengthThreshold

// ============================================
// 상위 타임프레임 추세 컨펌
// ============================================

// === 15분봉 (HTF1) 지표 ===
htf1_ema20 = request.security(syminfo.tickerid, htfTimeframe1, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
htf1_ema50 = request.security(syminfo.tickerid, htfTimeframe1, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
htf1_rsi = request.security(syminfo.tickerid, htfTimeframe1, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

[htf1_diPlus, htf1_diMinus, htf1_adx_raw] = ta.dmi(14, 14)
htf1_adx = request.security(syminfo.tickerid, htfTimeframe1, htf1_adx_raw, lookahead=barmerge.lookahead_off)
htf1_diPlus_sec = request.security(syminfo.tickerid, htfTimeframe1, htf1_diPlus, lookahead=barmerge.lookahead_off)
htf1_diMinus_sec = request.security(syminfo.tickerid, htfTimeframe1, htf1_diMinus, lookahead=barmerge.lookahead_off)

[htf1_macdLine, htf1_signalLine, htf1_hist] = request.security(syminfo.tickerid, htfTimeframe1, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

htf1_bullish = htf1_ema20 > htf1_ema50 and htf1_rsi > 45 and htf1_rsi < 75 and htf1_macdLine > htf1_signalLine
htf1_bearish = htf1_ema20 < htf1_ema50 and htf1_rsi < 55 and htf1_rsi > 25 and htf1_macdLine < htf1_signalLine
htf1_bullDI = htf1_diPlus_sec > htf1_diMinus_sec
htf1_bearDI = htf1_diMinus_sec > htf1_diPlus_sec

// === 1시간봉 (HTF2) 지표 ===
htf2_ema20 = request.security(syminfo.tickerid, htfTimeframe2, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
htf2_ema50 = request.security(syminfo.tickerid, htfTimeframe2, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
htf2_rsi = request.security(syminfo.tickerid, htfTimeframe2, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

[htf2_diPlus, htf2_diMinus, htf2_adx_raw] = ta.dmi(14, 14)
htf2_adx = request.security(syminfo.tickerid, htfTimeframe2, htf2_adx_raw, lookahead=barmerge.lookahead_off)
htf2_diPlus_sec = request.security(syminfo.tickerid, htfTimeframe2, htf2_diPlus, lookahead=barmerge.lookahead_off)
htf2_diMinus_sec = request.security(syminfo.tickerid, htfTimeframe2, htf2_diMinus, lookahead=barmerge.lookahead_off)

[htf2_macdLine, htf2_signalLine, htf2_hist] = request.security(syminfo.tickerid, htfTimeframe2, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

htf2_bullish = htf2_ema20 > htf2_ema50 and htf2_rsi > 45 and htf2_rsi < 75 and htf2_macdLine > htf2_signalLine
htf2_bearish = htf2_ema20 < htf2_ema50 and htf2_rsi < 55 and htf2_rsi > 25 and htf2_macdLine < htf2_signalLine
htf2_bullDI = htf2_diPlus_sec > htf2_diMinus_sec
htf2_bearDI = htf2_diMinus_sec > htf2_diPlus_sec

// === 상위 타임프레임 컨펌 결과 ===
htf1_longConfirm = htf1_bullish and htf1_bullDI
htf2_longConfirm = htf2_bullish and htf2_bullDI
htf1_shortConfirm = htf1_bearish and htf1_bearDI
htf2_shortConfirm = htf2_bearish and htf2_bearDI

bool htfLongConfirmed = false
bool htfShortConfirmed = false

if requireBothHTF
    htfLongConfirmed := htf1_longConfirm and htf2_longConfirm
    htfShortConfirmed := htf1_shortConfirm and htf2_shortConfirm
else
    htfLongConfirmed := htf1_longConfirm or htf2_longConfirm
    htfShortConfirmed := htf1_shortConfirm or htf2_shortConfirm

// ============================================
// 신호 간격 추적
// ============================================
var int barsSinceLastLong = 999
var int barsSinceLastShort = 999
barsSinceLastLong := barsSinceLastLong + 1
barsSinceLastShort := barsSinceLastShort + 1
canSignalLong = barsSinceLastLong >= minBarsBetweenSignals
canSignalShort = barsSinceLastShort >= minBarsBetweenSignals

// ============================================
// 점수 시스템 (V29: S/R 보너스 추가)
// ============================================

// LONG 점수 (최대 26점 - S/R 보너스 포함)
var float trendScore = 0.0
trendScore := 0.0
if strongUptrend
    trendScore += 4
else if isUptrend
    trendScore += 2
if htf1_bullish
    trendScore += 2
if htf2_bullish
    trendScore += 2

var float momentumScore = 0.0
momentumScore := 0.0
if stochGoldenCross
    momentumScore += 3
else if stochOversold
    momentumScore += 2
if macdCrossUp or macdBullish
    momentumScore += 2
if rsiBullish
    momentumScore += 2
if diCrossUp or (bullishDI and trendExists)
    momentumScore += 1

var float volumeScore = 0.0
volumeScore := 0.0
if veryHighVolume and strongBuyPressure and htfVolumeOK and htf_strongBuyPressure
    volumeScore += 5
else if veryHighVolume and strongBuyPressure
    volumeScore += 4
else if highVolume and strongBuyPressure
    volumeScore += 3
else if volumeConfirm and buyPressure > 55
    volumeScore += 2
else if volumeConfirm
    volumeScore += 1

var float technicalScore = 0.0
technicalScore := 0.0
if touchingBBLower and stochOversold
    technicalScore += 2
if close > vwap50
    technicalScore += 1
if close > ema200
    technicalScore += 1

// V29: S/R 보너스 점수
var float srScore = 0.0
srScore := 0.0
if nearSupport and isStrongSupport
    srScore += 2
else if nearSupport
    srScore += 1

var float totalScore = 0.0
totalScore := trendScore + momentumScore + volumeScore + technicalScore + srScore

// SHORT 점수
var float trendScoreShort = 0.0
trendScoreShort := 0.0
if strongDowntrend
    trendScoreShort += 4
else if isDowntrend
    trendScoreShort += 2
if htf1_bearish
    trendScoreShort += 2
if htf2_bearish
    trendScoreShort += 2

var float momentumScoreShort = 0.0
momentumScoreShort := 0.0
if stochDeadCross
    momentumScoreShort += 3
else if stochOverbought
    momentumScoreShort += 2
if macdCrossDown or macdBearish
    momentumScoreShort += 2
if rsiBearish
    momentumScoreShort += 2
if diCrossDown or (bearishDI and trendExists)
    momentumScoreShort += 1

var float volumeScoreShort = 0.0
volumeScoreShort := 0.0
if veryHighVolume and strongSellPressure and htfVolumeOK and htf_strongSellPressure
    volumeScoreShort += 5
else if veryHighVolume and strongSellPressure
    volumeScoreShort += 4
else if highVolume and strongSellPressure
    volumeScoreShort += 3
else if volumeConfirm and buyPressure < 45
    volumeScoreShort += 2
else if volumeConfirm
    volumeScoreShort += 1

var float technicalScoreShort = 0.0
technicalScoreShort := 0.0
if touchingBBUpper and stochOverbought
    technicalScoreShort += 2
if close < vwap50
    technicalScoreShort += 1
if close < ema200
    technicalScoreShort += 1

// V29: S/R 보너스 점수 (SHORT)
var float srScoreShort = 0.0
srScoreShort := 0.0
if nearResistance and isStrongResistance
    srScoreShort += 2
else if nearResistance
    srScoreShort += 1

var float totalScoreShort = 0.0
totalScoreShort := trendScoreShort + momentumScoreShort + volumeScoreShort + technicalScoreShort + srScoreShort

// ============================================
// 최종 신호 결정
// ============================================

// LONG 조건
longBase = totalScore >= minSignalStrength
longBase := longBase and canSignalLong
longBase := longBase and isUptrend

if requireVolumeConfirm
    longBase := longBase and volumeFullConfirm

if useADXFilter
    longBase := longBase and trendExists and bullishDI

longBase := longBase and (stochOversold or stochGoldenCross or (stochK < 50 and stochK > stochD))

if useHTFConfirm
    longBase := longBase and htfLongConfirmed

if useHTFVolumeConfirm
    longBase := longBase and (htf_buyPressure > 50)

longSignal_final = longBase

// SHORT 조건 (선물만)
shortBase = false
if tradeMode == "선물"
    shortBase := totalScoreShort >= minSignalStrength
    shortBase := shortBase and canSignalShort
    shortBase := shortBase and isDowntrend

    if requireVolumeConfirm
        shortBase := shortBase and volumeFullConfirm

    if useADXFilter
        shortBase := shortBase and trendExists and bearishDI

    shortBase := shortBase and (stochOverbought or stochDeadCross or (stochK > 50 and stochK < stochD))

    if useHTFConfirm
        shortBase := shortBase and htfShortConfirmed

    if useHTFVolumeConfirm
        shortBase := shortBase and (htf_buyPressure < 50)

shortSignal_final = shortBase

// 신호 발생시 카운터 리셋
if longSignal_final
    barsSinceLastLong := 0
if shortSignal_final
    barsSinceLastShort := 0

// ============================================
// Strategy 진입/청산
// ============================================

// LONG 진입
if longSignal_final and strategy.position_size == 0
    strategy.entry("LONG", strategy.long)

// SHORT 진입
if shortSignal_final and strategy.position_size == 0
    strategy.entry("SHORT", strategy.short)

// TP/SL 설정
if strategy.position_size > 0
    longTP1Price = strategy.position_avg_price * (1 + tpPct1/100)
    longTP2Price = strategy.position_avg_price * (1 + tpPct2/100)
    longSLPrice = strategy.position_avg_price * (1 - slPct/100)
    strategy.exit("LONG TP1", "LONG", qty_percent=50, limit=longTP1Price, stop=longSLPrice)
    strategy.exit("LONG TP2", "LONG", limit=longTP2Price, stop=longSLPrice)

if strategy.position_size < 0
    shortTP1Price = strategy.position_avg_price * (1 - tpPct1/100)
    shortTP2Price = strategy.position_avg_price * (1 - tpPct2/100)
    shortSLPrice = strategy.position_avg_price * (1 + slPct/100)
    strategy.exit("SHORT TP1", "SHORT", qty_percent=50, limit=shortTP1Price, stop=shortSLPrice)
    strategy.exit("SHORT TP2", "SHORT", limit=shortTP2Price, stop=shortSLPrice)

// ============================================
// 차트 표시
// ============================================

// 이동평균선
plot(ema21, color=color.new(color.orange, 0), linewidth=2, title="EMA 21")
plot(ema50, color=color.new(color.blue, 0), linewidth=2, title="EMA 50")
plot(ema200, color=color.new(color.purple, 0), linewidth=2, title="EMA 200")

// Bollinger Bands
plot(bbUpper, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(bbLower, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")

// 추세 배경
bgcolor(strongUptrend ? color.new(color.green, 92) : strongDowntrend ? color.new(color.red, 92) : na)
bgcolor(bbSqueeze ? color.new(color.yellow, 90) : na, title="BB 스퀴즈")

// ============================================
// 백테스트 결과는 "전략 테스터" 탭에서 확인
// ============================================
