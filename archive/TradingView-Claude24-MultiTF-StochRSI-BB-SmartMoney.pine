//@version=5
indicator("ÌÅ¥Î°úÎìú24 Î©ÄÌã∞TF + StochRSI + BB + üêãÌÅ∞ÏÜêÍ∞êÏßÄ", overlay=true, max_labels_count=100)

// ======================== Î≤ÑÏ†Ñ Ï†ïÎ≥¥ ========================
// Î≤ÑÏ†Ñ: v24
// ÏóÖÎç∞Ïù¥Ìä∏: 2024-11-21
// Î≥ÄÍ≤ΩÏÇ¨Ìï≠: Ïä§ÎßàÌä∏Î®∏Îãà(ÌÅ∞ÏÜê) Í∞êÏßÄ + Volume Delta + ÎàÑÏ†Å/Î∂ÑÏÇ∞ Î∂ÑÏÑù
// Ïù¥Ï†Ñ Î≤ÑÏ†Ñ: v23 (BB Ïä§Ï∫òÌïë)
// ========================================================

// ======================== ÏûÖÎ†• Î≥ÄÏàò ========================
leverageInput = input.int(5, title="Î†àÎ≤ÑÎ¶¨ÏßÄ", minval=1, maxval=20)
riskPercentInput = input.float(20.0, title="Ìà¨ÏûÖ ÎπÑÏú® (%)", minval=1.0, maxval=100.0)
tpPct1 = input.float(0.8, title="TP1 ÏàòÏùµÎ•† (%)", minval=0.1, maxval=5.0, step=0.1)
tpPct2 = input.float(1.5, title="TP2 ÏàòÏùµÎ•† (%)", minval=0.1, maxval=5.0, step=0.1)
slPct = input.float(0.3, title="ÏÜêÏ†à ÎπÑÏú® (%)", minval=0.05, maxval=2.0, step=0.05)

// Î©ÄÌã∞ÌÉÄÏûÑÌîÑÎ†àÏûÑ ÌôúÏÑ±Ìôî ÏòµÏÖò
useMultiTF = input.bool(true, title="Î©ÄÌã∞ÌÉÄÏûÑÌîÑÎ†àÏûÑ ÌïÑÌÑ∞ ÏÇ¨Ïö©")
strictMode = input.bool(true, title="ÏóÑÍ≤© Î™®Îìú (Î™®Îì† Ï°∞Í±¥ ÎßåÏ°±)")

// Stochastic RSI ÏÑ§Ï†ï
useStochRSI = input.bool(true, title="Stochastic RSI ÌïÑÌÑ∞ ÏÇ¨Ïö©", group="Stochastic RSI")
stochRSI_length = input.int(14, title="RSI Í∏∞Í∞Ñ", minval=1, group="Stochastic RSI")
stochRSI_smoothK = input.int(3, title="K ÌèâÌôúÌôî", minval=1, group="Stochastic RSI")
stochRSI_smoothD = input.int(3, title="D ÌèâÌôúÌôî", minval=1, group="Stochastic RSI")
stochRSI_overbought = input.float(80, title="Í≥ºÎß§Ïàò Î†àÎ≤®", minval=50, maxval=100, group="Stochastic RSI")
stochRSI_oversold = input.float(20, title="Í≥ºÎß§ÎèÑ Î†àÎ≤®", minval=0, maxval=50, group="Stochastic RSI")

// Bollinger Bands Ïä§Ï∫òÌïë ÏÑ§Ï†ï
useBBScalping = input.bool(true, title="BB Ïä§Ï∫òÌïë ÌïÑÌÑ∞ ÏÇ¨Ïö©", group="Bollinger Bands Ïä§Ï∫òÌïë")
bb_length = input.int(20, title="BB Í∏∞Í∞Ñ", minval=1, group="Bollinger Bands Ïä§Ï∫òÌïë")
bb_mult = input.float(2.0, title="BB ÌëúÏ§ÄÌé∏Ï∞®", minval=0.1, maxval=5.0, step=0.1, group="Bollinger Bands Ïä§Ï∫òÌïë")
bb_rsi_length = input.int(14, title="Ïä§Ï∫òÌïë RSI Í∏∞Í∞Ñ", minval=1, group="Bollinger Bands Ïä§Ï∫òÌïë")
bb_rsi_overbought = input.float(70, title="Ïä§Ï∫òÌïë RSI Í≥ºÎß§Ïàò", minval=50, maxval=100, group="Bollinger Bands Ïä§Ï∫òÌïë")
bb_rsi_oversold = input.float(30, title="Ïä§Ï∫òÌïë RSI Í≥ºÎß§ÎèÑ", minval=0, maxval=50, group="Bollinger Bands Ïä§Ï∫òÌïë")
bb_squeeze_threshold = input.float(0.015, title="BB Ïä§ÌÄ¥Ï¶à ÏûÑÍ≥ÑÍ∞í (%)", minval=0.005, maxval=0.05, step=0.001, group="Bollinger Bands Ïä§Ï∫òÌïë")

// üÜï v24: Ïä§ÎßàÌä∏Î®∏Îãà(ÌÅ∞ÏÜê) Í∞êÏßÄ ÏÑ§Ï†ï
useSmartMoney = input.bool(true, title="üÜï Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ ÏÇ¨Ïö©", group="üêã Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ")
volume_ma_length = input.int(20, title="Í±∞ÎûòÎüâ ÌèâÍ∑† Í∏∞Í∞Ñ", minval=5, maxval=100, group="üêã Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ")
whale_multiplier = input.float(2.0, title="üêã ÌÅ∞ÏÜê ÏûÑÍ≥ÑÍ∞í (Î∞∞Ïàò)", minval=1.5, maxval=5.0, step=0.1, group="üêã Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ")
institution_multiplier = input.float(3.0, title="üê≥ Í∏∞Í¥Ä ÏûÑÍ≥ÑÍ∞í (Î∞∞Ïàò)", minval=2.0, maxval=10.0, step=0.5, group="üêã Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ")
show_volume_delta = input.bool(true, title="Volume Delta ÌëúÏãú", group="üêã Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ")
show_accumulation = input.bool(true, title="ÎàÑÏ†Å/Î∂ÑÏÇ∞ Íµ¨Í∞Ñ ÌëúÏãú", group="üêã Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ")

// ======================== üÜï v24: Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ Í≥ÑÏÇ∞ ========================
// Í±∞ÎûòÎüâ Î∂ÑÏÑù
volume_ma = ta.sma(volume, volume_ma_length)
volume_ratio = volume / volume_ma

// ÌÅ∞ÏÜê Í∞êÏßÄ
whale_detected = volume_ratio >= whale_multiplier and volume_ratio < institution_multiplier
institution_detected = volume_ratio >= institution_multiplier

// Volume Delta (Îß§Ïàò vs Îß§ÎèÑ ÏïïÎ†• Ï∂îÏ†ï)
// ÏñëÎ¥âÏù¥Î©¥ Îß§Ïàò Ïö∞ÏÑ∏, ÏùåÎ¥âÏù¥Î©¥ Îß§ÎèÑ Ïö∞ÏÑ∏Î°ú Í∞ÄÏ†ï
volume_delta = close > open ? volume : close < open ? -volume : 0
volume_delta_ma = ta.sma(volume_delta, 14)

// ÎàÑÏ†Å Volume Delta (Cumulative)
var float cumulative_delta = 0
cumulative_delta := cumulative_delta + volume_delta

// Îß§Ïàò/Îß§ÎèÑ ÏïïÎ†• ÎπÑÏú®
buy_pressure = close > open ? volume : 0
sell_pressure = close < open ? volume : 0
buy_pressure_ma = ta.sma(buy_pressure, 14)
sell_pressure_ma = ta.sma(sell_pressure, 14)
total_pressure = buy_pressure_ma + sell_pressure_ma
buy_ratio = total_pressure > 0 ? (buy_pressure_ma / total_pressure) * 100 : 50
sell_ratio = 100 - buy_ratio

// ÎàÑÏ†Å/Î∂ÑÏÇ∞ Íµ¨Í∞Ñ ÌåêÎ≥Ñ
price_change = close - close[1]
accumulation = price_change > 0 and volume > volume_ma  // Í∞ÄÍ≤©‚Üë + Í±∞ÎûòÎüâ‚Üë = ÎàÑÏ†Å
distribution = price_change < 0 and volume > volume_ma  // Í∞ÄÍ≤©‚Üì + Í±∞ÎûòÎüâ‚Üë = Î∂ÑÏÇ∞

// Ïä§ÎßàÌä∏Î®∏Îãà Î∞©Ìñ• ÌåêÎ≥Ñ
smart_money_bullish = (whale_detected or institution_detected) and close > open and buy_ratio > 60
smart_money_bearish = (whale_detected or institution_detected) and close < open and sell_ratio > 60

// ======================== Bollinger Bands Í≥ÑÏÇ∞ ========================
[bb_middle_1m, bb_upper_1m, bb_lower_1m] = ta.bb(close, bb_length, bb_mult)
bb_width_1m = (bb_upper_1m - bb_lower_1m) / bb_middle_1m
bb_squeeze_1m = bb_width_1m < bb_squeeze_threshold

bb_middle_3m = request.security(syminfo.tickerid, "3", ta.sma(close, bb_length), lookahead=barmerge.lookahead_off)
bb_upper_3m = request.security(syminfo.tickerid, "3", ta.sma(close, bb_length) + bb_mult * ta.stdev(close, bb_length), lookahead=barmerge.lookahead_off)
bb_lower_3m = request.security(syminfo.tickerid, "3", ta.sma(close, bb_length) - bb_mult * ta.stdev(close, bb_length), lookahead=barmerge.lookahead_off)

rsi_scalping = ta.rsi(close, bb_rsi_length)

bb_touch_lower = close <= bb_lower_1m * 1.001
bb_touch_upper = close >= bb_upper_1m * 0.999
bb_bounce_from_lower = bb_touch_lower[1] and close > bb_lower_1m
bb_bounce_from_upper = bb_touch_upper[1] and close < bb_upper_1m
bb_breakout_up = close > bb_upper_1m and bb_squeeze_1m[1]
bb_breakout_down = close < bb_lower_1m and bb_squeeze_1m[1]

bb_scalp_long = (bb_touch_lower or bb_bounce_from_lower or bb_breakout_up) and rsi_scalping < bb_rsi_oversold
bb_scalp_short = (bb_touch_upper or bb_bounce_from_upper or bb_breakout_down) and rsi_scalping > bb_rsi_overbought

bb_cross_up = ta.crossover(close, bb_middle_1m)
bb_cross_down = ta.crossunder(close, bb_middle_1m)

// ======================== Stochastic RSI Í≥ÑÏÇ∞ ========================
rsi_for_stoch = ta.rsi(close, stochRSI_length)
stoch_k = ta.stoch(rsi_for_stoch, rsi_for_stoch, rsi_for_stoch, stochRSI_length)
stochRSI_k = ta.sma(stoch_k, stochRSI_smoothK)
stochRSI_d = ta.sma(stochRSI_k, stochRSI_smoothD)

stochRSI_bullish = stochRSI_k < stochRSI_oversold or (stochRSI_k > stochRSI_k[1] and stochRSI_k < 50)
stochRSI_bearish = stochRSI_k > stochRSI_overbought or (stochRSI_k < stochRSI_k[1] and stochRSI_k > 50)
stochRSI_golden_cross = ta.crossover(stochRSI_k, stochRSI_d)
stochRSI_death_cross = ta.crossunder(stochRSI_k, stochRSI_d)

// ======================== Î©ÄÌã∞ÌÉÄÏûÑÌîÑÎ†àÏûÑ Îç∞Ïù¥ÌÑ∞ ========================
ema20_15m = request.security(syminfo.tickerid, "15", ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_15m = request.security(syminfo.tickerid, "15", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
rsi_15m = request.security(syminfo.tickerid, "15", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

ema20_5m = request.security(syminfo.tickerid, "5", ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_5m = request.security(syminfo.tickerid, "5", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_5m, signalLine_5m, histogram_5m] = request.security(syminfo.tickerid, "5", ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)
rsi_5m = request.security(syminfo.tickerid, "5", ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

ema20_3m = request.security(syminfo.tickerid, "3", ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_3m = request.security(syminfo.tickerid, "3", ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_3m, signalLine_3m, histogram_3m] = request.security(syminfo.tickerid, "3", ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

rsi_1m = ta.rsi(close, 14)
vwma_1m = ta.vwma(close, 20)

// ======================== Ìä∏Î†åÎìú Î∞©Ìñ• Î∂ÑÏÑù ========================
trend_15m_bullish = ema20_15m > ema50_15m and rsi_15m > 45 and rsi_15m < 70
trend_15m_bearish = ema20_15m < ema50_15m and rsi_15m > 30 and rsi_15m < 55

trend_5m_bullish = ema20_5m > ema50_5m and macdLine_5m > macdLine_5m[1] and rsi_5m > 40
trend_5m_bearish = ema20_5m < ema50_5m and macdLine_5m < macdLine_5m[1] and rsi_5m < 60

signal_3m_long = ta.crossover(ema20_3m, ema50_3m) and macdLine_3m > signalLine_3m
signal_3m_short = ta.crossunder(ema20_3m, ema50_3m) and macdLine_3m < signalLine_3m

// ======================== üÜï v24: ÌÜµÌï© Ïã†Ìò∏ (Ïä§ÎßàÌä∏Î®∏Îãà Ìè¨Ìï®) ========================
longSignal_basic = signal_3m_long and rsi_1m > 35 and rsi_1m < 65 and close > vwma_1m

longSignal_stochRSI = if useStochRSI
    (stochRSI_k < stochRSI_oversold or stochRSI_golden_cross or (stochRSI_k > stochRSI_k[1] and stochRSI_k < 50)) and
    not (stochRSI_k > stochRSI_overbought)
else
    true

longSignal_BB = if useBBScalping
    (bb_scalp_long or (bb_cross_up and rsi_scalping < 50)) and close > bb_lower_3m
else
    true

// üÜï Ïä§ÎßàÌä∏Î®∏Îãà ÌôïÏù∏
longSignal_SmartMoney = if useSmartMoney
    // Ïä§ÎßàÌä∏Î®∏ÎãàÍ∞Ä Îß§Ïàò Ï§ëÏù¥Í±∞ÎÇò ÎàÑÏ†Å Íµ¨Í∞Ñ
    (smart_money_bullish or accumulation or buy_ratio > 65) and not distribution
else
    true

// ÌÜµÌï© LONG Ïã†Ìò∏
longSignal_filtered = if useMultiTF
    if strictMode
        longSignal_basic and trend_15m_bullish and trend_5m_bullish and longSignal_stochRSI and longSignal_BB and longSignal_SmartMoney
    else
        longSignal_basic and (trend_15m_bullish or trend_5m_bullish) and longSignal_stochRSI and longSignal_BB and longSignal_SmartMoney
else
    longSignal_basic and longSignal_stochRSI and longSignal_BB and longSignal_SmartMoney

// SHORT Ïã†Ìò∏
shortSignal_basic = signal_3m_short and rsi_1m > 35 and rsi_1m < 65 and close < vwma_1m

shortSignal_stochRSI = if useStochRSI
    (stochRSI_k > stochRSI_overbought or stochRSI_death_cross or (stochRSI_k < stochRSI_k[1] and stochRSI_k > 50)) and
    not (stochRSI_k < stochRSI_oversold)
else
    true

shortSignal_BB = if useBBScalping
    (bb_scalp_short or (bb_cross_down and rsi_scalping > 50)) and close < bb_upper_3m
else
    true

// üÜï Ïä§ÎßàÌä∏Î®∏Îãà ÌôïÏù∏
shortSignal_SmartMoney = if useSmartMoney
    // Ïä§ÎßàÌä∏Î®∏ÎãàÍ∞Ä Îß§ÎèÑ Ï§ëÏù¥Í±∞ÎÇò Î∂ÑÏÇ∞ Íµ¨Í∞Ñ
    (smart_money_bearish or distribution or sell_ratio > 65) and not accumulation
else
    true

// ÌÜµÌï© SHORT Ïã†Ìò∏
shortSignal_filtered = if useMultiTF
    if strictMode
        shortSignal_basic and trend_15m_bearish and trend_5m_bearish and shortSignal_stochRSI and shortSignal_BB and shortSignal_SmartMoney
    else
        shortSignal_basic and (trend_15m_bearish or trend_5m_bearish) and shortSignal_stochRSI and shortSignal_BB and shortSignal_SmartMoney
else
    shortSignal_basic and shortSignal_stochRSI and shortSignal_BB and shortSignal_SmartMoney

// ======================== Ï∞®Ìä∏ ÌëúÏãú ========================
// BB ÎùºÏù∏
plot(bb_upper_1m, color=color.new(color.blue, 50), linewidth=1, title="BB Upper")
plot(bb_middle_1m, color=color.new(color.gray, 50), linewidth=1, title="BB Middle")
plot(bb_lower_1m, color=color.new(color.blue, 50), linewidth=1, title="BB Lower")

// BB Ïä§ÌÄ¥Ï¶à Î∞∞Í≤Ω
bgcolor(bb_squeeze_1m ? color.new(color.yellow, 90) : na, title="BB Squeeze")

// üÜï ÎàÑÏ†Å/Î∂ÑÏÇ∞ Íµ¨Í∞Ñ Î∞∞Í≤ΩÏÉâ
bgcolor(show_accumulation and accumulation ? color.new(color.green, 95) : na, title="ÎàÑÏ†Å Íµ¨Í∞Ñ")
bgcolor(show_accumulation and distribution ? color.new(color.red, 95) : na, title="Î∂ÑÏÇ∞ Íµ¨Í∞Ñ")

// Ïã†Ìò∏ ÌëúÏãú
plotshape(longSignal_filtered, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.normal, title="üÜï v24 LONG")
plotshape(shortSignal_filtered, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.normal, title="üÜï v24 SHORT")

// üÜï Ïä§ÎßàÌä∏Î®∏Îãà Í∞êÏßÄ ÌëúÏãú (ÏµúÍ∑º 10Í∞úÎßå)
var label[] whaleLabels = array.new_label(10)
var label[] institutionLabels = array.new_label(10)
var int maxSmartMoneyLabels = 10

// ÌÅ∞ÏÜê Îß§Ïàò Í∞êÏßÄ
if whale_detected and close > open
    newLabel = label.new(bar_index, low, text="üêã", style=label.style_label_up, color=color.new(color.green, 0), textcolor=color.white, size=size.small)
    if array.size(whaleLabels) >= maxSmartMoneyLabels
        oldLabel = array.shift(whaleLabels)
        label.delete(oldLabel)
    array.push(whaleLabels, newLabel)

// ÌÅ∞ÏÜê Îß§ÎèÑ Í∞êÏßÄ
if whale_detected and close < open
    newLabel = label.new(bar_index, high, text="üêã", style=label.style_label_down, color=color.new(color.red, 0), textcolor=color.white, size=size.small)
    if array.size(whaleLabels) >= maxSmartMoneyLabels
        oldLabel = array.shift(whaleLabels)
        label.delete(oldLabel)
    array.push(whaleLabels, newLabel)

// Í∏∞Í¥Ä Îß§Ïàò Í∞êÏßÄ
if institution_detected and close > open
    newLabel = label.new(bar_index, low, text="üê≥", style=label.style_label_up, color=color.new(color.blue, 0), textcolor=color.white, size=size.normal)
    if array.size(institutionLabels) >= maxSmartMoneyLabels
        oldLabel = array.shift(institutionLabels)
        label.delete(oldLabel)
    array.push(institutionLabels, newLabel)

// Í∏∞Í¥Ä Îß§ÎèÑ Í∞êÏßÄ
if institution_detected and close < open
    newLabel = label.new(bar_index, high, text="üê≥", style=label.style_label_down, color=color.new(color.purple, 0), textcolor=color.white, size=size.normal)
    if array.size(institutionLabels) >= maxSmartMoneyLabels
        oldLabel = array.shift(institutionLabels)
        label.delete(oldLabel)
    array.push(institutionLabels, newLabel)

// EMA ÎùºÏù∏
plot(ema20_15m, color=color.blue, linewidth=1, title="EMA20 (15m)")
plot(ema50_15m, color=color.red, linewidth=1, title="EMA50 (15m)")

// ======================== Ïã†Ìò∏ Î∞úÏÉù Ïãú TP/SL ÎùºÎ≤® ========================
var label timeLabel = na
var line tp1Line = na
var line tp2Line = na
var line slLine = na
var int signalBarIndex = na
var float signalTP1 = na
var float signalTP2 = na
var float signalSL = na

if longSignal_filtered
    if not na(timeLabel)
        label.delete(timeLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    signalBarIndex := bar_index
    signalTP1 := close * (1 + tpPct1/100)
    signalTP2 := close * (1 + tpPct2/100)
    signalSL := close * (1 - slPct/100)

    string bbType = bb_scalp_long ? "üéØBBÎ∞òÏ†Ñ" : bb_breakout_up ? "üí•BBÎèåÌåå" : "üìäBBÏ§ëÎ¶Ω"
    string smartMoneyType = smart_money_bullish ? "üêãÎß§ÏàòÏÑ∏" : accumulation ? "üìàÎàÑÏ†Å" : ""

    timeLabel := label.new(bar_index, low - (high - low) * 0.2,
                          text="üìÖ " + str.format_time(time, "MM-dd HH:mm", "Asia/Seoul") +
                               "\nüî• v24 ÌÅ∞ÏÜêÍ∞êÏßÄ LONG / $" + str.tostring(close, "#.##") +
                               "\nTP1: $" + str.tostring(signalTP1, "#.##") + " / TP2: $" + str.tostring(signalTP2, "#.##") +
                               "\nSL: $" + str.tostring(signalSL, "#.##") +
                               "\n15m:" + (trend_15m_bullish ? "‚úÖ" : "‚ùå") + " 5m:" + (trend_5m_bullish ? "‚úÖ" : "‚ùå") +
                               "\nStochK:" + str.tostring(stochRSI_k, "#.#") + " " + (stochRSI_golden_cross ? "üü¢GC" : "") +
                               "\n" + bbType + " RSI:" + str.tostring(rsi_scalping, "#") +
                               "\nüÜï " + smartMoneyType + " Îß§Ïàò:" + str.tostring(buy_ratio, "#") + "%",
                          style=label.style_label_up,
                          color=color.new(color.green, 40),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, signalTP1, bar_index + 1, signalTP1, color=color.green, width=2, style=line.style_dashed, extend=extend.right)
    tp2Line := line.new(bar_index, signalTP2, bar_index + 1, signalTP2, color=color.green, width=2, style=line.style_solid, extend=extend.right)
    slLine := line.new(bar_index, signalSL, bar_index + 1, signalSL, color=color.red, width=2, style=line.style_solid, extend=extend.right)

if shortSignal_filtered
    if not na(timeLabel)
        label.delete(timeLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    signalBarIndex := bar_index
    signalTP1 := close * (1 - tpPct1/100)
    signalTP2 := close * (1 - tpPct2/100)
    signalSL := close * (1 + slPct/100)

    string bbType = bb_scalp_short ? "üéØBBÎ∞òÏ†Ñ" : bb_breakout_down ? "üí•BBÎèåÌåå" : "üìäBBÏ§ëÎ¶Ω"
    string smartMoneyType = smart_money_bearish ? "üêãÎß§ÎèÑÏÑ∏" : distribution ? "üìâÎ∂ÑÏÇ∞" : ""

    timeLabel := label.new(bar_index, high + (high - low) * 0.2,
                          text="üìÖ " + str.format_time(time, "MM-dd HH:mm", "Asia/Seoul") +
                               "\nüî• v24 ÌÅ∞ÏÜêÍ∞êÏßÄ SHORT / $" + str.tostring(close, "#.##") +
                               "\nTP1: $" + str.tostring(signalTP1, "#.##") + " / TP2: $" + str.tostring(signalTP2, "#.##") +
                               "\nSL: $" + str.tostring(signalSL, "#.##") +
                               "\n15m:" + (trend_15m_bearish ? "‚úÖ" : "‚ùå") + " 5m:" + (trend_5m_bearish ? "‚úÖ" : "‚ùå") +
                               "\nStochK:" + str.tostring(stochRSI_k, "#.#") + " " + (stochRSI_death_cross ? "üî¥DC" : "") +
                               "\n" + bbType + " RSI:" + str.tostring(rsi_scalping, "#") +
                               "\nüÜï " + smartMoneyType + " Îß§ÎèÑ:" + str.tostring(sell_ratio, "#") + "%",
                          style=label.style_label_down,
                          color=color.new(color.red, 40),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, signalTP1, bar_index + 1, signalTP1, color=color.green, width=2, style=line.style_dashed, extend=extend.right)
    tp2Line := line.new(bar_index, signalTP2, bar_index + 1, signalTP2, color=color.green, width=2, style=line.style_solid, extend=extend.right)
    slLine := line.new(bar_index, signalSL, bar_index + 1, signalSL, color=color.red, width=2, style=line.style_solid, extend=extend.right)

// ======================== Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î ========================
var table infoTable = table.new(position.top_right, 2, 16, bgcolor=color.white, border_width=1)

if barstate.islast
    table.clear(infoTable, 0, 0, 1, 15)

    // Ìó§Îçî
    table.cell(infoTable, 0, 0, "üÜï v24 ÌÅ∞ÏÜêÍ∞êÏßÄ", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.purple, 20))
    table.cell(infoTable, 1, 0, "Ïä§ÎßàÌä∏Î®∏Îãà", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 20))

    table.cell(infoTable, 0, 1, "Current Price", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 1, "$" + str.tostring(close, "#.#"), text_color=color.black, text_size=size.small)

    // üÜï Ïä§ÎßàÌä∏Î®∏Îãà Ï†ïÎ≥¥
    table.cell(infoTable, 0, 2, "üÜï Í±∞ÎûòÎüâ ÎπÑÏú®", text_color=color.black, text_size=size.small, bgcolor=color.new(color.orange, 80))
    string volStatus = str.tostring(volume_ratio, "#.##") + "x"
    color volColor = institution_detected ? color.purple : whale_detected ? color.blue : color.gray
    if institution_detected
        volStatus := volStatus + " üê≥Í∏∞Í¥Ä"
    else if whale_detected
        volStatus := volStatus + " üêãÌÅ∞ÏÜê"
    table.cell(infoTable, 1, 2, volStatus, text_color=volColor, text_size=size.small)

    table.cell(infoTable, 0, 3, "üÜï Îß§Ïàò/Îß§ÎèÑ ÏïïÎ†•", text_color=color.black, text_size=size.small, bgcolor=color.new(color.orange, 80))
    string pressureStatus = str.tostring(buy_ratio, "#") + "% / " + str.tostring(sell_ratio, "#") + "%"
    color pressureColor = buy_ratio > 65 ? color.green : sell_ratio > 65 ? color.red : color.gray
    table.cell(infoTable, 1, 3, pressureStatus, text_color=pressureColor, text_size=size.small)

    table.cell(infoTable, 0, 4, "üÜï ÏãúÏû• ÏÉÅÌÉú", text_color=color.black, text_size=size.small, bgcolor=color.new(color.orange, 80))
    string marketStatus = accumulation ? "üìà ÎàÑÏ†ÅÏ§ë" : distribution ? "üìâ Î∂ÑÏÇ∞Ï§ë" : "‚ö™ Ï§ëÎ¶Ω"
    color marketColor = accumulation ? color.green : distribution ? color.red : color.gray
    table.cell(infoTable, 1, 4, marketStatus, text_color=marketColor, text_size=size.small)

    table.cell(infoTable, 0, 5, "BB Width", text_color=color.black, text_size=size.small)
    string bbStatus = str.tostring(bb_width_1m*100, "#.##") + "% " + (bb_squeeze_1m ? "üü°Ïä§ÌÄ¥Ï¶à" : "")
    table.cell(infoTable, 1, 5, bbStatus, text_color=bb_squeeze_1m ? color.orange : color.blue, text_size=size.small)

    table.cell(infoTable, 0, 6, "Ïä§Ï∫òÌïë RSI", text_color=color.black, text_size=size.small)
    color rsiColor = rsi_scalping < bb_rsi_oversold ? color.green : rsi_scalping > bb_rsi_overbought ? color.red : color.gray
    table.cell(infoTable, 1, 6, str.tostring(rsi_scalping, "#.#"), text_color=rsiColor, text_size=size.small)

    table.cell(infoTable, 0, 7, "BB Position", text_color=color.black, text_size=size.small)
    string bbPos = close > bb_upper_1m ? "ÏÉÅÎã® Ïù¥ÌÉà" : close < bb_lower_1m ? "ÌïòÎã® Ïù¥ÌÉà" : "Î∞¥Îìú ÎÇ¥"
    color bbPosColor = close > bb_upper_1m ? color.red : close < bb_lower_1m ? color.green : color.gray
    table.cell(infoTable, 1, 7, bbPos, text_color=bbPosColor, text_size=size.small)

    table.cell(infoTable, 0, 8, "15m Trend", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 8, trend_15m_bullish ? "üü¢ BULL" : trend_15m_bearish ? "üî¥ BEAR" : "‚ö™ FLAT", text_color=trend_15m_bullish ? color.green : trend_15m_bearish ? color.red : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 9, "5m Trend", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 9, trend_5m_bullish ? "üü¢ BULL" : trend_5m_bearish ? "üî¥ BEAR" : "‚ö™ FLAT", text_color=trend_5m_bullish ? color.green : trend_5m_bearish ? color.red : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 10, "StochRSI K", text_color=color.black, text_size=size.small)
    string stochStatus = str.tostring(stochRSI_k, "#.#")
    color stochColor = stochRSI_k < stochRSI_oversold ? color.green : stochRSI_k > stochRSI_overbought ? color.red : color.gray
    if stochRSI_golden_cross
        stochStatus := stochStatus + " üü¢GC"
    if stochRSI_death_cross
        stochStatus := stochStatus + " üî¥DC"
    table.cell(infoTable, 1, 10, stochStatus, text_color=stochColor, text_size=size.small)

    table.cell(infoTable, 0, 11, "TP1/TP2/SL", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 11, str.tostring(tpPct1, "#.#") + "%/" + str.tostring(tpPct2, "#.#") + "%/" + str.tostring(slPct, "#.#") + "%", text_color=color.blue, text_size=size.small)

    table.cell(infoTable, 0, 12, "Leverage", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 12, str.tostring(leverageInput) + "Î∞∞ √ó " + str.tostring(riskPercentInput) + "%", text_color=color.orange, text_size=size.small)

    table.cell(infoTable, 0, 13, "Mode", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 13, strictMode ? "ÏóÑÍ≤©Î™®Îìú" : "ÏôÑÌôîÎ™®Îìú", text_color=strictMode ? color.red : color.green, text_size=size.small)

    // üÜï Ïã†Ìò∏ Í∞ïÎèÑ Í≥ÑÏÇ∞
    int signalStrength = 0
    string strengthText = ""
    color strengthColor = color.gray
    color strengthBg = color.white

    // LONG Ïã†Ìò∏ Í∞ïÎèÑ Í≥ÑÏÇ∞
    if longSignal_filtered
        signalStrength := 3  // Í∏∞Î≥∏ Ïã†Ìò∏
        if institution_detected and close > open
            signalStrength := signalStrength + 3  // üê≥ Í∏∞Í¥Ä Îß§Ïàò
        else if whale_detected and close > open
            signalStrength := signalStrength + 2  // üêã ÌÅ∞ÏÜê Îß§Ïàò
        if accumulation
            signalStrength := signalStrength + 2  // üìà ÎàÑÏ†Å
        if buy_ratio > 70
            signalStrength := signalStrength + 1  // Í∞ïÌïú Îß§ÏàòÏïïÎ†•

        strengthText := signalStrength >= 8 ? "üöÄ Ï¶âÏãú LONG!" : signalStrength >= 6 ? "‚úÖ LONG ÏßÑÏûÖ" : "‚ö†Ô∏è LONG Ïã†Ï§ë"
        strengthColor := signalStrength >= 8 ? color.white : signalStrength >= 6 ? color.green : color.orange
        strengthBg := signalStrength >= 8 ? color.new(color.green, 0) : signalStrength >= 6 ? color.new(color.green, 60) : color.new(color.orange, 60)

    // SHORT Ïã†Ìò∏ Í∞ïÎèÑ Í≥ÑÏÇ∞
    else if shortSignal_filtered
        signalStrength := 3  // Í∏∞Î≥∏ Ïã†Ìò∏
        if institution_detected and close < open
            signalStrength := signalStrength + 3  // üê≥ Í∏∞Í¥Ä Îß§ÎèÑ
        else if whale_detected and close < open
            signalStrength := signalStrength + 2  // üêã ÌÅ∞ÏÜê Îß§ÎèÑ
        if distribution
            signalStrength := signalStrength + 2  // üìâ Î∂ÑÏÇ∞
        if sell_ratio > 70
            signalStrength := signalStrength + 1  // Í∞ïÌïú Îß§ÎèÑÏïïÎ†•

        strengthText := signalStrength >= 8 ? "üìâ Ï¶âÏãú SHORT!" : signalStrength >= 6 ? "‚úÖ SHORT ÏßÑÏûÖ" : "‚ö†Ô∏è SHORT Ïã†Ï§ë"
        strengthColor := signalStrength >= 8 ? color.white : signalStrength >= 6 ? color.red : color.orange
        strengthBg := signalStrength >= 8 ? color.new(color.red, 0) : signalStrength >= 6 ? color.new(color.red, 60) : color.new(color.orange, 60)

    // Í¥ÄÎßù/ÎåÄÍ∏∞
    else
        if whale_detected or institution_detected
            if volume_ratio >= 3
                strengthText := "üê≥ ÌÅ∞ ÏõÄÏßÅÏûÑ Í∞êÏßÄ"
                strengthColor := color.blue
            else
                strengthText := "üêã ÌÅ∞ÏÜê ÌôúÎèô Ï§ë"
                strengthColor := color.blue
        else if accumulation
            strengthText := "üìà ÎàÑÏ†Å - LONG ÎåÄÍ∏∞"
            strengthColor := color.green
        else if distribution
            strengthText := "üìâ Î∂ÑÏÇ∞ - SHORT ÎåÄÍ∏∞"
            strengthColor := color.red
        else
            strengthText := "‚è∏Ô∏è Í¥ÄÎßù (Ïã†Ìò∏ÎåÄÍ∏∞)"
            strengthColor := color.gray

    // Ïã†Ìò∏ Í∞ïÎèÑ ÌëúÏãú
    table.cell(infoTable, 0, 14, "üéØ Ïã†Ìò∏ Í∞ïÎèÑ", text_color=color.black, text_size=size.small, bgcolor=color.new(color.yellow, 80))
    table.cell(infoTable, 1, 14, str.tostring(signalStrength) + " / 10", text_color=signalStrength >= 8 ? color.green : signalStrength >= 6 ? color.blue : color.gray, text_size=size.small)

    // ÏßÑÏûÖ Ï∂îÏ≤ú ÌëúÏãú (Í∞ÄÏû• Ï§ëÏöî!)
    table.cell(infoTable, 0, 15, "üí° Ïï°ÏÖò", text_color=color.black, text_size=size.small, bgcolor=strengthBg)
    table.cell(infoTable, 1, 15, strengthText, text_color=strengthColor, text_size=size.normal, bgcolor=strengthBg)

// ======================== ÏïåÎûå ÏÑ§Ï†ï ========================
if longSignal_filtered
    // üÜï v24: Ïä§ÎßàÌä∏Î®∏Îãà Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
    string jsonData = '{"version":"24",' +
          '"date":"' + str.format_time(time, "yyyy-MM-dd", "Asia/Seoul") + '",' +
          '"time":"' + str.format_time(time, "HH:mm", "Asia/Seoul") + '",' +
          '"signal":"LONG",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"tp1":"' + str.tostring(close * (1 + tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 + tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 - slPct/100), "#.##") + '",' +
          '"trend15m":"' + (trend_15m_bullish ? "BULL" : "BEAR") + '",' +
          '"trend5m":"' + (trend_5m_bullish ? "BULL" : trend_5m_bearish ? "BEAR" : "FLAT") + '",' +
          '"stochRSI_k":"' + str.tostring(stochRSI_k, "#.##") + '",' +
          '"stochRSI_signal":"' + (stochRSI_golden_cross ? "GOLDEN_CROSS" : stochRSI_k < stochRSI_oversold ? "OVERSOLD" : "BULLISH") + '",' +
          '"bb_width":"' + str.tostring(bb_width_1m*100, "#.##") + '",' +
          '"bb_squeeze":"' + (bb_squeeze_1m ? "true" : "false") + '",' +
          '"scalping_rsi":"' + str.tostring(rsi_scalping, "#.##") + '",' +
          '"bb_signal":"' + (bb_scalp_long ? "BB_REVERSAL" : bb_breakout_up ? "BB_BREAKOUT" : "BB_NEUTRAL") + '",' +
          '"volume_ratio":"' + str.tostring(volume_ratio, "#.##") + '",' +
          '"smart_money":"' + (institution_detected ? "INSTITUTION" : whale_detected ? "WHALE" : "NONE") + '",' +
          '"buy_pressure":"' + str.tostring(buy_ratio, "#.##") + '",' +
          '"market_phase":"' + (accumulation ? "ACCUMULATION" : distribution ? "DISTRIBUTION" : "NEUTRAL") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)

if shortSignal_filtered
    // üÜï v24: Ïä§ÎßàÌä∏Î®∏Îãà Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
    string jsonData = '{"version":"24",' +
          '"date":"' + str.format_time(time, "yyyy-MM-dd", "Asia/Seoul") + '",' +
          '"time":"' + str.format_time(time, "HH:mm", "Asia/Seoul") + '",' +
          '"signal":"SHORT",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"tp1":"' + str.tostring(close * (1 - tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 - tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 + slPct/100), "#.##") + '",' +
          '"trend15m":"' + (trend_15m_bearish ? "BEAR" : "BULL") + '",' +
          '"trend5m":"' + (trend_5m_bullish ? "BULL" : trend_5m_bearish ? "BEAR" : "FLAT") + '",' +
          '"stochRSI_k":"' + str.tostring(stochRSI_k, "#.##") + '",' +
          '"stochRSI_signal":"' + (stochRSI_death_cross ? "DEATH_CROSS" : stochRSI_k > stochRSI_overbought ? "OVERBOUGHT" : "BEARISH") + '",' +
          '"bb_width":"' + str.tostring(bb_width_1m*100, "#.##") + '",' +
          '"bb_squeeze":"' + (bb_squeeze_1m ? "true" : "false") + '",' +
          '"scalping_rsi":"' + str.tostring(rsi_scalping, "#.##") + '",' +
          '"bb_signal":"' + (bb_scalp_short ? "BB_REVERSAL" : bb_breakout_down ? "BB_BREAKOUT" : "BB_NEUTRAL") + '",' +
          '"volume_ratio":"' + str.tostring(volume_ratio, "#.##") + '",' +
          '"smart_money":"' + (institution_detected ? "INSTITUTION" : whale_detected ? "WHALE" : "NONE") + '",' +
          '"sell_pressure":"' + str.tostring(sell_ratio, "#.##") + '",' +
          '"market_phase":"' + (accumulation ? "ACCUMULATION" : distribution ? "DISTRIBUTION" : "NEUTRAL") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)
