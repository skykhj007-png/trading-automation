//@version=5
indicator("í´ë¡œë“œ28 HTFë³¼ë¥¨ (15ë¶„ë´‰ ê±°ë˜ëŸ‰ ì»¨íŒ)", overlay=true, max_labels_count=100)

// ============================================
// V28 í•µì‹¬ ë³€ê²½ì‚¬í•­:
// - 15ë¶„ë´‰ ê±°ë˜ëŸ‰ ì»¨íŒ ì¶”ê°€ (V27 + ë³¼ë¥¨ HTF)
// - í˜„ì¬TF ê±°ë˜ëŸ‰ + 15ë¶„ë´‰ ê±°ë˜ëŸ‰ AND ì¡°ê±´
// - ê°€ì§œ ê±°ë˜ëŸ‰ ìŠ¤íŒŒì´í¬ í•„í„°ë§
// - ë” ì‹ ë¢°ì„± ë†’ì€ ê³ ë˜ ê°ì§€
// ============================================

// ============================================
// ê±°ë˜ ëª¨ë“œ ì„ íƒ
// ============================================
tradeMode = input.string("ì„ ë¬¼", title="ê±°ë˜ ëª¨ë“œ", options=["ì„ ë¬¼", "í˜„ë¬¼ì½”ì¸", "ì£¼ì‹"],
    tooltip="ì„ ë¬¼: LONG+SHORT, í˜„ë¬¼ì½”ì¸: LONGë§Œ, ì£¼ì‹: LONGë§Œ")

// ============================================
// ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì»¨íŒ ì„¤ì •
// ============================================
useHTFConfirm = input.bool(true, title="ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì¶”ì„¸ ì»¨íŒ",
    tooltip="15ë¶„/1ì‹œê°„ë´‰ ì¶”ì„¸ê°€ ì¼ì¹˜í•´ì•¼ë§Œ ì‹ í˜¸ ë°œìƒ")
htfTimeframe1 = input.timeframe("15", title="ì»¨íŒ íƒ€ì„í”„ë ˆì„ 1",
    tooltip="ì²« ë²ˆì§¸ ìƒìœ„ íƒ€ì„í”„ë ˆì„ (ê¸°ë³¸: 15ë¶„)")
htfTimeframe2 = input.timeframe("60", title="ì»¨íŒ íƒ€ì„í”„ë ˆì„ 2",
    tooltip="ë‘ ë²ˆì§¸ ìƒìœ„ íƒ€ì„í”„ë ˆì„ (ê¸°ë³¸: 1ì‹œê°„)")
requireBothHTF = input.bool(false, title="ë‘ íƒ€ì„í”„ë ˆì„ ëª¨ë‘ ì¼ì¹˜ í•„ìš”",
    tooltip="ì²´í¬ì‹œ 15ë¶„+1ì‹œê°„ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ ì‹ í˜¸. í•´ì œì‹œ í•˜ë‚˜ë§Œ ì¼ì¹˜í•´ë„ ì‹ í˜¸")

// ============================================
// V28 ì‹ ê·œ: ìƒìœ„ íƒ€ì„í”„ë ˆì„ ê±°ë˜ëŸ‰ ì»¨íŒ ì„¤ì •
// ============================================
useHTFVolumeConfirm = input.bool(true, title="15ë¶„ë´‰ ê±°ë˜ëŸ‰ ì»¨íŒ (V28)",
    tooltip="15ë¶„ë´‰ì—ì„œë„ í‰ê·  ì´ìƒ ê±°ë˜ëŸ‰ì´ì–´ì•¼ ì‹ í˜¸ ë°œìƒ")
htfVolumeRatioMin = input.float(1.2, title="15ë¶„ë´‰ ìµœì†Œ ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=0.8, maxval=3.0, step=0.1,
    tooltip="15ë¶„ë´‰ ê±°ë˜ëŸ‰ì´ í‰ê· ì˜ ëª‡ ë°° ì´ìƒì´ì–´ì•¼ í•˜ëŠ”ì§€")
currentTFVolumeMin = input.float(1.5, title="í˜„ì¬TF ìµœì†Œ ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=1.0, maxval=5.0, step=0.1,
    tooltip="í˜„ì¬ íƒ€ì„í”„ë ˆì„ ê±°ë˜ëŸ‰ì´ í‰ê· ì˜ ëª‡ ë°° ì´ìƒì´ì–´ì•¼ í•˜ëŠ”ì§€")

// ============================================
// ë ˆë²„ë¦¬ì§€ ì„¤ì • (TP/SL ìë™ ì—°ë™)
// ============================================
leverageInput = input.int(5, title="ë ˆë²„ë¦¬ì§€", minval=1, maxval=50, step=1,
    tooltip="ë ˆë²„ë¦¬ì§€ì— ë”°ë¼ TP/SL ìë™ ì¡°ì •ë¨\në†’ì€ ë ˆë²„ë¦¬ì§€ = ì¢ì€ TP/SL")

// ë ˆë²„ë¦¬ì§€ ê¸°ë°˜ TP/SL ê³„ì‚°
float leverageMultiplier = 5.0 / leverageInput

// ëª¨ë“œë³„ ê¸°ë³¸ê°’ (5ë°° ë ˆë²„ë¦¬ì§€ ê¸°ì¤€)
float baseTP1 = tradeMode == "ì„ ë¬¼" ? 1.0 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.5 : 2.0
float baseTP2 = tradeMode == "ì„ ë¬¼" ? 2.0 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 3.0 : 4.0
float baseSL = tradeMode == "ì„ ë¬¼" ? 0.5 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.0 : 1.5

// ë ˆë²„ë¦¬ì§€ ì ìš©ëœ TP/SL (ì„ ë¬¼ì—ì„œë§Œ ì ìš©)
float defaultTP1 = tradeMode == "ì„ ë¬¼" ? baseTP1 * leverageMultiplier : baseTP1
float defaultTP2 = tradeMode == "ì„ ë¬¼" ? baseTP2 * leverageMultiplier : baseTP2
float defaultSL = tradeMode == "ì„ ë¬¼" ? baseSL * leverageMultiplier : baseSL

// ìµœì†Œ/ìµœëŒ€ ì œí•œ
defaultTP1 := math.max(0.3, math.min(defaultTP1, 5.0))
defaultTP2 := math.max(0.5, math.min(defaultTP2, 10.0))
defaultSL := math.max(0.15, math.min(defaultSL, 3.0))

// ìˆ˜ë™ ì˜¤ë²„ë¼ì´ë“œ ì˜µì…˜
useAutoTPSL = input.bool(true, title="ìë™ TP/SL ì‚¬ìš©")
manualTP1 = input.float(1.0, title="ìˆ˜ë™ TP1 (%)", minval=0.1, maxval=10.0, step=0.1)
manualTP2 = input.float(2.0, title="ìˆ˜ë™ TP2 (%)", minval=0.1, maxval=20.0, step=0.1)
manualSL = input.float(0.5, title="ìˆ˜ë™ SL (%)", minval=0.1, maxval=5.0, step=0.1)

// ìµœì¢… TP/SL ê°’
float tpPct1 = useAutoTPSL ? defaultTP1 : manualTP1
float tpPct2 = useAutoTPSL ? defaultTP2 : manualTP2
float slPct = useAutoTPSL ? defaultSL : manualSL

// ============================================
// ì‹ í˜¸ í’ˆì§ˆ ì„¤ì •
// ============================================
minSignalStrength = input.int(14, title="ìµœì†Œ ì‹ í˜¸ ê°•ë„", minval=10, maxval=20)
minBarsBetweenSignals = input.int(5, title="ì‹ í˜¸ ìµœì†Œ ê°„ê²© (ë´‰)", minval=3, maxval=20)
requireVolumeConfirm = input.bool(true, title="ê±°ë˜ëŸ‰ í™•ì¸ í•„ìˆ˜")

// ============================================
// ADX ì„¤ì •
// ============================================
useADXFilter = input.bool(true, title="ADX í•„í„° ì‚¬ìš©")
adxLength = input.int(14, title="ADX ê¸¸ì´", minval=7, maxval=30)
adxThreshold = input.float(20.0, title="ADX ì„ê³„ê°’", minval=15.0, maxval=35.0, step=1.0)

// ============================================
// í˜„ì¬ íƒ€ì„í”„ë ˆì„ ì§€í‘œ ê³„ì‚°
// ============================================

// ì´ë™í‰ê· ì„ 
ema9 = ta.ema(close, 9)
ema21 = ta.ema(close, 21)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)
vwap50 = ta.vwma(close, 50)

// ì¶”ì„¸ ì •ì˜
strongUptrend = ema9 > ema21 and ema21 > ema50 and close > ema200
strongDowntrend = ema9 < ema21 and ema21 < ema50 and close < ema200
isUptrend = ema9 > ema21 and close > ema50
isDowntrend = ema9 < ema21 and close < ema50

// ADX
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)
noTrend = adx < adxThreshold
trendExists = adx >= adxThreshold
strongTrend = adx >= 25
veryStrongTrend = adx >= 30
bullishDI = diPlus > diMinus
bearishDI = diMinus > diPlus
diCrossUp = ta.crossover(diPlus, diMinus)
diCrossDown = ta.crossunder(diPlus, diMinus)

// RSI
rsi = ta.rsi(close, 14)
rsiOversold = rsi < 30
rsiOverbought = rsi > 70
rsiBullish = rsi > 50 and rsi < 70
rsiBearish = rsi < 50 and rsi > 30

// Stochastic RSI
stochRsi = ta.stoch(rsi, rsi, rsi, 14)
stochK = ta.sma(stochRsi, 3)
stochD = ta.sma(stochK, 3)
stochOversold = stochK < 15
stochOverbought = stochK > 85
stochGoldenCross = ta.crossover(stochK, stochD) and stochK < 30
stochDeadCross = ta.crossunder(stochK, stochD) and stochK > 70

// MACD
[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
macdBullish = macdLine > signalLine and histogram > 0
macdBearish = macdLine < signalLine and histogram < 0
macdCrossUp = ta.crossover(macdLine, signalLine)
macdCrossDown = ta.crossunder(macdLine, signalLine)

// Bollinger Bands
bbBasis = ta.sma(close, 20)
bbDev = ta.stdev(close, 20)
bbUpper = bbBasis + 2 * bbDev
bbLower = bbBasis - 2 * bbDev
bbWidth = (bbUpper - bbLower) / bbBasis * 100
touchingBBLower = low <= bbLower
touchingBBUpper = high >= bbUpper
bbSqueeze = bbWidth < ta.sma(bbWidth, 20) * 0.7

// ============================================
// í˜„ì¬ íƒ€ì„í”„ë ˆì„ ê±°ë˜ëŸ‰ ë¶„ì„
// ============================================
avgVolume = ta.sma(volume, 20)
volumeRatio = volume / avgVolume
volumeConfirm = volumeRatio >= 1.0
highVolume = volumeRatio >= 1.5
veryHighVolume = volumeRatio >= 2.0

// V28: í˜„ì¬TF ê°•í™”ëœ ê±°ë˜ëŸ‰ ì¡°ê±´
currentTFVolumeOK = volumeRatio >= currentTFVolumeMin

bullVolume = close > open ? volume : volume * (close - low) / math.max(high - low, 0.0001)
bearVolume = close < open ? volume : volume * (high - close) / math.max(high - low, 0.0001)
buyPressure = bullVolume / (bullVolume + bearVolume) * 100
strongBuyPressure = buyPressure > 65
strongSellPressure = buyPressure < 35

// ============================================
// V28 í•µì‹¬: 15ë¶„ë´‰ ê±°ë˜ëŸ‰ ì»¨íŒ
// ============================================

// 15ë¶„ë´‰ ê±°ë˜ëŸ‰ ë°ì´í„°
htf_volume = request.security(syminfo.tickerid, htfTimeframe1, volume, lookahead=barmerge.lookahead_off)
htf_avgVolume = request.security(syminfo.tickerid, htfTimeframe1, ta.sma(volume, 20), lookahead=barmerge.lookahead_off)
htf_volumeRatio = htf_volume / htf_avgVolume

// 15ë¶„ë´‰ ê±°ë˜ëŸ‰ ì¡°ê±´
htfVolumeOK = htf_volumeRatio >= htfVolumeRatioMin

// 15ë¶„ë´‰ ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥
htf_close = request.security(syminfo.tickerid, htfTimeframe1, close, lookahead=barmerge.lookahead_off)
htf_open = request.security(syminfo.tickerid, htfTimeframe1, open, lookahead=barmerge.lookahead_off)
htf_high = request.security(syminfo.tickerid, htfTimeframe1, high, lookahead=barmerge.lookahead_off)
htf_low = request.security(syminfo.tickerid, htfTimeframe1, low, lookahead=barmerge.lookahead_off)

htf_bullVolume = htf_close > htf_open ? htf_volume : htf_volume * (htf_close - htf_low) / math.max(htf_high - htf_low, 0.0001)
htf_bearVolume = htf_close < htf_open ? htf_volume : htf_volume * (htf_high - htf_close) / math.max(htf_high - htf_low, 0.0001)
htf_buyPressure = htf_bullVolume / (htf_bullVolume + htf_bearVolume) * 100
htf_strongBuyPressure = htf_buyPressure > 60
htf_strongSellPressure = htf_buyPressure < 40

// V28 ìµœì¢… ê±°ë˜ëŸ‰ ì»¨íŒ (í˜„ì¬TF + 15ë¶„ë´‰ AND)
bool volumeFullConfirm = true
if useHTFVolumeConfirm
    volumeFullConfirm := currentTFVolumeOK and htfVolumeOK
else
    volumeFullConfirm := volumeConfirm

// ============================================
// ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì¶”ì„¸ ì»¨íŒ
// ============================================

// === 15ë¶„ë´‰ (HTF1) ì§€í‘œ ===
htf1_ema20 = request.security(syminfo.tickerid, htfTimeframe1, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
htf1_ema50 = request.security(syminfo.tickerid, htfTimeframe1, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
htf1_rsi = request.security(syminfo.tickerid, htfTimeframe1, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

// 15ë¶„ë´‰ ADX
[htf1_diPlus, htf1_diMinus, htf1_adx_raw] = ta.dmi(14, 14)
htf1_adx = request.security(syminfo.tickerid, htfTimeframe1, htf1_adx_raw, lookahead=barmerge.lookahead_off)
htf1_diPlus_sec = request.security(syminfo.tickerid, htfTimeframe1, htf1_diPlus, lookahead=barmerge.lookahead_off)
htf1_diMinus_sec = request.security(syminfo.tickerid, htfTimeframe1, htf1_diMinus, lookahead=barmerge.lookahead_off)

// 15ë¶„ë´‰ MACD
[htf1_macdLine, htf1_signalLine, htf1_hist] = request.security(syminfo.tickerid, htfTimeframe1, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

// 15ë¶„ë´‰ ì¶”ì„¸ íŒë‹¨
htf1_bullish = htf1_ema20 > htf1_ema50 and htf1_rsi > 45 and htf1_rsi < 75 and htf1_macdLine > htf1_signalLine
htf1_bearish = htf1_ema20 < htf1_ema50 and htf1_rsi < 55 and htf1_rsi > 25 and htf1_macdLine < htf1_signalLine
htf1_trending = htf1_adx >= 18
htf1_bullDI = htf1_diPlus_sec > htf1_diMinus_sec
htf1_bearDI = htf1_diMinus_sec > htf1_diPlus_sec

// === 1ì‹œê°„ë´‰ (HTF2) ì§€í‘œ ===
htf2_ema20 = request.security(syminfo.tickerid, htfTimeframe2, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
htf2_ema50 = request.security(syminfo.tickerid, htfTimeframe2, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
htf2_rsi = request.security(syminfo.tickerid, htfTimeframe2, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

// 1ì‹œê°„ë´‰ ADX
[htf2_diPlus, htf2_diMinus, htf2_adx_raw] = ta.dmi(14, 14)
htf2_adx = request.security(syminfo.tickerid, htfTimeframe2, htf2_adx_raw, lookahead=barmerge.lookahead_off)
htf2_diPlus_sec = request.security(syminfo.tickerid, htfTimeframe2, htf2_diPlus, lookahead=barmerge.lookahead_off)
htf2_diMinus_sec = request.security(syminfo.tickerid, htfTimeframe2, htf2_diMinus, lookahead=barmerge.lookahead_off)

// 1ì‹œê°„ë´‰ MACD
[htf2_macdLine, htf2_signalLine, htf2_hist] = request.security(syminfo.tickerid, htfTimeframe2, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

// 1ì‹œê°„ë´‰ ì¶”ì„¸ íŒë‹¨
htf2_bullish = htf2_ema20 > htf2_ema50 and htf2_rsi > 45 and htf2_rsi < 75 and htf2_macdLine > htf2_signalLine
htf2_bearish = htf2_ema20 < htf2_ema50 and htf2_rsi < 55 and htf2_rsi > 25 and htf2_macdLine < htf2_signalLine
htf2_trending = htf2_adx >= 18
htf2_bullDI = htf2_diPlus_sec > htf2_diMinus_sec
htf2_bearDI = htf2_diMinus_sec > htf2_diPlus_sec

// === ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì»¨íŒ ê²°ê³¼ ===
// LONG ì»¨íŒ
htf1_longConfirm = htf1_bullish and htf1_bullDI
htf2_longConfirm = htf2_bullish and htf2_bullDI

// SHORT ì»¨íŒ
htf1_shortConfirm = htf1_bearish and htf1_bearDI
htf2_shortConfirm = htf2_bearish and htf2_bearDI

// ìµœì¢… ì»¨íŒ (ë‘ ê°œ ëª¨ë‘ ë˜ëŠ” í•˜ë‚˜ë§Œ)
bool htfLongConfirmed = false
bool htfShortConfirmed = false

if requireBothHTF
    htfLongConfirmed := htf1_longConfirm and htf2_longConfirm
    htfShortConfirmed := htf1_shortConfirm and htf2_shortConfirm
else
    htfLongConfirmed := htf1_longConfirm or htf2_longConfirm
    htfShortConfirmed := htf1_shortConfirm or htf2_shortConfirm

// ============================================
// ì‹ í˜¸ ê°„ê²© ì¶”ì 
// ============================================
var int barsSinceLastLong = 999
var int barsSinceLastShort = 999
barsSinceLastLong := barsSinceLastLong + 1
barsSinceLastShort := barsSinceLastShort + 1
canSignalLong = barsSinceLastLong >= minBarsBetweenSignals
canSignalShort = barsSinceLastShort >= minBarsBetweenSignals

// ============================================
// ì ìˆ˜ ì‹œìŠ¤í…œ
// ============================================

// LONG ì ìˆ˜ (ìµœëŒ€ 24ì )
var float trendScore = 0.0
trendScore := 0.0
if strongUptrend
    trendScore += 4
else if isUptrend
    trendScore += 2
if htf1_bullish
    trendScore += 2
if htf2_bullish
    trendScore += 2

var float momentumScore = 0.0
momentumScore := 0.0
if stochGoldenCross
    momentumScore += 3
else if stochOversold
    momentumScore += 2
if macdCrossUp or macdBullish
    momentumScore += 2
if rsiBullish
    momentumScore += 2
if diCrossUp or (bullishDI and trendExists)
    momentumScore += 1

var float volumeScore = 0.0
volumeScore := 0.0
// V28: 15ë¶„ë´‰ ê±°ë˜ëŸ‰ë„ ì ìˆ˜ì— ë°˜ì˜
if veryHighVolume and strongBuyPressure and htfVolumeOK and htf_strongBuyPressure
    volumeScore += 5  // ë³´ë„ˆìŠ¤ ì ìˆ˜
else if veryHighVolume and strongBuyPressure
    volumeScore += 4
else if highVolume and strongBuyPressure
    volumeScore += 3
else if volumeConfirm and buyPressure > 55
    volumeScore += 2
else if volumeConfirm
    volumeScore += 1

var float technicalScore = 0.0
technicalScore := 0.0
if touchingBBLower and stochOversold
    technicalScore += 2
if close > vwap50
    technicalScore += 1
if close > ema200
    technicalScore += 1

var float totalScore = 0.0
totalScore := trendScore + momentumScore + volumeScore + technicalScore

// SHORT ì ìˆ˜
var float trendScoreShort = 0.0
trendScoreShort := 0.0
if strongDowntrend
    trendScoreShort += 4
else if isDowntrend
    trendScoreShort += 2
if htf1_bearish
    trendScoreShort += 2
if htf2_bearish
    trendScoreShort += 2

var float momentumScoreShort = 0.0
momentumScoreShort := 0.0
if stochDeadCross
    momentumScoreShort += 3
else if stochOverbought
    momentumScoreShort += 2
if macdCrossDown or macdBearish
    momentumScoreShort += 2
if rsiBearish
    momentumScoreShort += 2
if diCrossDown or (bearishDI and trendExists)
    momentumScoreShort += 1

var float volumeScoreShort = 0.0
volumeScoreShort := 0.0
// V28: 15ë¶„ë´‰ ê±°ë˜ëŸ‰ë„ ì ìˆ˜ì— ë°˜ì˜
if veryHighVolume and strongSellPressure and htfVolumeOK and htf_strongSellPressure
    volumeScoreShort += 5  // ë³´ë„ˆìŠ¤ ì ìˆ˜
else if veryHighVolume and strongSellPressure
    volumeScoreShort += 4
else if highVolume and strongSellPressure
    volumeScoreShort += 3
else if volumeConfirm and buyPressure < 45
    volumeScoreShort += 2
else if volumeConfirm
    volumeScoreShort += 1

var float technicalScoreShort = 0.0
technicalScoreShort := 0.0
if touchingBBUpper and stochOverbought
    technicalScoreShort += 2
if close < vwap50
    technicalScoreShort += 1
if close < ema200
    technicalScoreShort += 1

var float totalScoreShort = 0.0
totalScoreShort := trendScoreShort + momentumScoreShort + volumeScoreShort + technicalScoreShort

// ============================================
// ìµœì¢… ì‹ í˜¸ ê²°ì • (V28: HTF ì¶”ì„¸ + HTF ê±°ë˜ëŸ‰ ì»¨íŒ!)
// ============================================

// LONG ì¡°ê±´
longBase = totalScore >= minSignalStrength
longBase := longBase and canSignalLong
longBase := longBase and isUptrend

// V28: ê±°ë˜ëŸ‰ í™•ì¸ (í˜„ì¬TF + 15ë¶„ë´‰)
if requireVolumeConfirm
    longBase := longBase and volumeFullConfirm

// ADX í•„í„°
if useADXFilter
    longBase := longBase and trendExists and bullishDI

// StochRSI í™•ì¸
longBase := longBase and (stochOversold or stochGoldenCross or (stochK < 50 and stochK > stochD))

// ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì¶”ì„¸ ì»¨íŒ
if useHTFConfirm
    longBase := longBase and htfLongConfirmed

// V28: 15ë¶„ë´‰ ë§¤ìˆ˜ ì••ë ¥ í™•ì¸ (ì„ íƒì )
if useHTFVolumeConfirm
    longBase := longBase and (htf_buyPressure > 50)

longSignal_final = longBase

// SHORT ì¡°ê±´ (ì„ ë¬¼ë§Œ)
shortBase = false
if tradeMode == "ì„ ë¬¼"
    shortBase := totalScoreShort >= minSignalStrength
    shortBase := shortBase and canSignalShort
    shortBase := shortBase and isDowntrend

    // V28: ê±°ë˜ëŸ‰ í™•ì¸ (í˜„ì¬TF + 15ë¶„ë´‰)
    if requireVolumeConfirm
        shortBase := shortBase and volumeFullConfirm

    if useADXFilter
        shortBase := shortBase and trendExists and bearishDI

    shortBase := shortBase and (stochOverbought or stochDeadCross or (stochK > 50 and stochK < stochD))

    // ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì¶”ì„¸ ì»¨íŒ
    if useHTFConfirm
        shortBase := shortBase and htfShortConfirmed

    // V28: 15ë¶„ë´‰ ë§¤ë„ ì••ë ¥ í™•ì¸ (ì„ íƒì )
    if useHTFVolumeConfirm
        shortBase := shortBase and (htf_buyPressure < 50)

shortSignal_final = shortBase

// ì‹ í˜¸ ë°œìƒì‹œ ì¹´ìš´í„° ë¦¬ì…‹
if longSignal_final
    barsSinceLastLong := 0
if shortSignal_final
    barsSinceLastShort := 0

// EXIT ì‹ í˜¸ (V28: 15ë¶„ë´‰ ê±°ë˜ëŸ‰ë„ í™•ì¸)
whaleExitSignal = (tradeMode == "í˜„ë¬¼ì½”ì¸" or tradeMode == "ì£¼ì‹") and
                  veryHighVolume and strongSellPressure and isDowntrend and
                  htfVolumeOK and htf_strongSellPressure

// ============================================
// ì°¨íŠ¸ í‘œì‹œ
// ============================================

// ì´ë™í‰ê· ì„ 
plot(ema21, color=color.new(color.orange, 0), linewidth=2, title="EMA 21")
plot(ema50, color=color.new(color.blue, 0), linewidth=2, title="EMA 50")
plot(ema200, color=color.new(color.purple, 0), linewidth=2, title="EMA 200")

// Bollinger Bands
plot(bbUpper, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(bbLower, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")

// ì‹ í˜¸ í‘œì‹œ
plotshape(longSignal_final, style=shape.triangleup, location=location.belowbar,
         color=color.new(color.green, 0), size=size.normal, title="LONG ì‹ í˜¸")
plotshape(shortSignal_final, style=shape.triangledown, location=location.abovebar,
         color=color.new(color.red, 0), size=size.normal, title="SHORT ì‹ í˜¸")

// EXIT ê²½ê³ 
plotshape(whaleExitSignal, style=shape.xcross, location=location.abovebar,
         color=color.new(color.orange, 0), size=size.small, title="EXIT ê²½ê³ ")

// ì¶”ì„¸ ë°°ê²½
bgcolor(strongUptrend ? color.new(color.green, 92) : strongDowntrend ? color.new(color.red, 92) : na)
bgcolor(bbSqueeze ? color.new(color.yellow, 90) : na, title="BB ìŠ¤í€´ì¦ˆ")

// ============================================
// ì‹ í˜¸ ë¼ë²¨
// ============================================

var label signalLabel = na
var line tp1Line = na
var line tp2Line = na
var line slLine = na

string modeEmoji = tradeMode == "ì„ ë¬¼" ? "âš¡" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "ğŸª™" : "ğŸ“ˆ"
string modeText = tradeMode == "ì„ ë¬¼" ? "FUTURES" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "SPOT" : "STOCK"

if longSignal_final
    if not na(signalLabel)
        label.delete(signalLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 + tpPct1/100)
    float labelTp2 = close * (1 + tpPct2/100)
    float labelSl = close * (1 - slPct/100)

    // HTF ìƒíƒœ í…ìŠ¤íŠ¸
    string htf1Status = htf1_longConfirm ? "âœ…" : "âŒ"
    string htf2Status = htf2_longConfirm ? "âœ…" : "âŒ"
    string htfVolStatus = htfVolumeOK ? "âœ…" : "âŒ"

    signalLabel := label.new(bar_index, low - (high - low) * 0.3,
                          text=modeEmoji + " LONG [V28 HTFVol]\n" +
                               "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
                               "ì ìˆ˜: " + str.tostring(totalScore, "#.#") + "/24\n" +
                               "15ë¶„: " + htf1Status + " | 1ì‹œê°„: " + htf2Status + "\n" +
                               "15ë¶„ ê±°ë˜ëŸ‰: " + htfVolStatus + " (" + str.tostring(htf_volumeRatio, "#.#") + "x)\n" +
                               "â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                               "TP1: $" + str.tostring(labelTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
                               "TP2: $" + str.tostring(labelTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
                               "SL: $" + str.tostring(labelSl, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)",
                          style=label.style_label_up,
                          color=color.new(color.green, 20),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 20, labelTp1,
                       color=color.new(color.green, 0), width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 20, labelTp2,
                       color=color.new(color.green, 0), width=3, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 20, labelSl,
                      color=color.new(color.red, 0), width=2, style=line.style_solid)

if shortSignal_final
    if not na(signalLabel)
        label.delete(signalLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 - tpPct1/100)
    float labelTp2 = close * (1 - tpPct2/100)
    float labelSl = close * (1 + slPct/100)

    string htf1Status = htf1_shortConfirm ? "âœ…" : "âŒ"
    string htf2Status = htf2_shortConfirm ? "âœ…" : "âŒ"
    string htfVolStatus = htfVolumeOK ? "âœ…" : "âŒ"

    signalLabel := label.new(bar_index, high + (high - low) * 0.3,
                          text="âš¡ SHORT [V28 HTFVol]\n" +
                               "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
                               "ì ìˆ˜: " + str.tostring(totalScoreShort, "#.#") + "/24\n" +
                               "15ë¶„: " + htf1Status + " | 1ì‹œê°„: " + htf2Status + "\n" +
                               "15ë¶„ ê±°ë˜ëŸ‰: " + htfVolStatus + " (" + str.tostring(htf_volumeRatio, "#.#") + "x)\n" +
                               "â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                               "TP1: $" + str.tostring(labelTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
                               "TP2: $" + str.tostring(labelTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
                               "SL: $" + str.tostring(labelSl, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)",
                          style=label.style_label_down,
                          color=color.new(color.red, 20),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 20, labelTp1,
                       color=color.new(color.green, 0), width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 20, labelTp2,
                       color=color.new(color.green, 0), width=3, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 20, labelSl,
                      color=color.new(color.red, 0), width=2, style=line.style_solid)

// ============================================
// ì •ë³´ í…Œì´ë¸” (V28: HTF ê±°ë˜ëŸ‰ ìƒíƒœ ì¶”ê°€)
// ============================================

var table infoTable = table.new(position.top_right, 2, 22, bgcolor=color.new(color.white, 10), border_width=1)

if barstate.islast
    table.clear(infoTable, 0, 0, 1, 21)

    // ë²„ì „ & ëª¨ë“œ
    modeColor = tradeMode == "ì„ ë¬¼" ? color.purple : tradeMode == "í˜„ë¬¼ì½”ì¸" ? color.orange : color.blue
    table.cell(infoTable, 0, 0, modeEmoji + " V28 HTFVol", text_color=color.white, text_size=size.normal,
              bgcolor=color.new(modeColor, 20))
    table.cell(infoTable, 1, 0, modeText, text_color=color.white, text_size=size.normal,
              bgcolor=color.new(modeColor, 20))

    table.cell(infoTable, 0, 1, "í˜„ì¬ê°€", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 1, "$" + str.tostring(close, "#.##"), text_color=color.black, text_size=size.small)

    table.cell(infoTable, 0, 2, "ë ˆë²„ë¦¬ì§€", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(leverageInput) + "x",
              text_color=leverageInput >= 10 ? color.red : leverageInput >= 5 ? color.orange : color.green, text_size=size.small)

    table.cell(infoTable, 0, 3, "TP1/TP2/SL", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(tpPct1, "#.##") + "/" + str.tostring(tpPct2, "#.##") + "/" + str.tostring(slPct, "#.##") + "%",
              text_color=color.black, text_size=size.small)

    // â˜… ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì¶”ì„¸ ì»¨íŒ â˜…
    table.cell(infoTable, 0, 4, "â”â” HTF ì¶”ì„¸ â”â”", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.blue, 30))
    table.cell(infoTable, 1, 4, useHTFConfirm ? "í™œì„±" : "ë¹„í™œì„±", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.blue, 30))

    // 15ë¶„ë´‰ ì¶”ì„¸ ìƒíƒœ
    htf1_status = htf1_bullish ? "ğŸŸ¢ BULL" : htf1_bearish ? "ğŸ”´ BEAR" : "âšª FLAT"
    htf1_color = htf1_bullish ? color.green : htf1_bearish ? color.red : color.gray
    table.cell(infoTable, 0, 5, "15ë¶„ ì¶”ì„¸", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 5, htf1_status,
              text_color=htf1_color, text_size=size.small)

    // 1ì‹œê°„ë´‰ ì¶”ì„¸ ìƒíƒœ
    htf2_status = htf2_bullish ? "ğŸŸ¢ BULL" : htf2_bearish ? "ğŸ”´ BEAR" : "âšª FLAT"
    htf2_color = htf2_bullish ? color.green : htf2_bearish ? color.red : color.gray
    table.cell(infoTable, 0, 6, "1ì‹œê°„ ì¶”ì„¸", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 6, htf2_status,
              text_color=htf2_color, text_size=size.small)

    // â˜… V28 ì‹ ê·œ: HTF ê±°ë˜ëŸ‰ ìƒíƒœ â˜…
    table.cell(infoTable, 0, 7, "â”â” HTF ê±°ë˜ëŸ‰ â”â”", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.teal, 30))
    table.cell(infoTable, 1, 7, useHTFVolumeConfirm ? "í™œì„±" : "ë¹„í™œì„±", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.teal, 30))

    // í˜„ì¬TF ê±°ë˜ëŸ‰
    currentVolStatus = currentTFVolumeOK ? "âœ… " + str.tostring(volumeRatio, "#.#") + "x" : "âŒ " + str.tostring(volumeRatio, "#.#") + "x"
    table.cell(infoTable, 0, 8, "í˜„ì¬TF ê±°ë˜ëŸ‰", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 8, currentVolStatus,
              text_color=currentTFVolumeOK ? color.green : color.red, text_size=size.small)

    // 15ë¶„ë´‰ ê±°ë˜ëŸ‰
    htfVolStatus = htfVolumeOK ? "âœ… " + str.tostring(htf_volumeRatio, "#.#") + "x" : "âŒ " + str.tostring(htf_volumeRatio, "#.#") + "x"
    table.cell(infoTable, 0, 9, "15ë¶„ ê±°ë˜ëŸ‰", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 9, htfVolStatus,
              text_color=htfVolumeOK ? color.green : color.red, text_size=size.small)

    // 15ë¶„ë´‰ ë§¤ìˆ˜ì••ë ¥
    htfPressureStatus = htf_strongBuyPressure ? "ğŸŸ¢ ë§¤ìˆ˜ " : htf_strongSellPressure ? "ğŸ”´ ë§¤ë„ " : "âšª ì¤‘ë¦½ "
    htfPressureStatus := htfPressureStatus + str.tostring(htf_buyPressure, "#") + "%"
    table.cell(infoTable, 0, 10, "15ë¶„ ì••ë ¥", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 10, htfPressureStatus,
              text_color=htf_strongBuyPressure ? color.green : htf_strongSellPressure ? color.red : color.gray, text_size=size.small)

    // ê±°ë˜ëŸ‰ ì¢…í•©
    volFullStatus = volumeFullConfirm ? "âœ… ì»¨íŒë¨" : "âŒ ëŒ€ê¸°"
    table.cell(infoTable, 0, 11, "ê±°ë˜ëŸ‰ ì¢…í•©", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 11, volFullStatus,
              text_color=volumeFullConfirm ? color.green : color.red, text_size=size.small)

    // êµ¬ë¶„ì„ 
    table.cell(infoTable, 0, 12, "â”â” í˜„ì¬TF â”â”", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.gray, 30))
    table.cell(infoTable, 1, 12, "", bgcolor=color.new(color.gray, 30))

    // ì´ì 
    table.cell(infoTable, 0, 13, "ì´ì ", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 13, str.tostring(totalScore, "#.#") + "/24",
              text_color=totalScore >= minSignalStrength ? color.green : color.gray, text_size=size.small)

    // ADX
    adxStatus = veryStrongTrend ? "ğŸ”¥ ê°•í•¨" : strongTrend ? "ğŸ’ª ì¶”ì„¸" : trendExists ? "âœ… OK" : "âš ï¸ íš¡ë³´"
    adxColor = veryStrongTrend ? color.green : strongTrend ? color.blue : trendExists ? color.teal : color.red
    table.cell(infoTable, 0, 14, "ADX", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 14, adxStatus + " (" + str.tostring(adx, "#.#") + ")",
              text_color=adxColor, text_size=size.small)

    // DI ë°©í–¥
    diStatus = bullishDI ? "ğŸŸ¢ ìƒìŠ¹" : "ğŸ”´ í•˜ë½"
    table.cell(infoTable, 0, 15, "DI ë°©í–¥", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 15, diStatus, text_color=bullishDI ? color.green : color.red, text_size=size.small)

    // StochRSI
    stochStatus = stochOversold ? "ğŸŸ¢ ê³¼ë§¤ë„" : stochOverbought ? "ğŸ”´ ê³¼ë§¤ìˆ˜" : "âšª ì¤‘ë¦½"
    table.cell(infoTable, 0, 16, "StochRSI", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 16, stochStatus + " (" + str.tostring(stochK, "#.#") + ")",
              text_color=stochOversold ? color.green : stochOverbought ? color.red : color.gray, text_size=size.small)

    // RSI
    table.cell(infoTable, 0, 17, "RSI", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 17, str.tostring(rsi, "#.#"),
              text_color=rsi < 30 ? color.green : rsi > 70 ? color.red : color.gray, text_size=size.small)

    // ì¶”ì„¸ ìƒíƒœ
    trendStatus = strongUptrend ? "ğŸš€ ê°•í•œ ìƒìŠ¹" : strongDowntrend ? "ğŸ“‰ ê°•í•œ í•˜ë½" : isUptrend ? "ğŸ“ˆ ìƒìŠ¹" : isDowntrend ? "ğŸ“‰ í•˜ë½" : "â¡ï¸ íš¡ë³´"
    table.cell(infoTable, 0, 18, "ì¶”ì„¸", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 18, trendStatus,
              text_color=strongUptrend or isUptrend ? color.green : strongDowntrend or isDowntrend ? color.red : color.gray, text_size=size.small)

    // ì‹ í˜¸ ê°„ê²©
    table.cell(infoTable, 0, 19, "ì‹ í˜¸ ê°„ê²©", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 19, str.tostring(math.min(barsSinceLastLong, barsSinceLastShort)) + "ë´‰",
              text_color=canSignalLong ? color.green : color.orange, text_size=size.small)

    // ìµœì¢… ì‹ í˜¸
    table.cell(infoTable, 0, 20, "ìµœì¢… ì‹ í˜¸", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.gray, 30))
    string finalText = longSignal_final ? "ğŸš€ LONG" : shortSignal_final ? "ğŸ”» SHORT" : "â¸ï¸ ëŒ€ê¸°"
    finalColor = longSignal_final ? color.green : shortSignal_final ? color.red : color.gray
    table.cell(infoTable, 1, 20, finalText, text_color=finalColor, text_size=size.small,
              bgcolor=color.new(color.gray, 30))

// ============================================
// Webhook ì•Œë¦¼ (V28: HTF ê±°ë˜ëŸ‰ ì •ë³´ ì¶”ê°€)
// ============================================

if longSignal_final
    // ì•± ì•Œë¦¼ìš© ê°„ë‹¨ ë©”ì‹œì§€
    string simpleMsg = "LONG " + syminfo.basecurrency + " | ì§„ì…: $" + str.tostring(close, "#.##") + " | TP1: $" + str.tostring(close * (1 + tpPct1/100), "#.##") + " | TP2: $" + str.tostring(close * (1 + tpPct2/100), "#.##") + " | SL: $" + str.tostring(close * (1 - slPct/100), "#.##")

    // Webhookìš© JSON (êµ¬ê¸€ì‹œíŠ¸ ê¸°ë¡ìš©)
    string jsonData = '{"version":"28",' +
          '"market":"' + syminfo.basecurrency + '-USDT",' +
          '"mode":"' + tradeMode + '",' +
          '"signal":"LONG",' +
          '"leverage":"' + str.tostring(leverageInput) + '",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"totalScore":"' + str.tostring(totalScore, "#.#") + '",' +
          '"tp1":"' + str.tostring(close * (1 + tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 + tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 - slPct/100), "#.##") + '",' +
          '"tp1_pct":"' + str.tostring(tpPct1, "#.##") + '",' +
          '"tp2_pct":"' + str.tostring(tpPct2, "#.##") + '",' +
          '"sl_pct":"' + str.tostring(slPct, "#.##") + '",' +
          '"volume_ratio":"' + str.tostring(volumeRatio, "#.#") + '",' +
          '"htf_volume_ratio":"' + str.tostring(htf_volumeRatio, "#.#") + '",' +
          '"htf_buy_pressure":"' + str.tostring(htf_buyPressure, "#") + '",' +
          '"message":"' + simpleMsg + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)

if shortSignal_final
    // ì•± ì•Œë¦¼ìš© ê°„ë‹¨ ë©”ì‹œì§€
    string simpleMsg = "SHORT " + syminfo.basecurrency + " | ì§„ì…: $" + str.tostring(close, "#.##") + " | TP1: $" + str.tostring(close * (1 - tpPct1/100), "#.##") + " | TP2: $" + str.tostring(close * (1 - tpPct2/100), "#.##") + " | SL: $" + str.tostring(close * (1 + slPct/100), "#.##")

    // Webhookìš© JSON (êµ¬ê¸€ì‹œíŠ¸ ê¸°ë¡ìš©)
    string jsonData = '{"version":"28",' +
          '"market":"' + syminfo.basecurrency + '-USDT",' +
          '"mode":"ì„ ë¬¼",' +
          '"signal":"SHORT",' +
          '"leverage":"' + str.tostring(leverageInput) + '",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"totalScore":"' + str.tostring(totalScoreShort, "#.#") + '",' +
          '"tp1":"' + str.tostring(close * (1 - tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 - tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 + slPct/100), "#.##") + '",' +
          '"tp1_pct":"' + str.tostring(tpPct1, "#.##") + '",' +
          '"tp2_pct":"' + str.tostring(tpPct2, "#.##") + '",' +
          '"sl_pct":"' + str.tostring(slPct, "#.##") + '",' +
          '"volume_ratio":"' + str.tostring(volumeRatio, "#.#") + '",' +
          '"htf_volume_ratio":"' + str.tostring(htf_volumeRatio, "#.#") + '",' +
          '"htf_buy_pressure":"' + str.tostring(htf_buyPressure, "#") + '",' +
          '"message":"' + simpleMsg + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)

if whaleExitSignal
    string alertMsg = "EXIT " + syminfo.basecurrency + " - ê³ ë˜ ë§¤ë„ ê°ì§€ (HTF í™•ì¸)"

    string jsonData = '{"version":"28",' +
          '"market":"' + syminfo.basecurrency + '-USDT",' +
          '"mode":"' + tradeMode + '",' +
          '"signal":"EXIT",' +
          '"reason":"HTF_VOLUME_SELL",' +
          '"current_price":"' + str.tostring(close, "#.##") + '",' +
          '"htf_volume_ratio":"' + str.tostring(htf_volumeRatio, "#.#") + '",' +
          '"htf_sell_pressure":"' + str.tostring(100 - htf_buyPressure, "#") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)
