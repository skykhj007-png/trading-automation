//@version=5
indicator("í´ë¡œë“œ26 í•˜ì´í€„ë¦¬í‹° (ì‹ í˜¸ ì •ë°€)", overlay=true, max_labels_count=100)

// ============================================
// V26 ê°œì„ ì‚¬í•­:
// 1. ê±°ì§“ ì‹ í˜¸ ëŒ€í­ ê°ì†Œ
// 2. ADX í•„í„° ê¸°ë³¸ í™œì„±í™” (íš¡ë³´ì¥ í•„í„°ë§)
// 3. ìµœì†Œ ì‹ í˜¸ ê°•ë„ ìƒí–¥ (14ì )
// 4. ì¶”ì„¸ í™•ì¸ ê°•í™”
// 5. ì—°ì† ì‹ í˜¸ ë°©ì§€ (ìµœì†Œ ê°„ê²©)
// 6. ê±°ë˜ëŸ‰ í™•ì¸ í•„ìˆ˜
// ============================================

// ============================================
// ê±°ë˜ ëª¨ë“œ ì„ íƒ
// ============================================
tradeMode = input.string("ì„ ë¬¼", title="ğŸ“Š ê±°ë˜ ëª¨ë“œ", options=["ì„ ë¬¼", "í˜„ë¬¼ì½”ì¸", "ì£¼ì‹"],
    tooltip="ì„ ë¬¼: LONG+SHORT, í˜„ë¬¼ì½”ì¸: LONGë§Œ, ì£¼ì‹: LONGë§Œ")

// ============================================
// ë ˆë²„ë¦¬ì§€ ì„¤ì • (TP/SL ìë™ ì—°ë™)
// ============================================
leverageInput = input.int(5, title="ğŸ“Š ë ˆë²„ë¦¬ì§€", minval=1, maxval=50, step=1,
    tooltip="ë ˆë²„ë¦¬ì§€ì— ë”°ë¼ TP/SL ìë™ ì¡°ì •ë¨\në†’ì€ ë ˆë²„ë¦¬ì§€ = ì¢ì€ TP/SL")

// ============================================
// ëª¨ë“œë³„ ìë™ TP/SL ì„¤ì • (ë ˆë²„ë¦¬ì§€ ì—°ë™)
// ============================================

// ë ˆë²„ë¦¬ì§€ ê¸°ë°˜ TP/SL ê³„ì‚° ê³µì‹:
// ê¸°ì¤€: 5ë°° ë ˆë²„ë¦¬ì§€ = ê¸°ë³¸ê°’
// ë ˆë²„ë¦¬ì§€ ë†’ì•„ì§€ë©´ TP/SL ì¤„ì–´ë“¦, ë‚®ì•„ì§€ë©´ ëŠ˜ì–´ë‚¨
float leverageMultiplier = 5.0 / leverageInput  // 5ë°° ê¸°ì¤€

// ëª¨ë“œë³„ ê¸°ë³¸ê°’ (5ë°° ë ˆë²„ë¦¬ì§€ ê¸°ì¤€)
float baseTP1 = tradeMode == "ì„ ë¬¼" ? 1.0 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.5 : 2.0
float baseTP2 = tradeMode == "ì„ ë¬¼" ? 2.0 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 3.0 : 4.0
float baseSL = tradeMode == "ì„ ë¬¼" ? 0.5 : tradeMode == "í˜„ë¬¼ì½”ì¸" ? 1.0 : 1.5

// ë ˆë²„ë¦¬ì§€ ì ìš©ëœ TP/SL (ì„ ë¬¼ì—ì„œë§Œ ì ìš©)
float defaultTP1 = tradeMode == "ì„ ë¬¼" ? baseTP1 * leverageMultiplier : baseTP1
float defaultTP2 = tradeMode == "ì„ ë¬¼" ? baseTP2 * leverageMultiplier : baseTP2
float defaultSL = tradeMode == "ì„ ë¬¼" ? baseSL * leverageMultiplier : baseSL

// ìµœì†Œ/ìµœëŒ€ ì œí•œ
defaultTP1 := math.max(0.3, math.min(defaultTP1, 5.0))
defaultTP2 := math.max(0.5, math.min(defaultTP2, 10.0))
defaultSL := math.max(0.15, math.min(defaultSL, 3.0))

// ìˆ˜ë™ ì˜¤ë²„ë¼ì´ë“œ ì˜µì…˜
useAutoTPSL = input.bool(true, title="ìë™ TP/SL ì‚¬ìš©", tooltip="ì²´í¬ í•´ì œì‹œ ìˆ˜ë™ ì„¤ì • ì‚¬ìš©")
manualTP1 = input.float(1.0, title="ìˆ˜ë™ TP1 (%)", minval=0.1, maxval=10.0, step=0.1)
manualTP2 = input.float(2.0, title="ìˆ˜ë™ TP2 (%)", minval=0.1, maxval=20.0, step=0.1)
manualSL = input.float(0.5, title="ìˆ˜ë™ SL (%)", minval=0.1, maxval=5.0, step=0.1)

// ìµœì¢… TP/SL ê°’
float tpPct1 = useAutoTPSL ? defaultTP1 : manualTP1
float tpPct2 = useAutoTPSL ? defaultTP2 : manualTP2
float slPct = useAutoTPSL ? defaultSL : manualSL

// ============================================
// ì‹ í˜¸ í’ˆì§ˆ ì„¤ì • (V26 í•µì‹¬)
// ============================================
minSignalStrength = input.int(14, title="ìµœì†Œ ì‹ í˜¸ ê°•ë„", minval=10, maxval=20,
    tooltip="ë†’ì„ìˆ˜ë¡ ì‹ í˜¸ ì ì§€ë§Œ ì •í™•ë„ ë†’ìŒ. ì¶”ì²œ: 14-16")
minBarsBetweenSignals = input.int(5, title="ì‹ í˜¸ ìµœì†Œ ê°„ê²© (ë´‰)", minval=3, maxval=20,
    tooltip="ì—°ì† ì‹ í˜¸ ë°©ì§€. ì¶”ì²œ: 5-10")
requireVolumeConfirm = input.bool(true, title="ê±°ë˜ëŸ‰ í™•ì¸ í•„ìˆ˜",
    tooltip="í‰ê·  ì´ìƒ ê±°ë˜ëŸ‰ì—ì„œë§Œ ì‹ í˜¸ ë°œìƒ")
requireTrendAlign = input.bool(true, title="ì¶”ì„¸ ì¼ì¹˜ í•„ìˆ˜",
    tooltip="ìƒìœ„ íƒ€ì„í”„ë ˆì„ê³¼ ë°©í–¥ ì¼ì¹˜ í•„ìˆ˜")

// ============================================
// ADX ì„¤ì • (V26: ê¸°ë³¸ í™œì„±í™”)
// ============================================
useADXFilter = input.bool(true, title="ADX í•„í„° ì‚¬ìš© (ê°•ë ¥ ê¶Œì¥)",
    tooltip="íš¡ë³´ì¥ í•„í„°ë§. OFFì‹œ ê±°ì§“ ì‹ í˜¸ ì¦ê°€")
adxLength = input.int(14, title="ADX ê¸¸ì´", minval=7, maxval=30)
adxThreshold = input.float(20.0, title="ADX ì„ê³„ê°’", minval=15.0, maxval=35.0, step=1.0,
    tooltip="20 ì´ìƒ: ì¶”ì„¸ ì¡´ì¬, 25 ì´ìƒ: ê°•í•œ ì¶”ì„¸")

// ============================================
// ì´ë™í‰ê· ì„  ë° ì¶”ì„¸
// ============================================
ema9 = ta.ema(close, 9)
ema21 = ta.ema(close, 21)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)
vwap50 = ta.vwma(close, 50)

// ëª…í™•í•œ ì¶”ì„¸ ì •ì˜
strongUptrend = ema9 > ema21 and ema21 > ema50 and close > ema200
strongDowntrend = ema9 < ema21 and ema21 < ema50 and close < ema200
isUptrend = ema9 > ema21 and close > ema50
isDowntrend = ema9 < ema21 and close < ema50

// ============================================
// ADX (ì¶”ì„¸ ê°•ë„)
// ============================================
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)

noTrend = adx < adxThreshold
trendExists = adx >= adxThreshold
strongTrend = adx >= 25
veryStrongTrend = adx >= 30

bullishDI = diPlus > diMinus
bearishDI = diMinus > diPlus

// DI í¬ë¡œìŠ¤ (ì¶”ì„¸ ì „í™˜ ì‹ í˜¸)
diCrossUp = ta.crossover(diPlus, diMinus)
diCrossDown = ta.crossunder(diPlus, diMinus)

// ============================================
// RSI (ë‹¨ìˆœí™” + ê°•í™”)
// ============================================
rsi = ta.rsi(close, 14)
rsiOversold = rsi < 30
rsiOverbought = rsi > 70
rsiNeutral = rsi >= 40 and rsi <= 60
rsiBullish = rsi > 50 and rsi < 70
rsiBearish = rsi < 50 and rsi > 30

// ============================================
// Stochastic RSI (V26: ì¡°ê±´ ê°•í™”)
// ============================================
stochRsi = ta.stoch(rsi, rsi, rsi, 14)
stochK = ta.sma(stochRsi, 3)
stochD = ta.sma(stochK, 3)

// ë” ì—„ê²©í•œ ê³¼ë§¤ë„/ê³¼ë§¤ìˆ˜ ê¸°ì¤€
stochOversold = stochK < 15  // ê¸°ì¡´ 20 â†’ 15
stochOverbought = stochK > 85  // ê¸°ì¡´ 80 â†’ 85
stochGoldenCross = ta.crossover(stochK, stochD) and stochK < 30
stochDeadCross = ta.crossunder(stochK, stochD) and stochK > 70

// ============================================
// MACD
// ============================================
[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
macdBullish = macdLine > signalLine and histogram > 0
macdBearish = macdLine < signalLine and histogram < 0
macdCrossUp = ta.crossover(macdLine, signalLine)
macdCrossDown = ta.crossunder(macdLine, signalLine)

// ============================================
// Bollinger Bands
// ============================================
bbBasis = ta.sma(close, 20)
bbDev = ta.stdev(close, 20)
bbUpper = bbBasis + 2 * bbDev
bbLower = bbBasis - 2 * bbDev
bbWidth = (bbUpper - bbLower) / bbBasis * 100

touchingBBLower = low <= bbLower
touchingBBUpper = high >= bbUpper
bbSqueeze = bbWidth < ta.sma(bbWidth, 20) * 0.7

// ============================================
// ê±°ë˜ëŸ‰ ë¶„ì„ (V26: í•„ìˆ˜ í™•ì¸)
// ============================================
avgVolume = ta.sma(volume, 20)
volumeRatio = volume / avgVolume
volumeConfirm = volumeRatio >= 1.0  // í‰ê·  ì´ìƒ ê±°ë˜ëŸ‰
highVolume = volumeRatio >= 1.5
veryHighVolume = volumeRatio >= 2.0

// ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥
bullVolume = close > open ? volume : volume * (close - low) / math.max(high - low, 0.0001)
bearVolume = close < open ? volume : volume * (high - close) / math.max(high - low, 0.0001)
buyPressure = bullVolume / (bullVolume + bearVolume) * 100
strongBuyPressure = buyPressure > 65
strongSellPressure = buyPressure < 35

// ============================================
// ë©€í‹°íƒ€ì„í”„ë ˆì„ (V26: ì¶”ì„¸ í™•ì¸ ê°•í™”)
// ============================================

// ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì„¤ì •
string tf_higher = tradeMode == "ì„ ë¬¼" ? "60" : "D"
string tf_mid = tradeMode == "ì„ ë¬¼" ? "15" : "240"

// ìƒìœ„ íƒ€ì„í”„ë ˆì„ ë°ì´í„°
ema20_higher = request.security(syminfo.tickerid, tf_higher, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_higher = request.security(syminfo.tickerid, tf_higher, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
rsi_higher = request.security(syminfo.tickerid, tf_higher, ta.rsi(close, 14), lookahead=barmerge.lookahead_off)

// ìƒìœ„ íƒ€ì„í”„ë ˆì„ ADX (ë³„ë„ ê³„ì‚°)
[diPlus_h, diMinus_h, adx_h] = ta.dmi(14, 14)
adx_higher = request.security(syminfo.tickerid, tf_higher, adx_h, lookahead=barmerge.lookahead_off)

// ìƒìœ„ íƒ€ì„í”„ë ˆì„ ì¶”ì„¸
higherTF_bullish = ema20_higher > ema50_higher and rsi_higher > 45 and rsi_higher < 75
higherTF_bearish = ema20_higher < ema50_higher and rsi_higher < 55 and rsi_higher > 25
higherTF_trending = adx_higher >= 18

// ì¤‘ê°„ íƒ€ì„í”„ë ˆì„ ë°ì´í„°
ema20_mid = request.security(syminfo.tickerid, tf_mid, ta.ema(close, 20), lookahead=barmerge.lookahead_off)
ema50_mid = request.security(syminfo.tickerid, tf_mid, ta.ema(close, 50), lookahead=barmerge.lookahead_off)
[macdLine_mid, signalLine_mid, hist_mid] = request.security(syminfo.tickerid, tf_mid, ta.macd(close, 12, 26, 9), lookahead=barmerge.lookahead_off)

midTF_bullish = ema20_mid > ema50_mid and macdLine_mid > signalLine_mid
midTF_bearish = ema20_mid < ema50_mid and macdLine_mid < signalLine_mid

// ============================================
// ì‹ í˜¸ ê°„ê²© ì¶”ì  (V26: ì—°ì† ì‹ í˜¸ ë°©ì§€)
// ============================================
var int barsSinceLastLong = 999
var int barsSinceLastShort = 999

barsSinceLastLong := barsSinceLastLong + 1
barsSinceLastShort := barsSinceLastShort + 1

canSignalLong = barsSinceLastLong >= minBarsBetweenSignals
canSignalShort = barsSinceLastShort >= minBarsBetweenSignals

// ============================================
// ì ìˆ˜ ì‹œìŠ¤í…œ (V26: ì¬ì¡°ì •)
// ============================================

// ì¶”ì„¸ ì ìˆ˜ (ìµœëŒ€ 8ì )
var float trendScore = 0.0
trendScore := 0.0
if strongUptrend
    trendScore += 4
else if isUptrend
    trendScore += 2
if higherTF_bullish
    trendScore += 2
if midTF_bullish
    trendScore += 2

// ëª¨ë©˜í…€ ì ìˆ˜ (ìµœëŒ€ 8ì )
var float momentumScore = 0.0
momentumScore := 0.0
if stochGoldenCross
    momentumScore += 3
else if stochOversold
    momentumScore += 2
if macdCrossUp or macdBullish
    momentumScore += 2
if rsiBullish
    momentumScore += 2
if diCrossUp or (bullishDI and trendExists)
    momentumScore += 1

// ê±°ë˜ëŸ‰ ì ìˆ˜ (ìµœëŒ€ 4ì )
var float volumeScore = 0.0
volumeScore := 0.0
if veryHighVolume and strongBuyPressure
    volumeScore += 4
else if highVolume and strongBuyPressure
    volumeScore += 3
else if volumeConfirm and buyPressure > 55
    volumeScore += 2
else if volumeConfirm
    volumeScore += 1

// ê¸°ìˆ ì  ì ìˆ˜ (ìµœëŒ€ 4ì )
var float technicalScore = 0.0
technicalScore := 0.0
if touchingBBLower and stochOversold
    technicalScore += 2
if close > vwap50
    technicalScore += 1
if close > ema200
    technicalScore += 1

// SHORT ì ìˆ˜ ê³„ì‚°
var float trendScoreShort = 0.0
trendScoreShort := 0.0
if strongDowntrend
    trendScoreShort += 4
else if isDowntrend
    trendScoreShort += 2
if higherTF_bearish
    trendScoreShort += 2
if midTF_bearish
    trendScoreShort += 2

var float momentumScoreShort = 0.0
momentumScoreShort := 0.0
if stochDeadCross
    momentumScoreShort += 3
else if stochOverbought
    momentumScoreShort += 2
if macdCrossDown or macdBearish
    momentumScoreShort += 2
if rsiBearish
    momentumScoreShort += 2
if diCrossDown or (bearishDI and trendExists)
    momentumScoreShort += 1

var float volumeScoreShort = 0.0
volumeScoreShort := 0.0
if veryHighVolume and strongSellPressure
    volumeScoreShort += 4
else if highVolume and strongSellPressure
    volumeScoreShort += 3
else if volumeConfirm and buyPressure < 45
    volumeScoreShort += 2
else if volumeConfirm
    volumeScoreShort += 1

var float technicalScoreShort = 0.0
technicalScoreShort := 0.0
if touchingBBUpper and stochOverbought
    technicalScoreShort += 2
if close < vwap50
    technicalScoreShort += 1
if close < ema200
    technicalScoreShort += 1

// ì´ì  ê³„ì‚°
var float totalScore = 0.0
totalScore := trendScore + momentumScore + volumeScore + technicalScore

var float totalScoreShort = 0.0
totalScoreShort := trendScoreShort + momentumScoreShort + volumeScoreShort + technicalScoreShort

// ============================================
// ìµœì¢… ì‹ í˜¸ ê²°ì • (V26: ì—„ê²©í•œ ì¡°ê±´)
// ============================================

// LONG ê¸°ë³¸ ì¡°ê±´
longBase = totalScore >= minSignalStrength
longBase := longBase and canSignalLong  // ì—°ì† ì‹ í˜¸ ë°©ì§€

// ì¶”ì„¸ ì¼ì¹˜ í™•ì¸
if requireTrendAlign
    longBase := longBase and (higherTF_bullish or midTF_bullish)

// ê±°ë˜ëŸ‰ í™•ì¸
if requireVolumeConfirm
    longBase := longBase and volumeConfirm

// ADX í•„í„° (íš¡ë³´ì¥ ì°¨ë‹¨)
if useADXFilter
    longBase := longBase and trendExists and bullishDI

// StochRSI í™•ì¸ (ê³¼ë§¤ë„ ë˜ëŠ” ê³¨ë“ í¬ë¡œìŠ¤)
longBase := longBase and (stochOversold or stochGoldenCross or (stochK < 50 and stochK > stochD))

// ìµœì¢… LONG ì‹ í˜¸
longSignal_final = longBase and isUptrend

// SHORT ê¸°ë³¸ ì¡°ê±´ (ì„ ë¬¼ë§Œ)
shortBase = false
if tradeMode == "ì„ ë¬¼"
    shortBase := totalScoreShort >= minSignalStrength
    shortBase := shortBase and canSignalShort

    if requireTrendAlign
        shortBase := shortBase and (higherTF_bearish or midTF_bearish)

    if requireVolumeConfirm
        shortBase := shortBase and volumeConfirm

    if useADXFilter
        shortBase := shortBase and trendExists and bearishDI

    shortBase := shortBase and (stochOverbought or stochDeadCross or (stochK > 50 and stochK < stochD))
    shortBase := shortBase and isDowntrend

shortSignal_final = shortBase

// ì‹ í˜¸ ë°œìƒì‹œ ì¹´ìš´í„° ë¦¬ì…‹
if longSignal_final
    barsSinceLastLong := 0
if shortSignal_final
    barsSinceLastShort := 0

// ============================================
// EXIT ì‹ í˜¸ (í˜„ë¬¼/ì£¼ì‹ìš©)
// ============================================
whaleExitSignal = (tradeMode == "í˜„ë¬¼ì½”ì¸" or tradeMode == "ì£¼ì‹") and
                  veryHighVolume and strongSellPressure and isDowntrend

// ============================================
// ì°¨íŠ¸ í‘œì‹œ
// ============================================

// ì´ë™í‰ê· ì„ 
plot(ema21, color=color.new(color.orange, 0), linewidth=2, title="EMA 21")
plot(ema50, color=color.new(color.blue, 0), linewidth=2, title="EMA 50")
plot(ema200, color=color.new(color.purple, 0), linewidth=2, title="EMA 200")

// Bollinger Bands
plot(bbUpper, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(bbLower, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")

// ì‹ í˜¸ í‘œì‹œ
plotshape(longSignal_final, style=shape.triangleup, location=location.belowbar,
         color=color.new(color.green, 0), size=size.normal, title="LONG ì‹ í˜¸")
plotshape(shortSignal_final, style=shape.triangledown, location=location.abovebar,
         color=color.new(color.red, 0), size=size.normal, title="SHORT ì‹ í˜¸")

// EXIT ê²½ê³ 
plotshape(whaleExitSignal, style=shape.xcross, location=location.abovebar,
         color=color.new(color.orange, 0), size=size.small, title="EXIT ê²½ê³ ")

// ì¶”ì„¸ ë°°ê²½
bgcolor(strongUptrend ? color.new(color.green, 92) : strongDowntrend ? color.new(color.red, 92) : na)

// BB ìŠ¤í€´ì¦ˆ
bgcolor(bbSqueeze ? color.new(color.yellow, 90) : na, title="BB ìŠ¤í€´ì¦ˆ")

// ============================================
// ì‹ í˜¸ ë¼ë²¨
// ============================================

var label signalLabel = na
var line tp1Line = na
var line tp2Line = na
var line slLine = na

string modeEmoji = tradeMode == "ì„ ë¬¼" ? "âš¡" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "ğŸª™" : "ğŸ“ˆ"
string modeText = tradeMode == "ì„ ë¬¼" ? "FUTURES" : tradeMode == "í˜„ë¬¼ì½”ì¸" ? "SPOT" : "STOCK"

if longSignal_final
    if not na(signalLabel)
        label.delete(signalLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 + tpPct1/100)
    float labelTp2 = close * (1 + tpPct2/100)
    float labelSl = close * (1 - slPct/100)

    signalLabel := label.new(bar_index, low - (high - low) * 0.3,
                          text=modeEmoji + " LONG [V26]\n" +
                               "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
                               "ì ìˆ˜: " + str.tostring(totalScore, "#.#") + "/24\n" +
                               "ADX: " + str.tostring(adx, "#.#") + "\n" +
                               "â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                               "TP1: $" + str.tostring(labelTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
                               "TP2: $" + str.tostring(labelTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
                               "SL: $" + str.tostring(labelSl, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)",
                          style=label.style_label_up,
                          color=color.new(color.green, 20),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 20, labelTp1,
                       color=color.new(color.green, 0), width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 20, labelTp2,
                       color=color.new(color.green, 0), width=3, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 20, labelSl,
                      color=color.new(color.red, 0), width=2, style=line.style_solid)

if shortSignal_final
    if not na(signalLabel)
        label.delete(signalLabel)
    if not na(tp1Line)
        line.delete(tp1Line)
    if not na(tp2Line)
        line.delete(tp2Line)
    if not na(slLine)
        line.delete(slLine)

    float labelTp1 = close * (1 - tpPct1/100)
    float labelTp2 = close * (1 - tpPct2/100)
    float labelSl = close * (1 + slPct/100)

    signalLabel := label.new(bar_index, high + (high - low) * 0.3,
                          text="âš¡ SHORT [V26]\n" +
                               "ì§„ì…: $" + str.tostring(close, "#.##") + "\n" +
                               "ì ìˆ˜: " + str.tostring(totalScoreShort, "#.#") + "/24\n" +
                               "ADX: " + str.tostring(adx, "#.#") + "\n" +
                               "â”â”â”â”â”â”â”â”â”â”â”â”\n" +
                               "TP1: $" + str.tostring(labelTp1, "#.##") + " (+" + str.tostring(tpPct1, "#.#") + "%)\n" +
                               "TP2: $" + str.tostring(labelTp2, "#.##") + " (+" + str.tostring(tpPct2, "#.#") + "%)\n" +
                               "SL: $" + str.tostring(labelSl, "#.##") + " (-" + str.tostring(slPct, "#.#") + "%)",
                          style=label.style_label_down,
                          color=color.new(color.red, 20),
                          textcolor=color.white, size=size.normal)

    tp1Line := line.new(bar_index, labelTp1, bar_index + 20, labelTp1,
                       color=color.new(color.green, 0), width=2, style=line.style_dashed)
    tp2Line := line.new(bar_index, labelTp2, bar_index + 20, labelTp2,
                       color=color.new(color.green, 0), width=3, style=line.style_solid)
    slLine := line.new(bar_index, labelSl, bar_index + 20, labelSl,
                      color=color.new(color.red, 0), width=2, style=line.style_solid)

// ============================================
// ì •ë³´ í…Œì´ë¸”
// ============================================

var table infoTable = table.new(position.top_right, 2, 18, bgcolor=color.new(color.white, 10), border_width=1)

if barstate.islast
    table.clear(infoTable, 0, 0, 1, 17)

    // ë²„ì „ & ëª¨ë“œ
    modeColor = tradeMode == "ì„ ë¬¼" ? color.purple : tradeMode == "í˜„ë¬¼ì½”ì¸" ? color.orange : color.blue
    table.cell(infoTable, 0, 0, modeEmoji + " V26 HQ", text_color=color.white, text_size=size.normal,
              bgcolor=color.new(modeColor, 20))
    table.cell(infoTable, 1, 0, modeText, text_color=color.white, text_size=size.normal,
              bgcolor=color.new(modeColor, 20))

    table.cell(infoTable, 0, 1, "í˜„ì¬ê°€", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 1, "$" + str.tostring(close, "#.##"), text_color=color.black, text_size=size.small)

    // ë ˆë²„ë¦¬ì§€ í‘œì‹œ
    table.cell(infoTable, 0, 2, "ë ˆë²„ë¦¬ì§€", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(leverageInput) + "x",
              text_color=leverageInput >= 10 ? color.red : leverageInput >= 5 ? color.orange : color.green, text_size=size.small)

    // TP/SL ì„¤ì • (ë ˆë²„ë¦¬ì§€ ì—°ë™)
    table.cell(infoTable, 0, 3, "TP1/TP2/SL", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(tpPct1, "#.##") + "/" + str.tostring(tpPct2, "#.##") + "/" + str.tostring(slPct, "#.##") + "%",
              text_color=color.black, text_size=size.small)

    // ì´ì 
    table.cell(infoTable, 0, 4, "ğŸ“Š ì´ì ", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.gray, 30))
    table.cell(infoTable, 1, 4, str.tostring(totalScore, "#.#") + "/24",
              text_color=totalScore >= minSignalStrength ? color.green : color.gray, text_size=size.small)

    // ì ìˆ˜ ì„¸ë¶€
    table.cell(infoTable, 0, 5, "ì¶”ì„¸", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(trendScore, "#") + "/8",
              text_color=trendScore >= 4 ? color.green : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 6, "ëª¨ë©˜í…€", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 6, str.tostring(momentumScore, "#") + "/8",
              text_color=momentumScore >= 4 ? color.green : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 7, "ê±°ë˜ëŸ‰", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 7, str.tostring(volumeScore, "#") + "/4 (" + str.tostring(volumeRatio, "#.#") + "x)",
              text_color=volumeScore >= 2 ? color.green : color.gray, text_size=size.small)

    table.cell(infoTable, 0, 8, "ê¸°ìˆ ì ", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 8, str.tostring(technicalScore, "#") + "/4",
              text_color=technicalScore >= 2 ? color.green : color.gray, text_size=size.small)

    // ADX (í•µì‹¬ ì§€í‘œ)
    table.cell(infoTable, 0, 9, "ğŸ“Š ADX", text_color=color.black, text_size=size.small)
    adxStatus = veryStrongTrend ? "ğŸ”¥ ê°•í•¨" : strongTrend ? "ğŸ’ª ì¶”ì„¸" : trendExists ? "âœ… OK" : "âš ï¸ íš¡ë³´"
    adxColor = veryStrongTrend ? color.green : strongTrend ? color.blue : trendExists ? color.teal : color.red
    table.cell(infoTable, 1, 9, adxStatus + " (" + str.tostring(adx, "#.#") + ")",
              text_color=adxColor, text_size=size.small)

    // DI ë°©í–¥
    table.cell(infoTable, 0, 10, "DI ë°©í–¥", text_color=color.black, text_size=size.small)
    diStatus = bullishDI ? "ğŸŸ¢ ìƒìŠ¹" : "ğŸ”´ í•˜ë½"
    table.cell(infoTable, 1, 10, diStatus,
              text_color=bullishDI ? color.green : color.red, text_size=size.small)

    // StochRSI
    table.cell(infoTable, 0, 11, "StochRSI", text_color=color.black, text_size=size.small)
    stochStatus = stochOversold ? "ğŸŸ¢ ê³¼ë§¤ë„" : stochOverbought ? "ğŸ”´ ê³¼ë§¤ìˆ˜" : "âšª ì¤‘ë¦½"
    table.cell(infoTable, 1, 11, stochStatus + " (" + str.tostring(stochK, "#.#") + ")",
              text_color=stochOversold ? color.green : stochOverbought ? color.red : color.gray, text_size=size.small)

    // RSI
    table.cell(infoTable, 0, 12, "RSI", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 12, str.tostring(rsi, "#.#"),
              text_color=rsi < 30 ? color.green : rsi > 70 ? color.red : color.gray, text_size=size.small)

    // ìƒìœ„ TF
    string tfLabel = tradeMode == "ì„ ë¬¼" ? "1H TF" : "Daily"
    table.cell(infoTable, 0, 13, tfLabel, text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 13, higherTF_bullish ? "ğŸŸ¢ BULL" : higherTF_bearish ? "ğŸ”´ BEAR" : "âšª FLAT",
              text_color=higherTF_bullish ? color.green : higherTF_bearish ? color.red : color.gray, text_size=size.small)

    // ì‹ í˜¸ ê°„ê²©
    table.cell(infoTable, 0, 14, "ì‹ í˜¸ ê°„ê²©", text_color=color.black, text_size=size.small)
    table.cell(infoTable, 1, 14, str.tostring(math.min(barsSinceLastLong, barsSinceLastShort)) + "ë´‰",
              text_color=canSignalLong ? color.green : color.orange, text_size=size.small)

    // ì¶”ì„¸ ìƒíƒœ
    table.cell(infoTable, 0, 15, "ì¶”ì„¸", text_color=color.black, text_size=size.small)
    trendStatus = strongUptrend ? "ğŸš€ ê°•í•œ ìƒìŠ¹" : strongDowntrend ? "ğŸ“‰ ê°•í•œ í•˜ë½" : isUptrend ? "ğŸ“ˆ ìƒìŠ¹" : isDowntrend ? "ğŸ“‰ í•˜ë½" : "â¡ï¸ íš¡ë³´"
    table.cell(infoTable, 1, 15, trendStatus,
              text_color=strongUptrend or isUptrend ? color.green : strongDowntrend or isDowntrend ? color.red : color.gray, text_size=size.small)

    // ìµœì¢… ì‹ í˜¸
    table.cell(infoTable, 0, 16, "ì‹ í˜¸", text_color=color.white, text_size=size.small,
              bgcolor=color.new(color.gray, 30))
    string finalText = longSignal_final ? "ğŸš€ LONG" : shortSignal_final ? "ğŸ”» SHORT" : "â¸ï¸ ëŒ€ê¸°"
    finalColor = longSignal_final ? color.green : shortSignal_final ? color.red : color.gray
    table.cell(infoTable, 1, 16, finalText, text_color=finalColor, text_size=size.small)

// ============================================
// Webhook ì•Œë¦¼
// ============================================

if longSignal_final
    string jsonData = '{"version":"26",' +
          '"market":"' + syminfo.basecurrency + '-USDT",' +
          '"mode":"' + tradeMode + '",' +
          '"signal":"LONG",' +
          '"leverage":"' + str.tostring(leverageInput) + '",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"totalScore":"' + str.tostring(totalScore, "#.#") + '",' +
          '"tp1":"' + str.tostring(close * (1 + tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 + tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 - slPct/100), "#.##") + '",' +
          '"tp1_pct":"' + str.tostring(tpPct1, "#.##") + '",' +
          '"tp2_pct":"' + str.tostring(tpPct2, "#.##") + '",' +
          '"sl_pct":"' + str.tostring(slPct, "#.##") + '",' +
          '"adx":"' + str.tostring(adx, "#.#") + '",' +
          '"volume_ratio":"' + str.tostring(volumeRatio, "#.##") + '",' +
          '"rsi":"' + str.tostring(rsi, "#.#") + '",' +
          '"stochK":"' + str.tostring(stochK, "#.#") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)

if shortSignal_final
    string jsonData = '{"version":"26",' +
          '"market":"' + syminfo.basecurrency + '-USDT",' +
          '"mode":"ì„ ë¬¼",' +
          '"signal":"SHORT",' +
          '"leverage":"' + str.tostring(leverageInput) + '",' +
          '"entry":"' + str.tostring(close, "#.##") + '",' +
          '"totalScore":"' + str.tostring(totalScoreShort, "#.#") + '",' +
          '"tp1":"' + str.tostring(close * (1 - tpPct1/100), "#.##") + '",' +
          '"tp2":"' + str.tostring(close * (1 - tpPct2/100), "#.##") + '",' +
          '"sl":"' + str.tostring(close * (1 + slPct/100), "#.##") + '",' +
          '"tp1_pct":"' + str.tostring(tpPct1, "#.##") + '",' +
          '"tp2_pct":"' + str.tostring(tpPct2, "#.##") + '",' +
          '"sl_pct":"' + str.tostring(slPct, "#.##") + '",' +
          '"adx":"' + str.tostring(adx, "#.#") + '",' +
          '"volume_ratio":"' + str.tostring(volumeRatio, "#.##") + '",' +
          '"rsi":"' + str.tostring(rsi, "#.#") + '",' +
          '"stochK":"' + str.tostring(stochK, "#.#") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)

if whaleExitSignal
    string jsonData = '{"version":"26",' +
          '"market":"' + syminfo.basecurrency + '-USDT",' +
          '"mode":"' + tradeMode + '",' +
          '"signal":"EXIT",' +
          '"reason":"HIGH_VOLUME_SELL",' +
          '"current_price":"' + str.tostring(close, "#.##") + '",' +
          '"volume_ratio":"' + str.tostring(volumeRatio, "#.##") + '"}'

    alert(jsonData, freq=alert.freq_once_per_bar)
