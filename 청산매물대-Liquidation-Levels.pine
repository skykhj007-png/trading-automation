//@version=5
indicator("Ï≤≠ÏÇ∞ Îß§Î¨ºÎåÄ (Liquidation Levels) v1.0", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================
// Ï≤≠ÏÇ∞ Îß§Î¨ºÎåÄ ÏãúÍ∞ÅÌôî ÏßÄÌëú
//
// Í∏∞Îä•:
// 1. Î†àÎ≤ÑÎ¶¨ÏßÄÎ≥Ñ Ï≤≠ÏÇ∞ Í∞ÄÍ≤© ÏàòÌèâÏÑ† ÌëúÏãú
// 2. Í≥†ÏúÑÌóò Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ ÌïòÏù¥ÎùºÏù¥Ìä∏
// 3. ÌéÄÎî©ÎπÑ/Î°±Ïàè Í∏∞Î∞ò ÏúÑÌóòÎèÑ ÌëúÏãú
// 4. Ï≤≠ÏÇ∞ Î¨ºÎüâ ÏßëÏ§ë Íµ¨Í∞Ñ ÏïåÎ¶º
//
// Ï£ºÏùò: Ïù¥ ÏßÄÌëúÎäî ÏòàÏÉÅ Ï≤≠ÏÇ∞ Î†àÎ≤®ÏùÑ Í≥ÑÏÇ∞Ìï©ÎãàÎã§.
// Ïã§Ï†ú Ï≤≠ÏÇ∞ÏùÄ Í±∞ÎûòÏÜå/Ìè¨ÏßÄÏÖòÎßàÎã§ Îã§Î•º Ïàò ÏûàÏäµÎãàÎã§.
// ============================================

// ============================================
// ÏÑ§Ï†ï
// ============================================

// Í∏∞Î≥∏ ÏÑ§Ï†ï
showLongLiq = input.bool(true, title="Î°± Ï≤≠ÏÇ∞ Î†àÎ≤® ÌëúÏãú", group="ÌëúÏãú ÏÑ§Ï†ï")
showShortLiq = input.bool(true, title="Ïàè Ï≤≠ÏÇ∞ Î†àÎ≤® ÌëúÏãú", group="ÌëúÏãú ÏÑ§Ï†ï")
showLabels = input.bool(true, title="Î†àÎ≤ÑÎ¶¨ÏßÄ ÎùºÎ≤® ÌëúÏãú", group="ÌëúÏãú ÏÑ§Ï†ï")
showHighRisk = input.bool(true, title="Í≥†ÏúÑÌóò Íµ¨Í∞Ñ Í∞ïÏ°∞", group="ÌëúÏãú ÏÑ§Ï†ï")

// Î†àÎ≤ÑÎ¶¨ÏßÄ ÏÑ†ÌÉù
show5x = input.bool(false, title="5x", inline="lev1", group="Î†àÎ≤ÑÎ¶¨ÏßÄ ÏÑ†ÌÉù")
show10x = input.bool(true, title="10x", inline="lev1", group="Î†àÎ≤ÑÎ¶¨ÏßÄ ÏÑ†ÌÉù")
show25x = input.bool(true, title="25x", inline="lev1", group="Î†àÎ≤ÑÎ¶¨ÏßÄ ÏÑ†ÌÉù")
show50x = input.bool(true, title="50x", inline="lev2", group="Î†àÎ≤ÑÎ¶¨ÏßÄ ÏÑ†ÌÉù")
show100x = input.bool(true, title="100x", inline="lev2", group="Î†àÎ≤ÑÎ¶¨ÏßÄ ÏÑ†ÌÉù")
show125x = input.bool(false, title="125x", inline="lev2", group="Î†àÎ≤ÑÎ¶¨ÏßÄ ÏÑ†ÌÉù")

// ÏÉâÏÉÅ ÏÑ§Ï†ï
longLiqColor = input.color(color.new(color.red, 30), title="Î°± Ï≤≠ÏÇ∞ ÏÉâÏÉÅ", group="ÏÉâÏÉÅ")
shortLiqColor = input.color(color.new(color.green, 30), title="Ïàè Ï≤≠ÏÇ∞ ÏÉâÏÉÅ", group="ÏÉâÏÉÅ")
highRiskColor = input.color(color.new(color.orange, 50), title="Í≥†ÏúÑÌóò Íµ¨Í∞Ñ ÏÉâÏÉÅ", group="ÏÉâÏÉÅ")

// Í≥†Í∏â ÏÑ§Ï†ï
maintenanceMargin = input.float(0.5, title="Ïú†ÏßÄÎßàÏßÑÏú® (%)", minval=0.1, maxval=2.0, step=0.1, group="Í≥†Í∏â") / 100
basePrice = input.string("ÌòÑÏû¨Í∞Ä", title="Í∏∞Ï§Ä Í∞ÄÍ≤©", options=["ÌòÑÏû¨Í∞Ä", "VWAP", "EMA20"], group="Í≥†Í∏â")
updateBars = input.int(1, title="ÏóÖÎç∞Ïù¥Ìä∏ Ï£ºÍ∏∞ (Î¥â)", minval=1, maxval=10, group="Í≥†Í∏â")

// ============================================
// Í∏∞Ï§Ä Í∞ÄÍ≤© Í≥ÑÏÇ∞
// ============================================

float refPrice = switch basePrice
    "ÌòÑÏû¨Í∞Ä" => close
    "VWAP" => ta.vwap
    "EMA20" => ta.ema(close, 20)
    => close

// ============================================
// Ï≤≠ÏÇ∞ Í∞ÄÍ≤© Í≥ÑÏÇ∞ Ìï®Ïàò
// ============================================

// Î°± Ï≤≠ÏÇ∞Í∞Ä = ÏßÑÏûÖÍ∞Ä * (1 - 1/Î†àÎ≤ÑÎ¶¨ÏßÄ + Ïú†ÏßÄÎßàÏßÑÏú®)
calcLongLiqPrice(float entryPrice, float leverage) =>
    entryPrice * (1 - 1/leverage + maintenanceMargin)

// Ïàè Ï≤≠ÏÇ∞Í∞Ä = ÏßÑÏûÖÍ∞Ä * (1 + 1/Î†àÎ≤ÑÎ¶¨ÏßÄ - Ïú†ÏßÄÎßàÏßÑÏú®)
calcShortLiqPrice(float entryPrice, float leverage) =>
    entryPrice * (1 + 1/leverage - maintenanceMargin)

// ============================================
// Ï≤≠ÏÇ∞ Î†àÎ≤® Í≥ÑÏÇ∞
// ============================================

// Î°± Ï≤≠ÏÇ∞ Î†àÎ≤® (Í∞ÄÍ≤© ÌïòÎùΩ Ïãú)
longLiq5x = calcLongLiqPrice(refPrice, 5)
longLiq10x = calcLongLiqPrice(refPrice, 10)
longLiq25x = calcLongLiqPrice(refPrice, 25)
longLiq50x = calcLongLiqPrice(refPrice, 50)
longLiq100x = calcLongLiqPrice(refPrice, 100)
longLiq125x = calcLongLiqPrice(refPrice, 125)

// Ïàè Ï≤≠ÏÇ∞ Î†àÎ≤® (Í∞ÄÍ≤© ÏÉÅÏäπ Ïãú)
shortLiq5x = calcShortLiqPrice(refPrice, 5)
shortLiq10x = calcShortLiqPrice(refPrice, 10)
shortLiq25x = calcShortLiqPrice(refPrice, 25)
shortLiq50x = calcShortLiqPrice(refPrice, 50)
shortLiq100x = calcShortLiqPrice(refPrice, 100)
shortLiq125x = calcShortLiqPrice(refPrice, 125)

// ============================================
// Ï≤≠ÏÇ∞ Î†àÎ≤® ÎùºÏù∏ Í∑∏Î¶¨Í∏∞
// ============================================

var line[] longLines = array.new_line()
var line[] shortLines = array.new_line()
var label[] liqLabels = array.new_label()

// ÏóÖÎç∞Ïù¥Ìä∏ Ï°∞Í±¥
bool shouldUpdate = bar_index % updateBars == 0

if shouldUpdate and barstate.islast
    // Í∏∞Ï°¥ ÎùºÏù∏/ÎùºÎ≤® ÏÇ≠Ï†ú
    for ln in longLines
        line.delete(ln)
    array.clear(longLines)

    for ln in shortLines
        line.delete(ln)
    array.clear(shortLines)

    for lb in liqLabels
        label.delete(lb)
    array.clear(liqLabels)

    // Î°± Ï≤≠ÏÇ∞ Î†àÎ≤® Í∑∏Î¶¨Í∏∞
    if showLongLiq
        if show5x
            array.push(longLines, line.new(bar_index - 50, longLiq5x, bar_index + 10, longLiq5x, color=longLiqColor, style=line.style_dotted, width=1))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, longLiq5x, "L5x", color=color.new(color.red, 80), textcolor=color.red, style=label.style_label_left, size=size.tiny))

        if show10x
            array.push(longLines, line.new(bar_index - 50, longLiq10x, bar_index + 10, longLiq10x, color=longLiqColor, style=line.style_dashed, width=1))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, longLiq10x, "L10x", color=color.new(color.red, 80), textcolor=color.red, style=label.style_label_left, size=size.tiny))

        if show25x
            array.push(longLines, line.new(bar_index - 50, longLiq25x, bar_index + 10, longLiq25x, color=longLiqColor, style=line.style_dashed, width=2))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, longLiq25x, "L25x", color=color.new(color.red, 80), textcolor=color.red, style=label.style_label_left, size=size.small))

        if show50x
            lnColor50 = showHighRisk ? highRiskColor : longLiqColor
            array.push(longLines, line.new(bar_index - 50, longLiq50x, bar_index + 10, longLiq50x, color=lnColor50, style=line.style_solid, width=2))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, longLiq50x, "L50x ‚ö†Ô∏è", color=color.new(color.orange, 80), textcolor=color.orange, style=label.style_label_left, size=size.small))

        if show100x
            lnColor100 = showHighRisk ? color.new(color.red, 0) : longLiqColor
            array.push(longLines, line.new(bar_index - 50, longLiq100x, bar_index + 10, longLiq100x, color=lnColor100, style=line.style_solid, width=3))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, longLiq100x, "L100x üî•", color=color.new(color.red, 70), textcolor=color.red, style=label.style_label_left, size=size.normal))

        if show125x
            array.push(longLines, line.new(bar_index - 50, longLiq125x, bar_index + 10, longLiq125x, color=color.new(color.red, 0), style=line.style_solid, width=3))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, longLiq125x, "L125x üíÄ", color=color.new(color.red, 70), textcolor=color.red, style=label.style_label_left, size=size.normal))

    // Ïàè Ï≤≠ÏÇ∞ Î†àÎ≤® Í∑∏Î¶¨Í∏∞
    if showShortLiq
        if show5x
            array.push(shortLines, line.new(bar_index - 50, shortLiq5x, bar_index + 10, shortLiq5x, color=shortLiqColor, style=line.style_dotted, width=1))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, shortLiq5x, "S5x", color=color.new(color.green, 80), textcolor=color.green, style=label.style_label_left, size=size.tiny))

        if show10x
            array.push(shortLines, line.new(bar_index - 50, shortLiq10x, bar_index + 10, shortLiq10x, color=shortLiqColor, style=line.style_dashed, width=1))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, shortLiq10x, "S10x", color=color.new(color.green, 80), textcolor=color.green, style=label.style_label_left, size=size.tiny))

        if show25x
            array.push(shortLines, line.new(bar_index - 50, shortLiq25x, bar_index + 10, shortLiq25x, color=shortLiqColor, style=line.style_dashed, width=2))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, shortLiq25x, "S25x", color=color.new(color.green, 80), textcolor=color.green, style=label.style_label_left, size=size.small))

        if show50x
            lnColor50s = showHighRisk ? highRiskColor : shortLiqColor
            array.push(shortLines, line.new(bar_index - 50, shortLiq50x, bar_index + 10, shortLiq50x, color=lnColor50s, style=line.style_solid, width=2))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, shortLiq50x, "S50x ‚ö†Ô∏è", color=color.new(color.orange, 80), textcolor=color.orange, style=label.style_label_left, size=size.small))

        if show100x
            lnColor100s = showHighRisk ? color.new(color.green, 0) : shortLiqColor
            array.push(shortLines, line.new(bar_index - 50, shortLiq100x, bar_index + 10, shortLiq100x, color=lnColor100s, style=line.style_solid, width=3))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, shortLiq100x, "S100x üî•", color=color.new(color.green, 70), textcolor=color.green, style=label.style_label_left, size=size.normal))

        if show125x
            array.push(shortLines, line.new(bar_index - 50, shortLiq125x, bar_index + 10, shortLiq125x, color=color.new(color.green, 0), style=line.style_solid, width=3))
            if showLabels
                array.push(liqLabels, label.new(bar_index + 12, shortLiq125x, "S125x üíÄ", color=color.new(color.green, 70), textcolor=color.green, style=label.style_label_left, size=size.normal))

// ============================================
// Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ ÎèÑÎã¨ Í∞êÏßÄ
// ============================================

// Í≥†Î†àÎ≤ÑÎ¶¨ÏßÄ Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ Í∑ºÏ†ë ÏïåÎ¶º (ÌòÑÏû¨Í∞Ä Í∏∞Ï§Ä 1% Ïù¥ÎÇ¥)
longLiq50xNear = low <= longLiq50x * 1.01 and low >= longLiq50x * 0.99
longLiq100xNear = low <= longLiq100x * 1.01 and low >= longLiq100x * 0.99
shortLiq50xNear = high >= shortLiq50x * 0.99 and high <= shortLiq50x * 1.01
shortLiq100xNear = high >= shortLiq100x * 0.99 and high <= shortLiq100x * 1.01

// Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ ÎèåÌåå Í∞êÏßÄ
longLiq50xBreak = low < longLiq50x[1] and close > longLiq50x
longLiq100xBreak = low < longLiq100x[1] and close > longLiq100x
shortLiq50xBreak = high > shortLiq50x[1] and close < shortLiq50x
shortLiq100xBreak = high > shortLiq100x[1] and close < shortLiq100x

// ============================================
// Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ ÎèåÌåå Ïãú ÏãúÍ∞Å Ìö®Í≥º
// ============================================

// Î°± Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ ÎèåÌåå (Í∏âÎùΩ ÌõÑ Î∞òÎì± = Ïàè Ïä§ÌÄ¥Ï¶à Í∏∞Ìöå)
plotshape(longLiq100xBreak and showHighRisk, title="100x Î°±Ï≤≠ÏÇ∞ Ïä§Ïúï", location=location.belowbar, color=color.red, style=shape.triangleup, size=size.normal, text="100x\nSWEEP")
plotshape(longLiq50xBreak and showHighRisk and not longLiq100xBreak, title="50x Î°±Ï≤≠ÏÇ∞ Ïä§Ïúï", location=location.belowbar, color=color.orange, style=shape.triangleup, size=size.small, text="50x")

// Ïàè Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ ÎèåÌåå (Í∏âÎì± ÌõÑ ÌïòÎùΩ = Î°± Ïä§ÌÄ¥Ï¶à Í∏∞Ìöå)
plotshape(shortLiq100xBreak and showHighRisk, title="100x ÏàèÏ≤≠ÏÇ∞ Ïä§Ïúï", location=location.abovebar, color=color.green, style=shape.triangledown, size=size.normal, text="100x\nSWEEP")
plotshape(shortLiq50xBreak and showHighRisk and not shortLiq100xBreak, title="50x ÏàèÏ≤≠ÏÇ∞ Ïä§Ïúï", location=location.abovebar, color=color.teal, style=shape.triangledown, size=size.small, text="50x")

// ============================================
// Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î
// ============================================

var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "Ï≤≠ÏÇ∞ Îß§Î¨ºÎåÄ", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Í∞ÄÍ≤©", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)

    // Î°± Ï≤≠ÏÇ∞ Î†àÎ≤®
    table.cell(infoTable, 0, 1, "Î°±100x Ï≤≠ÏÇ∞", text_color=color.red, text_size=size.tiny)
    table.cell(infoTable, 1, 1, str.tostring(longLiq100x, "#.##"), text_color=color.red, text_size=size.tiny)

    table.cell(infoTable, 0, 2, "Î°±50x Ï≤≠ÏÇ∞", text_color=color.orange, text_size=size.tiny)
    table.cell(infoTable, 1, 2, str.tostring(longLiq50x, "#.##"), text_color=color.orange, text_size=size.tiny)

    table.cell(infoTable, 0, 3, "Î°±25x Ï≤≠ÏÇ∞", text_color=color.yellow, text_size=size.tiny)
    table.cell(infoTable, 1, 3, str.tostring(longLiq25x, "#.##"), text_color=color.yellow, text_size=size.tiny)

    // Íµ¨Î∂ÑÏÑ†
    table.cell(infoTable, 0, 4, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 4, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.tiny)

    // Ïàè Ï≤≠ÏÇ∞ Î†àÎ≤®
    table.cell(infoTable, 0, 5, "Ïàè25x Ï≤≠ÏÇ∞", text_color=color.lime, text_size=size.tiny)
    table.cell(infoTable, 1, 5, str.tostring(shortLiq25x, "#.##"), text_color=color.lime, text_size=size.tiny)

    table.cell(infoTable, 0, 6, "Ïàè50x Ï≤≠ÏÇ∞", text_color=color.teal, text_size=size.tiny)
    table.cell(infoTable, 1, 6, str.tostring(shortLiq50x, "#.##"), text_color=color.teal, text_size=size.tiny)

    table.cell(infoTable, 0, 7, "Ïàè100x Ï≤≠ÏÇ∞", text_color=color.green, text_size=size.tiny)
    table.cell(infoTable, 1, 7, str.tostring(shortLiq100x, "#.##"), text_color=color.green, text_size=size.tiny)

// ============================================
// ÏïåÎ¶º ÏÑ§Ï†ï
// ============================================

// Î°± Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ Ï†ëÍ∑º ÏïåÎ¶º
alertcondition(longLiq50xNear, title="Î°±50x Ï≤≠ÏÇ∞Íµ¨Í∞Ñ Ï†ëÍ∑º", message="{{ticker}}: Î°± 50x Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ Ï†ëÍ∑º Ï§ë! Í∞ÄÍ≤©: {{close}}")
alertcondition(longLiq100xNear, title="Î°±100x Ï≤≠ÏÇ∞Íµ¨Í∞Ñ Ï†ëÍ∑º", message="{{ticker}}: Î°± 100x Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ Ï†ëÍ∑º Ï§ë! Í∞ÄÍ≤©: {{close}}")

// Ïàè Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ Ï†ëÍ∑º ÏïåÎ¶º
alertcondition(shortLiq50xNear, title="Ïàè50x Ï≤≠ÏÇ∞Íµ¨Í∞Ñ Ï†ëÍ∑º", message="{{ticker}}: Ïàè 50x Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ Ï†ëÍ∑º Ï§ë! Í∞ÄÍ≤©: {{close}}")
alertcondition(shortLiq100xNear, title="Ïàè100x Ï≤≠ÏÇ∞Íµ¨Í∞Ñ Ï†ëÍ∑º", message="{{ticker}}: Ïàè 100x Ï≤≠ÏÇ∞ Íµ¨Í∞Ñ Ï†ëÍ∑º Ï§ë! Í∞ÄÍ≤©: {{close}}")

// Ï≤≠ÏÇ∞ Ïä§Ïúï ÏïåÎ¶º (Î∞òÏ†Ñ Í∏∞Ìöå)
alertcondition(longLiq50xBreak or longLiq100xBreak, title="Î°± Ï≤≠ÏÇ∞ Ïä§Ïúï", message="üî• {{ticker}}: Î°± Ï≤≠ÏÇ∞ Ïä§Ïúï Î∞úÏÉù! Î∞òÎì± Í∏∞Ìöå? Í∞ÄÍ≤©: {{close}}")
alertcondition(shortLiq50xBreak or shortLiq100xBreak, title="Ïàè Ï≤≠ÏÇ∞ Ïä§Ïúï", message="üî• {{ticker}}: Ïàè Ï≤≠ÏÇ∞ Ïä§Ïúï Î∞úÏÉù! ÌïòÎùΩ Í∏∞Ìöå? Í∞ÄÍ≤©: {{close}}")

// Î≥µÌï© ÏïåÎ¶º
alertcondition(longLiq100xBreak or shortLiq100xBreak, title="100x Ï≤≠ÏÇ∞ Ïä§Ïúï", message="üíÄ {{ticker}}: 100x Î†àÎ≤ÑÎ¶¨ÏßÄ Ï≤≠ÏÇ∞ Ïä§Ïúï! ÎåÄÎüâ Ï≤≠ÏÇ∞ Î∞úÏÉù Ï∂îÏ†ï. Í∞ÄÍ≤©: {{close}}")
