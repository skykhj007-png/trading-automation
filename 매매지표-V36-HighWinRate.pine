//@version=5
strategy("V36 HighWinRate", overlay=true, max_labels_count=100, default_qty_type=strategy.percent_of_equity, default_qty_value=100, initial_capital=1000, commission_type=strategy.commission.percent, commission_value=0.1, slippage=2)

// ============================================
// V36 HighWinRate - 고승률 전략 조합
//
// 참고:
// - Triple RSI (Larry Connors R3) - 90% 승률
// - RSI(7) + EMA(20/50) + Volume
// - EMA + RSI + ADX 조합
// ============================================

// ============================================
// 전략 선택
// ============================================
strategyType = input.string("Triple RSI", title="전략 선택", options=["Triple RSI", "RSI+EMA+Volume", "EMA+RSI+ADX", "복합"], group="전략 설정")
longOnly = input.bool(true, title="LONG만 거래", group="전략 설정")

// ============================================
// Triple RSI 설정 (Larry Connors R3)
// ============================================
rsiLen1 = input.int(2, title="RSI 길이 1 (빠른)", group="Triple RSI")
rsiLen2 = input.int(4, title="RSI 길이 2 (중간)", group="Triple RSI")
rsiLen3 = input.int(14, title="RSI 길이 3 (느린)", group="Triple RSI")
rsiOversold = input.int(10, title="RSI 과매도 레벨", group="Triple RSI")
rsiOverbought = input.int(90, title="RSI 과매수 레벨", group="Triple RSI")

// ============================================
// EMA 설정
// ============================================
emaFast = input.int(9, title="EMA 빠른선", group="EMA 설정")
emaMid = input.int(20, title="EMA 중간선", group="EMA 설정")
emaSlow = input.int(50, title="EMA 느린선", group="EMA 설정")
ema200Len = input.int(200, title="EMA 200", group="EMA 설정")

// ============================================
// ADX 설정
// ============================================
adxLen = input.int(14, title="ADX 길이", group="ADX 설정")
adxThreshold = input.float(20, title="ADX 추세 임계값", group="ADX 설정")
adxStrongThreshold = input.float(25, title="ADX 강한 추세", group="ADX 설정")

// ============================================
// 거래량 설정
// ============================================
volLen = input.int(20, title="거래량 평균 길이", group="거래량 설정")
volSpike = input.float(1.5, title="거래량 급증 배수", group="거래량 설정")

// ============================================
// TP/SL 설정
// ============================================
tpPct = input.float(1.5, title="TP (%)", minval=0.1, maxval=10.0, step=0.1, group="TP/SL 설정")
slPct = input.float(0.8, title="SL (%)", minval=0.1, maxval=5.0, step=0.1, group="TP/SL 설정")

// ============================================
// HTF 설정
// ============================================
useHTF = input.bool(false, title="HTF 확인", group="HTF 설정", tooltip="거래 수 늘리려면 OFF")
htfTimeframe = input.timeframe("60", title="HTF 타임프레임", group="HTF 설정")

// ============================================
// 지표 계산
// ============================================

// Triple RSI
rsi1 = ta.rsi(close, rsiLen1)  // RSI(2) - 매우 빠름
rsi2 = ta.rsi(close, rsiLen2)  // RSI(4) - 빠름
rsi3 = ta.rsi(close, rsiLen3)  // RSI(14) - 표준

// Triple RSI 평균 (Connors RSI 스타일)
avgRsi = (rsi1 + rsi2 + rsi3) / 3

// RSI 상승/하락 감지
bool rsi1Rising = rsi1 > rsi1[1]
bool rsi1Falling = rsi1 < rsi1[1]

// EMA
ema9 = ta.ema(close, emaFast)
ema20 = ta.ema(close, emaMid)
ema50 = ta.ema(close, emaSlow)
ema200 = ta.ema(close, ema200Len)

// EMA 정렬
bool emaUptrend = ema9 > ema20 and ema20 > ema50
bool emaDowntrend = ema9 < ema20 and ema20 < ema50
bool priceAboveEMA = close > ema20 and close > ema50
bool priceBelowEMA = close < ema20 and close < ema50
bool aboveEMA200 = close > ema200
bool belowEMA200 = close < ema200

// ADX/DMI
[diPlus, diMinus, adxValue] = ta.dmi(adxLen, adxLen)
bool trendExists = adxValue >= adxThreshold
bool strongTrend = adxValue >= adxStrongThreshold
bool bullishDI = diPlus > diMinus
bool bearishDI = diMinus > diPlus

// 거래량
avgVolume = ta.sma(volume, volLen)
volumeRatio = volume / avgVolume
bool volumeConfirm = volumeRatio >= volSpike

// 매수/매도 압력
bullVolume = close > open ? volume : volume * (close - low) / math.max(high - low, 0.0001)
bearVolume = close < open ? volume : volume * (high - close) / math.max(high - low, 0.0001)
buyPressure = bullVolume / (bullVolume + bearVolume) * 100
bool strongBuyPressure = buyPressure > 55
bool strongSellPressure = buyPressure < 45

// Stochastic RSI
stochRsi = ta.stoch(rsi3, rsi3, rsi3, 14)
stochK = ta.sma(stochRsi, 3)
stochD = ta.sma(stochK, 3)
bool stochOversold = stochK < 20
bool stochOverbought = stochK > 80
bool stochCrossUp = ta.crossover(stochK, stochD)
bool stochCrossDown = ta.crossunder(stochK, stochD)

// MACD
[macdLine, signalLine, histogram] = ta.macd(close, 12, 26, 9)
bool macdBullish = macdLine > signalLine
bool macdBearish = macdLine < signalLine

// HTF 데이터
[htf_ema20, htf_ema50, htf_close, htf_rsi] = request.security(syminfo.tickerid, htfTimeframe, [ta.ema(close, 20), ta.ema(close, 50), close, ta.rsi(close, 14)], lookahead=barmerge.lookahead_off)
bool htfUptrend = htf_ema20 > htf_ema50 and htf_close > htf_ema50
bool htfDowntrend = htf_ema20 < htf_ema50 and htf_close < htf_ema50
bool htfBullish = htfUptrend and htf_rsi > 45 and htf_rsi < 70
bool htfBearish = htfDowntrend and htf_rsi > 30 and htf_rsi < 55

// ============================================
// 전략 1: Triple RSI (Mean Reversion)
// Larry Connors R3 기반 - 90% 승률
// ============================================
// 조건: RSI 과매도 (완화된 조건)
bool tripleRsiOversold = rsi1 < 25 and rsi2 < 35 and rsi3 < 40  // 완화
bool tripleRsiOverbought = rsi1 > 75 and rsi2 > 65 and rsi3 > 60  // 완화

// RSI 반등 시작 감지 (더 중요)
bool rsiReversal = rsi1 < 30 and rsi1Rising and rsi2 < 40
bool rsiReversalShort = rsi1 > 70 and rsi1Falling and rsi2 > 60

// 추가 필터: 상승 추세에서만 매수 (추세 + 평균회귀)
bool tripleRsiLong = (tripleRsiOversold or rsiReversal) and aboveEMA200
bool tripleRsiShort = (tripleRsiOverbought or rsiReversalShort) and belowEMA200

// 청산 조건
bool tripleRsiExitLong = rsi1 > 70 or rsi2 > 65
bool tripleRsiExitShort = rsi1 < 30 or rsi2 < 35

// ============================================
// 전략 2: RSI(7) + EMA(20/50) + Volume
// 과매도 + 추세 + 거래량 확인
// ============================================
rsi7 = ta.rsi(close, 7)
bool rsi7Oversold = rsi7 < 30
bool rsi7Overbought = rsi7 > 70
bool rsi7Rising = rsi7 > rsi7[1] and rsi7[1] < 35

bool rsiEmaVolLong = rsi7Oversold and priceAboveEMA and volumeConfirm and strongBuyPressure
bool rsiEmaVolShort = rsi7Overbought and priceBelowEMA and volumeConfirm and strongSellPressure

// 대안: RSI가 30 아래에서 상승 시작
bool rsiEmaVolLongAlt = rsi7Rising and priceAboveEMA and volumeConfirm

// ============================================
// 전략 3: EMA + RSI + ADX
// 추세 강도 확인 후 진입
// ============================================
bool emaRsiAdxLong = emaUptrend and rsi3 > 40 and rsi3 < 60 and trendExists and bullishDI and aboveEMA200
bool emaRsiAdxShort = emaDowntrend and rsi3 > 40 and rsi3 < 60 and trendExists and bearishDI and belowEMA200

// 추가: 풀백 진입 (강한 추세에서 일시적 하락 후)
bool pullbackLong = emaUptrend and strongTrend and stochOversold and bullishDI
bool pullbackShort = emaDowntrend and strongTrend and stochOverbought and bearishDI

// ============================================
// 복합 전략: 모든 조건 조합
// ============================================
bool complexLong = (tripleRsiOversold or rsi7Oversold or stochOversold) and
                   priceAboveEMA and
                   aboveEMA200 and
                   (trendExists and bullishDI) and
                   (volumeConfirm or strongBuyPressure)

bool complexShort = (tripleRsiOverbought or rsi7Overbought or stochOverbought) and
                    priceBelowEMA and
                    belowEMA200 and
                    (trendExists and bearishDI) and
                    (volumeConfirm or strongSellPressure)

// ============================================
// 최종 시그널
// ============================================
bool longSignal = false
bool shortSignal = false
bool exitLong = false
bool exitShort = false

if strategyType == "Triple RSI"
    longSignal := tripleRsiLong
    shortSignal := tripleRsiShort
    exitLong := tripleRsiExitLong
    exitShort := tripleRsiExitShort
else if strategyType == "RSI+EMA+Volume"
    longSignal := rsiEmaVolLong or rsiEmaVolLongAlt
    shortSignal := rsiEmaVolShort
else if strategyType == "EMA+RSI+ADX"
    longSignal := emaRsiAdxLong or pullbackLong
    shortSignal := emaRsiAdxShort or pullbackShort
else  // 복합
    longSignal := complexLong
    shortSignal := complexShort

// HTF 필터
if useHTF
    longSignal := longSignal and htfBullish
    shortSignal := shortSignal and htfBearish

// LONG만 옵션
if longOnly
    shortSignal := false

// ============================================
// Strategy
// ============================================
if longSignal and strategy.position_size == 0
    strategy.entry("LONG", strategy.long)

if shortSignal and strategy.position_size == 0
    strategy.entry("SHORT", strategy.short)

// Triple RSI 전용 청산
if strategyType == "Triple RSI"
    if strategy.position_size > 0 and exitLong
        strategy.close("LONG", comment="RSI Exit")
    if strategy.position_size < 0 and exitShort
        strategy.close("SHORT", comment="RSI Exit")

// TP/SL
if strategy.position_size > 0
    float tp = strategy.position_avg_price * (1 + tpPct/100)
    float sl = strategy.position_avg_price * (1 - slPct/100)
    strategy.exit("Exit", "LONG", limit=tp, stop=sl)

if strategy.position_size < 0
    float tp = strategy.position_avg_price * (1 - tpPct/100)
    float sl = strategy.position_avg_price * (1 + slPct/100)
    strategy.exit("Exit", "SHORT", limit=tp, stop=sl)

// ============================================
// 차트 표시
// ============================================
plot(ema20, color=color.new(color.orange, 0), linewidth=2, title="EMA 20")
plot(ema50, color=color.new(color.blue, 0), linewidth=2, title="EMA 50")
plot(ema200, color=color.new(color.purple, 50), linewidth=1, title="EMA 200")

plotshape(longSignal, style=shape.triangleup, location=location.belowbar, color=color.lime, size=size.normal, title="LONG")
plotshape(shortSignal, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.normal, title="SHORT")

bgcolor(emaUptrend and trendExists ? color.new(color.green, 94) : emaDowntrend and trendExists ? color.new(color.red, 94) : na)

// 라벨
if longSignal
    string stratName = strategyType == "Triple RSI" ? "TR" : strategyType == "RSI+EMA+Volume" ? "REV" : strategyType == "EMA+RSI+ADX" ? "ERA" : "CX"
    label.new(bar_index, low, stratName + "\nRSI:" + str.tostring(rsi3, "#"), style=label.style_label_up, color=color.lime, textcolor=color.white, size=size.tiny)

if shortSignal
    string stratName = strategyType == "Triple RSI" ? "TR" : strategyType == "RSI+EMA+Volume" ? "REV" : strategyType == "EMA+RSI+ADX" ? "ERA" : "CX"
    label.new(bar_index, high, stratName + "\nRSI:" + str.tostring(rsi3, "#"), style=label.style_label_down, color=color.red, textcolor=color.white, size=size.tiny)

// ============================================
// 정보 테이블
// ============================================
var table infoTable = table.new(position.top_right, 2, 10, bgcolor=color.new(color.white, 10), border_width=1)

string trendText = emaUptrend ? "UP" : emaDowntrend ? "DOWN" : "FLAT"
color trendColor = emaUptrend ? color.green : emaDowntrend ? color.red : color.gray
string rsiStatus = rsi1 < 20 ? "과매도" : rsi1 > 80 ? "과매수" : "중립"
color rsiColor = rsi1 < 20 ? color.green : rsi1 > 80 ? color.red : color.gray

if barstate.islast
    table.clear(infoTable, 0, 0, 1, 9)
    table.cell(infoTable, 0, 0, "V36 " + strategyType, text_color=color.white, text_size=size.small, bgcolor=color.new(color.teal, 20))
    table.cell(infoTable, 1, 0, timeframe.period, text_color=color.white, text_size=size.small, bgcolor=color.new(color.teal, 20))

    table.cell(infoTable, 0, 1, "추세", text_color=color.black, text_size=size.tiny)
    table.cell(infoTable, 1, 1, trendText + " ADX:" + str.tostring(adxValue, "#"), text_color=trendColor, text_size=size.tiny)

    table.cell(infoTable, 0, 2, "HTF", text_color=color.black, text_size=size.tiny)
    table.cell(infoTable, 1, 2, htfBullish ? "BULL" : htfBearish ? "BEAR" : "FLAT", text_color=htfBullish ? color.green : htfBearish ? color.red : color.gray, text_size=size.tiny)

    table.cell(infoTable, 0, 3, "RSI(2)", text_color=color.black, text_size=size.tiny)
    table.cell(infoTable, 1, 3, str.tostring(rsi1, "#") + " " + rsiStatus, text_color=rsiColor, text_size=size.tiny)

    table.cell(infoTable, 0, 4, "RSI(7)", text_color=color.black, text_size=size.tiny)
    table.cell(infoTable, 1, 4, str.tostring(rsi7, "#"), text_color=rsi7 < 30 ? color.green : rsi7 > 70 ? color.red : color.gray, text_size=size.tiny)

    table.cell(infoTable, 0, 5, "RSI(14)", text_color=color.black, text_size=size.tiny)
    table.cell(infoTable, 1, 5, str.tostring(rsi3, "#"), text_color=rsi3 < 30 ? color.green : rsi3 > 70 ? color.red : color.gray, text_size=size.tiny)

    table.cell(infoTable, 0, 6, "StochK", text_color=color.black, text_size=size.tiny)
    table.cell(infoTable, 1, 6, str.tostring(stochK, "#"), text_color=stochOversold ? color.green : stochOverbought ? color.red : color.gray, text_size=size.tiny)

    table.cell(infoTable, 0, 7, "거래량", text_color=color.black, text_size=size.tiny)
    table.cell(infoTable, 1, 7, str.tostring(volumeRatio, "#.#") + "x", text_color=volumeConfirm ? color.green : color.gray, text_size=size.tiny)

    table.cell(infoTable, 0, 8, "TP/SL", text_color=color.black, text_size=size.tiny)
    table.cell(infoTable, 1, 8, str.tostring(tpPct, "#.#") + "/" + str.tostring(slPct, "#.#") + "%", text_color=color.blue, text_size=size.tiny)

    table.cell(infoTable, 0, 9, "시그널", text_color=color.white, text_size=size.small, bgcolor=color.new(color.gray, 30))
    table.cell(infoTable, 1, 9, longSignal ? "LONG" : shortSignal ? "SHORT" : "WAIT", text_color=longSignal ? color.lime : shortSignal ? color.red : color.gray, text_size=size.small, bgcolor=color.new(color.gray, 30))

// ============================================
// 알림
// ============================================
if longSignal
    string alertMsg = "LONG [" + strategyType + "]\n"
    alertMsg += syminfo.basecurrency + "/USDT " + timeframe.period + "\n"
    alertMsg += "━━━━━━━━━━━━━━━━\n"
    alertMsg += "Entry: $" + str.tostring(close, "#.##") + "\n"
    alertMsg += "RSI(2): " + str.tostring(rsi1, "#") + " | RSI(7): " + str.tostring(rsi7, "#") + "\n"
    alertMsg += "ADX: " + str.tostring(adxValue, "#") + " | Vol: " + str.tostring(volumeRatio, "#.#") + "x\n"
    alertMsg += "TP: " + str.tostring(tpPct, "#.#") + "% | SL: " + str.tostring(slPct, "#.#") + "%"
    alert(alertMsg, freq=alert.freq_once_per_bar)

if shortSignal
    string alertMsg = "SHORT [" + strategyType + "]\n"
    alertMsg += syminfo.basecurrency + "/USDT " + timeframe.period + "\n"
    alertMsg += "━━━━━━━━━━━━━━━━\n"
    alertMsg += "Entry: $" + str.tostring(close, "#.##") + "\n"
    alertMsg += "RSI(2): " + str.tostring(rsi1, "#") + " | RSI(7): " + str.tostring(rsi7, "#") + "\n"
    alertMsg += "ADX: " + str.tostring(adxValue, "#") + " | Vol: " + str.tostring(volumeRatio, "#.#") + "x\n"
    alertMsg += "TP: " + str.tostring(tpPct, "#.#") + "% | SL: " + str.tostring(slPct, "#.#") + "%"
    alert(alertMsg, freq=alert.freq_once_per_bar)
