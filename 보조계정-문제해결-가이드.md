# 보조계정 자동매매 문제 해결 가이드

## 문제 증상
**TradingView 알람은 가는데 보조계정에서 자동매매가 실행되지 않음**

---

## 🚀 빠른 해결 (1분 진단)

### Apps Script에서 이 함수를 실행하세요:

```javascript
보조계정_자동매매_진단()
```

**실행 방법:**
1. Apps Script 에디터 열기
2. 함수 선택: `보조계정_자동매매_진단`
3. **실행** 버튼 클릭
4. 로그에서 문제 확인

**진단 항목:**
- ✅ 스프레드시트 연결
- ✅ Bitget API 연결
- ✅ 트리거 설정 상태
- ✅ 웹훅 URL 확인
- ✅ 최근 신호 수신 여부
- ✅ 현재 포지션 확인

---

## 📋 문제별 해결 방법

### ❌ 문제 1: 트리거 누락

**증상:**
```
❌ 필수 트리거 누락!
   누락: syncBitgetPositions, checkClosedPositions
```

**해결:**
```javascript
// Apps Script에서 실행
원클릭_전체설정()
```

이 함수가:
- 시트 생성/확인
- 트리거 자동 설정 (syncBitgetPositions, checkClosedPositions)
- API 연결 테스트

모두 자동으로 처리합니다!

---

### ❌ 문제 2: 웹훅 URL 미설정 또는 잘못됨

**증상:**
```
⚠️  신호 기록 없음
   → TradingView 알림이 웹훅 URL로 전송되고 있는지 확인
```

**해결 방법:**

#### 1단계: 새 배포 생성
```
1. Apps Script에서 "배포" → "새 배포"
2. 유형: 웹 앱
3. 실행 권한: 나
4. 액세스 권한: 모든 사용자 ← 중요!
5. "배포" 클릭
6. 웹 앱 URL 복사
```

#### 2단계: TradingView 알림 수정
```
1. TradingView 차트 → 알림 (종 아이콘)
2. 보조계정 알림 찾기
3. "..." → "편집"
4. 웹훅 URL에 새 URL 붙여넣기
5. 저장
```

#### 3단계: 테스트
브라우저에서 웹 앱 URL 접속:
```
https://script.google.com/macros/s/AKfycb.../exec
```

**예상 결과:**
```json
{
  "status": "ok",
  "message": "클로드25 V27 웹훅 서버 작동 중",
  ...
}
```

---

### ❌ 문제 3: Bitget API 오류

**증상:**
```
❌ Bitget API 연결 실패!
   → API 키 재확인 필요
```

**해결 방법:**

#### Code-보조계정.gs 파일에서 확인:

```javascript
var BITGET_CONFIG = {
  API_KEY: '보조계정_API_KEY',        // ← 확인!
  SECRET_KEY: '보조계정_SECRET_KEY',  // ← 확인!
  PASSPHRASE: '보조계정_PASSPHRASE',  // ← 확인!
  BASE_URL: 'https://api.bitget.com'
};
```

**체크리스트:**
- [ ] API 키가 보조계정용인지 확인 (메인 계정 키와 다름!)
- [ ] Bitget에서 API 권한 확인 (읽기 + 거래)
- [ ] API가 활성화되어 있는지 확인
- [ ] 선물 거래 활성화 여부 확인

**API 재발급:**
1. Bitget 로그인 (보조계정)
2. 프로필 → API 관리
3. 기존 API 삭제 또는 새 API 생성
4. 권한: ✅ 읽기, ✅ 거래
5. 새 키를 Code-보조계정.gs에 붙여넣기
6. 저장 후 배포

---

### ❌ 문제 4: 시트 누락

**증상:**
```
⚠️  필요한 시트 누락: 신호기록, V25 자동매매일지, 통계
```

**해결:**
```javascript
// Apps Script에서 실행
initSimulation()
```

또는

```javascript
원클릭_전체설정()
```

---

### ❌ 문제 5: 스프레드시트 ID 잘못됨

**증상:**
```
❌ 스프레드시트 연결 실패!
   → SPREADSHEET_ID 확인: 1L6wn9f...
```

**해결:**

#### 1. 스프레드시트 URL 확인
```
https://docs.google.com/spreadsheets/d/여기가_ID/edit
```

#### 2. Code-보조계정.gs에서 수정
```javascript
var SHEET_CONFIG = {
  SPREADSHEET_ID: '여기에_정확한_ID_붙여넣기',
  ...
};
```

---

## 🔍 실시간 로그 확인 방법

### TradingView 신호 발생 시:

#### 1. Apps Script 실행 로그
```
1. Apps Script → "실행" 메뉴
2. 최근 실행 내역 확인
3. "Webhook 수신" 메시지 있는지 확인
```

**로그에 "Webhook 수신" 있음:**
- ✅ 신호는 정상 도착
- 트리거나 API 문제일 가능성

**로그에 "Webhook 수신" 없음:**
- ❌ 웹훅 URL 문제
- TradingView 알림 웹훅 URL 재확인

#### 2. 스프레드시트 확인
```
1. 신호기록 시트 확인
2. 마지막 행에 새 신호 추가되었는지 확인
```

---

## ✅ 전체 체크리스트

### 설정 완료 확인:

- [ ] **Apps Script 배포**
  - [ ] 배포 → 새 배포 (웹 앱)
  - [ ] 액세스: "모든 사용자" 선택
  - [ ] 웹 앱 URL 복사

- [ ] **TradingView 알림**
  - [ ] 알림 생성 완료
  - [ ] 웹훅 URL 설정 (보조계정 URL!)
  - [ ] 조건: "모든 alert() 함수 호출"

- [ ] **Apps Script 설정**
  - [ ] SPREADSHEET_ID 정확한지 확인
  - [ ] BITGET_CONFIG에 보조계정 API 키 입력
  - [ ] `원클릭_전체설정()` 실행 완료

- [ ] **테스트**
  - [ ] `보조계정_자동매매_진단()` 실행
  - [ ] 모든 항목 ✅ 확인
  - [ ] TradingView 신호 대기

---

## 🆘 여전히 안 되는 경우

### 진단 로그 내용을 확인하세요:

```javascript
보조계정_자동매매_진단()
```

**로그 결과를 보고:**

1. **모든 시스템 정상인데 매매 안 됨:**
   - TradingView 알림 로그 확인 (웹훅 전송 성공 여부)
   - Apps Script 실행 로그에서 "Webhook 수신" 확인
   - 신호 발생 대기 (1분봉에서 테스트)

2. **특정 항목에 ❌ 또는 ⚠️  표시:**
   - 로그에서 제시한 해결 방법 따라 실행
   - 예: "원클릭_전체설정() 실행" → 그대로 실행

3. **Bitget 잔고가 0이거나 없음:**
   - Bitget 보조계정에 USDT 입금
   - 선물 계정 활성화

---

## 📌 자주 하는 실수

### 1. 메인/보조 계정 URL 혼동
```
❌ 메인 계정 웹훅 URL을 보조 계정 알림에 설정
✅ 각 계정마다 별도 Apps Script → 별도 웹훅 URL
```

### 2. 액세스 권한 잘못 선택
```
❌ 배포 시 "나만" 선택
✅ 반드시 "모든 사용자" 선택
```

### 3. 트리거 미설정
```
❌ 시트만 생성하고 트리거 설정 안 함
✅ 원클릭_전체설정() 실행해야 트리거 자동 생성
```

### 4. API 키 혼동
```
❌ 메인 계정 API 키를 보조 계정에 입력
✅ 각 계정마다 별도 API 키 필요
```

---

## 🎯 정상 작동 확인 방법

### 신호 발생 후:

```
1. 신호기록 시트에 새 행 추가됨
2. Apps Script 로그: "Webhook 수신"
3. 1분 후 트리거 실행: "syncBitgetPositions"
4. Bitget에 포지션 생성 확인
5. V25 자동매매일지에 진입 기록
```

---

## 빠른 재설정 (처음부터 다시)

모든 것을 리셋하고 싶다면:

```javascript
// 1. 기존 데이터 삭제
resetSimulation()

// 2. 전체 재설정
원클릭_전체설정()

// 3. 진단
보조계정_자동매매_진단()
```

그 다음:
- 배포 → 새 배포
- TradingView 알림에 새 웹훅 URL 설정

---

## 요약

**가장 흔한 문제 TOP 3:**

1. **웹훅 URL 문제** (50%)
   → 배포 → 새 배포 → TradingView 알림 수정

2. **트리거 미설정** (30%)
   → `원클릭_전체설정()` 실행

3. **API 키 오류** (20%)
   → BITGET_CONFIG 재확인

**해결 순서:**
```
보조계정_자동매매_진단() 실행
  ↓
로그에서 문제 확인
  ↓
제시된 해결 방법 실행
  ↓
다시 진단 실행
  ↓
✅ 모든 시스템 정상!
```
